var __decorate=this&&this.__decorate||function(e,t,i,r){var n,o=arguments.length,s=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,i,s):n(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s};var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();(function e(t,i){var r=[];var n=t?t.CANNON:this?this.CANNON:{};var o=t.OIMO||this.OIMO;var s=t.earcut||this.earcut;if(typeof exports==="object"&&typeof module==="object"){try{n=n||require("cannon")}catch(e){}try{o=o||require("oimo")}catch(e){}try{s=s||require("earcut")}catch(e){}module.exports=i(n,o,s)}else if(typeof define==="function"&&define.amd){if(require.specified&&require.specified("cannon"))r.push("cannon");if(require.specified&&require.specified("oimo"))r.push("oimo");if(require.specified&&require.specified("earcut"))r.push("earcut");define("babylonjs",r,i)}else if(typeof exports==="object"){try{n=n||require("cannon")}catch(e){}try{o=o||require("oimo")}catch(e){}try{s=s||require("earcut")}catch(e){}exports["babylonjs"]=i(n,o,s)}else{t["BABYLON"]=i(n,o,s)}})(this,function(e,t,i){e=e||this?this.CANNON:{};t=t||this.OIMO;i=i||this.earcut;"use strict";var r;(function(e){var t=function(){function e(){this._defines={};this._currentRank=32;this._maxRank=-1}e.prototype.unBindMesh=function(){this._mesh=null};e.prototype.addFallback=function(e,t){if(!this._defines[e]){if(e<this._currentRank){this._currentRank=e}if(e>this._maxRank){this._maxRank=e}this._defines[e]=new Array}this._defines[e].push(t)};e.prototype.addCPUSkinningFallback=function(e,t){this._mesh=t;if(e<this._currentRank){this._currentRank=e}if(e>this._maxRank){this._maxRank=e}};Object.defineProperty(e.prototype,"isMoreFallbacks",{get:function(){return this._currentRank<=this._maxRank},enumerable:true,configurable:true});e.prototype.reduce=function(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0&&this._mesh.material){this._mesh.computeBonesUsingShaders=false;e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0");var i=this._mesh.getScene();for(var r=0;r<i.meshes.length;r++){var n=i.meshes[r];if(!n.material){continue}if(!n.computeBonesUsingShaders||n.numBoneInfluencers===0){continue}if(n.material.getEffect()===t){n.computeBonesUsingShaders=false}else{for(var o=0,s=n.subMeshes;o<s.length;o++){var a=s[o];var u=a.effect;if(u===t){n.computeBonesUsingShaders=false;break}}}}}else{var l=this._defines[this._currentRank];if(l){for(var r=0;r<l.length;r++){e=e.replace("#define "+l[r],"")}}this._currentRank++}return e};return e}();e.EffectFallbacks=t;var i=function(){function e(){}return e}();e.EffectCreationOptions=i;var r=function(){function t(i,r,n,o,s,a,u,l,c,h){if(o===void 0){o=null}if(a===void 0){a=null}if(u===void 0){u=null}if(l===void 0){l=null}if(c===void 0){c=null}var f=this;this.uniqueId=0;this.onCompileObservable=new e.Observable;this.onErrorObservable=new e.Observable;this.onBindObservable=new e.Observable;this._uniformBuffersNames={};this._isReady=false;this._compilationError="";this.name=i;if(r.attributes){var d=r;this._engine=n;this._attributesNames=d.attributes;this._uniformsNames=d.uniformsNames.concat(d.samplers);this._samplers=d.samplers.slice();this.defines=d.defines;this.onError=d.onError;this.onCompiled=d.onCompiled;this._fallbacks=d.fallbacks;this._indexParameters=d.indexParameters;this._transformFeedbackVaryings=d.transformFeedbackVaryings;if(d.uniformBuffersNames){for(var p=0;p<d.uniformBuffersNames.length;p++){this._uniformBuffersNames[d.uniformBuffersNames[p]]=p}}}else{this._engine=s;this.defines=a;this._uniformsNames=n.concat(o);this._samplers=o?o.slice():[];this._attributesNames=r;this.onError=c;this.onCompiled=l;this._indexParameters=h;this._fallbacks=u}this.uniqueId=t._uniqueIdSeed++;var _;var m;if(i.vertexElement){_=document.getElementById(i.vertexElement);if(!_){_=i.vertexElement}}else{_=i.vertex||i}if(i.fragmentElement){m=document.getElementById(i.fragmentElement);if(!m){m=i.fragmentElement}}else{m=i.fragment||i}this._loadVertexShader(_,function(e){f._processIncludes(e,function(e){f._processShaderConversion(e,false,function(e){f._loadFragmentShader(m,function(t){f._processIncludes(t,function(t){f._processShaderConversion(t,true,function(t){if(i){var r=i.vertexElement||i.vertex||i;var n=i.fragmentElement||i.fragment||i;f._vertexSourceCode="#define SHADER_NAME vertex:"+r+"\n"+e;f._fragmentSourceCode="#define SHADER_NAME fragment:"+n+"\n"+t}else{f._vertexSourceCode=e;f._fragmentSourceCode=t}f._prepareEffect()})})})})})})}Object.defineProperty(t.prototype,"key",{get:function(){return this._key},enumerable:true,configurable:true});t.prototype.isReady=function(){return this._isReady};t.prototype.getEngine=function(){return this._engine};t.prototype.getProgram=function(){return this._program};t.prototype.getAttributesNames=function(){return this._attributesNames};t.prototype.getAttributeLocation=function(e){return this._attributes[e]};t.prototype.getAttributeLocationByName=function(e){var t=this._attributesNames.indexOf(e);return this._attributes[t]};t.prototype.getAttributesCount=function(){return this._attributes.length};t.prototype.getUniformIndex=function(e){return this._uniformsNames.indexOf(e)};t.prototype.getUniform=function(e){return this._uniforms[this._uniformsNames.indexOf(e)]};t.prototype.getSamplers=function(){return this._samplers};t.prototype.getCompilationError=function(){return this._compilationError};t.prototype.executeWhenCompiled=function(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(function(t){e(t)})};t.prototype._loadVertexShader=function(i,r){if(e.Tools.IsWindowObjectExist()){if(i instanceof HTMLElement){var n=e.Tools.GetDOMTextContent(i);r(n);return}}if(i.substr(0,7)==="base64:"){var o=window.atob(i.substr(7));r(o);return}if(t.ShadersStore[i+"VertexShader"]){r(t.ShadersStore[i+"VertexShader"]);return}var s;if(i[0]==="."||i[0]==="/"||i.indexOf("http")>-1){s=i}else{s=e.Engine.ShadersRepository+i}this._engine._loadFile(s+".vertex.fx",r)};t.prototype._loadFragmentShader=function(i,r){if(e.Tools.IsWindowObjectExist()){if(i instanceof HTMLElement){var n=e.Tools.GetDOMTextContent(i);r(n);return}}if(i.substr(0,7)==="base64:"){var o=window.atob(i.substr(7));r(o);return}if(t.ShadersStore[i+"PixelShader"]){r(t.ShadersStore[i+"PixelShader"]);return}if(t.ShadersStore[i+"FragmentShader"]){r(t.ShadersStore[i+"FragmentShader"]);return}var s;if(i[0]==="."||i[0]==="/"||i.indexOf("http")>-1){s=i}else{s=e.Engine.ShadersRepository+i}this._engine._loadFile(s+".fragment.fx",r)};t.prototype._dumpShadersSource=function(t,i,r){var n=this._engine.webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"";var o=n+(r?r+"\n":"");t=o+t;i=o+i;var s=2;var a=/\n/gm;var u="\n1\t"+t.replace(a,function(){return"\n"+s+++"\t"});s=2;var l="\n1\t"+i.replace(a,function(){return"\n"+s+++"\t"});if(this.name.vertexElement){e.Tools.Error("Vertex shader: "+this.name.vertexElement+u);e.Tools.Error("Fragment shader: "+this.name.fragmentElement+l)}else if(this.name.vertex){e.Tools.Error("Vertex shader: "+this.name.vertex+u);e.Tools.Error("Fragment shader: "+this.name.fragment+l)}else{e.Tools.Error("Vertex shader: "+this.name+u);e.Tools.Error("Fragment shader: "+this.name+l)}};t.prototype._processShaderConversion=function(e,t,i){var r=this._processPrecision(e);if(this._engine.webGLVersion==1){i(r);return}if(r.indexOf("#version 3")!==-1){i(r.replace("#version 300 es",""));return}var n=r.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1;var o=/#extension.+(GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;var s=r.replace(o,"");s=s.replace(/varying(?![\n\r])\s/g,t?"in ":"out ");s=s.replace(/attribute[ \t]/g,"in ");s=s.replace(/[ \t]attribute/g," in");if(t){s=s.replace(/texture2DLodEXT\s*\(/g,"textureLod(");s=s.replace(/textureCubeLodEXT\s*\(/g,"textureLod(");s=s.replace(/texture2D\s*\(/g,"texture(");s=s.replace(/textureCube\s*\(/g,"texture(");s=s.replace(/gl_FragDepthEXT/g,"gl_FragDepth");s=s.replace(/gl_FragColor/g,"glFragColor");s=s.replace(/gl_FragData/g,"glFragData");s=s.replace(/void\s+?main\s*\(/g,(n?"":"out vec4 glFragColor;\n")+"void main(")}i(s)};t.prototype._processIncludes=function(i,r){var n=this;var o=/#include<(.+)>(\((.*)\))*(\[(.*)\])*/g;var s=o.exec(i);var a=new String(i);while(s!=null){var u=s[1];if(u.indexOf("__decl__")!==-1){u=u.replace(/__decl__/,"");if(this._engine.supportsUniformBuffers){u=u.replace(/Vertex/,"Ubo");u=u.replace(/Fragment/,"Ubo")}u=u+"Declaration"}if(t.IncludesShadersStore[u]){var l=t.IncludesShadersStore[u];if(s[2]){var c=s[3].split(",");for(var h=0;h<c.length;h+=2){var f=new RegExp(c[h],"g");var d=c[h+1];l=l.replace(f,d)}}if(s[4]){var p=s[5];if(p.indexOf("..")!==-1){var _=p.split("..");var m=parseInt(_[0]);var g=parseInt(_[1]);var v=l.slice(0);l="";if(isNaN(g)){g=this._indexParameters[_[1]]}for(var y=m;y<g;y++){if(!this._engine.supportsUniformBuffers){v=v.replace(/light\{X\}.(\w*)/g,function(e,t){return t+"{X}"})}l+=v.replace(/\{X\}/g,y.toString())+"\n"}}else{if(!this._engine.supportsUniformBuffers){l=l.replace(/light\{X\}.(\w*)/g,function(e,t){return t+"{X}"})}l=l.replace(/\{X\}/g,p)}}a=a.replace(s[0],l)}else{var b=e.Engine.ShadersRepository+"ShadersInclude/"+u+".fx";this._engine._loadFile(b,function(e){t.IncludesShadersStore[u]=e;n._processIncludes(a,r)});return}s=o.exec(i)}r(a)};t.prototype._processPrecision=function(e){if(e.indexOf("precision highp float")===-1){if(!this._engine.getCaps().highPrecisionShaderSupported){e="precision mediump float;\n"+e}else{e="precision highp float;\n"+e}}else{if(!this._engine.getCaps().highPrecisionShaderSupported){e=e.replace("precision highp float","precision mediump float")}}return e};t.prototype._rebuildProgram=function(t,i,r,n){var o=this;this._isReady=false;this._vertexSourceCodeOverride=t;this._fragmentSourceCodeOverride=i;this.onError=function(e,t){if(n){n(t)}};this.onCompiled=function(){var t=o.getEngine().scenes;for(var i=0;i<t.length;i++){t[i].markAllMaterialsAsDirty(e.Material.TextureDirtyFlag)}if(r){r(o._program)}};this._fallbacks=null;this._prepareEffect()};t.prototype.getSpecificUniformLocations=function(e){var t=this._engine;return t.getUniforms(this._program,e)};t.prototype._prepareEffect=function(){var t=this._attributesNames;var i=this.defines;var r=this._fallbacks;this._valueCache={};var n=this._program;try{var o=this._engine;if(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride){this._program=o.createRawShaderProgram(this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,undefined,this._transformFeedbackVaryings)}else{this._program=o.createShaderProgram(this._vertexSourceCode,this._fragmentSourceCode,i,undefined,this._transformFeedbackVaryings)}this._program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this);if(o.supportsUniformBuffers){for(var s in this._uniformBuffersNames){this.bindUniformBlock(s,this._uniformBuffersNames[s])}}this._uniforms=o.getUniforms(this._program,this._uniformsNames);this._attributes=o.getAttributes(this._program,t);var a;for(a=0;a<this._samplers.length;a++){var u=this.getUniform(this._samplers[a]);if(u==null){this._samplers.splice(a,1);a--}}o.bindSamplers(this);this._compilationError="";this._isReady=true;if(this.onCompiled){this.onCompiled(this)}this.onCompileObservable.notifyObservers(this);this.onCompileObservable.clear();if(this._fallbacks){this._fallbacks.unBindMesh()}if(n){this.getEngine()._deleteProgram(n)}}catch(o){this._compilationError=o.message;e.Tools.Error("Unable to compile effect:");e.Tools.Error("Uniforms: "+this._uniformsNames.map(function(e){return" "+e}));e.Tools.Error("Attributes: "+t.map(function(e){return" "+e}));this._dumpShadersSource(this._vertexSourceCode,this._fragmentSourceCode,i);e.Tools.Error("Error: "+this._compilationError);if(n){this._program=n;this._isReady=true;if(this.onError){this.onError(this,this._compilationError)}this.onErrorObservable.notifyObservers(this)}if(r&&r.isMoreFallbacks){e.Tools.Error("Trying next fallback.");this.defines=r.reduce(this.defines,this);this._prepareEffect()}else{if(this.onError){this.onError(this,this._compilationError)}this.onErrorObservable.notifyObservers(this);this.onErrorObservable.clear();if(this._fallbacks){this._fallbacks.unBindMesh()}}}};Object.defineProperty(t.prototype,"isSupported",{get:function(){return this._compilationError===""},enumerable:true,configurable:true});t.prototype._bindTexture=function(e,t){this._engine._bindTexture(this._samplers.indexOf(e),t)};t.prototype.setTexture=function(e,t){this._engine.setTexture(this._samplers.indexOf(e),this.getUniform(e),t)};t.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers.indexOf(e),this.getUniform(e),t)};t.prototype.setTextureArray=function(e,t){if(this._samplers.indexOf(e+"Ex")===-1){var i=this._samplers.indexOf(e);for(var r=1;r<t.length;r++){this._samplers.splice(i+r,0,e+"Ex")}}this._engine.setTextureArray(this._samplers.indexOf(e),this.getUniform(e),t)};t.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers.indexOf(e),t)};t.prototype.setTextureFromPostProcessOutput=function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers.indexOf(e),t)};t.prototype._cacheMatrix=function(e,t){var i=this._valueCache[e];var r=t.updateFlag;if(i!==undefined&&i===r){return false}this._valueCache[e]=r;return true};t.prototype._cacheFloat2=function(e,t,i){var r=this._valueCache[e];if(!r){r=[t,i];this._valueCache[e]=r;return true}var n=false;if(r[0]!==t){r[0]=t;n=true}if(r[1]!==i){r[1]=i;n=true}return n};t.prototype._cacheFloat3=function(e,t,i,r){var n=this._valueCache[e];if(!n){n=[t,i,r];this._valueCache[e]=n;return true}var o=false;if(n[0]!==t){n[0]=t;o=true}if(n[1]!==i){n[1]=i;o=true}if(n[2]!==r){n[2]=r;o=true}return o};t.prototype._cacheFloat4=function(e,t,i,r,n){var o=this._valueCache[e];if(!o){o=[t,i,r,n];this._valueCache[e]=o;return true}var s=false;if(o[0]!==t){o[0]=t;s=true}if(o[1]!==i){o[1]=i;s=true}if(o[2]!==r){o[2]=r;s=true}if(o[3]!==n){o[3]=n;s=true}return s};t.prototype.bindUniformBuffer=function(e,i){var r=this._uniformBuffersNames[i];if(r===undefined||t._baseCache[r]===e){return}t._baseCache[r]=e;this._engine.bindUniformBufferBase(e,r)};t.prototype.bindUniformBlock=function(e,t){this._engine.bindUniformBlock(this._program,e,t)};t.prototype.setInt=function(e,t){var i=this._valueCache[e];if(i!==undefined&&i===t)return this;this._valueCache[e]=t;this._engine.setInt(this.getUniform(e),t);return this};t.prototype.setIntArray=function(e,t){this._valueCache[e]=null;this._engine.setIntArray(this.getUniform(e),t);return this};t.prototype.setIntArray2=function(e,t){this._valueCache[e]=null;this._engine.setIntArray2(this.getUniform(e),t);return this};t.prototype.setIntArray3=function(e,t){this._valueCache[e]=null;this._engine.setIntArray3(this.getUniform(e),t);return this};t.prototype.setIntArray4=function(e,t){this._valueCache[e]=null;this._engine.setIntArray4(this.getUniform(e),t);return this};t.prototype.setFloatArray=function(e,t){this._valueCache[e]=null;this._engine.setFloatArray(this.getUniform(e),t);return this};t.prototype.setFloatArray2=function(e,t){this._valueCache[e]=null;this._engine.setFloatArray2(this.getUniform(e),t);return this};t.prototype.setFloatArray3=function(e,t){this._valueCache[e]=null;this._engine.setFloatArray3(this.getUniform(e),t);return this};t.prototype.setFloatArray4=function(e,t){this._valueCache[e]=null;this._engine.setFloatArray4(this.getUniform(e),t);return this};t.prototype.setArray=function(e,t){this._valueCache[e]=null;this._engine.setArray(this.getUniform(e),t);return this};t.prototype.setArray2=function(e,t){this._valueCache[e]=null;this._engine.setArray2(this.getUniform(e),t);return this};t.prototype.setArray3=function(e,t){this._valueCache[e]=null;this._engine.setArray3(this.getUniform(e),t);return this};t.prototype.setArray4=function(e,t){this._valueCache[e]=null;this._engine.setArray4(this.getUniform(e),t);return this};t.prototype.setMatrices=function(e,t){if(!t){return this}this._valueCache[e]=null;this._engine.setMatrices(this.getUniform(e),t);return this};t.prototype.setMatrix=function(e,t){if(this._cacheMatrix(e,t)){this._engine.setMatrix(this.getUniform(e),t)}return this};t.prototype.setMatrix3x3=function(e,t){this._valueCache[e]=null;this._engine.setMatrix3x3(this.getUniform(e),t);return this};t.prototype.setMatrix2x2=function(e,t){this._valueCache[e]=null;this._engine.setMatrix2x2(this.getUniform(e),t);return this};t.prototype.setFloat=function(e,t){var i=this._valueCache[e];if(i!==undefined&&i===t)return this;this._valueCache[e]=t;this._engine.setFloat(this.getUniform(e),t);return this};t.prototype.setBool=function(e,t){var i=this._valueCache[e];if(i!==undefined&&i===t)return this;this._valueCache[e]=t;this._engine.setBool(this.getUniform(e),t?1:0);return this};t.prototype.setVector2=function(e,t){if(this._cacheFloat2(e,t.x,t.y)){this._engine.setFloat2(this.getUniform(e),t.x,t.y)}return this};t.prototype.setFloat2=function(e,t,i){if(this._cacheFloat2(e,t,i)){this._engine.setFloat2(this.getUniform(e),t,i)}return this};t.prototype.setVector3=function(e,t){if(this._cacheFloat3(e,t.x,t.y,t.z)){this._engine.setFloat3(this.getUniform(e),t.x,t.y,t.z)}return this};t.prototype.setFloat3=function(e,t,i,r){if(this._cacheFloat3(e,t,i,r)){this._engine.setFloat3(this.getUniform(e),t,i,r)}return this};t.prototype.setVector4=function(e,t){if(this._cacheFloat4(e,t.x,t.y,t.z,t.w)){this._engine.setFloat4(this.getUniform(e),t.x,t.y,t.z,t.w)}return this};t.prototype.setFloat4=function(e,t,i,r,n){if(this._cacheFloat4(e,t,i,r,n)){this._engine.setFloat4(this.getUniform(e),t,i,r,n)}return this};t.prototype.setColor3=function(e,t){if(this._cacheFloat3(e,t.r,t.g,t.b)){this._engine.setColor3(this.getUniform(e),t)}return this};t.prototype.setColor4=function(e,t,i){if(this._cacheFloat4(e,t.r,t.g,t.b,i)){this._engine.setColor4(this.getUniform(e),t,i)}return this};t.prototype.setDirectColor4=function(e,t){if(this._cacheFloat4(e,t.r,t.g,t.b,t.a)){this._engine.setDirectColor4(this.getUniform(e),t)}return this};t.ResetCache=function(){t._baseCache={}};t._uniqueIdSeed=0;t._baseCache={};t.ShadersStore={};t.IncludesShadersStore={};return t}();e.Effect=r})(r||(r={}));"use strict";"use strict";var r;(function(e){var t=function(){function e(){}Object.defineProperty(e,"KEYDOWN",{get:function(){return e._KEYDOWN},enumerable:true,configurable:true});Object.defineProperty(e,"KEYUP",{get:function(){return e._KEYUP},enumerable:true,configurable:true});e._KEYDOWN=1;e._KEYUP=2;return e}();e.KeyboardEventTypes=t;var i=function(){function e(e,t){this.type=e;this.event=t}return e}();e.KeyboardInfo=i;var r=function(e){__extends(t,e);function t(t,i){var r=e.call(this,t,i)||this;r.skipOnPointerObservable=false;return r}return t}(i);e.KeyboardInfoPre=r})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){}Object.defineProperty(e,"POINTERDOWN",{get:function(){return e._POINTERDOWN},enumerable:true,configurable:true});Object.defineProperty(e,"POINTERUP",{get:function(){return e._POINTERUP},enumerable:true,configurable:true});Object.defineProperty(e,"POINTERMOVE",{get:function(){return e._POINTERMOVE},enumerable:true,configurable:true});Object.defineProperty(e,"POINTERWHEEL",{get:function(){return e._POINTERWHEEL},enumerable:true,configurable:true});Object.defineProperty(e,"POINTERPICK",{get:function(){return e._POINTERPICK},enumerable:true,configurable:true});Object.defineProperty(e,"POINTERTAP",{get:function(){return e._POINTERTAP},enumerable:true,configurable:true});Object.defineProperty(e,"POINTERDOUBLETAP",{get:function(){return e._POINTERDOUBLETAP},enumerable:true,configurable:true});e._POINTERDOWN=1;e._POINTERUP=2;e._POINTERMOVE=4;e._POINTERWHEEL=8;e._POINTERPICK=16;e._POINTERTAP=32;e._POINTERDOUBLETAP=64;return e}();e.PointerEventTypes=t;var i=function(){function e(e,t){this.type=e;this.event=t}return e}();e.PointerInfoBase=i;var r=function(t){__extends(i,t);function i(i,r,n,o){var s=t.call(this,i,r)||this;s.skipOnPointerObservable=false;s.localPosition=new e.Vector2(n,o);return s}return i}(i);e.PointerInfoPre=r;var n=function(e){__extends(t,e);function t(t,i,r){var n=e.call(this,t,i)||this;n.pickInfo=r;return n}return t}(i);e.PointerInfo=n})(r||(r={}));"use strict";var r;(function(e){e.ToGammaSpace=1/2.2;e.ToLinearSpace=2.2;e.Epsilon=.001;var t=function(){function t(e,t,i){if(e===void 0){e=0}if(t===void 0){t=0}if(i===void 0){i=0}this.r=e;this.g=t;this.b=i}t.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"};t.prototype.getClassName=function(){return"Color3"};t.prototype.getHashCode=function(){var e=this.r||0;e=e*397^(this.g||0);e=e*397^(this.b||0);return e};t.prototype.toArray=function(e,t){if(t===undefined){t=0}e[t]=this.r;e[t+1]=this.g;e[t+2]=this.b;return this};t.prototype.toColor4=function(e){if(e===void 0){e=1}return new i(this.r,this.g,this.b,e)};t.prototype.asArray=function(){var e=new Array;this.toArray(e,0);return e};t.prototype.toLuminance=function(){return this.r*.3+this.g*.59+this.b*.11};t.prototype.multiply=function(e){return new t(this.r*e.r,this.g*e.g,this.b*e.b)};t.prototype.multiplyToRef=function(e,t){t.r=this.r*e.r;t.g=this.g*e.g;t.b=this.b*e.b;return this};t.prototype.equals=function(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b};t.prototype.equalsFloats=function(e,t,i){return this.r===e&&this.g===t&&this.b===i};t.prototype.scale=function(e){return new t(this.r*e,this.g*e,this.b*e)};t.prototype.scaleToRef=function(e,t){t.r=this.r*e;t.g=this.g*e;t.b=this.b*e;return this};t.prototype.scaleAndAddToRef=function(e,t){t.r+=this.r*e;t.g+=this.g*e;t.b+=this.b*e;return this};t.prototype.clampToRef=function(t,i,r){if(t===void 0){t=0}if(i===void 0){i=1}r.r=e.Scalar.Clamp(this.r,t,i);r.g=e.Scalar.Clamp(this.g,t,i);r.b=e.Scalar.Clamp(this.b,t,i);return this};t.prototype.add=function(e){return new t(this.r+e.r,this.g+e.g,this.b+e.b)};t.prototype.addToRef=function(e,t){t.r=this.r+e.r;t.g=this.g+e.g;t.b=this.b+e.b;return this};t.prototype.subtract=function(e){return new t(this.r-e.r,this.g-e.g,this.b-e.b)};t.prototype.subtractToRef=function(e,t){t.r=this.r-e.r;t.g=this.g-e.g;t.b=this.b-e.b;return this};t.prototype.clone=function(){return new t(this.r,this.g,this.b)};t.prototype.copyFrom=function(e){this.r=e.r;this.g=e.g;this.b=e.b;return this};t.prototype.copyFromFloats=function(e,t,i){this.r=e;this.g=t;this.b=i;return this};t.prototype.set=function(e,t,i){return this.copyFromFloats(e,t,i)};t.prototype.toHexString=function(){var t=this.r*255|0;var i=this.g*255|0;var r=this.b*255|0;return"#"+e.Scalar.ToHex(t)+e.Scalar.ToHex(i)+e.Scalar.ToHex(r)};t.prototype.toLinearSpace=function(){var e=new t;this.toLinearSpaceToRef(e);return e};t.prototype.toLinearSpaceToRef=function(t){t.r=Math.pow(this.r,e.ToLinearSpace);t.g=Math.pow(this.g,e.ToLinearSpace);t.b=Math.pow(this.b,e.ToLinearSpace);return this};t.prototype.toGammaSpace=function(){var e=new t;this.toGammaSpaceToRef(e);return e};t.prototype.toGammaSpaceToRef=function(t){t.r=Math.pow(this.r,e.ToGammaSpace);t.g=Math.pow(this.g,e.ToGammaSpace);t.b=Math.pow(this.b,e.ToGammaSpace);return this};t.FromHexString=function(e){if(e.substring(0,1)!=="#"||e.length!==7){return new t(0,0,0)}var i=parseInt(e.substring(1,3),16);var r=parseInt(e.substring(3,5),16);var n=parseInt(e.substring(5,7),16);return t.FromInts(i,r,n)};t.FromArray=function(e,i){if(i===void 0){i=0}return new t(e[i],e[i+1],e[i+2])};t.FromInts=function(e,i,r){return new t(e/255,i/255,r/255)};t.Lerp=function(e,i,r){var n=e.r+(i.r-e.r)*r;var o=e.g+(i.g-e.g)*r;var s=e.b+(i.b-e.b)*r;return new t(n,o,s)};t.Red=function(){return new t(1,0,0)};t.Green=function(){return new t(0,1,0)};t.Blue=function(){return new t(0,0,1)};t.Black=function(){return new t(0,0,0)};t.White=function(){return new t(1,1,1)};t.Purple=function(){return new t(.5,0,.5)};t.Magenta=function(){return new t(1,0,1)};t.Yellow=function(){return new t(1,1,0)};t.Gray=function(){return new t(.5,.5,.5)};t.Teal=function(){return new t(0,1,1)};t.Random=function(){return new t(Math.random(),Math.random(),Math.random())};return t}();e.Color3=t;var i=function(){function t(e,t,i,r){if(e===void 0){e=0}if(t===void 0){t=0}if(i===void 0){i=0}if(r===void 0){r=1}this.r=e;this.g=t;this.b=i;this.a=r}t.prototype.addInPlace=function(e){this.r+=e.r;this.g+=e.g;this.b+=e.b;this.a+=e.a;return this};t.prototype.asArray=function(){var e=new Array;this.toArray(e,0);return e};t.prototype.toArray=function(e,t){if(t===undefined){t=0}e[t]=this.r;e[t+1]=this.g;e[t+2]=this.b;e[t+3]=this.a;return this};t.prototype.add=function(e){return new t(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)};t.prototype.subtract=function(e){return new t(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)};t.prototype.subtractToRef=function(e,t){t.r=this.r-e.r;t.g=this.g-e.g;t.b=this.b-e.b;t.a=this.a-e.a;return this};t.prototype.scale=function(e){return new t(this.r*e,this.g*e,this.b*e,this.a*e)};t.prototype.scaleToRef=function(e,t){t.r=this.r*e;t.g=this.g*e;t.b=this.b*e;t.a=this.a*e;return this};t.prototype.scaleAndAddToRef=function(e,t){t.r+=this.r*e;t.g+=this.g*e;t.b+=this.b*e;t.a+=this.a*e;return this};t.prototype.clampToRef=function(t,i,r){if(t===void 0){t=0}if(i===void 0){i=1}r.r=e.Scalar.Clamp(this.r,t,i);r.g=e.Scalar.Clamp(this.g,t,i);r.b=e.Scalar.Clamp(this.b,t,i);r.a=e.Scalar.Clamp(this.a,t,i);return this};t.prototype.multiply=function(e){return new t(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)};t.prototype.multiplyToRef=function(e,t){t.r=this.r*e.r;t.g=this.g*e.g;t.b=this.b*e.b;t.a=this.a*e.a;return t};t.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"};t.prototype.getClassName=function(){return"Color4"};t.prototype.getHashCode=function(){var e=this.r||0;e=e*397^(this.g||0);e=e*397^(this.b||0);e=e*397^(this.a||0);return e};t.prototype.clone=function(){return new t(this.r,this.g,this.b,this.a)};t.prototype.copyFrom=function(e){this.r=e.r;this.g=e.g;this.b=e.b;this.a=e.a;return this};t.prototype.copyFromFloats=function(e,t,i,r){this.r=e;this.g=t;this.b=i;this.a=r;return this};t.prototype.set=function(e,t,i,r){return this.copyFromFloats(e,t,i,r)};t.prototype.toHexString=function(){var t=this.r*255|0;var i=this.g*255|0;var r=this.b*255|0;var n=this.a*255|0;return"#"+e.Scalar.ToHex(t)+e.Scalar.ToHex(i)+e.Scalar.ToHex(r)+e.Scalar.ToHex(n)};t.prototype.toLinearSpace=function(){var e=new t;this.toLinearSpaceToRef(e);return e};t.prototype.toLinearSpaceToRef=function(t){t.r=Math.pow(this.r,e.ToLinearSpace);t.g=Math.pow(this.g,e.ToLinearSpace);t.b=Math.pow(this.b,e.ToLinearSpace);t.a=this.a;return this};t.prototype.toGammaSpace=function(){var e=new t;this.toGammaSpaceToRef(e);return e};t.prototype.toGammaSpaceToRef=function(t){t.r=Math.pow(this.r,e.ToGammaSpace);t.g=Math.pow(this.g,e.ToGammaSpace);t.b=Math.pow(this.b,e.ToGammaSpace);t.a=this.a;return this};t.FromHexString=function(e){if(e.substring(0,1)!=="#"||e.length!==9){return new t(0,0,0,0)}var i=parseInt(e.substring(1,3),16);var r=parseInt(e.substring(3,5),16);var n=parseInt(e.substring(5,7),16);var o=parseInt(e.substring(7,9),16);return t.FromInts(i,r,n,o)};t.Lerp=function(e,i,r){var n=new t(0,0,0,0);t.LerpToRef(e,i,r,n);return n};t.LerpToRef=function(e,t,i,r){r.r=e.r+(t.r-e.r)*i;r.g=e.g+(t.g-e.g)*i;r.b=e.b+(t.b-e.b)*i;r.a=e.a+(t.a-e.a)*i};t.FromArray=function(e,i){if(i===void 0){i=0}return new t(e[i],e[i+1],e[i+2],e[i+3])};t.FromInts=function(e,i,r,n){return new t(e/255,i/255,r/255,n/255)};t.CheckColors4=function(e,t){if(e.length===t*3){var i=[];for(var r=0;r<e.length;r+=3){var n=r/3*4;i[n]=e[r];i[n+1]=e[r+1];i[n+2]=e[r+2];i[n+3]=1}return i}return e};return t}();e.Color4=i;var r=function(){function t(e,t){this.x=e;this.y=t}t.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+"}"};t.prototype.getClassName=function(){return"Vector2"};t.prototype.getHashCode=function(){var e=this.x||0;e=e*397^(this.y||0);return e};t.prototype.toArray=function(e,t){if(t===void 0){t=0}e[t]=this.x;e[t+1]=this.y;return this};t.prototype.asArray=function(){var e=new Array;this.toArray(e,0);return e};t.prototype.copyFrom=function(e){this.x=e.x;this.y=e.y;return this};t.prototype.copyFromFloats=function(e,t){this.x=e;this.y=t;return this};t.prototype.set=function(e,t){return this.copyFromFloats(e,t)};t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y)};t.prototype.addToRef=function(e,t){t.x=this.x+e.x;t.y=this.y+e.y;return this};t.prototype.addInPlace=function(e){this.x+=e.x;this.y+=e.y;return this};t.prototype.addVector3=function(e){return new t(this.x+e.x,this.y+e.y)};t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y)};t.prototype.subtractToRef=function(e,t){t.x=this.x-e.x;t.y=this.y-e.y;return this};t.prototype.subtractInPlace=function(e){this.x-=e.x;this.y-=e.y;return this};t.prototype.multiplyInPlace=function(e){this.x*=e.x;this.y*=e.y;return this};t.prototype.multiply=function(e){return new t(this.x*e.x,this.y*e.y)};t.prototype.multiplyToRef=function(e,t){t.x=this.x*e.x;t.y=this.y*e.y;return this};t.prototype.multiplyByFloats=function(e,i){return new t(this.x*e,this.y*i)};t.prototype.divide=function(e){return new t(this.x/e.x,this.y/e.y)};t.prototype.divideToRef=function(e,t){t.x=this.x/e.x;t.y=this.y/e.y;return this};t.prototype.divideInPlace=function(e){return this.divideToRef(e,this)};t.prototype.negate=function(){return new t(-this.x,-this.y)};t.prototype.scaleInPlace=function(e){this.x*=e;this.y*=e;return this};t.prototype.scale=function(e){var i=new t(0,0);this.scaleToRef(e,i);return i};t.prototype.scaleToRef=function(e,t){t.x=this.x*e;t.y=this.y*e;return this};t.prototype.scaleAndAddToRef=function(e,t){t.x+=this.x*e;t.y+=this.y*e;return this};t.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y};t.prototype.equalsWithEpsilon=function(t,i){if(i===void 0){i=e.Epsilon}return t&&e.Scalar.WithinEpsilon(this.x,t.x,i)&&e.Scalar.WithinEpsilon(this.y,t.y,i)};t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y};t.prototype.normalize=function(){var e=this.length();if(e===0)return this;var t=1/e;this.x*=t;this.y*=t;return this};t.prototype.clone=function(){return new t(this.x,this.y)};t.Zero=function(){return new t(0,0)};t.One=function(){return new t(1,1)};t.FromArray=function(e,i){if(i===void 0){i=0}return new t(e[i],e[i+1])};t.FromArrayToRef=function(e,t,i){i.x=e[t];i.y=e[t+1]};t.CatmullRom=function(e,i,r,n,o){var s=o*o;var a=o*s;var u=.5*(2*i.x+(-e.x+r.x)*o+(2*e.x-5*i.x+4*r.x-n.x)*s+(-e.x+3*i.x-3*r.x+n.x)*a);var l=.5*(2*i.y+(-e.y+r.y)*o+(2*e.y-5*i.y+4*r.y-n.y)*s+(-e.y+3*i.y-3*r.y+n.y)*a);return new t(u,l)};t.Clamp=function(e,i,r){var n=e.x;n=n>r.x?r.x:n;n=n<i.x?i.x:n;var o=e.y;o=o>r.y?r.y:o;o=o<i.y?i.y:o;return new t(n,o)};t.Hermite=function(e,i,r,n,o){var s=o*o;var a=o*s;var u=2*a-3*s+1;var l=-2*a+3*s;var c=a-2*s+o;var h=a-s;var f=e.x*u+r.x*l+i.x*c+n.x*h;var d=e.y*u+r.y*l+i.y*c+n.y*h;return new t(f,d)};t.Lerp=function(e,i,r){var n=e.x+(i.x-e.x)*r;var o=e.y+(i.y-e.y)*r;return new t(n,o)};t.Dot=function(e,t){return e.x*t.x+e.y*t.y};t.Normalize=function(e){var t=e.clone();t.normalize();return t};t.Minimize=function(e,i){var r=e.x<i.x?e.x:i.x;var n=e.y<i.y?e.y:i.y;return new t(r,n)};t.Maximize=function(e,i){var r=e.x>i.x?e.x:i.x;var n=e.y>i.y?e.y:i.y;return new t(r,n)};t.Transform=function(e,i){var r=t.Zero();t.TransformToRef(e,i,r);return r};t.TransformToRef=function(e,t,i){var r=e.x*t.m[0]+e.y*t.m[4]+t.m[12]
;var n=e.x*t.m[1]+e.y*t.m[5]+t.m[13];i.x=r;i.y=n};t.PointInTriangle=function(e,t,i,r){var n=1/2*(-i.y*r.x+t.y*(-i.x+r.x)+t.x*(i.y-r.y)+i.x*r.y);var o=n<0?-1:1;var s=(t.y*r.x-t.x*r.y+(r.y-t.y)*e.x+(t.x-r.x)*e.y)*o;var a=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*o;return s>0&&a>0&&s+a<2*n*o};t.Distance=function(e,i){return Math.sqrt(t.DistanceSquared(e,i))};t.DistanceSquared=function(e,t){var i=e.x-t.x;var r=e.y-t.y;return i*i+r*r};t.Center=function(e,t){var i=e.add(t);i.scaleInPlace(.5);return i};t.DistanceOfPointFromSegment=function(e,i,r){var n=t.DistanceSquared(i,r);if(n===0){return t.Distance(e,i)}var o=r.subtract(i);var s=Math.max(0,Math.min(1,t.Dot(e.subtract(i),o)/n));var a=i.add(o.multiplyByFloats(s,s));return t.Distance(e,a)};return t}();e.Vector2=r;var n=function(){function t(e,t,i){this.x=e;this.y=t;this.z=i}t.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+"}"};t.prototype.getClassName=function(){return"Vector3"};t.prototype.getHashCode=function(){var e=this.x||0;e=e*397^(this.y||0);e=e*397^(this.z||0);return e};t.prototype.asArray=function(){var e=[];this.toArray(e,0);return e};t.prototype.toArray=function(e,t){if(t===void 0){t=0}e[t]=this.x;e[t+1]=this.y;e[t+2]=this.z;return this};t.prototype.toQuaternion=function(){var e=new a(0,0,0,1);var t=Math.cos((this.x+this.z)*.5);var i=Math.sin((this.x+this.z)*.5);var r=Math.cos((this.z-this.x)*.5);var n=Math.sin((this.z-this.x)*.5);var o=Math.cos(this.y*.5);var s=Math.sin(this.y*.5);e.x=r*s;e.y=-n*s;e.z=i*o;e.w=t*o;return e};t.prototype.addInPlace=function(e){this.x+=e.x;this.y+=e.y;this.z+=e.z;return this};t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z)};t.prototype.addToRef=function(e,t){t.x=this.x+e.x;t.y=this.y+e.y;t.z=this.z+e.z;return this};t.prototype.subtractInPlace=function(e){this.x-=e.x;this.y-=e.y;this.z-=e.z;return this};t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z)};t.prototype.subtractToRef=function(e,t){t.x=this.x-e.x;t.y=this.y-e.y;t.z=this.z-e.z;return this};t.prototype.subtractFromFloats=function(e,i,r){return new t(this.x-e,this.y-i,this.z-r)};t.prototype.subtractFromFloatsToRef=function(e,t,i,r){r.x=this.x-e;r.y=this.y-t;r.z=this.z-i;return this};t.prototype.negate=function(){return new t(-this.x,-this.y,-this.z)};t.prototype.scaleInPlace=function(e){this.x*=e;this.y*=e;this.z*=e;return this};t.prototype.scale=function(e){return new t(this.x*e,this.y*e,this.z*e)};t.prototype.scaleToRef=function(e,t){t.x=this.x*e;t.y=this.y*e;t.z=this.z*e;return this};t.prototype.scaleAndAddToRef=function(e,t){t.x+=this.x*e;t.y+=this.y*e;t.z+=this.z*e;return this};t.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z};t.prototype.equalsWithEpsilon=function(t,i){if(i===void 0){i=e.Epsilon}return t&&e.Scalar.WithinEpsilon(this.x,t.x,i)&&e.Scalar.WithinEpsilon(this.y,t.y,i)&&e.Scalar.WithinEpsilon(this.z,t.z,i)};t.prototype.equalsToFloats=function(e,t,i){return this.x===e&&this.y===t&&this.z===i};t.prototype.multiplyInPlace=function(e){this.x*=e.x;this.y*=e.y;this.z*=e.z;return this};t.prototype.multiply=function(e){return new t(this.x*e.x,this.y*e.y,this.z*e.z)};t.prototype.multiplyToRef=function(e,t){t.x=this.x*e.x;t.y=this.y*e.y;t.z=this.z*e.z;return this};t.prototype.multiplyByFloats=function(e,i,r){return new t(this.x*e,this.y*i,this.z*r)};t.prototype.divide=function(e){return new t(this.x/e.x,this.y/e.y,this.z/e.z)};t.prototype.divideToRef=function(e,t){t.x=this.x/e.x;t.y=this.y/e.y;t.z=this.z/e.z;return this};t.prototype.divideInPlace=function(e){return this.divideToRef(e,this)};t.prototype.minimizeInPlace=function(e){if(e.x<this.x)this.x=e.x;if(e.y<this.y)this.y=e.y;if(e.z<this.z)this.z=e.z;return this};t.prototype.maximizeInPlace=function(e){if(e.x>this.x)this.x=e.x;if(e.y>this.y)this.y=e.y;if(e.z>this.z)this.z=e.z;return this};Object.defineProperty(t.prototype,"isNonUniform",{get:function(){var e=Math.abs(this.x);var t=Math.abs(this.y);if(e!==t){return true}var i=Math.abs(this.z);if(e!==i){return true}if(t!==i){return true}return false},enumerable:true,configurable:true});t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z};t.prototype.normalize=function(){var e=this.length();if(e===0||e===1)return this;var t=1/e;this.x*=t;this.y*=t;this.z*=t;return this};t.prototype.normalizeToNew=function(){var e=new t(0,0,0);this.normalizeToRef(e);return e};t.prototype.normalizeToRef=function(e){var t=this.length();if(t===0||t===1){e.set(this.x,this.y,this.z);return e}var i=1/t;this.scaleToRef(i,e);return e};t.prototype.clone=function(){return new t(this.x,this.y,this.z)};t.prototype.copyFrom=function(e){this.x=e.x;this.y=e.y;this.z=e.z;return this};t.prototype.copyFromFloats=function(e,t,i){this.x=e;this.y=t;this.z=i;return this};t.prototype.set=function(e,t,i){return this.copyFromFloats(e,t,i)};t.GetClipFactor=function(e,i,r,n){var o=t.Dot(e,r)-n;var s=t.Dot(i,r)-n;var a=o/(o-s);return a};t.GetAngleBetweenVectors=function(e,i,r){var n=e.clone().normalize();var o=i.clone().normalize();var s=t.Dot(n,o);var a=t.Cross(n,o);if(t.Dot(a,r)>0){return Math.acos(s)}return-Math.acos(s)};t.FromArray=function(e,i){if(!i){i=0}return new t(e[i],e[i+1],e[i+2])};t.FromFloatArray=function(e,i){return t.FromArray(e,i)};t.FromArrayToRef=function(e,t,i){i.x=e[t];i.y=e[t+1];i.z=e[t+2]};t.FromFloatArrayToRef=function(e,i,r){return t.FromArrayToRef(e,i,r)};t.FromFloatsToRef=function(e,t,i,r){r.x=e;r.y=t;r.z=i};t.Zero=function(){return new t(0,0,0)};t.One=function(){return new t(1,1,1)};t.Up=function(){return new t(0,1,0)};t.Forward=function(){return new t(0,0,1)};t.Right=function(){return new t(1,0,0)};t.Left=function(){return new t(-1,0,0)};t.TransformCoordinates=function(e,i){var r=t.Zero();t.TransformCoordinatesToRef(e,i,r);return r};t.TransformCoordinatesToRef=function(e,t,i){var r=e.x*t.m[0]+e.y*t.m[4]+e.z*t.m[8]+t.m[12];var n=e.x*t.m[1]+e.y*t.m[5]+e.z*t.m[9]+t.m[13];var o=e.x*t.m[2]+e.y*t.m[6]+e.z*t.m[10]+t.m[14];var s=e.x*t.m[3]+e.y*t.m[7]+e.z*t.m[11]+t.m[15];i.x=r/s;i.y=n/s;i.z=o/s};t.TransformCoordinatesFromFloatsToRef=function(e,t,i,r,n){var o=e*r.m[0]+t*r.m[4]+i*r.m[8]+r.m[12];var s=e*r.m[1]+t*r.m[5]+i*r.m[9]+r.m[13];var a=e*r.m[2]+t*r.m[6]+i*r.m[10]+r.m[14];var u=e*r.m[3]+t*r.m[7]+i*r.m[11]+r.m[15];n.x=o/u;n.y=s/u;n.z=a/u};t.TransformNormal=function(e,i){var r=t.Zero();t.TransformNormalToRef(e,i,r);return r};t.TransformNormalToRef=function(e,t,i){var r=e.x*t.m[0]+e.y*t.m[4]+e.z*t.m[8];var n=e.x*t.m[1]+e.y*t.m[5]+e.z*t.m[9];var o=e.x*t.m[2]+e.y*t.m[6]+e.z*t.m[10];i.x=r;i.y=n;i.z=o};t.TransformNormalFromFloatsToRef=function(e,t,i,r,n){n.x=e*r.m[0]+t*r.m[4]+i*r.m[8];n.y=e*r.m[1]+t*r.m[5]+i*r.m[9];n.z=e*r.m[2]+t*r.m[6]+i*r.m[10]};t.CatmullRom=function(e,i,r,n,o){var s=o*o;var a=o*s;var u=.5*(2*i.x+(-e.x+r.x)*o+(2*e.x-5*i.x+4*r.x-n.x)*s+(-e.x+3*i.x-3*r.x+n.x)*a);var l=.5*(2*i.y+(-e.y+r.y)*o+(2*e.y-5*i.y+4*r.y-n.y)*s+(-e.y+3*i.y-3*r.y+n.y)*a);var c=.5*(2*i.z+(-e.z+r.z)*o+(2*e.z-5*i.z+4*r.z-n.z)*s+(-e.z+3*i.z-3*r.z+n.z)*a);return new t(u,l,c)};t.Clamp=function(e,i,r){var n=e.x;n=n>r.x?r.x:n;n=n<i.x?i.x:n;var o=e.y;o=o>r.y?r.y:o;o=o<i.y?i.y:o;var s=e.z;s=s>r.z?r.z:s;s=s<i.z?i.z:s;return new t(n,o,s)};t.Hermite=function(e,i,r,n,o){var s=o*o;var a=o*s;var u=2*a-3*s+1;var l=-2*a+3*s;var c=a-2*s+o;var h=a-s;var f=e.x*u+r.x*l+i.x*c+n.x*h;var d=e.y*u+r.y*l+i.y*c+n.y*h;var p=e.z*u+r.z*l+i.z*c+n.z*h;return new t(f,d,p)};t.Lerp=function(e,i,r){var n=new t(0,0,0);t.LerpToRef(e,i,r,n);return n};t.LerpToRef=function(e,t,i,r){r.x=e.x+(t.x-e.x)*i;r.y=e.y+(t.y-e.y)*i;r.z=e.z+(t.z-e.z)*i};t.Dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z};t.Cross=function(e,i){var r=t.Zero();t.CrossToRef(e,i,r);return r};t.CrossToRef=function(e,t,i){P.Vector3[0].x=e.y*t.z-e.z*t.y;P.Vector3[0].y=e.z*t.x-e.x*t.z;P.Vector3[0].z=e.x*t.y-e.y*t.x;i.copyFrom(P.Vector3[0])};t.Normalize=function(e){var i=t.Zero();t.NormalizeToRef(e,i);return i};t.NormalizeToRef=function(e,t){t.copyFrom(e);t.normalize()};t.Project=function(e,i,r,n){var o=n.width;var s=n.height;var a=n.x;var l=n.y;var c=t._viewportMatrixCache?t._viewportMatrixCache:t._viewportMatrixCache=new u;u.FromValuesToRef(o/2,0,0,0,0,-s/2,0,0,0,0,.5,0,a+o/2,s/2+l,.5,1,c);var h=P.Matrix[0];i.multiplyToRef(r,h);h.multiplyToRef(c,h);return t.TransformCoordinates(e,h)};t.UnprojectFromTransform=function(i,r,n,o,s){var a=P.Matrix[0];o.multiplyToRef(s,a);a.invert();i.x=i.x/r*2-1;i.y=-(i.y/n*2-1);var u=t.TransformCoordinates(i,a);var l=i.x*a.m[3]+i.y*a.m[7]+i.z*a.m[11]+a.m[15];if(e.Scalar.WithinEpsilon(l,1)){u=u.scale(1/l)}return u};t.Unproject=function(e,i,r,n,o,s){var a=t.Zero();t.UnprojectToRef(e,i,r,n,o,s,a);return a};t.UnprojectToRef=function(e,i,r,n,o,s,a){t.UnprojectFloatsToRef(e.x,e.y,e.z,i,r,n,o,s,a)};t.UnprojectFloatsToRef=function(i,r,n,o,s,a,u,l,c){var h=P.Matrix[0];a.multiplyToRef(u,h);h.multiplyToRef(l,h);h.invert();var f=P.Vector3[0];f.x=i/o*2-1;f.y=-(r/s*2-1);f.z=2*n-1;t.TransformCoordinatesToRef(f,h,c);var d=f.x*h.m[3]+f.y*h.m[7]+f.z*h.m[11]+h.m[15];if(e.Scalar.WithinEpsilon(d,1)){c.scaleInPlace(1/d)}};t.Minimize=function(e,t){var i=e.clone();i.minimizeInPlace(t);return i};t.Maximize=function(e,t){var i=e.clone();i.maximizeInPlace(t);return i};t.Distance=function(e,i){return Math.sqrt(t.DistanceSquared(e,i))};t.DistanceSquared=function(e,t){var i=e.x-t.x;var r=e.y-t.y;var n=e.z-t.z;return i*i+r*r+n*n};t.Center=function(e,t){var i=e.add(t);i.scaleInPlace(.5);return i};t.RotationFromAxis=function(e,i,r){var n=t.Zero();t.RotationFromAxisToRef(e,i,r,n);return n};t.RotationFromAxisToRef=function(e,t,i,r){var n=P.Quaternion[0];a.RotationQuaternionFromAxisToRef(e,t,i,n);n.toEulerAnglesToRef(r)};return t}();e.Vector3=n;var o=function(){function t(e,t,i,r){this.x=e;this.y=t;this.z=i;this.w=r}t.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"};t.prototype.getClassName=function(){return"Vector4"};t.prototype.getHashCode=function(){var e=this.x||0;e=e*397^(this.y||0);e=e*397^(this.z||0);e=e*397^(this.w||0);return e};t.prototype.asArray=function(){var e=new Array;this.toArray(e,0);return e};t.prototype.toArray=function(e,t){if(t===undefined){t=0}e[t]=this.x;e[t+1]=this.y;e[t+2]=this.z;e[t+3]=this.w;return this};t.prototype.addInPlace=function(e){this.x+=e.x;this.y+=e.y;this.z+=e.z;this.w+=e.w;return this};t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)};t.prototype.addToRef=function(e,t){t.x=this.x+e.x;t.y=this.y+e.y;t.z=this.z+e.z;t.w=this.w+e.w;return this};t.prototype.subtractInPlace=function(e){this.x-=e.x;this.y-=e.y;this.z-=e.z;this.w-=e.w;return this};t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)};t.prototype.subtractToRef=function(e,t){t.x=this.x-e.x;t.y=this.y-e.y;t.z=this.z-e.z;t.w=this.w-e.w;return this};t.prototype.subtractFromFloats=function(e,i,r,n){return new t(this.x-e,this.y-i,this.z-r,this.w-n)};t.prototype.subtractFromFloatsToRef=function(e,t,i,r,n){n.x=this.x-e;n.y=this.y-t;n.z=this.z-i;n.w=this.w-r;return this};t.prototype.negate=function(){return new t(-this.x,-this.y,-this.z,-this.w)};t.prototype.scaleInPlace=function(e){this.x*=e;this.y*=e;this.z*=e;this.w*=e;return this};t.prototype.scale=function(e){return new t(this.x*e,this.y*e,this.z*e,this.w*e)};t.prototype.scaleToRef=function(e,t){t.x=this.x*e;t.y=this.y*e;t.z=this.z*e;t.w=this.w*e;return this};t.prototype.scaleAndAddToRef=function(e,t){t.x+=this.x*e;t.y+=this.y*e;t.z+=this.z*e;t.w+=this.w*e;return this};t.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w};t.prototype.equalsWithEpsilon=function(t,i){if(i===void 0){i=e.Epsilon}return t&&e.Scalar.WithinEpsilon(this.x,t.x,i)&&e.Scalar.WithinEpsilon(this.y,t.y,i)&&e.Scalar.WithinEpsilon(this.z,t.z,i)&&e.Scalar.WithinEpsilon(this.w,t.w,i)};t.prototype.equalsToFloats=function(e,t,i,r){return this.x===e&&this.y===t&&this.z===i&&this.w===r};t.prototype.multiplyInPlace=function(e){this.x*=e.x;this.y*=e.y;this.z*=e.z;this.w*=e.w;return this};t.prototype.multiply=function(e){return new t(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)};t.prototype.multiplyToRef=function(e,t){t.x=this.x*e.x;t.y=this.y*e.y;t.z=this.z*e.z;t.w=this.w*e.w;return this};t.prototype.multiplyByFloats=function(e,i,r,n){return new t(this.x*e,this.y*i,this.z*r,this.w*n)};t.prototype.divide=function(e){return new t(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)};t.prototype.divideToRef=function(e,t){t.x=this.x/e.x;t.y=this.y/e.y;t.z=this.z/e.z;t.w=this.w/e.w;return this};t.prototype.divideInPlace=function(e){return this.divideToRef(e,this)};t.prototype.minimizeInPlace=function(e){if(e.x<this.x)this.x=e.x;if(e.y<this.y)this.y=e.y;if(e.z<this.z)this.z=e.z;if(e.w<this.w)this.w=e.w;return this};t.prototype.maximizeInPlace=function(e){if(e.x>this.x)this.x=e.x;if(e.y>this.y)this.y=e.y;if(e.z>this.z)this.z=e.z;if(e.w>this.w)this.w=e.w;return this};t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)};t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w};t.prototype.normalize=function(){var e=this.length();if(e===0)return this;var t=1/e;this.x*=t;this.y*=t;this.z*=t;this.w*=t;return this};t.prototype.toVector3=function(){return new n(this.x,this.y,this.z)};t.prototype.clone=function(){return new t(this.x,this.y,this.z,this.w)};t.prototype.copyFrom=function(e){this.x=e.x;this.y=e.y;this.z=e.z;this.w=e.w;return this};t.prototype.copyFromFloats=function(e,t,i,r){this.x=e;this.y=t;this.z=i;this.w=r;return this};t.prototype.set=function(e,t,i,r){return this.copyFromFloats(e,t,i,r)};t.FromArray=function(e,i){if(!i){i=0}return new t(e[i],e[i+1],e[i+2],e[i+3])};t.FromArrayToRef=function(e,t,i){i.x=e[t];i.y=e[t+1];i.z=e[t+2];i.w=e[t+3]};t.FromFloatArrayToRef=function(e,i,r){t.FromArrayToRef(e,i,r)};t.FromFloatsToRef=function(e,t,i,r,n){n.x=e;n.y=t;n.z=i;n.w=r};t.Zero=function(){return new t(0,0,0,0)};t.One=function(){return new t(1,1,1,1)};t.Normalize=function(e){var i=t.Zero();t.NormalizeToRef(e,i);return i};t.NormalizeToRef=function(e,t){t.copyFrom(e);t.normalize()};t.Minimize=function(e,t){var i=e.clone();i.minimizeInPlace(t);return i};t.Maximize=function(e,t){var i=e.clone();i.maximizeInPlace(t);return i};t.Distance=function(e,i){return Math.sqrt(t.DistanceSquared(e,i))};t.DistanceSquared=function(e,t){var i=e.x-t.x;var r=e.y-t.y;var n=e.z-t.z;var o=e.w-t.w;return i*i+r*r+n*n+o*o};t.Center=function(e,t){var i=e.add(t);i.scaleInPlace(.5);return i};t.TransformNormal=function(e,i){var r=t.Zero();t.TransformNormalToRef(e,i,r);return r};t.TransformNormalToRef=function(e,t,i){var r=e.x*t.m[0]+e.y*t.m[4]+e.z*t.m[8];var n=e.x*t.m[1]+e.y*t.m[5]+e.z*t.m[9];var o=e.x*t.m[2]+e.y*t.m[6]+e.z*t.m[10];i.x=r;i.y=n;i.z=o;i.w=e.w};t.TransformNormalFromFloatsToRef=function(e,t,i,r,n,o){o.x=e*n.m[0]+t*n.m[4]+i*n.m[8];o.y=e*n.m[1]+t*n.m[5]+i*n.m[9];o.z=e*n.m[2]+t*n.m[6]+i*n.m[10];o.w=r};return t}();e.Vector4=o;var s=function(){function e(e,t){this.width=e;this.height=t}e.prototype.toString=function(){return"{W: "+this.width+", H: "+this.height+"}"};e.prototype.getClassName=function(){return"Size"};e.prototype.getHashCode=function(){var e=this.width||0;e=e*397^(this.height||0);return e};e.prototype.copyFrom=function(e){this.width=e.width;this.height=e.height};e.prototype.copyFromFloats=function(e,t){this.width=e;this.height=t;return this};e.prototype.set=function(e,t){return this.copyFromFloats(e,t)};e.prototype.multiplyByFloats=function(t,i){return new e(this.width*t,this.height*i)};e.prototype.clone=function(){return new e(this.width,this.height)};e.prototype.equals=function(e){if(!e){return false}return this.width===e.width&&this.height===e.height};Object.defineProperty(e.prototype,"surface",{get:function(){return this.width*this.height},enumerable:true,configurable:true});e.Zero=function(){return new e(0,0)};e.prototype.add=function(t){var i=new e(this.width+t.width,this.height+t.height);return i};e.prototype.subtract=function(t){var i=new e(this.width-t.width,this.height-t.height);return i};e.Lerp=function(t,i,r){var n=t.width+(i.width-t.width)*r;var o=t.height+(i.height-t.height)*r;return new e(n,o)};return e}();e.Size=s;var a=function(){function e(e,t,i,r){if(e===void 0){e=0}if(t===void 0){t=0}if(i===void 0){i=0}if(r===void 0){r=1}this.x=e;this.y=t;this.z=i;this.w=r}e.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"};e.prototype.getClassName=function(){return"Quaternion"};e.prototype.getHashCode=function(){var e=this.x||0;e=e*397^(this.y||0);e=e*397^(this.z||0);e=e*397^(this.w||0);return e};e.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]};e.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w};e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)};e.prototype.copyFrom=function(e){this.x=e.x;this.y=e.y;this.z=e.z;this.w=e.w;return this};e.prototype.copyFromFloats=function(e,t,i,r){this.x=e;this.y=t;this.z=i;this.w=r;return this};e.prototype.set=function(e,t,i,r){return this.copyFromFloats(e,t,i,r)};e.prototype.add=function(t){return new e(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)};e.prototype.subtract=function(t){return new e(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)};e.prototype.scale=function(t){return new e(this.x*t,this.y*t,this.z*t,this.w*t)};e.prototype.scaleToRef=function(e,t){t.x=this.x*e;t.y=this.y*e;t.z=this.z*e;t.w=this.w*e;return this};e.prototype.scaleAndAddToRef=function(e,t){t.x+=this.x*e;t.y+=this.y*e;t.z+=this.z*e;t.w+=this.w*e;return this};e.prototype.multiply=function(t){var i=new e(0,0,0,1);this.multiplyToRef(t,i);return i};e.prototype.multiplyToRef=function(e,t){var i=this.x*e.w+this.y*e.z-this.z*e.y+this.w*e.x;var r=-this.x*e.z+this.y*e.w+this.z*e.x+this.w*e.y;var n=this.x*e.y-this.y*e.x+this.z*e.w+this.w*e.z;var o=-this.x*e.x-this.y*e.y-this.z*e.z+this.w*e.w;t.copyFromFloats(i,r,n,o);return this};e.prototype.multiplyInPlace=function(e){this.multiplyToRef(e,this);return this};e.prototype.conjugateToRef=function(e){e.copyFromFloats(-this.x,-this.y,-this.z,this.w);return this};e.prototype.conjugateInPlace=function(){this.x*=-1;this.y*=-1;this.z*=-1;return this};e.prototype.conjugate=function(){var t=new e(-this.x,-this.y,-this.z,this.w);return t};e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)};e.prototype.normalize=function(){var e=1/this.length();this.x*=e;this.y*=e;this.z*=e;this.w*=e;return this};e.prototype.toEulerAngles=function(e){if(e===void 0){e="YZX"}var t=n.Zero();this.toEulerAnglesToRef(t,e);return t};e.prototype.toEulerAnglesToRef=function(e,t){if(t===void 0){t="YZX"}var i=this.z;var r=this.x;var n=this.y;var o=this.w;var s=o*o;var a=i*i;var u=r*r;var l=n*n;var c=n*i-r*o;var h=.4999999;if(c<-h){e.y=2*Math.atan2(n,o);e.x=Math.PI/2;e.z=0}else if(c>h){e.y=2*Math.atan2(n,o);e.x=-Math.PI/2;e.z=0}else{e.z=Math.atan2(2*(r*n+i*o),-a-u+l+s);e.x=Math.asin(-2*(i*n-r*o));e.y=Math.atan2(2*(i*r+n*o),a-u-l+s)}return this};e.prototype.toRotationMatrix=function(e){var t=this.x*this.x;var i=this.y*this.y;var r=this.z*this.z;var n=this.x*this.y;var o=this.z*this.w;var s=this.z*this.x;var a=this.y*this.w;var u=this.y*this.z;var l=this.x*this.w;e.m[0]=1-2*(i+r);e.m[1]=2*(n+o);e.m[2]=2*(s-a);e.m[3]=0;e.m[4]=2*(n-o);e.m[5]=1-2*(r+t);e.m[6]=2*(u+l);e.m[7]=0;e.m[8]=2*(s+a);e.m[9]=2*(u-l);e.m[10]=1-2*(i+t);e.m[11]=0;e.m[12]=0;e.m[13]=0;e.m[14]=0;e.m[15]=1;e._markAsUpdated();return this};e.prototype.fromRotationMatrix=function(t){e.FromRotationMatrixToRef(t,this);return this};e.FromRotationMatrix=function(t){var i=new e;e.FromRotationMatrixToRef(t,i);return i};e.FromRotationMatrixToRef=function(e,t){var i=e.m;var r=i[0],n=i[4],o=i[8];var s=i[1],a=i[5],u=i[9];var l=i[2],c=i[6],h=i[10];var f=r+a+h;var d;if(f>0){d=.5/Math.sqrt(f+1);t.w=.25/d;t.x=(c-u)*d;t.y=(o-l)*d;t.z=(s-n)*d}else if(r>a&&r>h){d=2*Math.sqrt(1+r-a-h);t.w=(c-u)/d;t.x=.25*d;t.y=(n+s)/d;t.z=(o+l)/d}else if(a>h){d=2*Math.sqrt(1+a-r-h);t.w=(o-l)/d;t.x=(n+s)/d;t.y=.25*d;t.z=(u+c)/d}else{d=2*Math.sqrt(1+h-r-a);t.w=(s-n)/d;t.x=(o+l)/d;t.y=(u+c)/d;t.z=.25*d}};e.Zero=function(){return new e(0,0,0,0)};e.Inverse=function(t){return new e(-t.x,-t.y,-t.z,t.w)};e.Identity=function(){return new e(0,0,0,1)};e.IsIdentity=function(e){return e&&e.x===0&&e.y===0&&e.z===0&&e.w===1};e.RotationAxis=function(t,i){return e.RotationAxisToRef(t,i,new e)};e.RotationAxisToRef=function(e,t,i){var r=Math.sin(t/2);e.normalize();i.w=Math.cos(t/2);i.x=e.x*r;i.y=e.y*r;i.z=e.z*r;return i};e.FromArray=function(t,i){if(!i){i=0}return new e(t[i],t[i+1],t[i+2],t[i+3])};e.RotationYawPitchRoll=function(t,i,r){var n=new e;e.RotationYawPitchRollToRef(t,i,r,n);return n};e.RotationYawPitchRollToRef=function(e,t,i,r){var n=i*.5;var o=t*.5;var s=e*.5;var a=Math.sin(n);var u=Math.cos(n);var l=Math.sin(o);var c=Math.cos(o);var h=Math.sin(s);var f=Math.cos(s);r.x=f*l*u+h*c*a;r.y=h*c*u-f*l*a;r.z=f*c*a-h*l*u;r.w=f*c*u+h*l*a};e.RotationAlphaBetaGamma=function(t,i,r){var n=new e;e.RotationAlphaBetaGammaToRef(t,i,r,n);return n};e.RotationAlphaBetaGammaToRef=function(e,t,i,r){var n=(i+e)*.5;var o=(i-e)*.5;var s=t*.5;r.x=Math.cos(o)*Math.sin(s);r.y=Math.sin(o)*Math.sin(s);r.z=Math.sin(n)*Math.cos(s);r.w=Math.cos(n)*Math.cos(s)};e.RotationQuaternionFromAxis=function(t,i,r,n){var o=new e(0,0,0,0);e.RotationQuaternionFromAxisToRef(t,i,r,o);return o};e.RotationQuaternionFromAxisToRef=function(t,i,r,n){var o=P.Matrix[0];u.FromXYZAxesToRef(t.normalize(),i.normalize(),r.normalize(),o);e.FromRotationMatrixToRef(o,n)};e.Slerp=function(t,i,r){var n=e.Identity();e.SlerpToRef(t,i,r,n);return n};e.SlerpToRef=function(e,t,i,r){var n;var o;var s=i;var a=e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w;var u=false;if(a<0){u=true;a=-a}if(a>.999999){o=1-s;n=u?-s:s}else{var l=Math.acos(a);var c=1/Math.sin(l);o=Math.sin((1-s)*l)*c;n=u?-Math.sin(s*l)*c:Math.sin(s*l)*c}r.x=o*e.x+n*t.x;r.y=o*e.y+n*t.y;r.z=o*e.z+n*t.z;r.w=o*e.w+n*t.w};e.Hermite=function(t,i,r,n,o){var s=o*o;var a=o*s;var u=2*a-3*s+1;var l=-2*a+3*s;var c=a-2*s+o;var h=a-s;var f=t.x*u+r.x*l+i.x*c+n.x*h;var d=t.y*u+r.y*l+i.y*c+n.y*h;var p=t.z*u+r.z*l+i.z*c+n.z*h;var _=t.w*u+r.w*l+i.w*c+n.w*h;return new e(f,d,p,_)};return e}();e.Quaternion=a;var u=function(){function e(){this._isIdentity=false;this._isIdentityDirty=true;this.m=new Float32Array(16);this._markAsUpdated()}e.prototype._markAsUpdated=function(){this.updateFlag=e._updateFlagSeed++;this._isIdentityDirty=true};e.prototype.isIdentity=function(e){if(e===void 0){e=false}if(this._isIdentityDirty){this._isIdentityDirty=false;if(this.m[0]!==1||this.m[5]!==1||this.m[15]!==1){this._isIdentity=false}else if(this.m[1]!==0||this.m[2]!==0||this.m[3]!==0||this.m[4]!==0||this.m[6]!==0||this.m[7]!==0||this.m[8]!==0||this.m[9]!==0||this.m[11]!==0||this.m[12]!==0||this.m[13]!==0||this.m[14]!==0){this._isIdentity=false}else{this._isIdentity=true}if(!e&&this.m[10]!==1){this._isIdentity=false}}return this._isIdentity};e.prototype.determinant=function(){var e=this.m[10]*this.m[15]-this.m[11]*this.m[14];var t=this.m[9]*this.m[15]-this.m[11]*this.m[13];var i=this.m[9]*this.m[14]-this.m[10]*this.m[13];var r=this.m[8]*this.m[15]-this.m[11]*this.m[12];var n=this.m[8]*this.m[14]-this.m[10]*this.m[12];var o=this.m[8]*this.m[13]-this.m[9]*this.m[12];return this.m[0]*(this.m[5]*e-this.m[6]*t+this.m[7]*i)-this.m[1]*(this.m[4]*e-this.m[6]*r+this.m[7]*n)+this.m[2]*(this.m[4]*t-this.m[5]*r+this.m[7]*o)-this.m[3]*(this.m[4]*i-this.m[5]*n+this.m[6]*o)};e.prototype.toArray=function(){return this.m};e.prototype.asArray=function(){return this.toArray()};e.prototype.invert=function(){this.invertToRef(this);return this};e.prototype.reset=function(){for(var e=0;e<16;e++){this.m[e]=0}this._markAsUpdated();return this};e.prototype.add=function(t){var i=new e;this.addToRef(t,i);return i};e.prototype.addToRef=function(e,t){for(var i=0;i<16;i++){t.m[i]=this.m[i]+e.m[i]}t._markAsUpdated();return this};e.prototype.addToSelf=function(e){for(var t=0;t<16;t++){this.m[t]+=e.m[t]}this._markAsUpdated();return this};e.prototype.invertToRef=function(e){var t=this.m[0];var i=this.m[1];var r=this.m[2];var n=this.m[3];var o=this.m[4];var s=this.m[5];var a=this.m[6];var u=this.m[7];var l=this.m[8];var c=this.m[9];var h=this.m[10];var f=this.m[11];var d=this.m[12];var p=this.m[13];var _=this.m[14];var m=this.m[15];var g=h*m-f*_;var v=c*m-f*p;var y=c*_-h*p;var b=l*m-f*d;var x=l*_-h*d;var T=l*p-c*d;var E=s*g-a*v+u*y;var P=-(o*g-a*b+u*x);var A=o*v-s*b+u*T;var M=-(o*y-s*x+a*T);var S=1/(t*E+i*P+r*A+n*M);var C=a*m-u*_;var R=s*m-u*p;var O=s*_-a*p;var I=o*m-u*d;var D=o*_-a*d;var w=o*p-s*d;var L=a*f-u*h;var F=s*f-u*c;var B=s*h-a*c;var V=o*f-u*l;var N=o*h-a*l;var U=o*c-s*l;e.m[0]=E*S;e.m[4]=P*S;e.m[8]=A*S;e.m[12]=M*S;e.m[1]=-(i*g-r*v+n*y)*S;e.m[5]=(t*g-r*b+n*x)*S;e.m[9]=-(t*v-i*b+n*T)*S;e.m[13]=(t*y-i*x+r*T)*S;e.m[2]=(i*C-r*R+n*O)*S;e.m[6]=-(t*C-r*I+n*D)*S;e.m[10]=(t*R-i*I+n*w)*S;e.m[14]=-(t*O-i*D+r*w)*S;e.m[3]=-(i*L-r*F+n*B)*S;e.m[7]=(t*L-r*V+n*N)*S;e.m[11]=-(t*F-i*V+n*U)*S;e.m[15]=(t*B-i*N+r*U)*S;e._markAsUpdated();return this};e.prototype.setTranslationFromFloats=function(e,t,i){this.m[12]=e;this.m[13]=t;this.m[14]=i;this._markAsUpdated();return this};e.prototype.setTranslation=function(e){this.m[12]=e.x;this.m[13]=e.y;this.m[14]=e.z;this._markAsUpdated();return this};e.prototype.getTranslation=function(){return new n(this.m[12],this.m[13],this.m[14])};e.prototype.getTranslationToRef=function(e){e.x=this.m[12];e.y=this.m[13];e.z=this.m[14];return this};e.prototype.removeRotationAndScaling=function(){this.setRowFromFloats(0,1,0,0,0);this.setRowFromFloats(1,0,1,0,0);this.setRowFromFloats(2,0,0,1,0);return this};e.prototype.multiply=function(t){var i=new e;this.multiplyToRef(t,i);return i};e.prototype.copyFrom=function(e){for(var t=0;t<16;t++){this.m[t]=e.m[t]}this._markAsUpdated();return this};e.prototype.copyToArray=function(e,t){if(t===void 0){t=0}for(var i=0;i<16;i++){e[t+i]=this.m[i]}return this};e.prototype.multiplyToRef=function(e,t){this.multiplyToArray(e,t.m,0);t._markAsUpdated();return this};e.prototype.multiplyToArray=function(e,t,i){var r=this.m[0];var n=this.m[1];var o=this.m[2];var s=this.m[3];var a=this.m[4];var u=this.m[5];var l=this.m[6];var c=this.m[7];var h=this.m[8];var f=this.m[9];var d=this.m[10];var p=this.m[11];var _=this.m[12];var m=this.m[13];var g=this.m[14];var v=this.m[15];var y=e.m[0];var b=e.m[1];var x=e.m[2];var T=e.m[3];var E=e.m[4];var P=e.m[5];var A=e.m[6];var M=e.m[7];var S=e.m[8];var C=e.m[9];var R=e.m[10];var O=e.m[11];var I=e.m[12];var D=e.m[13];var w=e.m[14];var L=e.m[15];t[i]=r*y+n*E+o*S+s*I;t[i+1]=r*b+n*P+o*C+s*D;t[i+2]=r*x+n*A+o*R+s*w;t[i+3]=r*T+n*M+o*O+s*L;t[i+4]=a*y+u*E+l*S+c*I;t[i+5]=a*b+u*P+l*C+c*D;t[i+6]=a*x+u*A+l*R+c*w;t[i+7]=a*T+u*M+l*O+c*L;t[i+8]=h*y+f*E+d*S+p*I;t[i+9]=h*b+f*P+d*C+p*D;t[i+10]=h*x+f*A+d*R+p*w;t[i+11]=h*T+f*M+d*O+p*L;t[i+12]=_*y+m*E+g*S+v*I;t[i+13]=_*b+m*P+g*C+v*D;t[i+14]=_*x+m*A+g*R+v*w;t[i+15]=_*T+m*M+g*O+v*L;return this};e.prototype.equals=function(e){return e&&(this.m[0]===e.m[0]&&this.m[1]===e.m[1]&&this.m[2]===e.m[2]&&this.m[3]===e.m[3]&&this.m[4]===e.m[4]&&this.m[5]===e.m[5]&&this.m[6]===e.m[6]&&this.m[7]===e.m[7]&&this.m[8]===e.m[8]&&this.m[9]===e.m[9]&&this.m[10]===e.m[10]&&this.m[11]===e.m[11]&&this.m[12]===e.m[12]&&this.m[13]===e.m[13]&&this.m[14]===e.m[14]&&this.m[15]===e.m[15])};e.prototype.clone=function(){return e.FromValues(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8],this.m[9],this.m[10],this.m[11],this.m[12],this.m[13],this.m[14],this.m[15])};e.prototype.getClassName=function(){return"Matrix"};e.prototype.getHashCode=function(){var e=this.m[0]||0;for(var t=1;t<16;t++){e=e*397^(this.m[t]||0)}return e};e.prototype.decompose=function(t,i,r){r.x=this.m[12];r.y=this.m[13];r.z=this.m[14];t.x=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]+this.m[2]*this.m[2]);t.y=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]+this.m[6]*this.m[6]);t.z=Math.sqrt(this.m[8]*this.m[8]+this.m[9]*this.m[9]+this.m[10]*this.m[10]);if(this.determinant()<=0){t.y*=-1}if(t.x===0||t.y===0||t.z===0){i.x=0;i.y=0;i.z=0;i.w=1;return false}e.FromValuesToRef(this.m[0]/t.x,this.m[1]/t.x,this.m[2]/t.x,0,this.m[4]/t.y,this.m[5]/t.y,this.m[6]/t.y,0,this.m[8]/t.z,this.m[9]/t.z,this.m[10]/t.z,0,0,0,0,1,P.Matrix[0]);a.FromRotationMatrixToRef(P.Matrix[0],i);return true};e.prototype.getRow=function(e){if(e<0||e>3){return null}var t=e*4;return new o(this.m[t+0],this.m[t+1],this.m[t+2],this.m[t+3])};e.prototype.setRow=function(e,t){if(e<0||e>3){return this}var i=e*4;this.m[i+0]=t.x;this.m[i+1]=t.y;this.m[i+2]=t.z;this.m[i+3]=t.w;this._markAsUpdated();return this};e.prototype.transpose=function(){return e.Transpose(this)};e.prototype.transposeToRef=function(t){e.TransposeToRef(this,t);return this};e.prototype.setRowFromFloats=function(e,t,i,r,n){if(e<0||e>3){return this}var o=e*4;this.m[o+0]=t;this.m[o+1]=i;this.m[o+2]=r;this.m[o+3]=n;this._markAsUpdated();return this};e.prototype.scale=function(t){var i=new e;this.scaleToRef(t,i);return i};e.prototype.scaleToRef=function(e,t){for(var i=0;i<16;i++){t.m[i]=this.m[i]*e}t._markAsUpdated();return this};e.prototype.scaleAndAddToRef=function(e,t){for(var i=0;i<16;i++){t.m[i]+=this.m[i]*e}t._markAsUpdated();return this};e.prototype.toNormalMatrix=function(t){this.invertToRef(t);t.transpose();var i=t.m;e.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,t)};e.prototype.getRotationMatrix=function(){var t=e.Identity();this.getRotationMatrixToRef(t);return t};e.prototype.getRotationMatrixToRef=function(t){var i=this.m;var r=i[0]*i[1]*i[2]*i[3]<0?-1:1;var n=i[4]*i[5]*i[6]*i[7]<0?-1:1;var o=i[8]*i[9]*i[10]*i[11]<0?-1:1;var s=r*Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);var a=n*Math.sqrt(i[4]*i[4]+i[5]*i[5]+i[6]*i[6]);var u=o*Math.sqrt(i[8]*i[8]+i[9]*i[9]+i[10]*i[10]);e.FromValuesToRef(i[0]/s,i[1]/s,i[2]/s,0,i[4]/a,i[5]/a,i[6]/a,0,i[8]/u,i[9]/u,i[10]/u,0,0,0,0,1,t);return this};e.FromArray=function(t,i){var r=new e;if(!i){i=0}e.FromArrayToRef(t,i,r);return r};e.FromArrayToRef=function(e,t,i){for(var r=0;r<16;r++){i.m[r]=e[r+t]}i._markAsUpdated()};e.FromFloat32ArrayToRefScaled=function(e,t,i,r){for(var n=0;n<16;n++){r.m[n]=e[n+t]*i}r._markAsUpdated()};e.FromValuesToRef=function(e,t,i,r,n,o,s,a,u,l,c,h,f,d,p,_,m){m.m[0]=e;m.m[1]=t;m.m[2]=i;m.m[3]=r;m.m[4]=n;m.m[5]=o;m.m[6]=s;m.m[7]=a;m.m[8]=u;m.m[9]=l;m.m[10]=c;m.m[11]=h;m.m[12]=f;m.m[13]=d;m.m[14]=p;m.m[15]=_;m._markAsUpdated()};Object.defineProperty(e,"IdentityReadOnly",{get:function(){return e._identityReadOnly},enumerable:true,configurable:true});e.FromValues=function(t,i,r,n,o,s,a,u,l,c,h,f,d,p,_,m){var g=new e;g.m[0]=t;g.m[1]=i;g.m[2]=r;g.m[3]=n;g.m[4]=o;g.m[5]=s;g.m[6]=a;g.m[7]=u;g.m[8]=l;g.m[9]=c;g.m[10]=h;g.m[11]=f;g.m[12]=d;g.m[13]=p;g.m[14]=_;g.m[15]=m;return g};e.Compose=function(t,i,r){var n=e.Identity();e.ComposeToRef(t,i,r,n);return n};e.ComposeToRef=function(t,i,r,n){e.FromValuesToRef(t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1,P.Matrix[1]);i.toRotationMatrix(P.Matrix[0]);P.Matrix[1].multiplyToRef(P.Matrix[0],n);n.setTranslation(r)};e.Identity=function(){return e.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)};e.IdentityToRef=function(t){e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,t)};e.Zero=function(){return e.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)};e.RotationX=function(t){var i=new e;e.RotationXToRef(t,i);return i};e.Invert=function(t){var i=new e;t.invertToRef(i);return i};e.RotationXToRef=function(e,t){var i=Math.sin(e);var r=Math.cos(e);t.m[0]=1;t.m[15]=1;t.m[5]=r;t.m[10]=r;t.m[9]=-i;t.m[6]=i;t.m[1]=0;t.m[2]=0;t.m[3]=0;t.m[4]=0;t.m[7]=0;t.m[8]=0;t.m[11]=0;t.m[12]=0;t.m[13]=0;t.m[14]=0;t._markAsUpdated()};e.RotationY=function(t){var i=new e;e.RotationYToRef(t,i);return i};e.RotationYToRef=function(e,t){var i=Math.sin(e);var r=Math.cos(e);t.m[5]=1;t.m[15]=1;t.m[0]=r
;t.m[2]=-i;t.m[8]=i;t.m[10]=r;t.m[1]=0;t.m[3]=0;t.m[4]=0;t.m[6]=0;t.m[7]=0;t.m[9]=0;t.m[11]=0;t.m[12]=0;t.m[13]=0;t.m[14]=0;t._markAsUpdated()};e.RotationZ=function(t){var i=new e;e.RotationZToRef(t,i);return i};e.RotationZToRef=function(e,t){var i=Math.sin(e);var r=Math.cos(e);t.m[10]=1;t.m[15]=1;t.m[0]=r;t.m[1]=i;t.m[4]=-i;t.m[5]=r;t.m[2]=0;t.m[3]=0;t.m[6]=0;t.m[7]=0;t.m[8]=0;t.m[9]=0;t.m[11]=0;t.m[12]=0;t.m[13]=0;t.m[14]=0;t._markAsUpdated()};e.RotationAxis=function(t,i){var r=e.Zero();e.RotationAxisToRef(t,i,r);return r};e.RotationAxisToRef=function(e,t,i){var r=Math.sin(-t);var n=Math.cos(-t);var o=1-n;e.normalize();i.m[0]=e.x*e.x*o+n;i.m[1]=e.x*e.y*o-e.z*r;i.m[2]=e.x*e.z*o+e.y*r;i.m[3]=0;i.m[4]=e.y*e.x*o+e.z*r;i.m[5]=e.y*e.y*o+n;i.m[6]=e.y*e.z*o-e.x*r;i.m[7]=0;i.m[8]=e.z*e.x*o-e.y*r;i.m[9]=e.z*e.y*o+e.x*r;i.m[10]=e.z*e.z*o+n;i.m[11]=0;i.m[15]=1;i._markAsUpdated()};e.RotationYawPitchRoll=function(t,i,r){var n=new e;e.RotationYawPitchRollToRef(t,i,r,n);return n};e.RotationYawPitchRollToRef=function(e,t,i,r){a.RotationYawPitchRollToRef(e,t,i,this._tempQuaternion);this._tempQuaternion.toRotationMatrix(r)};e.Scaling=function(t,i,r){var n=e.Zero();e.ScalingToRef(t,i,r,n);return n};e.ScalingToRef=function(e,t,i,r){r.m[0]=e;r.m[1]=0;r.m[2]=0;r.m[3]=0;r.m[4]=0;r.m[5]=t;r.m[6]=0;r.m[7]=0;r.m[8]=0;r.m[9]=0;r.m[10]=i;r.m[11]=0;r.m[12]=0;r.m[13]=0;r.m[14]=0;r.m[15]=1;r._markAsUpdated()};e.Translation=function(t,i,r){var n=e.Identity();e.TranslationToRef(t,i,r,n);return n};e.TranslationToRef=function(t,i,r,n){e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t,i,r,1,n)};e.Lerp=function(t,i,r){var n=e.Zero();e.LerpToRef(t,i,r,n);return n};e.LerpToRef=function(e,t,i,r){for(var n=0;n<16;n++){r.m[n]=e.m[n]*(1-i)+t.m[n]*i}r._markAsUpdated()};e.DecomposeLerp=function(t,i,r){var o=new n(0,0,0);var s=new a;var u=new n(0,0,0);t.decompose(o,s,u);var l=new n(0,0,0);var c=new a;var h=new n(0,0,0);i.decompose(l,c,h);var f=n.Lerp(o,l,r);var d=a.Slerp(s,c,r);var p=n.Lerp(u,h,r);return e.Compose(f,d,p)};e.LookAtLH=function(t,i,r){var n=e.Zero();e.LookAtLHToRef(t,i,r,n);return n};e.LookAtLHToRef=function(t,i,r,o){i.subtractToRef(t,this._zAxis);this._zAxis.normalize();n.CrossToRef(r,this._zAxis,this._xAxis);if(this._xAxis.lengthSquared()===0){this._xAxis.x=1}else{this._xAxis.normalize()}n.CrossToRef(this._zAxis,this._xAxis,this._yAxis);this._yAxis.normalize();var s=-n.Dot(this._xAxis,t);var a=-n.Dot(this._yAxis,t);var u=-n.Dot(this._zAxis,t);return e.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,s,a,u,1,o)};e.LookAtRH=function(t,i,r){var n=e.Zero();e.LookAtRHToRef(t,i,r,n);return n};e.LookAtRHToRef=function(t,i,r,o){t.subtractToRef(i,this._zAxis);this._zAxis.normalize();n.CrossToRef(r,this._zAxis,this._xAxis);if(this._xAxis.lengthSquared()===0){this._xAxis.x=1}else{this._xAxis.normalize()}n.CrossToRef(this._zAxis,this._xAxis,this._yAxis);this._yAxis.normalize();var s=-n.Dot(this._xAxis,t);var a=-n.Dot(this._yAxis,t);var u=-n.Dot(this._zAxis,t);return e.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,s,a,u,1,o)};e.OrthoLH=function(t,i,r,n){var o=e.Zero();e.OrthoLHToRef(t,i,r,n,o);return o};e.OrthoLHToRef=function(t,i,r,n,o){var s=r;var a=n;var u=2/t;var l=2/i;var c=2/(a-s);var h=-(a+s)/(a-s);e.FromValuesToRef(u,0,0,0,0,l,0,0,0,0,c,0,0,0,h,1,o)};e.OrthoOffCenterLH=function(t,i,r,n,o,s){var a=e.Zero();e.OrthoOffCenterLHToRef(t,i,r,n,o,s,a);return a};e.OrthoOffCenterLHToRef=function(t,i,r,n,o,s,a){var u=o;var l=s;var c=2/(i-t);var h=2/(n-r);var f=2/(l-u);var d=-(l+u)/(l-u);var p=(t+i)/(t-i);var _=(n+r)/(r-n);e.FromValuesToRef(c,0,0,0,0,h,0,0,0,0,f,0,p,_,d,1,a)};e.OrthoOffCenterRH=function(t,i,r,n,o,s){var a=e.Zero();e.OrthoOffCenterRHToRef(t,i,r,n,o,s,a);return a};e.OrthoOffCenterRHToRef=function(t,i,r,n,o,s,a){e.OrthoOffCenterLHToRef(t,i,r,n,o,s,a);a.m[10]*=-1};e.PerspectiveLH=function(t,i,r,n){var o=e.Zero();var s=r;var a=n;var u=2*s/t;var l=2*s/i;var c=(a+s)/(a-s);var h=-2*a*s/(a-s);e.FromValuesToRef(u,0,0,0,0,l,0,0,0,0,c,1,0,0,h,0,o);return o};e.PerspectiveFovLH=function(t,i,r,n){var o=e.Zero();e.PerspectiveFovLHToRef(t,i,r,n,o);return o};e.PerspectiveFovLHToRef=function(t,i,r,n,o,s){if(s===void 0){s=true}var a=r;var u=n;var l=1/Math.tan(t*.5);var c=s?l/i:l;var h=s?l:l*i;var f=(u+a)/(u-a);var d=-2*u*a/(u-a);e.FromValuesToRef(c,0,0,0,0,h,0,0,0,0,f,1,0,0,d,0,o)};e.PerspectiveFovRH=function(t,i,r,n){var o=e.Zero();e.PerspectiveFovRHToRef(t,i,r,n,o);return o};e.PerspectiveFovRHToRef=function(t,i,r,n,o,s){if(s===void 0){s=true}var a=r;var u=n;var l=1/Math.tan(t*.5);var c=s?l/i:l;var h=s?l:l*i;var f=-(u+a)/(u-a);var d=-2*u*a/(u-a);e.FromValuesToRef(c,0,0,0,0,h,0,0,0,0,f,-1,0,0,d,0,o)};e.PerspectiveFovWebVRToRef=function(e,t,i,r,n){if(n===void 0){n=false}var o=n?-1:1;var s=Math.tan(e.upDegrees*Math.PI/180);var a=Math.tan(e.downDegrees*Math.PI/180);var u=Math.tan(e.leftDegrees*Math.PI/180);var l=Math.tan(e.rightDegrees*Math.PI/180);var c=2/(u+l);var h=2/(s+a);r.m[0]=c;r.m[1]=r.m[2]=r.m[3]=r.m[4]=0;r.m[5]=h;r.m[6]=r.m[7]=0;r.m[8]=(u-l)*c*.5;r.m[9]=-((s-a)*h*.5);r.m[10]=-i/(t-i);r.m[11]=1*o;r.m[12]=r.m[13]=r.m[15]=0;r.m[14]=-(2*i*t)/(i-t);r._markAsUpdated()};e.GetFinalMatrix=function(t,i,r,n,o,s){var a=t.width;var u=t.height;var l=t.x;var c=t.y;var h=e.FromValues(a/2,0,0,0,0,-u/2,0,0,0,0,s-o,0,l+a/2,u/2+c,o,1);return i.multiply(r).multiply(n).multiply(h)};e.GetAsMatrix2x2=function(e){return new Float32Array([e.m[0],e.m[1],e.m[4],e.m[5]])};e.GetAsMatrix3x3=function(e){return new Float32Array([e.m[0],e.m[1],e.m[2],e.m[4],e.m[5],e.m[6],e.m[8],e.m[9],e.m[10]])};e.Transpose=function(t){var i=new e;e.TransposeToRef(t,i);return i};e.TransposeToRef=function(e,t){t.m[0]=e.m[0];t.m[1]=e.m[4];t.m[2]=e.m[8];t.m[3]=e.m[12];t.m[4]=e.m[1];t.m[5]=e.m[5];t.m[6]=e.m[9];t.m[7]=e.m[13];t.m[8]=e.m[2];t.m[9]=e.m[6];t.m[10]=e.m[10];t.m[11]=e.m[14];t.m[12]=e.m[3];t.m[13]=e.m[7];t.m[14]=e.m[11];t.m[15]=e.m[15]};e.Reflection=function(t){var i=new e;e.ReflectionToRef(t,i);return i};e.ReflectionToRef=function(e,t){e.normalize();var i=e.normal.x;var r=e.normal.y;var n=e.normal.z;var o=-2*i;var s=-2*r;var a=-2*n;t.m[0]=o*i+1;t.m[1]=s*i;t.m[2]=a*i;t.m[3]=0;t.m[4]=o*r;t.m[5]=s*r+1;t.m[6]=a*r;t.m[7]=0;t.m[8]=o*n;t.m[9]=s*n;t.m[10]=a*n+1;t.m[11]=0;t.m[12]=o*e.d;t.m[13]=s*e.d;t.m[14]=a*e.d;t.m[15]=1;t._markAsUpdated()};e.FromXYZAxesToRef=function(e,t,i,r){r.m[0]=e.x;r.m[1]=e.y;r.m[2]=e.z;r.m[3]=0;r.m[4]=t.x;r.m[5]=t.y;r.m[6]=t.z;r.m[7]=0;r.m[8]=i.x;r.m[9]=i.y;r.m[10]=i.z;r.m[11]=0;r.m[12]=0;r.m[13]=0;r.m[14]=0;r.m[15]=1;r._markAsUpdated()};e.FromQuaternionToRef=function(e,t){var i=e.x*e.x;var r=e.y*e.y;var n=e.z*e.z;var o=e.x*e.y;var s=e.z*e.w;var a=e.z*e.x;var u=e.y*e.w;var l=e.y*e.z;var c=e.x*e.w;t.m[0]=1-2*(r+n);t.m[1]=2*(o+s);t.m[2]=2*(a-u);t.m[3]=0;t.m[4]=2*(o-s);t.m[5]=1-2*(n+i);t.m[6]=2*(l+c);t.m[7]=0;t.m[8]=2*(a+u);t.m[9]=2*(l-c);t.m[10]=1-2*(r+i);t.m[11]=0;t.m[12]=0;t.m[13]=0;t.m[14]=0;t.m[15]=1;t._markAsUpdated()};e._tempQuaternion=new a;e._xAxis=n.Zero();e._yAxis=n.Zero();e._zAxis=n.Zero();e._updateFlagSeed=0;e._identityReadOnly=e.Identity();return e}();e.Matrix=u;var l=function(){function e(e,t,i,r){this.normal=new n(e,t,i);this.d=r}e.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]};e.prototype.clone=function(){return new e(this.normal.x,this.normal.y,this.normal.z,this.d)};e.prototype.getClassName=function(){return"Plane"};e.prototype.getHashCode=function(){var e=this.normal.getHashCode();e=e*397^(this.d||0);return e};e.prototype.normalize=function(){var e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);var t=0;if(e!==0){t=1/e}this.normal.x*=t;this.normal.y*=t;this.normal.z*=t;this.d*=t;return this};e.prototype.transform=function(t){var i=u.Transpose(t);var r=this.normal.x;var n=this.normal.y;var o=this.normal.z;var s=this.d;var a=r*i.m[0]+n*i.m[1]+o*i.m[2]+s*i.m[3];var l=r*i.m[4]+n*i.m[5]+o*i.m[6]+s*i.m[7];var c=r*i.m[8]+n*i.m[9]+o*i.m[10]+s*i.m[11];var h=r*i.m[12]+n*i.m[13]+o*i.m[14]+s*i.m[15];return new e(a,l,c,h)};e.prototype.dotCoordinate=function(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d};e.prototype.copyFromPoints=function(e,t,i){var r=t.x-e.x;var n=t.y-e.y;var o=t.z-e.z;var s=i.x-e.x;var a=i.y-e.y;var u=i.z-e.z;var l=n*u-o*a;var c=o*s-r*u;var h=r*a-n*s;var f=Math.sqrt(l*l+c*c+h*h);var d;if(f!==0){d=1/f}else{d=0}this.normal.x=l*d;this.normal.y=c*d;this.normal.z=h*d;this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z);return this};e.prototype.isFrontFacingTo=function(e,t){var i=n.Dot(this.normal,e);return i<=t};e.prototype.signedDistanceTo=function(e){return n.Dot(e,this.normal)+this.d};e.FromArray=function(t){return new e(t[0],t[1],t[2],t[3])};e.FromPoints=function(t,i,r){var n=new e(0,0,0,0);n.copyFromPoints(t,i,r);return n};e.FromPositionAndNormal=function(t,i){var r=new e(0,0,0,0);i.normalize();r.normal=i;r.d=-(i.x*t.x+i.y*t.y+i.z*t.z);return r};e.SignedDistanceToPlaneFromPositionAndNormal=function(e,t,i){var r=-(t.x*e.x+t.y*e.y+t.z*e.z);return n.Dot(i,t)+r};return e}();e.Plane=l;var c=function(){function e(e,t,i,r){this.x=e;this.y=t;this.width=i;this.height=r}e.prototype.toGlobal=function(t,i){if(t.getRenderWidth){var r=t;return this.toGlobal(r.getRenderWidth(),r.getRenderHeight())}var n=t;return new e(this.x*n,this.y*i,this.width*n,this.height*i)};e.prototype.clone=function(){return new e(this.x,this.y,this.width,this.height)};return e}();e.Viewport=c;var h=function(){function e(){}e.GetPlanes=function(t){var i=[];for(var r=0;r<6;r++){i.push(new l(0,0,0,0))}e.GetPlanesToRef(t,i);return i};e.GetNearPlaneToRef=function(e,t){t.normal.x=e.m[3]+e.m[2];t.normal.y=e.m[7]+e.m[6];t.normal.z=e.m[11]+e.m[10];t.d=e.m[15]+e.m[14];t.normalize()};e.GetFarPlaneToRef=function(e,t){t.normal.x=e.m[3]-e.m[2];t.normal.y=e.m[7]-e.m[6];t.normal.z=e.m[11]-e.m[10];t.d=e.m[15]-e.m[14];t.normalize()};e.GetLeftPlaneToRef=function(e,t){t.normal.x=e.m[3]+e.m[0];t.normal.y=e.m[7]+e.m[4];t.normal.z=e.m[11]+e.m[8];t.d=e.m[15]+e.m[12];t.normalize()};e.GetRightPlaneToRef=function(e,t){t.normal.x=e.m[3]-e.m[0];t.normal.y=e.m[7]-e.m[4];t.normal.z=e.m[11]-e.m[8];t.d=e.m[15]-e.m[12];t.normalize()};e.GetTopPlaneToRef=function(e,t){t.normal.x=e.m[3]-e.m[1];t.normal.y=e.m[7]-e.m[5];t.normal.z=e.m[11]-e.m[9];t.d=e.m[15]-e.m[13];t.normalize()};e.GetBottomPlaneToRef=function(e,t){t.normal.x=e.m[3]+e.m[1];t.normal.y=e.m[7]+e.m[5];t.normal.z=e.m[11]+e.m[9];t.d=e.m[15]+e.m[13];t.normalize()};e.GetPlanesToRef=function(t,i){e.GetNearPlaneToRef(t,i[0]);e.GetFarPlaneToRef(t,i[1]);e.GetLeftPlaneToRef(t,i[2]);e.GetRightPlaneToRef(t,i[3]);e.GetTopPlaneToRef(t,i[4]);e.GetBottomPlaneToRef(t,i[5])};return e}();e.Frustum=h;var f;(function(e){e[e["LOCAL"]=0]="LOCAL";e[e["WORLD"]=1]="WORLD";e[e["BONE"]=2]="BONE"})(f=e.Space||(e.Space={}));var d=function(){function e(){}e.X=new n(1,0,0);e.Y=new n(0,1,0);e.Z=new n(0,0,1);return e}();e.Axis=d;var p=function(){function e(){}e.interpolate=function(e,t,i,r,n){var o=1-3*r+3*t;var s=3*r-6*t;var a=3*t;var u=e;for(var l=0;l<5;l++){var c=u*u;var h=c*u;var f=o*h+s*c+a*u;var d=1/(3*o*c+2*s*u+a);u-=(f-e)*d;u=Math.min(1,Math.max(0,u))}return 3*Math.pow(1-u,2)*u*i+3*(1-u)*Math.pow(u,2)*n+Math.pow(u,3)};return e}();e.BezierCurve=p;var _;(function(e){e[e["CW"]=0]="CW";e[e["CCW"]=1]="CCW"})(_=e.Orientation||(e.Orientation={}));var m=function(){function e(e){var t=this;this.degrees=function(){return t._radians*180/Math.PI};this.radians=function(){return t._radians};this._radians=e;if(this._radians<0)this._radians+=2*Math.PI}e.BetweenTwoPoints=function(t,i){var r=i.subtract(t);var n=Math.atan2(r.y,r.x);return new e(n)};e.FromRadians=function(t){return new e(t)};e.FromDegrees=function(t){return new e(t*Math.PI/180)};return e}();e.Angle=m;var g=function(){function e(e,t,i){this.startPoint=e;this.midPoint=t;this.endPoint=i;var n=Math.pow(t.x,2)+Math.pow(t.y,2);var o=(Math.pow(e.x,2)+Math.pow(e.y,2)-n)/2;var s=(n-Math.pow(i.x,2)-Math.pow(i.y,2))/2;var a=(e.x-t.x)*(t.y-i.y)-(t.x-i.x)*(e.y-t.y);this.centerPoint=new r((o*(t.y-i.y)-s*(e.y-t.y))/a,((e.x-t.x)*s-(t.x-i.x)*o)/a);this.radius=this.centerPoint.subtract(this.startPoint).length();this.startAngle=m.BetweenTwoPoints(this.centerPoint,this.startPoint);var u=this.startAngle.degrees();var l=m.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees();var c=m.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();if(l-u>+180)l-=360;if(l-u<-180)l+=360;if(c-l>+180)c-=360;if(c-l<-180)c+=360;this.orientation=l-u<0?_.CW:_.CCW;this.angle=m.FromDegrees(this.orientation===_.CW?u-c:c-u)}return e}();e.Arc2=g;var v=function(){function e(e,t){this._points=new Array;this._length=0;this.closed=false;this._points.push(new r(e,t))}e.prototype.addLineTo=function(e,t){if(this.closed){return this}var i=new r(e,t);var n=this._points[this._points.length-1];this._points.push(i);this._length+=i.subtract(n).length();return this};e.prototype.addArcTo=function(e,t,i,n,o){if(o===void 0){o=36}if(this.closed){return this}var s=this._points[this._points.length-1];var a=new r(e,t);var u=new r(i,n);var l=new g(s,a,u);var c=l.angle.radians()/o;if(l.orientation===_.CW)c*=-1;var h=l.startAngle.radians()+c;for(var f=0;f<o;f++){var d=Math.cos(h)*l.radius+l.centerPoint.x;var p=Math.sin(h)*l.radius+l.centerPoint.y;this.addLineTo(d,p);h+=c}return this};e.prototype.close=function(){this.closed=true;return this};e.prototype.length=function(){var e=this._length;if(!this.closed){var t=this._points[this._points.length-1];var i=this._points[0];e+=i.subtract(t).length()}return e};e.prototype.getPoints=function(){return this._points};e.prototype.getPointAtLengthPosition=function(e){if(e<0||e>1){return r.Zero()}var t=e*this.length();var i=0;for(var n=0;n<this._points.length;n++){var o=(n+1)%this._points.length;var s=this._points[n];var a=this._points[o];var u=a.subtract(s);var l=u.length()+i;if(t>=i&&t<=l){var c=u.normalize();var h=t-i;return new r(s.x+c.x*h,s.y+c.y*h)}i=l}return r.Zero()};e.StartingAt=function(t,i){return new e(t,i)};return e}();e.Path2=v;var y=function(){function t(e,t,i){if(t===void 0){t=null}this.path=e;this._curve=new Array;this._distances=new Array;this._tangents=new Array;this._normals=new Array;this._binormals=new Array;for(var r=0;r<e.length;r++){this._curve[r]=e[r].clone()}this._raw=i||false;this._compute(t)}t.prototype.getCurve=function(){return this._curve};t.prototype.getTangents=function(){return this._tangents};t.prototype.getNormals=function(){return this._normals};t.prototype.getBinormals=function(){return this._binormals};t.prototype.getDistances=function(){return this._distances};t.prototype.update=function(e,t){if(t===void 0){t=null}for(var i=0;i<e.length;i++){this._curve[i].x=e[i].x;this._curve[i].y=e[i].y;this._curve[i].z=e[i].z}this._compute(t);return this};t.prototype._compute=function(e){var t=this._curve.length;this._tangents[0]=this._getFirstNonNullVector(0);if(!this._raw){this._tangents[0].normalize()}this._tangents[t-1]=this._curve[t-1].subtract(this._curve[t-2]);if(!this._raw){this._tangents[t-1].normalize()}var i=this._tangents[0];var r=this._normalVector(this._curve[0],i,e);this._normals[0]=r;if(!this._raw){this._normals[0].normalize()}this._binormals[0]=n.Cross(i,this._normals[0]);if(!this._raw){this._binormals[0].normalize()}this._distances[0]=0;var o;var s;var a;var u;for(var l=1;l<t;l++){o=this._getLastNonNullVector(l);if(l<t-1){s=this._getFirstNonNullVector(l);this._tangents[l]=o.add(s);this._tangents[l].normalize()}this._distances[l]=this._distances[l-1]+o.length();a=this._tangents[l];u=this._binormals[l-1];this._normals[l]=n.Cross(u,a);if(!this._raw){this._normals[l].normalize()}this._binormals[l]=n.Cross(a,this._normals[l]);if(!this._raw){this._binormals[l].normalize()}}};t.prototype._getFirstNonNullVector=function(e){var t=1;var i=this._curve[e+t].subtract(this._curve[e]);while(i.length()===0&&e+t+1<this._curve.length){t++;i=this._curve[e+t].subtract(this._curve[e])}return i};t.prototype._getLastNonNullVector=function(e){var t=1;var i=this._curve[e].subtract(this._curve[e-t]);while(i.length()===0&&e>t+1){t++;i=this._curve[e].subtract(this._curve[e-t])}return i};t.prototype._normalVector=function(t,i,r){var o;var s=i.length();if(s===0){s=1}if(r===undefined||r===null){var a;if(!e.Scalar.WithinEpsilon(Math.abs(i.y)/s,1,e.Epsilon)){a=new n(0,-1,0)}else if(!e.Scalar.WithinEpsilon(Math.abs(i.x)/s,1,e.Epsilon)){a=new n(1,0,0)}else if(!e.Scalar.WithinEpsilon(Math.abs(i.z)/s,1,e.Epsilon)){a=new n(0,0,1)}else{a=n.Zero()}o=n.Cross(i,a)}else{o=n.Cross(i,r);n.CrossToRef(o,i,o)}o.normalize();return o};return t}();e.Path3D=y;var b=function(){function e(e){this._length=0;this._points=e;this._length=this._computeLength(e)}e.CreateQuadraticBezier=function(t,i,r,o){o=o>2?o:3;var s=new Array;var a=function(e,t,i,r){var n=(1-e)*(1-e)*t+2*e*(1-e)*i+e*e*r;return n};for(var u=0;u<=o;u++){s.push(new n(a(u/o,t.x,i.x,r.x),a(u/o,t.y,i.y,r.y),a(u/o,t.z,i.z,r.z)))}return new e(s)};e.CreateCubicBezier=function(t,i,r,o,s){s=s>3?s:4;var a=new Array;var u=function(e,t,i,r,n){var o=(1-e)*(1-e)*(1-e)*t+3*e*(1-e)*(1-e)*i+3*e*e*(1-e)*r+e*e*e*n;return o};for(var l=0;l<=s;l++){a.push(new n(u(l/s,t.x,i.x,r.x,o.x),u(l/s,t.y,i.y,r.y,o.y),u(l/s,t.z,i.z,r.z,o.z)))}return new e(a)};e.CreateHermiteSpline=function(t,i,r,o,s){var a=new Array;var u=1/s;for(var l=0;l<=s;l++){a.push(n.Hermite(t,i,r,o,l*u))}return new e(a)};e.CreateCatmullRomSpline=function(t,i){var r=new Array;r.push(t[0].clone());Array.prototype.push.apply(r,t);r.push(t[t.length-1].clone());var o=new Array;var s=1/i;var a=0;for(var u=0;u<r.length-3;u++){a=0;for(var l=0;l<i;l++){o.push(n.CatmullRom(r[u],r[u+1],r[u+2],r[u+3],a));a+=s}}u--;o.push(n.CatmullRom(r[u],r[u+1],r[u+2],r[u+3],a));return new e(o)};e.prototype.getPoints=function(){return this._points};e.prototype.length=function(){return this._length};e.prototype.continue=function(t){var i=this._points[this._points.length-1];var r=this._points.slice();var n=t.getPoints();for(var o=1;o<n.length;o++){r.push(n[o].subtract(n[0]).add(i))}var s=new e(r);return s};e.prototype._computeLength=function(e){var t=0;for(var i=1;i<e.length;i++){t+=e[i].subtract(e[i-1]).length()}return t};return e}();e.Curve3=b;var x=function(){function e(e,t){if(e===void 0){e=n.Zero()}if(t===void 0){t=n.Up()}this.position=e;this.normal=t}e.prototype.clone=function(){return new e(this.position.clone(),this.normal.clone())};return e}();e.PositionNormalVertex=x;var T=function(){function e(e,t,i){if(e===void 0){e=n.Zero()}if(t===void 0){t=n.Up()}if(i===void 0){i=r.Zero()}this.position=e;this.normal=t;this.uv=i}e.prototype.clone=function(){return new e(this.position.clone(),this.normal.clone(),this.uv.clone())};return e}();e.PositionNormalTextureVertex=T;var E=function(){function e(){}e.Color3=[t.Black(),t.Black(),t.Black()];e.Vector2=[r.Zero(),r.Zero(),r.Zero()];e.Vector3=[n.Zero(),n.Zero(),n.Zero(),n.Zero(),n.Zero(),n.Zero(),n.Zero(),n.Zero(),n.Zero()];e.Vector4=[o.Zero(),o.Zero(),o.Zero()];e.Quaternion=[a.Zero(),a.Zero()];e.Matrix=[u.Zero(),u.Zero(),u.Zero(),u.Zero(),u.Zero(),u.Zero(),u.Zero(),u.Zero()];return e}();e.Tmp=E;var P=function(){function e(){}e.Vector3=[n.Zero()];e.Matrix=[u.Zero(),u.Zero()];e.Quaternion=[a.Zero()];return e}()})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){}e.WithinEpsilon=function(e,t,i){if(i===void 0){i=1.401298e-45}var r=e-t;return-i<=r&&r<=i};e.ToHex=function(e){var t=e.toString(16);if(e<=15){return("0"+t).toUpperCase()}return t.toUpperCase()};e.Sign=function(e){e=+e;if(e===0||isNaN(e))return e;return e>0?1:-1};e.Clamp=function(e,t,i){if(t===void 0){t=0}if(i===void 0){i=1}return Math.min(i,Math.max(t,e))};e.Log2=function(e){return Math.log(e)*Math.LOG2E};e.Repeat=function(e,t){return e-Math.floor(e/t)*t};e.Normalize=function(e,t,i){return(e-t)/(i-t)};e.Denormalize=function(e,t,i){return e*(i-t)+t};e.DeltaAngle=function(t,i){var r=e.Repeat(i-t,360);if(r>180){r-=360}return r};e.PingPong=function(t,i){var r=e.Repeat(t,i*2);return i-Math.abs(r-i)};e.SmoothStep=function(t,i,r){var n=e.Clamp(r);n=-2*n*n*n+3*n*n;return i*n+t*(1-n)};e.MoveTowards=function(t,i,r){var n=0;if(Math.abs(i-t)<=r){n=i}else{n=t+e.Sign(i-t)*r}return n};e.MoveTowardsAngle=function(t,i,r){var n=e.DeltaAngle(t,i);var o=0;if(-r<n&&n<r){o=i}else{i=t+n;o=e.MoveTowards(t,i,r)}return o};e.Lerp=function(e,t,i){return e+(t-e)*i};e.LerpAngle=function(t,i,r){var n=e.Repeat(i-t,360);if(n>180){n-=360}return t+n*e.Clamp(r)};e.InverseLerp=function(t,i,r){var n=0;if(t!=i){n=e.Clamp((r-t)/(i-t))}else{n=0}return n};e.Hermite=function(e,t,i,r,n){var o=n*n;var s=n*o;var a=2*s-3*o+1;var u=-2*s+3*o;var l=s-2*o+n;var c=s-o;return e*a+i*u+t*l+r*c};e.RandomRange=function(e,t){if(e===t)return e;return Math.random()*(t-e)+e};e.RangeToPercent=function(e,t,i){return(e-t)/(i-t)};e.PercentToRange=function(e,t,i){return(i-t)*e+t};e.NormalizeRadians=function(t){t-=e.TwoPi*Math.floor((t+Math.PI)/e.TwoPi);return t};e.TwoPi=Math.PI*2;return e}();e.Scalar=t})(r||(r={}));"use strict";"use strict";"use strict";var r;(function(e){var t={};var i={};var r=function(t,i,r){var n=t();if(e.Tags){e.Tags.AddTagsTo(n,i.tags)}var s=o(n);for(var a in s){var u=s[a];var l=i[a];var c=u.type;if(l!==undefined&&l!==null){switch(c){case 0:case 6:case 11:n[a]=l;break;case 1:n[a]=r||l.isRenderTarget?l:l.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:n[a]=r?l:l.clone();break}}}return n};function n(e){var i=e.getClassName();if(!t[i]){t[i]={}}return t[i]}function o(e){var r=e.getClassName();if(i[r]){return i[r]}i[r]={};var n=i[r];var o=e;var s=r;while(s){var a=t[s];for(var u in a){n[u]=a[u]}var l=void 0;var c=false;do{l=Object.getPrototypeOf(o);if(!l.getClassName){c=true;break}if(l.getClassName()!==s){break}o=l}while(l);if(c){break}s=l.getClassName();o=l}return n}function s(e,t){return function(i,r){var o=n(i);if(!o[r]){o[r]={type:e,sourceName:t}}}}function a(e,t){if(t===void 0){t=null}return function(i,r){var n=t||"_"+r;Object.defineProperty(i,r,{get:function(){return this[n]},set:function(t){if(this[n]===t){return}this[n]=t;i[e].apply(this)},enumerable:true,configurable:true})}}function u(e,t){if(t===void 0){t=null}return a(e,t)}e.expandToProperty=u;function l(e){return s(0,e)}e.serialize=l;function c(e){return s(1,e)}e.serializeAsTexture=c;function h(e){return s(2,e)}e.serializeAsColor3=h;function f(e){return s(3,e)}e.serializeAsFresnelParameters=f;function d(e){return s(4,e)}e.serializeAsVector2=d;function p(e){return s(5,e)}e.serializeAsVector3=p;function _(e){return s(6,e)}e.serializeAsMeshReference=_;function m(e){return s(7,e)}e.serializeAsColorCurves=m;function g(e){return s(8,e)}e.serializeAsColor4=g;function v(e){return s(9,e)}e.serializeAsImageProcessingConfiguration=v;function y(e){return s(10,e)}e.serializeAsQuaternion=y;function b(e){return s(11,e)}e.serializeAsCameraReference=b;var x=function(){function t(){}t.Serialize=function(t,i){if(!i){i={}}if(e.Tags){i.tags=e.Tags.GetTags(t)}var r=o(t);for(var n in r){var s=r[n];var a=s.sourceName||n;var u=s.type;var l=t[n];if(l!==undefined&&l!==null){switch(u){case 0:i[a]=l;break;case 1:i[a]=l.serialize();break;case 2:i[a]=l.asArray();break;case 3:i[a]=l.serialize();break;case 4:i[a]=l.asArray();break;case 5:i[a]=l.asArray();break;case 6:i[a]=l.id;break;case 7:i[a]=l.serialize();break;case 8:i[a]=l.asArray();break;case 9:i[a]=l.serialize();break;case 10:i[a]=l.asArray();break;case 11:i[a]=l.id;break}}}return i};t.Parse=function(t,i,r,n){if(n===void 0){n=null}var s=t();if(!n){n=""}if(e.Tags){e.Tags.AddTagsTo(s,i.tags)}var a=o(s);for(var u in a){var l=a[u];var c=i[l.sourceName||u];var h=l.type;if(c!==undefined&&c!==null){var f=s;switch(h){case 0:f[u]=c;break;case 1:if(r){f[u]=e.Texture.Parse(c,r,n)}break;case 2:f[u]=e.Color3.FromArray(c);break;case 3:f[u]=e.FresnelParameters.Parse(c);break;case 4:f[u]=e.Vector2.FromArray(c);break;case 5:f[u]=e.Vector3.FromArray(c);break;case 6:if(r){f[u]=r.getLastMeshByID(c)}break;case 7:f[u]=e.ColorCurves.Parse(c);break;case 8:f[u]=e.Color4.FromArray(c);break;case 9:f[u]=e.ImageProcessingConfiguration.Parse(c);break;case 10:f[u]=e.Quaternion.FromArray(c);break;case 11:if(r){f[u]=r.getCameraByID(c)}break}}}return s};t.Clone=function(e,t){return r(e,t,false)};t.Instanciate=function(e,t){return r(e,t,true)};return t}();e.SerializationHelper=x})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){var e=this;this.promise=new Promise(function(t,i){e._resolve=t;e._reject=i})}Object.defineProperty(e.prototype,"resolve",{get:function(){return this._resolve},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"reject",{get:function(){return this._reject},enumerable:true,configurable:true});return e}();e.Deferred=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e,t,i,r){if(t===void 0){t=false}this.initalize(e,t,i,r)}e.prototype.initalize=function(e,t,i,r){if(t===void 0){t=false}this.mask=e;this.skipNextObservers=t;this.target=i;this.currentTarget=r;return this};return e}();e.EventState=t;var i=function(){function e(e,t,i){if(i===void 0){i=null}this.callback=e;this.mask=t;this.scope=i;this._willBeUnregistered=false;this.unregisterOnNextCall=false}return e}();e.Observer=i;var r=function(){function e(){}e.prototype.dispose=function(){if(this._observers&&this._observables){for(var e=0;e<this._observers.length;e++){this._observables[e].remove(this._observers[e])}}this._observers=null;this._observables=null};e.Watch=function(t,i,r,n){if(r===void 0){r=-1}if(n===void 0){n=null}var o=new e;o._observers=new Array;o._observables=t;for(var s=0,a=t;s<a.length;s++){var u=a[s];var l=u.add(i,r,false,n);if(l){o._observers.push(l)}}return o};return e}();e.MultiObserver=r;var n=function(){function r(e){this._observers=new Array;this._eventState=new t(0);if(e){this._onObserverAdded=e}}r.prototype.add=function(e,t,r,n,o){if(t===void 0){t=-1}if(r===void 0){r=false}if(n===void 0){n=null}if(o===void 0){o=false}if(!e){return null}var s=new i(e,t,n);s.unregisterOnNextCall=o;if(r){this._observers.unshift(s)}else{this._observers.push(s)}if(this._onObserverAdded){this._onObserverAdded(s)}return s};r.prototype.remove=function(e){if(!e){return false}var t=this._observers.indexOf(e);if(t!==-1){this._observers.splice(t,1);return true}return false};r.prototype.removeCallback=function(e,t){for(var i=0;i<this._observers.length;i++){if(this._observers[i].callback===e&&(!t||t===this._observers[i].scope)){this._observers.splice(i,1);return true}}return false};r.prototype._deferUnregister=function(t){var i=this;t.unregisterOnNextCall=false;t._willBeUnregistered=true;e.Tools.SetImmediate(function(){i.remove(t)})};r.prototype.notifyObservers=function(e,t,i,r){if(t===void 0){t=-1}if(!this._observers.length){return true}var n=this._eventState;n.mask=t;n.target=i;n.currentTarget=r;n.skipNextObservers=false;n.lastReturnValue=e;for(var o=0,s=this._observers;o<s.length;o++){var a=s[o];if(a._willBeUnregistered){continue}if(a.mask&t){if(a.scope){n.lastReturnValue=a.callback.apply(a.scope,[e,n])}else{n.lastReturnValue=a.callback(e,n)}if(a.unregisterOnNextCall){this._deferUnregister(a)}}if(n.skipNextObservers){return false}}return true};r.prototype.notifyObserversWithPromise=function(e,t,i,r){var n=this;if(t===void 0){t=-1}var o=Promise.resolve(e);if(!this._observers.length){return o}var s=this._eventState;s.mask=t;s.target=i;s.currentTarget=r;s.skipNextObservers=false;this._observers.forEach(function(i){if(s.skipNextObservers){return}if(i._willBeUnregistered){return}if(i.mask&t){if(i.scope){o=o.then(function(t){s.lastReturnValue=t;return i.callback.apply(i.scope,[e,s])})}else{o=o.then(function(t){s.lastReturnValue=t;return i.callback(e,s)})}if(i.unregisterOnNextCall){n._deferUnregister(i)}}});return o.then(function(){return e})};r.prototype.notifyObserver=function(e,t,i){if(i===void 0){i=-1}var r=this._eventState;r.mask=i;r.skipNextObservers=false;e.callback(t,r)};r.prototype.hasObservers=function(){return this._observers.length>0};r.prototype.clear=function(){this._observers=new Array;this._onObserverAdded=null};r.prototype.clone=function(){var e=new r;e._observers=this._observers.slice(0);return e};r.prototype.hasSpecificMask=function(e){if(e===void 0){e=-1}for(var t=0,i=this._observers;t<i.length;t++){var r=i[t];if(r.mask&e||r.mask===e){return true}}return false};return r}();e.Observable=n})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(t){this.length=0;this.data=new Array(t);this._id=e._GlobalId++}e.prototype.push=function(e){this.data[this.length++]=e;if(this.length>this.data.length){this.data.length*=2}};e.prototype.forEach=function(e){for(var t=0;t<this.length;t++){e(this.data[t])}};e.prototype.sort=function(e){this.data.sort(e)};e.prototype.reset=function(){this.length=0};e.prototype.dispose=function(){this.reset();if(this.data){this.data.length=0;this.data=[]}};e.prototype.concat=function(e){if(e.length===0){return}if(this.length+e.length>this.data.length){this.data.length=(this.length+e.length)*2}for(var t=0;t<e.length;t++){this.data[this.length++]=(e.data||e)[t]}};e.prototype.indexOf=function(e){var t=this.data.indexOf(e);if(t>=this.length){return-1}return t};e.prototype.contains=function(e){return this.data.indexOf(e)!==-1};e._GlobalId=0;return e}();e.SmartArray=t;var i=function(e){__extends(t,e);function t(){var t=e!==null&&e.apply(this,arguments)||this;t._duplicateId=0;return t}t.prototype.push=function(t){e.prototype.push.call(this,t);if(!t.__smartArrayFlags){t.__smartArrayFlags={}}t.__smartArrayFlags[this._id]=this._duplicateId};t.prototype.pushNoDuplicate=function(e){if(e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId){return false}this.push(e);return true};t.prototype.reset=function(){e.prototype.reset.call(this);this._duplicateId++};t.prototype.concatWithNoDuplicate=function(e){if(e.length===0){return}if(this.length+e.length>this.data.length){this.data.length=(this.length+e.length)*2}for(var t=0;t<e.length;t++){var i=(e.data||e)[t];this.pushNoDuplicate(i)}};return t}(t);e.SmartArrayNoDuplicate=i})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(i,r){var n=e.call(this,i)||this;n.request=r;n.name="LoadFileError";t._setPrototypeOf(n,t.prototype);return n}t._setPrototypeOf=Object.setPrototypeOf||function(e,t){e.__proto__=t;return e};return t}(Error);e.LoadFileError=t;var i=function(){function e(){}e.ExponentialBackoff=function(e,t){if(e===void 0){e=3}if(t===void 0){t=500}return function(i,r,n){if(r.status!==0||n>=e||i.indexOf("file:")!==-1){return-1}return Math.pow(2,n)*t}};return e}();e.RetryStrategy=i;var r;var n=function(t,i){if(!t)return null;if(t instanceof e.Mesh){return null}if(t instanceof e.SubMesh){return t.clone(i)}else if(t.clone){return t.clone()}return null};var o=function(){function o(){}o.Mix=function(e,t,i){return e*(1-i)+t*i};o.Instantiate=function(e){if(o.RegisteredExternalClasses&&o.RegisteredExternalClasses[e]){return o.RegisteredExternalClasses[e]}var t=e.split(".");var i=window||this;for(var r=0,n=t.length;r<n;r++){i=i[t[r]]}if(typeof i!=="function"){return null}return i};o.Slice=function(e,t,i){if(e.slice){return e.slice(t,i)}return Array.prototype.slice.call(e,t,i)};o.SetImmediate=function(e){if(window.setImmediate){window.setImmediate(e)}else{setTimeout(e,1)}};o.IsExponentOfTwo=function(e){var t=1;do{t*=2}while(t<e);return t===e};o.CeilingPOT=function(e){e--;e|=e>>1;e|=e>>2;e|=e>>4;e|=e>>8;e|=e>>16;e++;return e};o.FloorPOT=function(e){e=e|e>>1;e=e|e>>2;e=e|e>>4;e=e|e>>8;e=e|e>>16;return e-(e>>1)};o.NearestPOT=function(e){var t=o.CeilingPOT(e);var i=o.FloorPOT(e);return t-e>e-i?i:t};o.GetExponentOfTwo=function(t,i,r){if(r===void 0){r=e.Engine.SCALEMODE_NEAREST}var n;switch(r){case e.Engine.SCALEMODE_FLOOR:n=o.FloorPOT(t);break;case e.Engine.SCALEMODE_NEAREST:n=o.NearestPOT(t);break;case e.Engine.SCALEMODE_CEILING:default:n=o.CeilingPOT(t);break}
return Math.min(n,i)};o.GetFilename=function(e){var t=e.lastIndexOf("/");if(t<0)return e;return e.substring(t+1)};o.GetFolderPath=function(e,t){if(t===void 0){t=false}var i=e.lastIndexOf("/");if(i<0){if(t){return e}return""}return e.substring(0,i+1)};o.GetDOMTextContent=function(e){var t="";var i=e.firstChild;while(i){if(i.nodeType===3){t+=i.textContent}i=i.nextSibling}return t};o.ToDegrees=function(e){return e*180/Math.PI};o.ToRadians=function(e){return e*Math.PI/180};o.EncodeArrayBufferTobase64=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var i="";var r,n,o,s,a,u,l;var c=0;var h=new Uint8Array(e);while(c<h.length){r=h[c++];n=c<h.length?h[c++]:Number.NaN;o=c<h.length?h[c++]:Number.NaN;s=r>>2;a=(r&3)<<4|n>>4;u=(n&15)<<2|o>>6;l=o&63;if(isNaN(n)){u=l=64}else if(isNaN(o)){l=64}i+=t.charAt(s)+t.charAt(a)+t.charAt(u)+t.charAt(l)}return"data:image/png;base64,"+i};o.ExtractMinAndMaxIndexed=function(t,i,r,n,o){if(o===void 0){o=null}var s=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);var a=new e.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var u=r;u<r+n;u++){var l=new e.Vector3(t[i[u]*3],t[i[u]*3+1],t[i[u]*3+2]);s=e.Vector3.Minimize(l,s);a=e.Vector3.Maximize(l,a)}if(o){s.x-=s.x*o.x+o.y;s.y-=s.y*o.x+o.y;s.z-=s.z*o.x+o.y;a.x+=a.x*o.x+o.y;a.y+=a.y*o.x+o.y;a.z+=a.z*o.x+o.y}return{minimum:s,maximum:a}};o.ExtractMinAndMax=function(t,i,r,n,o){if(n===void 0){n=null}var s=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);var a=new e.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(!o){o=3}for(var u=i;u<i+r;u++){var l=new e.Vector3(t[u*o],t[u*o+1],t[u*o+2]);s=e.Vector3.Minimize(l,s);a=e.Vector3.Maximize(l,a)}if(n){s.x-=s.x*n.x+n.y;s.y-=s.y*n.x+n.y;s.z-=s.z*n.x+n.y;a.x+=a.x*n.x+n.y;a.y+=a.y*n.x+n.y;a.z+=a.z*n.x+n.y}return{minimum:s,maximum:a}};o.Vector2ArrayFeeder=function(t){return function(i){var r=t.BYTES_PER_ELEMENT!==undefined;var n=r?t.length/2:t.length;if(i>=n){return null}if(r){var o=t;return new e.Vector2(o[i*2+0],o[i*2+1])}var s=t;return s[i]}};o.ExtractMinAndMaxVector2=function(t,i){if(i===void 0){i=null}var r=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE);var n=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE);var o=0;var s=t(o++);while(s){r=e.Vector2.Minimize(s,r);n=e.Vector2.Maximize(s,n);s=t(o++)}if(i){r.x-=r.x*i.x+i.y;r.y-=r.y*i.x+i.y;n.x+=n.x*i.x+i.y;n.y+=n.y*i.x+i.y}return{minimum:r,maximum:n}};o.MakeArray=function(e,t){if(t!==true&&(e===undefined||e==null))return null;return Array.isArray(e)?e:[e]};o.GetPointerPrefix=function(){var e="pointer";if(o.IsWindowObjectExist()&&!window.PointerEvent&&!navigator.pointerEnabled){e="mouse"}return e};o.QueueNewFrame=function(e,t){if(!o.IsWindowObjectExist()){return setTimeout(e,16)}if(!t){t=window}if(t.requestAnimationFrame){return t.requestAnimationFrame(e)}else if(t.msRequestAnimationFrame){return t.msRequestAnimationFrame(e)}else if(t.webkitRequestAnimationFrame){return t.webkitRequestAnimationFrame(e)}else if(t.mozRequestAnimationFrame){return t.mozRequestAnimationFrame(e)}else if(t.oRequestAnimationFrame){return t.oRequestAnimationFrame(e)}else{return window.setTimeout(e,16)}};o.RequestFullscreen=function(e){var t=e.requestFullscreen||e.msRequestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen;if(!t)return;t.call(e)};o.ExitFullscreen=function(){if(document.exitFullscreen){document.exitFullscreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}else if(document.msCancelFullScreen){document.msCancelFullScreen()}};o.SetCorsBehavior=function(e,t){if(e&&e.indexOf("data:")===0){return}if(o.CorsBehavior){if(typeof o.CorsBehavior==="string"||o.CorsBehavior instanceof String){t.crossOrigin=o.CorsBehavior}else{var i=o.CorsBehavior(e);if(i){t.crossOrigin=i}}}};o.CleanUrl=function(e){e=e.replace(/#/gm,"%23");return e};o.LoadImage=function(t,i,r,n){if(t instanceof ArrayBuffer){t=o.EncodeArrayBufferTobase64(t)}t=o.CleanUrl(t);t=o.PreprocessUrl(t);var s=new Image;o.SetCorsBehavior(t,s);var a=function(){s.removeEventListener("load",a);s.removeEventListener("error",u);i(s)};var u=function(e){s.removeEventListener("load",a);s.removeEventListener("error",u);o.Error("Error while trying to load image: "+t);if(r){r("Error while trying to load image: "+t,e)}};s.addEventListener("load",a);s.addEventListener("error",u);var l=function(){s.src=t};var c=function(){if(n){n.loadImageFromDB(t,s)}};if(t.substr(0,5)!=="data:"&&n&&n.enableTexturesOffline&&e.Database.IsUASupportingBlobStorage){n.openAsync(c,l)}else{if(t.indexOf("file:")!==-1){var h=decodeURIComponent(t.substring(5).toLowerCase());if(e.FilesInput.FilesToLoad[h]){try{var f;try{f=URL.createObjectURL(e.FilesInput.FilesToLoad[h],{oneTimeOnly:true})}catch(t){f=URL.createObjectURL(e.FilesInput.FilesToLoad[h])}s.src=f}catch(e){s.src=""}return s}}l()}return s};o.LoadFile=function(i,r,n,s,a,u){i=o.CleanUrl(i);i=o.PreprocessUrl(i);if(i.indexOf("file:")!==-1){var l=decodeURIComponent(i.substring(5).toLowerCase());if(e.FilesInput.FilesToLoad[l]){return o.ReadFile(e.FilesInput.FilesToLoad[l],r,n,a)}}var c=o.BaseUrl+i;var h=false;var f={onCompleteObservable:new e.Observable,abort:function(){return h=true}};var d=function(){var e=new XMLHttpRequest;var i=null;f.abort=function(){h=true;if(e.readyState!==(XMLHttpRequest.DONE||4)){e.abort()}if(i!==null){clearTimeout(i);i=null}};var s=function(l){e.open("GET",c,true);if(a){e.responseType="arraybuffer"}if(n){e.addEventListener("progress",n)}var d=function(){e.removeEventListener("loadend",d);f.onCompleteObservable.notifyObservers(f);f.onCompleteObservable.clear()};e.addEventListener("loadend",d);var p=function(){if(h){return}if(e.readyState===(XMLHttpRequest.DONE||4)){e.removeEventListener("readystatechange",p);if(e.status>=200&&e.status<300||!o.IsWindowObjectExist()&&e.status===0){r(!a?e.responseText:e.response,e.responseURL);return}var n=o.DefaultRetryStrategy;if(n){var f=n(c,e,l);if(f!==-1){e.removeEventListener("loadend",d);e=new XMLHttpRequest;i=setTimeout(function(){return s(l+1)},f);return}}var _=new t("Error status: "+e.status+" "+e.statusText+" - Unable to load "+c,e);if(u){u(e,_)}else{throw _}}};e.addEventListener("readystatechange",p);e.send()};s(0)};if(s&&s.enableSceneOffline){var p=function(){if(!h){d()}};var _=function(){if(h){return}if(s){s.loadFileFromDB(i,function(e){if(!h){r(e)}f.onCompleteObservable.notifyObservers(f)},n?function(e){if(!h){n(e)}}:undefined,p,a)}};s.openAsync(_,p)}else{d()}return f};o.LoadScript=function(e,t,i){var r=document.getElementsByTagName("head")[0];var n=document.createElement("script");n.type="text/javascript";n.src=e;n.onload=function(){if(t){t()}};n.onerror=function(e){if(i){i("Unable to load script",e)}};r.appendChild(n)};o.ReadFileAsDataURL=function(t,i,r){var n=new FileReader;var o={onCompleteObservable:new e.Observable,abort:function(){return n.abort()}};n.onloadend=function(e){o.onCompleteObservable.notifyObservers(o)};n.onload=function(e){i(e.target["result"])};n.onprogress=r;n.readAsDataURL(t);return o};o.ReadFile=function(t,i,r,n){var s=new FileReader;var a={onCompleteObservable:new e.Observable,abort:function(){return s.abort()}};s.onloadend=function(e){return a.onCompleteObservable.notifyObservers(a)};s.onerror=function(e){o.Log("Error while reading file: "+t.name);i(JSON.stringify({autoClear:true,clearColor:[1,0,0],ambientColor:[0,0,0],gravity:[0,-9.807,0],meshes:[],cameras:[],lights:[]}))};s.onload=function(e){i(e.target["result"])};if(r){s.onprogress=r}if(!n){s.readAsText(t)}else{s.readAsArrayBuffer(t)}return a};o.FileAsURL=function(e){var t=new Blob([e]);var i=window.URL||window.webkitURL;var r=i.createObjectURL(t);return r};o.Format=function(e,t){if(t===void 0){t=2}return e.toFixed(t)};o.CheckExtends=function(e,t,i){if(e.x<t.x)t.x=e.x;if(e.y<t.y)t.y=e.y;if(e.z<t.z)t.z=e.z;if(e.x>i.x)i.x=e.x;if(e.y>i.y)i.y=e.y;if(e.z>i.z)i.z=e.z};o.DeepCopy=function(e,t,i,r){for(var o in e){if(o[0]==="_"&&(!r||r.indexOf(o)===-1)){continue}if(i&&i.indexOf(o)!==-1){continue}var s=e[o];var a=typeof s;if(a==="function"){continue}try{if(a==="object"){if(s instanceof Array){t[o]=[];if(s.length>0){if(typeof s[0]=="object"){for(var u=0;u<s.length;u++){var l=n(s[u],t);if(t[o].indexOf(l)===-1){t[o].push(l)}}}else{t[o]=s.slice(0)}}}else{t[o]=n(s,t)}}else{t[o]=s}}catch(e){}}};o.IsEmpty=function(e){for(var t in e){if(e.hasOwnProperty(t)){return false}}return true};o.RegisterTopRootEvents=function(e){for(var t=0;t<e.length;t++){var i=e[t];window.addEventListener(i.name,i.handler,false);try{if(window.parent){window.parent.addEventListener(i.name,i.handler,false)}}catch(e){}}};o.UnregisterTopRootEvents=function(e){for(var t=0;t<e.length;t++){var i=e[t];window.removeEventListener(i.name,i.handler);try{if(window.parent){window.parent.removeEventListener(i.name,i.handler)}}catch(e){}}};o.DumpFramebuffer=function(e,t,i,n,s,a){if(s===void 0){s="image/png"}var u=e*4;var l=t/2;var c=i.readPixels(0,0,e,t);for(var h=0;h<l;h++){for(var f=0;f<u;f++){var d=f+h*u;var p=t-h-1;var _=f+p*u;var m=c[d];c[d]=c[_];c[_]=m}}if(!r){r=document.createElement("canvas")}r.width=e;r.height=t;var g=r.getContext("2d");if(g){var v=g.createImageData(e,t);var y=v.data;y.set(c);g.putImageData(v,0,0);o.EncodeScreenshotCanvasData(n,s,a)}};o.EncodeScreenshotCanvasData=function(e,t,i){if(t===void 0){t="image/png"}var n=r.toDataURL(t);if(e){e(n)}else{if(!r.toBlob){r.toBlob=function(e,t,i){var r=this;setTimeout(function(){var n=atob(r.toDataURL(t,i).split(",")[1]),o=n.length,s=new Uint8Array(o);for(var a=0;a<o;a++){s[a]=n.charCodeAt(a)}e(new Blob([s],{type:t||"image/png"}))})}}r.toBlob(function(e){var t=URL.createObjectURL(e);if("download"in document.createElement("a")){var r=window.document.createElement("a");r.href=t;if(i){r.setAttribute("download",i)}else{var n=new Date;var o=(n.getFullYear()+"-"+(n.getMonth()+1)).slice(-2)+"-"+n.getDate()+"_"+n.getHours()+"-"+("0"+n.getMinutes()).slice(-2);r.setAttribute("download","screenshot_"+o+".png")}window.document.body.appendChild(r);r.addEventListener("click",function(){if(r.parentElement){r.parentElement.removeChild(r)}});r.click()}else{var s=window.open("");if(!s)return;var a=s.document.createElement("img");a.onload=function(){URL.revokeObjectURL(t)};a.src=t;s.document.body.appendChild(a)}})}};o.CreateScreenshot=function(e,t,i,n,s){if(s===void 0){s="image/png"}var a;var u;if(i.precision){a=Math.round(e.getRenderWidth()*i.precision);u=Math.round(a/e.getAspectRatio(t))}else if(i.width&&i.height){a=i.width;u=i.height}else if(i.width&&!i.height){a=i.width;u=Math.round(a/e.getAspectRatio(t))}else if(i.height&&!i.width){u=i.height;a=Math.round(u*e.getAspectRatio(t))}else if(!isNaN(i)){u=i;a=i}else{o.Error("Invalid 'size' parameter !");return}if(!r){r=document.createElement("canvas")}r.width=a;r.height=u;var l=r.getContext("2d");var c=e.getRenderWidth()/e.getRenderHeight();var h=a;var f=h/c;if(f>u){f=u;h=f*c}var d=Math.max(0,a-h)/2;var p=Math.max(0,u-f)/2;var _=e.getRenderingCanvas();if(l&&_){l.drawImage(_,d,p,h,f)}o.EncodeScreenshotCanvasData(n,s)};o.CreateScreenshotUsingRenderTarget=function(t,i,r,n,s,a,u,l){if(s===void 0){s="image/png"}if(a===void 0){a=1}if(u===void 0){u=false}var c;var h;if(r.precision){c=Math.round(t.getRenderWidth()*r.precision);h=Math.round(c/t.getAspectRatio(i));r={width:c,height:h}}else if(r.width&&r.height){c=r.width;h=r.height}else if(r.width&&!r.height){c=r.width;h=Math.round(c/t.getAspectRatio(i));r={width:c,height:h}}else if(r.height&&!r.width){h=r.height;c=Math.round(h*t.getAspectRatio(i));r={width:c,height:h}}else if(!isNaN(r)){h=r;c=r}else{o.Error("Invalid 'size' parameter !");return}var f=i.getScene();var d=null;if(f.activeCamera!==i){d=f.activeCamera;f.activeCamera=i}var p=new e.RenderTargetTexture("screenShot",r,f,false,false,e.Engine.TEXTURETYPE_UNSIGNED_INT,false,e.Texture.NEAREST_SAMPLINGMODE);p.renderList=null;p.samples=a;if(u){p.addPostProcess(new e.FxaaPostProcess("antialiasing",1,f.activeCamera))}p.onAfterRenderObservable.add(function(){o.DumpFramebuffer(c,h,t,n,s,l)});f.incrementRenderId();f.resetCachedMaterial();p.render(true);p.dispose();if(d){f.activeCamera=d}i.getProjectionMatrix(true)};o.ValidateXHRData=function(t,i){if(i===void 0){i=7}try{if(i&1){if(t.responseText&&t.responseText.length>0){return true}else if(i===1){return false}}if(i&2){var r=e.TGATools.GetTGAHeader(t.response);if(r.width&&r.height&&r.width>0&&r.height>0){return true}else if(i===2){return false}}if(i&4){var n=new Uint8Array(t.response,0,3);if(n[0]===68&&n[1]===68&&n[2]===83){return true}else{return false}}}catch(e){}return false};o.RandomId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,i=e==="x"?t:t&3|8;return i.toString(16)})};o.IsBase64=function(e){return e.length<5?false:e.substr(0,5)==="data:"};o.DecodeBase64=function(e){var t=atob(e.split(",")[1]);var i=t.length;var r=new Uint8Array(new ArrayBuffer(i));for(var n=0;n<i;n++){r[n]=t.charCodeAt(n)}return r.buffer};Object.defineProperty(o,"NoneLogLevel",{get:function(){return o._NoneLogLevel},enumerable:true,configurable:true});Object.defineProperty(o,"MessageLogLevel",{get:function(){return o._MessageLogLevel},enumerable:true,configurable:true});Object.defineProperty(o,"WarningLogLevel",{get:function(){return o._WarningLogLevel},enumerable:true,configurable:true});Object.defineProperty(o,"ErrorLogLevel",{get:function(){return o._ErrorLogLevel},enumerable:true,configurable:true});Object.defineProperty(o,"AllLogLevel",{get:function(){return o._MessageLogLevel|o._WarningLogLevel|o._ErrorLogLevel},enumerable:true,configurable:true});o._AddLogEntry=function(e){o._LogCache=e+o._LogCache;if(o.OnNewCacheEntry){o.OnNewCacheEntry(e)}};o._FormatMessage=function(e){var t=function(e){return e<10?"0"+e:""+e};var i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e};o._LogDisabled=function(e){};o._LogEnabled=function(e){var t=o._FormatMessage(e);console.log("BJS - "+t);var i="<div style='color:white'>"+t+"</div><br>";o._AddLogEntry(i)};o._WarnDisabled=function(e){};o._WarnEnabled=function(e){var t=o._FormatMessage(e);console.warn("BJS - "+t);var i="<div style='color:orange'>"+t+"</div><br>";o._AddLogEntry(i)};o._ErrorDisabled=function(e){};o._ErrorEnabled=function(e){o.errorsCount++;var t=o._FormatMessage(e);console.error("BJS - "+t);var i="<div style='color:red'>"+t+"</div><br>";o._AddLogEntry(i)};Object.defineProperty(o,"LogCache",{get:function(){return o._LogCache},enumerable:true,configurable:true});o.ClearLogCache=function(){o._LogCache="";o.errorsCount=0};Object.defineProperty(o,"LogLevels",{set:function(e){if((e&o.MessageLogLevel)===o.MessageLogLevel){o.Log=o._LogEnabled}else{o.Log=o._LogDisabled}if((e&o.WarningLogLevel)===o.WarningLogLevel){o.Warn=o._WarnEnabled}else{o.Warn=o._WarnDisabled}if((e&o.ErrorLogLevel)===o.ErrorLogLevel){o.Error=o._ErrorEnabled}else{o.Error=o._ErrorDisabled}},enumerable:true,configurable:true});o.IsWindowObjectExist=function(){return typeof window!=="undefined"};Object.defineProperty(o,"PerformanceNoneLogLevel",{get:function(){return o._PerformanceNoneLogLevel},enumerable:true,configurable:true});Object.defineProperty(o,"PerformanceUserMarkLogLevel",{get:function(){return o._PerformanceUserMarkLogLevel},enumerable:true,configurable:true});Object.defineProperty(o,"PerformanceConsoleLogLevel",{get:function(){return o._PerformanceConsoleLogLevel},enumerable:true,configurable:true});Object.defineProperty(o,"PerformanceLogLevel",{set:function(e){if((e&o.PerformanceUserMarkLogLevel)===o.PerformanceUserMarkLogLevel){o.StartPerformanceCounter=o._StartUserMark;o.EndPerformanceCounter=o._EndUserMark;return}if((e&o.PerformanceConsoleLogLevel)===o.PerformanceConsoleLogLevel){o.StartPerformanceCounter=o._StartPerformanceConsole;o.EndPerformanceCounter=o._EndPerformanceConsole;return}o.StartPerformanceCounter=o._StartPerformanceCounterDisabled;o.EndPerformanceCounter=o._EndPerformanceCounterDisabled},enumerable:true,configurable:true});o._StartPerformanceCounterDisabled=function(e,t){};o._EndPerformanceCounterDisabled=function(e,t){};o._StartUserMark=function(e,t){if(t===void 0){t=true}if(!o._performance){if(!o.IsWindowObjectExist()){return}o._performance=window.performance}if(!t||!o._performance.mark){return}o._performance.mark(e+"-Begin")};o._EndUserMark=function(e,t){if(t===void 0){t=true}if(!t||!o._performance.mark){return}o._performance.mark(e+"-End");o._performance.measure(e,e+"-Begin",e+"-End")};o._StartPerformanceConsole=function(e,t){if(t===void 0){t=true}if(!t){return}o._StartUserMark(e,t);if(console.time){console.time(e)}};o._EndPerformanceConsole=function(e,t){if(t===void 0){t=true}if(!t){return}o._EndUserMark(e,t);if(console.time){console.timeEnd(e)}};Object.defineProperty(o,"Now",{get:function(){if(o.IsWindowObjectExist()&&window.performance&&window.performance.now){return window.performance.now()}return(new Date).getTime()},enumerable:true,configurable:true});o.GetClassName=function(e,t){if(t===void 0){t=false}var i=null;if(!t&&e.getClassName){i=e.getClassName()}else{if(e instanceof Object){var r=t?e:Object.getPrototypeOf(e);i=r.constructor["__bjsclassName__"]}if(!i){i=typeof e}}return i};o.First=function(e,t){for(var i=0,r=e;i<r.length;i++){var n=r[i];if(t(n)){return n}}return null};o.getFullClassName=function(e,t){if(t===void 0){t=false}var i=null;var r=null;if(!t&&e.getClassName){i=e.getClassName()}else{if(e instanceof Object){var n=t?e:Object.getPrototypeOf(e);i=n.constructor["__bjsclassName__"];r=n.constructor["__bjsmoduleName__"]}if(!i){i=typeof e}}if(!i){return null}return(r!=null?r+".":"")+i};o.arrayOrStringFeeder=function(e){return function(t){if(t>=e.length){return null}var i=e.charCodeAt?e.charCodeAt(t):e[t];if(i&&i.getHashCode){i=i.getHashCode()}if(typeof i==="string"){return o.hashCodeFromStream(o.arrayOrStringFeeder(i))}return i}};o.hashCodeFromStream=function(e){var t=0;var i=0;var r=e(i++);while(r!=null){t=(t<<5)-t+r;t|=0;r=e(i++)}return t};o.DelayAsync=function(e){return new Promise(function(t){setTimeout(function(){t()},e)})};o.BaseUrl="";o.DefaultRetryStrategy=i.ExponentialBackoff();o.CorsBehavior="anonymous";o.UseFallbackTexture=true;o.RegisteredExternalClasses={};o.fallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";o.PreprocessUrl=function(e){return e};o._NoneLogLevel=0;o._MessageLogLevel=1;o._WarningLogLevel=2;o._ErrorLogLevel=4;o._LogCache="";o.errorsCount=0;o.Log=o._LogEnabled;o.Warn=o._WarnEnabled;o.Error=o._ErrorEnabled;o._PerformanceNoneLogLevel=0;o._PerformanceUserMarkLogLevel=1;o._PerformanceConsoleLogLevel=2;o.StartPerformanceCounter=o._StartPerformanceCounterDisabled;o.EndPerformanceCounter=o._EndPerformanceCounterDisabled;return o}();e.Tools=o;var s=function(){function e(){this._startMonitoringTime=0;this._min=0;this._max=0;this._average=0;this._lastSecAverage=0;this._current=0;this._totalValueCount=0;this._totalAccumulated=0;this._lastSecAccumulated=0;this._lastSecTime=0;this._lastSecValueCount=0}Object.defineProperty(e.prototype,"min",{get:function(){return this._min},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"max",{get:function(){return this._max},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"average",{get:function(){return this._average},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"lastSecAverage",{get:function(){return this._lastSecAverage},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"current",{get:function(){return this._current},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"total",{get:function(){return this._totalAccumulated},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"count",{get:function(){return this._totalValueCount},enumerable:true,configurable:true});e.prototype.fetchNewFrame=function(){this._totalValueCount++;this._current=0;this._lastSecValueCount++};e.prototype.addCount=function(t,i){if(!e.Enabled){return}this._current+=t;if(i){this._fetchResult()}};e.prototype.beginMonitoring=function(){if(!e.Enabled){return}this._startMonitoringTime=o.Now};e.prototype.endMonitoring=function(t){if(t===void 0){t=true}if(!e.Enabled){return}if(t){this.fetchNewFrame()}var i=o.Now;this._current=i-this._startMonitoringTime;if(t){this._fetchResult()}};e.prototype._fetchResult=function(){this._totalAccumulated+=this._current;this._lastSecAccumulated+=this._current;this._min=Math.min(this._min,this._current);this._max=Math.max(this._max,this._current);this._average=this._totalAccumulated/this._totalValueCount;var e=o.Now;if(e-this._lastSecTime>1e3){this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount;this._lastSecTime=e;this._lastSecAccumulated=0;this._lastSecValueCount=0}};e.Enabled=true;return e}();e.PerfCounter=s;function a(e,t){return function(i){i["__bjsclassName__"]=e;i["__bjsmoduleName__"]=t!=null?t:null}}e.className=a;var u=function(){function e(e,t,i,r){if(r===void 0){r=0}this.iterations=e;this._fn=t;this._successCallback=i;this.index=r-1;this._done=false}e.prototype.executeNext=function(){if(!this._done){if(this.index+1<this.iterations){++this.index;this._fn(this)}else{this.breakLoop()}}};e.prototype.breakLoop=function(){this._done=true;this._successCallback()};e.Run=function(t,i,r,n){if(n===void 0){n=0}var o=new e(t,i,r,n);o.executeNext();return o};e.SyncAsyncForLoop=function(t,i,r,n,o,s){if(s===void 0){s=0}e.Run(Math.ceil(t/i),function(e){if(o&&o())e.breakLoop();else{setTimeout(function(){for(var n=0;n<i;++n){var s=e.index*i+n;if(s>=t)break;r(s);if(o&&o()){e.breakLoop();break}}e.executeNext()},s)}},n)};return e}();e.AsyncLoop=u})(r||(r={}));"use strict";var r;(function(e){var t;(function(e){e[e["Pending"]=0]="Pending";e[e["Fulfilled"]=1]="Fulfilled";e[e["Rejected"]=2]="Rejected"})(t||(t={}));var i=function(){function e(){this.count=0;this.target=0;this.results=[]}return e}();var r=function(){function r(e){var i=this;this._state=t.Pending;this._children=new Array;this._rejectWasConsumed=false;if(!e){return}try{e(function(e){i._resolve(e)},function(e){i._reject(e)})}catch(e){this._reject(e)}}r.prototype.catch=function(e){return this.then(undefined,e)};r.prototype.then=function(i,n){var o=this;var s=new r;s._onFulfilled=i;s._onRejected=n;this._children.push(s);if(this._state!==t.Pending){e.Tools.SetImmediate(function(){if(o._state===t.Fulfilled||o._rejectWasConsumed){var e=s._resolve(o._result);if(e!==undefined&&e!==null){if(e._state!==undefined){var i=e;s._children.push(i);s=i}else{s._result=e}}}else{s._reject(o._reason)}})}return s};r.prototype._moveChildren=function(e){(a=this._children).push.apply(a,e.splice(0,e.length));if(this._state===t.Fulfilled){for(var i=0,r=this._children;i<r.length;i++){var n=r[i];n._resolve(this._result)}}else if(this._state===t.Rejected){for(var o=0,s=this._children;o<s.length;o++){var n=s[o];n._reject(this._reason)}}var a};r.prototype._resolve=function(e){try{this._state=t.Fulfilled;var i=null;if(this._onFulfilled){i=this._onFulfilled(e)}if(i!==undefined&&i!==null){if(i._state!==undefined){var r=i;r._moveChildren(this._children);e=r._result}else{e=i}}this._result=e;for(var n=0,o=this._children;n<o.length;n++){var s=o[n];s._resolve(e)}this._children.length=0;delete this._onFulfilled;delete this._onRejected}catch(e){this._reject(e,true)}};r.prototype._reject=function(e,i){if(i===void 0){i=false}this._state=t.Rejected;this._reason=e;if(this._onRejected&&!i){try{this._onRejected(e);this._rejectWasConsumed=true}catch(t){e=t}}for(var r=0,n=this._children;r<n.length;r++){var o=n[r];if(this._rejectWasConsumed){o._resolve(null)}else{o._reject(e)}}this._children.length=0;delete this._onFulfilled;delete this._onRejected};r.resolve=function(e){var t=new r;t._resolve(e);return t};r._RegisterForFulfillment=function(e,i,r){e.then(function(e){i.results[r]=e;i.count++;if(i.count===i.target){i.rootPromise._resolve(i.results)}return null},function(e){if(i.rootPromise._state!==t.Rejected){i.rootPromise._reject(e)}})};r.all=function(e){var t=new r;var n=new i;n.target=e.length;n.rootPromise=t;if(e.length){for(var o=0;o<e.length;o++){r._RegisterForFulfillment(e[o],n,o)}}else{t._resolve([])}return t};r.race=function(e){var t=new r;if(e.length){for(var i=0,n=e;i<n.length;i++){var o=n[i];o.then(function(e){if(t){t._resolve(e);t=null}return null},function(e){if(t){t._reject(e);t=null}})}}return t};return r}();var n=function(){function e(){}e.Apply=function(e){if(e===void 0){e=false}if(e||typeof Promise==="undefined"){var t=window;t.Promise=r}};return e}();e.PromisePolyfill=n})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e){this._pendingActions=new Array;this._workerInfos=e.map(function(e){return{worker:e,active:false}})}e.prototype.dispose=function(){for(var e=0,t=this._workerInfos;e<t.length;e++){var i=t[e];i.worker.terminate()}delete this._workerInfos;delete this._pendingActions};e.prototype.push=function(e){for(var t=0,i=this._workerInfos;t<i.length;t++){var r=i[t];if(!r.active){this._execute(r,e);return}}this._pendingActions.push(e)};e.prototype._execute=function(e,t){var i=this;e.active=true;t(e.worker,function(){e.active=false;var t=i._pendingActions.shift();if(t){i._execute(e,t)}})};return e}();e.WorkerPool=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this._isAlphaBlendDirty=false;this._isBlendFunctionParametersDirty=false;this._isBlendEquationParametersDirty=false;this._isBlendConstantsDirty=false;this._alphaBlend=false;this._blendFunctionParameters=new Array(4);this._blendEquationParameters=new Array(2);this._blendConstants=new Array(4);this.reset()}Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"alphaBlend",{get:function(){return this._alphaBlend},set:function(e){if(this._alphaBlend===e){return}this._alphaBlend=e;this._isAlphaBlendDirty=true},enumerable:true,configurable:true});e.prototype.setAlphaBlendConstants=function(e,t,i,r){if(this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===r){return}this._blendConstants[0]=e;this._blendConstants[1]=t;this._blendConstants[2]=i;this._blendConstants[3]=r;this._isBlendConstantsDirty=true};e.prototype.setAlphaBlendFunctionParameters=function(e,t,i,r){if(this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===r){return}this._blendFunctionParameters[0]=e;this._blendFunctionParameters[1]=t;this._blendFunctionParameters[2]=i;this._blendFunctionParameters[3]=r;this._isBlendFunctionParametersDirty=true};e.prototype.setAlphaEquationParameters=function(e,t){if(this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t){return}this._blendEquationParameters[0]=e;this._blendEquationParameters[1]=t;this._isBlendEquationParametersDirty=true};e.prototype.reset=function(){this._alphaBlend=false;this._blendFunctionParameters[0]=null;this._blendFunctionParameters[1]=null;this._blendFunctionParameters[2]=null;this._blendFunctionParameters[3]=null;this._blendEquationParameters[0]=null;this._blendEquationParameters[1]=null;this._blendConstants[0]=null;this._blendConstants[1]=null;this._blendConstants[2]=null;this._blendConstants[3]=null;this._isAlphaBlendDirty=true;this._isBlendFunctionParametersDirty=false;this._isBlendEquationParametersDirty=false;this._isBlendConstantsDirty=false};e.prototype.apply=function(e){if(!this.isDirty){return}if(this._isAlphaBlendDirty){if(this._alphaBlend){e.enable(e.BLEND)}else{e.disable(e.BLEND)}this._isAlphaBlendDirty=false}if(this._isBlendFunctionParametersDirty){e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]);this._isBlendFunctionParametersDirty=false}if(this._isBlendEquationParametersDirty){e.blendEquationSeparate(this._isBlendEquationParametersDirty[0],this._isBlendEquationParametersDirty[1]);this._isBlendEquationParametersDirty=false}if(this._isBlendConstantsDirty){
e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]);this._isBlendConstantsDirty=false}};return e}();e._AlphaState=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this._isDepthTestDirty=false;this._isDepthMaskDirty=false;this._isDepthFuncDirty=false;this._isCullFaceDirty=false;this._isCullDirty=false;this._isZOffsetDirty=false;this._isFrontFaceDirty=false;this.reset()}Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"zOffset",{get:function(){return this._zOffset},set:function(e){if(this._zOffset===e){return}this._zOffset=e;this._isZOffsetDirty=true},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"cullFace",{get:function(){return this._cullFace},set:function(e){if(this._cullFace===e){return}this._cullFace=e;this._isCullFaceDirty=true},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"cull",{get:function(){return this._cull},set:function(e){if(this._cull===e){return}this._cull=e;this._isCullDirty=true},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(e){if(this._depthFunc===e){return}this._depthFunc=e;this._isDepthFuncDirty=true},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"depthMask",{get:function(){return this._depthMask},set:function(e){if(this._depthMask===e){return}this._depthMask=e;this._isDepthMaskDirty=true},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"depthTest",{get:function(){return this._depthTest},set:function(e){if(this._depthTest===e){return}this._depthTest=e;this._isDepthTestDirty=true},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"frontFace",{get:function(){return this._frontFace},set:function(e){if(this._frontFace===e){return}this._frontFace=e;this._isFrontFaceDirty=true},enumerable:true,configurable:true});e.prototype.reset=function(){this._depthMask=true;this._depthTest=true;this._depthFunc=null;this._cullFace=null;this._cull=null;this._zOffset=0;this._frontFace=null;this._isDepthTestDirty=true;this._isDepthMaskDirty=true;this._isDepthFuncDirty=false;this._isCullFaceDirty=false;this._isCullDirty=false;this._isZOffsetDirty=false;this._isFrontFaceDirty=false};e.prototype.apply=function(e){if(!this.isDirty){return}if(this._isCullDirty){if(this.cull){e.enable(e.CULL_FACE)}else{e.disable(e.CULL_FACE)}this._isCullDirty=false}if(this._isCullFaceDirty){e.cullFace(this.cullFace);this._isCullFaceDirty=false}if(this._isDepthMaskDirty){e.depthMask(this.depthMask);this._isDepthMaskDirty=false}if(this._isDepthTestDirty){if(this.depthTest){e.enable(e.DEPTH_TEST)}else{e.disable(e.DEPTH_TEST)}this._isDepthTestDirty=false}if(this._isDepthFuncDirty){e.depthFunc(this.depthFunc);this._isDepthFuncDirty=false}if(this._isZOffsetDirty){if(this.zOffset){e.enable(e.POLYGON_OFFSET_FILL);e.polygonOffset(this.zOffset,0)}else{e.disable(e.POLYGON_OFFSET_FILL)}this._isZOffsetDirty=false}if(this._isFrontFaceDirty){e.frontFace(this.frontFace);this._isFrontFaceDirty=false}};return e}();e._DepthCullingState=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this._isStencilTestDirty=false;this._isStencilMaskDirty=false;this._isStencilFuncDirty=false;this._isStencilOpDirty=false;this.reset()}Object.defineProperty(t.prototype,"isDirty",{get:function(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"stencilFunc",{get:function(){return this._stencilFunc},set:function(e){if(this._stencilFunc===e){return}this._stencilFunc=e;this._isStencilFuncDirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"stencilFuncRef",{get:function(){return this._stencilFuncRef},set:function(e){if(this._stencilFuncRef===e){return}this._stencilFuncRef=e;this._isStencilFuncDirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"stencilFuncMask",{get:function(){return this._stencilFuncMask},set:function(e){if(this._stencilFuncMask===e){return}this._stencilFuncMask=e;this._isStencilFuncDirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"stencilOpStencilFail",{get:function(){return this._stencilOpStencilFail},set:function(e){if(this._stencilOpStencilFail===e){return}this._stencilOpStencilFail=e;this._isStencilOpDirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"stencilOpDepthFail",{get:function(){return this._stencilOpDepthFail},set:function(e){if(this._stencilOpDepthFail===e){return}this._stencilOpDepthFail=e;this._isStencilOpDirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"stencilOpStencilDepthPass",{get:function(){return this._stencilOpStencilDepthPass},set:function(e){if(this._stencilOpStencilDepthPass===e){return}this._stencilOpStencilDepthPass=e;this._isStencilOpDirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"stencilMask",{get:function(){return this._stencilMask},set:function(e){if(this._stencilMask===e){return}this._stencilMask=e;this._isStencilMaskDirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"stencilTest",{get:function(){return this._stencilTest},set:function(e){if(this._stencilTest===e){return}this._stencilTest=e;this._isStencilTestDirty=true},enumerable:true,configurable:true});t.prototype.reset=function(){this._stencilTest=false;this._stencilMask=255;this._stencilFunc=e.Engine.ALWAYS;this._stencilFuncRef=1;this._stencilFuncMask=255;this._stencilOpStencilFail=e.Engine.KEEP;this._stencilOpDepthFail=e.Engine.KEEP;this._stencilOpStencilDepthPass=e.Engine.REPLACE;this._isStencilTestDirty=true;this._isStencilMaskDirty=true;this._isStencilFuncDirty=true;this._isStencilOpDirty=true};t.prototype.apply=function(e){if(!this.isDirty){return}if(this._isStencilTestDirty){if(this.stencilTest){e.enable(e.STENCIL_TEST)}else{e.disable(e.STENCIL_TEST)}this._isStencilTestDirty=false}if(this._isStencilMaskDirty){e.stencilMask(this.stencilMask);this._isStencilMaskDirty=false}if(this._isStencilFuncDirty){e.stencilFunc(this.stencilFunc,this.stencilFuncRef,this.stencilFuncMask);this._isStencilFuncDirty=false}if(this._isStencilOpDirty){e.stencilOp(this.stencilOpStencilFail,this.stencilOpDepthFail,this.stencilOpStencilDepthPass);this._isStencilOpDirty=false}};return t}();e._StencilState=t})(r||(r={}));"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++){t=arguments[i];for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n))e[n]=t[n]}return e};var r;(function(e){var t=function(e,t,r,n,o){return i(e,o+(n?n+"\n":"")+t,r)};var i=function(e,t,i){var r=e.createShader(i==="vertex"?e.VERTEX_SHADER:e.FRAGMENT_SHADER);e.shaderSource(r,t);e.compileShader(r);if(!e.getShaderParameter(r,e.COMPILE_STATUS)){var n=e.getShaderInfoLog(r);if(n){throw new Error(n)}}if(!r){throw new Error("Something went wrong while compile the shader.")}return r};var r=function(t,i,r){var n=r.NEAREST;var o=r.NEAREST;switch(t){case e.Texture.BILINEAR_SAMPLINGMODE:n=r.LINEAR;if(i){o=r.LINEAR_MIPMAP_NEAREST}else{o=r.LINEAR}break;case e.Texture.TRILINEAR_SAMPLINGMODE:n=r.LINEAR;if(i){o=r.LINEAR_MIPMAP_LINEAR}else{o=r.LINEAR}break;case e.Texture.NEAREST_SAMPLINGMODE:n=r.NEAREST;if(i){o=r.NEAREST_MIPMAP_LINEAR}else{o=r.NEAREST}break;case e.Texture.NEAREST_NEAREST_MIPNEAREST:n=r.NEAREST;if(i){o=r.NEAREST_MIPMAP_NEAREST}else{o=r.NEAREST}break;case e.Texture.NEAREST_LINEAR_MIPNEAREST:n=r.NEAREST;if(i){o=r.LINEAR_MIPMAP_NEAREST}else{o=r.LINEAR}break;case e.Texture.NEAREST_LINEAR_MIPLINEAR:n=r.NEAREST;if(i){o=r.LINEAR_MIPMAP_LINEAR}else{o=r.LINEAR}break;case e.Texture.NEAREST_LINEAR:n=r.NEAREST;o=r.LINEAR;break;case e.Texture.NEAREST_NEAREST:n=r.NEAREST;o=r.NEAREST;break;case e.Texture.LINEAR_NEAREST_MIPNEAREST:n=r.LINEAR;if(i){o=r.NEAREST_MIPMAP_NEAREST}else{o=r.NEAREST}break;case e.Texture.LINEAR_NEAREST_MIPLINEAR:n=r.LINEAR;if(i){o=r.NEAREST_MIPMAP_LINEAR}else{o=r.NEAREST}break;case e.Texture.LINEAR_LINEAR:n=r.LINEAR;o=r.LINEAR;break;case e.Texture.LINEAR_NEAREST:n=r.LINEAR;o=r.NEAREST;break}return{min:o,mag:n}};var o=function(t,i,r,n,o,s){if(s===void 0){s=null}var a;var u=function(){r[i]=a;r._internalCount++;if(n){n._removePendingData(a)}if(r._internalCount===6){o(r)}};var l=function(e,t){if(n){n._removePendingData(a)}if(s){s(e,t)}};a=e.Tools.LoadImage(t,u,l,n?n.database:null);if(n){n._addPendingData(a)}};var s=function(e,t,i,r,n){if(n===void 0){n=null}var s=[];s._internalCount=0;for(var a=0;a<6;a++){o(r[a],a,s,t,i,n)}};var a=function(){function e(){}return e}();var u=function(){function e(){}return e}();e.InstancingAttributeInfo=u;var l=function(){function e(){}return e}();e.RenderTargetCreationOptions=l;var c=function(){function e(){}return e}();e.DepthTextureCreationOptions=c;var h=function(){function e(){}return e}();e.EngineCapabilities=h;var f=function(){function o(t,i,r,n){if(n===void 0){n=false}var s=this;this.forcePOTTextures=false;this.isFullscreen=false;this.isPointerLock=false;this.cullBackFaces=true;this.renderEvenInBackground=true;this.preventCacheWipeBetweenFrames=false;this.enableOfflineSupport=false;this.scenes=new Array;this.postProcesses=new Array;this.onResizeObservable=new e.Observable;this.onCanvasBlurObservable=new e.Observable;this.onCanvasFocusObservable=new e.Observable;this.onCanvasPointerOutObservable=new e.Observable;this.onBeforeTextureInitObservable=new e.Observable;this._vrDisplay=undefined;this._vrSupported=false;this._vrExclusivePointerMode=false;this.disableUniformBuffers=false;this._uniformBuffers=new Array;this.onBeginFrameObservable=new e.Observable;this.onEndFrameObservable=new e.Observable;this.onBeforeShaderCompilationObservable=new e.Observable;this.onAfterShaderCompilationObservable=new e.Observable;this._windowIsBackground=false;this._webGLVersion=1;this._badOS=false;this._badDesktopOS=false;this.disableTextureBindingOptimization=false;this.onVRDisplayChangedObservable=new e.Observable;this.onVRRequestPresentComplete=new e.Observable;this.onVRRequestPresentStart=new e.Observable;this._colorWrite=true;this._drawCalls=new e.PerfCounter;this._textureCollisions=new e.PerfCounter;this._renderingQueueLaunched=false;this._activeRenderLoops=new Array;this._deterministicLockstep=false;this._lockstepMaxSteps=4;this.onContextLostObservable=new e.Observable;this.onContextRestoredObservable=new e.Observable;this._contextWasLost=false;this._doNotHandleContextLost=false;this._performanceMonitor=new e.PerformanceMonitor;this._fps=60;this._deltaTime=0;this.disablePerformanceMonitorInBackground=false;this._depthCullingState=new e._DepthCullingState;this._stencilState=new e._StencilState;this._alphaState=new e._AlphaState;this._alphaMode=o.ALPHA_DISABLE;this._internalTexturesCache=new Array;this._activeChannel=0;this._currentTextureChannel=-1;this._boundTexturesCache={};this._compiledEffects={};this._vertexAttribArraysEnabled=[];this._uintIndicesCurrentlySet=false;this._currentBoundBuffer=new Array;this._currentBufferPointers=new Array;this._currentInstanceLocations=new Array;this._currentInstanceBuffers=new Array;this._firstBoundInternalTextureTracker=new e.DummyInternalTextureTracker;this._lastBoundInternalTextureTracker=new e.DummyInternalTextureTracker;this._vaoRecordInProgress=false;this._mustWipeVertexAttributes=false;this._nextFreeTextureSlots=new Array;this._maxSimultaneousTextures=0;this._activeRequests=new Array;this._texturesSupported=new Array;this._onVRFullScreenTriggered=function(){if(s._vrDisplay&&s._vrDisplay.isPresenting){s._oldSize=new e.Size(s.getRenderWidth(),s.getRenderHeight());s._oldHardwareScaleFactor=s.getHardwareScalingLevel();var t=s._vrDisplay.getEyeParameters("left");s.setHardwareScalingLevel(1);s.setSize(t.renderWidth*2,t.renderHeight)}else{s.setHardwareScalingLevel(s._oldHardwareScaleFactor);s.setSize(s._oldSize.width,s._oldSize.height)}};this._boundUniforms={};e.PromisePolyfill.Apply();var u=null;o.Instances.push(this);if(!t){return}r=r||{};if(t.getContext){u=t;this._renderingCanvas=u;if(i!=null){r.antialias=i}if(r.deterministicLockstep===undefined){r.deterministicLockstep=false}if(r.lockstepMaxSteps===undefined){r.lockstepMaxSteps=4}if(r.preserveDrawingBuffer===undefined){r.preserveDrawingBuffer=false}if(r.audioEngine===undefined){r.audioEngine=true}if(r.stencil===undefined){r.stencil=true}this._deterministicLockstep=r.deterministicLockstep;this._lockstepMaxSteps=r.lockstepMaxSteps;this._doNotHandleContextLost=r.doNotHandleContextLost?true:false;if(navigator&&navigator.userAgent){var l=navigator.userAgent;for(var c=0,h=o.ExceptionList;c<h.length;c++){var f=h[c];var d=f.key;var p=f.targets;if(l.indexOf(d)>-1){if(f.capture&&f.captureConstraint){var _=f.capture;var m=f.captureConstraint;var g=new RegExp(_);var v=g.exec(l);if(v&&v.length>0){var y=parseInt(v[v.length-1]);if(y>=m){continue}}}for(var b=0,x=p;b<x.length;b++){var T=x[b];switch(T){case"uniformBuffer":this.disableUniformBuffers=true;break;case"textureBindingOptimization":this.disableTextureBindingOptimization=true;break}}}}}if(!r.disableWebGL2Support){try{this._gl=u.getContext("webgl2",r)||u.getContext("experimental-webgl2",r);if(this._gl){this._webGLVersion=2}}catch(e){}}if(!this._gl){if(!u){throw new Error("The provided canvas is null or undefined.")}try{this._gl=u.getContext("webgl",r)||u.getContext("experimental-webgl",r)}catch(e){throw new Error("WebGL not supported")}}if(!this._gl){throw new Error("WebGL not supported")}this._onCanvasFocus=function(){s.onCanvasFocusObservable.notifyObservers(s)};this._onCanvasBlur=function(){s.onCanvasBlurObservable.notifyObservers(s)};u.addEventListener("focus",this._onCanvasFocus);u.addEventListener("blur",this._onCanvasBlur);this._onBlur=function(){if(s.disablePerformanceMonitorInBackground){s._performanceMonitor.disable()}s._windowIsBackground=true};this._onFocus=function(){if(s.disablePerformanceMonitorInBackground){s._performanceMonitor.enable()}s._windowIsBackground=false};this._onCanvasPointerOut=function(e){s.onCanvasPointerOutObservable.notifyObservers(e)};window.addEventListener("blur",this._onBlur);window.addEventListener("focus",this._onFocus);u.addEventListener("pointerout",this._onCanvasPointerOut);if(!this._doNotHandleContextLost){this._onContextLost=function(t){t.preventDefault();s._contextWasLost=true;e.Tools.Warn("WebGL context lost.");s.onContextLostObservable.notifyObservers(s)};this._onContextRestored=function(t){setTimeout(function(){s._initGLContext();s._rebuildEffects();s._rebuildInternalTextures();s._rebuildBuffers();s.wipeCaches(true);e.Tools.Warn("WebGL context successfully restored.");s.onContextRestoredObservable.notifyObservers(s);s._contextWasLost=false},0)};u.addEventListener("webglcontextlost",this._onContextLost,false);u.addEventListener("webglcontextrestored",this._onContextRestored,false)}}else{this._gl=t;this._renderingCanvas=this._gl.canvas;if(this._gl.renderbufferStorageMultisample){this._webGLVersion=2}r.stencil=this._gl.getContextAttributes().stencil}var E=r.limitDeviceRatio||window.devicePixelRatio||1;this._hardwareScalingLevel=n?1/Math.min(E,window.devicePixelRatio||1):1;this.resize();this._isStencilEnable=r.stencil?true:false;this._initGLContext();if(u){this._onFullscreenChange=function(){if(document.fullscreen!==undefined){s.isFullscreen=document.fullscreen}else if(document.mozFullScreen!==undefined){s.isFullscreen=document.mozFullScreen}else if(document.webkitIsFullScreen!==undefined){s.isFullscreen=document.webkitIsFullScreen}else if(document.msIsFullScreen!==undefined){s.isFullscreen=document.msIsFullScreen}if(s.isFullscreen&&s._pointerLockRequested&&u){u.requestPointerLock=u.requestPointerLock||u.msRequestPointerLock||u.mozRequestPointerLock||u.webkitRequestPointerLock;if(u.requestPointerLock){u.requestPointerLock()}}};document.addEventListener("fullscreenchange",this._onFullscreenChange,false);document.addEventListener("mozfullscreenchange",this._onFullscreenChange,false);document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,false);document.addEventListener("msfullscreenchange",this._onFullscreenChange,false);this._onPointerLockChange=function(){s.isPointerLock=document.mozPointerLockElement===u||document.webkitPointerLockElement===u||document.msPointerLockElement===u||document.pointerLockElement===u};document.addEventListener("pointerlockchange",this._onPointerLockChange,false);document.addEventListener("mspointerlockchange",this._onPointerLockChange,false);document.addEventListener("mozpointerlockchange",this._onPointerLockChange,false);document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,false);this._onVRDisplayPointerRestricted=function(){if(u){u.requestPointerLock()}};this._onVRDisplayPointerUnrestricted=function(){document.exitPointerLock()};window.addEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted,false);window.addEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted,false)}if(r.audioEngine&&e.AudioEngine&&!o.audioEngine){o.audioEngine=new e.AudioEngine}for(var P=0;P<this._caps.maxVertexAttribs;P++){this._currentBufferPointers[P]=new a}this._linkTrackers(this._firstBoundInternalTextureTracker,this._lastBoundInternalTextureTracker);if(r.autoEnableWebVR){this.initWebVR()}this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);console.log("Babylon.js engine (v"+o.Version+") launched");this.enableOfflineSupport=e.Database!==undefined}Object.defineProperty(o,"LastCreatedEngine",{get:function(){if(o.Instances.length===0){return null}return o.Instances[o.Instances.length-1]},enumerable:true,configurable:true});Object.defineProperty(o,"LastCreatedScene",{get:function(){var e=o.LastCreatedEngine;if(!e){return null}if(e.scenes.length===0){return null}return e.scenes[e.scenes.length-1]},enumerable:true,configurable:true});o.MarkAllMaterialsAsDirty=function(e,t){for(var i=0;i<o.Instances.length;i++){var r=o.Instances[i];for(var n=0;n<r.scenes.length;n++){r.scenes[n].markAllMaterialsAsDirty(e,t)}}};Object.defineProperty(o,"NEVER",{get:function(){return o._NEVER},enumerable:true,configurable:true});Object.defineProperty(o,"ALWAYS",{get:function(){return o._ALWAYS},enumerable:true,configurable:true});Object.defineProperty(o,"LESS",{get:function(){return o._LESS},enumerable:true,configurable:true});Object.defineProperty(o,"EQUAL",{get:function(){return o._EQUAL},enumerable:true,configurable:true});Object.defineProperty(o,"LEQUAL",{get:function(){return o._LEQUAL},enumerable:true,configurable:true});Object.defineProperty(o,"GREATER",{get:function(){return o._GREATER},enumerable:true,configurable:true});Object.defineProperty(o,"GEQUAL",{get:function(){return o._GEQUAL},enumerable:true,configurable:true});Object.defineProperty(o,"NOTEQUAL",{get:function(){return o._NOTEQUAL},enumerable:true,configurable:true});Object.defineProperty(o,"KEEP",{get:function(){return o._KEEP},enumerable:true,configurable:true});Object.defineProperty(o,"REPLACE",{get:function(){return o._REPLACE},enumerable:true,configurable:true});Object.defineProperty(o,"INCR",{get:function(){return o._INCR},enumerable:true,configurable:true});Object.defineProperty(o,"DECR",{get:function(){return o._DECR},enumerable:true,configurable:true});Object.defineProperty(o,"INVERT",{get:function(){return o._INVERT},enumerable:true,configurable:true});Object.defineProperty(o,"INCR_WRAP",{get:function(){return o._INCR_WRAP},enumerable:true,configurable:true});Object.defineProperty(o,"DECR_WRAP",{get:function(){return o._DECR_WRAP},enumerable:true,configurable:true});Object.defineProperty(o,"ALPHA_DISABLE",{get:function(){return o._ALPHA_DISABLE},enumerable:true,configurable:true});Object.defineProperty(o,"ALPHA_ONEONE",{get:function(){return o._ALPHA_ONEONE},enumerable:true,configurable:true});Object.defineProperty(o,"ALPHA_ADD",{get:function(){return o._ALPHA_ADD},enumerable:true,configurable:true});Object.defineProperty(o,"ALPHA_COMBINE",{get:function(){return o._ALPHA_COMBINE},enumerable:true,configurable:true});Object.defineProperty(o,"ALPHA_SUBTRACT",{get:function(){return o._ALPHA_SUBTRACT},enumerable:true,configurable:true});Object.defineProperty(o,"ALPHA_MULTIPLY",{get:function(){return o._ALPHA_MULTIPLY},enumerable:true,configurable:true});Object.defineProperty(o,"ALPHA_MAXIMIZED",{get:function(){return o._ALPHA_MAXIMIZED},enumerable:true,configurable:true});Object.defineProperty(o,"ALPHA_PREMULTIPLIED",{get:function(){return o._ALPHA_PREMULTIPLIED},enumerable:true,configurable:true});Object.defineProperty(o,"ALPHA_PREMULTIPLIED_PORTERDUFF",{get:function(){return o._ALPHA_PREMULTIPLIED_PORTERDUFF},enumerable:true,configurable:true});Object.defineProperty(o,"ALPHA_INTERPOLATE",{get:function(){return o._ALPHA_INTERPOLATE},enumerable:true,configurable:true});Object.defineProperty(o,"ALPHA_SCREENMODE",{get:function(){return o._ALPHA_SCREENMODE},enumerable:true,configurable:true});Object.defineProperty(o,"DELAYLOADSTATE_NONE",{get:function(){return o._DELAYLOADSTATE_NONE},enumerable:true,configurable:true});Object.defineProperty(o,"DELAYLOADSTATE_LOADED",{get:function(){return o._DELAYLOADSTATE_LOADED},enumerable:true,configurable:true});Object.defineProperty(o,"DELAYLOADSTATE_LOADING",{get:function(){return o._DELAYLOADSTATE_LOADING},enumerable:true,configurable:true});Object.defineProperty(o,"DELAYLOADSTATE_NOTLOADED",{get:function(){return o._DELAYLOADSTATE_NOTLOADED},enumerable:true,configurable:true});Object.defineProperty(o,"TEXTUREFORMAT_ALPHA",{get:function(){return o._TEXTUREFORMAT_ALPHA},enumerable:true,configurable:true});Object.defineProperty(o,"TEXTUREFORMAT_LUMINANCE",{get:function(){return o._TEXTUREFORMAT_LUMINANCE},enumerable:true,configurable:true});Object.defineProperty(o,"TEXTUREFORMAT_R32F",{get:function(){return o._TEXTUREFORMAT_R32F},enumerable:true,configurable:true});Object.defineProperty(o,"TEXTUREFORMAT_RG32F",{get:function(){return o._TEXTUREFORMAT_RG32F},enumerable:true,configurable:true});Object.defineProperty(o,"TEXTUREFORMAT_RGB32F",{get:function(){return o._TEXTUREFORMAT_RGB32F},enumerable:true,configurable:true});Object.defineProperty(o,"TEXTUREFORMAT_RGBA32F",{get:function(){return o._TEXTUREFORMAT_RGBA32F},enumerable:true,configurable:true});Object.defineProperty(o,"TEXTUREFORMAT_LUMINANCE_ALPHA",{get:function(){return o._TEXTUREFORMAT_LUMINANCE_ALPHA},enumerable:true,configurable:true});Object.defineProperty(o,"TEXTUREFORMAT_RGB",{get:function(){return o._TEXTUREFORMAT_RGB},enumerable:true,configurable:true});Object.defineProperty(o,"TEXTUREFORMAT_RGBA",{get:function(){return o._TEXTUREFORMAT_RGBA},enumerable:true,configurable:true});Object.defineProperty(o,"TEXTURETYPE_UNSIGNED_INT",{get:function(){return o._TEXTURETYPE_UNSIGNED_INT},enumerable:true,configurable:true});Object.defineProperty(o,"TEXTURETYPE_FLOAT",{get:function(){return o._TEXTURETYPE_FLOAT},enumerable:true,configurable:true});Object.defineProperty(o,"TEXTURETYPE_HALF_FLOAT",{get:function(){return o._TEXTURETYPE_HALF_FLOAT},enumerable:true,configurable:true});Object.defineProperty(o,"SCALEMODE_FLOOR",{get:function(){return o._SCALEMODE_FLOOR},enumerable:true,configurable:true});Object.defineProperty(o,"SCALEMODE_NEAREST",{get:function(){return o._SCALEMODE_NEAREST},enumerable:true,configurable:true});Object.defineProperty(o,"SCALEMODE_CEILING",{get:function(){return o._SCALEMODE_CEILING},enumerable:true,configurable:true});Object.defineProperty(o,"Version",{get:function(){return"3.2.0-beta.4"},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"isInVRExclusivePointerMode",{get:function(){return this._vrExclusivePointerMode},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"supportsUniformBuffers",{get:function(){return this.webGLVersion>1&&!this.disableUniformBuffers},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"needPOTTextures",{get:function(){return this._webGLVersion<2||this.forcePOTTextures},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"performanceMonitor",{get:function(){return this._performanceMonitor},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"texturesSupported",{get:function(){return this._texturesSupported},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"currentViewport",{get:function(){return this._cachedViewport},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"emptyTexture",{get:function(){if(!this._emptyTexture){this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,o.TEXTUREFORMAT_RGBA,false,false,e.Texture.NEAREST_SAMPLINGMODE)}return this._emptyTexture},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"emptyTexture3D",{get:function(){if(!this._emptyTexture3D){this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,o.TEXTUREFORMAT_RGBA,false,false,e.Texture.NEAREST_SAMPLINGMODE)}return this._emptyTexture3D},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"emptyCubeTexture",{get:function(){if(!this._emptyCubeTexture){var t=new Uint8Array(4);var i=[t,t,t,t,t,t];this._emptyCubeTexture=this.createRawCubeTexture(i,1,o.TEXTUREFORMAT_RGBA,o.TEXTURETYPE_UNSIGNED_INT,false,false,e.Texture.NEAREST_SAMPLINGMODE)}return this._emptyCubeTexture},enumerable:true,configurable:true});o.prototype._rebuildInternalTextures=function(){var e=this._internalTexturesCache.slice();for(var t=0,i=e;t<i.length;t++){var r=i[t];r._rebuild()}};o.prototype._rebuildEffects=function(){for(var t in this._compiledEffects){var i=this._compiledEffects[t];i._prepareEffect()}e.Effect.ResetCache()};o.prototype._rebuildBuffers=function(){for(var e=0,t=this.scenes;e<t.length;e++){var i=t[e];i.resetCachedMaterial();i._rebuildGeometries();i._rebuildTextures()}for(var r=0,n=this._uniformBuffers;r<n.length;r++){var o=n[r];o._rebuild()}};o.prototype._initGLContext=function(){this._caps=new h;this._caps.maxTexturesImageUnits=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);this._caps.maxCombinedTexturesImageUnits=this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS);this._caps.maxVertexTextureImageUnits=this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this._caps.maxTextureSize=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE);this._caps.maxCubemapTextureSize=this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE);this._caps.maxRenderTextureSize=this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE);this._caps.maxVertexAttribs=this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS);this._caps.maxVaryingVectors=this._gl.getParameter(this._gl.MAX_VARYING_VECTORS);this._caps.maxFragmentUniformVectors=this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS);this._caps.maxVertexUniformVectors=this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS);this._glVersion=this._gl.getParameter(this._gl.VERSION);var e=this._gl.getExtension("WEBGL_debug_renderer_info");if(e!=null){this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL);this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)}if(!this._glVendor){this._glVendor="Unknown vendor"}if(!this._glRenderer){this._glRenderer="Unknown renderer"}this._gl.HALF_FLOAT_OES=36193;if(this._gl.RGBA16F!==34842){this._gl.RGBA16F=34842}if(this._gl.RGBA32F!==34836){this._gl.RGBA32F=34836}if(this._gl.DEPTH24_STENCIL8!==35056){this._gl.DEPTH24_STENCIL8=35056}this._caps.standardDerivatives=this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null;this._caps.astc=this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc");this._caps.s3tc=this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");this._caps.pvrtc=this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");this._caps.etc1=this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1");this._caps.etc2=this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0");this._caps.textureAnisotropicFilterExtension=this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic");this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0;this._caps.uintIndices=this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null;this._caps.fragmentDepthSupported=this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null;this._caps.highPrecisionShaderSupported=true;this._caps.timerQuery=this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query");if(this._caps.timerQuery){if(this._webGLVersion===1){this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)}this._caps.canUseTimestampForTimerQuery=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)>0}this._caps.colorBufferFloat=this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float");this._caps.textureFloat=this._webGLVersion>1||this._gl.getExtension("OES_texture_float")?true:false;this._caps.textureFloatLinearFiltering=this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")?true:false;this._caps.textureFloatRender=this._caps.textureFloat&&this._canRenderToFloatFramebuffer()?true:false;this._caps.textureHalfFloat=this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")?true:false;this._caps.textureHalfFloatLinearFiltering=this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")?true:false;if(this._webGLVersion>1){this._gl.HALF_FLOAT_OES=5131}this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer();this._caps.textureLOD=this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")?true:false;if(this._webGLVersion>1){this._caps.drawBuffersExtension=true}else{var t=this._gl.getExtension("WEBGL_draw_buffers");if(t!==null){this._caps.drawBuffersExtension=true;this._gl.drawBuffers=t.drawBuffersWEBGL.bind(t);this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(var i=0;i<16;i++){this._gl["COLOR_ATTACHMENT"+i+"_WEBGL"]=t["COLOR_ATTACHMENT"+i+"_WEBGL"]}}else{this._caps.drawBuffersExtension=false}}if(this._webGLVersion>1){this._caps.depthTextureExtension=true}else{var r=this._gl.getExtension("WEBGL_depth_texture");if(r!=null){this._caps.depthTextureExtension=true;this._gl.UNSIGNED_INT_24_8=r.UNSIGNED_INT_24_8_WEBGL}}if(this._webGLVersion>1){this._caps.vertexArrayObject=true}else{var n=this._gl.getExtension("OES_vertex_array_object");if(n!=null){this._caps.vertexArrayObject=true;this._gl.createVertexArray=n.createVertexArrayOES.bind(n);this._gl.bindVertexArray=n.bindVertexArrayOES.bind(n);this._gl.deleteVertexArray=n.deleteVertexArrayOES.bind(n)}else{this._caps.vertexArrayObject=false}}if(this._webGLVersion>1){this._caps.instancedArrays=true}else{var o=this._gl.getExtension("ANGLE_instanced_arrays");if(o!=null){
this._caps.instancedArrays=true;this._gl.drawArraysInstanced=o.drawArraysInstancedANGLE.bind(o);this._gl.drawElementsInstanced=o.drawElementsInstancedANGLE.bind(o);this._gl.vertexAttribDivisor=o.vertexAttribDivisorANGLE.bind(o)}else{this._caps.instancedArrays=false}}if(this._caps.astc)this.texturesSupported.push("-astc.ktx");if(this._caps.s3tc)this.texturesSupported.push("-dxt.ktx");if(this._caps.pvrtc)this.texturesSupported.push("-pvrtc.ktx");if(this._caps.etc2)this.texturesSupported.push("-etc2.ktx");if(this._caps.etc1)this.texturesSupported.push("-etc1.ktx");if(this._gl.getShaderPrecisionFormat){var s=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);if(s){this._caps.highPrecisionShaderSupported=s.precision!==0}}this.setDepthBuffer(true);this.setDepthFunctionToLessOrEqual();this.setDepthWrite(true);this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(var a=0;a<this._maxSimultaneousTextures;a++){this._nextFreeTextureSlots.push(a)}};Object.defineProperty(o.prototype,"webGLVersion",{get:function(){return this._webGLVersion},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"isStencilEnable",{get:function(){return this._isStencilEnable},enumerable:true,configurable:true});o.prototype._prepareWorkingCanvas=function(){if(this._workingCanvas){return}this._workingCanvas=document.createElement("canvas");var e=this._workingCanvas.getContext("2d");if(e){this._workingContext=e}};o.prototype.resetTextureCache=function(){for(var e in this._boundTexturesCache){var t=this._boundTexturesCache[e];if(t){this._removeDesignatedSlot(t)}this._boundTexturesCache[e]=null}if(!this.disableTextureBindingOptimization){this._nextFreeTextureSlots=[];for(var i=0;i<this._maxSimultaneousTextures;i++){this._nextFreeTextureSlots.push(i)}}this._currentTextureChannel=-1};o.prototype.isDeterministicLockStep=function(){return this._deterministicLockstep};o.prototype.getLockstepMaxSteps=function(){return this._lockstepMaxSteps};o.prototype.getGlInfo=function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}};o.prototype.getAspectRatio=function(e,t){if(t===void 0){t=false}var i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)};o.prototype.getRenderWidth=function(e){if(e===void 0){e=false}if(!e&&this._currentRenderTarget){return this._currentRenderTarget.width}return this._gl.drawingBufferWidth};o.prototype.getRenderHeight=function(e){if(e===void 0){e=false}if(!e&&this._currentRenderTarget){return this._currentRenderTarget.height}return this._gl.drawingBufferHeight};o.prototype.getRenderingCanvas=function(){return this._renderingCanvas};o.prototype.getRenderingCanvasClientRect=function(){if(!this._renderingCanvas){return null}return this._renderingCanvas.getBoundingClientRect()};o.prototype.setHardwareScalingLevel=function(e){this._hardwareScalingLevel=e;this.resize()};o.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel};o.prototype.getLoadedTexturesCache=function(){return this._internalTexturesCache};o.prototype.getCaps=function(){return this._caps};Object.defineProperty(o.prototype,"drawCalls",{get:function(){e.Tools.Warn("drawCalls is deprecated. Please use SceneInstrumentation class");return 0},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"drawCallsPerfCounter",{get:function(){e.Tools.Warn("drawCallsPerfCounter is deprecated. Please use SceneInstrumentation class");return null},enumerable:true,configurable:true});o.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc};o.prototype.setDepthFunction=function(e){this._depthCullingState.depthFunc=e};o.prototype.setDepthFunctionToGreater=function(){this._depthCullingState.depthFunc=this._gl.GREATER};o.prototype.setDepthFunctionToGreaterOrEqual=function(){this._depthCullingState.depthFunc=this._gl.GEQUAL};o.prototype.setDepthFunctionToLess=function(){this._depthCullingState.depthFunc=this._gl.LESS};o.prototype.setDepthFunctionToLessOrEqual=function(){this._depthCullingState.depthFunc=this._gl.LEQUAL};o.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest};o.prototype.setStencilBuffer=function(e){this._stencilState.stencilTest=e};o.prototype.getStencilMask=function(){return this._stencilState.stencilMask};o.prototype.setStencilMask=function(e){this._stencilState.stencilMask=e};o.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc};o.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef};o.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask};o.prototype.setStencilFunction=function(e){this._stencilState.stencilFunc=e};o.prototype.setStencilFunctionReference=function(e){this._stencilState.stencilFuncRef=e};o.prototype.setStencilFunctionMask=function(e){this._stencilState.stencilFuncMask=e};o.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail};o.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail};o.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass};o.prototype.setStencilOperationFail=function(e){this._stencilState.stencilOpStencilFail=e};o.prototype.setStencilOperationDepthFail=function(e){this._stencilState.stencilOpDepthFail=e};o.prototype.setStencilOperationPass=function(e){this._stencilState.stencilOpStencilDepthPass=e};o.prototype.setDitheringState=function(e){if(e){this._gl.enable(this._gl.DITHER)}else{this._gl.disable(this._gl.DITHER)}};o.prototype.setRasterizerState=function(e){if(e){this._gl.disable(this._gl.RASTERIZER_DISCARD)}else{this._gl.enable(this._gl.RASTERIZER_DISCARD)}};o.prototype.stopRenderLoop=function(e){if(!e){this._activeRenderLoops=[];return}var t=this._activeRenderLoops.indexOf(e);if(t>=0){this._activeRenderLoops.splice(t,1)}};o.prototype._renderLoop=function(){if(!this._contextWasLost){var t=true;if(!this.renderEvenInBackground&&this._windowIsBackground){t=false}if(t){this.beginFrame();for(var i=0;i<this._activeRenderLoops.length;i++){var r=this._activeRenderLoops[i];r()}this.endFrame()}}if(this._activeRenderLoops.length>0){var n=null;if(this._vrDisplay&&this._vrDisplay.isPresenting)n=this._vrDisplay;this._frameHandler=e.Tools.QueueNewFrame(this._bindedRenderFunction,n)}else{this._renderingQueueLaunched=false}};o.prototype.runRenderLoop=function(t){if(this._activeRenderLoops.indexOf(t)!==-1){return}this._activeRenderLoops.push(t);if(!this._renderingQueueLaunched){this._renderingQueueLaunched=true;this._bindedRenderFunction=this._renderLoop.bind(this);this._frameHandler=e.Tools.QueueNewFrame(this._bindedRenderFunction)}};o.prototype.switchFullscreen=function(t){if(this.isFullscreen){e.Tools.ExitFullscreen()}else{this._pointerLockRequested=t;if(this._renderingCanvas){e.Tools.RequestFullscreen(this._renderingCanvas)}}};o.prototype.clear=function(e,t,i,r){if(r===void 0){r=false}this.applyStates();var n=0;if(t&&e){this._gl.clearColor(e.r,e.g,e.b,e.a!==undefined?e.a:1);n|=this._gl.COLOR_BUFFER_BIT}if(i){this._gl.clearDepth(1);n|=this._gl.DEPTH_BUFFER_BIT}if(r){this._gl.clearStencil(0);n|=this._gl.STENCIL_BUFFER_BIT}this._gl.clear(n)};o.prototype.scissorClear=function(e,t,i,r,n){var o=this._gl;var s=o.getParameter(o.SCISSOR_TEST);var a=o.getParameter(o.SCISSOR_BOX);o.enable(o.SCISSOR_TEST);o.scissor(e,t,i,r);this.clear(n,true,true,true);o.scissor(a[0],a[1],a[2],a[3]);if(s===true){o.enable(o.SCISSOR_TEST)}else{o.disable(o.SCISSOR_TEST)}};o.prototype.setViewport=function(e,t,i){var r=t||this.getRenderWidth();var n=i||this.getRenderHeight();var o=e.x||0;var s=e.y||0;this._cachedViewport=e;this._gl.viewport(o*r,s*n,r*e.width,n*e.height)};o.prototype.setDirectViewport=function(e,t,i,r){var n=this._cachedViewport;this._cachedViewport=null;this._gl.viewport(e,t,i,r);return n};o.prototype.beginFrame=function(){this.onBeginFrameObservable.notifyObservers(this);this._measureFps()};o.prototype.endFrame=function(){if(this._badOS){this.flushFramebuffer()}if(this._vrDisplay&&this._vrDisplay.isPresenting){this._vrDisplay.submitFrame()}this.onEndFrameObservable.notifyObservers(this)};o.prototype.resize=function(){if(!(this._vrDisplay&&this._vrDisplay.isPresenting)){var e=this._renderingCanvas?this._renderingCanvas.clientWidth:window.innerWidth;var t=this._renderingCanvas?this._renderingCanvas.clientHeight:window.innerHeight;this.setSize(e/this._hardwareScalingLevel,t/this._hardwareScalingLevel)}};o.prototype.setSize=function(e,t){if(!this._renderingCanvas){return}if(this._renderingCanvas.width===e&&this._renderingCanvas.height===t){return}this._renderingCanvas.width=e;this._renderingCanvas.height=t;for(var i=0;i<this.scenes.length;i++){var r=this.scenes[i];for(var n=0;n<r.cameras.length;n++){var o=r.cameras[n];o._currentRenderId=0}}if(this.onResizeObservable.hasObservers){this.onResizeObservable.notifyObservers(this)}};o.prototype.isVRDevicePresent=function(){return!!this._vrDisplay};o.prototype.getVRDevice=function(){return this._vrDisplay};o.prototype.initWebVR=function(){this.initWebVRAsync();return this.onVRDisplayChangedObservable};o.prototype.initWebVRAsync=function(){var t=this;var i=function(){var e={vrDisplay:t._vrDisplay,vrSupported:t._vrSupported};t.onVRDisplayChangedObservable.notifyObservers(e);t._webVRInitPromise=new Promise(function(t){t(e)})};if(!this._onVrDisplayConnect){this._onVrDisplayConnect=function(e){t._vrDisplay=e.display;i()};this._onVrDisplayDisconnect=function(){t._vrDisplay.cancelAnimationFrame(t._frameHandler);t._vrDisplay=undefined;t._frameHandler=e.Tools.QueueNewFrame(t._bindedRenderFunction);i()};this._onVrDisplayPresentChange=function(){t._vrExclusivePointerMode=t._vrDisplay&&t._vrDisplay.isPresenting};window.addEventListener("vrdisplayconnect",this._onVrDisplayConnect);window.addEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect);window.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange)}this._webVRInitPromise=this._webVRInitPromise||this._getVRDisplaysAsync();this._webVRInitPromise.then(i);return this._webVRInitPromise};o.prototype.enableVR=function(){var e=this;if(this._vrDisplay&&!this._vrDisplay.isPresenting){var t=function(){e.onVRRequestPresentComplete.notifyObservers(true);e._onVRFullScreenTriggered()};var i=function(){e.onVRRequestPresentComplete.notifyObservers(false)};this.onVRRequestPresentStart.notifyObservers(this);this._vrDisplay.requestPresent([{source:this.getRenderingCanvas()}]).then(t).catch(i)}};o.prototype.disableVR=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting){this._vrDisplay.exitPresent().then(this._onVRFullScreenTriggered).catch(this._onVRFullScreenTriggered)}};o.prototype._getVRDisplaysAsync=function(){var e=this;return new Promise(function(t,i){if(navigator.getVRDisplays){navigator.getVRDisplays().then(function(i){e._vrSupported=true;e._vrDisplay=i[0];t({vrDisplay:e._vrDisplay,vrSupported:e._vrSupported})})}else{e._vrDisplay=undefined;e._vrSupported=false;t({vrDisplay:e._vrDisplay,vrSupported:e._vrSupported})}})};o.prototype.bindFramebuffer=function(e,t,i,r,n,o){if(this._currentRenderTarget){this.unBindFramebuffer(this._currentRenderTarget)}this._currentRenderTarget=e;this.bindUnboundFramebuffer(e._MSAAFramebuffer?e._MSAAFramebuffer:e._framebuffer);var s=this._gl;if(e.isCube){if(t===undefined){t=0}s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+t,e._webGLTexture,0);if(o){if(o._generateStencilBuffer){s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.TEXTURE_CUBE_MAP_POSITIVE_X+t,o._webGLTexture,0)}else{s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.TEXTURE_CUBE_MAP_POSITIVE_X+t,o._webGLTexture,0)}}}if(this._cachedViewport&&!n){this.setViewport(this._cachedViewport,i,r)}else{s.viewport(0,0,i||e.width,r||e.height)}this.wipeCaches()};o.prototype.bindUnboundFramebuffer=function(e){if(this._currentFramebuffer!==e){this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e);this._currentFramebuffer=e}};o.prototype.unBindFramebuffer=function(e,t,i){if(t===void 0){t=false}this._currentRenderTarget=null;var r=this._gl;if(e._MSAAFramebuffer){r.bindFramebuffer(r.READ_FRAMEBUFFER,e._MSAAFramebuffer);r.bindFramebuffer(r.DRAW_FRAMEBUFFER,e._framebuffer);r.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,r.COLOR_BUFFER_BIT,r.NEAREST)}if(e.generateMipMaps&&!t&&!e.isCube){this._bindTextureDirectly(r.TEXTURE_2D,e,true);r.generateMipmap(r.TEXTURE_2D);this._bindTextureDirectly(r.TEXTURE_2D,null)}if(i){if(e._MSAAFramebuffer){this.bindUnboundFramebuffer(e._framebuffer)}i()}this.bindUnboundFramebuffer(null)};o.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t,i){if(t===void 0){t=false}this._currentRenderTarget=null;var r=this._gl;if(e[0]._MSAAFramebuffer){r.bindFramebuffer(r.READ_FRAMEBUFFER,e[0]._MSAAFramebuffer);r.bindFramebuffer(r.DRAW_FRAMEBUFFER,e[0]._framebuffer);var n=e[0]._attachments;if(!n){n=new Array(e.length);e[0]._attachments=n}for(var o=0;o<e.length;o++){var s=e[o];for(var a=0;a<n.length;a++){n[a]=r.NONE}n[o]=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+o:"COLOR_ATTACHMENT"+o+"_WEBGL"];r.readBuffer(n[o]);r.drawBuffers(n);r.blitFramebuffer(0,0,s.width,s.height,0,0,s.width,s.height,r.COLOR_BUFFER_BIT,r.NEAREST)}for(var o=0;o<n.length;o++){n[o]=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+o:"COLOR_ATTACHMENT"+o+"_WEBGL"]}r.drawBuffers(n)}for(var o=0;o<e.length;o++){var s=e[o];if(s.generateMipMaps&&!t&&!s.isCube){this._bindTextureDirectly(r.TEXTURE_2D,s);r.generateMipmap(r.TEXTURE_2D);this._bindTextureDirectly(r.TEXTURE_2D,null)}}if(i){if(e[0]._MSAAFramebuffer){this.bindUnboundFramebuffer(e[0]._framebuffer)}i()}this.bindUnboundFramebuffer(null)};o.prototype.generateMipMapsForCubemap=function(e){if(e.generateMipMaps){var t=this._gl;this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,e,true);t.generateMipmap(t.TEXTURE_CUBE_MAP);this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,null)}};o.prototype.flushFramebuffer=function(){this._gl.flush()};o.prototype.restoreDefaultFramebuffer=function(){if(this._currentRenderTarget){this.unBindFramebuffer(this._currentRenderTarget)}else{this.bindUnboundFramebuffer(null)}if(this._cachedViewport){this.setViewport(this._cachedViewport)}this.wipeCaches()};o.prototype.createUniformBuffer=function(e){var t=this._gl.createBuffer();if(!t){throw new Error("Unable to create uniform buffer")}this.bindUniformBuffer(t);if(e instanceof Float32Array){this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW)}else{this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW)}this.bindUniformBuffer(null);t.references=1;return t};o.prototype.createDynamicUniformBuffer=function(e){var t=this._gl.createBuffer();if(!t){throw new Error("Unable to create dynamic uniform buffer")}this.bindUniformBuffer(t);if(e instanceof Float32Array){this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW)}else{this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW)}this.bindUniformBuffer(null);t.references=1;return t};o.prototype.updateUniformBuffer=function(e,t,i,r){this.bindUniformBuffer(e);if(i===undefined){i=0}if(r===undefined){if(t instanceof Float32Array){this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,t)}else{this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,new Float32Array(t))}}else{if(t instanceof Float32Array){this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(i,i+r))}else{this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(i,i+r))}}this.bindUniformBuffer(null)};o.prototype._resetVertexBufferBinding=function(){this.bindArrayBuffer(null);this._cachedVertexBuffers=null};o.prototype.createVertexBuffer=function(e){var t=this._gl.createBuffer();if(!t){throw new Error("Unable to create vertex buffer")}this.bindArrayBuffer(t);if(e instanceof Array){this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW)}else{this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.STATIC_DRAW)}this._resetVertexBufferBinding();t.references=1;return t};o.prototype.createDynamicVertexBuffer=function(e){var t=this._gl.createBuffer();if(!t){throw new Error("Unable to create dynamic vertex buffer")}this.bindArrayBuffer(t);if(e instanceof Array){this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW)}else{this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW)}this._resetVertexBufferBinding();t.references=1;return t};o.prototype.updateDynamicIndexBuffer=function(e,t,i){if(i===void 0){i=0}this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null;this.bindIndexBuffer(e);var r;if(t instanceof Uint16Array||t instanceof Uint32Array){r=t}else{r=e.is32Bits?new Uint32Array(t):new Uint16Array(t)}this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,r,this._gl.DYNAMIC_DRAW);this._resetIndexBufferBinding()};o.prototype.updateDynamicVertexBuffer=function(e,t,i,r){this.bindArrayBuffer(e);if(i===undefined){i=0}if(r===undefined){if(t instanceof Array){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(t))}else{this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,t)}}else{if(t instanceof Array){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t).subarray(i,i+r))}else{if(t instanceof ArrayBuffer){t=new Uint8Array(t,i,r)}else{t=new Uint8Array(t.buffer,t.byteOffset+i,r)}this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)}}this._resetVertexBufferBinding()};o.prototype._resetIndexBufferBinding=function(){this.bindIndexBuffer(null);this._cachedIndexBuffer=null};o.prototype.createIndexBuffer=function(e,t){var i=this._gl.createBuffer();if(!i){throw new Error("Unable to create index buffer")}this.bindIndexBuffer(i);var r;var n=false;if(e instanceof Uint16Array){r=e}else{if(this._caps.uintIndices){if(e instanceof Uint32Array){r=e;n=true}else{for(var o=0;o<e.length;o++){if(e[o]>65535){n=true;break}}r=n?new Uint32Array(e):new Uint16Array(e)}}else{r=new Uint16Array(e)}}this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,r,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW);this._resetIndexBufferBinding();i.references=1;i.is32Bits=n;return i};o.prototype.bindArrayBuffer=function(e){if(!this._vaoRecordInProgress){this._unbindVertexArrayObject()}this.bindBuffer(e,this._gl.ARRAY_BUFFER)};o.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e)};o.prototype.bindUniformBufferBase=function(e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e)};o.prototype.bindUniformBlock=function(e,t,i){var r=this._gl.getUniformBlockIndex(e,t);this._gl.uniformBlockBinding(e,r,i)};o.prototype.bindIndexBuffer=function(e){if(!this._vaoRecordInProgress){this._unbindVertexArrayObject()}this.bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)};o.prototype.bindBuffer=function(e,t){if(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e){this._gl.bindBuffer(t,e);this._currentBoundBuffer[t]=e}};o.prototype.updateArrayBuffer=function(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)};o.prototype._vertexAttribPointer=function(e,t,i,r,n,o,s){var a=this._currentBufferPointers[t];var u=false;if(!a.active){u=true;a.active=true;a.index=t;a.size=i;a.type=r;a.normalized=n;a.stride=o;a.offset=s;a.buffer=e}else{if(a.buffer!==e){a.buffer=e;u=true}if(a.size!==i){a.size=i;u=true}if(a.type!==r){a.type=r;u=true}if(a.normalized!==n){a.normalized=n;u=true}if(a.stride!==o){a.stride=o;u=true}if(a.offset!==s){a.offset=s;u=true}}if(u||this._vaoRecordInProgress){this.bindArrayBuffer(e);this._gl.vertexAttribPointer(t,i,r,n,o,s)}};o.prototype._bindIndexBufferWithCache=function(e){if(e==null){return}if(this._cachedIndexBuffer!==e){this._cachedIndexBuffer=e;this.bindIndexBuffer(e);this._uintIndicesCurrentlySet=e.is32Bits}};o.prototype._bindVertexBuffersAttributes=function(e,t){var i=t.getAttributesNames();if(!this._vaoRecordInProgress){this._unbindVertexArrayObject()}this.unbindAllAttributes();for(var r=0;r<i.length;r++){var n=t.getAttributeLocation(r);if(n>=0){var o=e[i[r]];if(!o){continue}this._gl.enableVertexAttribArray(n);if(!this._vaoRecordInProgress){this._vertexAttribArraysEnabled[n]=true}var s=o.getBuffer();if(s){this._vertexAttribPointer(s,n,o.getSize(),o.type,o.normalized,o.byteStride,o.byteOffset);if(o.getIsInstanced()){this._gl.vertexAttribDivisor(n,o.getInstanceDivisor());if(!this._vaoRecordInProgress){this._currentInstanceLocations.push(n);this._currentInstanceBuffers.push(s)}}}}}};o.prototype.recordVertexArrayObject=function(e,t,i){var r=this._gl.createVertexArray();this._vaoRecordInProgress=true;this._gl.bindVertexArray(r);this._mustWipeVertexAttributes=true;this._bindVertexBuffersAttributes(e,i);this.bindIndexBuffer(t);this._vaoRecordInProgress=false;this._gl.bindVertexArray(null);return r};o.prototype.bindVertexArrayObject=function(e,t){if(this._cachedVertexArrayObject!==e){this._cachedVertexArrayObject=e;this._gl.bindVertexArray(e);this._cachedVertexBuffers=null;this._cachedIndexBuffer=null;this._uintIndicesCurrentlySet=t!=null&&t.is32Bits;this._mustWipeVertexAttributes=true}};o.prototype.bindBuffersDirectly=function(e,t,i,r,n){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==n){this._cachedVertexBuffers=e;this._cachedEffectForVertexBuffers=n;var o=n.getAttributesCount();this._unbindVertexArrayObject();this.unbindAllAttributes();var s=0;for(var a=0;a<o;a++){if(a<i.length){var u=n.getAttributeLocation(a);if(u>=0){this._gl.enableVertexAttribArray(u);this._vertexAttribArraysEnabled[u]=true;this._vertexAttribPointer(e,u,i[a],this._gl.FLOAT,false,r,s)}s+=i[a]*4}}}this._bindIndexBufferWithCache(t)};o.prototype._unbindVertexArrayObject=function(){if(!this._cachedVertexArrayObject){return}this._cachedVertexArrayObject=null;this._gl.bindVertexArray(null)};o.prototype.bindBuffers=function(e,t,i){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i){this._cachedVertexBuffers=e;this._cachedEffectForVertexBuffers=i;this._bindVertexBuffersAttributes(e,i)}this._bindIndexBufferWithCache(t)};o.prototype.unbindInstanceAttributes=function(){var e;for(var t=0,i=this._currentInstanceLocations.length;t<i;t++){var r=this._currentInstanceBuffers[t];if(e!=r&&r.references){e=r;this.bindArrayBuffer(r)}var n=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(n,0)}this._currentInstanceBuffers.length=0;this._currentInstanceLocations.length=0};o.prototype.releaseVertexArrayObject=function(e){this._gl.deleteVertexArray(e)};o.prototype._releaseBuffer=function(e){e.references--;if(e.references===0){this._gl.deleteBuffer(e);return true}return false};o.prototype.createInstancesBuffer=function(e){var t=this._gl.createBuffer();if(!t){throw new Error("Unable to create instance buffer")}t.capacity=e;this.bindArrayBuffer(t);this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW);return t};o.prototype.deleteInstancesBuffer=function(e){this._gl.deleteBuffer(e)};o.prototype.updateAndBindInstancesBuffer=function(e,t,i){this.bindArrayBuffer(e);if(t){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)}if(i[0].index!==undefined){var r=0;for(var n=0;n<i.length;n++){var o=i[n];r+=o.attributeSize*4}for(var n=0;n<i.length;n++){var o=i[n];if(!this._vertexAttribArraysEnabled[o.index]){this._gl.enableVertexAttribArray(o.index);this._vertexAttribArraysEnabled[o.index]=true}this._vertexAttribPointer(e,o.index,o.attributeSize,o.attribyteType||this._gl.FLOAT,o.normalized||false,r,o.offset);this._gl.vertexAttribDivisor(o.index,1);this._currentInstanceLocations.push(o.index);this._currentInstanceBuffers.push(e)}}else{for(var s=0;s<4;s++){var a=i[s];if(!this._vertexAttribArraysEnabled[a]){this._gl.enableVertexAttribArray(a);this._vertexAttribArraysEnabled[a]=true}this._vertexAttribPointer(e,a,4,this._gl.FLOAT,false,64,s*16);this._gl.vertexAttribDivisor(a,1);this._currentInstanceLocations.push(a);this._currentInstanceBuffers.push(e)}}};o.prototype.applyStates=function(){this._depthCullingState.apply(this._gl);this._stencilState.apply(this._gl);this._alphaState.apply(this._gl)};o.prototype.draw=function(t,i,r,n){this.drawElementsType(t?e.Material.TriangleFillMode:e.Material.WireFrameFillMode,i,r,n)};o.prototype.drawPointClouds=function(t,i,r){this.drawArraysType(e.Material.PointFillMode,t,i,r)};o.prototype.drawUnIndexed=function(t,i,r,n){this.drawArraysType(t?e.Material.TriangleFillMode:e.Material.WireFrameFillMode,i,r,n)};o.prototype.drawElementsType=function(e,t,i,r){this.applyStates();this._drawCalls.addCount(1,false);var n=this._drawMode(e);var o=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT;var s=this._uintIndicesCurrentlySet?4:2;if(r){this._gl.drawElementsInstanced(n,i,o,t*s,r)}else{this._gl.drawElements(n,i,o,t*s)}};o.prototype.drawArraysType=function(e,t,i,r){this.applyStates();this._drawCalls.addCount(1,false);var n=this._drawMode(e);if(r){this._gl.drawArraysInstanced(n,t,i,r)}else{this._gl.drawArrays(n,t,i)}};o.prototype._drawMode=function(t){switch(t){case e.Material.TriangleFillMode:return this._gl.TRIANGLES;case e.Material.PointFillMode:return this._gl.POINTS;case e.Material.WireFrameFillMode:return this._gl.LINES;case e.Material.PointListDrawMode:return this._gl.POINTS;case e.Material.LineListDrawMode:return this._gl.LINES;case e.Material.LineLoopDrawMode:return this._gl.LINE_LOOP;case e.Material.LineStripDrawMode:return this._gl.LINE_STRIP;case e.Material.TriangleStripDrawMode:return this._gl.TRIANGLE_STRIP;case e.Material.TriangleFanDrawMode:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}};o.prototype._releaseEffect=function(e){if(this._compiledEffects[e._key]){delete this._compiledEffects[e._key];this._deleteProgram(e.getProgram())}};o.prototype._deleteProgram=function(e){if(e){e.__SPECTOR_rebuildProgram=null;if(e.transformFeedback){this.deleteTransformFeedback(e.transformFeedback);e.transformFeedback=null}this._gl.deleteProgram(e)}};o.prototype.createEffect=function(t,i,r,n,o,s,a,u,l){var c=t.vertexElement||t.vertex||t;var h=t.fragmentElement||t.fragment||t;var f=c+"+"+h+"@"+(o?o:i.defines);if(this._compiledEffects[f]){var d=this._compiledEffects[f];if(a&&d.isReady()){a(d)}return d}var p=new e.Effect(t,i,r,n,this,o,s,a,u,l);p._key=f;this._compiledEffects[f]=p;return p};o.prototype.createEffectForParticles=function(e,t,i,r,n,o,s){if(t===void 0){t=[]}if(i===void 0){i=[]}if(r===void 0){r=""}return this.createEffect({vertex:"particles",fragmentElement:e},["position","color","options"],["view","projection"].concat(t),["diffuseSampler"].concat(i),r,n,o,s)};o.prototype.createRawShaderProgram=function(e,t,r,n){if(n===void 0){n=null}r=r||this._gl;var o=i(r,e,"vertex");var s=i(r,t,"fragment");return this._createShaderProgram(o,s,r,n)};o.prototype.createShaderProgram=function(e,i,r,n,o){if(o===void 0){o=null}n=n||this._gl;this.onBeforeShaderCompilationObservable.notifyObservers(this);var s=this._webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"";var a=t(n,e,"vertex",r,s);var u=t(n,i,"fragment",r,s);var l=this._createShaderProgram(a,u,n,o);this.onAfterShaderCompilationObservable.notifyObservers(this);return l};o.prototype._createShaderProgram=function(e,t,i,r){if(r===void 0){r=null}var n=i.createProgram();if(!n){throw new Error("Unable to create program")}i.attachShader(n,e);i.attachShader(n,t);if(this.webGLVersion>1&&r){var o=this.createTransformFeedback();this.bindTransformFeedback(o);this.setTranformFeedbackVaryings(n,r);n.transformFeedback=o}i.linkProgram(n);if(this.webGLVersion>1&&r){this.bindTransformFeedback(null)}var s=i.getProgramParameter(n,i.LINK_STATUS);if(!s){i.validateProgram(n);var a=i.getProgramInfoLog(n);if(a){throw new Error(a)}}i.deleteShader(e);i.deleteShader(t);return n};o.prototype.getUniforms=function(e,t){var i=new Array;for(var r=0;r<t.length;r++){i.push(this._gl.getUniformLocation(e,t[r]))}return i};o.prototype.getAttributes=function(e,t){var i=[];for(var r=0;r<t.length;r++){try{i.push(this._gl.getAttribLocation(e,t[r]))}catch(e){i.push(-1)}}return i};o.prototype.enableEffect=function(e){if(!e){return}this.bindSamplers(e);this._currentEffect=e;if(e.onBind){e.onBind(e)}e.onBindObservable.notifyObservers(e)};o.prototype.setIntArray=function(e,t){if(!e)return;this._gl.uniform1iv(e,t)};o.prototype.setIntArray2=function(e,t){if(!e||t.length%2!==0)return;this._gl.uniform2iv(e,t)};o.prototype.setIntArray3=function(e,t){if(!e||t.length%3!==0)return;this._gl.uniform3iv(e,t)};o.prototype.setIntArray4=function(e,t){if(!e||t.length%4!==0)return;this._gl.uniform4iv(e,t)};o.prototype.setFloatArray=function(e,t){if(!e)return;this._gl.uniform1fv(e,t)};o.prototype.setFloatArray2=function(e,t){if(!e||t.length%2!==0)return;this._gl.uniform2fv(e,t)};o.prototype.setFloatArray3=function(e,t){if(!e||t.length%3!==0)return;this._gl.uniform3fv(e,t)};o.prototype.setFloatArray4=function(e,t){if(!e||t.length%4!==0)return;this._gl.uniform4fv(e,t)};o.prototype.setArray=function(e,t){if(!e)return;this._gl.uniform1fv(e,t)};o.prototype.setArray2=function(e,t){if(!e||t.length%2!==0)return;this._gl.uniform2fv(e,t)};o.prototype.setArray3=function(e,t){if(!e||t.length%3!==0)return;this._gl.uniform3fv(e,t)};o.prototype.setArray4=function(e,t){if(!e||t.length%4!==0)return;this._gl.uniform4fv(e,t)};o.prototype.setMatrices=function(e,t){if(!e)return;this._gl.uniformMatrix4fv(e,false,t)};o.prototype.setMatrix=function(e,t){if(!e)return;this._gl.uniformMatrix4fv(e,false,t.toArray())};o.prototype.setMatrix3x3=function(e,t){if(!e)return;this._gl.uniformMatrix3fv(e,false,t)};o.prototype.setMatrix2x2=function(e,t){if(!e)return;this._gl.uniformMatrix2fv(e,false,t)};o.prototype.setInt=function(e,t){if(!e)return;this._gl.uniform1i(e,t)};o.prototype.setFloat=function(e,t){if(!e)return;this._gl.uniform1f(e,t)};o.prototype.setFloat2=function(e,t,i){if(!e)return;this._gl.uniform2f(e,t,i)};o.prototype.setFloat3=function(e,t,i,r){if(!e)return;this._gl.uniform3f(e,t,i,r)};o.prototype.setBool=function(e,t){if(!e)return;this._gl.uniform1i(e,t)};o.prototype.setFloat4=function(e,t,i,r,n){if(!e)return;this._gl.uniform4f(e,t,i,r,n)};o.prototype.setColor3=function(e,t){if(!e)return;this._gl.uniform3f(e,t.r,t.g,t.b)};o.prototype.setColor4=function(e,t,i){if(!e)return;this._gl.uniform4f(e,t.r,t.g,t.b,i)};o.prototype.setDirectColor4=function(e,t){if(!e)return;this._gl.uniform4f(e,t.r,t.g,t.b,t.a)};o.prototype.setState=function(e,t,i,r){if(t===void 0){t=0}if(r===void 0){r=false}if(this._depthCullingState.cull!==e||i){this._depthCullingState.cull=e}var n=this.cullBackFaces?this._gl.BACK:this._gl.FRONT;if(this._depthCullingState.cullFace!==n||i){this._depthCullingState.cullFace=n}this.setZOffset(t);var o=r?this._gl.CW:this._gl.CCW;if(this._depthCullingState.frontFace!==o||i){this._depthCullingState.frontFace=o}};o.prototype.setZOffset=function(e){this._depthCullingState.zOffset=e};o.prototype.getZOffset=function(){return this._depthCullingState.zOffset};o.prototype.setDepthBuffer=function(e){this._depthCullingState.depthTest=e};o.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask};o.prototype.setDepthWrite=function(e){this._depthCullingState.depthMask=e};o.prototype.setColorWrite=function(e){this._gl.colorMask(e,e,e,e);this._colorWrite=e};o.prototype.getColorWrite=function(){return this._colorWrite};o.prototype.setAlphaConstants=function(e,t,i,r){this._alphaState.setAlphaBlendConstants(e,t,i,r)};o.prototype.setAlphaMode=function(e,t){if(t===void 0){t=false}if(this._alphaMode===e){return}switch(e){case o.ALPHA_DISABLE:this._alphaState.alphaBlend=false;break;case o.ALPHA_PREMULTIPLIED:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=true;break;case o.ALPHA_PREMULTIPLIED_PORTERDUFF:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA);this._alphaState.alphaBlend=true;break;case o.ALPHA_COMBINE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE)
;this._alphaState.alphaBlend=true;break;case o.ALPHA_ONEONE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE);this._alphaState.alphaBlend=true;break;case o.ALPHA_ADD:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE);this._alphaState.alphaBlend=true;break;case o.ALPHA_SUBTRACT:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=true;break;case o.ALPHA_MULTIPLY:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=true;break;case o.ALPHA_MAXIMIZED:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=true;break;case o.ALPHA_INTERPOLATE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA);this._alphaState.alphaBlend=true;break;case o.ALPHA_SCREENMODE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA);this._alphaState.alphaBlend=true;break}if(!t){this.setDepthWrite(e===o.ALPHA_DISABLE)}this._alphaMode=e};o.prototype.getAlphaMode=function(){return this._alphaMode};o.prototype.wipeCaches=function(e){if(this.preventCacheWipeBetweenFrames&&!e){return}this._currentEffect=null;if(e){this.resetTextureCache();this._currentProgram=null;this._stencilState.reset();this._depthCullingState.reset();this.setDepthFunctionToLessOrEqual();this._alphaState.reset()}this._resetVertexBufferBinding();this._cachedIndexBuffer=null;this._cachedEffectForVertexBuffers=null;this._unbindVertexArrayObject();this.bindIndexBuffer(null)};o.prototype.setTextureFormatToUse=function(e){for(var t=0,i=this.texturesSupported.length;t<i;t++){for(var r=0,n=e.length;r<n;r++){if(this._texturesSupported[t]===e[r].toLowerCase()){return this._textureFormatInUse=this._texturesSupported[t]}}}this._textureFormatInUse=null;return null};o.prototype._createTexture=function(){var e=this._gl.createTexture();if(!e){throw new Error("Unable to create texture")}return e};o.prototype.createTexture=function(t,i,r,n,o,s,a,u,l,c){var h=this;if(o===void 0){o=e.Texture.TRILINEAR_SAMPLINGMODE}if(s===void 0){s=null}if(a===void 0){a=null}if(u===void 0){u=null}if(l===void 0){l=null}if(c===void 0){c=null}var f=String(t);var d=f.substr(0,5)==="data:";var p=f.substr(0,5)==="blob:";var _=d&&f.indexOf("base64")!==-1;var m=l?l:new e.InternalTexture(this,e.InternalTexture.DATASOURCE_URL);var g=f.lastIndexOf(".");var v=g>0?f.substring(g).toLowerCase():"";var y=this.getCaps().s3tc&&v.indexOf(".dds")===0;var b=v.indexOf(".tga")===0;var x=false;if(this._textureFormatInUse&&!_&&!l){f=f.substring(0,g)+this._textureFormatInUse;x=true}if(n){n._addPendingData(m)}m.url=f;m.generateMipMaps=!i;m.samplingMode=o;m.invertY=r;if(!this._doNotHandleContextLost){m._buffer=u}var T=null;if(s&&!l){T=m.onLoadedObservable.add(s)}if(!l)this._internalTexturesCache.push(m);var E=function(s,l){if(n){n._removePendingData(m)}if(T){m.onLoadedObservable.remove(T)}if(x){h.createTexture(t,i,r,n,o,null,a,u,m)}else if(e.Tools.UseFallbackTexture){h.createTexture(e.Tools.fallbackTexture,i,r,n,o,null,a,u,m)}if(a){a(s||"Unknown error",l)}};var P=null;if(x||b||y){if(x){P=function(t){var s=new e.KhronosTextureContainer(t,1);h._prepareWebGLTexture(m,n,s.pixelWidth,s.pixelHeight,r,false,true,function(){s.uploadLevels(h._gl,!i);return false},o)}}else if(b){P=function(t){var s=new Uint8Array(t);var a=e.TGATools.GetTGAHeader(s);h._prepareWebGLTexture(m,n,a.width,a.height,r,i,false,function(){e.TGATools.UploadContent(h._gl,s);return false},o)}}else if(y){P=function(t){var s=e.DDSTools.GetDDSInfo(t);var a=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&!i&&s.width>>s.mipmapCount-1===1;h._prepareWebGLTexture(m,n,s.width,s.height,r,!a,s.isFourCC,function(){e.DDSTools.UploadDDSLevels(h,h._gl,t,s,a,1);return false},o)}}if(!u){this._loadFile(f,function(e){if(P){P(e)}},undefined,n?n.database:undefined,true,function(e,t){E("Unable to load "+(e?e.responseURL:f,t))})}else{if(P){P(u)}}}else{var A=function(t){if(p&&!h._doNotHandleContextLost){m._buffer=t}h._prepareWebGLTexture(m,n,t.width,t.height,r,i,false,function(i,r,o){var s=h._gl;var a=t.width===i&&t.height===r;var u=c?h._getInternalFormat(c):v===".jpg"?s.RGB:s.RGBA;if(a){s.texImage2D(s.TEXTURE_2D,0,u,u,s.UNSIGNED_BYTE,t);return false}var l=new e.InternalTexture(h,e.InternalTexture.DATASOURCE_TEMP);h._bindTextureDirectly(s.TEXTURE_2D,l,true);s.texImage2D(s.TEXTURE_2D,0,u,u,s.UNSIGNED_BYTE,t);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);h._rescaleTexture(l,m,n,u,function(){h._releaseTexture(l);h._bindTextureDirectly(s.TEXTURE_2D,m,true);o()});return true},o)};if(!d||_)if(u instanceof HTMLImageElement){A(u)}else{e.Tools.LoadImage(f,A,E,n?n.database:null)}else if(u instanceof Array||typeof u==="string"||u instanceof ArrayBuffer)e.Tools.LoadImage(u,A,E,n?n.database:null);else A(u)}return m};o.prototype._rescaleTexture=function(t,i,r,n,s){var a=this;var u=this.createRenderTargetTexture({width:i.width,height:i.height},{generateMipMaps:false,type:o.TEXTURETYPE_UNSIGNED_INT,samplingMode:e.Texture.BILINEAR_SAMPLINGMODE,generateDepthBuffer:false,generateStencilBuffer:false});if(!this._rescalePostProcess){this._rescalePostProcess=new e.PassPostProcess("rescale",1,null,e.Texture.BILINEAR_SAMPLINGMODE,this,false,o.TEXTURETYPE_UNSIGNED_INT)}this._rescalePostProcess.getEffect().executeWhenCompiled(function(){a._rescalePostProcess.onApply=function(e){e._bindTexture("textureSampler",t)};var e=r;if(!e){e=a.scenes[a.scenes.length-1]}e.postProcessManager.directRender([a._rescalePostProcess],u,true);a._bindTextureDirectly(a._gl.TEXTURE_2D,i,true);a._gl.copyTexImage2D(a._gl.TEXTURE_2D,0,n,0,0,i.width,i.height,0);a.unBindFramebuffer(u);a._releaseTexture(u);if(s){s()}})};o.prototype.updateRawTexture=function(e,t,i,r,n,s){if(n===void 0){n=null}if(s===void 0){s=o.TEXTURETYPE_UNSIGNED_INT}if(!e){return}var a=this._getRGBABufferInternalSizedFormat(s,i);var u=this._getInternalFormat(i);var l=this._getWebGLTextureType(s);this._bindTextureDirectly(this._gl.TEXTURE_2D,e,true);this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,r===undefined?1:r?1:0);if(!this._doNotHandleContextLost){e._bufferView=t;e.format=i;e.type=s;e.invertY=r;e._compression=n}if(e.width%4!==0){this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1)}if(n&&t){this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[n],e.width,e.height,0,t)}else{this._gl.texImage2D(this._gl.TEXTURE_2D,0,a,e.width,e.height,0,u,l,t)}if(e.generateMipMaps){this._gl.generateMipmap(this._gl.TEXTURE_2D)}this._bindTextureDirectly(this._gl.TEXTURE_2D,null);e.isReady=true};o.prototype.createRawTexture=function(t,i,n,s,a,u,l,c,h){if(c===void 0){c=null}if(h===void 0){h=o.TEXTURETYPE_UNSIGNED_INT}var f=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_RAW);f.baseWidth=i;f.baseHeight=n;f.width=i;f.height=n;f.format=s;f.generateMipMaps=a;f.samplingMode=l;f.invertY=u;f._compression=c;f.type=h;if(!this._doNotHandleContextLost){f._bufferView=t}this.updateRawTexture(f,t,s,u,c,h);this._bindTextureDirectly(this._gl.TEXTURE_2D,f,true);var d=r(l,a,this._gl);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min);if(a){this._gl.generateMipmap(this._gl.TEXTURE_2D)}this._bindTextureDirectly(this._gl.TEXTURE_2D,null);this._internalTexturesCache.push(f);return f};o.prototype.createDynamicTexture=function(t,i,r,n){var o=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_DYNAMIC);o.baseWidth=t;o.baseHeight=i;if(r){t=this.needPOTTextures?e.Tools.GetExponentOfTwo(t,this._caps.maxTextureSize):t;i=this.needPOTTextures?e.Tools.GetExponentOfTwo(i,this._caps.maxTextureSize):i}o.width=t;o.height=i;o.isReady=false;o.generateMipMaps=r;o.samplingMode=n;this.updateTextureSamplingMode(n,o);this._internalTexturesCache.push(o);return o};o.prototype.updateTextureSamplingMode=function(e,t){var i=r(e,t.generateMipMaps,this._gl);if(t.isCube){this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,t,true);this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_MAG_FILTER,i.mag);this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_MIN_FILTER,i.min);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}else if(t.is3D){this._bindTextureDirectly(this._gl.TEXTURE_3D,t,true);this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_MAG_FILTER,i.mag);this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_MIN_FILTER,i.min);this._bindTextureDirectly(this._gl.TEXTURE_3D,null)}else{this._bindTextureDirectly(this._gl.TEXTURE_2D,t,true);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,i.mag);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,i.min);this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}t.samplingMode=e};o.prototype.updateDynamicTexture=function(e,t,i,r,n){if(r===void 0){r=false}if(!e){return}this._bindTextureDirectly(this._gl.TEXTURE_2D,e,true);this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,i?1:0);if(r){this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1)}var o=n?this._getInternalFormat(n):this._gl.RGBA;this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,o,this._gl.UNSIGNED_BYTE,t);if(e.generateMipMaps){this._gl.generateMipmap(this._gl.TEXTURE_2D)}this._bindTextureDirectly(this._gl.TEXTURE_2D,null);if(r){this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0)}e.isReady=true};o.prototype.updateVideoTexture=function(e,t,i){if(!e||e._isDisabled){return}this._bindTextureDirectly(this._gl.TEXTURE_2D,e,true);this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,i?0:1);try{if(this._videoTextureSupported===undefined){this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t);if(this._gl.getError()!==0){this._videoTextureSupported=false}else{this._videoTextureSupported=true}}if(!this._videoTextureSupported){if(!e._workingCanvas){e._workingCanvas=document.createElement("canvas");var r=e._workingCanvas.getContext("2d");if(!r){throw new Error("Unable to get 2d context")}e._workingContext=r;e._workingCanvas.width=e.width;e._workingCanvas.height=e.height}e._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,e.width,e.height);this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e._workingCanvas)}else{this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t)}if(e.generateMipMaps){this._gl.generateMipmap(this._gl.TEXTURE_2D)}this._bindTextureDirectly(this._gl.TEXTURE_2D,null);e.isReady=true}catch(t){e._isDisabled=true}};o.prototype.updateTextureComparisonFunction=function(t,i){if(this.webGLVersion===1){e.Tools.Error("WebGL 1 does not support texture comparison.");return}var r=this._gl;if(t.isCube){this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,t,true);if(i===0){r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_COMPARE_FUNC,o.LEQUAL);r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_COMPARE_MODE,r.NONE)}else{r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_COMPARE_FUNC,i);r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}else{this._bindTextureDirectly(this._gl.TEXTURE_2D,t,true);if(i===0){r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_FUNC,o.LEQUAL);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_MODE,r.NONE)}else{r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_FUNC,i);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE)}this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}t._comparisonFunction=i};o.prototype._setupDepthStencilTexture=function(t,i,n,s,a){var u=i.width||i;var l=i.height||i;t.baseWidth=u;t.baseHeight=l;t.width=u;t.height=l;t.isReady=true;t.samples=1;t.generateMipMaps=false;t._generateDepthBuffer=true;t._generateStencilBuffer=n;t.samplingMode=s?e.Texture.BILINEAR_SAMPLINGMODE:e.Texture.NEAREST_SAMPLINGMODE;t.type=o.TEXTURETYPE_UNSIGNED_INT;t._comparisonFunction=a;var c=this._gl;var h=t.isCube?c.TEXTURE_CUBE_MAP:c.TEXTURE_2D;var f=r(t.samplingMode,false,c);c.texParameteri(h,c.TEXTURE_MAG_FILTER,f.mag);c.texParameteri(h,c.TEXTURE_MIN_FILTER,f.min);c.texParameteri(h,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(h,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);if(a===0){c.texParameteri(h,c.TEXTURE_COMPARE_FUNC,o.LEQUAL);c.texParameteri(h,c.TEXTURE_COMPARE_MODE,c.NONE)}else{c.texParameteri(h,c.TEXTURE_COMPARE_FUNC,a);c.texParameteri(h,c.TEXTURE_COMPARE_MODE,c.COMPARE_REF_TO_TEXTURE)}};o.prototype.createDepthStencilTexture=function(e,t){if(t.isCube){var i=e.width||e;return this._createDepthStencilCubeTexture(i,t)}else{return this._createDepthStencilTexture(e,t)}};o.prototype._createDepthStencilTexture=function(t,i){var r=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_DEPTHTEXTURE);if(!this._caps.depthTextureExtension){e.Tools.Error("Depth texture is not supported by your browser or hardware.");return r}var o=n({bilinearFiltering:false,comparisonFunction:0,generateStencil:false},i);var s=this._gl;this._bindTextureDirectly(s.TEXTURE_2D,r,true);this._setupDepthStencilTexture(r,t,o.generateStencil,o.bilinearFiltering,o.comparisonFunction);if(this.webGLVersion>1){if(o.generateStencil){s.texImage2D(s.TEXTURE_2D,0,s.DEPTH24_STENCIL8,r.width,r.height,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null)}else{s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_COMPONENT24,r.width,r.height,0,s.DEPTH_COMPONENT,s.UNSIGNED_INT,null)}}else{if(o.generateStencil){s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_STENCIL,r.width,r.height,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null)}else{s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_COMPONENT,r.width,r.height,0,s.DEPTH_COMPONENT,s.UNSIGNED_INT,null)}}this._bindTextureDirectly(s.TEXTURE_2D,null);return r};o.prototype._createDepthStencilCubeTexture=function(t,i){var r=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_UNKNOWN);r.isCube=true;if(this.webGLVersion===1){e.Tools.Error("Depth cube texture is not supported by WebGL 1.");return r}var o=n({bilinearFiltering:false,comparisonFunction:0,generateStencil:false},i);var s=this._gl;this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,r,true);this._setupDepthStencilTexture(r,t,o.generateStencil,o.bilinearFiltering,o.comparisonFunction);for(var a=0;a<6;a++){if(o.generateStencil){s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,s.DEPTH24_STENCIL8,t,t,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null)}else{s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,s.DEPTH_COMPONENT24,t,t,0,s.DEPTH_COMPONENT,s.UNSIGNED_INT,null)}}this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null);return r};o.prototype.setFrameBufferDepthStencilTexture=function(e){var t=e.getInternalTexture();if(!t||!t._framebuffer||!e.depthStencilTexture){return}var i=this._gl;var r=e.depthStencilTexture;this.bindUnboundFramebuffer(t._framebuffer);if(r.isCube){if(r._generateStencilBuffer){i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.TEXTURE_CUBE_MAP_POSITIVE_X,r._webGLTexture,0)}else{i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_CUBE_MAP_POSITIVE_X,r._webGLTexture,0)}}else{if(r._generateStencilBuffer){i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.TEXTURE_2D,r._webGLTexture,0)}else{i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,r._webGLTexture,0)}}this.bindUnboundFramebuffer(null)};o.prototype.createRenderTargetTexture=function(t,i){var n=new l;if(i!==undefined&&typeof i==="object"){n.generateMipMaps=i.generateMipMaps;n.generateDepthBuffer=i.generateDepthBuffer===undefined?true:i.generateDepthBuffer;n.generateStencilBuffer=n.generateDepthBuffer&&i.generateStencilBuffer;n.type=i.type===undefined?o.TEXTURETYPE_UNSIGNED_INT:i.type;n.samplingMode=i.samplingMode===undefined?e.Texture.TRILINEAR_SAMPLINGMODE:i.samplingMode;n.format=i.format===undefined?o.TEXTUREFORMAT_RGBA:i.format}else{n.generateMipMaps=i;n.generateDepthBuffer=true;n.generateStencilBuffer=false;n.type=o.TEXTURETYPE_UNSIGNED_INT;n.samplingMode=e.Texture.TRILINEAR_SAMPLINGMODE;n.format=o.TEXTUREFORMAT_RGBA}if(n.type===o.TEXTURETYPE_FLOAT&&!this._caps.textureFloatLinearFiltering){n.samplingMode=e.Texture.NEAREST_SAMPLINGMODE}else if(n.type===o.TEXTURETYPE_HALF_FLOAT&&!this._caps.textureHalfFloatLinearFiltering){n.samplingMode=e.Texture.NEAREST_SAMPLINGMODE}var s=this._gl;var a=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_RENDERTARGET);this._bindTextureDirectly(s.TEXTURE_2D,a,true);var u=t.width||t;var c=t.height||t;var h=r(n.samplingMode,n.generateMipMaps?true:false,s);if(n.type===o.TEXTURETYPE_FLOAT&&!this._caps.textureFloat){n.type=o.TEXTURETYPE_UNSIGNED_INT;e.Tools.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")}s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,h.mag);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,h.min);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);s.texImage2D(s.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(n.type,n.format),u,c,0,this._getInternalFormat(n.format),this._getWebGLTextureType(n.type),null);var f=s.createFramebuffer();this.bindUnboundFramebuffer(f);s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,a._webGLTexture,0);a._depthStencilBuffer=this._setupFramebufferDepthAttachments(n.generateStencilBuffer?true:false,n.generateDepthBuffer,u,c);if(n.generateMipMaps){this._gl.generateMipmap(this._gl.TEXTURE_2D)}this._bindTextureDirectly(s.TEXTURE_2D,null);s.bindRenderbuffer(s.RENDERBUFFER,null);this.bindUnboundFramebuffer(null);a._framebuffer=f;a.baseWidth=u;a.baseHeight=c;a.width=u;a.height=c;a.isReady=true;a.samples=1;a.generateMipMaps=n.generateMipMaps?true:false;a.samplingMode=n.samplingMode;a.type=n.type;a._generateDepthBuffer=n.generateDepthBuffer;a._generateStencilBuffer=n.generateStencilBuffer?true:false;this._internalTexturesCache.push(a);return a};o.prototype.createMultipleRenderTarget=function(t,i){var n=false;var s=true;var a=false;var u=false;var l=1;var c=o.TEXTURETYPE_UNSIGNED_INT;var h=e.Texture.TRILINEAR_SAMPLINGMODE;var f=new Array;var d=new Array;if(i!==undefined){n=i.generateMipMaps===undefined?false:i.generateMipMaps;s=i.generateDepthBuffer===undefined?true:i.generateDepthBuffer;a=i.generateStencilBuffer===undefined?false:i.generateStencilBuffer;u=i.generateDepthTexture===undefined?false:i.generateDepthTexture;l=i.textureCount||1;if(i.types){f=i.types}if(i.samplingModes){d=i.samplingModes}}var p=this._gl;var _=p.createFramebuffer();this.bindUnboundFramebuffer(_);var m=t.width||t;var g=t.height||t;var v=[];var y=[];var b=this._setupFramebufferDepthAttachments(a,s,m,g);for(var x=0;x<l;x++){var T=d[x]||h;var E=f[x]||c;if(E===o.TEXTURETYPE_FLOAT&&!this._caps.textureFloatLinearFiltering){T=e.Texture.NEAREST_SAMPLINGMODE}else if(E===o.TEXTURETYPE_HALF_FLOAT&&!this._caps.textureHalfFloatLinearFiltering){T=e.Texture.NEAREST_SAMPLINGMODE}var P=r(T,n,p);if(E===o.TEXTURETYPE_FLOAT&&!this._caps.textureFloat){E=o.TEXTURETYPE_UNSIGNED_INT;e.Tools.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")}var A=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_MULTIRENDERTARGET);var M=p[this.webGLVersion>1?"COLOR_ATTACHMENT"+x:"COLOR_ATTACHMENT"+x+"_WEBGL"];v.push(A);y.push(M);p.activeTexture(p["TEXTURE"+x]);p.bindTexture(p.TEXTURE_2D,A._webGLTexture);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,P.mag);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,P.min);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE);p.texImage2D(p.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(E),m,g,0,p.RGBA,this._getWebGLTextureType(E),null);p.framebufferTexture2D(p.DRAW_FRAMEBUFFER,M,p.TEXTURE_2D,A._webGLTexture,0);if(n){this._gl.generateMipmap(this._gl.TEXTURE_2D)}this._bindTextureDirectly(p.TEXTURE_2D,null);A._framebuffer=_;A._depthStencilBuffer=b;A.baseWidth=m;A.baseHeight=g;A.width=m;A.height=g;A.isReady=true;A.samples=1;A.generateMipMaps=n;A.samplingMode=T;A.type=E;A._generateDepthBuffer=s;A._generateStencilBuffer=a;A._attachments=y;this._internalTexturesCache.push(A)}if(u&&this._caps.depthTextureExtension){var S=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_MULTIRENDERTARGET);p.activeTexture(p.TEXTURE0);p.bindTexture(p.TEXTURE_2D,S._webGLTexture);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE);p.texImage2D(p.TEXTURE_2D,0,this.webGLVersion<2?p.DEPTH_COMPONENT:p.DEPTH_COMPONENT16,m,g,0,p.DEPTH_COMPONENT,p.UNSIGNED_SHORT,null);p.framebufferTexture2D(p.FRAMEBUFFER,p.DEPTH_ATTACHMENT,p.TEXTURE_2D,S._webGLTexture,0);S._framebuffer=_;S.baseWidth=m;S.baseHeight=g;S.width=m;S.height=g;S.isReady=true;S.samples=1;S.generateMipMaps=n;S.samplingMode=p.NEAREST;S._generateDepthBuffer=s;S._generateStencilBuffer=a;v.push(S);this._internalTexturesCache.push(S)}p.drawBuffers(y);p.bindRenderbuffer(p.RENDERBUFFER,null);this.bindUnboundFramebuffer(null);this.resetTextureCache();return v};o.prototype._setupFramebufferDepthAttachments=function(e,t,i,r,n){if(n===void 0){n=1}var o=null;var s=this._gl;if(e){o=s.createRenderbuffer();s.bindRenderbuffer(s.RENDERBUFFER,o);if(n>1){s.renderbufferStorageMultisample(s.RENDERBUFFER,n,s.DEPTH24_STENCIL8,i,r)}else{s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,i,r)}s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,o)}else if(t){o=s.createRenderbuffer();s.bindRenderbuffer(s.RENDERBUFFER,o);if(n>1){s.renderbufferStorageMultisample(s.RENDERBUFFER,n,s.DEPTH_COMPONENT16,i,r)}else{s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_COMPONENT16,i,r)}s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,o)}return o};o.prototype.updateRenderTargetTextureSampleCount=function(e,t){if(this.webGLVersion<2||!e){return 1}if(e.samples===t){return t}var i=this._gl;t=Math.min(t,i.getParameter(i.MAX_SAMPLES));if(e._depthStencilBuffer){i.deleteRenderbuffer(e._depthStencilBuffer);e._depthStencilBuffer=null}if(e._MSAAFramebuffer){i.deleteFramebuffer(e._MSAAFramebuffer);e._MSAAFramebuffer=null}if(e._MSAARenderBuffer){i.deleteRenderbuffer(e._MSAARenderBuffer);e._MSAARenderBuffer=null}if(t>1){var r=i.createFramebuffer();if(!r){throw new Error("Unable to create multi sampled framebuffer")}e._MSAAFramebuffer=r;this.bindUnboundFramebuffer(e._MSAAFramebuffer);var n=i.createRenderbuffer();if(!n){throw new Error("Unable to create multi sampled framebuffer")}i.bindRenderbuffer(i.RENDERBUFFER,n);i.renderbufferStorageMultisample(i.RENDERBUFFER,t,this._getRGBAMultiSampleBufferFormat(e.type),e.width,e.height);i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,n);e._MSAARenderBuffer=n}else{this.bindUnboundFramebuffer(e._framebuffer)}e.samples=t;e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.width,e.height,t);i.bindRenderbuffer(i.RENDERBUFFER,null);this.bindUnboundFramebuffer(null);return t};o.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t){if(this.webGLVersion<2||!e||e.length==0){return 1}if(e[0].samples===t){return t}var i=this._gl;t=Math.min(t,i.getParameter(i.MAX_SAMPLES));if(e[0]._depthStencilBuffer){i.deleteRenderbuffer(e[0]._depthStencilBuffer);e[0]._depthStencilBuffer=null}if(e[0]._MSAAFramebuffer){i.deleteFramebuffer(e[0]._MSAAFramebuffer);e[0]._MSAAFramebuffer=null}for(var r=0;r<e.length;r++){if(e[r]._MSAARenderBuffer){i.deleteRenderbuffer(e[r]._MSAARenderBuffer);e[r]._MSAARenderBuffer=null}}if(t>1){var n=i.createFramebuffer();if(!n){throw new Error("Unable to create multi sampled framebuffer")}this.bindUnboundFramebuffer(n);var o=this._setupFramebufferDepthAttachments(e[0]._generateStencilBuffer,e[0]._generateDepthBuffer,e[0].width,e[0].height,t);var s=[];for(var r=0;r<e.length;r++){var a=e[r];var u=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+r:"COLOR_ATTACHMENT"+r+"_WEBGL"];var l=i.createRenderbuffer();if(!l){throw new Error("Unable to create multi sampled framebuffer")}i.bindRenderbuffer(i.RENDERBUFFER,l);i.renderbufferStorageMultisample(i.RENDERBUFFER,t,this._getRGBAMultiSampleBufferFormat(a.type),a.width,a.height);i.framebufferRenderbuffer(i.FRAMEBUFFER,u,i.RENDERBUFFER,l);a._MSAAFramebuffer=n;a._MSAARenderBuffer=l;a.samples=t;a._depthStencilBuffer=o;i.bindRenderbuffer(i.RENDERBUFFER,null);s.push(u)}i.drawBuffers(s)}else{this.bindUnboundFramebuffer(e[0]._framebuffer)}this.bindUnboundFramebuffer(null);return t};o.prototype._uploadDataToTexture=function(e,t,i,r,n,o,s,a){this._gl.texImage2D(e,t,i,r,n,0,o,s,a)};o.prototype._uploadCompressedDataToTexture=function(e,t,i,r,n,o){this._gl.compressedTexImage2D(e,t,i,r,n,0,o)};o.prototype.createRenderTargetCubeTexture=function(t,i){var s=n({generateMipMaps:true,generateDepthBuffer:true,generateStencilBuffer:false,type:o.TEXTURETYPE_UNSIGNED_INT,samplingMode:e.Texture.TRILINEAR_SAMPLINGMODE,format:o.TEXTUREFORMAT_RGBA},i);s.generateStencilBuffer=s.generateDepthBuffer&&s.generateStencilBuffer;if(s.type===o.TEXTURETYPE_FLOAT&&!this._caps.textureFloatLinearFiltering){s.samplingMode=e.Texture.NEAREST_SAMPLINGMODE}else if(s.type===o.TEXTURETYPE_HALF_FLOAT&&!this._caps.textureHalfFloatLinearFiltering){s.samplingMode=e.Texture.NEAREST_SAMPLINGMODE}var a=this._gl;var u=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_RENDERTARGET);this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,u,true);var l=r(s.samplingMode,s.generateMipMaps,a);if(s.type===o.TEXTURETYPE_FLOAT&&!this._caps.textureFloat){s.type=o.TEXTURETYPE_UNSIGNED_INT;e.Tools.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")}a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,l.mag);a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,l.min);a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);for(var c=0;c<6;c++){a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,this._getRGBABufferInternalSizedFormat(s.type,s.format),t,t,0,this._getInternalFormat(s.format),this._getWebGLTextureType(s.type),null)}var h=a.createFramebuffer();this.bindUnboundFramebuffer(h);u._depthStencilBuffer=this._setupFramebufferDepthAttachments(s.generateStencilBuffer,s.generateDepthBuffer,t,t);if(s.generateMipMaps){a.generateMipmap(a.TEXTURE_CUBE_MAP)}this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,null);a.bindRenderbuffer(a.RENDERBUFFER,null);this.bindUnboundFramebuffer(null);u._framebuffer=h;u.width=t;u.height=t;u.isReady=true;u.isCube=true;u.samples=1;u.generateMipMaps=s.generateMipMaps;u.samplingMode=s.samplingMode;u.type=s.type;u._generateDepthBuffer=s.generateDepthBuffer;u._generateStencilBuffer=s.generateStencilBuffer;this._internalTexturesCache.push(u);return u};o.prototype.createPrefilteredCubeTexture=function(t,i,r,n,o,s,a,u){var l=this;if(o===void 0){o=null}if(s===void 0){s=null}if(u===void 0){u=null}var c=function(t){if(!t){if(o){o(null)}return}var s=t.texture;s._dataSource=e.InternalTexture.DATASOURCE_CUBEPREFILTERED;s._lodGenerationScale=r;s._lodGenerationOffset=n;if(l._caps.textureLOD){if(o){o(s)}return}var a=3;var u=l._gl;var c=t.width;if(!c){return}var h=[];for(var f=0;f<a;f++){var d=f/(a-1);var p=1-d;var _=n;var m=e.Scalar.Log2(c)*r+n;var g=_+(m-_)*p;var v=Math.round(Math.min(Math.max(g,0),m));var y=new e.InternalTexture(l,e.InternalTexture.DATASOURCE_TEMP);y.isCube=true;l._bindTextureDirectly(u.TEXTURE_CUBE_MAP,y,true);u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_MAG_FILTER,u.LINEAR);u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_MIN_FILTER,u.LINEAR);u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE);u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE);if(t.isDDS){var b=t.info;var x=t.data;u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,b.isCompressed?1:0);e.DDSTools.UploadDDSLevels(l,l._gl,x,b,true,6,v)}else{e.Tools.Warn("DDS is the only prefiltered cube map supported so far.")}l._bindTextureDirectly(u.TEXTURE_CUBE_MAP,null);var T=new e.BaseTexture(i);T.isCube=true;T._texture=y;y.isReady=true;h.push(T)}s._lodTextureHigh=h[2];s._lodTextureMid=h[1];s._lodTextureLow=h[0];if(o){o(s)}};return this.createCubeTexture(t,i,null,false,c,s,a,u)};o.prototype.createCubeTexture=function(t,i,r,n,o,a,u,l){var c=this;if(o===void 0){o=null}if(a===void 0){a=null}if(l===void 0){l=null}var h=this._gl;var f=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_CUBE);f.isCube=true;f.url=t;f.generateMipMaps=!n;if(!this._doNotHandleContextLost){f._extension=l;f._files=r}var d=false;var p=false;var _=t.lastIndexOf(".");var m=l?l:_>-1?t.substring(_).toLowerCase():"";if(this._textureFormatInUse){m=this._textureFormatInUse;t=(_>-1?t.substring(0,_):t)+this._textureFormatInUse;d=true}else{p=m===".dds"}var g=function(e,t){if(a&&e){a(e.status+" "+e.statusText,t)}};if(d){this._loadFile(t,function(t){var i=new e.KhronosTextureContainer(t,6);var r=i.numberOfMipmapLevels>1&&!n;c._bindTextureDirectly(h.TEXTURE_CUBE_MAP,f,true);h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,1);i.uploadLevels(c._gl,!n);c.setCubeMapTextureParams(h,r);f.width=i.pixelWidth;f.height=i.pixelHeight;f.isReady=true},undefined,undefined,true,g)}else if(p){if(r&&r.length===6){this._cascadeLoadFiles(i,function(t){var i;var r=false;var s=0;for(var a=0;a<t.length;a++){var u=t[a];i=e.DDSTools.GetDDSInfo(u);r=(i.isRGB||i.isLuminance||i.mipmapCount>1)&&!n;c._bindTextureDirectly(h.TEXTURE_CUBE_MAP,f,true);h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,i.isCompressed?1:0);e.DDSTools.UploadDDSLevels(c,c._gl,u,i,r,6,-1,a);if(!n&&!i.isFourCC&&i.mipmapCount===1){h.generateMipmap(h.TEXTURE_CUBE_MAP)}f.width=i.width;f.height=i.height;f.type=i.textureType;s=i.width}c.setCubeMapTextureParams(h,r);f.isReady=true;if(o){o({isDDS:true,width:s,info:i,imgs:t,texture:f})}},r,a)}else{this._loadFile(t,function(t){var i=e.DDSTools.GetDDSInfo(t);var r=(i.isRGB||i.isLuminance||i.mipmapCount>1)&&!n;c._bindTextureDirectly(h.TEXTURE_CUBE_MAP,f,true);h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,i.isCompressed?1:0);e.DDSTools.UploadDDSLevels(c,c._gl,t,i,r,6);if(!n&&!i.isFourCC&&i.mipmapCount===1){h.generateMipmap(h.TEXTURE_CUBE_MAP)}c.setCubeMapTextureParams(h,r);f.width=i.width;f.height=i.height;f.isReady=true;f.type=i.textureType;if(o){o({isDDS:true,width:i.width,info:i,data:t,texture:f})}},undefined,undefined,true,g)}}else{if(!r){throw new Error("Cannot load cubemap because files were not defined")}s(t,i,function(t){var i=c.needPOTTextures?e.Tools.GetExponentOfTwo(t[0].width,c._caps.maxCubemapTextureSize):t[0].width;var r=i;c._prepareWorkingCanvas();if(!c._workingCanvas||!c._workingContext){return}c._workingCanvas.width=i;c._workingCanvas.height=r;var s=[h.TEXTURE_CUBE_MAP_POSITIVE_X,h.TEXTURE_CUBE_MAP_POSITIVE_Y,h.TEXTURE_CUBE_MAP_POSITIVE_Z,h.TEXTURE_CUBE_MAP_NEGATIVE_X,h.TEXTURE_CUBE_MAP_NEGATIVE_Y,h.TEXTURE_CUBE_MAP_NEGATIVE_Z];c._bindTextureDirectly(h.TEXTURE_CUBE_MAP,f,true);h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,0);var a=u?c._getInternalFormat(u):c._gl.RGBA;for(var l=0;l<s.length;l++){c._workingContext.drawImage(t[l],0,0,t[l].width,t[l].height,0,0,i,r);h.texImage2D(s[l],0,a,a,h.UNSIGNED_BYTE,c._workingCanvas)}if(!n){h.generateMipmap(h.TEXTURE_CUBE_MAP)}c.setCubeMapTextureParams(h,!n);f.width=i;f.height=r;f.isReady=true;if(u){f.format=u}f.onLoadedObservable.notifyObservers(f);f.onLoadedObservable.clear();if(o){o()}},r,a)}
this._internalTexturesCache.push(f);return f};o.prototype.setCubeMapTextureParams=function(e,t){e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,t?e.LINEAR_MIPMAP_LINEAR:e.LINEAR);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);this._bindTextureDirectly(e.TEXTURE_CUBE_MAP,null)};o.prototype.updateRawCubeTexture=function(t,i,r,n,o,s,a){if(s===void 0){s=null}if(a===void 0){a=0}t._bufferViewArray=i;t.format=r;t.type=n;t.invertY=o;t._compression=s;var u=this._gl;var l=this._getWebGLTextureType(n);var c=this._getInternalFormat(r);var h=this._getRGBABufferInternalSizedFormat(n);var f=false;if(c===u.RGB){c=u.RGBA;f=true}this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,t,true);u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,o===undefined?1:o?1:0);if(t.width%4!==0){u.pixelStorei(u.UNPACK_ALIGNMENT,1)}for(var d=0;d<6;d++){var p=i[d];if(s){u.compressedTexImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+d,a,this.getCaps().s3tc[s],t.width,t.height,0,p)}else{if(f){p=this._convertRGBtoRGBATextureData(p,t.width,t.height,n)}u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+d,a,h,t.width,t.height,0,c,l,p)}}var _=!this.needPOTTextures||e.Tools.IsExponentOfTwo(t.width)&&e.Tools.IsExponentOfTwo(t.height);if(_&&t.generateMipMaps&&a===0){this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null);t.isReady=true};o.prototype.createRawCubeTexture=function(t,i,n,o,s,a,u,l){if(l===void 0){l=null}var c=this._gl;var h=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_CUBERAW);h.isCube=true;h.generateMipMaps=s;h.format=n;h.type=o;if(!this._doNotHandleContextLost){h._bufferViewArray=t}var f=this._getWebGLTextureType(o);var d=this._getInternalFormat(n);if(d===c.RGB){d=c.RGBA}var p=i;var _=p;h.width=p;h.height=_;var m=!this.needPOTTextures||e.Tools.IsExponentOfTwo(h.width)&&e.Tools.IsExponentOfTwo(h.height);if(!m){s=false}if(t){this.updateRawCubeTexture(h,t,n,o,a,l)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,h,true);if(t&&s){this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP)}if(f===c.FLOAT&&!this._caps.textureFloatLinearFiltering){c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MAG_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MIN_FILTER,c.NEAREST)}else if(f===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering){c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MAG_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MIN_FILTER,c.NEAREST)}else{var g=r(u,s,c);c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MAG_FILTER,g.mag);c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MIN_FILTER,g.min)}c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);this._bindTextureDirectly(c.TEXTURE_CUBE_MAP,null);return h};o.prototype.createRawCubeTextureFromUrl=function(t,i,r,n,o,s,a,u,l,c,h,f){var d=this;if(l===void 0){l=null}if(c===void 0){c=null}if(h===void 0){h=e.Texture.TRILINEAR_SAMPLINGMODE}if(f===void 0){f=false}var p=this._gl;var _=this.createRawCubeTexture(null,r,n,o,!s,f,h);i._addPendingData(_);_.url=t;this._internalTexturesCache.push(_);var m=function(e,t){i._removePendingData(_);if(c&&e){c(e.status+" "+e.statusText,t)}};var g=function(e){var t=_.width;var r=a(e);if(!r){return}if(u){var c=d._getWebGLTextureType(o);var h=d._getInternalFormat(n);var m=d._getRGBABufferInternalSizedFormat(o);var g=false;if(h===p.RGB){h=p.RGBA;g=true}d._bindTextureDirectly(p.TEXTURE_CUBE_MAP,_,true);p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,0);var v=u(r);for(var y=0;y<v.length;y++){var b=t>>y;for(var x=0;x<6;x++){var T=v[y][x];if(g){T=d._convertRGBtoRGBATextureData(T,b,b,o)}p.texImage2D(x,y,m,b,b,0,h,c,T)}}d._bindTextureDirectly(p.TEXTURE_CUBE_MAP,null)}else{_.generateMipMaps=!s;d.updateRawCubeTexture(_,r,n,o,f)}_.isReady=true;i._removePendingData(_);if(l){l()}};this._loadFile(t,function(e){g(e)},undefined,i.database,true,m);return _};o.prototype.updateRawTexture3D=function(e,t,i,r,n){if(n===void 0){n=null}var o=this._getInternalFormat(i);this._bindTextureDirectly(this._gl.TEXTURE_3D,e,true);this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,r===undefined?1:r?1:0);if(!this._doNotHandleContextLost){e._bufferView=t;e.format=i;e.invertY=r;e._compression=n}if(e.width%4!==0){this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1)}if(n&&t){this._gl.compressedTexImage3D(this._gl.TEXTURE_3D,0,this.getCaps().s3tc[n],e.width,e.height,e.depth,0,t)}else{this._gl.texImage3D(this._gl.TEXTURE_3D,0,o,e.width,e.height,e.depth,0,o,this._gl.UNSIGNED_BYTE,t)}if(e.generateMipMaps){this._gl.generateMipmap(this._gl.TEXTURE_3D)}this._bindTextureDirectly(this._gl.TEXTURE_3D,null);e.isReady=true};o.prototype.createRawTexture3D=function(t,i,n,o,s,a,u,l,c){if(c===void 0){c=null}var h=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_RAW3D);h.baseWidth=i;h.baseHeight=n;h.baseDepth=o;h.width=i;h.height=n;h.depth=o;h.format=s;h.generateMipMaps=a;h.samplingMode=l;h.is3D=true;if(!this._doNotHandleContextLost){h._bufferView=t}this.updateRawTexture3D(h,t,s,u,c);this._bindTextureDirectly(this._gl.TEXTURE_3D,h,true);var f=r(l,a,this._gl);this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_MAG_FILTER,f.mag);this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_MIN_FILTER,f.min);if(a){this._gl.generateMipmap(this._gl.TEXTURE_3D)}this._bindTextureDirectly(this._gl.TEXTURE_3D,null);this._internalTexturesCache.push(h);return h};o.prototype._prepareWebGLTextureContinuation=function(e,t,i,n,o){var s=this._gl;if(!s){return}var a=r(o,!i,s);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,a.mag);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,a.min);if(!i&&!n){s.generateMipmap(s.TEXTURE_2D)}this._bindTextureDirectly(s.TEXTURE_2D,null);if(t){t._removePendingData(e)}e.onLoadedObservable.notifyObservers(e);e.onLoadedObservable.clear()};o.prototype._prepareWebGLTexture=function(t,i,r,n,o,s,a,u,l){var c=this;if(l===void 0){l=e.Texture.TRILINEAR_SAMPLINGMODE}var h=this.needPOTTextures?e.Tools.GetExponentOfTwo(r,this.getCaps().maxTextureSize):r;var f=this.needPOTTextures?e.Tools.GetExponentOfTwo(n,this.getCaps().maxTextureSize):n;var d=this._gl;if(!d){return}if(!t._webGLTexture){if(i){i._removePendingData(t)}return}this._bindTextureDirectly(d.TEXTURE_2D,t,true);d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,o===undefined?1:o?1:0);t.baseWidth=r;t.baseHeight=n;t.width=h;t.height=f;t.isReady=true;if(u(h,f,function(){c._prepareWebGLTextureContinuation(t,i,s,a,l)})){return}this._prepareWebGLTextureContinuation(t,i,s,a,l)};o.prototype._convertRGBtoRGBATextureData=function(e,t,i,r){var n;if(r===o.TEXTURETYPE_FLOAT){n=new Float32Array(t*i*4)}else{n=new Uint32Array(t*i*4)}for(var s=0;s<t;s++){for(var a=0;a<i;a++){var u=(a*t+s)*3;var l=(a*t+s)*4;n[l+0]=e[u+0];n[l+1]=e[u+1];n[l+2]=e[u+2];n[l+3]=1}}return n};o.prototype._releaseFramebufferObjects=function(e){var t=this._gl;if(e._framebuffer){t.deleteFramebuffer(e._framebuffer);e._framebuffer=null}if(e._depthStencilBuffer){t.deleteRenderbuffer(e._depthStencilBuffer);e._depthStencilBuffer=null}if(e._MSAAFramebuffer){t.deleteFramebuffer(e._MSAAFramebuffer);e._MSAAFramebuffer=null}if(e._MSAARenderBuffer){t.deleteRenderbuffer(e._MSAARenderBuffer);e._MSAARenderBuffer=null}};o.prototype._releaseTexture=function(e){var t=this._gl;this._releaseFramebufferObjects(e);t.deleteTexture(e._webGLTexture);this.unbindAllTextures();var i=this._internalTexturesCache.indexOf(e);if(i!==-1){this._internalTexturesCache.splice(i,1)}if(e._lodTextureHigh){e._lodTextureHigh.dispose()}if(e._lodTextureMid){e._lodTextureMid.dispose()}if(e._lodTextureLow){e._lodTextureLow.dispose()}this.scenes.forEach(function(t){t.postProcesses.forEach(function(t){if(t._outputTexture==e){t._outputTexture=null}});t.cameras.forEach(function(t){t._postProcesses.forEach(function(t){if(t){if(t._outputTexture==e){t._outputTexture=null}}})})})};o.prototype.setProgram=function(e){if(this._currentProgram!==e){this._gl.useProgram(e);this._currentProgram=e}};o.prototype.bindSamplers=function(e){this.setProgram(e.getProgram());var t=e.getSamplers();for(var i=0;i<t.length;i++){var r=e.getUniform(t[i]);if(r){this._boundUniforms[i]=r}}this._currentEffect=null};o.prototype._moveBoundTextureOnTop=function(e){if(this.disableTextureBindingOptimization||this._lastBoundInternalTextureTracker.previous===e){return}this._linkTrackers(e.previous,e.next);this._linkTrackers(this._lastBoundInternalTextureTracker.previous,e);this._linkTrackers(e,this._lastBoundInternalTextureTracker)};o.prototype._getCorrectTextureChannel=function(e,t){if(!t){return-1}t._initialSlot=e;if(this.disableTextureBindingOptimization){if(e!==t._designatedSlot){this._textureCollisions.addCount(1,false)}}else{if(e!==t._designatedSlot){if(t._designatedSlot>-1){return t._designatedSlot}else{if(this._nextFreeTextureSlots.length){return this._nextFreeTextureSlots[0]}this._textureCollisions.addCount(1,false);return this._removeDesignatedSlot(this._firstBoundInternalTextureTracker.next)}}}return e};o.prototype._linkTrackers=function(e,t){e.next=t;t.previous=e};o.prototype._removeDesignatedSlot=function(e){var t=e._designatedSlot;if(t===-1){return-1}e._designatedSlot=-1;if(this.disableTextureBindingOptimization){return-1}this._linkTrackers(e.previous,e.next);this._boundTexturesCache[t]=null;this._nextFreeTextureSlots.push(t);return t};o.prototype._activateCurrentTexture=function(){if(this._currentTextureChannel!==this._activeChannel){this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel);this._currentTextureChannel=this._activeChannel}};o.prototype._bindTextureDirectly=function(e,t,i){if(i===void 0){i=false}if(i&&t&&t._designatedSlot>-1){this._activeChannel=t._designatedSlot}var r=this._boundTexturesCache[this._activeChannel];var n=t&&t._initialSlot>-1;if(r!==t){if(r){this._removeDesignatedSlot(r)}this._activateCurrentTexture();this._gl.bindTexture(e,t?t._webGLTexture:null);this._boundTexturesCache[this._activeChannel]=t;if(t){if(!this.disableTextureBindingOptimization){var o=this._nextFreeTextureSlots.indexOf(this._activeChannel);if(o>-1){this._nextFreeTextureSlots.splice(o,1)}this._linkTrackers(this._lastBoundInternalTextureTracker.previous,t);this._linkTrackers(t,this._lastBoundInternalTextureTracker)}t._designatedSlot=this._activeChannel}}else if(i){this._activateCurrentTexture()}if(n&&!i){this._bindSamplerUniformToChannel(t._initialSlot,this._activeChannel)}};o.prototype._bindTexture=function(e,t){if(e<0){return}if(t){e=this._getCorrectTextureChannel(e,t)}this._activeChannel=e;this._bindTextureDirectly(this._gl.TEXTURE_2D,t)};o.prototype.setTextureFromPostProcess=function(e,t){this._bindTexture(e,t?t._textures.data[t._currentRenderTextureInd]:null)};o.prototype.setTextureFromPostProcessOutput=function(e,t){this._bindTexture(e,t?t._outputTexture:null)};o.prototype.unbindAllTextures=function(){for(var e=0;e<this._maxSimultaneousTextures;e++){this._activeChannel=e;this._bindTextureDirectly(this._gl.TEXTURE_2D,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null);if(this.webGLVersion>1){this._bindTextureDirectly(this._gl.TEXTURE_3D,null)}}};o.prototype.setTexture=function(e,t,i){if(e<0){return}if(t){this._boundUniforms[e]=t}this._setTexture(e,i)};o.prototype.setDepthStencilTexture=function(e,t,i){if(e<0){return}if(t){this._boundUniforms[e]=t}if(!i||!i.depthStencilTexture){this._setTexture(e,null)}else{this._setTexture(e,i,false,true)}};o.prototype._bindSamplerUniformToChannel=function(e,t){var i=this._boundUniforms[e];if(i._currentState===t){return}this._gl.uniform1i(i,t);i._currentState=t};o.prototype._setTexture=function(t,i,r,n){if(r===void 0){r=false}if(n===void 0){n=false}if(!i){if(this._boundTexturesCache[t]!=null){this._activeChannel=t;this._bindTextureDirectly(this._gl.TEXTURE_2D,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null);if(this.webGLVersion>1){this._bindTextureDirectly(this._gl.TEXTURE_3D,null)}}return false}if(i.video){this._activeChannel=t;i.update()}else if(i.delayLoadState===o.DELAYLOADSTATE_NOTLOADED){i.delayLoad();return false}var s;if(n){s=i.depthStencilTexture}else if(i.isReady()){s=i.getInternalTexture()}else if(i.isCube){s=this.emptyCubeTexture}else if(i.is3D){s=this.emptyTexture3D}else{s=this.emptyTexture}if(!r){t=this._getCorrectTextureChannel(t,s)}if(this._boundTexturesCache[t]===s){this._moveBoundTextureOnTop(s);if(!r){this._bindSamplerUniformToChannel(s._initialSlot,t)}return false}this._activeChannel=t;if(s&&s.is3D){this._bindTextureDirectly(this._gl.TEXTURE_3D,s,r);if(s&&s._cachedWrapU!==i.wrapU){s._cachedWrapU=i.wrapU;switch(i.wrapU){case e.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_S,this._gl.REPEAT);break;case e.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE);break;case e.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_S,this._gl.MIRRORED_REPEAT);break}}if(s&&s._cachedWrapV!==i.wrapV){s._cachedWrapV=i.wrapV;switch(i.wrapV){case e.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_T,this._gl.REPEAT);break;case e.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);break;case e.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_T,this._gl.MIRRORED_REPEAT);break}}if(s&&s._cachedWrapR!==i.wrapR){s._cachedWrapR=i.wrapR;switch(i.wrapR){case e.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_R,this._gl.REPEAT);break;case e.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_R,this._gl.CLAMP_TO_EDGE);break;case e.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_R,this._gl.MIRRORED_REPEAT);break}}this._setAnisotropicLevel(this._gl.TEXTURE_3D,i)}else if(s&&s.isCube){this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,s,r);if(s._cachedCoordinatesMode!==i.coordinatesMode){s._cachedCoordinatesMode=i.coordinatesMode;var a=i.coordinatesMode!==e.Texture.CUBIC_MODE&&i.coordinatesMode!==e.Texture.SKYBOX_MODE?this._gl.REPEAT:this._gl.CLAMP_TO_EDGE;this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_S,a);this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_T,a)}this._setAnisotropicLevel(this._gl.TEXTURE_CUBE_MAP,i)}else{this._bindTextureDirectly(this._gl.TEXTURE_2D,s,r);if(s&&s._cachedWrapU!==i.wrapU){s._cachedWrapU=i.wrapU;switch(i.wrapU){case e.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.REPEAT);break;case e.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE);break;case e.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.MIRRORED_REPEAT);break}}if(s&&s._cachedWrapV!==i.wrapV){s._cachedWrapV=i.wrapV;switch(i.wrapV){case e.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.REPEAT);break;case e.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);break;case e.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.MIRRORED_REPEAT);break}}this._setAnisotropicLevel(this._gl.TEXTURE_2D,i)}return true};o.prototype.setTextureArray=function(e,t,i){if(e<0||!t){return}if(!this._textureUnits||this._textureUnits.length!==i.length){this._textureUnits=new Int32Array(i.length)}for(var r=0;r<i.length;r++){this._textureUnits[r]=this._getCorrectTextureChannel(e+r,i[r].getInternalTexture())}this._gl.uniform1iv(t,this._textureUnits);for(var n=0;n<i.length;n++){this._setTexture(this._textureUnits[n],i[n],true)}};o.prototype._setAnisotropicLevel=function(t,i){var r=i.getInternalTexture();if(!r){return}var n=this._caps.textureAnisotropicFilterExtension;var o=i.anisotropicFilteringLevel;if(r.samplingMode!==e.Texture.LINEAR_LINEAR_MIPNEAREST&&r.samplingMode!==e.Texture.LINEAR_LINEAR_MIPLINEAR&&r.samplingMode!==e.Texture.LINEAR_LINEAR){o=1}if(n&&r._cachedAnisotropicFilteringLevel!==o){this._gl.texParameterf(t,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(o,this._caps.maxAnisotropy));r._cachedAnisotropicFilteringLevel=o}};o.prototype.readPixels=function(e,t,i,r){var n=new Uint8Array(r*i*4);this._gl.readPixels(e,t,i,r,this._gl.RGBA,this._gl.UNSIGNED_BYTE,n);return n};o.prototype.addExternalData=function(t,i){if(!this._externalData){this._externalData=new e.StringDictionary}return this._externalData.add(t,i)};o.prototype.getExternalData=function(t){if(!this._externalData){this._externalData=new e.StringDictionary}return this._externalData.get(t)};o.prototype.getOrAddExternalDataWithFactory=function(t,i){if(!this._externalData){this._externalData=new e.StringDictionary}return this._externalData.getOrAddWithFactory(t,i)};o.prototype.removeExternalData=function(t){if(!this._externalData){this._externalData=new e.StringDictionary}return this._externalData.remove(t)};o.prototype.unbindAllAttributes=function(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=false;for(var e=0;e<this._caps.maxVertexAttribs;e++){this._gl.disableVertexAttribArray(e);this._vertexAttribArraysEnabled[e]=false;this._currentBufferPointers[e].active=false}return}for(var e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++){if(e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]){continue}this._gl.disableVertexAttribArray(e);this._vertexAttribArraysEnabled[e]=false;this._currentBufferPointers[e].active=false}};o.prototype.releaseEffects=function(){for(var e in this._compiledEffects){this._deleteProgram(this._compiledEffects[e]._program)}this._compiledEffects={}};o.prototype.dispose=function(){this.hideLoadingUI();this.stopRenderLoop();while(this.postProcesses.length){this.postProcesses[0].dispose()}if(this._emptyTexture){this._releaseTexture(this._emptyTexture);this._emptyTexture=null}if(this._emptyCubeTexture){this._releaseTexture(this._emptyCubeTexture);this._emptyCubeTexture=null}if(this._rescalePostProcess){this._rescalePostProcess.dispose()}while(this.scenes.length){this.scenes[0].dispose()}if(o.audioEngine){o.audioEngine.dispose()}this.releaseEffects();this.unbindAllAttributes();this._boundUniforms=[];if(this._dummyFramebuffer){this._gl.deleteFramebuffer(this._dummyFramebuffer)}this.disableVR();if(e.Tools.IsWindowObjectExist()){window.removeEventListener("blur",this._onBlur);window.removeEventListener("focus",this._onFocus);window.removeEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted);window.removeEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted);if(this._renderingCanvas){this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus);this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur);this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut);if(!this._doNotHandleContextLost){this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost);this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)}}document.removeEventListener("fullscreenchange",this._onFullscreenChange);document.removeEventListener("mozfullscreenchange",this._onFullscreenChange);document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange);document.removeEventListener("msfullscreenchange",this._onFullscreenChange);document.removeEventListener("pointerlockchange",this._onPointerLockChange);document.removeEventListener("mspointerlockchange",this._onPointerLockChange);document.removeEventListener("mozpointerlockchange",this._onPointerLockChange);document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange);if(this._onVrDisplayConnect){window.removeEventListener("vrdisplayconnect",this._onVrDisplayConnect);if(this._onVrDisplayDisconnect){window.removeEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect)}if(this._onVrDisplayPresentChange){window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange)}this._onVrDisplayConnect=null;this._onVrDisplayDisconnect=null}}var t=o.Instances.indexOf(this);if(t>=0){o.Instances.splice(t,1)}this._workingCanvas=null;this._workingContext=null;this._currentBufferPointers=[];this._renderingCanvas=null;this._currentProgram=null;this._bindedRenderFunction=null;this.onResizeObservable.clear();this.onCanvasBlurObservable.clear();this.onCanvasFocusObservable.clear();this.onCanvasPointerOutObservable.clear();this.onBeginFrameObservable.clear();this.onEndFrameObservable.clear();e.Effect.ResetCache();for(var i=0,r=this._activeRequests;i<r.length;i++){var n=r[i];n.abort()}};o.prototype.displayLoadingUI=function(){if(!e.Tools.IsWindowObjectExist()){return}var t=this.loadingScreen;if(t){t.displayLoadingUI()}};o.prototype.hideLoadingUI=function(){if(!e.Tools.IsWindowObjectExist()){return}var t=this.loadingScreen;if(t){t.hideLoadingUI()}};Object.defineProperty(o.prototype,"loadingScreen",{get:function(){if(!this._loadingScreen&&e.DefaultLoadingScreen&&this._renderingCanvas)this._loadingScreen=new e.DefaultLoadingScreen(this._renderingCanvas);return this._loadingScreen},set:function(e){this._loadingScreen=e},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"loadingUIText",{set:function(e){this.loadingScreen.loadingUIText=e},enumerable:true,configurable:true});Object.defineProperty(o.prototype,"loadingUIBackgroundColor",{set:function(e){this.loadingScreen.loadingUIBackgroundColor=e},enumerable:true,configurable:true});o.prototype.attachContextLostEvent=function(e){if(this._renderingCanvas){this._renderingCanvas.addEventListener("webglcontextlost",e,false)}};o.prototype.attachContextRestoredEvent=function(e){if(this._renderingCanvas){this._renderingCanvas.addEventListener("webglcontextrestored",e,false)}};o.prototype.getVertexShaderSource=function(e){var t=this._gl.getAttachedShaders(e);if(!t){return null}return this._gl.getShaderSource(t[0])};o.prototype.getFragmentShaderSource=function(e){var t=this._gl.getAttachedShaders(e);if(!t){return null}return this._gl.getShaderSource(t[1])};o.prototype.getError=function(){return this._gl.getError()};o.prototype.getFps=function(){return this._fps};o.prototype.getDeltaTime=function(){return this._deltaTime};o.prototype._measureFps=function(){this._performanceMonitor.sampleFrame();this._fps=this._performanceMonitor.averageFPS;this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0};o.prototype._readTexturePixels=function(e,t,i,r){if(r===void 0){r=-1}var n=this._gl;if(!this._dummyFramebuffer){var o=n.createFramebuffer();if(!o){throw new Error("Unable to create dummy framebuffer")}this._dummyFramebuffer=o}n.bindFramebuffer(n.FRAMEBUFFER,this._dummyFramebuffer);if(r>-1){n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_CUBE_MAP_POSITIVE_X+r,e._webGLTexture,0)}else{n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,e._webGLTexture,0)}var s=e.type!==undefined?this._getWebGLTextureType(e.type):n.UNSIGNED_BYTE;var a;switch(s){case n.UNSIGNED_BYTE:a=new Uint8Array(4*t*i);s=n.UNSIGNED_BYTE;break;default:a=new Float32Array(4*t*i);s=n.FLOAT;break}n.readPixels(0,0,t,i,n.RGBA,s,a);n.bindFramebuffer(n.FRAMEBUFFER,this._currentFramebuffer);return a};o.prototype._canRenderToFloatFramebuffer=function(){if(this._webGLVersion>1){return this._caps.colorBufferFloat}return this._canRenderToFramebuffer(o.TEXTURETYPE_FLOAT)};o.prototype._canRenderToHalfFloatFramebuffer=function(){if(this._webGLVersion>1){return this._caps.colorBufferFloat}return this._canRenderToFramebuffer(o.TEXTURETYPE_HALF_FLOAT)};o.prototype._canRenderToFramebuffer=function(e){var t=this._gl;while(t.getError()!==t.NO_ERROR){}var i=true;var r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r);t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);var n=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,n);t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);var o=t.checkFramebufferStatus(t.FRAMEBUFFER);i=i&&o===t.FRAMEBUFFER_COMPLETE;i=i&&t.getError()===t.NO_ERROR;if(i){t.clear(t.COLOR_BUFFER_BIT);i=i&&t.getError()===t.NO_ERROR}if(i){t.bindFramebuffer(t.FRAMEBUFFER,null);var s=t.RGBA;var a=t.UNSIGNED_BYTE;var u=new Uint8Array(4);t.readPixels(0,0,1,1,s,a,u);i=i&&t.getError()===t.NO_ERROR}t.deleteTexture(r);t.deleteFramebuffer(n);t.bindFramebuffer(t.FRAMEBUFFER,null);while(!i&&t.getError()!==t.NO_ERROR){}return i};o.prototype._getWebGLTextureType=function(e){if(e===o.TEXTURETYPE_FLOAT){return this._gl.FLOAT}else if(e===o.TEXTURETYPE_HALF_FLOAT){return this._gl.HALF_FLOAT_OES}return this._gl.UNSIGNED_BYTE};o.prototype._getInternalFormat=function(e){var t=this._gl.RGBA;switch(e){case o.TEXTUREFORMAT_ALPHA:t=this._gl.ALPHA;break;case o.TEXTUREFORMAT_LUMINANCE:t=this._gl.LUMINANCE;break;case o.TEXTUREFORMAT_LUMINANCE_ALPHA:t=this._gl.LUMINANCE_ALPHA;break;case o.TEXTUREFORMAT_RGB:case o.TEXTUREFORMAT_RGB32F:t=this._gl.RGB;break;case o.TEXTUREFORMAT_RGBA:case o.TEXTUREFORMAT_RGBA32F:t=this._gl.RGBA;break;case o.TEXTUREFORMAT_R32F:t=this._gl.RED;break;case o.TEXTUREFORMAT_RG32F:t=this._gl.RG;break}return t};o.prototype._getRGBABufferInternalSizedFormat=function(e,t){if(this._webGLVersion===1){if(t){switch(t){case o.TEXTUREFORMAT_LUMINANCE:return this._gl.LUMINANCE}}return this._gl.RGBA}if(e===o.TEXTURETYPE_FLOAT){if(t){switch(t){case o.TEXTUREFORMAT_R32F:return this._gl.R32F;case o.TEXTUREFORMAT_RG32F:return this._gl.RG32F;case o.TEXTUREFORMAT_RGB32F:return this._gl.RGB32F}}return this._gl.RGBA32F}else if(e===o.TEXTURETYPE_HALF_FLOAT){return this._gl.RGBA16F}if(t){switch(t){case o.TEXTUREFORMAT_LUMINANCE:return this._gl.LUMINANCE}}return this._gl.RGBA};o.prototype._getRGBAMultiSampleBufferFormat=function(e){if(e===o.TEXTURETYPE_FLOAT){return this._gl.RGBA32F}else if(e===o.TEXTURETYPE_HALF_FLOAT){return this._gl.RGBA16F}return this._gl.RGBA8};o.prototype.createQuery=function(){return this._gl.createQuery()};o.prototype.deleteQuery=function(e){this._gl.deleteQuery(e);return this};o.prototype.isQueryResultAvailable=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT_AVAILABLE)};o.prototype.getQueryResult=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT)};o.prototype.beginOcclusionQuery=function(e,t){var i=this.getGlAlgorithmType(e);this._gl.beginQuery(i,t);return this};o.prototype.endOcclusionQuery=function(e){var t=this.getGlAlgorithmType(e);this._gl.endQuery(t);return this};o.prototype._createTimeQuery=function(){var e=this._caps.timerQuery;if(e.createQueryEXT){return e.createQueryEXT()}return this.createQuery()};o.prototype._deleteTimeQuery=function(e){var t=this._caps.timerQuery;if(t.deleteQueryEXT){t.deleteQueryEXT(e);return}this.deleteQuery(e)};o.prototype._getTimeQueryResult=function(e){var t=this._caps.timerQuery;if(t.getQueryObjectEXT){return t.getQueryObjectEXT(e,t.QUERY_RESULT_EXT)}return this.getQueryResult(e)};o.prototype._getTimeQueryAvailability=function(e){var t=this._caps.timerQuery;if(t.getQueryObjectEXT){return t.getQueryObjectEXT(e,t.QUERY_RESULT_AVAILABLE_EXT)}return this.isQueryResultAvailable(e)};o.prototype.startTimeQuery=function(){var t=this._caps.timerQuery;if(!t){return null}var i=new e._TimeToken;this._gl.getParameter(t.GPU_DISJOINT_EXT);if(this._caps.canUseTimestampForTimerQuery){i._startTimeQuery=this._createTimeQuery();t.queryCounterEXT(i._startTimeQuery,t.TIMESTAMP_EXT)}else{if(this._currentNonTimestampToken){return this._currentNonTimestampToken}i._timeElapsedQuery=this._createTimeQuery();if(t.beginQueryEXT){t.beginQueryEXT(t.TIME_ELAPSED_EXT,i._timeElapsedQuery)}else{this._gl.beginQuery(t.TIME_ELAPSED_EXT,i._timeElapsedQuery)}this._currentNonTimestampToken=i}return i};o.prototype.endTimeQuery=function(e){var t=this._caps.timerQuery;if(!t||!e){return-1}if(this._caps.canUseTimestampForTimerQuery){if(!e._startTimeQuery){return-1}if(!e._endTimeQuery){e._endTimeQuery=this._createTimeQuery();t.queryCounterEXT(e._endTimeQuery,t.TIMESTAMP_EXT)}}else if(!e._timeElapsedQueryEnded){if(!e._timeElapsedQuery){return-1}if(t.endQueryEXT){t.endQueryEXT(t.TIME_ELAPSED_EXT)}else{this._gl.endQuery(t.TIME_ELAPSED_EXT)}e._timeElapsedQueryEnded=true}var i=this._gl.getParameter(t.GPU_DISJOINT_EXT);var r=false;if(e._endTimeQuery){r=this._getTimeQueryAvailability(e._endTimeQuery)}else if(e._timeElapsedQuery){r=this._getTimeQueryAvailability(e._timeElapsedQuery)}if(r&&!i){var n=0;if(this._caps.canUseTimestampForTimerQuery){if(!e._startTimeQuery||!e._endTimeQuery){return-1}var o=this._getTimeQueryResult(e._startTimeQuery);var s=this._getTimeQueryResult(e._endTimeQuery);n=s-o;this._deleteTimeQuery(e._startTimeQuery);this._deleteTimeQuery(e._endTimeQuery);e._startTimeQuery=null;e._endTimeQuery=null}else{if(!e._timeElapsedQuery){return-1}n=this._getTimeQueryResult(e._timeElapsedQuery);this._deleteTimeQuery(e._timeElapsedQuery);e._timeElapsedQuery=null;e._timeElapsedQueryEnded=false;this._currentNonTimestampToken=null}return n}return-1};o.prototype.getGlAlgorithmType=function(t){return t===e.AbstractMesh.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED};o.prototype.createTransformFeedback=function(){return this._gl.createTransformFeedback()};o.prototype.deleteTransformFeedback=function(e){this._gl.deleteTransformFeedback(e)};o.prototype.bindTransformFeedback=function(e){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,e)};o.prototype.beginTransformFeedback=function(e){if(e===void 0){e=true}this._gl.beginTransformFeedback(e?this._gl.POINTS:this._gl.TRIANGLES)};o.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()};o.prototype.setTranformFeedbackVaryings=function(e,t){this._gl.transformFeedbackVaryings(e,t,this._gl.INTERLEAVED_ATTRIBS)};o.prototype.bindTransformFeedbackBuffer=function(e){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e)};o.prototype._loadFile=function(t,i,r,n,o,s){var a=this;var u=e.Tools.LoadFile(t,i,r,n,o,s);this._activeRequests.push(u);u.onCompleteObservable.add(function(e){a._activeRequests.splice(a._activeRequests.indexOf(e),1)});return u};o.prototype._loadFileAsync=function(e,t,i){var r=this;return new Promise(function(n,o){r._loadFile(e,function(e){n(e)},undefined,t,i,function(e,t){o(t)})})};o.prototype._partialLoadFile=function(e,t,i,r,n,o){if(o===void 0){o=null}var s=function(e){i[t]=e;i._internalCount++;if(i._internalCount===6){n(i)}};var a=function(e,t){if(o&&e){o(e.status+" "+e.statusText,t)}};this._loadFile(e,s,undefined,undefined,true,a)};o.prototype._cascadeLoadFiles=function(e,t,i,r){if(r===void 0){r=null}var n=[];n._internalCount=0;for(var o=0;o<6;o++){this._partialLoadFile(i[o],o,n,e,t,r)}};o.isSupported=function(){try{var e=document.createElement("canvas");var t=e.getContext("webgl")||e.getContext("experimental-webgl");return t!=null&&!!window.WebGLRenderingContext}catch(e){return false}};o.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Macintosh",capture:null,captureConstraint:null,targets:["textureBindingOptimization"]},{key:"iPhone",capture:null,captureConstraint:null,targets:["textureBindingOptimization"]},{key:"iPad",capture:null,captureConstraint:null,targets:["textureBindingOptimization"]}];o.Instances=new Array;o._ALPHA_DISABLE=0;o._ALPHA_ADD=1;o._ALPHA_COMBINE=2;o._ALPHA_SUBTRACT=3
;o._ALPHA_MULTIPLY=4;o._ALPHA_MAXIMIZED=5;o._ALPHA_ONEONE=6;o._ALPHA_PREMULTIPLIED=7;o._ALPHA_PREMULTIPLIED_PORTERDUFF=8;o._ALPHA_INTERPOLATE=9;o._ALPHA_SCREENMODE=10;o._DELAYLOADSTATE_NONE=0;o._DELAYLOADSTATE_LOADED=1;o._DELAYLOADSTATE_LOADING=2;o._DELAYLOADSTATE_NOTLOADED=4;o._TEXTUREFORMAT_ALPHA=0;o._TEXTUREFORMAT_LUMINANCE=1;o._TEXTUREFORMAT_LUMINANCE_ALPHA=2;o._TEXTUREFORMAT_RGB=4;o._TEXTUREFORMAT_RGBA=5;o._TEXTUREFORMAT_R32F=6;o._TEXTUREFORMAT_RG32F=7;o._TEXTUREFORMAT_RGB32F=8;o._TEXTUREFORMAT_RGBA32F=9;o._TEXTURETYPE_UNSIGNED_INT=0;o._TEXTURETYPE_FLOAT=1;o._TEXTURETYPE_HALF_FLOAT=2;o._NEVER=512;o._ALWAYS=519;o._LESS=513;o._EQUAL=514;o._LEQUAL=515;o._GREATER=516;o._GEQUAL=518;o._NOTEQUAL=517;o._KEEP=7680;o._REPLACE=7681;o._INCR=7682;o._DECR=7683;o._INVERT=5386;o._INCR_WRAP=34055;o._DECR_WRAP=34056;o._SCALEMODE_FLOOR=1;o._SCALEMODE_NEAREST=2;o._SCALEMODE_CEILING=3;o.CollisionsEpsilon=.001;o.CodeRepository="src/";o.ShadersRepository="src/Shaders/";return o}();e.Engine=f})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i){if(i===void 0){i=null}this.state="";this.metadata=null;this.doNotSerialize=false;this._isDisposed=false;this.animations=new Array;this._ranges={};this._isEnabled=true;this._isReady=true;this._currentRenderId=-1;this._parentRenderId=-1;this._childRenderId=-1;this._animationPropertiesOverride=null;this.onDisposeObservable=new e.Observable;this._behaviors=new Array;this.name=t;this.id=t;this._scene=i||e.Engine.LastCreatedScene;this.uniqueId=this._scene.getUniqueId();this._initCache()}t.prototype.isDisposed=function(){return this._isDisposed};Object.defineProperty(t.prototype,"parent",{get:function(){return this._parentNode},set:function(e){if(this._parentNode===e){return}if(this._parentNode&&this._parentNode._children!==undefined&&this._parentNode._children!==null){var t=this._parentNode._children.indexOf(this);if(t!==-1){this._parentNode._children.splice(t,1)}}this._parentNode=e;if(this._parentNode){if(this._parentNode._children===undefined||this._parentNode._children===null){this._parentNode._children=new Array}this._parentNode._children.push(this)}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e},enumerable:true,configurable:true});t.prototype.getClassName=function(){return"Node"};Object.defineProperty(t.prototype,"onDispose",{set:function(e){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:true,configurable:true});t.prototype.getScene=function(){return this._scene};t.prototype.getEngine=function(){return this._scene.getEngine()};t.prototype.addBehavior=function(e){var t=this;var i=this._behaviors.indexOf(e);if(i!==-1){return this}e.init();if(this._scene.isLoading){var r=this._scene.onDataLoadedObservable.add(function(){e.attach(t);setTimeout(function(){t._scene.onDataLoadedObservable.remove(r)},0)})}else{e.attach(this)}this._behaviors.push(e);return this};t.prototype.removeBehavior=function(e){var t=this._behaviors.indexOf(e);if(t===-1){return this}this._behaviors[t].detach();this._behaviors.splice(t,1);return this};Object.defineProperty(t.prototype,"behaviors",{get:function(){return this._behaviors},enumerable:true,configurable:true});t.prototype.getBehaviorByName=function(e){for(var t=0,i=this._behaviors;t<i.length;t++){var r=i[t];if(r.name===e){return r}}return null};t.prototype.getWorldMatrix=function(){return e.Matrix.Identity()};t.prototype._initCache=function(){this._cache={};this._cache.parent=undefined};t.prototype.updateCache=function(e){if(!e&&this.isSynchronized())return;this._cache.parent=this.parent;this._updateCache()};t.prototype._updateCache=function(e){};t.prototype._isSynchronized=function(){return true};t.prototype._markSyncedWithParent=function(){if(this.parent){this._parentRenderId=this.parent._childRenderId}};t.prototype.isSynchronizedWithParent=function(){if(!this.parent){return true}if(this._parentRenderId!==this.parent._childRenderId){return false}return this.parent.isSynchronized()};t.prototype.isSynchronized=function(e){var t=this.hasNewParent();t=t||!this.isSynchronizedWithParent();t=t||!this._isSynchronized();if(e)this.updateCache(true);return!t};t.prototype.hasNewParent=function(e){if(this._cache.parent===this.parent)return false;if(e)this._cache.parent=this.parent;return true};t.prototype.isReady=function(e){if(e===void 0){e=false}return this._isReady};t.prototype.isEnabled=function(e){if(e===void 0){e=true}if(e===false){return this._isEnabled}if(this._isEnabled===false){return false}if(this.parent!==undefined&&this.parent!==null){return this.parent.isEnabled(e)}return true};t.prototype.setEnabled=function(e){this._isEnabled=e};t.prototype.isDescendantOf=function(e){if(this.parent){if(this.parent===e){return true}return this.parent.isDescendantOf(e)}return false};t.prototype._getDescendants=function(e,t,i){if(t===void 0){t=false}if(!this._children){return}for(var r=0;r<this._children.length;r++){var n=this._children[r];if(!i||i(n)){e.push(n)}if(!t){n._getDescendants(e,false,i)}}};t.prototype.getDescendants=function(e,t){var i=new Array;this._getDescendants(i,e,t);return i};t.prototype.getChildMeshes=function(t,i){var r=[];this._getDescendants(r,t,function(t){return(!i||i(t))&&t instanceof e.AbstractMesh});return r};t.prototype.getChildTransformNodes=function(t,i){var r=[];this._getDescendants(r,t,function(t){return(!i||i(t))&&t instanceof e.TransformNode});return r};t.prototype.getChildren=function(e){return this.getDescendants(true,e)};t.prototype._setReady=function(e){if(e===this._isReady){return}if(!e){this._isReady=false;return}if(this.onReady){this.onReady(this)}this._isReady=true};t.prototype.getAnimationByName=function(e){for(var t=0;t<this.animations.length;t++){var i=this.animations[t];if(i.name===e){return i}}return null};t.prototype.createAnimationRange=function(t,i,r){if(!this._ranges[t]){this._ranges[t]=new e.AnimationRange(t,i,r);for(var n=0,o=this.animations.length;n<o;n++){if(this.animations[n]){this.animations[n].createRange(t,i,r)}}}};t.prototype.deleteAnimationRange=function(e,t){if(t===void 0){t=true}for(var i=0,r=this.animations.length;i<r;i++){if(this.animations[i]){this.animations[i].deleteRange(e,t)}}this._ranges[e]=null};t.prototype.getAnimationRange=function(e){return this._ranges[e]};t.prototype.beginAnimation=function(e,t,i,r){var n=this.getAnimationRange(e);if(!n){return null}return this._scene.beginAnimation(this,n.from,n.to,t,i,r)};t.prototype.serializeAnimationRanges=function(){var e=[];for(var t in this._ranges){var i=this._ranges[t];if(!i){continue}var r={};r.name=t;r.from=i.from;r.to=i.to;e.push(r)}return e};t.prototype.computeWorldMatrix=function(t){return e.Matrix.Identity()};t.prototype.dispose=function(e,t){if(t===void 0){t=false}if(!e){var i=this.getDescendants(true);for(var r=0,n=i;r<n.length;r++){var o=n[r];o.dispose(e,t)}}else{var s=this.getChildTransformNodes(true);for(var a=0,u=s;a<u.length;a++){var l=u[a];l.parent=null;l.computeWorldMatrix(true)}}this.parent=null;this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();for(var c=0,h=this._behaviors;c<h.length;c++){var f=h[c];f.detach()}this._behaviors=[];this._isDisposed=true};t.ParseAnimationRanges=function(e,t,i){if(t.ranges){for(var r=0;r<t.ranges.length;r++){var n=t.ranges[r];e.createAnimationRange(n.name,n.from,n.to)}}};__decorate([e.serialize()],t.prototype,"name",void 0);__decorate([e.serialize()],t.prototype,"id",void 0);__decorate([e.serialize()],t.prototype,"uniqueId",void 0);__decorate([e.serialize()],t.prototype,"state",void 0);__decorate([e.serialize()],t.prototype,"metadata",void 0);return t}();e.Node=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i){this.minimum=t;this.maximum=i;this._tempRadiusVector=e.Vector3.Zero();var r=e.Vector3.Distance(t,i);this.center=e.Vector3.Lerp(t,i,.5);this.radius=r*.5;this.centerWorld=e.Vector3.Zero();this._update(e.Matrix.Identity())}t.prototype._update=function(t){e.Vector3.TransformCoordinatesToRef(this.center,t,this.centerWorld);e.Vector3.TransformNormalFromFloatsToRef(1,1,1,t,this._tempRadiusVector);this.radiusWorld=Math.max(Math.abs(this._tempRadiusVector.x),Math.abs(this._tempRadiusVector.y),Math.abs(this._tempRadiusVector.z))*this.radius};t.prototype.isInFrustum=function(e){for(var t=0;t<6;t++){if(e[t].dotCoordinate(this.centerWorld)<=-this.radiusWorld)return false}return true};t.prototype.intersectsPoint=function(t){var i=this.centerWorld.x-t.x;var r=this.centerWorld.y-t.y;var n=this.centerWorld.z-t.z;var o=Math.sqrt(i*i+r*r+n*n);if(Math.abs(this.radiusWorld-o)<e.Epsilon)return false;return true};t.Intersects=function(e,t){var i=e.centerWorld.x-t.centerWorld.x;var r=e.centerWorld.y-t.centerWorld.y;var n=e.centerWorld.z-t.centerWorld.z;var o=Math.sqrt(i*i+r*r+n*n);if(e.radiusWorld+t.radiusWorld<o)return false;return true};return t}();e.BoundingSphere=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i){this.minimum=t;this.maximum=i;this.vectors=new Array;this.vectorsWorld=new Array;this.vectors.push(this.minimum.clone());this.vectors.push(this.maximum.clone());this.vectors.push(this.minimum.clone());this.vectors[2].x=this.maximum.x;this.vectors.push(this.minimum.clone());this.vectors[3].y=this.maximum.y;this.vectors.push(this.minimum.clone());this.vectors[4].z=this.maximum.z;this.vectors.push(this.maximum.clone());this.vectors[5].z=this.minimum.z;this.vectors.push(this.maximum.clone());this.vectors[6].x=this.minimum.x;this.vectors.push(this.maximum.clone());this.vectors[7].y=this.minimum.y;this.center=this.maximum.add(this.minimum).scale(.5);this.extendSize=this.maximum.subtract(this.minimum).scale(.5);this.directions=[e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero()];for(var r=0;r<this.vectors.length;r++){this.vectorsWorld[r]=e.Vector3.Zero()}this.minimumWorld=e.Vector3.Zero();this.maximumWorld=e.Vector3.Zero();this.centerWorld=e.Vector3.Zero();this.extendSizeWorld=e.Vector3.Zero();this._update(e.Matrix.Identity())}t.prototype.getWorldMatrix=function(){return this._worldMatrix};t.prototype.setWorldMatrix=function(e){this._worldMatrix.copyFrom(e);return this};t.prototype._update=function(t){e.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.minimumWorld);e.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.maximumWorld);for(var i=0;i<this.vectors.length;i++){var r=this.vectorsWorld[i];e.Vector3.TransformCoordinatesToRef(this.vectors[i],t,r);if(r.x<this.minimumWorld.x)this.minimumWorld.x=r.x;if(r.y<this.minimumWorld.y)this.minimumWorld.y=r.y;if(r.z<this.minimumWorld.z)this.minimumWorld.z=r.z;if(r.x>this.maximumWorld.x)this.maximumWorld.x=r.x;if(r.y>this.maximumWorld.y)this.maximumWorld.y=r.y;if(r.z>this.maximumWorld.z)this.maximumWorld.z=r.z}this.maximumWorld.subtractToRef(this.minimumWorld,this.extendSizeWorld);this.extendSizeWorld.scaleInPlace(.5);this.maximumWorld.addToRef(this.minimumWorld,this.centerWorld);this.centerWorld.scaleInPlace(.5);e.Vector3.FromFloatArrayToRef(t.m,0,this.directions[0]);e.Vector3.FromFloatArrayToRef(t.m,4,this.directions[1]);e.Vector3.FromFloatArrayToRef(t.m,8,this.directions[2]);this._worldMatrix=t};t.prototype.isInFrustum=function(e){return t.IsInFrustum(this.vectorsWorld,e)};t.prototype.isCompletelyInFrustum=function(e){return t.IsCompletelyInFrustum(this.vectorsWorld,e)};t.prototype.intersectsPoint=function(t){var i=-e.Epsilon;if(this.maximumWorld.x-t.x<i||i>t.x-this.minimumWorld.x)return false;if(this.maximumWorld.y-t.y<i||i>t.y-this.minimumWorld.y)return false;if(this.maximumWorld.z-t.z<i||i>t.z-this.minimumWorld.z)return false;return true};t.prototype.intersectsSphere=function(e){return t.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)};t.prototype.intersectsMinMax=function(e,t){if(this.maximumWorld.x<e.x||this.minimumWorld.x>t.x)return false;if(this.maximumWorld.y<e.y||this.minimumWorld.y>t.y)return false;if(this.maximumWorld.z<e.z||this.minimumWorld.z>t.z)return false;return true};t.Intersects=function(e,t){if(e.maximumWorld.x<t.minimumWorld.x||e.minimumWorld.x>t.maximumWorld.x)return false;if(e.maximumWorld.y<t.minimumWorld.y||e.minimumWorld.y>t.maximumWorld.y)return false;if(e.maximumWorld.z<t.minimumWorld.z||e.minimumWorld.z>t.maximumWorld.z)return false;return true};t.IntersectsSphere=function(t,i,r,n){var o=e.Vector3.Clamp(r,t,i);var s=e.Vector3.DistanceSquared(r,o);return s<=n*n};t.IsCompletelyInFrustum=function(e,t){for(var i=0;i<6;i++){for(var r=0;r<8;r++){if(t[i].dotCoordinate(e[r])<0){return false}}}return true};t.IsInFrustum=function(e,t){for(var i=0;i<6;i++){var r=8;for(var n=0;n<8;n++){if(t[i].dotCoordinate(e[n])<0){--r}else{break}}if(r===0)return false}return true};return t}();e.BoundingBox=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t,i){var r=e.Vector3.Dot(i.centerWorld,t);var n=Math.abs(e.Vector3.Dot(i.directions[0],t))*i.extendSize.x;var o=Math.abs(e.Vector3.Dot(i.directions[1],t))*i.extendSize.y;var s=Math.abs(e.Vector3.Dot(i.directions[2],t))*i.extendSize.z;var a=n+o+s;return{min:r-a,max:r+a}};var i=function(e,t,i,r){return!(e>r||i>t)};var r=function(e,r,n){var o=t(e,r);var s=t(e,n);return i(o.min,o.max,s.min,s.max)};var n=function(){function t(t,i){this.minimum=t;this.maximum=i;this._isLocked=false;this.boundingBox=new e.BoundingBox(t,i);this.boundingSphere=new e.BoundingSphere(t,i)}Object.defineProperty(t.prototype,"isLocked",{get:function(){return this._isLocked},set:function(e){this._isLocked=e},enumerable:true,configurable:true});t.prototype.update=function(e){if(this._isLocked){return}this.boundingBox._update(e);this.boundingSphere._update(e)};t.prototype.centerOn=function(t,i){this.minimum=t.subtract(i);this.maximum=t.add(i);this.boundingBox=new e.BoundingBox(this.minimum,this.maximum);this.boundingSphere=new e.BoundingSphere(this.minimum,this.maximum);return this};t.prototype.isInFrustum=function(e){if(!this.boundingSphere.isInFrustum(e))return false;return this.boundingBox.isInFrustum(e)};Object.defineProperty(t.prototype,"diagonalLength",{get:function(){var e=this.boundingBox;var t=e.maximumWorld.subtract(e.minimumWorld);return t.length()},enumerable:true,configurable:true});t.prototype.isCompletelyInFrustum=function(e){return this.boundingBox.isCompletelyInFrustum(e)};t.prototype._checkCollision=function(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)};t.prototype.intersectsPoint=function(e){if(!this.boundingSphere.centerWorld){return false}if(!this.boundingSphere.intersectsPoint(e)){return false}if(!this.boundingBox.intersectsPoint(e)){return false}return true};t.prototype.intersects=function(t,i){if(!this.boundingSphere.centerWorld||!t.boundingSphere.centerWorld){return false}if(!e.BoundingSphere.Intersects(this.boundingSphere,t.boundingSphere)){return false}if(!e.BoundingBox.Intersects(this.boundingBox,t.boundingBox)){return false}if(!i){return true}var n=this.boundingBox;var o=t.boundingBox;if(!r(n.directions[0],n,o))return false;if(!r(n.directions[1],n,o))return false;if(!r(n.directions[2],n,o))return false;if(!r(o.directions[0],n,o))return false;if(!r(o.directions[1],n,o))return false;if(!r(o.directions[2],n,o))return false;if(!r(e.Vector3.Cross(n.directions[0],o.directions[0]),n,o))return false;if(!r(e.Vector3.Cross(n.directions[0],o.directions[1]),n,o))return false;if(!r(e.Vector3.Cross(n.directions[0],o.directions[2]),n,o))return false;if(!r(e.Vector3.Cross(n.directions[1],o.directions[0]),n,o))return false;if(!r(e.Vector3.Cross(n.directions[1],o.directions[1]),n,o))return false;if(!r(e.Vector3.Cross(n.directions[1],o.directions[2]),n,o))return false;if(!r(e.Vector3.Cross(n.directions[2],o.directions[0]),n,o))return false;if(!r(e.Vector3.Cross(n.directions[2],o.directions[1]),n,o))return false;if(!r(e.Vector3.Cross(n.directions[2],o.directions[2]),n,o))return false;return true};return t}();e.BoundingInfo=n})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(r,n,o){if(n===void 0){n=null}if(o===void 0){o=true}var s=t.call(this,r,n)||this;s._forward=new e.Vector3(0,0,1);s._forwardInverted=new e.Vector3(0,0,-1);s._up=new e.Vector3(0,1,0);s._right=new e.Vector3(1,0,0);s._rightInverted=new e.Vector3(-1,0,0);s._rotation=e.Vector3.Zero();s._scaling=e.Vector3.One();s._isDirty=false;s.billboardMode=i.BILLBOARDMODE_NONE;s.scalingDeterminant=1;s.infiniteDistance=false;s.position=e.Vector3.Zero();s._localWorld=e.Matrix.Zero();s._worldMatrix=e.Matrix.Zero();s._worldMatrixDeterminant=0;s._absolutePosition=e.Vector3.Zero();s._pivotMatrix=e.Matrix.Identity();s._postMultiplyPivotMatrix=false;s._isWorldMatrixFrozen=false;s.onAfterWorldMatrixUpdateObservable=new e.Observable;s._nonUniformScaling=false;if(o){s.getScene().addTransformNode(s)}return s}i.prototype.getClassName=function(){return"TransformNode"};Object.defineProperty(i.prototype,"rotation",{get:function(){return this._rotation},set:function(e){this._rotation=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"scaling",{get:function(){return this._scaling},set:function(e){this._scaling=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rotationQuaternion",{get:function(){return this._rotationQuaternion},set:function(e){this._rotationQuaternion=e;if(e&&this.rotation.length()){this.rotation.copyFromFloats(0,0,0)}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"forward",{get:function(){return e.Vector3.Normalize(e.Vector3.TransformNormal(this.getScene().useRightHandedSystem?this._forwardInverted:this._forward,this.getWorldMatrix()))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"up",{get:function(){return e.Vector3.Normalize(e.Vector3.TransformNormal(this._up,this.getWorldMatrix()))},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"right",{get:function(){return e.Vector3.Normalize(e.Vector3.TransformNormal(this.getScene().useRightHandedSystem?this._rightInverted:this._right,this.getWorldMatrix()))},enumerable:true,configurable:true});i.prototype.getWorldMatrix=function(){if(this._currentRenderId!==this.getScene().getRenderId()){this.computeWorldMatrix()}return this._worldMatrix};i.prototype._getWorldMatrixDeterminant=function(){return this._worldMatrixDeterminant};Object.defineProperty(i.prototype,"worldMatrixFromCache",{get:function(){return this._worldMatrix},enumerable:true,configurable:true});i.prototype.updatePoseMatrix=function(e){this._poseMatrix.copyFrom(e);return this};i.prototype.getPoseMatrix=function(){return this._poseMatrix};i.prototype._isSynchronized=function(){if(this._isDirty){return false}if(this.billboardMode!==this._cache.billboardMode||this.billboardMode!==i.BILLBOARDMODE_NONE)return false;if(this._cache.pivotMatrixUpdated){return false}if(this.infiniteDistance){return false}if(!this._cache.position.equals(this.position))return false;if(this.rotationQuaternion){if(!this._cache.rotationQuaternion.equals(this.rotationQuaternion))return false}if(!this._cache.rotation.equals(this.rotation))return false;if(!this._cache.scaling.equals(this.scaling))return false;return true};i.prototype._initCache=function(){t.prototype._initCache.call(this);this._cache.localMatrixUpdated=false;this._cache.position=e.Vector3.Zero();this._cache.scaling=e.Vector3.Zero();this._cache.rotation=e.Vector3.Zero();this._cache.rotationQuaternion=new e.Quaternion(0,0,0,0);this._cache.billboardMode=-1};i.prototype.markAsDirty=function(e){if(e==="rotation"){this.rotationQuaternion=null}this._currentRenderId=Number.MAX_VALUE;this._isDirty=true;return this};Object.defineProperty(i.prototype,"absolutePosition",{get:function(){return this._absolutePosition},enumerable:true,configurable:true});i.prototype.setPreTransformMatrix=function(e){return this.setPivotMatrix(e,false)};i.prototype.setPivotMatrix=function(t,i){if(i===void 0){i=true}this._pivotMatrix=t.clone();this._cache.pivotMatrixUpdated=true;this._postMultiplyPivotMatrix=i;if(this._postMultiplyPivotMatrix){if(!this._pivotMatrixInverse){this._pivotMatrixInverse=e.Matrix.Invert(this._pivotMatrix)}else{this._pivotMatrix.invertToRef(this._pivotMatrixInverse)}}return this};i.prototype.getPivotMatrix=function(){return this._pivotMatrix};i.prototype.freezeWorldMatrix=function(){this._isWorldMatrixFrozen=false;this.computeWorldMatrix(true);this._isWorldMatrixFrozen=true;return this};i.prototype.unfreezeWorldMatrix=function(){this._isWorldMatrixFrozen=false;this.computeWorldMatrix(true);return this};Object.defineProperty(i.prototype,"isWorldMatrixFrozen",{get:function(){return this._isWorldMatrixFrozen},enumerable:true,configurable:true});i.prototype.getAbsolutePosition=function(){this.computeWorldMatrix();return this._absolutePosition};i.prototype.setAbsolutePosition=function(t){if(!t){return this}var i;var r;var n;if(t.x===undefined){if(arguments.length<3){return this}i=arguments[0];r=arguments[1];n=arguments[2]}else{i=t.x;r=t.y;n=t.z}if(this.parent){var o=this.parent.getWorldMatrix().clone();o.invert();var s=new e.Vector3(i,r,n);this.position=e.Vector3.TransformCoordinates(s,o)}else{this.position.x=i;this.position.y=r;this.position.z=n}return this};i.prototype.setPositionWithLocalVector=function(t){this.computeWorldMatrix();this.position=e.Vector3.TransformNormal(t,this._localWorld);return this};i.prototype.getPositionExpressedInLocalSpace=function(){this.computeWorldMatrix();var t=this._localWorld.clone();t.invert();return e.Vector3.TransformNormal(this.position,t)};i.prototype.locallyTranslate=function(t){this.computeWorldMatrix(true);this.position=e.Vector3.TransformCoordinates(t,this._localWorld);return this};i.prototype.lookAt=function(t,r,n,o,s){if(r===void 0){r=0}if(n===void 0){n=0}if(o===void 0){o=0}if(s===void 0){s=e.Space.LOCAL}var a=i._lookAtVectorCache;var u=s===e.Space.LOCAL?this.position:this.getAbsolutePosition();t.subtractToRef(u,a);var l=-Math.atan2(a.z,a.x)-Math.PI/2;var c=Math.sqrt(a.x*a.x+a.z*a.z);var h=Math.atan2(a.y,c);if(this.rotationQuaternion){e.Quaternion.RotationYawPitchRollToRef(l+r,h+n,o,this.rotationQuaternion)}else{this.rotation.x=h+n;this.rotation.y=l+r;this.rotation.z=o}return this};i.prototype.getDirection=function(t){var i=e.Vector3.Zero();this.getDirectionToRef(t,i);return i};i.prototype.getDirectionToRef=function(t,i){e.Vector3.TransformNormalToRef(t,this.getWorldMatrix(),i);return this};i.prototype.setPivotPoint=function(t,i){if(i===void 0){i=e.Space.LOCAL}if(this.getScene().getRenderId()==0){this.computeWorldMatrix(true)}var r=this.getWorldMatrix();if(i==e.Space.WORLD){var n=e.Tmp.Matrix[0];r.invertToRef(n);t=e.Vector3.TransformCoordinates(t,n)}return this.setPivotMatrix(e.Matrix.Translation(-t.x,-t.y,-t.z),true)};i.prototype.getPivotPoint=function(){var t=e.Vector3.Zero();this.getPivotPointToRef(t);return t};i.prototype.getPivotPointToRef=function(e){e.x=-this._pivotMatrix.m[12];e.y=-this._pivotMatrix.m[13];e.z=-this._pivotMatrix.m[14];return this};i.prototype.getAbsolutePivotPoint=function(){var t=e.Vector3.Zero();this.getAbsolutePivotPointToRef(t);return t};i.prototype.getAbsolutePivotPointToRef=function(t){t.x=this._pivotMatrix.m[12];t.y=this._pivotMatrix.m[13];t.z=this._pivotMatrix.m[14];this.getPivotPointToRef(t);e.Vector3.TransformCoordinatesToRef(t,this.getWorldMatrix(),t);return this};i.prototype.setParent=function(t){if(t===null){var i=e.Tmp.Quaternion[0];var r=e.Tmp.Vector3[0];var n=e.Tmp.Vector3[1];if(this.parent&&this.parent.computeWorldMatrix){this.parent.computeWorldMatrix(true)}this.computeWorldMatrix(true);this.getWorldMatrix().decompose(n,i,r);if(this.rotationQuaternion){this.rotationQuaternion.copyFrom(i)}else{i.toEulerAnglesToRef(this.rotation)}this.scaling.x=n.x;this.scaling.y=n.y;this.scaling.z=n.z;this.position.x=r.x;this.position.y=r.y;this.position.z=r.z}else{var i=e.Tmp.Quaternion[0];var r=e.Tmp.Vector3[0];var n=e.Tmp.Vector3[1];var o=e.Tmp.Matrix[0];var s=e.Tmp.Matrix[1];this.computeWorldMatrix(true);t.computeWorldMatrix(true);t.getWorldMatrix().invertToRef(s);this.getWorldMatrix().multiplyToRef(s,o);o.decompose(n,i,r);if(this.rotationQuaternion){this.rotationQuaternion.copyFrom(i)}else{i.toEulerAnglesToRef(this.rotation)}this.position.x=r.x;this.position.y=r.y;this.position.z=r.z;this.scaling.x=n.x;this.scaling.y=n.y;this.scaling.z=n.z}this.parent=t;return this};Object.defineProperty(i.prototype,"nonUniformScaling",{get:function(){return this._nonUniformScaling},enumerable:true,configurable:true});i.prototype._updateNonUniformScalingState=function(e){if(this._nonUniformScaling===e){return false}this._nonUniformScaling=true;return true};i.prototype.attachToBone=function(e,t){this._transformToBoneReferal=t;this.parent=e;if(e.getWorldMatrix().determinant()<0){this.scalingDeterminant*=-1}return this};i.prototype.detachFromBone=function(){if(!this.parent){return this}if(this.parent.getWorldMatrix().determinant()<0){this.scalingDeterminant*=-1}this._transformToBoneReferal=null;this.parent=null;return this};i.prototype.rotate=function(t,r,n){t.normalize();if(!this.rotationQuaternion){this.rotationQuaternion=e.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z);this.rotation=e.Vector3.Zero()}var o;if(!n||n===e.Space.LOCAL){o=e.Quaternion.RotationAxisToRef(t,r,i._rotationAxisCache);this.rotationQuaternion.multiplyToRef(o,this.rotationQuaternion)}else{if(this.parent){var s=this.parent.getWorldMatrix().clone();s.invert();t=e.Vector3.TransformNormal(t,s)}o=e.Quaternion.RotationAxisToRef(t,r,i._rotationAxisCache);o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this};i.prototype.rotateAround=function(t,i,r){i.normalize();if(!this.rotationQuaternion){this.rotationQuaternion=e.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z);this.rotation.copyFromFloats(0,0,0)}t.subtractToRef(this.position,e.Tmp.Vector3[0]);e.Matrix.TranslationToRef(e.Tmp.Vector3[0].x,e.Tmp.Vector3[0].y,e.Tmp.Vector3[0].z,e.Tmp.Matrix[0]);e.Tmp.Matrix[0].invertToRef(e.Tmp.Matrix[2]);e.Matrix.RotationAxisToRef(i,r,e.Tmp.Matrix[1]);e.Tmp.Matrix[2].multiplyToRef(e.Tmp.Matrix[1],e.Tmp.Matrix[2]);e.Tmp.Matrix[2].multiplyToRef(e.Tmp.Matrix[0],e.Tmp.Matrix[2]);e.Tmp.Matrix[2].decompose(e.Tmp.Vector3[0],e.Tmp.Quaternion[0],e.Tmp.Vector3[1]);this.position.addInPlace(e.Tmp.Vector3[1]);e.Tmp.Quaternion[0].multiplyToRef(this.rotationQuaternion,this.rotationQuaternion);return this};i.prototype.translate=function(t,i,r){var n=t.scale(i);if(!r||r===e.Space.LOCAL){var o=this.getPositionExpressedInLocalSpace().add(n);this.setPositionWithLocalVector(o)}else{this.setAbsolutePosition(this.getAbsolutePosition().add(n))}return this};i.prototype.addRotation=function(t,i,r){var n;if(this.rotationQuaternion){n=this.rotationQuaternion}else{n=e.Tmp.Quaternion[1];e.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,n)}var o=e.Tmp.Quaternion[0];e.Quaternion.RotationYawPitchRollToRef(i,t,r,o);n.multiplyInPlace(o);if(!this.rotationQuaternion){n.toEulerAnglesToRef(this.rotation)}return this};i.prototype.computeWorldMatrix=function(t){if(this._isWorldMatrixFrozen){return this._worldMatrix}if(!t&&this.isSynchronized(true)){this._currentRenderId=this.getScene().getRenderId();return this._worldMatrix}this._cache.position.copyFrom(this.position);this._cache.scaling.copyFrom(this.scaling);this._cache.pivotMatrixUpdated=false;this._cache.billboardMode=this.billboardMode;this._currentRenderId=this.getScene().getRenderId();this._childRenderId=this.getScene().getRenderId();this._isDirty=false;e.Matrix.ScalingToRef(this.scaling.x*this.scalingDeterminant,this.scaling.y*this.scalingDeterminant,this.scaling.z*this.scalingDeterminant,e.Tmp.Matrix[1]);if(this.rotationQuaternion){var r=this.rotation.length();if(r){this.rotationQuaternion.multiplyInPlace(e.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z));this.rotation.copyFromFloats(0,0,0)}}if(this.rotationQuaternion){this.rotationQuaternion.toRotationMatrix(e.Tmp.Matrix[0]);this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}else{e.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,e.Tmp.Matrix[0]);this._cache.rotation.copyFrom(this.rotation)}var n=this.getScene().activeCamera;if(this.infiniteDistance&&!this.parent&&n){var o=n.getWorldMatrix();var s=new e.Vector3(o.m[12],o.m[13],o.m[14]);e.Matrix.TranslationToRef(this.position.x+s.x,this.position.y+s.y,this.position.z+s.z,e.Tmp.Matrix[2])}else{e.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,e.Tmp.Matrix[2])}this._pivotMatrix.multiplyToRef(e.Tmp.Matrix[1],e.Tmp.Matrix[4]);e.Tmp.Matrix[4].multiplyToRef(e.Tmp.Matrix[0],e.Tmp.Matrix[5]);if(this.billboardMode!==i.BILLBOARDMODE_NONE&&n){if((this.billboardMode&i.BILLBOARDMODE_ALL)!==i.BILLBOARDMODE_ALL){var a=e.Tmp.Vector3[3];if(this.parent&&this.parent.getWorldMatrix){if(this._transformToBoneReferal){this.parent.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),e.Tmp.Matrix[6]);e.Vector3.TransformCoordinatesToRef(this.position,e.Tmp.Matrix[6],a)}else{e.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),a)}}else{a.copyFrom(this.position)}a.subtractInPlace(n.globalPosition);var u=e.Tmp.Vector3[4].copyFromFloats(0,0,0);if((this.billboardMode&i.BILLBOARDMODE_X)===i.BILLBOARDMODE_X){u.x=Math.atan2(-a.y,a.z)}if((this.billboardMode&i.BILLBOARDMODE_Y)===i.BILLBOARDMODE_Y){u.y=Math.atan2(a.x,a.z)}if((this.billboardMode&i.BILLBOARDMODE_Z)===i.BILLBOARDMODE_Z){u.z=Math.atan2(a.y,a.x)}e.Matrix.RotationYawPitchRollToRef(u.y,u.x,u.z,e.Tmp.Matrix[0])}else{e.Tmp.Matrix[1].copyFrom(n.getViewMatrix());e.Tmp.Matrix[1].setTranslationFromFloats(0,0,0);e.Tmp.Matrix[1].invertToRef(e.Tmp.Matrix[0])}e.Tmp.Matrix[1].copyFrom(e.Tmp.Matrix[5]);e.Tmp.Matrix[1].multiplyToRef(e.Tmp.Matrix[0],e.Tmp.Matrix[5])}e.Tmp.Matrix[5].multiplyToRef(e.Tmp.Matrix[2],this._localWorld);if(this.parent&&this.parent.getWorldMatrix){if(this.billboardMode!==i.BILLBOARDMODE_NONE){if(this._transformToBoneReferal){this.parent.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),e.Tmp.Matrix[6]);e.Tmp.Matrix[5].copyFrom(e.Tmp.Matrix[6])}else{e.Tmp.Matrix[5].copyFrom(this.parent.getWorldMatrix())}this._localWorld.getTranslationToRef(e.Tmp.Vector3[5]);e.Vector3.TransformCoordinatesToRef(e.Tmp.Vector3[5],e.Tmp.Matrix[5],e.Tmp.Vector3[5]);this._worldMatrix.copyFrom(this._localWorld);this._worldMatrix.setTranslation(e.Tmp.Vector3[5])}else{if(this._transformToBoneReferal){this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),e.Tmp.Matrix[6]);e.Tmp.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else{this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix)}}this._markSyncedWithParent()}else{this._worldMatrix.copyFrom(this._localWorld)}if(this._postMultiplyPivotMatrix){this._worldMatrix.multiplyToRef(this._pivotMatrixInverse,this._worldMatrix)}if(this.scaling.isNonUniform){this._updateNonUniformScalingState(true)}else if(this.parent&&this.parent._nonUniformScaling){this._updateNonUniformScalingState(this.parent._nonUniformScaling)}else{this._updateNonUniformScalingState(false)}this._afterComputeWorldMatrix();this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]);this.onAfterWorldMatrixUpdateObservable.notifyObservers(this);if(!this._poseMatrix){this._poseMatrix=e.Matrix.Invert(this._worldMatrix)}this._worldMatrixDeterminant=this._worldMatrix.determinant();return this._worldMatrix};i.prototype._afterComputeWorldMatrix=function(){};i.prototype.registerAfterWorldMatrixUpdate=function(e){this.onAfterWorldMatrixUpdateObservable.add(e)
;return this};i.prototype.unregisterAfterWorldMatrixUpdate=function(e){this.onAfterWorldMatrixUpdateObservable.removeCallback(e);return this};i.prototype.clone=function(t,r,n){var o=this;var s=e.SerializationHelper.Clone(function(){return new i(t,o.getScene())},this);s.name=t;s.id=t;if(r){s.parent=r}if(!n){var a=this.getDescendants(true);for(var u=0;u<a.length;u++){var l=a[u];if(l.clone){l.clone(t+"."+l.name,s)}}}return s};i.prototype.serialize=function(t){var i=e.SerializationHelper.Serialize(this,t);i.type=this.getClassName();if(this.parent){i.parentId=this.parent.id}if(e.Tags&&e.Tags.HasTags(this)){i.tags=e.Tags.GetTags(this)}i.localMatrix=this.getPivotMatrix().asArray();i.isEnabled=this.isEnabled();if(this.parent){i.parentId=this.parent.id}return i};i.Parse=function(t,r,n){var o=e.SerializationHelper.Parse(function(){return new i(t.name,r)},t,r,n);if(e.Tags){e.Tags.AddTagsTo(o,t.tags)}if(t.localMatrix){o.setPreTransformMatrix(e.Matrix.FromArray(t.localMatrix))}else if(t.pivotMatrix){o.setPivotMatrix(e.Matrix.FromArray(t.pivotMatrix))}o.setEnabled(t.isEnabled);if(t.parentId){o._waitingParentId=t.parentId}return o};i.prototype.dispose=function(e,i){if(i===void 0){i=false}this.getScene().stopAnimation(this);this.getScene().removeTransformNode(this);this.onAfterWorldMatrixUpdateObservable.clear();t.prototype.dispose.call(this,e,i)};i.BILLBOARDMODE_NONE=0;i.BILLBOARDMODE_X=1;i.BILLBOARDMODE_Y=2;i.BILLBOARDMODE_Z=4;i.BILLBOARDMODE_ALL=7;i._lookAtVectorCache=new e.Vector3(0,0,0);i._rotationAxisCache=new e.Quaternion;__decorate([e.serializeAsVector3()],i.prototype,"_rotation",void 0);__decorate([e.serializeAsQuaternion()],i.prototype,"_rotationQuaternion",void 0);__decorate([e.serializeAsVector3()],i.prototype,"_scaling",void 0);__decorate([e.serialize()],i.prototype,"billboardMode",void 0);__decorate([e.serialize()],i.prototype,"scalingDeterminant",void 0);__decorate([e.serialize()],i.prototype,"infiniteDistance",void 0);__decorate([e.serializeAsVector3()],i.prototype,"position",void 0);return i}(e.Node);e.TransformNode=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(r,n){if(n===void 0){n=null}var o=t.call(this,r,n,false)||this;o._facetNb=0;o._partitioningSubdivisions=10;o._partitioningBBoxRatio=1.01;o._facetDataEnabled=false;o._facetParameters={};o._bbSize=e.Vector3.Zero();o._subDiv={max:1,X:1,Y:1,Z:1};o._facetDepthSort=false;o._facetDepthSortEnabled=false;o.onCollideObservable=new e.Observable;o.onCollisionPositionChangeObservable=new e.Observable;o.onMaterialChangedObservable=new e.Observable;o.definedFacingForward=true;o.occlusionQueryAlgorithmType=i.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE;o.occlusionType=i.OCCLUSION_TYPE_NONE;o.occlusionRetryCount=-1;o._occlusionInternalRetryCounter=0;o._isOccluded=false;o._isOcclusionQueryInProgress=false;o._visibility=1;o.alphaIndex=Number.MAX_VALUE;o.isVisible=true;o.isPickable=true;o.showBoundingBox=false;o.showSubMeshesBoundingBox=false;o.isBlocker=false;o.enablePointerMoveEvents=false;o.renderingGroupId=0;o._receiveShadows=false;o.renderOutline=false;o.outlineColor=e.Color3.Red();o.outlineWidth=.02;o.renderOverlay=false;o.overlayColor=e.Color3.Red();o.overlayAlpha=.5;o._hasVertexAlpha=false;o._useVertexColors=true;o._computeBonesUsingShaders=true;o._numBoneInfluencers=4;o._applyFog=true;o.useOctreeForRenderingSelection=true;o.useOctreeForPicking=true;o.useOctreeForCollisions=true;o._layerMask=268435455;o.alwaysSelectAsActiveMesh=false;o.actionManager=null;o.physicsImpostor=null;o._checkCollisions=false;o._collisionMask=-1;o._collisionGroup=-1;o.ellipsoid=new e.Vector3(.5,1,.5);o.ellipsoidOffset=new e.Vector3(0,0,0);o._oldPositionForCollisions=new e.Vector3(0,0,0);o._diffPositionForCollisions=new e.Vector3(0,0,0);o.edgesWidth=1;o.edgesColor=new e.Color4(1,0,0,1);o._collisionsTransformMatrix=e.Matrix.Zero();o._collisionsScalingMatrix=e.Matrix.Zero();o._renderId=0;o._intersectionsInProgress=new Array;o._unIndexed=false;o._lightSources=new Array;o._onCollisionPositionChange=function(t,i,r){if(r===void 0){r=null}if(o.getScene().workerCollisions)i.multiplyInPlace(o._collider._radius);i.subtractToRef(o._oldPositionForCollisions,o._diffPositionForCollisions);if(o._diffPositionForCollisions.length()>e.Engine.CollisionsEpsilon){o.position.addInPlace(o._diffPositionForCollisions)}if(r){o.onCollideObservable.notifyObservers(r)}o.onCollisionPositionChangeObservable.notifyObservers(o.position)};o.getScene().addMesh(o);o._resyncLightSources();return o}Object.defineProperty(i,"BILLBOARDMODE_NONE",{get:function(){return e.TransformNode.BILLBOARDMODE_NONE},enumerable:true,configurable:true});Object.defineProperty(i,"BILLBOARDMODE_X",{get:function(){return e.TransformNode.BILLBOARDMODE_X},enumerable:true,configurable:true});Object.defineProperty(i,"BILLBOARDMODE_Y",{get:function(){return e.TransformNode.BILLBOARDMODE_Y},enumerable:true,configurable:true});Object.defineProperty(i,"BILLBOARDMODE_Z",{get:function(){return e.TransformNode.BILLBOARDMODE_Z},enumerable:true,configurable:true});Object.defineProperty(i,"BILLBOARDMODE_ALL",{get:function(){return e.TransformNode.BILLBOARDMODE_ALL},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"facetNb",{get:function(){return this._facetNb},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"partitioningSubdivisions",{get:function(){return this._partitioningSubdivisions},set:function(e){this._partitioningSubdivisions=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"partitioningBBoxRatio",{get:function(){return this._partitioningBBoxRatio},set:function(e){this._partitioningBBoxRatio=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"mustDepthSortFacets",{get:function(){return this._facetDepthSort},set:function(e){this._facetDepthSort=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"facetDepthSortFrom",{get:function(){return this._facetDepthSortFrom},set:function(e){this._facetDepthSortFrom=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"isFacetDataEnabled",{get:function(){return this._facetDataEnabled},enumerable:true,configurable:true});i.prototype._updateNonUniformScalingState=function(e){if(!t.prototype._updateNonUniformScalingState.call(this,e)){return false}this._markSubMeshesAsMiscDirty();return true};Object.defineProperty(i.prototype,"onCollide",{set:function(e){if(this._onCollideObserver){this.onCollideObservable.remove(this._onCollideObserver)}this._onCollideObserver=this.onCollideObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"onCollisionPositionChange",{set:function(e){if(this._onCollisionPositionChangeObserver){this.onCollisionPositionChangeObservable.remove(this._onCollisionPositionChangeObserver)}this._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"isOccluded",{get:function(){return this._isOccluded},set:function(e){this._isOccluded=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"isOcclusionQueryInProgress",{get:function(){return this._isOcclusionQueryInProgress},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"visibility",{get:function(){return this._visibility},set:function(e){if(this._visibility===e){return}this._visibility=e;this._markSubMeshesAsMiscDirty()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"material",{get:function(){return this._material},set:function(e){if(this._material===e){return}this._material=e;if(this.onMaterialChangedObservable.hasObservers){this.onMaterialChangedObservable.notifyObservers(this)}if(!this.subMeshes){return}for(var t=0,i=this.subMeshes;t<i.length;t++){var r=i[t];r.setEffect(null)}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"receiveShadows",{get:function(){return this._receiveShadows},set:function(e){if(this._receiveShadows===e){return}this._receiveShadows=e;this._markSubMeshesAsLightDirty()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"hasVertexAlpha",{get:function(){return this._hasVertexAlpha},set:function(e){if(this._hasVertexAlpha===e){return}this._hasVertexAlpha=e;this._markSubMeshesAsAttributesDirty();this._markSubMeshesAsMiscDirty()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"useVertexColors",{get:function(){return this._useVertexColors},set:function(e){if(this._useVertexColors===e){return}this._useVertexColors=e;this._markSubMeshesAsAttributesDirty()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"computeBonesUsingShaders",{get:function(){return this._computeBonesUsingShaders},set:function(e){if(this._computeBonesUsingShaders===e){return}this._computeBonesUsingShaders=e;this._markSubMeshesAsAttributesDirty()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"numBoneInfluencers",{get:function(){return this._numBoneInfluencers},set:function(e){if(this._numBoneInfluencers===e){return}this._numBoneInfluencers=e;this._markSubMeshesAsAttributesDirty()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"applyFog",{get:function(){return this._applyFog},set:function(e){if(this._applyFog===e){return}this._applyFog=e;this._markSubMeshesAsMiscDirty()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"layerMask",{get:function(){return this._layerMask},set:function(e){if(e===this._layerMask){return}this._layerMask=e;this._resyncLightSources()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(e){this._collisionMask=!isNaN(e)?e:-1},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"collisionGroup",{get:function(){return this._collisionGroup},set:function(e){this._collisionGroup=!isNaN(e)?e:-1},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"_positions",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"skeleton",{get:function(){return this._skeleton},set:function(e){if(this._skeleton&&this._skeleton.needInitialSkinMatrix){this._skeleton._unregisterMeshWithPoseMatrix(this)}if(e&&e.needInitialSkinMatrix){e._registerMeshWithPoseMatrix(this)}this._skeleton=e;if(!this._skeleton){this._bonesTransformMatrices=null}this._markSubMeshesAsAttributesDirty()},enumerable:true,configurable:true});i.prototype.getClassName=function(){return"AbstractMesh"};i.prototype.toString=function(t){var i="Name: "+this.name+", isInstance: "+(this instanceof e.InstancedMesh?"YES":"NO");i+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);if(this._skeleton){i+=", skeleton: "+this._skeleton.name}if(t){i+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode];i+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingFreezeWorldMatrix?"YES":"NO")}return i};i.prototype._rebuild=function(){if(this._occlusionQuery){this._occlusionQuery=null}if(this._edgesRenderer){this._edgesRenderer._rebuild()}if(!this.subMeshes){return}for(var e=0,t=this.subMeshes;e<t.length;e++){var i=t[e];i._rebuild()}};i.prototype._resyncLightSources=function(){this._lightSources.length=0;for(var e=0,t=this.getScene().lights;e<t.length;e++){var i=t[e];if(!i.isEnabled()){continue}if(i.canAffectMesh(this)){this._lightSources.push(i)}}this._markSubMeshesAsLightDirty()};i.prototype._resyncLighSource=function(e){var t=e.isEnabled()&&e.canAffectMesh(this);var i=this._lightSources.indexOf(e);if(i===-1){if(!t){return}this._lightSources.push(e)}else{if(t){return}this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty()};i.prototype._removeLightSource=function(e){var t=this._lightSources.indexOf(e);if(t===-1){return}this._lightSources.splice(t,1);this._markSubMeshesAsLightDirty()};i.prototype._markSubMeshesAsDirty=function(e){if(!this.subMeshes){return}for(var t=0,i=this.subMeshes;t<i.length;t++){var r=i[t];if(r._materialDefines){e(r._materialDefines)}}};i.prototype._markSubMeshesAsLightDirty=function(){this._markSubMeshesAsDirty(function(e){return e.markAsLightDirty()})};i.prototype._markSubMeshesAsAttributesDirty=function(){this._markSubMeshesAsDirty(function(e){return e.markAsAttributesDirty()})};i.prototype._markSubMeshesAsMiscDirty=function(){if(!this.subMeshes){return}for(var t=0,i=this.subMeshes;t<i.length;t++){var r=i[t];var n=r.getMaterial();if(n){n.markAsDirty(e.Material.MiscDirtyFlag)}}};Object.defineProperty(i.prototype,"scaling",{get:function(){return this._scaling},set:function(e){this._scaling=e;if(this.physicsImpostor){this.physicsImpostor.forceUpdate()}},enumerable:true,configurable:true});i.prototype.disableEdgesRendering=function(){if(this._edgesRenderer){this._edgesRenderer.dispose();this._edgesRenderer=null}return this};i.prototype.enableEdgesRendering=function(t,i){if(t===void 0){t=.95}if(i===void 0){i=false}this.disableEdgesRendering();this._edgesRenderer=new e.EdgesRenderer(this,t,i);return this};Object.defineProperty(i.prototype,"isBlocked",{get:function(){return false},enumerable:true,configurable:true});i.prototype.getLOD=function(e){return this};i.prototype.getTotalVertices=function(){return 0};i.prototype.getIndices=function(){return null};i.prototype.getVerticesData=function(e){return null};i.prototype.setVerticesData=function(e,t,i,r){return this};i.prototype.updateVerticesData=function(e,t,i,r){return this};i.prototype.setIndices=function(e,t){return this};i.prototype.isVerticesDataPresent=function(e){return false};i.prototype.getBoundingInfo=function(){if(this._masterMesh){return this._masterMesh.getBoundingInfo()}if(!this._boundingInfo){this._updateBoundingInfo()}return this._boundingInfo};i.prototype.normalizeToUnitCube=function(e){if(e===void 0){e=true}var t=this.getHierarchyBoundingVectors(e);var i=t.max.subtract(t.min);var r=Math.max(i.x,i.y,i.z);if(r===0){return this}var n=1/r;this.scaling.scaleInPlace(n);return this};i.prototype.setBoundingInfo=function(e){this._boundingInfo=e;return this};Object.defineProperty(i.prototype,"useBones",{get:function(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)&&this.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind)},enumerable:true,configurable:true});i.prototype._preActivate=function(){};i.prototype._preActivateForIntermediateRendering=function(e){};i.prototype._activate=function(e){this._renderId=e};i.prototype.getWorldMatrix=function(){if(this._masterMesh){return this._masterMesh.getWorldMatrix()}return t.prototype.getWorldMatrix.call(this)};i.prototype._getWorldMatrixDeterminant=function(){if(this._masterMesh){return this._masterMesh._getWorldMatrixDeterminant()}return t.prototype._getWorldMatrixDeterminant.call(this)};i.prototype.movePOV=function(e,t,i){this.position.addInPlace(this.calcMovePOV(e,t,i));return this};i.prototype.calcMovePOV=function(t,i,r){var n=new e.Matrix;var o=this.rotationQuaternion?this.rotationQuaternion:e.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z);o.toRotationMatrix(n);var s=e.Vector3.Zero();var a=this.definedFacingForward?-1:1;e.Vector3.TransformCoordinatesFromFloatsToRef(t*a,i,r*a,n,s);return s};i.prototype.rotatePOV=function(e,t,i){this.rotation.addInPlace(this.calcRotatePOV(e,t,i));return this};i.prototype.calcRotatePOV=function(t,i,r){var n=this.definedFacingForward?1:-1;return new e.Vector3(t*n,i,r*n)};i.prototype.getHierarchyBoundingVectors=function(t){if(t===void 0){t=true}this.computeWorldMatrix(true);var i;var r;var n=this.getBoundingInfo();if(!this.subMeshes){i=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);r=new e.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}else{i=n.boundingBox.minimumWorld;r=n.boundingBox.maximumWorld}if(t){var o=this.getDescendants(false);for(var s=0,a=o;s<a.length;s++){var u=a[s];var l=u;l.computeWorldMatrix(true);if(!l.getBoundingInfo||l.getTotalVertices()===0){continue}var c=l.getBoundingInfo();var h=c.boundingBox;var f=h.minimumWorld;var d=h.maximumWorld;e.Tools.CheckExtends(f,i,r);e.Tools.CheckExtends(d,i,r)}}return{min:i,max:r}};i.prototype._updateBoundingInfo=function(){this._boundingInfo=this._boundingInfo||new e.BoundingInfo(this.absolutePosition,this.absolutePosition);this._boundingInfo.update(this.worldMatrixFromCache);this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache);return this};i.prototype._updateSubMeshesBoundingInfo=function(e){if(!this.subMeshes){return this}for(var t=0;t<this.subMeshes.length;t++){var i=this.subMeshes[t];if(!i.IsGlobal){i.updateBoundingInfo(e)}}return this};i.prototype._afterComputeWorldMatrix=function(){this._updateBoundingInfo()};i.prototype.isInFrustum=function(e){return this._boundingInfo!==null&&this._boundingInfo.isInFrustum(e)};i.prototype.isCompletelyInFrustum=function(e){return this._boundingInfo!==null&&this._boundingInfo.isCompletelyInFrustum(e)};i.prototype.intersectsMesh=function(e,t,i){if(t===void 0){t=false}if(!this._boundingInfo||!e._boundingInfo){return false}if(this._boundingInfo.intersects(e._boundingInfo,t)){return true}if(i){for(var r=0,n=this.getChildMeshes();r<n.length;r++){var o=n[r];if(o.intersectsMesh(e,t,true)){return true}}}return false};i.prototype.intersectsPoint=function(e){if(!this._boundingInfo){return false}return this._boundingInfo.intersectsPoint(e)};i.prototype.getPhysicsImpostor=function(){return this.physicsImpostor};i.prototype.getPositionInCameraSpace=function(t){if(t===void 0){t=null}if(!t){t=this.getScene().activeCamera}return e.Vector3.TransformCoordinates(this.absolutePosition,t.getViewMatrix())};i.prototype.getDistanceToCamera=function(e){if(e===void 0){e=null}if(!e){e=this.getScene().activeCamera}return this.absolutePosition.subtract(e.position).length()};i.prototype.applyImpulse=function(e,t){if(!this.physicsImpostor){return this}this.physicsImpostor.applyImpulse(e,t);return this};i.prototype.setPhysicsLinkWith=function(t,i,r,n){if(!this.physicsImpostor||!t.physicsImpostor){return this}this.physicsImpostor.createJoint(t.physicsImpostor,e.PhysicsJoint.HingeJoint,{mainPivot:i,connectedPivot:r,nativeParams:n});return this};Object.defineProperty(i.prototype,"checkCollisions",{get:function(){return this._checkCollisions},set:function(e){this._checkCollisions=e;if(this.getScene().workerCollisions){this.getScene().collisionCoordinator.onMeshUpdated(this)}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"collider",{get:function(){return this._collider},enumerable:true,configurable:true});i.prototype.moveWithCollisions=function(t){var i=this.getAbsolutePosition();i.addToRef(this.ellipsoidOffset,this._oldPositionForCollisions);if(!this._collider){this._collider=new e.Collider}this._collider._radius=this.ellipsoid;this.getScene().collisionCoordinator.getNewPosition(this._oldPositionForCollisions,t,this._collider,3,this,this._onCollisionPositionChange,this.uniqueId);return this};i.prototype.createOrUpdateSubmeshesOctree=function(t,i){if(t===void 0){t=64}if(i===void 0){i=2}if(!this._submeshesOctree){this._submeshesOctree=new e.Octree(e.Octree.CreationFuncForSubMeshes,t,i)}this.computeWorldMatrix(true);var r=this.getBoundingInfo();var n=r.boundingBox;this._submeshesOctree.update(n.minimumWorld,n.maximumWorld,this.subMeshes);return this._submeshesOctree};i.prototype._collideForSubMesh=function(t,i,r){this._generatePointsArray();if(!this._positions){return this}if(!t._lastColliderWorldVertices||!t._lastColliderTransformMatrix.equals(i)){t._lastColliderTransformMatrix=i.clone();t._lastColliderWorldVertices=[];t._trianglePlanes=[];var n=t.verticesStart;var o=t.verticesStart+t.verticesCount;for(var s=n;s<o;s++){t._lastColliderWorldVertices.push(e.Vector3.TransformCoordinates(this._positions[s],i))}}r._collide(t._trianglePlanes,t._lastColliderWorldVertices,this.getIndices(),t.indexStart,t.indexStart+t.indexCount,t.verticesStart,!!t.getMaterial());if(r.collisionFound){r.collidedMesh=this}return this};i.prototype._processCollisionsForSubMeshes=function(e,t){var i;var r;if(this._submeshesOctree&&this.useOctreeForCollisions){var n=e._velocityWorldLength+Math.max(e._radius.x,e._radius.y,e._radius.z);var o=this._submeshesOctree.intersects(e._basePointWorld,n);r=o.length;i=o.data}else{i=this.subMeshes;r=i.length}for(var s=0;s<r;s++){var a=i[s];if(r>1&&!a._checkCollision(e))continue;this._collideForSubMesh(a,t,e)}return this};i.prototype._checkCollision=function(t){if(!this._boundingInfo||!this._boundingInfo._checkCollision(t))return this;e.Matrix.ScalingToRef(1/t._radius.x,1/t._radius.y,1/t._radius.z,this._collisionsScalingMatrix);this.worldMatrixFromCache.multiplyToRef(this._collisionsScalingMatrix,this._collisionsTransformMatrix);this._processCollisionsForSubMeshes(t,this._collisionsTransformMatrix);return this};i.prototype._generatePointsArray=function(){return false};i.prototype.intersects=function(t,i){var r=new e.PickingInfo;if(!this.subMeshes||!this._boundingInfo||!t.intersectsSphere(this._boundingInfo.boundingSphere)||!t.intersectsBox(this._boundingInfo.boundingBox)){return r}if(!this._generatePointsArray()){return r}var n=null;var o;var s;if(this._submeshesOctree&&this.useOctreeForPicking){var a=e.Ray.Transform(t,this.getWorldMatrix());var u=this._submeshesOctree.intersectsRay(a);s=u.length;o=u.data}else{o=this.subMeshes;s=o.length}for(var l=0;l<s;l++){var c=o[l];if(s>1&&!c.canIntersects(t))continue;var h=c.intersects(t,this._positions,this.getIndices(),i);if(h){if(i||!n||h.distance<n.distance){n=h;n.subMeshId=l;if(i){break}}}}if(n){var f=this.getWorldMatrix();var d=e.Vector3.TransformCoordinates(t.origin,f);var p=t.direction.clone();p=p.scale(n.distance);var _=e.Vector3.TransformNormal(p,f);var m=d.add(_);r.hit=true;r.distance=e.Vector3.Distance(d,m);r.pickedPoint=m;r.pickedMesh=this;r.bu=n.bu||0;r.bv=n.bv||0;r.faceId=n.faceId;r.subMeshId=n.subMeshId;return r}return r};i.prototype.clone=function(e,t,i){return null};i.prototype.releaseSubMeshes=function(){if(this.subMeshes){while(this.subMeshes.length){this.subMeshes[0].dispose()}}else{this.subMeshes=new Array}return this};i.prototype.dispose=function(e,i){var r=this;if(i===void 0){i=false}var n;this.getScene().freeActiveMeshes();this.getScene().freeRenderingGroups();if(this.actionManager!==undefined&&this.actionManager!==null){this.actionManager.dispose();this.actionManager=null}this._skeleton=null;if(this.physicsImpostor){this.physicsImpostor.dispose()}for(n=0;n<this._intersectionsInProgress.length;n++){var o=this._intersectionsInProgress[n];var s=o._intersectionsInProgress.indexOf(this);o._intersectionsInProgress.splice(s,1)}this._intersectionsInProgress=[];var a=this.getScene().lights;a.forEach(function(e){var t=e.includedOnlyMeshes.indexOf(r);if(t!==-1){e.includedOnlyMeshes.splice(t,1)}t=e.excludedMeshes.indexOf(r);if(t!==-1){e.excludedMeshes.splice(t,1)}var i=e.getShadowGenerator();if(i){var n=i.getShadowMap();if(n&&n.renderList){t=n.renderList.indexOf(r);if(t!==-1){n.renderList.splice(t,1)}}}});if(this._edgesRenderer){this._edgesRenderer.dispose();this._edgesRenderer=null}if(this.getClassName()!=="InstancedMesh"){this.releaseSubMeshes()}var u=this.getScene().selectionOctree;if(u!==undefined&&u!==null){var n=u.dynamicContent.indexOf(this);if(n!==-1){u.dynamicContent.splice(n,1)}}var l=this.getScene().getEngine();if(this._occlusionQuery){this._isOcclusionQueryInProgress=false;l.deleteQuery(this._occlusionQuery);this._occlusionQuery=null}l.wipeCaches();this.getScene().removeMesh(this);if(i){if(this.material){this.material.dispose(false,true)}}if(!e){for(n=0;n<this.getScene().particleSystems.length;n++){if(this.getScene().particleSystems[n].emitter===this){this.getScene().particleSystems[n].dispose();n--}}}if(this._facetDataEnabled){this.disableFacetData()}this.onAfterWorldMatrixUpdateObservable.clear();this.onCollideObservable.clear();this.onCollisionPositionChangeObservable.clear();t.prototype.dispose.call(this,e,i)};i.prototype.addChild=function(e){e.setParent(this);return this};i.prototype.removeChild=function(e){e.setParent(null);return this};i.prototype._initFacetData=function(){if(!this._facetNormals){this._facetNormals=new Array}if(!this._facetPositions){this._facetPositions=new Array}if(!this._facetPartitioning){this._facetPartitioning=new Array}this._facetNb=this.getIndices().length/3|0;this._partitioningSubdivisions=this._partitioningSubdivisions?this._partitioningSubdivisions:10;this._partitioningBBoxRatio=this._partitioningBBoxRatio?this._partitioningBBoxRatio:1.01;for(var t=0;t<this._facetNb;t++){this._facetNormals[t]=e.Vector3.Zero();this._facetPositions[t]=e.Vector3.Zero()}this._facetDataEnabled=true;return this};i.prototype.updateFacetData=function(){if(!this._facetDataEnabled){this._initFacetData()}var t=this.getVerticesData(e.VertexBuffer.PositionKind);var i=this.getIndices();var r=this.getVerticesData(e.VertexBuffer.NormalKind);var n=this.getBoundingInfo();if(this._facetDepthSort&&!this._facetDepthSortEnabled){this._facetDepthSortEnabled=true;if(i instanceof Uint16Array){this._depthSortedIndices=new Uint16Array(i)}else if(i instanceof Uint32Array){this._depthSortedIndices=new Uint32Array(i)}else{var o=false;for(var s=0;s<i.length;s++){if(i[s]>65535){o=true;break}}if(o){this._depthSortedIndices=new Uint32Array(i)}else{this._depthSortedIndices=new Uint16Array(i)}}this._facetDepthSortFunction=function(e,t){return t.sqDistance-e.sqDistance};if(!this._facetDepthSortFrom){var a=this.getScene().activeCamera;this._facetDepthSortFrom=a?a.position:e.Vector3.Zero()}this._depthSortedFacets=[];for(var u=0;u<this._facetNb;u++){var l={ind:u*3,sqDistance:0};this._depthSortedFacets.push(l)}this._invertedMatrix=e.Matrix.Identity();this._facetDepthSortOrigin=e.Vector3.Zero()}this._bbSize.x=n.maximum.x-n.minimum.x>e.Epsilon?n.maximum.x-n.minimum.x:e.Epsilon;this._bbSize.y=n.maximum.y-n.minimum.y>e.Epsilon?n.maximum.y-n.minimum.y:e.Epsilon;this._bbSize.z=n.maximum.z-n.minimum.z>e.Epsilon?n.maximum.z-n.minimum.z:e.Epsilon;var c=this._bbSize.x>this._bbSize.y?this._bbSize.x:this._bbSize.y;c=c>this._bbSize.z?c:this._bbSize.z;this._subDiv.max=this._partitioningSubdivisions;this._subDiv.X=Math.floor(this._subDiv.max*this._bbSize.x/c);this._subDiv.Y=Math.floor(this._subDiv.max*this._bbSize.y/c);this._subDiv.Z=Math.floor(this._subDiv.max*this._bbSize.z/c);this._subDiv.X=this._subDiv.X<1?1:this._subDiv.X;this._subDiv.Y=this._subDiv.Y<1?1:this._subDiv.Y;this._subDiv.Z=this._subDiv.Z<1?1:this._subDiv.Z;this._facetParameters.facetNormals=this.getFacetLocalNormals();this._facetParameters.facetPositions=this.getFacetLocalPositions();this._facetParameters.facetPartitioning=this.getFacetLocalPartitioning();this._facetParameters.bInfo=n;this._facetParameters.bbSize=this._bbSize;this._facetParameters.subDiv=this._subDiv;this._facetParameters.ratio=this.partitioningBBoxRatio;this._facetParameters.depthSort=this._facetDepthSort;if(this._facetDepthSort&&this._facetDepthSortEnabled){this.computeWorldMatrix(true);this._worldMatrix.invertToRef(this._invertedMatrix);e.Vector3.TransformCoordinatesToRef(this._facetDepthSortFrom,this._invertedMatrix,this._facetDepthSortOrigin);this._facetParameters.distanceTo=this._facetDepthSortOrigin}this._facetParameters.depthSortedFacets=this._depthSortedFacets;e.VertexData.ComputeNormals(t,i,r,this._facetParameters);if(this._facetDepthSort&&this._facetDepthSortEnabled){this._depthSortedFacets.sort(this._facetDepthSortFunction);var h=this._depthSortedIndices.length/3|0;for(var u=0;u<h;u++){var f=this._depthSortedFacets[u].ind;this._depthSortedIndices[u*3]=i[f];this._depthSortedIndices[u*3+1]=i[f+1];this._depthSortedIndices[u*3+2]=i[f+2]}this.updateIndices(this._depthSortedIndices)}return this};i.prototype.getFacetLocalNormals=function(){if(!this._facetNormals){this.updateFacetData()}return this._facetNormals};i.prototype.getFacetLocalPositions=function(){if(!this._facetPositions){this.updateFacetData()}return this._facetPositions};i.prototype.getFacetLocalPartitioning=function(){if(!this._facetPartitioning){this.updateFacetData()}return this._facetPartitioning};i.prototype.getFacetPosition=function(t){var i=e.Vector3.Zero();this.getFacetPositionToRef(t,i);return i};i.prototype.getFacetPositionToRef=function(t,i){var r=this.getFacetLocalPositions()[t];var n=this.getWorldMatrix();e.Vector3.TransformCoordinatesToRef(r,n,i);return this};i.prototype.getFacetNormal=function(t){var i=e.Vector3.Zero();this.getFacetNormalToRef(t,i);return i};i.prototype.getFacetNormalToRef=function(t,i){var r=this.getFacetLocalNormals()[t];e.Vector3.TransformNormalToRef(r,this.getWorldMatrix(),i);return this};i.prototype.getFacetsAtLocalCoordinates=function(e,t,i){var r=this.getBoundingInfo();var n=Math.floor((e-r.minimum.x*this._partitioningBBoxRatio)*this._subDiv.X*this._partitioningBBoxRatio/this._bbSize.x);var o=Math.floor((t-r.minimum.y*this._partitioningBBoxRatio)*this._subDiv.Y*this._partitioningBBoxRatio/this._bbSize.y);var s=Math.floor((i-r.minimum.z*this._partitioningBBoxRatio)*this._subDiv.Z*this._partitioningBBoxRatio/this._bbSize.z);if(n<0||n>this._subDiv.max||o<0||o>this._subDiv.max||s<0||s>this._subDiv.max){return null}return this._facetPartitioning[n+this._subDiv.max*o+this._subDiv.max*this._subDiv.max*s]};i.prototype.getClosestFacetAtCoordinates=function(t,i,r,n,o,s){if(o===void 0){o=false}if(s===void 0){s=true}var a=this.getWorldMatrix();var u=e.Tmp.Matrix[5];a.invertToRef(u);var l=e.Tmp.Vector3[8];e.Vector3.TransformCoordinatesFromFloatsToRef(t,i,r,u,l);var c=this.getClosestFacetAtLocalCoordinates(l.x,l.y,l.z,n,o,s);if(n){e.Vector3.TransformCoordinatesFromFloatsToRef(n.x,n.y,n.z,a,n)}return c};i.prototype.getClosestFacetAtLocalCoordinates=function(e,t,i,r,n,o){if(n===void 0){n=false}if(o===void 0){o=true}var s=null;var a=0;var u=0;var l=0;var c=0;var h=0;var f=0;var d=0;var p=0;var _=this.getFacetLocalPositions();var m=this.getFacetLocalNormals();var g=this.getFacetsAtLocalCoordinates(e,t,i);if(!g){return null}var v=Number.MAX_VALUE;var y=v;var b;var x;var T;for(var E=0;E<g.length;E++){b=g[E];x=m[b];T=_[b];c=(e-T.x)*x.x+(t-T.y)*x.y+(i-T.z)*x.z;if(!n||n&&o&&c>=0||n&&!o&&c<=0){c=x.x*T.x+x.y*T.y+x.z*T.z;h=-(x.x*e+x.y*t+x.z*i-c)/(x.x*x.x+x.y*x.y+x.z*x.z);f=e+x.x*h;d=t+x.y*h;p=i+x.z*h;a=f-e;u=d-t;l=p-i;y=a*a+u*u+l*l;if(y<v){v=y;s=b;if(r){r.x=f;r.y=d;r.z=p}}}}return s};i.prototype.getFacetDataParameters=function(){return this._facetParameters};i.prototype.disableFacetData=function(){if(this._facetDataEnabled){this._facetDataEnabled=false;this._facetPositions=new Array;this._facetNormals=new Array;this._facetPartitioning=new Array;this._facetParameters=null;this._depthSortedIndices=new Uint32Array(0)}return this};i.prototype.updateIndices=function(e){return this};i.prototype.createNormals=function(t){var i=this.getVerticesData(e.VertexBuffer.PositionKind);var r=this.getIndices();var n;if(this.isVerticesDataPresent(e.VertexBuffer.NormalKind)){n=this.getVerticesData(e.VertexBuffer.NormalKind)}else{n=[]}e.VertexData.ComputeNormals(i,r,n,{useRightHandedSystem:this.getScene().useRightHandedSystem});this.setVerticesData(e.VertexBuffer.NormalKind,n,t)};i.prototype.alignWithNormal=function(t,i){if(!i){i=e.Axis.Y}var r=e.Tmp.Vector3[0];var n=e.Tmp.Vector3[1];e.Vector3.CrossToRef(i,t,n);e.Vector3.CrossToRef(t,n,r);if(this.rotationQuaternion){e.Quaternion.RotationQuaternionFromAxisToRef(r,t,n,this.rotationQuaternion)}else{e.Vector3.RotationFromAxisToRef(r,t,n,this.rotation)}return this};i.prototype.checkOcclusionQuery=function(){var e=this.getEngine();if(e.webGLVersion<2||this.occlusionType===i.OCCLUSION_TYPE_NONE){this._isOccluded=false;return}if(this.isOcclusionQueryInProgress&&this._occlusionQuery){var t=e.isQueryResultAvailable(this._occlusionQuery);if(t){var r=e.getQueryResult(this._occlusionQuery);this._isOcclusionQueryInProgress=false;this._occlusionInternalRetryCounter=0;this._isOccluded=r===1?false:true}else{
this._occlusionInternalRetryCounter++;if(this.occlusionRetryCount!==-1&&this._occlusionInternalRetryCounter>this.occlusionRetryCount){this._isOcclusionQueryInProgress=false;this._occlusionInternalRetryCounter=0;this._isOccluded=this.occlusionType===i.OCCLUSION_TYPE_OPTIMISTIC?false:this._isOccluded}else{return}}}var n=this.getScene();var o=n.getBoundingBoxRenderer();if(!this._occlusionQuery){this._occlusionQuery=e.createQuery()}e.beginOcclusionQuery(this.occlusionQueryAlgorithmType,this._occlusionQuery);o.renderOcclusionBoundingBox(this);e.endOcclusionQuery(this.occlusionQueryAlgorithmType);this._isOcclusionQueryInProgress=true};i.OCCLUSION_TYPE_NONE=0;i.OCCLUSION_TYPE_OPTIMISTIC=1;i.OCCLUSION_TYPE_STRICT=2;i.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0;i.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1;return i}(e.TransformNode);e.AbstractMesh=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(r,n){var o=t.call(this,r,n)||this;o.diffuse=new e.Color3(1,1,1);o.specular=new e.Color3(1,1,1);o.intensity=1;o.range=Number.MAX_VALUE;o._photometricScale=1;o._intensityMode=i.INTENSITYMODE_AUTOMATIC;o._radius=1e-5;o.renderPriority=0;o.shadowEnabled=true;o._excludeWithLayerMask=0;o._includeOnlyWithLayerMask=0;o._lightmapMode=0;o._excludedMeshesIds=new Array;o._includedOnlyMeshesIds=new Array;o.getScene().addLight(o);o._uniformBuffer=new e.UniformBuffer(o.getScene().getEngine());o._buildUniformLayout();o.includedOnlyMeshes=new Array;o.excludedMeshes=new Array;o._resyncMeshes();return o}Object.defineProperty(i,"LIGHTMAP_DEFAULT",{get:function(){return i._LIGHTMAP_DEFAULT},enumerable:true,configurable:true});Object.defineProperty(i,"LIGHTMAP_SPECULAR",{get:function(){return i._LIGHTMAP_SPECULAR},enumerable:true,configurable:true});Object.defineProperty(i,"LIGHTMAP_SHADOWSONLY",{get:function(){return i._LIGHTMAP_SHADOWSONLY},enumerable:true,configurable:true});Object.defineProperty(i,"INTENSITYMODE_AUTOMATIC",{get:function(){return i._INTENSITYMODE_AUTOMATIC},enumerable:true,configurable:true});Object.defineProperty(i,"INTENSITYMODE_LUMINOUSPOWER",{get:function(){return i._INTENSITYMODE_LUMINOUSPOWER},enumerable:true,configurable:true});Object.defineProperty(i,"INTENSITYMODE_LUMINOUSINTENSITY",{get:function(){return i._INTENSITYMODE_LUMINOUSINTENSITY},enumerable:true,configurable:true});Object.defineProperty(i,"INTENSITYMODE_ILLUMINANCE",{get:function(){return i._INTENSITYMODE_ILLUMINANCE},enumerable:true,configurable:true});Object.defineProperty(i,"INTENSITYMODE_LUMINANCE",{get:function(){return i._INTENSITYMODE_LUMINANCE},enumerable:true,configurable:true});Object.defineProperty(i,"LIGHTTYPEID_POINTLIGHT",{get:function(){return i._LIGHTTYPEID_POINTLIGHT},enumerable:true,configurable:true});Object.defineProperty(i,"LIGHTTYPEID_DIRECTIONALLIGHT",{get:function(){return i._LIGHTTYPEID_DIRECTIONALLIGHT},enumerable:true,configurable:true});Object.defineProperty(i,"LIGHTTYPEID_SPOTLIGHT",{get:function(){return i._LIGHTTYPEID_SPOTLIGHT},enumerable:true,configurable:true});Object.defineProperty(i,"LIGHTTYPEID_HEMISPHERICLIGHT",{get:function(){return i._LIGHTTYPEID_HEMISPHERICLIGHT},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"intensityMode",{get:function(){return this._intensityMode},set:function(e){this._intensityMode=e;this._computePhotometricScale()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"radius",{get:function(){return this._radius},set:function(e){this._radius=e;this._computePhotometricScale()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"includedOnlyMeshes",{get:function(){return this._includedOnlyMeshes},set:function(e){this._includedOnlyMeshes=e;this._hookArrayForIncludedOnly(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"excludedMeshes",{get:function(){return this._excludedMeshes},set:function(e){this._excludedMeshes=e;this._hookArrayForExcluded(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"excludeWithLayerMask",{get:function(){return this._excludeWithLayerMask},set:function(e){this._excludeWithLayerMask=e;this._resyncMeshes()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"includeOnlyWithLayerMask",{get:function(){return this._includeOnlyWithLayerMask},set:function(e){this._includeOnlyWithLayerMask=e;this._resyncMeshes()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"lightmapMode",{get:function(){return this._lightmapMode},set:function(e){if(this._lightmapMode===e){return}this._lightmapMode=e;this._markMeshesAsLightDirty()},enumerable:true,configurable:true});i.prototype.getClassName=function(){return"Light"};i.prototype.toString=function(e){var t="Name: "+this.name;t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()];if(this.animations){for(var i=0;i<this.animations.length;i++){t+=", animation[0]: "+this.animations[i].toString(e)}}if(e){}return t};i.prototype.setEnabled=function(e){t.prototype.setEnabled.call(this,e);this._resyncMeshes()};i.prototype.getShadowGenerator=function(){return this._shadowGenerator};i.prototype.getAbsolutePosition=function(){return e.Vector3.Zero()};i.prototype.canAffectMesh=function(e){if(!e){return true}if(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1){return false}if(this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1){return false}if(this.includeOnlyWithLayerMask!==0&&(this.includeOnlyWithLayerMask&e.layerMask)===0){return false}if(this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask){return false}return true};i.prototype.getWorldMatrix=function(){this._currentRenderId=this.getScene().getRenderId();this._childRenderId=this._currentRenderId;var t=this._getWorldMatrix();if(this.parent&&this.parent.getWorldMatrix){if(!this._parentedWorldMatrix){this._parentedWorldMatrix=e.Matrix.Identity()}t.multiplyToRef(this.parent.getWorldMatrix(),this._parentedWorldMatrix);this._markSyncedWithParent();return this._parentedWorldMatrix}return t};i.CompareLightsPriority=function(e,t){if(e.shadowEnabled!==t.shadowEnabled){return(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0)}return t.renderPriority-e.renderPriority};i.prototype.dispose=function(e,i){if(i===void 0){i=false}if(this._shadowGenerator){this._shadowGenerator.dispose();this._shadowGenerator=null}this.getScene().stopAnimation(this);for(var r=0,n=this.getScene().meshes;r<n.length;r++){var o=n[r];o._removeLightSource(this)}this._uniformBuffer.dispose();this.getScene().removeLight(this);t.prototype.dispose.call(this,e,i)};i.prototype.getTypeID=function(){return 0};i.prototype.getScaledIntensity=function(){return this._photometricScale*this.intensity};i.prototype.clone=function(t){var r=i.GetConstructorFromName(this.getTypeID(),t,this.getScene());if(!r){return null}return e.SerializationHelper.Clone(r,this)};i.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);t.type=this.getTypeID();if(this.parent){t.parentId=this.parent.id}if(this.excludedMeshes.length>0){t.excludedMeshesIds=[];this.excludedMeshes.forEach(function(e){t.excludedMeshesIds.push(e.id)})}if(this.includedOnlyMeshes.length>0){t.includedOnlyMeshesIds=[];this.includedOnlyMeshes.forEach(function(e){t.includedOnlyMeshesIds.push(e.id)})}e.Animation.AppendSerializedAnimations(this,t);t.ranges=this.serializeAnimationRanges();return t};i.GetConstructorFromName=function(t,i,r){switch(t){case 0:return function(){return new e.PointLight(i,e.Vector3.Zero(),r)};case 1:return function(){return new e.DirectionalLight(i,e.Vector3.Zero(),r)};case 2:return function(){return new e.SpotLight(i,e.Vector3.Zero(),e.Vector3.Zero(),0,0,r)};case 3:return function(){return new e.HemisphericLight(i,e.Vector3.Zero(),r)}}return null};i.Parse=function(t,r){var n=i.GetConstructorFromName(t.type,t.name,r);if(!n){return null}var o=e.SerializationHelper.Parse(n,t,r);if(t.excludedMeshesIds){o._excludedMeshesIds=t.excludedMeshesIds}if(t.includedOnlyMeshesIds){o._includedOnlyMeshesIds=t.includedOnlyMeshesIds}if(t.parentId){o._waitingParentId=t.parentId}if(t.animations){for(var s=0;s<t.animations.length;s++){var a=t.animations[s];o.animations.push(e.Animation.Parse(a))}e.Node.ParseAnimationRanges(o,t,r)}if(t.autoAnimate){r.beginAnimation(o,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1)}return o};i.prototype._hookArrayForExcluded=function(e){var t=this;var i=e.push;e.push=function(){var r=[];for(var n=0;n<arguments.length;n++){r[n]=arguments[n]}var o=i.apply(e,r);for(var s=0,a=r;s<a.length;s++){var u=a[s];u._resyncLighSource(t)}return o};var r=e.splice;e.splice=function(i,n){var o=r.apply(e,[i,n]);for(var s=0,a=o;s<a.length;s++){var u=a[s];u._resyncLighSource(t)}return o};for(var n=0,o=e;n<o.length;n++){var s=o[n];s._resyncLighSource(this)}};i.prototype._hookArrayForIncludedOnly=function(e){var t=this;var i=e.push;e.push=function(){var r=[];for(var n=0;n<arguments.length;n++){r[n]=arguments[n]}var o=i.apply(e,r);t._resyncMeshes();return o};var r=e.splice;e.splice=function(i,n){var o=r.apply(e,[i,n]);t._resyncMeshes();return o};this._resyncMeshes()};i.prototype._resyncMeshes=function(){for(var e=0,t=this.getScene().meshes;e<t.length;e++){var i=t[e];i._resyncLighSource(this)}};i.prototype._markMeshesAsLightDirty=function(){for(var e=0,t=this.getScene().meshes;e<t.length;e++){var i=t[e];if(i._lightSources.indexOf(this)!==-1){i._markSubMeshesAsLightDirty()}}};i.prototype._computePhotometricScale=function(){this._photometricScale=this._getPhotometricScale();this.getScene().resetCachedMaterial()};i.prototype._getPhotometricScale=function(){var e=0;var t=this.getTypeID();var r=this.intensityMode;if(r===i.INTENSITYMODE_AUTOMATIC){if(t===i.LIGHTTYPEID_DIRECTIONALLIGHT){r=i.INTENSITYMODE_ILLUMINANCE}else{r=i.INTENSITYMODE_LUMINOUSINTENSITY}}switch(t){case i.LIGHTTYPEID_POINTLIGHT:case i.LIGHTTYPEID_SPOTLIGHT:switch(r){case i.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case i.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case i.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case i.LIGHTTYPEID_DIRECTIONALLIGHT:switch(r){case i.INTENSITYMODE_ILLUMINANCE:e=1;break;case i.INTENSITYMODE_LUMINANCE:var n=this.radius;n=Math.max(n,.001);var o=2*Math.PI*(1-Math.cos(n));e=o;break}break;case i.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e};i.prototype._reorderLightsInScene=function(){var e=this.getScene();if(this._renderPriority!=0){e.requireLightSorting=true}this.getScene().sortLightsByPriority()};i._LIGHTMAP_DEFAULT=0;i._LIGHTMAP_SPECULAR=1;i._LIGHTMAP_SHADOWSONLY=2;i._INTENSITYMODE_AUTOMATIC=0;i._INTENSITYMODE_LUMINOUSPOWER=1;i._INTENSITYMODE_LUMINOUSINTENSITY=2;i._INTENSITYMODE_ILLUMINANCE=3;i._INTENSITYMODE_LUMINANCE=4;i._LIGHTTYPEID_POINTLIGHT=0;i._LIGHTTYPEID_DIRECTIONALLIGHT=1;i._LIGHTTYPEID_SPOTLIGHT=2;i._LIGHTTYPEID_HEMISPHERICLIGHT=3;__decorate([e.serializeAsColor3()],i.prototype,"diffuse",void 0);__decorate([e.serializeAsColor3()],i.prototype,"specular",void 0);__decorate([e.serialize()],i.prototype,"intensity",void 0);__decorate([e.serialize()],i.prototype,"range",void 0);__decorate([e.serialize()],i.prototype,"intensityMode",null);__decorate([e.serialize()],i.prototype,"radius",null);__decorate([e.serialize()],i.prototype,"_renderPriority",void 0);__decorate([e.expandToProperty("_reorderLightsInScene")],i.prototype,"renderPriority",void 0);__decorate([e.serialize()],i.prototype,"shadowEnabled",void 0);__decorate([e.serialize("excludeWithLayerMask")],i.prototype,"_excludeWithLayerMask",void 0);__decorate([e.serialize("includeOnlyWithLayerMask")],i.prototype,"_includeOnlyWithLayerMask",void 0);__decorate([e.serialize("lightmapMode")],i.prototype,"_lightmapMode",void 0);return i}(e.Node);e.Light=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(r,n,o){var s=t.call(this,r,o)||this;s.upVector=e.Vector3.Up();s.orthoLeft=null;s.orthoRight=null;s.orthoBottom=null;s.orthoTop=null;s.fov=.8;s.minZ=1;s.maxZ=1e4;s.inertia=.9;s.mode=i.PERSPECTIVE_CAMERA;s.isIntermediate=false;s.viewport=new e.Viewport(0,0,1,1);s.layerMask=268435455;s.fovMode=i.FOVMODE_VERTICAL_FIXED;s.cameraRigMode=i.RIG_MODE_NONE;s._rigCameras=new Array;s._webvrViewMatrix=e.Matrix.Identity();s._skipRendering=false;s.customRenderTargets=new Array;s.onViewMatrixChangedObservable=new e.Observable;s.onProjectionMatrixChangedObservable=new e.Observable;s.onAfterCheckInputsObservable=new e.Observable;s.onRestoreStateObservable=new e.Observable;s._computedViewMatrix=e.Matrix.Identity();s._projectionMatrix=new e.Matrix;s._doNotComputeProjectionMatrix=false;s._postProcesses=new Array;s._transformMatrix=e.Matrix.Zero();s._activeMeshes=new e.SmartArray(256);s._globalPosition=e.Vector3.Zero();s._refreshFrustumPlanes=true;s.getScene().addCamera(s);if(!s.getScene().activeCamera){s.getScene().activeCamera=s}s.position=n;return s}Object.defineProperty(i,"PERSPECTIVE_CAMERA",{get:function(){return i._PERSPECTIVE_CAMERA},enumerable:true,configurable:true});Object.defineProperty(i,"ORTHOGRAPHIC_CAMERA",{get:function(){return i._ORTHOGRAPHIC_CAMERA},enumerable:true,configurable:true});Object.defineProperty(i,"FOVMODE_VERTICAL_FIXED",{get:function(){return i._FOVMODE_VERTICAL_FIXED},enumerable:true,configurable:true});Object.defineProperty(i,"FOVMODE_HORIZONTAL_FIXED",{get:function(){return i._FOVMODE_HORIZONTAL_FIXED},enumerable:true,configurable:true});Object.defineProperty(i,"RIG_MODE_NONE",{get:function(){return i._RIG_MODE_NONE},enumerable:true,configurable:true});Object.defineProperty(i,"RIG_MODE_STEREOSCOPIC_ANAGLYPH",{get:function(){return i._RIG_MODE_STEREOSCOPIC_ANAGLYPH},enumerable:true,configurable:true});Object.defineProperty(i,"RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL",{get:function(){return i._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL},enumerable:true,configurable:true});Object.defineProperty(i,"RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED",{get:function(){return i._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED},enumerable:true,configurable:true});Object.defineProperty(i,"RIG_MODE_STEREOSCOPIC_OVERUNDER",{get:function(){return i._RIG_MODE_STEREOSCOPIC_OVERUNDER},enumerable:true,configurable:true});Object.defineProperty(i,"RIG_MODE_VR",{get:function(){return i._RIG_MODE_VR},enumerable:true,configurable:true});Object.defineProperty(i,"RIG_MODE_WEBVR",{get:function(){return i._RIG_MODE_WEBVR},enumerable:true,configurable:true});i.prototype.storeState=function(){this._stateStored=true;this._storedFov=this.fov;return this};i.prototype._restoreStateValues=function(){if(!this._stateStored){return false}this.fov=this._storedFov;return true};i.prototype.restoreState=function(){if(this._restoreStateValues()){this.onRestoreStateObservable.notifyObservers(this);return true}return false};i.prototype.getClassName=function(){return"Camera"};i.prototype.toString=function(e){var t="Name: "+this.name;t+=", type: "+this.getClassName();if(this.animations){for(var i=0;i<this.animations.length;i++){t+=", animation[0]: "+this.animations[i].toString(e)}}if(e){}return t};Object.defineProperty(i.prototype,"globalPosition",{get:function(){return this._globalPosition},enumerable:true,configurable:true});i.prototype.getActiveMeshes=function(){return this._activeMeshes};i.prototype.isActiveMesh=function(e){return this._activeMeshes.indexOf(e)!==-1};i.prototype.isReady=function(e){if(e===void 0){e=false}if(e){for(var i=0,r=this._postProcesses;i<r.length;i++){var n=r[i];if(n&&!n.isReady()){return false}}}return t.prototype.isReady.call(this,e)};i.prototype._initCache=function(){t.prototype._initCache.call(this);this._cache.position=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.upVector=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.mode=undefined;this._cache.minZ=undefined;this._cache.maxZ=undefined;this._cache.fov=undefined;this._cache.fovMode=undefined;this._cache.aspectRatio=undefined;this._cache.orthoLeft=undefined;this._cache.orthoRight=undefined;this._cache.orthoBottom=undefined;this._cache.orthoTop=undefined;this._cache.renderWidth=undefined;this._cache.renderHeight=undefined};i.prototype._updateCache=function(e){if(!e){t.prototype._updateCache.call(this)}this._cache.position.copyFrom(this.position);this._cache.upVector.copyFrom(this.upVector)};i.prototype._isSynchronized=function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()};i.prototype._isSynchronizedViewMatrix=function(){if(!t.prototype._isSynchronized.call(this))return false;return this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent()};i.prototype._isSynchronizedProjectionMatrix=function(){var e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e){return false}var t=this.getEngine();if(this.mode===i.PERSPECTIVE_CAMERA){e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)}else{e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight()}return e};i.prototype.attachControl=function(e,t){};i.prototype.detachControl=function(e){};i.prototype.update=function(){this._checkInputs();if(this.cameraRigMode!==i.RIG_MODE_NONE){this._updateRigCameras()}};i.prototype._checkInputs=function(){this.onAfterCheckInputsObservable.notifyObservers(this)};Object.defineProperty(i.prototype,"rigCameras",{get:function(){return this._rigCameras},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rigPostProcess",{get:function(){return this._rigPostProcess},enumerable:true,configurable:true});i.prototype._getFirstPostProcess=function(){for(var e in this._postProcesses){if(this._postProcesses[e]!==null){return this._postProcesses[e]}}return null};i.prototype._cascadePostProcessesToRigCams=function(){var t=this._getFirstPostProcess();if(t){t.markTextureDirty()}for(var i=0,r=this._rigCameras.length;i<r;i++){var n=this._rigCameras[i];var o=n._rigPostProcess;if(o){var s=o instanceof e.PassPostProcess;if(s){n.isIntermediate=this._postProcesses.length===0}n._postProcesses=this._postProcesses.slice(0).concat(o);o.markTextureDirty()}else{n._postProcesses=this._postProcesses.slice(0)}}};i.prototype.attachPostProcess=function(t,i){if(i===void 0){i=null}if(!t.isReusable()&&this._postProcesses.indexOf(t)>-1){e.Tools.Error("You're trying to reuse a post process not defined as reusable.");return 0}if(i==null||i<0){this._postProcesses.push(t)}else if(this._postProcesses[i]===null){this._postProcesses[i]=t}else{this._postProcesses.splice(i,0,t)}this._cascadePostProcessesToRigCams();return this._postProcesses.indexOf(t)};i.prototype.detachPostProcess=function(e){var t=this._postProcesses.indexOf(e);if(t!==-1){this._postProcesses[t]=null}this._cascadePostProcessesToRigCams()};i.prototype.getWorldMatrix=function(){if(!this._worldMatrix){this._worldMatrix=e.Matrix.Identity()}var t=this.getViewMatrix();t.invertToRef(this._worldMatrix);return this._worldMatrix};i.prototype._getViewMatrix=function(){return e.Matrix.Identity()};i.prototype.getViewMatrix=function(t){if(!t&&this._isSynchronizedViewMatrix()){return this._computedViewMatrix}this.updateCache();this._computedViewMatrix=this._getViewMatrix();this._currentRenderId=this.getScene().getRenderId();this._childRenderId=this._currentRenderId;this._refreshFrustumPlanes=true;if(!this.parent||!this.parent.getWorldMatrix){this._globalPosition.copyFrom(this.position)}else{if(!this._worldMatrix){this._worldMatrix=e.Matrix.Identity()}this._computedViewMatrix.invertToRef(this._worldMatrix);this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._computedViewMatrix);this._globalPosition.copyFromFloats(this._computedViewMatrix.m[12],this._computedViewMatrix.m[13],this._computedViewMatrix.m[14]);this._computedViewMatrix.invert();this._markSyncedWithParent()}if(this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix){this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix)}this.onViewMatrixChangedObservable.notifyObservers(this);return this._computedViewMatrix};i.prototype.freezeProjectionMatrix=function(e){this._doNotComputeProjectionMatrix=true;if(e!==undefined){this._projectionMatrix=e}};i.prototype.unfreezeProjectionMatrix=function(){this._doNotComputeProjectionMatrix=false};i.prototype.getProjectionMatrix=function(t){if(this._doNotComputeProjectionMatrix||!t&&this._isSynchronizedProjectionMatrix()){return this._projectionMatrix}this._cache.mode=this.mode;this._cache.minZ=this.minZ;this._cache.maxZ=this.maxZ;this._refreshFrustumPlanes=true;var r=this.getEngine();var n=this.getScene();if(this.mode===i.PERSPECTIVE_CAMERA){this._cache.fov=this.fov;this._cache.fovMode=this.fovMode;this._cache.aspectRatio=r.getAspectRatio(this);if(this.minZ<=0){this.minZ=.1}if(n.useRightHandedSystem){e.Matrix.PerspectiveFovRHToRef(this.fov,r.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix,this.fovMode===i.FOVMODE_VERTICAL_FIXED)}else{e.Matrix.PerspectiveFovLHToRef(this.fov,r.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix,this.fovMode===i.FOVMODE_VERTICAL_FIXED)}}else{var o=r.getRenderWidth()/2;var s=r.getRenderHeight()/2;if(n.useRightHandedSystem){e.Matrix.OrthoOffCenterRHToRef(this.orthoLeft||-o,this.orthoRight||o,this.orthoBottom||-s,this.orthoTop||s,this.minZ,this.maxZ,this._projectionMatrix)}else{e.Matrix.OrthoOffCenterLHToRef(this.orthoLeft||-o,this.orthoRight||o,this.orthoBottom||-s,this.orthoTop||s,this.minZ,this.maxZ,this._projectionMatrix)}this._cache.orthoLeft=this.orthoLeft;this._cache.orthoRight=this.orthoRight;this._cache.orthoBottom=this.orthoBottom;this._cache.orthoTop=this.orthoTop;this._cache.renderWidth=r.getRenderWidth();this._cache.renderHeight=r.getRenderHeight()}this.onProjectionMatrixChangedObservable.notifyObservers(this);return this._projectionMatrix};i.prototype.getTranformationMatrix=function(){this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix);return this._transformMatrix};i.prototype.updateFrustumPlanes=function(){if(!this._refreshFrustumPlanes){return}this.getTranformationMatrix();if(!this._frustumPlanes){this._frustumPlanes=e.Frustum.GetPlanes(this._transformMatrix)}else{e.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes)}this._refreshFrustumPlanes=false};i.prototype.isInFrustum=function(e){this.updateFrustumPlanes();return e.isInFrustum(this._frustumPlanes)};i.prototype.isCompletelyInFrustum=function(e){this.updateFrustumPlanes();return e.isCompletelyInFrustum(this._frustumPlanes)};i.prototype.getForwardRay=function(t,i,r){if(t===void 0){t=100}if(!i){i=this.getWorldMatrix()}if(!r){r=this.position}var n=new e.Vector3(0,0,1);var o=e.Vector3.TransformNormal(n,i);var s=e.Vector3.Normalize(o);return new e.Ray(r,s,t)};i.prototype.dispose=function(e,r){if(r===void 0){r=false}this.onViewMatrixChangedObservable.clear();this.onProjectionMatrixChangedObservable.clear();this.onAfterCheckInputsObservable.clear();this.onRestoreStateObservable.clear();if(this.inputs){this.inputs.clear()}this.getScene().stopAnimation(this);this.getScene().removeCamera(this);while(this._rigCameras.length>0){var n=this._rigCameras.pop();if(n){n.dispose()}}if(this._rigPostProcess){this._rigPostProcess.dispose(this);this._rigPostProcess=null;this._postProcesses=[]}else if(this.cameraRigMode!==i.RIG_MODE_NONE){this._rigPostProcess=null;this._postProcesses=[]}else{var o=this._postProcesses.length;while(--o>=0){var s=this._postProcesses[o];if(s){s.dispose(this)}}}var o=this.customRenderTargets.length;while(--o>=0){this.customRenderTargets[o].dispose()}this.customRenderTargets=[];this._activeMeshes.dispose();t.prototype.dispose.call(this,e,r)};Object.defineProperty(i.prototype,"leftCamera",{get:function(){if(this._rigCameras.length<1){return null}return this._rigCameras[0]},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rightCamera",{get:function(){if(this._rigCameras.length<2){return null}return this._rigCameras[1]},enumerable:true,configurable:true});i.prototype.getLeftTarget=function(){if(this._rigCameras.length<1){return null}return this._rigCameras[0].getTarget()};i.prototype.getRightTarget=function(){if(this._rigCameras.length<2){return null}return this._rigCameras[1].getTarget()};i.prototype.setCameraRigMode=function(t,r){if(this.cameraRigMode===t){return}while(this._rigCameras.length>0){var n=this._rigCameras.pop();if(n){n.dispose()}}this.cameraRigMode=t;this._cameraRigParams={};this._cameraRigParams.interaxialDistance=r.interaxialDistance||.0637;this._cameraRigParams.stereoHalfAngle=e.Tools.ToRadians(this._cameraRigParams.interaxialDistance/.0637);if(this.cameraRigMode!==i.RIG_MODE_NONE){var o=this.createRigCamera(this.name+"_L",0);var s=this.createRigCamera(this.name+"_R",1);if(o&&s){this._rigCameras.push(o);this._rigCameras.push(s)}}switch(this.cameraRigMode){case i.RIG_MODE_STEREOSCOPIC_ANAGLYPH:this._rigCameras[0]._rigPostProcess=new e.PassPostProcess(this.name+"_passthru",1,this._rigCameras[0]);this._rigCameras[1]._rigPostProcess=new e.AnaglyphPostProcess(this.name+"_anaglyph",1,this._rigCameras);break;case i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case i.RIG_MODE_STEREOSCOPIC_OVERUNDER:var a=this.cameraRigMode===i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||this.cameraRigMode===i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;this._rigCameras[0]._rigPostProcess=new e.PassPostProcess(this.name+"_passthru",1,this._rigCameras[0]);this._rigCameras[1]._rigPostProcess=new e.StereoscopicInterlacePostProcess(this.name+"_stereoInterlace",this._rigCameras,a);break;case i.RIG_MODE_VR:var u=r.vrCameraMetrics||e.VRCameraMetrics.GetDefault();this._rigCameras[0]._cameraRigParams.vrMetrics=u;this._rigCameras[0].viewport=new e.Viewport(0,0,.5,1);this._rigCameras[0]._cameraRigParams.vrWorkMatrix=new e.Matrix;this._rigCameras[0]._cameraRigParams.vrHMatrix=u.leftHMatrix;this._rigCameras[0]._cameraRigParams.vrPreViewMatrix=u.leftPreViewMatrix;this._rigCameras[0].getProjectionMatrix=this._rigCameras[0]._getVRProjectionMatrix;this._rigCameras[1]._cameraRigParams.vrMetrics=u;this._rigCameras[1].viewport=new e.Viewport(.5,0,.5,1);this._rigCameras[1]._cameraRigParams.vrWorkMatrix=new e.Matrix;this._rigCameras[1]._cameraRigParams.vrHMatrix=u.rightHMatrix;this._rigCameras[1]._cameraRigParams.vrPreViewMatrix=u.rightPreViewMatrix;this._rigCameras[1].getProjectionMatrix=this._rigCameras[1]._getVRProjectionMatrix;if(u.compensateDistortion){this._rigCameras[0]._rigPostProcess=new e.VRDistortionCorrectionPostProcess("VR_Distort_Compensation_Left",this._rigCameras[0],false,u);this._rigCameras[1]._rigPostProcess=new e.VRDistortionCorrectionPostProcess("VR_Distort_Compensation_Right",this._rigCameras[1],true,u)}break;case i.RIG_MODE_WEBVR:if(r.vrDisplay){var l=r.vrDisplay.getEyeParameters("left");var c=r.vrDisplay.getEyeParameters("right");this._rigCameras[0].viewport=new e.Viewport(0,0,.5,1);this._rigCameras[0].setCameraRigParameter("left",true);this._rigCameras[0].setCameraRigParameter("specs",r.specs);this._rigCameras[0].setCameraRigParameter("eyeParameters",l);this._rigCameras[0].setCameraRigParameter("frameData",r.frameData);this._rigCameras[0].setCameraRigParameter("parentCamera",r.parentCamera);this._rigCameras[0]._cameraRigParams.vrWorkMatrix=new e.Matrix;this._rigCameras[0].getProjectionMatrix=this._getWebVRProjectionMatrix;this._rigCameras[0].parent=this;this._rigCameras[0]._getViewMatrix=this._getWebVRViewMatrix;this._rigCameras[1].viewport=new e.Viewport(.5,0,.5,1);this._rigCameras[1].setCameraRigParameter("eyeParameters",c);this._rigCameras[1].setCameraRigParameter("specs",r.specs);this._rigCameras[1].setCameraRigParameter("frameData",r.frameData);this._rigCameras[1].setCameraRigParameter("parentCamera",r.parentCamera);this._rigCameras[1]._cameraRigParams.vrWorkMatrix=new e.Matrix;this._rigCameras[1].getProjectionMatrix=this._getWebVRProjectionMatrix;this._rigCameras[1].parent=this;this._rigCameras[1]._getViewMatrix=this._getWebVRViewMatrix;if(i.UseAlternateWebVRRendering){this._rigCameras[1]._skipRendering=true;this._rigCameras[0]._alternateCamera=this._rigCameras[1]}}break}this._cascadePostProcessesToRigCams();this.update()};i.prototype._getVRProjectionMatrix=function(){e.Matrix.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix);this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix);return this._projectionMatrix};i.prototype._updateCameraRotationMatrix=function(){};i.prototype._updateWebVRCameraRotationMatrix=function(){};i.prototype._getWebVRProjectionMatrix=function(){return e.Matrix.Identity()};i.prototype._getWebVRViewMatrix=function(){return e.Matrix.Identity()};i.prototype.setCameraRigParameter=function(t,i){if(!this._cameraRigParams){this._cameraRigParams={}}this._cameraRigParams[t]=i;if(t==="interaxialDistance"){this._cameraRigParams.stereoHalfAngle=e.Tools.ToRadians(i/.0637)}};i.prototype.createRigCamera=function(e,t){return null};i.prototype._updateRigCameras=function(){for(var e=0;e<this._rigCameras.length;e++){this._rigCameras[e].minZ=this.minZ;this._rigCameras[e].maxZ=this.maxZ;this._rigCameras[e].fov=this.fov}if(this.cameraRigMode===i.RIG_MODE_STEREOSCOPIC_ANAGLYPH){this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport}};i.prototype._setupInputs=function(){};i.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);t.type=this.getClassName();if(this.parent){t.parentId=this.parent.id}if(this.inputs){this.inputs.serialize(t)}e.Animation.AppendSerializedAnimations(this,t);t.ranges=this.serializeAnimationRanges();return t};i.prototype.clone=function(t){return e.SerializationHelper.Clone(i.GetConstructorFromName(this.getClassName(),t,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this)};i.prototype.getDirection=function(t){var i=e.Vector3.Zero();this.getDirectionToRef(t,i);return i};i.prototype.getDirectionToRef=function(t,i){e.Vector3.TransformNormalToRef(t,this.getWorldMatrix(),i)};i.GetConstructorFromName=function(t,i,r,n,o){if(n===void 0){n=0}if(o===void 0){o=true}switch(t){case"ArcRotateCamera":return function(){return new e.ArcRotateCamera(i,0,0,1,e.Vector3.Zero(),r)};case"DeviceOrientationCamera":return function(){return new e.DeviceOrientationCamera(i,e.Vector3.Zero(),r)};case"FollowCamera":return function(){return new e.FollowCamera(i,e.Vector3.Zero(),r)};case"ArcFollowCamera":return function(){return new e.ArcFollowCamera(i,0,0,1,null,r)};case"GamepadCamera":return function(){return new e.GamepadCamera(i,e.Vector3.Zero(),r)};case"TouchCamera":return function(){return new e.TouchCamera(i,e.Vector3.Zero(),r)};case"VirtualJoysticksCamera":return function(){return new e.VirtualJoysticksCamera(i,e.Vector3.Zero(),r)};case"WebVRFreeCamera":return function(){return new e.WebVRFreeCamera(i,e.Vector3.Zero(),r)};case"WebVRGamepadCamera":return function(){return new e.WebVRFreeCamera(i,e.Vector3.Zero(),r)};case"VRDeviceOrientationFreeCamera":return function(){return new e.VRDeviceOrientationFreeCamera(i,e.Vector3.Zero(),r)};case"VRDeviceOrientationGamepadCamera":return function(){return new e.VRDeviceOrientationGamepadCamera(i,e.Vector3.Zero(),r)};case"AnaglyphArcRotateCamera":return function(){return new e.AnaglyphArcRotateCamera(i,0,0,1,e.Vector3.Zero(),n,r)};case"AnaglyphFreeCamera":return function(){return new e.AnaglyphFreeCamera(i,e.Vector3.Zero(),n,r)};case"AnaglyphGamepadCamera":return function(){return new e.AnaglyphGamepadCamera(i,e.Vector3.Zero(),n,r)};case"AnaglyphUniversalCamera":return function(){
return new e.AnaglyphUniversalCamera(i,e.Vector3.Zero(),n,r)};case"StereoscopicArcRotateCamera":return function(){return new e.StereoscopicArcRotateCamera(i,0,0,1,e.Vector3.Zero(),n,o,r)};case"StereoscopicFreeCamera":return function(){return new e.StereoscopicFreeCamera(i,e.Vector3.Zero(),n,o,r)};case"StereoscopicGamepadCamera":return function(){return new e.StereoscopicGamepadCamera(i,e.Vector3.Zero(),n,o,r)};case"StereoscopicUniversalCamera":return function(){return new e.StereoscopicUniversalCamera(i,e.Vector3.Zero(),n,o,r)};case"FreeCamera":return function(){return new e.UniversalCamera(i,e.Vector3.Zero(),r)};default:return function(){return new e.UniversalCamera(i,e.Vector3.Zero(),r)}}};i.prototype.computeWorldMatrix=function(){return this.getWorldMatrix()};i.Parse=function(t,r){var n=t.type;var o=i.GetConstructorFromName(n,t.name,r,t.interaxial_distance,t.isStereoscopicSideBySide);var s=e.SerializationHelper.Parse(o,t,r);if(t.parentId){s._waitingParentId=t.parentId}if(s.inputs){s.inputs.parse(t);s._setupInputs()}if(s.setPosition){s.position.copyFromFloats(0,0,0);s.setPosition(e.Vector3.FromArray(t.position))}if(t.target){if(s.setTarget){s.setTarget(e.Vector3.FromArray(t.target))}}if(t.cameraRigMode){var a=t.interaxial_distance?{interaxialDistance:t.interaxial_distance}:{};s.setCameraRigMode(t.cameraRigMode,a)}if(t.animations){for(var u=0;u<t.animations.length;u++){var l=t.animations[u];s.animations.push(e.Animation.Parse(l))}e.Node.ParseAnimationRanges(s,t,r)}if(t.autoAnimate){r.beginAnimation(s,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1)}return s};i._PERSPECTIVE_CAMERA=0;i._ORTHOGRAPHIC_CAMERA=1;i._FOVMODE_VERTICAL_FIXED=0;i._FOVMODE_HORIZONTAL_FIXED=1;i._RIG_MODE_NONE=0;i._RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;i._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;i._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;i._RIG_MODE_STEREOSCOPIC_OVERUNDER=13;i._RIG_MODE_VR=20;i._RIG_MODE_WEBVR=21;i.ForceAttachControlToAlwaysPreventDefault=false;i.UseAlternateWebVRRendering=false;__decorate([e.serializeAsVector3()],i.prototype,"position",void 0);__decorate([e.serializeAsVector3()],i.prototype,"upVector",void 0);__decorate([e.serialize()],i.prototype,"orthoLeft",void 0);__decorate([e.serialize()],i.prototype,"orthoRight",void 0);__decorate([e.serialize()],i.prototype,"orthoBottom",void 0);__decorate([e.serialize()],i.prototype,"orthoTop",void 0);__decorate([e.serialize()],i.prototype,"fov",void 0);__decorate([e.serialize()],i.prototype,"minZ",void 0);__decorate([e.serialize()],i.prototype,"maxZ",void 0);__decorate([e.serialize()],i.prototype,"inertia",void 0);__decorate([e.serialize()],i.prototype,"mode",void 0);__decorate([e.serialize()],i.prototype,"layerMask",void 0);__decorate([e.serialize()],i.prototype,"fovMode",void 0);__decorate([e.serialize()],i.prototype,"cameraRigMode",void 0);__decorate([e.serialize()],i.prototype,"interaxialDistance",void 0);__decorate([e.serialize()],i.prototype,"isStereoscopicSideBySide",void 0);return i}(e.Node);e.Camera=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e){this._renderingGroups=new Array;this._autoClearDepthStencil={};this._customOpaqueSortCompareFn={};this._customAlphaTestSortCompareFn={};this._customTransparentSortCompareFn={};this._renderinGroupInfo=null;this._scene=e;for(var i=t.MIN_RENDERINGGROUPS;i<t.MAX_RENDERINGGROUPS;i++){this._autoClearDepthStencil[i]={autoClear:true,depth:true,stencil:true}}}t.prototype._clearDepthStencilBuffer=function(e,t){if(e===void 0){e=true}if(t===void 0){t=true}if(this._depthStencilBufferAlreadyCleaned){return}this._scene.getEngine().clear(null,false,e,t);this._depthStencilBufferAlreadyCleaned=true};t.prototype.render=function(i,r,n,o){var s=this._scene.onRenderingGroupObservable.hasObservers()?this._scene.onRenderingGroupObservable:null;var a=null;if(s){if(!this._renderinGroupInfo){this._renderinGroupInfo=new e.RenderingGroupInfo}a=this._renderinGroupInfo;a.scene=this._scene;a.camera=this._scene.activeCamera}if(o){for(var u=0;u<this._scene.spriteManagers.length;u++){var l=this._scene.spriteManagers[u];this.dispatchSprites(l)}}for(var u=t.MIN_RENDERINGGROUPS;u<t.MAX_RENDERINGGROUPS;u++){this._depthStencilBufferAlreadyCleaned=u===t.MIN_RENDERINGGROUPS;var c=this._renderingGroups[u];if(!c&&!s)continue;var h=0;if(s&&a){h=Math.pow(2,u);a.renderStage=e.RenderingGroupInfo.STAGE_PRECLEAR;a.renderingGroupId=u;s.notifyObservers(a,h)}if(t.AUTOCLEAR){var f=this._autoClearDepthStencil[u];if(f&&f.autoClear){this._clearDepthStencilBuffer(f.depth,f.stencil)}}if(s&&a){a.renderStage=e.RenderingGroupInfo.STAGE_PREOPAQUE;s.notifyObservers(a,h);a.renderStage=e.RenderingGroupInfo.STAGE_PRETRANSPARENT;s.notifyObservers(a,h)}if(c)c.render(i,o,n,r);if(s&&a){a.renderStage=e.RenderingGroupInfo.STAGE_POSTTRANSPARENT;s.notifyObservers(a,h)}}};t.prototype.reset=function(){for(var e=t.MIN_RENDERINGGROUPS;e<t.MAX_RENDERINGGROUPS;e++){var i=this._renderingGroups[e];if(i){i.prepare()}}};t.prototype.dispose=function(){this.freeRenderingGroups();this._renderingGroups.length=0};t.prototype.freeRenderingGroups=function(){for(var e=t.MIN_RENDERINGGROUPS;e<t.MAX_RENDERINGGROUPS;e++){var i=this._renderingGroups[e];if(i){i.dispose()}}};t.prototype._prepareRenderingGroup=function(t){if(this._renderingGroups[t]===undefined){this._renderingGroups[t]=new e.RenderingGroup(t,this._scene,this._customOpaqueSortCompareFn[t],this._customAlphaTestSortCompareFn[t],this._customTransparentSortCompareFn[t])}};t.prototype.dispatchSprites=function(e){var t=e.renderingGroupId||0;this._prepareRenderingGroup(t);this._renderingGroups[t].dispatchSprites(e)};t.prototype.dispatchParticles=function(e){var t=e.renderingGroupId||0;this._prepareRenderingGroup(t);this._renderingGroups[t].dispatchParticles(e)};t.prototype.dispatch=function(e,t,i){if(t===undefined){t=e.getMesh()}var r=t.renderingGroupId||0;this._prepareRenderingGroup(r);this._renderingGroups[r].dispatch(e,t,i)};t.prototype.setRenderingOrder=function(e,t,i,r){if(t===void 0){t=null}if(i===void 0){i=null}if(r===void 0){r=null}this._customOpaqueSortCompareFn[e]=t;this._customAlphaTestSortCompareFn[e]=i;this._customTransparentSortCompareFn[e]=r;if(this._renderingGroups[e]){var n=this._renderingGroups[e];n.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e];n.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e];n.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}};t.prototype.setRenderingAutoClearDepthStencil=function(e,t,i,r){if(i===void 0){i=true}if(r===void 0){r=true}this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:r}};t.MAX_RENDERINGGROUPS=4;t.MIN_RENDERINGGROUPS=0;t.AUTOCLEAR=true;return t}();e.RenderingManager=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r,n,o){if(r===void 0){r=null}if(n===void 0){n=null}if(o===void 0){o=null}this.index=t;this._opaqueSubMeshes=new e.SmartArray(256);this._transparentSubMeshes=new e.SmartArray(256);this._alphaTestSubMeshes=new e.SmartArray(256);this._depthOnlySubMeshes=new e.SmartArray(256);this._particleSystems=new e.SmartArray(256);this._spriteManagers=new e.SmartArray(256);this._edgesRenderers=new e.SmartArray(16);this._scene=i;this.opaqueSortCompareFn=r;this.alphaTestSortCompareFn=n;this.transparentSortCompareFn=o}Object.defineProperty(t.prototype,"opaqueSortCompareFn",{set:function(e){this._opaqueSortCompareFn=e;if(e){this._renderOpaque=this.renderOpaqueSorted}else{this._renderOpaque=t.renderUnsorted}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"alphaTestSortCompareFn",{set:function(e){this._alphaTestSortCompareFn=e;if(e){this._renderAlphaTest=this.renderAlphaTestSorted}else{this._renderAlphaTest=t.renderUnsorted}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"transparentSortCompareFn",{set:function(e){if(e){this._transparentSortCompareFn=e}else{this._transparentSortCompareFn=t.defaultTransparentSortCompare}this._renderTransparent=this.renderTransparentSorted},enumerable:true,configurable:true});t.prototype.render=function(t,i,r,n){if(t){t(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}var o=this._scene.getEngine();if(this._depthOnlySubMeshes.length!==0){o.setColorWrite(false);this._renderAlphaTest(this._depthOnlySubMeshes);o.setColorWrite(true)}if(this._opaqueSubMeshes.length!==0){this._renderOpaque(this._opaqueSubMeshes)}if(this._alphaTestSubMeshes.length!==0){this._renderAlphaTest(this._alphaTestSubMeshes)}var s=o.getStencilBuffer();o.setStencilBuffer(false);if(i){this._renderSprites()}if(r){this._renderParticles(n)}if(this.onBeforeTransparentRendering){this.onBeforeTransparentRendering()}if(this._transparentSubMeshes.length!==0){this._renderTransparent(this._transparentSubMeshes);o.setAlphaMode(e.Engine.ALPHA_DISABLE)}o.setStencilBuffer(false);for(var a=0;a<this._edgesRenderers.length;a++){this._edgesRenderers.data[a].render()}o.setStencilBuffer(s)};t.prototype.renderOpaqueSorted=function(e){return t.renderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,false)};t.prototype.renderAlphaTestSorted=function(e){return t.renderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,false)};t.prototype.renderTransparentSorted=function(e){return t.renderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,true)};t.renderSorted=function(t,i,r,n){var o=0;var s;var a=r?r.globalPosition:e.Vector3.Zero();for(;o<t.length;o++){s=t.data[o];s._alphaIndex=s.getMesh().alphaIndex;s._distanceToCamera=s.getBoundingInfo().boundingSphere.centerWorld.subtract(a).length()}var u=t.data.slice(0,t.length);if(i){u.sort(i)}for(o=0;o<u.length;o++){s=u[o];if(n){var l=s.getMaterial();if(l&&l.needDepthPrePass){var c=l.getScene().getEngine();c.setColorWrite(false);c.setAlphaMode(e.Engine.ALPHA_DISABLE);s.render(false);c.setColorWrite(true)}}s.render(n)}};t.renderUnsorted=function(e){for(var t=0;t<e.length;t++){var i=e.data[t];i.render(false)}};t.defaultTransparentSortCompare=function(e,i){if(e._alphaIndex>i._alphaIndex){return 1}if(e._alphaIndex<i._alphaIndex){return-1}return t.backToFrontSortCompare(e,i)};t.backToFrontSortCompare=function(e,t){if(e._distanceToCamera<t._distanceToCamera){return 1}if(e._distanceToCamera>t._distanceToCamera){return-1}return 0};t.frontToBackSortCompare=function(e,t){if(e._distanceToCamera<t._distanceToCamera){return-1}if(e._distanceToCamera>t._distanceToCamera){return 1}return 0};t.prototype.prepare=function(){this._opaqueSubMeshes.reset();this._transparentSubMeshes.reset();this._alphaTestSubMeshes.reset();this._depthOnlySubMeshes.reset();this._particleSystems.reset();this._spriteManagers.reset();this._edgesRenderers.reset()};t.prototype.dispose=function(){this._opaqueSubMeshes.dispose();this._transparentSubMeshes.dispose();this._alphaTestSubMeshes.dispose();this._depthOnlySubMeshes.dispose();this._particleSystems.dispose();this._spriteManagers.dispose();this._edgesRenderers.dispose()};t.prototype.dispatch=function(e,t,i){if(t===undefined){t=e.getMesh()}if(i===undefined){i=e.getMaterial()}if(i===null||i===undefined){return}if(i.needAlphaBlendingForMesh(t)){this._transparentSubMeshes.push(e)}else if(i.needAlphaTesting()){if(i.needDepthPrePass){this._depthOnlySubMeshes.push(e)}this._alphaTestSubMeshes.push(e)}else{if(i.needDepthPrePass){this._depthOnlySubMeshes.push(e)}this._opaqueSubMeshes.push(e)}if(t._edgesRenderer!==null&&t._edgesRenderer!==undefined){this._edgesRenderers.push(t._edgesRenderer)}};t.prototype.dispatchSprites=function(e){this._spriteManagers.push(e)};t.prototype.dispatchParticles=function(e){this._particleSystems.push(e)};t.prototype._renderParticles=function(e){if(this._particleSystems.length===0){return}var t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(var i=0;i<this._particleSystems.length;i++){var r=this._particleSystems.data[i];if((t&&t.layerMask&r.layerMask)===0){continue}var n=r.emitter;if(!n.position||!e||e.indexOf(n)!==-1){this._scene._activeParticles.addCount(r.render(),false)}}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)};t.prototype._renderSprites=function(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0){return}var e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(var t=0;t<this._spriteManagers.length;t++){var i=this._spriteManagers.data[t];if((e&&e.layerMask&i.layerMask)!==0){i.render()}}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)};return t}();e.RenderingGroup=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this._singleClick=false;this._doubleClick=false;this._hasSwiped=false;this._ignore=false}Object.defineProperty(e.prototype,"singleClick",{get:function(){return this._singleClick},set:function(e){this._singleClick=e},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"doubleClick",{get:function(){return this._doubleClick},set:function(e){this._doubleClick=e},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"hasSwiped",{get:function(){return this._hasSwiped},set:function(e){this._hasSwiped=e},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"ignore",{get:function(){return this._ignore},set:function(e){this._ignore=e},enumerable:true,configurable:true});return e}();var i=function(){function e(){}e.STAGE_PRECLEAR=1;e.STAGE_PREOPAQUE=2;e.STAGE_PRETRANSPARENT=3;e.STAGE_POSTTRANSPARENT=4;return e}();e.RenderingGroupInfo=i;var r=function(){function i(t){this.autoClear=true;this.autoClearDepthAndStencil=true;this.clearColor=new e.Color4(.2,.2,.3,1);this.ambientColor=new e.Color3(0,0,0);this._forceWireframe=false;this._forcePointsCloud=false;this.forceShowBoundingBoxes=false;this.animationsEnabled=true;this.useConstantAnimationDeltaTime=false;this.constantlyUpdateMeshUnderPointer=false;this.hoverCursor="pointer";this.defaultCursor="";this.preventDefaultOnPointerDown=true;this.metadata=null;this.disableOfflineSupportExceptionRules=new Array;this.onDisposeObservable=new e.Observable;this._onDisposeObserver=null;this.onBeforeRenderObservable=new e.Observable;this._onBeforeRenderObserver=null;this.onAfterRenderObservable=new e.Observable;this._onAfterRenderObserver=null;this.onBeforeAnimationsObservable=new e.Observable;this.onAfterAnimationsObservable=new e.Observable;this.onBeforeDrawPhaseObservable=new e.Observable;this.onAfterDrawPhaseObservable=new e.Observable;this.onBeforePhysicsObservable=new e.Observable;this.onAfterPhysicsObservable=new e.Observable;this.onReadyObservable=new e.Observable;this.onBeforeCameraRenderObservable=new e.Observable;this._onBeforeCameraRenderObserver=null;this.onAfterCameraRenderObservable=new e.Observable;this._onAfterCameraRenderObserver=null;this.onBeforeActiveMeshesEvaluationObservable=new e.Observable;this.onAfterActiveMeshesEvaluationObservable=new e.Observable;this.onBeforeParticlesRenderingObservable=new e.Observable;this.onAfterParticlesRenderingObservable=new e.Observable;this.onBeforeSpritesRenderingObservable=new e.Observable;this.onAfterSpritesRenderingObservable=new e.Observable;this.onDataLoadedObservable=new e.Observable;this.onNewCameraAddedObservable=new e.Observable;this.onCameraRemovedObservable=new e.Observable;this.onNewLightAddedObservable=new e.Observable;this.onLightRemovedObservable=new e.Observable;this.onNewGeometryAddedObservable=new e.Observable;this.onGeometryRemovedObservable=new e.Observable;this.onNewTransformNodeAddedObservable=new e.Observable;this.onTransformNodeRemovedObservable=new e.Observable;this.onNewMeshAddedObservable=new e.Observable;this.onMeshRemovedObservable=new e.Observable;this.onBeforeRenderTargetsRenderObservable=new e.Observable;this.onAfterRenderTargetsRenderObservable=new e.Observable;this.onBeforeStepObservable=new e.Observable;this.onAfterStepObservable=new e.Observable;this.onRenderingGroupObservable=new e.Observable;this.animations=[];this._registeredForLateAnimationBindings=new e.SmartArrayNoDuplicate(256);this.onPrePointerObservable=new e.Observable;this.onPointerObservable=new e.Observable;this._meshPickProceed=false;this._currentPickResult=null;this._previousPickResult=null;this._totalPointersPressed=0;this._doubleClickOccured=false;this.cameraToUseForPointers=null;this._startingPointerPosition=new e.Vector2(0,0);this._previousStartingPointerPosition=new e.Vector2(0,0);this._startingPointerTime=0;this._previousStartingPointerTime=0;this._timeAccumulator=0;this._currentStepId=0;this._currentInternalStep=0;this.onPreKeyboardObservable=new e.Observable;this.onKeyboardObservable=new e.Observable;this._useRightHandedSystem=false;this._fogEnabled=true;this._fogMode=i.FOGMODE_NONE;this.fogColor=new e.Color3(.2,.2,.3);this.fogDensity=.1;this.fogStart=0;this.fogEnd=1e3;this._shadowsEnabled=true;this._lightsEnabled=true;this.lights=new Array;this.cameras=new Array;this.activeCameras=new Array;this.transformNodes=new Array;this.meshes=new Array;this.animationGroups=new Array;this._geometries=new Array;this.materials=new Array;this.multiMaterials=new Array;this._texturesEnabled=true;this.textures=new Array;this.particlesEnabled=true;this.particleSystems=new Array;this.spritesEnabled=true;this.spriteManagers=new Array;this.layers=new Array;this.effectLayers=new Array;this._skeletonsEnabled=true;this.skeletons=new Array;this.morphTargetManagers=new Array;this.lensFlaresEnabled=true;this.lensFlareSystems=new Array;this.collisionsEnabled=true;this.gravity=new e.Vector3(0,-9.807,0);this.postProcessesEnabled=true;this.postProcesses=new Array;this.renderTargetsEnabled=true;this.dumpNextRenderTargets=false;this.customRenderTargets=new Array;this.importedMeshesFiles=new Array;this.probesEnabled=true;this.reflectionProbes=new Array;this._actionManagers=new Array;this._meshesForIntersections=new e.SmartArrayNoDuplicate(256);this.proceduralTexturesEnabled=true;this.proceduralTextures=new Array;this.soundTracks=new Array;this._audioEnabled=true;this._headphone=false;this._totalVertices=new e.PerfCounter;this._activeIndices=new e.PerfCounter;this._activeParticles=new e.PerfCounter;this._activeBones=new e.PerfCounter;this._animationTime=0;this.animationTimeScale=1;this._renderId=0;this._executeWhenReadyTimeoutId=-1;this._intermediateRendering=false;this._viewUpdateFlag=-1;this._projectionUpdateFlag=-1;this._alternateViewUpdateFlag=-1;this._alternateProjectionUpdateFlag=-1;this._toBeDisposed=new e.SmartArray(256);this._activeRequests=new Array;this._pendingData=new Array;this._isDisposed=false;this.dispatchAllSubMeshesOfActiveMeshes=false;this._activeMeshes=new e.SmartArray(256);this._processedMaterials=new e.SmartArray(256);this._renderTargets=new e.SmartArrayNoDuplicate(256);this._activeParticleSystems=new e.SmartArray(256);this._activeSkeletons=new e.SmartArrayNoDuplicate(32);this._softwareSkinnedMeshes=new e.SmartArrayNoDuplicate(32);this._activeAnimatables=new Array;this._transformMatrix=e.Matrix.Zero();this._useAlternateCameraConfiguration=false;this._alternateRendering=false;this.requireLightSorting=false;this._depthRenderer={};this._activeMeshesFrozen=false;this._tempPickingRay=e.Ray?e.Ray.Zero():null;this._engine=t||e.Engine.LastCreatedEngine;this._engine.scenes.push(this);this._uid=null;this._renderingManager=new e.RenderingManager(this);this.postProcessManager=new e.PostProcessManager(this);if(e.OutlineRenderer){this._outlineRenderer=new e.OutlineRenderer(this)}if(e.Tools.IsWindowObjectExist()){this.attachControl()}if(e.SimplificationQueue){this.simplificationQueue=new e.SimplificationQueue}this.workerCollisions=false;this._createUbo();this._imageProcessingConfiguration=new e.ImageProcessingConfiguration}Object.defineProperty(i,"FOGMODE_NONE",{get:function(){return i._FOGMODE_NONE},enumerable:true,configurable:true});Object.defineProperty(i,"FOGMODE_EXP",{get:function(){return i._FOGMODE_EXP},enumerable:true,configurable:true});Object.defineProperty(i,"FOGMODE_EXP2",{get:function(){return i._FOGMODE_EXP2},enumerable:true,configurable:true});Object.defineProperty(i,"FOGMODE_LINEAR",{get:function(){return i._FOGMODE_LINEAR},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"environmentTexture",{get:function(){return this._environmentTexture},set:function(t){if(this._environmentTexture===t){return}this._environmentTexture=t;this.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"forceWireframe",{get:function(){return this._forceWireframe},set:function(t){if(this._forceWireframe===t){return}this._forceWireframe=t;this.markAllMaterialsAsDirty(e.Material.MiscDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"forcePointsCloud",{get:function(){return this._forcePointsCloud},set:function(t){if(this._forcePointsCloud===t){return}this._forcePointsCloud=t;this.markAllMaterialsAsDirty(e.Material.MiscDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"onDispose",{set:function(e){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"beforeRender",{set:function(e){if(this._onBeforeRenderObserver){this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver)}if(e){this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"afterRender",{set:function(e){if(this._onAfterRenderObserver){this.onAfterRenderObservable.remove(this._onAfterRenderObserver)}if(e){this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"beforeCameraRender",{set:function(e){if(this._onBeforeCameraRenderObserver){this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver)}this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"afterCameraRender",{set:function(e){if(this._onAfterCameraRenderObserver){this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver)}this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new e.GamepadManager(this)}return this._gamepadManager},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"unTranslatedPointer",{get:function(){return new e.Vector2(this._unTranslatedPointerX,this._unTranslatedPointerY)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"useRightHandedSystem",{get:function(){return this._useRightHandedSystem},set:function(t){if(this._useRightHandedSystem===t){return}this._useRightHandedSystem=t;this.markAllMaterialsAsDirty(e.Material.MiscDirtyFlag)},enumerable:true,configurable:true});i.prototype.setStepId=function(e){this._currentStepId=e};i.prototype.getStepId=function(){return this._currentStepId};i.prototype.getInternalStep=function(){return this._currentInternalStep};Object.defineProperty(i.prototype,"fogEnabled",{get:function(){return this._fogEnabled},set:function(t){if(this._fogEnabled===t){return}this._fogEnabled=t;this.markAllMaterialsAsDirty(e.Material.MiscDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"fogMode",{get:function(){return this._fogMode},set:function(t){if(this._fogMode===t){return}this._fogMode=t;this.markAllMaterialsAsDirty(e.Material.MiscDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"shadowsEnabled",{get:function(){return this._shadowsEnabled},set:function(t){if(this._shadowsEnabled===t){return}this._shadowsEnabled=t;this.markAllMaterialsAsDirty(e.Material.LightDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"lightsEnabled",{get:function(){return this._lightsEnabled},set:function(t){if(this._lightsEnabled===t){return}this._lightsEnabled=t;this.markAllMaterialsAsDirty(e.Material.LightDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"defaultMaterial",{get:function(){if(!this._defaultMaterial){this._defaultMaterial=new e.StandardMaterial("default material",this)}return this._defaultMaterial},set:function(e){this._defaultMaterial=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"texturesEnabled",{get:function(){return this._texturesEnabled},set:function(t){if(this._texturesEnabled===t){return}this._texturesEnabled=t;this.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"skeletonsEnabled",{get:function(){return this._skeletonsEnabled},set:function(t){if(this._skeletonsEnabled===t){return}this._skeletonsEnabled=t;this.markAllMaterialsAsDirty(e.Material.AttributesDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){this._postProcessRenderPipelineManager=new e.PostProcessRenderPipelineManager}return this._postProcessRenderPipelineManager},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"mainSoundTrack",{get:function(){if(!this._mainSoundTrack){this._mainSoundTrack=new e.SoundTrack(this,{mainTrack:true})}return this._mainSoundTrack},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"_isAlternateRenderingEnabled",{get:function(){return this._alternateRendering},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"frustumPlanes",{get:function(){return this._frustumPlanes},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(e){if(e&&e.isSupported){this._geometryBufferRenderer=e}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"debugLayer",{get:function(){if(!this._debugLayer){this._debugLayer=new e.DebugLayer(this)}return this._debugLayer},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"workerCollisions",{get:function(){return this._workerCollisions},set:function(t){if(!e.CollisionCoordinatorLegacy){return}t=t&&!!Worker&&!!e.CollisionWorker;this._workerCollisions=t;if(this.collisionCoordinator){this.collisionCoordinator.destroy()}this.collisionCoordinator=t?new e.CollisionCoordinatorWorker:new e.CollisionCoordinatorLegacy;this.collisionCoordinator.init(this)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"meshUnderPointer",{get:function(){return this._pointerOverMesh},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"pointerX",{get:function(){return this._pointerX},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"pointerY",{get:function(){return this._pointerY},enumerable:true,configurable:true});i.prototype.getCachedMaterial=function(){return this._cachedMaterial};i.prototype.getCachedEffect=function(){return this._cachedEffect};i.prototype.getCachedVisibility=function(){return this._cachedVisibility};i.prototype.isCachedMaterialInvalid=function(e,t,i){if(i===void 0){i=1}return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i};i.prototype.getBoundingBoxRenderer=function(){if(!this._boundingBoxRenderer){this._boundingBoxRenderer=new e.BoundingBoxRenderer(this)}return this._boundingBoxRenderer};i.prototype.getOutlineRenderer=function(){return this._outlineRenderer};i.prototype.getEngine=function(){return this._engine};i.prototype.getTotalVertices=function(){return this._totalVertices.current};Object.defineProperty(i.prototype,"totalVerticesPerfCounter",{get:function(){return this._totalVertices},enumerable:true,configurable:true});i.prototype.getActiveIndices=function(){return this._activeIndices.current};Object.defineProperty(i.prototype,"totalActiveIndicesPerfCounter",{get:function(){return this._activeIndices},enumerable:true,configurable:true});i.prototype.getActiveParticles=function(){return this._activeParticles.current};Object.defineProperty(i.prototype,"activeParticlesPerfCounter",{get:function(){return this._activeParticles},enumerable:true,configurable:true});i.prototype.getActiveBones=function(){return this._activeBones.current};Object.defineProperty(i.prototype,"activeBonesPerfCounter",{get:function(){return this._activeBones},enumerable:true,configurable:true});i.prototype.getInterFramePerfCounter=function(){e.Tools.Warn("getInterFramePerfCounter is deprecated. Please use SceneInstrumentation class");return 0};Object.defineProperty(i.prototype,"interFramePerfCounter",{get:function(){e.Tools.Warn("interFramePerfCounter is deprecated. Please use SceneInstrumentation class");return null},enumerable:true,configurable:true});i.prototype.getLastFrameDuration=function(){e.Tools.Warn("getLastFrameDuration is deprecated. Please use SceneInstrumentation class");return 0};Object.defineProperty(i.prototype,"lastFramePerfCounter",{get:function(){e.Tools.Warn("lastFramePerfCounter is deprecated. Please use SceneInstrumentation class");return null},enumerable:true,configurable:true});i.prototype.getEvaluateActiveMeshesDuration=function(){e.Tools.Warn("getEvaluateActiveMeshesDuration is deprecated. Please use SceneInstrumentation class");return 0};Object.defineProperty(i.prototype,"evaluateActiveMeshesDurationPerfCounter",{get:function(){e.Tools.Warn("evaluateActiveMeshesDurationPerfCounter is deprecated. Please use SceneInstrumentation class");return null},enumerable:true,configurable:true});i.prototype.getActiveMeshes=function(){return this._activeMeshes};i.prototype.getRenderTargetsDuration=function(){e.Tools.Warn("getRenderTargetsDuration is deprecated. Please use SceneInstrumentation class");return 0};i.prototype.getRenderDuration=function(){e.Tools.Warn("getRenderDuration is deprecated. Please use SceneInstrumentation class");return 0};Object.defineProperty(i.prototype,"renderDurationPerfCounter",{get:function(){e.Tools.Warn("renderDurationPerfCounter is deprecated. Please use SceneInstrumentation class");return null},enumerable:true,configurable:true});i.prototype.getParticlesDuration=function(){e.Tools.Warn("getParticlesDuration is deprecated. Please use SceneInstrumentation class");return 0};Object.defineProperty(i.prototype,"particlesDurationPerfCounter",{get:function(){e.Tools.Warn("particlesDurationPerfCounter is deprecated. Please use SceneInstrumentation class");return null},enumerable:true,configurable:true});i.prototype.getSpritesDuration=function(){e.Tools.Warn("getSpritesDuration is deprecated. Please use SceneInstrumentation class");return 0};Object.defineProperty(i.prototype,"spriteDuractionPerfCounter",{get:function(){e.Tools.Warn("spriteDuractionPerfCounter is deprecated. Please use SceneInstrumentation class");return null},enumerable:true,configurable:true});i.prototype.getAnimationRatio=function(){return this._animationRatio};i.prototype.getRenderId=function(){return this._renderId};i.prototype.incrementRenderId=function(){this._renderId++};i.prototype._updatePointerPosition=function(e){var t=this._engine.getRenderingCanvasClientRect();if(!t){return}this._pointerX=e.clientX-t.left;this._pointerY=e.clientY-t.top;this._unTranslatedPointerX=this._pointerX;this._unTranslatedPointerY=this._pointerY};i.prototype._createUbo=function(){this._sceneUbo=new e.UniformBuffer(this._engine,undefined,true);this._sceneUbo.addUniform("viewProjection",16)
;this._sceneUbo.addUniform("view",16)};i.prototype._createAlternateUbo=function(){this._alternateSceneUbo=new e.UniformBuffer(this._engine,undefined,true);this._alternateSceneUbo.addUniform("viewProjection",16);this._alternateSceneUbo.addUniform("view",16)};i.prototype.simulatePointerMove=function(e,t){var i=new PointerEvent("pointermove",t);return this._processPointerMove(e,i)};i.prototype._processPointerMove=function(t,i){var r=this._engine.getRenderingCanvas();if(!r){return this}if(t&&t.hit&&t.pickedMesh){this.setPointerOverSprite(null);this.setPointerOverMesh(t.pickedMesh);if(this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.hasPointerTriggers){if(this._pointerOverMesh.actionManager.hoverCursor){r.style.cursor=this._pointerOverMesh.actionManager.hoverCursor}else{r.style.cursor=this.hoverCursor}}else{r.style.cursor=this.defaultCursor}}else{this.setPointerOverMesh(null);t=this.pickSprite(this._unTranslatedPointerX,this._unTranslatedPointerY,this._spritePredicate,false,this.cameraToUseForPointers||undefined);if(t&&t.hit&&t.pickedSprite){this.setPointerOverSprite(t.pickedSprite);if(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.hoverCursor){r.style.cursor=this._pointerOverSprite.actionManager.hoverCursor}else{r.style.cursor=this.hoverCursor}}else{this.setPointerOverSprite(null);r.style.cursor=this.defaultCursor}}if(t){var n=i.type==="mousewheel"||i.type==="DOMMouseScroll"?e.PointerEventTypes.POINTERWHEEL:e.PointerEventTypes.POINTERMOVE;if(this.onPointerMove){this.onPointerMove(i,t,n)}if(this.onPointerObservable.hasObservers()){var o=new e.PointerInfo(n,i,t);this.onPointerObservable.notifyObservers(o,n)}}return this};i.prototype.simulatePointerDown=function(e,t){var i=new PointerEvent("pointerdown",t);return this._processPointerDown(e,i)};i.prototype._processPointerDown=function(t,r){var n=this;if(t&&t.hit&&t.pickedMesh){this._pickedDownMesh=t.pickedMesh;var o=t.pickedMesh.actionManager;if(o){if(o.hasPickTriggers){o.processTrigger(e.ActionManager.OnPickDownTrigger,e.ActionEvent.CreateNew(t.pickedMesh,r));switch(r.button){case 0:o.processTrigger(e.ActionManager.OnLeftPickTrigger,e.ActionEvent.CreateNew(t.pickedMesh,r));break;case 1:o.processTrigger(e.ActionManager.OnCenterPickTrigger,e.ActionEvent.CreateNew(t.pickedMesh,r));break;case 2:o.processTrigger(e.ActionManager.OnRightPickTrigger,e.ActionEvent.CreateNew(t.pickedMesh,r));break}}if(o.hasSpecificTrigger(e.ActionManager.OnLongPressTrigger)){window.setTimeout(function(){var t=n.pick(n._unTranslatedPointerX,n._unTranslatedPointerY,function(t){return t.isPickable&&t.isVisible&&t.isReady()&&t.actionManager&&t.actionManager.hasSpecificTrigger(e.ActionManager.OnLongPressTrigger)&&t==n._pickedDownMesh},false,n.cameraToUseForPointers);if(t&&t.hit&&t.pickedMesh&&o){if(n._totalPointersPressed!==0&&(new Date).getTime()-n._startingPointerTime>i.LongPressDelay&&(Math.abs(n._startingPointerPosition.x-n._pointerX)<i.DragMovementThreshold&&Math.abs(n._startingPointerPosition.y-n._pointerY)<i.DragMovementThreshold)){n._startingPointerTime=0;o.processTrigger(e.ActionManager.OnLongPressTrigger,e.ActionEvent.CreateNew(t.pickedMesh,r))}}},i.LongPressDelay)}}}if(t){var s=e.PointerEventTypes.POINTERDOWN;if(this.onPointerDown){this.onPointerDown(r,t,s)}if(this.onPointerObservable.hasObservers()){var a=new e.PointerInfo(s,r,t);this.onPointerObservable.notifyObservers(a,s)}}return this};i.prototype.simulatePointerUp=function(e,i){var r=new PointerEvent("pointerup",i);var n=new t;n.singleClick=true;n.ignore=true;return this._processPointerUp(e,r,n)};i.prototype._processPointerUp=function(t,i,r){if(t&&t&&t.pickedMesh){this._pickedUpMesh=t.pickedMesh;if(this._pickedDownMesh===this._pickedUpMesh){if(this.onPointerPick){this.onPointerPick(i,t)}if(r.singleClick&&!r.ignore&&this.onPointerObservable.hasObservers()){var n=e.PointerEventTypes.POINTERPICK;var o=new e.PointerInfo(n,i,t);this.onPointerObservable.notifyObservers(o,n)}}if(t.pickedMesh.actionManager){if(r.ignore){t.pickedMesh.actionManager.processTrigger(e.ActionManager.OnPickUpTrigger,e.ActionEvent.CreateNew(t.pickedMesh,i))}if(!r.hasSwiped&&!r.ignore&&r.singleClick){t.pickedMesh.actionManager.processTrigger(e.ActionManager.OnPickTrigger,e.ActionEvent.CreateNew(t.pickedMesh,i))}if(r.doubleClick&&!r.ignore&&t.pickedMesh.actionManager.hasSpecificTrigger(e.ActionManager.OnDoublePickTrigger)){t.pickedMesh.actionManager.processTrigger(e.ActionManager.OnDoublePickTrigger,e.ActionEvent.CreateNew(t.pickedMesh,i))}}}if(this._pickedDownMesh&&this._pickedDownMesh.actionManager&&this._pickedDownMesh.actionManager.hasSpecificTrigger(e.ActionManager.OnPickOutTrigger)&&this._pickedDownMesh!==this._pickedUpMesh){this._pickedDownMesh.actionManager.processTrigger(e.ActionManager.OnPickOutTrigger,e.ActionEvent.CreateNew(this._pickedDownMesh,i))}var s=e.PointerEventTypes.POINTERUP;if(this.onPointerObservable.hasObservers()){if(!r.ignore){if(!r.hasSwiped){if(r.singleClick&&this.onPointerObservable.hasSpecificMask(e.PointerEventTypes.POINTERTAP)){var a=e.PointerEventTypes.POINTERTAP;var o=new e.PointerInfo(a,i,t);this.onPointerObservable.notifyObservers(o,a)}if(r.doubleClick&&this.onPointerObservable.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP)){var u=e.PointerEventTypes.POINTERDOUBLETAP;var o=new e.PointerInfo(u,i,t);this.onPointerObservable.notifyObservers(o,u)}}}else{var o=new e.PointerInfo(s,i,t);this.onPointerObservable.notifyObservers(o,s)}}if(this.onPointerUp){this.onPointerUp(i,t,s)}return this};i.prototype.attachControl=function(r,n,o){var s=this;if(r===void 0){r=true}if(n===void 0){n=true}if(o===void 0){o=true}this._initActionManager=function(e,t){if(!s._meshPickProceed){var i=s.pick(s._unTranslatedPointerX,s._unTranslatedPointerY,s.pointerDownPredicate,false,s.cameraToUseForPointers);s._currentPickResult=i;if(i){e=i.hit&&i.pickedMesh?i.pickedMesh.actionManager:null}s._meshPickProceed=true}return e};this._delayedSimpleClick=function(e,t,r){if((new Date).getTime()-s._previousStartingPointerTime>i.DoubleClickDelay&&!s._doubleClickOccured||e!==s._previousButtonPressed){s._doubleClickOccured=false;t.singleClick=true;t.ignore=false;r(t,s._currentPickResult)}};this._initClickEvent=function(r,n,o,a){var u=new t;s._currentPickResult=null;var l=null;var c=r.hasSpecificMask(e.PointerEventTypes.POINTERPICK)||n.hasSpecificMask(e.PointerEventTypes.POINTERPICK)||r.hasSpecificMask(e.PointerEventTypes.POINTERTAP)||n.hasSpecificMask(e.PointerEventTypes.POINTERTAP)||r.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP)||n.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP);if(!c&&e.ActionManager&&e.ActionManager.HasPickTriggers){l=s._initActionManager(l,u);if(l)c=l.hasPickTriggers}if(c){var h=o.button;u.hasSwiped=Math.abs(s._startingPointerPosition.x-s._pointerX)>i.DragMovementThreshold||Math.abs(s._startingPointerPosition.y-s._pointerY)>i.DragMovementThreshold;if(!u.hasSwiped){var f=!i.ExclusiveDoubleClickMode;if(!f){f=!r.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP)&&!n.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP);if(f&&!e.ActionManager.HasSpecificTrigger(e.ActionManager.OnDoublePickTrigger)){l=s._initActionManager(l,u);if(l)f=!l.hasSpecificTrigger(e.ActionManager.OnDoublePickTrigger)}}if(f){if((new Date).getTime()-s._previousStartingPointerTime>i.DoubleClickDelay||h!==s._previousButtonPressed){u.singleClick=true;a(u,s._currentPickResult)}}else{s._previousDelayedSimpleClickTimeout=s._delayedSimpleClickTimeout;s._delayedSimpleClickTimeout=window.setTimeout(s._delayedSimpleClick.bind(s,h,u,a),i.DoubleClickDelay)}var d=r.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP)||n.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP);if(!d&&e.ActionManager.HasSpecificTrigger(e.ActionManager.OnDoublePickTrigger)){l=s._initActionManager(l,u);if(l)d=l.hasSpecificTrigger(e.ActionManager.OnDoublePickTrigger)}if(d){if(h===s._previousButtonPressed&&(new Date).getTime()-s._previousStartingPointerTime<i.DoubleClickDelay&&!s._doubleClickOccured){if(!u.hasSwiped&&Math.abs(s._previousStartingPointerPosition.x-s._startingPointerPosition.x)<i.DragMovementThreshold&&Math.abs(s._previousStartingPointerPosition.y-s._startingPointerPosition.y)<i.DragMovementThreshold){s._previousStartingPointerTime=0;s._doubleClickOccured=true;u.doubleClick=true;u.ignore=false;if(i.ExclusiveDoubleClickMode&&s._previousDelayedSimpleClickTimeout){clearTimeout(s._previousDelayedSimpleClickTimeout)}s._previousDelayedSimpleClickTimeout=s._delayedSimpleClickTimeout;a(u,s._currentPickResult)}else{s._doubleClickOccured=false;s._previousStartingPointerTime=s._startingPointerTime;s._previousStartingPointerPosition.x=s._startingPointerPosition.x;s._previousStartingPointerPosition.y=s._startingPointerPosition.y;s._previousButtonPressed=h;if(i.ExclusiveDoubleClickMode){if(s._previousDelayedSimpleClickTimeout){clearTimeout(s._previousDelayedSimpleClickTimeout)}s._previousDelayedSimpleClickTimeout=s._delayedSimpleClickTimeout;a(u,s._previousPickResult)}else{a(u,s._currentPickResult)}}}else{s._doubleClickOccured=false;s._previousStartingPointerTime=s._startingPointerTime;s._previousStartingPointerPosition.x=s._startingPointerPosition.x;s._previousStartingPointerPosition.y=s._startingPointerPosition.y;s._previousButtonPressed=h}}}}u.ignore=true;a(u,s._currentPickResult)};this._spritePredicate=function(e){return e.isPickable&&e.actionManager&&e.actionManager.hasPointerTriggers};this._onPointerMove=function(t){s._updatePointerPosition(t);if(s.onPrePointerObservable.hasObservers()){var i=t.type==="mousewheel"||t.type==="DOMMouseScroll"?e.PointerEventTypes.POINTERWHEEL:e.PointerEventTypes.POINTERMOVE;var r=new e.PointerInfoPre(i,t,s._unTranslatedPointerX,s._unTranslatedPointerY);s.onPrePointerObservable.notifyObservers(r,i);if(r.skipOnPointerObservable){return}}if(!s.cameraToUseForPointers&&!s.activeCamera){return}if(!s.pointerMovePredicate){s.pointerMovePredicate=function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(e.enablePointerMoveEvents||s.constantlyUpdateMeshUnderPointer||e.actionManager!==null&&e.actionManager!==undefined)}}var n=s.pick(s._unTranslatedPointerX,s._unTranslatedPointerY,s.pointerMovePredicate,false,s.cameraToUseForPointers);s._processPointerMove(n,t)};this._onPointerDown=function(t){s._totalPointersPressed++;s._pickedDownMesh=null;s._meshPickProceed=false;s._updatePointerPosition(t);if(s.preventDefaultOnPointerDown&&l){t.preventDefault();l.focus()}if(s.onPrePointerObservable.hasObservers()){var i=e.PointerEventTypes.POINTERDOWN;var r=new e.PointerInfoPre(i,t,s._unTranslatedPointerX,s._unTranslatedPointerY);s.onPrePointerObservable.notifyObservers(r,i);if(r.skipOnPointerObservable){return}}if(!s.cameraToUseForPointers&&!s.activeCamera){return}s._startingPointerPosition.x=s._pointerX;s._startingPointerPosition.y=s._pointerY;s._startingPointerTime=(new Date).getTime();if(!s.pointerDownPredicate){s.pointerDownPredicate=function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()}}s._pickedDownMesh=null;var n=s.pick(s._unTranslatedPointerX,s._unTranslatedPointerY,s.pointerDownPredicate,false,s.cameraToUseForPointers);s._processPointerDown(n,t);s._pickedDownSprite=null;if(s.spriteManagers.length>0){n=s.pickSprite(s._unTranslatedPointerX,s._unTranslatedPointerY,s._spritePredicate,false,s.cameraToUseForPointers||undefined);if(n&&n.hit&&n.pickedSprite){if(n.pickedSprite.actionManager){s._pickedDownSprite=n.pickedSprite;switch(t.button){case 0:n.pickedSprite.actionManager.processTrigger(e.ActionManager.OnLeftPickTrigger,e.ActionEvent.CreateNewFromSprite(n.pickedSprite,s,t));break;case 1:n.pickedSprite.actionManager.processTrigger(e.ActionManager.OnCenterPickTrigger,e.ActionEvent.CreateNewFromSprite(n.pickedSprite,s,t));break;case 2:n.pickedSprite.actionManager.processTrigger(e.ActionManager.OnRightPickTrigger,e.ActionEvent.CreateNewFromSprite(n.pickedSprite,s,t));break}if(n.pickedSprite.actionManager){n.pickedSprite.actionManager.processTrigger(e.ActionManager.OnPickDownTrigger,e.ActionEvent.CreateNewFromSprite(n.pickedSprite,s,t))}}}}};this._onPointerUp=function(t){if(s._totalPointersPressed===0){return}s._totalPointersPressed--;s._pickedUpMesh=null;s._meshPickProceed=false;s._updatePointerPosition(t);s._initClickEvent(s.onPrePointerObservable,s.onPointerObservable,t,function(r,n){if(s.onPrePointerObservable.hasObservers()){if(!r.ignore){if(!r.hasSwiped){if(r.singleClick&&s.onPrePointerObservable.hasSpecificMask(e.PointerEventTypes.POINTERTAP)){var o=e.PointerEventTypes.POINTERTAP;var a=new e.PointerInfoPre(o,t,s._unTranslatedPointerX,s._unTranslatedPointerY);s.onPrePointerObservable.notifyObservers(a,o);if(a.skipOnPointerObservable){return}}if(r.doubleClick&&s.onPrePointerObservable.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP)){var o=e.PointerEventTypes.POINTERDOUBLETAP;var a=new e.PointerInfoPre(o,t,s._unTranslatedPointerX,s._unTranslatedPointerY);s.onPrePointerObservable.notifyObservers(a,o);if(a.skipOnPointerObservable){return}}}}else{var o=e.PointerEventTypes.POINTERUP;var a=new e.PointerInfoPre(o,t,s._unTranslatedPointerX,s._unTranslatedPointerY);s.onPrePointerObservable.notifyObservers(a,o);if(a.skipOnPointerObservable){return}}}if(!s.cameraToUseForPointers&&!s.activeCamera){return}if(!s.pointerUpPredicate){s.pointerUpPredicate=function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()}}if(!s._meshPickProceed&&(e.ActionManager&&e.ActionManager.HasTriggers||s.onPointerObservable.hasObservers())){s._initActionManager(null,r)}if(!n){n=s._currentPickResult}s._processPointerUp(n,t,r);if(s.spriteManagers.length>0){var u=s.pickSprite(s._unTranslatedPointerX,s._unTranslatedPointerY,s._spritePredicate,false,s.cameraToUseForPointers||undefined);if(u){if(u.hit&&u.pickedSprite){if(u.pickedSprite.actionManager){u.pickedSprite.actionManager.processTrigger(e.ActionManager.OnPickUpTrigger,e.ActionEvent.CreateNewFromSprite(u.pickedSprite,s,t));if(u.pickedSprite.actionManager){if(Math.abs(s._startingPointerPosition.x-s._pointerX)<i.DragMovementThreshold&&Math.abs(s._startingPointerPosition.y-s._pointerY)<i.DragMovementThreshold){u.pickedSprite.actionManager.processTrigger(e.ActionManager.OnPickTrigger,e.ActionEvent.CreateNewFromSprite(u.pickedSprite,s,t))}}}}if(s._pickedDownSprite&&s._pickedDownSprite.actionManager&&s._pickedDownSprite!==u.pickedSprite){s._pickedDownSprite.actionManager.processTrigger(e.ActionManager.OnPickOutTrigger,e.ActionEvent.CreateNewFromSprite(s._pickedDownSprite,s,t))}}}s._previousPickResult=s._currentPickResult})};this._onKeyDown=function(t){var i=e.KeyboardEventTypes.KEYDOWN;if(s.onPreKeyboardObservable.hasObservers()){var r=new e.KeyboardInfoPre(i,t);s.onPreKeyboardObservable.notifyObservers(r,i);if(r.skipOnPointerObservable){return}}if(s.onKeyboardObservable.hasObservers()){var r=new e.KeyboardInfo(i,t);s.onKeyboardObservable.notifyObservers(r,i)}if(s.actionManager){s.actionManager.processTrigger(e.ActionManager.OnKeyDownTrigger,e.ActionEvent.CreateNewFromScene(s,t))}};this._onKeyUp=function(t){var i=e.KeyboardEventTypes.KEYUP;if(s.onPreKeyboardObservable.hasObservers()){var r=new e.KeyboardInfoPre(i,t);s.onPreKeyboardObservable.notifyObservers(r,i);if(r.skipOnPointerObservable){return}}if(s.onKeyboardObservable.hasObservers()){var r=new e.KeyboardInfo(i,t);s.onKeyboardObservable.notifyObservers(r,i)}if(s.actionManager){s.actionManager.processTrigger(e.ActionManager.OnKeyUpTrigger,e.ActionEvent.CreateNewFromScene(s,t))}};var a=this.getEngine();this._onCanvasFocusObserver=a.onCanvasFocusObservable.add(function(){if(!l){return}l.addEventListener("keydown",s._onKeyDown,false);l.addEventListener("keyup",s._onKeyUp,false)});this._onCanvasBlurObserver=a.onCanvasBlurObservable.add(function(){if(!l){return}l.removeEventListener("keydown",s._onKeyDown);l.removeEventListener("keyup",s._onKeyUp)});var u=e.Tools.GetPointerPrefix();var l=this._engine.getRenderingCanvas();if(!l){return}if(o){l.addEventListener(u+"move",this._onPointerMove,false);l.addEventListener("mousewheel",this._onPointerMove,false);l.addEventListener("DOMMouseScroll",this._onPointerMove,false)}if(n){l.addEventListener(u+"down",this._onPointerDown,false)}if(r){window.addEventListener(u+"up",this._onPointerUp,false)}l.tabIndex=1};i.prototype.detachControl=function(){var t=this.getEngine();var i=e.Tools.GetPointerPrefix();var r=t.getRenderingCanvas();if(!r){return}r.removeEventListener(i+"move",this._onPointerMove);r.removeEventListener(i+"down",this._onPointerDown);window.removeEventListener(i+"up",this._onPointerUp);if(this._onCanvasBlurObserver){t.onCanvasBlurObservable.remove(this._onCanvasBlurObserver)}if(this._onCanvasFocusObserver){t.onCanvasFocusObservable.remove(this._onCanvasFocusObserver)}r.removeEventListener("mousewheel",this._onPointerMove);r.removeEventListener("DOMMouseScroll",this._onPointerMove);r.removeEventListener("keydown",this._onKeyDown);r.removeEventListener("keyup",this._onKeyUp);this.onKeyboardObservable.clear();this.onPreKeyboardObservable.clear();this.onPointerObservable.clear();this.onPrePointerObservable.clear()};i.prototype.isReady=function(){if(this._isDisposed){return false}if(this._pendingData.length>0){return false}var t;var i=this.getEngine();for(t=0;t<this._geometries.length;t++){var r=this._geometries[t];if(r.delayLoadState===e.Engine.DELAYLOADSTATE_LOADING){return false}}for(t=0;t<this.meshes.length;t++){var n=this.meshes[t];if(!n.isEnabled()){continue}if(!n.subMeshes||n.subMeshes.length===0){continue}if(!n.isReady(true)){return false}var o=n.getClassName()==="InstancedMesh"||i.getCaps().instancedArrays&&n.instances.length>0;for(var s=0,a=this.effectLayers;s<a.length;s++){var u=a[s];if(!u.hasMesh(n)){continue}for(var l=0,c=n.subMeshes;l<c.length;l++){var h=c[l];if(!u.isReady(h,o)){return false}}}}if(this.activeCameras&&this.activeCameras.length>0){for(var f=0,d=this.activeCameras;f<d.length;f++){var p=d[f];if(!p.isReady(true)){return false}}}else if(this.activeCamera){if(!this.activeCamera.isReady(true)){return false}}for(var _=0,m=this.particleSystems;_<m.length;_++){var g=m[_];if(!g.isReady()){return false}}return true};i.prototype.resetCachedMaterial=function(){this._cachedMaterial=null;this._cachedEffect=null;this._cachedVisibility=null};i.prototype.registerBeforeRender=function(e){this.onBeforeRenderObservable.add(e)};i.prototype.unregisterBeforeRender=function(e){this.onBeforeRenderObservable.removeCallback(e)};i.prototype.registerAfterRender=function(e){this.onAfterRenderObservable.add(e)};i.prototype.unregisterAfterRender=function(e){this.onAfterRenderObservable.removeCallback(e)};i.prototype._executeOnceBeforeRender=function(e){var t=this;var i=function(){e();setTimeout(function(){t.unregisterBeforeRender(i)})};this.registerBeforeRender(i)};i.prototype.executeOnceBeforeRender=function(e,t){var i=this;if(t!==undefined){setTimeout(function(){i._executeOnceBeforeRender(e)},t)}else{this._executeOnceBeforeRender(e)}};i.prototype._addPendingData=function(e){this._pendingData.push(e)};i.prototype._removePendingData=function(e){var t=this.isLoading;var i=this._pendingData.indexOf(e);if(i!==-1){this._pendingData.splice(i,1)}if(t&&!this.isLoading){this.onDataLoadedObservable.notifyObservers(this)}};i.prototype.getWaitingItemsCount=function(){return this._pendingData.length};Object.defineProperty(i.prototype,"isLoading",{get:function(){return this._pendingData.length>0},enumerable:true,configurable:true});i.prototype.executeWhenReady=function(e){var t=this;this.onReadyObservable.add(e);if(this._executeWhenReadyTimeoutId!==-1){return}this._executeWhenReadyTimeoutId=setTimeout(function(){t._checkIsReady()},150)};i.prototype.whenReadyAsync=function(){var e=this;return new Promise(function(t){e.executeWhenReady(function(){t()})})};i.prototype._checkIsReady=function(){var e=this;if(this.isReady()){this.onReadyObservable.notifyObservers(this);this.onReadyObservable.clear();this._executeWhenReadyTimeoutId=-1;return}this._executeWhenReadyTimeoutId=setTimeout(function(){e._checkIsReady()},150)};i.prototype.beginWeightedAnimation=function(e,t,i,r,n,o,s,a){if(r===void 0){r=1}if(o===void 0){o=1}var u=this.beginAnimation(e,t,i,n,o,s,a,false);u.weight=r;return u};i.prototype.beginAnimation=function(t,i,r,n,o,s,a,u){if(o===void 0){o=1}if(u===void 0){u=true}if(i>r&&o>0){o*=-1}if(u){this.stopAnimation(t)}if(!a){a=new e.Animatable(this,t,i,r,n,o,s)}if(t.animations){a.appendAnimations(t,t.animations)}if(t.getAnimatables){var l=t.getAnimatables();for(var c=0;c<l.length;c++){this.beginAnimation(l[c],i,r,n,o,s,a,u)}}a.reset();return a};i.prototype.beginDirectAnimation=function(t,i,r,n,o,s,a){if(s===undefined){s=1}var u=new e.Animatable(this,t,r,n,o,s,a,i);return u};i.prototype.beginDirectHierarchyAnimation=function(e,t,i,r,n,o,s,a){var u=e.getDescendants(t);var l=[];for(var c=0,h=u;c<h.length;c++){var f=h[c];l.push(this.beginDirectAnimation(f,i,r,n,o,s,a))}return l};i.prototype.getAnimatableByTarget=function(e){for(var t=0;t<this._activeAnimatables.length;t++){if(this._activeAnimatables[t].target===e){return this._activeAnimatables[t]}}return null};i.prototype.getAllAnimatablesByTarget=function(e){var t=[];for(var i=0;i<this._activeAnimatables.length;i++){if(this._activeAnimatables[i].target===e){t.push(this._activeAnimatables[i])}}return t};Object.defineProperty(i.prototype,"animatables",{get:function(){return this._activeAnimatables},enumerable:true,configurable:true});i.prototype.stopAnimation=function(e,t){var i=this.getAllAnimatablesByTarget(e);for(var r=0,n=i;r<n.length;r++){var o=n[r];o.stop(t)}};i.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(var e=0;e<this._activeAnimatables.length;e++){this._activeAnimatables[e].stop()}this._activeAnimatables=[]}for(var t=0,i=this.animationGroups;t<i.length;t++){var r=i[t];r.stop()}};i.prototype._animate=function(){if(!this.animationsEnabled||this._activeAnimatables.length===0){return}var t=e.Tools.Now;if(!this._animationTimeLast){if(this._pendingData.length>0){return}this._animationTimeLast=t}var i=this.useConstantAnimationDeltaTime?16:(t-this._animationTimeLast)*this.animationTimeScale;this._animationTime+=i;this._animationTimeLast=t;for(var r=0;r<this._activeAnimatables.length;r++){this._activeAnimatables[r]._animate(this._animationTime)}this._processLateAnimationBindings()};i.prototype._registerTargetForLateAnimationBinding=function(e){var t=e.target;this._registeredForLateAnimationBindings.pushNoDuplicate(t);if(!t._lateAnimationHolders){t._lateAnimationHolders={}}if(!t._lateAnimationHolders[e.targetPath]){t._lateAnimationHolders[e.targetPath]={totalWeight:0,animations:[]}}t._lateAnimationHolders[e.targetPath].animations.push(e);t._lateAnimationHolders[e.targetPath].totalWeight+=e.weight};i.prototype._processLateAnimationBindings=function(){if(!this._registeredForLateAnimationBindings.length){return}for(var e=0;e<this._registeredForLateAnimationBindings.length;e++){var t=this._registeredForLateAnimationBindings.data[e];for(var i in t._lateAnimationHolders){var r=t._lateAnimationHolders[i];if(!r.animations[0].originalValue.scaleAndAddToRef){continue}var n=1;var o=void 0;if(r.totalWeight<1){var s=r.animations[0].originalValue;o=s.scale(1-r.totalWeight)}else{n=r.totalWeight}for(var a=0;a<r.animations.length;a++){var u=r.animations[a];if(o){u.currentValue.scaleAndAddToRef(u.weight/n,o)}else{o=u.currentValue.scale(u.weight/n)}}u.target[i]=o}t._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()};i.prototype._switchToAlternateCameraConfiguration=function(e){this._useAlternateCameraConfiguration=e};i.prototype.getViewMatrix=function(){return this._useAlternateCameraConfiguration?this._alternateViewMatrix:this._viewMatrix};i.prototype.getProjectionMatrix=function(){return this._useAlternateCameraConfiguration?this._alternateProjectionMatrix:this._projectionMatrix};i.prototype.getTransformMatrix=function(){return this._useAlternateCameraConfiguration?this._alternateTransformMatrix:this._transformMatrix};i.prototype.setTransformMatrix=function(t,i){if(this._viewUpdateFlag===t.updateFlag&&this._projectionUpdateFlag===i.updateFlag){return}this._viewUpdateFlag=t.updateFlag;this._projectionUpdateFlag=i.updateFlag;this._viewMatrix=t;this._projectionMatrix=i;this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix);if(!this._frustumPlanes){this._frustumPlanes=e.Frustum.GetPlanes(this._transformMatrix)}else{e.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes)}if(this.activeCamera&&this.activeCamera._alternateCamera){var r=this.activeCamera._alternateCamera;r.getViewMatrix().multiplyToRef(r.getProjectionMatrix(),e.Tmp.Matrix[0]);e.Frustum.GetRightPlaneToRef(e.Tmp.Matrix[0],this._frustumPlanes[3])}if(this._sceneUbo.useUbo){this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix);this._sceneUbo.updateMatrix("view",this._viewMatrix);this._sceneUbo.update()}};i.prototype._setAlternateTransformMatrix=function(t,i){if(this._alternateViewUpdateFlag===t.updateFlag&&this._alternateProjectionUpdateFlag===i.updateFlag){return}this._alternateViewUpdateFlag=t.updateFlag;this._alternateProjectionUpdateFlag=i.updateFlag;this._alternateViewMatrix=t;this._alternateProjectionMatrix=i;if(!this._alternateTransformMatrix){this._alternateTransformMatrix=e.Matrix.Zero()}this._alternateViewMatrix.multiplyToRef(this._alternateProjectionMatrix,this._alternateTransformMatrix);if(!this._alternateSceneUbo){this._createAlternateUbo()}if(this._alternateSceneUbo.useUbo){this._alternateSceneUbo.updateMatrix("viewProjection",this._alternateTransformMatrix);this._alternateSceneUbo.updateMatrix("view",this._alternateViewMatrix);this._alternateSceneUbo.update()}};i.prototype.getSceneUniformBuffer=function(){return this._useAlternateCameraConfiguration?this._alternateSceneUbo:this._sceneUbo};i.prototype.getUniqueId=function(){var e=i._uniqueIdCounter;i._uniqueIdCounter++;return e};i.prototype.addMesh=function(e){this.meshes.push(e);if(this.collisionCoordinator){this.collisionCoordinator.onMeshAdded(e)}e._resyncLightSources();this.onNewMeshAddedObservable.notifyObservers(e)};i.prototype.removeMesh=function(e){var t=this.meshes.indexOf(e);if(t!==-1){this.meshes.splice(t,1)}this.onMeshRemovedObservable.notifyObservers(e);return t};i.prototype.addTransformNode=function(e){this.transformNodes.push(e);this.onNewTransformNodeAddedObservable.notifyObservers(e)};i.prototype.removeTransformNode=function(e){var t=this.transformNodes.indexOf(e);if(t!==-1){this.transformNodes.splice(t,1)}this.onTransformNodeRemovedObservable.notifyObservers(e);return t};i.prototype.removeSkeleton=function(e){var t=this.skeletons.indexOf(e);if(t!==-1){this.skeletons.splice(t,1)}return t};i.prototype.removeMorphTargetManager=function(e){var t=this.morphTargetManagers.indexOf(e);if(t!==-1){this.morphTargetManagers.splice(t,1)}return t};i.prototype.removeLight=function(e){var t=this.lights.indexOf(e);if(t!==-1){for(var i=0,r=this.meshes;i<r.length;i++){var n=r[i];n._removeLightSource(e)}this.lights.splice(t,1);this.sortLightsByPriority()}this.onLightRemovedObservable.notifyObservers(e);return t};i.prototype.removeCamera=function(e){var t=this.cameras.indexOf(e);if(t!==-1){this.cameras.splice(t,1)}var i=this.activeCameras.indexOf(e);if(i!==-1){this.activeCameras.splice(i,1)}if(this.activeCamera===e){if(this.cameras.length>0){this.activeCamera=this.cameras[0]}else{this.activeCamera=null}}this.onCameraRemovedObservable.notifyObservers(e);return t};i.prototype.removeParticleSystem=function(e){var t=this.particleSystems.indexOf(e);if(t!==-1){this.particleSystems.splice(t,1)}return t};i.prototype.removeAnimation=function(e){var t=this.animations.indexOf(e);if(t!==-1){this.animations.splice(t,1)}return t};i.prototype.removeAnimationGroup=function(e){var t=this.animationGroups.indexOf(e);if(t!==-1){this.animationGroups.splice(t,1)}return t};i.prototype.removeMultiMaterial=function(e){var t=this.multiMaterials.indexOf(e);if(t!==-1){this.multiMaterials.splice(t,1)}return t};i.prototype.removeMaterial=function(e){var t=this.materials.indexOf(e);if(t!==-1){this.materials.splice(t,1)}return t};i.prototype.removeLensFlareSystem=function(e){var t=this.lensFlareSystems.indexOf(e);if(t!==-1){this.lensFlareSystems.splice(t,1)}return t};i.prototype.removeActionManager=function(e){var t=this._actionManagers.indexOf(e);if(t!==-1){this._actionManagers.splice(t,1)}return t};i.prototype.removeTexture=function(e){var t=this.textures.indexOf(e);if(t!==-1){this.textures.splice(t,1)}return t};i.prototype.addLight=function(e){this.lights.push(e);this.sortLightsByPriority();for(var t=0,i=this.meshes;t<i.length;t++){var r=i[t];if(r._lightSources.indexOf(e)===-1){r._lightSources.push(e);r._resyncLightSources()}}this.onNewLightAddedObservable.notifyObservers(e)};i.prototype.sortLightsByPriority=function(){if(this.requireLightSorting){this.lights.sort(e.Light.CompareLightsPriority)}};i.prototype.addCamera=function(e){this.cameras.push(e);this.onNewCameraAddedObservable.notifyObservers(e)};i.prototype.addSkeleton=function(e){this.skeletons.push(e)};i.prototype.addParticleSystem=function(e){this.particleSystems.push(e)};i.prototype.addAnimation=function(e){this.animations.push(e)};i.prototype.addAnimationGroup=function(e){this.animationGroups.push(e)};i.prototype.addMultiMaterial=function(e){this.multiMaterials.push(e)};i.prototype.addMaterial=function(e){this.materials.push(e)};i.prototype.addMorphTargetManager=function(e){this.morphTargetManagers.push(e)};i.prototype.addGeometry=function(e){this._geometries.push(e)};i.prototype.addLensFlareSystem=function(e){this.lensFlareSystems.push(e)};i.prototype.addActionManager=function(e){this._actionManagers.push(e)};i.prototype.addTexture=function(e){this.textures.push(e)};i.prototype.switchActiveCamera=function(e,t){if(t===void 0){t=true}var i=this._engine.getRenderingCanvas();if(!i){return}if(this.activeCamera){this.activeCamera.detachControl(i)}this.activeCamera=e;if(t){e.attachControl(i)}};i.prototype.setActiveCameraByID=function(e){var t=this.getCameraByID(e);if(t){this.activeCamera=t;return t}return null};i.prototype.setActiveCameraByName=function(e){var t=this.getCameraByName(e);if(t){this.activeCamera=t;return t}return null};i.prototype.getAnimationGroupByName=function(e){for(var t=0;t<this.animationGroups.length;t++){if(this.animationGroups[t].name===e){return this.animationGroups[t]}}return null};i.prototype.getMaterialByID=function(e){for(var t=0;t<this.materials.length;t++){if(this.materials[t].id===e){return this.materials[t]}}return null};i.prototype.getMaterialByName=function(e){for(var t=0;t<this.materials.length;t++){if(this.materials[t].name===e){return this.materials[t]}}return null};i.prototype.getLensFlareSystemByName=function(e){for(var t=0;t<this.lensFlareSystems.length;t++){if(this.lensFlareSystems[t].name===e){return this.lensFlareSystems[t]}}return null};i.prototype.getLensFlareSystemByID=function(e){for(var t=0;t<this.lensFlareSystems.length;t++){if(this.lensFlareSystems[t].id===e){return this.lensFlareSystems[t]}}return null};i.prototype.getCameraByID=function(e){for(var t=0;t<this.cameras.length;t++){if(this.cameras[t].id===e){return this.cameras[t]}}return null};i.prototype.getCameraByUniqueID=function(e){for(var t=0;t<this.cameras.length;t++){if(this.cameras[t].uniqueId===e){return this.cameras[t]}}return null};i.prototype.getCameraByName=function(e){for(var t=0;t<this.cameras.length;t++){if(this.cameras[t].name===e){return this.cameras[t]}}return null};i.prototype.getBoneByID=function(e){for(var t=0;t<this.skeletons.length;t++){var i=this.skeletons[t];for(var r=0;r<i.bones.length;r++){if(i.bones[r].id===e){return i.bones[r]}}}return null};i.prototype.getBoneByName=function(e){for(var t=0;t<this.skeletons.length;t++){var i=this.skeletons[t];for(var r=0;r<i.bones.length;r++){if(i.bones[r].name===e){return i.bones[r]}}}return null};i.prototype.getLightByName=function(e){for(var t=0;t<this.lights.length;t++){
if(this.lights[t].name===e){return this.lights[t]}}return null};i.prototype.getLightByID=function(e){for(var t=0;t<this.lights.length;t++){if(this.lights[t].id===e){return this.lights[t]}}return null};i.prototype.getLightByUniqueID=function(e){for(var t=0;t<this.lights.length;t++){if(this.lights[t].uniqueId===e){return this.lights[t]}}return null};i.prototype.getParticleSystemByID=function(e){for(var t=0;t<this.particleSystems.length;t++){if(this.particleSystems[t].id===e){return this.particleSystems[t]}}return null};i.prototype.getGeometryByID=function(e){for(var t=0;t<this._geometries.length;t++){if(this._geometries[t].id===e){return this._geometries[t]}}return null};i.prototype.pushGeometry=function(e,t){if(!t&&this.getGeometryByID(e.id)){return false}this._geometries.push(e);if(this.collisionCoordinator){this.collisionCoordinator.onGeometryAdded(e)}this.onNewGeometryAddedObservable.notifyObservers(e);return true};i.prototype.removeGeometry=function(e){var t=this._geometries.indexOf(e);if(t>-1){this._geometries.splice(t,1);if(this.collisionCoordinator){this.collisionCoordinator.onGeometryDeleted(e)}this.onGeometryRemovedObservable.notifyObservers(e);return true}return false};i.prototype.getGeometries=function(){return this._geometries};i.prototype.getMeshByID=function(e){for(var t=0;t<this.meshes.length;t++){if(this.meshes[t].id===e){return this.meshes[t]}}return null};i.prototype.getMeshesByID=function(e){return this.meshes.filter(function(t){return t.id===e})};i.prototype.getTransformNodeByID=function(e){for(var t=0;t<this.transformNodes.length;t++){if(this.transformNodes[t].id===e){return this.transformNodes[t]}}return null};i.prototype.getTransformNodesByID=function(e){return this.transformNodes.filter(function(t){return t.id===e})};i.prototype.getMeshByUniqueID=function(e){for(var t=0;t<this.meshes.length;t++){if(this.meshes[t].uniqueId===e){return this.meshes[t]}}return null};i.prototype.getLastMeshByID=function(e){for(var t=this.meshes.length-1;t>=0;t--){if(this.meshes[t].id===e){return this.meshes[t]}}return null};i.prototype.getLastEntryByID=function(e){var t;for(t=this.meshes.length-1;t>=0;t--){if(this.meshes[t].id===e){return this.meshes[t]}}for(t=this.transformNodes.length-1;t>=0;t--){if(this.transformNodes[t].id===e){return this.transformNodes[t]}}for(t=this.cameras.length-1;t>=0;t--){if(this.cameras[t].id===e){return this.cameras[t]}}for(t=this.lights.length-1;t>=0;t--){if(this.lights[t].id===e){return this.lights[t]}}return null};i.prototype.getNodeByID=function(e){var t=this.getMeshByID(e);if(t){return t}var i=this.getLightByID(e);if(i){return i}var r=this.getCameraByID(e);if(r){return r}var n=this.getBoneByID(e);return n};i.prototype.getNodeByName=function(e){var t=this.getMeshByName(e);if(t){return t}var i=this.getLightByName(e);if(i){return i}var r=this.getCameraByName(e);if(r){return r}var n=this.getBoneByName(e);return n};i.prototype.getMeshByName=function(e){for(var t=0;t<this.meshes.length;t++){if(this.meshes[t].name===e){return this.meshes[t]}}return null};i.prototype.getTransformNodeByName=function(e){for(var t=0;t<this.transformNodes.length;t++){if(this.transformNodes[t].name===e){return this.transformNodes[t]}}return null};i.prototype.getSoundByName=function(t){var i;if(e.AudioEngine){for(i=0;i<this.mainSoundTrack.soundCollection.length;i++){if(this.mainSoundTrack.soundCollection[i].name===t){return this.mainSoundTrack.soundCollection[i]}}for(var r=0;r<this.soundTracks.length;r++){for(i=0;i<this.soundTracks[r].soundCollection.length;i++){if(this.soundTracks[r].soundCollection[i].name===t){return this.soundTracks[r].soundCollection[i]}}}}return null};i.prototype.getLastSkeletonByID=function(e){for(var t=this.skeletons.length-1;t>=0;t--){if(this.skeletons[t].id===e){return this.skeletons[t]}}return null};i.prototype.getSkeletonById=function(e){for(var t=0;t<this.skeletons.length;t++){if(this.skeletons[t].id===e){return this.skeletons[t]}}return null};i.prototype.getSkeletonByName=function(e){for(var t=0;t<this.skeletons.length;t++){if(this.skeletons[t].name===e){return this.skeletons[t]}}return null};i.prototype.getMorphTargetManagerById=function(e){for(var t=0;t<this.morphTargetManagers.length;t++){if(this.morphTargetManagers[t].uniqueId===e){return this.morphTargetManagers[t]}}return null};i.prototype.isActiveMesh=function(e){return this._activeMeshes.indexOf(e)!==-1};i.prototype.getHighlightLayerByName=function(t){for(var i=0;i<this.effectLayers.length;i++){if(this.effectLayers[i].name===t&&this.effectLayers[i].getEffectName()===e.HighlightLayer.EffectName){return this.effectLayers[i]}}return null};i.prototype.getGlowLayerByName=function(t){for(var i=0;i<this.effectLayers.length;i++){if(this.effectLayers[i].name===t&&this.effectLayers[i].getEffectName()===e.GlowLayer.EffectName){return this.effectLayers[i]}}return null};Object.defineProperty(i.prototype,"uid",{get:function(){if(!this._uid){this._uid=e.Tools.RandomId()}return this._uid},enumerable:true,configurable:true});i.prototype.addExternalData=function(t,i){if(!this._externalData){this._externalData=new e.StringDictionary}return this._externalData.add(t,i)};i.prototype.getExternalData=function(e){if(!this._externalData){return null}return this._externalData.get(e)};i.prototype.getOrAddExternalDataWithFactory=function(t,i){if(!this._externalData){this._externalData=new e.StringDictionary}return this._externalData.getOrAddWithFactory(t,i)};i.prototype.removeExternalData=function(e){return this._externalData.remove(e)};i.prototype._evaluateSubMesh=function(e,t){if(this.dispatchAllSubMeshesOfActiveMeshes||t.alwaysSelectAsActiveMesh||t.subMeshes.length===1||e.isInFrustum(this._frustumPlanes)){if(t.showSubMeshesBoundingBox){var i=e.getBoundingInfo();if(i!==null&&i!==undefined){this.getBoundingBoxRenderer().renderList.push(i.boundingBox)}}var r=e.getMaterial();if(r!==null&&r!==undefined){if(r.getRenderTargetTextures!==undefined){if(this._processedMaterials.indexOf(r)===-1){this._processedMaterials.push(r);this._renderTargets.concatWithNoDuplicate(r.getRenderTargetTextures())}}this._activeIndices.addCount(e.indexCount,false);this._renderingManager.dispatch(e,t,r)}}};i.prototype.freeProcessedMaterials=function(){this._processedMaterials.dispose()};i.prototype.freeActiveMeshes=function(){this._activeMeshes.dispose();if(this.activeCamera&&this.activeCamera._activeMeshes){this.activeCamera._activeMeshes.dispose()}if(this.activeCameras){for(var e=0;e<this.activeCameras.length;e++){var t=this.activeCameras[e];if(t&&t._activeMeshes){t._activeMeshes.dispose()}}}};i.prototype.freeRenderingGroups=function(){if(this._renderingManager){this._renderingManager.freeRenderingGroups()}if(this.textures){for(var e=0;e<this.textures.length;e++){var t=this.textures[e];if(t&&t.renderList){t.freeRenderingGroups()}}}};i.prototype._isInIntermediateRendering=function(){return this._intermediateRendering};i.prototype.setActiveMeshCandidateProvider=function(e){this._activeMeshCandidateProvider=e};i.prototype.getActiveMeshCandidateProvider=function(){return this._activeMeshCandidateProvider};i.prototype.freezeActiveMeshes=function(){if(!this.activeCamera){return this}if(!this._frustumPlanes){this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix())}this._evaluateActiveMeshes();this._activeMeshesFrozen=true;return this};i.prototype.unfreezeActiveMeshes=function(){this._activeMeshesFrozen=false;return this};i.prototype._evaluateActiveMeshes=function(){if(this._activeMeshesFrozen&&this._activeMeshes.length){return}if(!this.activeCamera){return}this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this);this.activeCamera._activeMeshes.reset();this._activeMeshes.reset();this._renderingManager.reset();this._processedMaterials.reset();this._activeParticleSystems.reset();this._activeSkeletons.reset();this._softwareSkinnedMeshes.reset();if(this._boundingBoxRenderer){this._boundingBoxRenderer.reset()}var t;var i;var r=true;if(this._activeMeshCandidateProvider!==undefined){t=this._activeMeshCandidateProvider.getMeshes(this);r=this._activeMeshCandidateProvider.checksIsEnabled===false;if(t!==undefined){i=t.length}else{i=0}}else if(this._selectionOctree!==undefined){var n=this._selectionOctree.select(this._frustumPlanes);t=n.data;i=n.length}else{i=this.meshes.length;t=this.meshes}for(var o=0,s,a;o<i;o++){s=t[o];if(s.isBlocked){continue}this._totalVertices.addCount(s.getTotalVertices(),false);if(!s.isReady()||r&&!s.isEnabled()){continue}s.computeWorldMatrix();if(s.actionManager&&s.actionManager.hasSpecificTriggers([e.ActionManager.OnIntersectionEnterTrigger,e.ActionManager.OnIntersectionExitTrigger])){this._meshesForIntersections.pushNoDuplicate(s)}a=s.getLOD(this.activeCamera);if(a===undefined||a===null){continue}s._preActivate();if(s.alwaysSelectAsActiveMesh||s.isVisible&&s.visibility>0&&(s.layerMask&this.activeCamera.layerMask)!==0&&s.isInFrustum(this._frustumPlanes)){this._activeMeshes.push(s);this.activeCamera._activeMeshes.push(s);s._activate(this._renderId);if(a!==s){a._activate(this._renderId)}this._activeMesh(s,a)}}this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this);if(this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(var u=0;u<this.particleSystems.length;u++){var l=this.particleSystems[u];if(!l.isStarted()||!l.emitter){continue}var c=l.emitter;if(!c.position||c.isEnabled()){this._activeParticleSystems.push(l);l.animate();this._renderingManager.dispatchParticles(l)}}this.onAfterParticlesRenderingObservable.notifyObservers(this)}};i.prototype._activeMesh=function(e,t){if(this.skeletonsEnabled&&t.skeleton!==null&&t.skeleton!==undefined){if(this._activeSkeletons.pushNoDuplicate(t.skeleton)){t.skeleton.prepare()}if(!t.computeBonesUsingShaders){this._softwareSkinnedMeshes.pushNoDuplicate(t)}}if(e.showBoundingBox||this.forceShowBoundingBoxes){var i=e.getBoundingInfo();this.getBoundingBoxRenderer().renderList.push(i.boundingBox)}if(t!==undefined&&t!==null&&t.subMeshes!==undefined&&t.subMeshes!==null&&t.subMeshes.length>0){var r;var n;if(t.useOctreeForRenderingSelection&&t._submeshesOctree!==undefined&&t._submeshesOctree!==null){var o=t._submeshesOctree.select(this._frustumPlanes);r=o.length;n=o.data}else{n=t.subMeshes;r=n.length}for(var s=0,a;s<r;s++){a=n[s];this._evaluateSubMesh(a,t)}}};i.prototype.updateTransformMatrix=function(e){if(!this.activeCamera){return}this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(e))};i.prototype.updateAlternateTransformMatrix=function(e){this._setAlternateTransformMatrix(e.getViewMatrix(),e.getProjectionMatrix())};i.prototype._renderForCamera=function(t,i){if(t&&t._skipRendering){return}var r=this._engine;this.activeCamera=t;if(!this.activeCamera)throw new Error("Active camera not set");e.Tools.StartPerformanceCounter("Rendering camera "+this.activeCamera.name);r.setViewport(this.activeCamera.viewport);this.resetCachedMaterial();this._renderId++;this.updateTransformMatrix();if(t._alternateCamera){this.updateAlternateTransformMatrix(t._alternateCamera);this._alternateRendering=true}this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera);this._evaluateActiveMeshes();for(var n=0;n<this._softwareSkinnedMeshes.length;n++){var o=this._softwareSkinnedMeshes.data[n];o.applySkeleton(o.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);var s=false;if(t.customRenderTargets&&t.customRenderTargets.length>0){this._renderTargets.concatWithNoDuplicate(t.customRenderTargets)}if(i&&i.customRenderTargets&&i.customRenderTargets.length>0){this._renderTargets.concatWithNoDuplicate(i.customRenderTargets)}if(this.renderTargetsEnabled&&this._renderTargets.length>0){this._intermediateRendering=true;e.Tools.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(var a=0;a<this._renderTargets.length;a++){var u=this._renderTargets.data[a];if(u._shouldRender()){this._renderId++;var l=u.activeCamera&&u.activeCamera!==this.activeCamera;u.render(l,this.dumpNextRenderTargets)}}e.Tools.EndPerformanceCounter("Render targets",this._renderTargets.length>0);this._intermediateRendering=false;this._renderId++;s=true}var c=this._engine.getStencilBuffer();var h=false;var f=false;if(this.renderTargetsEnabled&&this.effectLayers&&this.effectLayers.length>0){this._intermediateRendering=true;for(var d=0;d<this.effectLayers.length;d++){var p=this.effectLayers[d];if(p.shouldRender()&&(!p.camera||p.camera.cameraRigMode===e.Camera.RIG_MODE_NONE&&t===p.camera||p.camera.cameraRigMode!==e.Camera.RIG_MODE_NONE&&p.camera._rigCameras.indexOf(t)>-1)){h=true;f=f||p.needStencil();var u=p._mainTexture;if(u._shouldRender()){this._renderId++;u.render(false,false);s=true}}}this._intermediateRendering=false;this._renderId++}if(s){r.restoreDefaultFramebuffer()}this.onAfterRenderTargetsRenderObservable.notifyObservers(this);this.postProcessManager._prepareFrame();var _;var m;if(this.layers.length){r.setDepthBuffer(false);for(_=0;_<this.layers.length;_++){m=this.layers[_];if(m.isBackground&&(m.layerMask&this.activeCamera.layerMask)!==0){m.render()}}r.setDepthBuffer(true)}if(f){this._engine.setStencilBuffer(true)}this.onBeforeDrawPhaseObservable.notifyObservers(this);this._renderingManager.render(null,null,true,true);this.onAfterDrawPhaseObservable.notifyObservers(this);if(f){this._engine.setStencilBuffer(c)}if(this._boundingBoxRenderer){this._boundingBoxRenderer.render()}if(this.lensFlaresEnabled){e.Tools.StartPerformanceCounter("Lens flares",this.lensFlareSystems.length>0);for(var g=0;g<this.lensFlareSystems.length;g++){var v=this.lensFlareSystems[g];if((t.layerMask&v.layerMask)!==0){v.render()}}e.Tools.EndPerformanceCounter("Lens flares",this.lensFlareSystems.length>0)}if(h){r.setDepthBuffer(false);for(var d=0;d<this.effectLayers.length;d++){if(this.effectLayers[d].shouldRender()){this.effectLayers[d].render()}}r.setDepthBuffer(true)}if(this.layers.length){r.setDepthBuffer(false);for(_=0;_<this.layers.length;_++){m=this.layers[_];if(!m.isBackground&&(m.layerMask&this.activeCamera.layerMask)!==0){m.render()}}r.setDepthBuffer(true)}this.postProcessManager._finalizeFrame(t.isIntermediate);this._renderTargets.reset();this._alternateRendering=false;this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera);e.Tools.EndPerformanceCounter("Rendering camera "+this.activeCamera.name)};i.prototype._processSubCameras=function(t){if(t.cameraRigMode===e.Camera.RIG_MODE_NONE){this._renderForCamera(t);return}for(var i=0;i<t._rigCameras.length;i++){this._renderForCamera(t._rigCameras[i],t)}this.activeCamera=t;this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix())};i.prototype._checkIntersections=function(){for(var t=0;t<this._meshesForIntersections.length;t++){var i=this._meshesForIntersections.data[t];if(!i.actionManager){continue}for(var r=0;r<i.actionManager.actions.length;r++){var n=i.actionManager.actions[r];if(n.trigger===e.ActionManager.OnIntersectionEnterTrigger||n.trigger===e.ActionManager.OnIntersectionExitTrigger){var o=n.getTriggerParameter();var s=o instanceof e.AbstractMesh?o:o.mesh;var a=s.intersectsMesh(i,o.usePreciseIntersection);var u=i._intersectionsInProgress.indexOf(s);if(a&&u===-1){if(n.trigger===e.ActionManager.OnIntersectionEnterTrigger){n._executeCurrent(e.ActionEvent.CreateNew(i,undefined,s));i._intersectionsInProgress.push(s)}else if(n.trigger===e.ActionManager.OnIntersectionExitTrigger){i._intersectionsInProgress.push(s)}}else if(!a&&u>-1){if(n.trigger===e.ActionManager.OnIntersectionExitTrigger){n._executeCurrent(e.ActionEvent.CreateNew(i,undefined,s))}if(!i.actionManager.hasSpecificTrigger(e.ActionManager.OnIntersectionExitTrigger)||n.trigger===e.ActionManager.OnIntersectionExitTrigger){i._intersectionsInProgress.splice(u,1)}}}}}};i.prototype.render=function(){if(this.isDisposed){return}this._activeParticles.fetchNewFrame();this._totalVertices.fetchNewFrame();this._activeIndices.fetchNewFrame();this._activeBones.fetchNewFrame();this._meshesForIntersections.reset();this.resetCachedMaterial();this.onBeforeAnimationsObservable.notifyObservers(this);if(this.actionManager){this.actionManager.processTrigger(e.ActionManager.OnEveryFrameTrigger)}if(this.simplificationQueue&&!this.simplificationQueue.running){this.simplificationQueue.executeNext()}if(this._engine.isDeterministicLockStep()){var t=Math.max(i.MinDeltaTime,Math.min(this._engine.getDeltaTime(),i.MaxDeltaTime))+this._timeAccumulator;var r=60/1e3;var n=1e3/60;if(this._physicsEngine){n=this._physicsEngine.getTimeStep()*1e3}var o=0;var s=this._engine.getLockstepMaxSteps();var a=Math.floor(t/(1e3*r));a=Math.min(a,s);do{this.onBeforeStepObservable.notifyObservers(this);this._animationRatio=n*r;this._animate();this.onAfterAnimationsObservable.notifyObservers(this);if(this._physicsEngine){this.onBeforePhysicsObservable.notifyObservers(this);this._physicsEngine._step(n/1e3);this.onAfterPhysicsObservable.notifyObservers(this)}this.onAfterStepObservable.notifyObservers(this);this._currentStepId++;o++;t-=n}while(t>0&&o<a);this._timeAccumulator=t<0?0:t}else{var t=this.useConstantAnimationDeltaTime?16:Math.max(i.MinDeltaTime,Math.min(this._engine.getDeltaTime(),i.MaxDeltaTime));this._animationRatio=t*(60/1e3);this._animate();this.onAfterAnimationsObservable.notifyObservers(this);if(this._physicsEngine){this.onBeforePhysicsObservable.notifyObservers(this);this._physicsEngine._step(t/1e3);this.onAfterPhysicsObservable.notifyObservers(this)}}if(this._gamepadManager&&this._gamepadManager._isMonitoring){this._gamepadManager._checkGamepadsStatus()}if(this.activeCameras.length>0){for(var u=0;u<this.activeCameras.length;u++){var l=this.activeCameras[u];l.update();if(l.cameraRigMode!==e.Camera.RIG_MODE_NONE){for(var c=0;c<l._rigCameras.length;c++){l._rigCameras[c].update()}}}}else if(this.activeCamera){this.activeCamera.update();if(this.activeCamera.cameraRigMode!==e.Camera.RIG_MODE_NONE){for(var c=0;c<this.activeCamera._rigCameras.length;c++){this.activeCamera._rigCameras[c].update()}}}this.onBeforeRenderObservable.notifyObservers(this);this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);var h=this.getEngine();var f=this.activeCamera;if(this.renderTargetsEnabled){e.Tools.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0);this._intermediateRendering=true;for(var d=0;d<this.customRenderTargets.length;d++){var p=this.customRenderTargets[d];if(p._shouldRender()){this._renderId++;this.activeCamera=p.activeCamera||this.activeCamera;if(!this.activeCamera)throw new Error("Active camera not set");h.setViewport(this.activeCamera.viewport);this.updateTransformMatrix();p.render(f!==this.activeCamera,this.dumpNextRenderTargets)}}e.Tools.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0);this._intermediateRendering=false;this._renderId++}if(this.customRenderTargets.length>0){h.restoreDefaultFramebuffer()}this.onAfterRenderTargetsRenderObservable.notifyObservers(this);this.activeCamera=f;if(this.proceduralTexturesEnabled){e.Tools.StartPerformanceCounter("Procedural textures",this.proceduralTextures.length>0);for(var _=0;_<this.proceduralTextures.length;_++){var m=this.proceduralTextures[_];if(m._shouldRender()){m.render()}}e.Tools.EndPerformanceCounter("Procedural textures",this.proceduralTextures.length>0)}if(this.autoClearDepthAndStencil||this.autoClear){this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}if(this.shadowsEnabled){for(var g=0;g<this.lights.length;g++){var v=this.lights[g];var y=v.getShadowGenerator();if(v.isEnabled()&&v.shadowEnabled&&y){var b=y.getShadowMap();if(this.textures.indexOf(b)!==-1){this._renderTargets.push(b)}}}}for(var x in this._depthRenderer){this._renderTargets.push(this._depthRenderer[x].getDepthMap())}if(this._geometryBufferRenderer){this._renderTargets.push(this._geometryBufferRenderer.getGBuffer())}if(this._postProcessRenderPipelineManager){this._postProcessRenderPipelineManager.update()}if(this.activeCameras.length>0){for(var u=0;u<this.activeCameras.length;u++){if(u>0){this._engine.clear(null,false,true,true)}this._processSubCameras(this.activeCameras[u])}}else{if(!this.activeCamera){throw new Error("No camera defined")}this._processSubCameras(this.activeCamera)}this._checkIntersections();if(e.AudioEngine){this._updateAudioParameters()}if(this.afterRender){this.afterRender()}this.onAfterRenderObservable.notifyObservers(this);for(var c=0;c<this._toBeDisposed.length;c++){var T=this._toBeDisposed.data[c];if(T){T.dispose()}this._toBeDisposed[c]=null}this._toBeDisposed.reset();if(this.dumpNextRenderTargets){this.dumpNextRenderTargets=false}this._activeBones.addCount(0,true);this._activeIndices.addCount(0,true);this._activeParticles.addCount(0,true)};i.prototype._updateAudioParameters=function(){if(!this.audioEnabled||!this._mainSoundTrack||this._mainSoundTrack.soundCollection.length===0&&this.soundTracks.length===1){return}var t;var i=e.Engine.audioEngine;if(this.activeCameras.length>0){t=this.activeCameras[0]}else{t=this.activeCamera}if(t&&i.canUseWebAudio&&i.audioContext){i.audioContext.listener.setPosition(t.position.x,t.position.y,t.position.z);if(t.rigCameras&&t.rigCameras.length>0){t=t.rigCameras[0]}var r=e.Matrix.Invert(t.getViewMatrix());var n=e.Vector3.TransformNormal(new e.Vector3(0,0,-1),r);n.normalize();if(!isNaN(n.x)&&!isNaN(n.y)&&!isNaN(n.z)){i.audioContext.listener.setOrientation(n.x,n.y,n.z,0,1,0)}var o;for(o=0;o<this.mainSoundTrack.soundCollection.length;o++){var s=this.mainSoundTrack.soundCollection[o];if(s.useCustomAttenuation){s.updateDistanceFromListener()}}for(o=0;o<this.soundTracks.length;o++){for(var a=0;a<this.soundTracks[o].soundCollection.length;a++){s=this.soundTracks[o].soundCollection[a];if(s.useCustomAttenuation){s.updateDistanceFromListener()}}}}};Object.defineProperty(i.prototype,"audioEnabled",{get:function(){return this._audioEnabled},set:function(t){this._audioEnabled=t;if(e.AudioEngine){if(this._audioEnabled){this._enableAudio()}else{this._disableAudio()}}},enumerable:true,configurable:true});i.prototype._disableAudio=function(){var e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++){this.mainSoundTrack.soundCollection[e].pause()}for(e=0;e<this.soundTracks.length;e++){for(var t=0;t<this.soundTracks[e].soundCollection.length;t++){this.soundTracks[e].soundCollection[t].pause()}}};i.prototype._enableAudio=function(){var e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++){if(this.mainSoundTrack.soundCollection[e].isPaused){this.mainSoundTrack.soundCollection[e].play()}}for(e=0;e<this.soundTracks.length;e++){for(var t=0;t<this.soundTracks[e].soundCollection.length;t++){if(this.soundTracks[e].soundCollection[t].isPaused){this.soundTracks[e].soundCollection[t].play()}}}};Object.defineProperty(i.prototype,"headphone",{get:function(){return this._headphone},set:function(t){this._headphone=t;if(e.AudioEngine){if(this._headphone){this._switchAudioModeForHeadphones()}else{this._switchAudioModeForNormalSpeakers()}}},enumerable:true,configurable:true});i.prototype._switchAudioModeForHeadphones=function(){this.mainSoundTrack.switchPanningModelToHRTF();for(var e=0;e<this.soundTracks.length;e++){this.soundTracks[e].switchPanningModelToHRTF()}};i.prototype._switchAudioModeForNormalSpeakers=function(){this.mainSoundTrack.switchPanningModelToEqualPower();for(var e=0;e<this.soundTracks.length;e++){this.soundTracks[e].switchPanningModelToEqualPower()}};i.prototype.enableDepthRenderer=function(t){t=t||this.activeCamera;if(!t){throw"No camera available to enable depth renderer"}if(!this._depthRenderer[t.id]){var i=0;if(this._engine.getCaps().textureHalfFloatRender){i=e.Engine.TEXTURETYPE_HALF_FLOAT}else if(this._engine.getCaps().textureFloatRender){i=e.Engine.TEXTURETYPE_FLOAT}else{throw"Depth renderer does not support int texture type"}this._depthRenderer[t.id]=new e.DepthRenderer(this,i,t)}return this._depthRenderer[t.id]};i.prototype.disableDepthRenderer=function(e){e=e||this.activeCamera;if(!e||!this._depthRenderer[e.id]){return}this._depthRenderer[e.id].dispose();delete this._depthRenderer[e.id]};i.prototype.enableGeometryBufferRenderer=function(t){if(t===void 0){t=1}if(this._geometryBufferRenderer){return this._geometryBufferRenderer}this._geometryBufferRenderer=new e.GeometryBufferRenderer(this,t);if(!this._geometryBufferRenderer.isSupported){this._geometryBufferRenderer=null}return this._geometryBufferRenderer};i.prototype.disableGeometryBufferRenderer=function(){if(!this._geometryBufferRenderer){return}this._geometryBufferRenderer.dispose();this._geometryBufferRenderer=null};i.prototype.freezeMaterials=function(){for(var e=0;e<this.materials.length;e++){this.materials[e].freeze()}};i.prototype.unfreezeMaterials=function(){for(var e=0;e<this.materials.length;e++){this.materials[e].unfreeze()}};i.prototype.dispose=function(){this.beforeRender=null;this.afterRender=null;this.skeletons=[];this.morphTargetManagers=[];this.importedMeshesFiles=new Array;this.stopAllAnimations();this.resetCachedMaterial();for(var t in this._depthRenderer){this._depthRenderer[t].dispose()}if(this._gamepadManager){this._gamepadManager.dispose();this._gamepadManager=null}if(this.activeCamera){this.activeCamera._activeMeshes.dispose();this.activeCamera=null}this._activeMeshes.dispose();this._renderingManager.dispose();this._processedMaterials.dispose();this._activeParticleSystems.dispose();this._activeSkeletons.dispose();this._softwareSkinnedMeshes.dispose();this._renderTargets.dispose();this._registeredForLateAnimationBindings.dispose();if(this._boundingBoxRenderer){this._boundingBoxRenderer.dispose()}this._meshesForIntersections.dispose();this._toBeDisposed.dispose();for(var i=0,r=this._activeRequests;i<r.length;i++){var n=r[i];n.abort()}if(this._debugLayer){this._debugLayer.hide()}this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onBeforeRenderObservable.clear();this.onAfterRenderObservable.clear();this.onBeforeRenderTargetsRenderObservable.clear();this.onAfterRenderTargetsRenderObservable.clear();this.onAfterStepObservable.clear();this.onBeforeStepObservable.clear();this.onBeforeActiveMeshesEvaluationObservable.clear();this.onAfterActiveMeshesEvaluationObservable.clear();this.onBeforeParticlesRenderingObservable.clear();this.onAfterParticlesRenderingObservable.clear();this.onBeforeSpritesRenderingObservable.clear();this.onAfterSpritesRenderingObservable.clear();this.onBeforeDrawPhaseObservable.clear();this.onAfterDrawPhaseObservable.clear();this.onBeforePhysicsObservable.clear();this.onAfterPhysicsObservable.clear();this.onBeforeAnimationsObservable.clear();this.onAfterAnimationsObservable.clear();this.onDataLoadedObservable.clear();this.detachControl();if(e.AudioEngine){this.disposeSounds()}if(this.VRHelper){this.VRHelper.dispose()}var o=this._engine.getRenderingCanvas();if(o){var s;for(s=0;s<this.cameras.length;s++){this.cameras[s].detachControl(o)}}while(this.animationGroups.length){this.animationGroups[0].dispose()}while(this.lights.length){this.lights[0].dispose()}while(this.meshes.length){this.meshes[0].dispose(true)}while(this.transformNodes.length){this.removeTransformNode(this.transformNodes[0])}while(this.cameras.length){this.cameras[0].dispose()}if(this.defaultMaterial){this.defaultMaterial.dispose()}while(this.multiMaterials.length){this.multiMaterials[0].dispose()}while(this.materials.length){this.materials[0].dispose()}while(this.particleSystems.length){this.particleSystems[0].dispose()}while(this.spriteManagers.length){this.spriteManagers[0].dispose()}while(this.postProcesses.length){this.postProcesses[0].dispose()}while(this.layers.length){this.layers[0].dispose()}while(this.effectLayers.length){this.effectLayers[0].dispose()}while(this.textures.length){this.textures[0].dispose()}this._sceneUbo.dispose();if(this._alternateSceneUbo){this._alternateSceneUbo.dispose()}this.postProcessManager.dispose();if(this._postProcessRenderPipelineManager){this._postProcessRenderPipelineManager.dispose()}if(this._physicsEngine){this.disablePhysicsEngine()}s=this._engine.scenes.indexOf(this);if(s>-1){this._engine.scenes.splice(s,1)}this._engine.wipeCaches(true);this._isDisposed=true};Object.defineProperty(i.prototype,"isDisposed",{get:function(){return this._isDisposed},enumerable:true,configurable:true});i.prototype.disposeSounds=function(){if(!this._mainSoundTrack){return}this.mainSoundTrack.dispose();for(var e=0;e<this.soundTracks.length;e++){this.soundTracks[e].dispose()}};i.prototype.getWorldExtends=function(t){var i=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);var r=new e.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);t=t||function(){return true};this.meshes.filter(t).forEach(function(t){t.computeWorldMatrix(true);if(!t.subMeshes||t.subMeshes.length===0||t.infiniteDistance){return}var n=t.getBoundingInfo();var o=n.boundingBox.minimumWorld;var s=n.boundingBox.maximumWorld;e.Tools.CheckExtends(o,i,r);e.Tools.CheckExtends(s,i,r)});return{min:i,max:r}};i.prototype.createOrUpdateSelectionOctree=function(t,i){if(t===void 0){t=64}if(i===void 0){i=2}if(!this._selectionOctree){this._selectionOctree=new e.Octree(e.Octree.CreationFuncForMeshes,t,i)}var r=this.getWorldExtends();this._selectionOctree.update(r.min,r.max,this.meshes);return this._selectionOctree};i.prototype.createPickingRay=function(t,i,r,n,o){if(o===void 0){o=false}var s=e.Ray.Zero();this.createPickingRayToRef(t,i,r,s,n,o);return s};i.prototype.createPickingRayToRef=function(t,i,r,n,o,s){if(s===void 0){s=false}var a=this._engine;if(!o){if(!this.activeCamera)throw new Error("Active camera not set");o=this.activeCamera}var u=o.viewport;var l=u.toGlobal(a.getRenderWidth(),a.getRenderHeight());t=t/this._engine.getHardwareScalingLevel()-l.x;i=i/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-l.y-l.height);n.update(t,i,l.width,l.height,r?r:e.Matrix.Identity(),s?e.Matrix.Identity():o.getViewMatrix(),o.getProjectionMatrix());return this};i.prototype.createPickingRayInCameraSpace=function(t,i,r){var n=e.Ray.Zero();this.createPickingRayInCameraSpaceToRef(t,i,n,r);return n};i.prototype.createPickingRayInCameraSpaceToRef=function(t,i,r,n){if(!e.PickingInfo){return this}var o=this._engine;if(!n){if(!this.activeCamera)throw new Error("Active camera not set");n=this.activeCamera}var s=n.viewport;var a=s.toGlobal(o.getRenderWidth(),o.getRenderHeight());var u=e.Matrix.Identity();t=t/this._engine.getHardwareScalingLevel()-a.x;i=i/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-a.y-a.height);r.update(t,i,a.width,a.height,u,u,n.getProjectionMatrix());return this};i.prototype._internalPick=function(t,i,r){if(!e.PickingInfo){return null}var n=null;for(var o=0;o<this.meshes.length;o++){var s=this.meshes[o];if(i){if(!i(s)){continue}}else if(!s.isEnabled()||!s.isVisible||!s.isPickable){continue}var a=s.getWorldMatrix();var u=t(a);var l=s.intersects(u,r);if(!l||!l.hit)continue;if(!r&&n!=null&&l.distance>=n.distance)continue;n=l;if(r){break}}return n||new e.PickingInfo};i.prototype._internalMultiPick=function(t,i){if(!e.PickingInfo){return null}var r=new Array;for(var n=0;n<this.meshes.length;n++){var o=this.meshes[n];if(i){if(!i(o)){continue}}else if(!o.isEnabled()||!o.isVisible||!o.isPickable){continue}var s=o.getWorldMatrix();var a=t(s);var u=o.intersects(a,false);if(!u||!u.hit)continue;r.push(u)}return r};i.prototype._internalPickSprites=function(t,i,r,n){if(!e.PickingInfo){return null}var o=null;if(!n){if(!this.activeCamera){return null}n=this.activeCamera}if(this.spriteManagers.length>0){for(var s=0;s<this.spriteManagers.length;s++){var a=this.spriteManagers[s];if(!a.isPickable){continue}var u=a.intersects(t,n,i,r);if(!u||!u.hit)continue;if(!r&&o!=null&&u.distance>=o.distance)continue;o=u;if(r){break}}}return o||new e.PickingInfo};i.prototype.pick=function(t,i,r,n,o){var s=this;if(!e.PickingInfo){return null}
return this._internalPick(function(e){s.createPickingRayToRef(t,i,e,s._tempPickingRay,o||null);return s._tempPickingRay},r,n)};i.prototype.pickSprite=function(e,t,i,r,n){this.createPickingRayInCameraSpaceToRef(e,t,this._tempPickingRay,n);return this._internalPickSprites(this._tempPickingRay,i,r,n)};i.prototype.pickWithRay=function(t,i,r){var n=this;return this._internalPick(function(i){if(!n._pickWithRayInverseMatrix){n._pickWithRayInverseMatrix=e.Matrix.Identity()}i.invertToRef(n._pickWithRayInverseMatrix);if(!n._cachedRayForTransform){n._cachedRayForTransform=e.Ray.Zero()}e.Ray.TransformToRef(t,n._pickWithRayInverseMatrix,n._cachedRayForTransform);return n._cachedRayForTransform},i,r)};i.prototype.multiPick=function(e,t,i,r){var n=this;return this._internalMultiPick(function(i){return n.createPickingRay(e,t,i,r||null)},i)};i.prototype.multiPickWithRay=function(t,i){var r=this;return this._internalMultiPick(function(i){if(!r._pickWithRayInverseMatrix){r._pickWithRayInverseMatrix=e.Matrix.Identity()}i.invertToRef(r._pickWithRayInverseMatrix);if(!r._cachedRayForTransform){r._cachedRayForTransform=e.Ray.Zero()}e.Ray.TransformToRef(t,r._pickWithRayInverseMatrix,r._cachedRayForTransform);return r._cachedRayForTransform},i)};i.prototype.setPointerOverMesh=function(t){if(this._pointerOverMesh===t){return}if(this._pointerOverMesh&&this._pointerOverMesh.actionManager){this._pointerOverMesh.actionManager.processTrigger(e.ActionManager.OnPointerOutTrigger,e.ActionEvent.CreateNew(this._pointerOverMesh))}this._pointerOverMesh=t;if(this._pointerOverMesh&&this._pointerOverMesh.actionManager){this._pointerOverMesh.actionManager.processTrigger(e.ActionManager.OnPointerOverTrigger,e.ActionEvent.CreateNew(this._pointerOverMesh))}};i.prototype.getPointerOverMesh=function(){return this._pointerOverMesh};i.prototype.setPointerOverSprite=function(t){if(this._pointerOverSprite===t){return}if(this._pointerOverSprite&&this._pointerOverSprite.actionManager){this._pointerOverSprite.actionManager.processTrigger(e.ActionManager.OnPointerOutTrigger,e.ActionEvent.CreateNewFromSprite(this._pointerOverSprite,this))}this._pointerOverSprite=t;if(this._pointerOverSprite&&this._pointerOverSprite.actionManager){this._pointerOverSprite.actionManager.processTrigger(e.ActionManager.OnPointerOverTrigger,e.ActionEvent.CreateNewFromSprite(this._pointerOverSprite,this))}};i.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};i.prototype.getPhysicsEngine=function(){return this._physicsEngine};i.prototype.enablePhysics=function(t,i){if(t===void 0){t=null}if(this._physicsEngine){return true}try{this._physicsEngine=new e.PhysicsEngine(t,i);return true}catch(t){e.Tools.Error(t.message);return false}};i.prototype.disablePhysicsEngine=function(){if(!this._physicsEngine){return}this._physicsEngine.dispose();this._physicsEngine=null};i.prototype.isPhysicsEnabled=function(){return this._physicsEngine!==undefined};i.prototype.deleteCompoundImpostor=function(e){var t=e.parts[0].mesh;if(t.physicsImpostor){t.physicsImpostor.dispose();t.physicsImpostor=null}};i.prototype._rebuildGeometries=function(){for(var e=0,t=this._geometries;e<t.length;e++){var i=t[e];i._rebuild()}for(var r=0,n=this.meshes;r<n.length;r++){var o=n[r];o._rebuild()}if(this.postProcessManager){this.postProcessManager._rebuild()}for(var s=0,a=this.layers;s<a.length;s++){var u=a[s];u._rebuild()}for(var l=0,c=this.effectLayers;l<c.length;l++){var h=c[l];h._rebuild()}if(this._boundingBoxRenderer){this._boundingBoxRenderer._rebuild()}for(var f=0,d=this.particleSystems;f<d.length;f++){var p=d[f];p.rebuild()}if(this._postProcessRenderPipelineManager){this._postProcessRenderPipelineManager._rebuild()}};i.prototype._rebuildTextures=function(){for(var t=0,i=this.textures;t<i.length;t++){var r=i[t];r._rebuild()}this.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag)};i.prototype.createDefaultLight=function(t){if(t===void 0){t=false}if(t){if(this.lights){for(var i=0;i<this.lights.length;i++){this.lights[i].dispose()}}}if(this.lights.length===0){new e.HemisphericLight("default light",e.Vector3.Up(),this)}};i.prototype.createDefaultCamera=function(t,i,r){if(t===void 0){t=false}if(i===void 0){i=false}if(r===void 0){r=false}if(i){if(this.activeCamera){this.activeCamera.dispose();this.activeCamera=null}}if(!this.activeCamera){var n=this.getWorldExtends();var o=n.max.subtract(n.min);var s=n.min.add(o.scale(.5));var a;var u=o.length()*1.5;if(!isFinite(u)){u=1;s.copyFromFloats(0,0,0)}if(t){var l=new e.ArcRotateCamera("default camera",-(Math.PI/2),Math.PI/2,u,s,this);l.lowerRadiusLimit=u*.01;l.wheelPrecision=100/u;a=l}else{var c=new e.FreeCamera("default camera",new e.Vector3(s.x,s.y,-u),this);c.setTarget(s);a=c}a.minZ=u*.01;a.maxZ=u*1e3;a.speed=u*.2;this.activeCamera=a;var h=this.getEngine().getRenderingCanvas();if(r&&h){a.attachControl(h)}}};i.prototype.createDefaultCameraOrLight=function(e,t,i){if(e===void 0){e=false}if(t===void 0){t=false}if(i===void 0){i=false}this.createDefaultLight(t);this.createDefaultCamera(e,t,i)};i.prototype.createDefaultSkybox=function(t,i,r,n){if(i===void 0){i=false}if(r===void 0){r=1e3}if(n===void 0){n=0}if(t){this.environmentTexture=t}if(!this.environmentTexture){e.Tools.Warn("Can not create default skybox without environment texture.");return null}var o=e.Mesh.CreateBox("hdrSkyBox",r,this);if(i){var s=new e.PBRMaterial("skyBox",this);s.backFaceCulling=false;s.reflectionTexture=this.environmentTexture.clone();if(s.reflectionTexture){s.reflectionTexture.coordinatesMode=e.Texture.SKYBOX_MODE}s.microSurface=1-n;s.disableLighting=true;s.twoSidedLighting=true;o.infiniteDistance=true;o.material=s}else{var a=new e.StandardMaterial("skyBox",this);a.backFaceCulling=false;a.reflectionTexture=this.environmentTexture.clone();if(a.reflectionTexture){a.reflectionTexture.coordinatesMode=e.Texture.SKYBOX_MODE}a.disableLighting=true;o.infiniteDistance=true;o.material=a}return o};i.prototype.createDefaultEnvironment=function(t){if(e.EnvironmentHelper){return new e.EnvironmentHelper(t,this)}return null};i.prototype.createDefaultVRExperience=function(t){if(t===void 0){t={}}return new e.VRExperienceHelper(this,t)};i.prototype._getByTags=function(t,i,r){if(i===undefined){return t}var n=[];r=r||function(e){return};for(var o in t){var s=t[o];if(e.Tags&&e.Tags.MatchesQuery(s,i)){n.push(s);r(s)}}return n};i.prototype.getMeshesByTags=function(e,t){return this._getByTags(this.meshes,e,t)};i.prototype.getCamerasByTags=function(e,t){return this._getByTags(this.cameras,e,t)};i.prototype.getLightsByTags=function(e,t){return this._getByTags(this.lights,e,t)};i.prototype.getMaterialByTags=function(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))};i.prototype.setRenderingOrder=function(e,t,i,r){if(t===void 0){t=null}if(i===void 0){i=null}if(r===void 0){r=null}this._renderingManager.setRenderingOrder(e,t,i,r)};i.prototype.setRenderingAutoClearDepthStencil=function(e,t,i,r){if(i===void 0){i=true}if(r===void 0){r=true}this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,r)};i.prototype.markAllMaterialsAsDirty=function(e,t){for(var i=0,r=this.materials;i<r.length;i++){var n=r[i];if(t&&!t(n)){continue}n.markAsDirty(e)}};i.prototype._loadFile=function(t,i,r,n,o,s){var a=this;var u=e.Tools.LoadFile(t,i,r,n?this.database:undefined,o,s);this._activeRequests.push(u);u.onCompleteObservable.add(function(e){a._activeRequests.splice(a._activeRequests.indexOf(e),1)});return u};i.prototype._loadFileAsync=function(e,t,i){var r=this;return new Promise(function(n,o){r._loadFile(e,function(e){n(e)},undefined,t,i,function(e,t){o(t)})})};i._FOGMODE_NONE=0;i._FOGMODE_EXP=1;i._FOGMODE_EXP2=2;i._FOGMODE_LINEAR=3;i._uniqueIdCounter=0;i.MinDeltaTime=1;i.MaxDeltaTime=1e3;i.DragMovementThreshold=10;i.LongPressDelay=500;i.DoubleClickDelay=300;i.ExclusiveDoubleClickMode=false;return i}();e.Scene=r})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this.cameras=new Array;this.lights=new Array;this.meshes=new Array;this.skeletons=new Array;this.particleSystems=new Array;this.animations=new Array;this.animationGroups=new Array;this.multiMaterials=new Array;this.materials=new Array;this.morphTargetManagers=new Array;this.geometries=new Array;this.transformNodes=new Array;this.lensFlareSystems=new Array;this.shadowGenerators=new Array;this.actionManagers=new Array;this.sounds=new Array;this.textures=new Array}return e}();e.KeepAssets=t;var i=function(){function e(e){this.cameras=new Array;this.lights=new Array;this.meshes=new Array;this.skeletons=new Array;this.particleSystems=new Array;this.animations=new Array;this.animationGroups=new Array;this.multiMaterials=new Array;this.materials=new Array;this.morphTargetManagers=new Array;this.geometries=new Array;this.transformNodes=new Array;this.lensFlareSystems=new Array;this.shadowGenerators=new Array;this.actionManagers=new Array;this.sounds=new Array;this.textures=new Array;this.scene=e}e.prototype.addAllToScene=function(){var e=this;this.cameras.forEach(function(t){e.scene.addCamera(t)});this.lights.forEach(function(t){e.scene.addLight(t)});this.meshes.forEach(function(t){e.scene.addMesh(t)});this.skeletons.forEach(function(t){e.scene.addSkeleton(t)});this.particleSystems.forEach(function(t){e.scene.addParticleSystem(t)});this.animations.forEach(function(t){e.scene.addAnimation(t)});this.animationGroups.forEach(function(t){e.scene.addAnimationGroup(t)});this.multiMaterials.forEach(function(t){e.scene.addMultiMaterial(t)});this.materials.forEach(function(t){e.scene.addMaterial(t)});this.morphTargetManagers.forEach(function(t){e.scene.addMorphTargetManager(t)});this.geometries.forEach(function(t){e.scene.addGeometry(t)});this.transformNodes.forEach(function(t){e.scene.addTransformNode(t)});this.lensFlareSystems.forEach(function(t){e.scene.addLensFlareSystem(t)});this.actionManagers.forEach(function(t){e.scene.addActionManager(t)});this.sounds.forEach(function(t){t.play();t.autoplay=true;e.scene.mainSoundTrack.AddSound(t)});this.textures.forEach(function(t){e.scene.addTexture})};e.prototype.removeAllFromScene=function(){var e=this;this.cameras.forEach(function(t){e.scene.removeCamera(t)});this.lights.forEach(function(t){e.scene.removeLight(t)});this.meshes.forEach(function(t){e.scene.removeMesh(t)});this.skeletons.forEach(function(t){e.scene.removeSkeleton(t)});this.particleSystems.forEach(function(t){e.scene.removeParticleSystem(t)});this.animations.forEach(function(t){e.scene.removeAnimation(t)});this.animationGroups.forEach(function(t){e.scene.removeAnimationGroup(t)});this.multiMaterials.forEach(function(t){e.scene.removeMultiMaterial(t)});this.materials.forEach(function(t){e.scene.removeMaterial(t)});this.morphTargetManagers.forEach(function(t){e.scene.removeMorphTargetManager(t)});this.geometries.forEach(function(t){e.scene.removeGeometry(t)});this.transformNodes.forEach(function(t){e.scene.removeTransformNode(t)});this.lensFlareSystems.forEach(function(t){e.scene.removeLensFlareSystem(t)});this.actionManagers.forEach(function(t){e.scene.removeActionManager(t)});this.sounds.forEach(function(t){t.stop();t.autoplay=false;e.scene.mainSoundTrack.RemoveSound(t)});this.textures.forEach(function(t){e.scene.removeTexture(t)})};e.prototype._moveAssets=function(e,t,i){for(var r=0,n=e;r<n.length;r++){var o=n[r];var s=true;for(var a=0,u=i;a<u.length;a++){var l=u[a];if(o===l){s=false;break}}if(s){t.push(o)}}};e.prototype.moveAllFromScene=function(e){if(e===undefined){e=new t}this._moveAssets(this.scene.cameras,this.cameras,e.cameras);this._moveAssets(this.scene.meshes,this.meshes,e.meshes);this._moveAssets(this.scene.getGeometries(),this.geometries,e.geometries);this._moveAssets(this.scene.materials,this.materials,e.materials);this._moveAssets(this.scene._actionManagers,this.actionManagers,e.actionManagers);this._moveAssets(this.scene.animations,this.animations,e.animations);this._moveAssets(this.scene.animationGroups,this.animationGroups,e.animationGroups);this._moveAssets(this.scene.lensFlareSystems,this.lensFlareSystems,e.lensFlareSystems);this._moveAssets(this.scene.lights,this.lights,e.lights);this._moveAssets(this.scene.morphTargetManagers,this.morphTargetManagers,e.morphTargetManagers);this._moveAssets(this.scene.multiMaterials,this.multiMaterials,e.multiMaterials);this._moveAssets(this.scene.skeletons,this.skeletons,e.skeletons);this._moveAssets(this.scene.particleSystems,this.particleSystems,e.particleSystems);this._moveAssets(this.scene.mainSoundTrack.soundCollection,this.sounds,e.sounds);this._moveAssets(this.scene.transformNodes,this.transformNodes,e.transformNodes);this._moveAssets(this.scene.textures,this.textures,e.textures);this.removeAllFromScene()};return e}();e.AssetContainer=i})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r,n,o,s,a){if(n===void 0){n=0}if(o===void 0){o=false}if(s===void 0){s=false}if(a===void 0){a=false}if(t instanceof e.Mesh){this._engine=t.getScene().getEngine()}else{this._engine=t}this._updatable=r;this._instanced=s;this._data=i;this.byteStride=a?n:n*4;if(!o){this.create()}}t.prototype.createVertexBuffer=function(t,i,r,n,o,s){if(s===void 0){s=false}var a=s?i:i*4;var u=n?s?n:n*4:this.byteStride;return new e.VertexBuffer(this._engine,this,t,this._updatable,true,u,o===undefined?this._instanced:o,a,r,undefined,undefined,true)};t.prototype.isUpdatable=function(){return this._updatable};t.prototype.getData=function(){return this._data};t.prototype.getBuffer=function(){return this._buffer};t.prototype.getStrideSize=function(){return this.byteStride/4};t.prototype.create=function(e){if(e===void 0){e=null}if(!e&&this._buffer){return}e=e||this._data;if(!e){return}if(!this._buffer){if(this._updatable){this._buffer=this._engine.createDynamicVertexBuffer(e);this._data=e}else{this._buffer=this._engine.createVertexBuffer(e)}}else if(this._updatable){this._engine.updateDynamicVertexBuffer(this._buffer,e);this._data=e}};t.prototype._rebuild=function(){this._buffer=null;this.create(this._data)};t.prototype.update=function(e){this.create(e)};t.prototype.updateDirectly=function(e,t,i,r){if(r===void 0){r=false}if(!this._buffer){return}if(this._updatable){this._engine.updateDynamicVertexBuffer(this._buffer,e,r?t:t*4,i?i*this.byteStride:undefined);this._data=null}};t.prototype.dispose=function(){if(!this._buffer){return}if(this._engine._releaseBuffer(this._buffer)){this._buffer=null}};return t}();e.Buffer=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(i,r,n,o,s,a,u,l,c,h,f,d){if(f===void 0){f=false}if(d===void 0){d=false}if(r instanceof e.Buffer){this._buffer=r;this._ownsBuffer=false}else{this._buffer=new e.Buffer(i,r,o,a,s,u,d);this._ownsBuffer=true}this._kind=n;if(h==undefined){var p=this.getData();this.type=t.FLOAT;if(p instanceof Int8Array)this.type=t.BYTE;else if(p instanceof Uint8Array)this.type=t.UNSIGNED_BYTE;else if(p instanceof Int16Array)this.type=t.SHORT;else if(p instanceof Uint16Array)this.type=t.UNSIGNED_SHORT;else if(p instanceof Int32Array)this.type=t.INT;else if(p instanceof Uint32Array)this.type=t.UNSIGNED_INT}else{this.type=h}var _=t.GetTypeByteLength(this.type);if(d){this._size=c||(a?a/_:t.DeduceStride(n));this.byteStride=a||this._buffer.byteStride||this._size*_;this.byteOffset=l||0}else{this._size=c||a||t.DeduceStride(n);this.byteStride=a?a*_:this._buffer.byteStride||this._size*_;this.byteOffset=(l||0)*_}this.normalized=f;this._instanced=u!==undefined?u:false;this._instanceDivisor=u?1:0}Object.defineProperty(t.prototype,"instanceDivisor",{get:function(){return this._instanceDivisor},set:function(e){this._instanceDivisor=e;if(e==0){this._instanced=false}else{this._instanced=true}},enumerable:true,configurable:true});t.prototype._rebuild=function(){if(!this._buffer){return}this._buffer._rebuild()};t.prototype.getKind=function(){return this._kind};t.prototype.isUpdatable=function(){return this._buffer.isUpdatable()};t.prototype.getData=function(){return this._buffer.getData()};t.prototype.getBuffer=function(){return this._buffer.getBuffer()};t.prototype.getStrideSize=function(){return this.byteStride/t.GetTypeByteLength(this.type)};t.prototype.getOffset=function(){return this.byteOffset/t.GetTypeByteLength(this.type)};t.prototype.getSize=function(){return this._size};t.prototype.getIsInstanced=function(){return this._instanced};t.prototype.getInstanceDivisor=function(){return this._instanceDivisor};t.prototype.create=function(e){return this._buffer.create(e)};t.prototype.update=function(e){return this._buffer.update(e)};t.prototype.updateDirectly=function(e,t){return this._buffer.updateDirectly(e,t)};t.prototype.dispose=function(){if(this._ownsBuffer){this._buffer.dispose()}};t.prototype.forEach=function(e,i){t.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,i)};Object.defineProperty(t,"PositionKind",{get:function(){return t._PositionKind},enumerable:true,configurable:true});Object.defineProperty(t,"NormalKind",{get:function(){return t._NormalKind},enumerable:true,configurable:true});Object.defineProperty(t,"TangentKind",{get:function(){return t._TangentKind},enumerable:true,configurable:true});Object.defineProperty(t,"UVKind",{get:function(){return t._UVKind},enumerable:true,configurable:true});Object.defineProperty(t,"UV2Kind",{get:function(){return t._UV2Kind},enumerable:true,configurable:true});Object.defineProperty(t,"UV3Kind",{get:function(){return t._UV3Kind},enumerable:true,configurable:true});Object.defineProperty(t,"UV4Kind",{get:function(){return t._UV4Kind},enumerable:true,configurable:true});Object.defineProperty(t,"UV5Kind",{get:function(){return t._UV5Kind},enumerable:true,configurable:true});Object.defineProperty(t,"UV6Kind",{get:function(){return t._UV6Kind},enumerable:true,configurable:true});Object.defineProperty(t,"ColorKind",{get:function(){return t._ColorKind},enumerable:true,configurable:true});Object.defineProperty(t,"MatricesIndicesKind",{get:function(){return t._MatricesIndicesKind},enumerable:true,configurable:true});Object.defineProperty(t,"MatricesWeightsKind",{get:function(){return t._MatricesWeightsKind},enumerable:true,configurable:true});Object.defineProperty(t,"MatricesIndicesExtraKind",{get:function(){return t._MatricesIndicesExtraKind},enumerable:true,configurable:true});Object.defineProperty(t,"MatricesWeightsExtraKind",{get:function(){return t._MatricesWeightsExtraKind},enumerable:true,configurable:true});t.DeduceStride=function(e){switch(e){case t.UVKind:case t.UV2Kind:case t.UV3Kind:case t.UV4Kind:case t.UV5Kind:case t.UV6Kind:return 2;case t.NormalKind:case t.PositionKind:return 3;case t.ColorKind:case t.MatricesIndicesKind:case t.MatricesIndicesExtraKind:case t.MatricesWeightsKind:case t.MatricesWeightsExtraKind:case t.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}};t.GetTypeByteLength=function(e){switch(e){case t.BYTE:case t.UNSIGNED_BYTE:return 1;case t.SHORT:case t.UNSIGNED_SHORT:return 2;case t.INT:case t.FLOAT:return 4;default:throw new Error("Invalid type '"+e+"'")}};t.ForEach=function(e,i,r,n,o,s,a,u){if(e instanceof Array){var l=i/4;var c=r/4;for(var h=0;h<s;h+=n){for(var f=0;f<n;f++){u(e[l+f],h+f)}l+=c}}else{var d=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength);var p=t.GetTypeByteLength(o);for(var h=0;h<s;h+=n){var _=i;for(var f=0;f<n;f++){var m=t._GetFloatValue(d,o,_,a);u(m,h+f);_+=p}i+=r}}};t._GetFloatValue=function(e,i,r,n){switch(i){case t.BYTE:{var o=e.getInt8(r);if(n){o=(o+.5)/127.5}return o}case t.UNSIGNED_BYTE:{var o=e.getUint8(r);if(n){o=o/255}return o}case t.SHORT:{var o=e.getInt16(r,true);if(n){o=(o+.5)/16383.5}return o}case t.UNSIGNED_SHORT:{var o=e.getUint16(r,true);if(n){o=o/65535}return o}case t.FLOAT:{return e.getFloat32(r,true)}default:{throw new Error("Invalid component type "+i)}}};t.BYTE=5120;t.UNSIGNED_BYTE=5121;t.SHORT=5122;t.UNSIGNED_SHORT=5123;t.INT=5124;t.UNSIGNED_INT=5125;t.FLOAT=5126;t._PositionKind="position";t._NormalKind="normal";t._TangentKind="tangent";t._UVKind="uv";t._UV2Kind="uv2";t._UV3Kind="uv3";t._UV4Kind="uv4";t._UV5Kind="uv5";t._UV6Kind="uv6";t._ColorKind="color";t._MatricesIndicesKind="matricesIndices";t._MatricesWeightsKind="matricesWeights";t._MatricesIndicesExtraKind="matricesIndicesExtra";t._MatricesWeightsExtraKind="matricesWeightsExtra";return t}();e.VertexBuffer=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this.previous=null;this.next=null}return e}();e.DummyInternalTextureTracker=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(i,r){this.onLoadedObservable=new e.Observable;this.previous=null;this.next=null;this._initialSlot=-1;this._designatedSlot=-1;this._dataSource=t.DATASOURCE_UNKNOWN;this._comparisonFunction=0;this._references=1;this._engine=i;this._dataSource=r;this._webGLTexture=i._createTexture()}Object.defineProperty(t.prototype,"dataSource",{get:function(){return this._dataSource},enumerable:true,configurable:true});t.prototype.incrementReferences=function(){this._references++};t.prototype.updateSize=function(e,t,i){if(i===void 0){i=1}this.width=e;this.height=t;this.depth=i;this.baseWidth=e;this.baseHeight=t;this.baseDepth=i;this._size=e*t*i};t.prototype._rebuild=function(){var i=this;var r;this.isReady=false;this._cachedCoordinatesMode=null;this._cachedWrapU=null;this._cachedWrapV=null;this._cachedAnisotropicFilteringLevel=null;switch(this._dataSource){case t.DATASOURCE_TEMP:return;case t.DATASOURCE_URL:r=this._engine.createTexture(this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,function(){i.isReady=true},null,this._buffer,undefined,this.format);r._swapAndDie(this);return;case t.DATASOURCE_RAW:r=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression);r._swapAndDie(this);this.isReady=true;return;case t.DATASOURCE_RAW3D:r=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression);r._swapAndDie(this);this.isReady=true;return;case t.DATASOURCE_DYNAMIC:r=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode);r._swapAndDie(this);return;case t.DATASOURCE_RENDERTARGET:var n=new e.RenderTargetCreationOptions;n.generateDepthBuffer=this._generateDepthBuffer;n.generateMipMaps=this.generateMipMaps;n.generateStencilBuffer=this._generateStencilBuffer;n.samplingMode=this.samplingMode;n.type=this.type;if(this.isCube){r=this._engine.createRenderTargetCubeTexture(this.width,n)}else{var o={width:this.width,height:this.height};r=this._engine.createRenderTargetTexture(o,n)}r._swapAndDie(this);this.isReady=true;return;case t.DATASOURCE_DEPTHTEXTURE:var s={bilinearFiltering:this.samplingMode!==e.Texture.BILINEAR_SAMPLINGMODE,comparisonFunction:this._comparisonFunction,generateStencil:this._generateStencilBuffer,isCube:this.isCube};r=this._engine.createDepthStencilTexture({width:this.width,height:this.height},s);r._swapAndDie(this);this.isReady=true;return;case t.DATASOURCE_CUBE:r=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,function(){i.isReady=true},null,this.format,this._extension);r._swapAndDie(this);return;case t.DATASOURCE_CUBERAW:r=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression);r._swapAndDie(this);this.isReady=true;return;case t.DATASOURCE_CUBEPREFILTERED:r=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,function(e){if(e){e._swapAndDie(i)}i.isReady=true},null,this.format,this._extension);return}};t.prototype._swapAndDie=function(e){e._webGLTexture=this._webGLTexture;if(this._framebuffer){e._framebuffer=this._framebuffer}if(this._depthStencilBuffer){e._depthStencilBuffer=this._depthStencilBuffer}if(this._lodTextureHigh){if(e._lodTextureHigh){e._lodTextureHigh.dispose()}e._lodTextureHigh=this._lodTextureHigh}if(this._lodTextureMid){if(e._lodTextureMid){e._lodTextureMid.dispose()}e._lodTextureMid=this._lodTextureMid}if(this._lodTextureLow){if(e._lodTextureLow){e._lodTextureLow.dispose()}e._lodTextureLow=this._lodTextureLow}var t=this._engine.getLoadedTexturesCache();var i=t.indexOf(this);if(i!==-1){t.splice(i,1)}};t.prototype.dispose=function(){if(!this._webGLTexture){return}this._references--;if(this._references===0){this._engine._releaseTexture(this);this._webGLTexture=null;this.previous=null;this.next=null}};t.DATASOURCE_UNKNOWN=0;t.DATASOURCE_URL=1;t.DATASOURCE_TEMP=2;t.DATASOURCE_RAW=3;t.DATASOURCE_DYNAMIC=4;t.DATASOURCE_RENDERTARGET=5;t.DATASOURCE_MULTIRENDERTARGET=6;t.DATASOURCE_CUBE=7;t.DATASOURCE_CUBERAW=8;t.DATASOURCE_CUBEPREFILTERED=9;t.DATASOURCE_RAW3D=10;t.DATASOURCE_DEPTHTEXTURE=11;return t}();e.InternalTexture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(i){this._hasAlpha=false;this.getAlphaFromRGB=false;this.level=1;this.coordinatesIndex=0;this._coordinatesMode=e.Texture.EXPLICIT_MODE;this.wrapU=e.Texture.WRAP_ADDRESSMODE;this.wrapV=e.Texture.WRAP_ADDRESSMODE;this.wrapR=e.Texture.WRAP_ADDRESSMODE;this.anisotropicFilteringLevel=t.DEFAULT_ANISOTROPIC_FILTERING_LEVEL;this.isCube=false;this.is3D=false;this.gammaSpace=true;this.invertZ=false;this.lodLevelInAlpha=false;this.lodGenerationOffset=0;this.lodGenerationScale=.8;this.isRenderTarget=false;this.animations=new Array;this.onDisposeObservable=new e.Observable;this.delayLoadState=e.Engine.DELAYLOADSTATE_NONE;this._scene=i||e.Engine.LastCreatedScene;if(this._scene){this._scene.textures.push(this)}this._uid=null}Object.defineProperty(t.prototype,"hasAlpha",{get:function(){return this._hasAlpha},set:function(t){if(this._hasAlpha===t){return}this._hasAlpha=t;if(this._scene){this._scene.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag|e.Material.MiscDirtyFlag)}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"coordinatesMode",{get:function(){return this._coordinatesMode},set:function(t){if(this._coordinatesMode===t){return}this._coordinatesMode=t;if(this._scene){this._scene.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag)}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"uid",{get:function(){if(!this._uid){this._uid=e.Tools.RandomId()}return this._uid},enumerable:true,configurable:true});t.prototype.toString=function(){return this.name};t.prototype.getClassName=function(){return"BaseTexture"};Object.defineProperty(t.prototype,"onDispose",{set:function(e){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"isBlocking",{get:function(){return true},enumerable:true,configurable:true});t.prototype.getScene=function(){return this._scene};t.prototype.getTextureMatrix=function(){return e.Matrix.IdentityReadOnly};t.prototype.getReflectionTextureMatrix=function(){return e.Matrix.IdentityReadOnly};t.prototype.getInternalTexture=function(){return this._texture};t.prototype.isReadyOrNotBlocking=function(){return!this.isBlocking||this.isReady()};t.prototype.isReady=function(){if(this.delayLoadState===e.Engine.DELAYLOADSTATE_NOTLOADED){this.delayLoad();return false}if(this._texture){return this._texture.isReady}return false};t.prototype.getSize=function(){if(this._texture&&this._texture.width){return new e.Size(this._texture.width,this._texture.height)}if(this._texture&&this._texture._size){return new e.Size(this._texture._size,this._texture._size)}return e.Size.Zero()};t.prototype.getBaseSize=function(){if(!this.isReady()||!this._texture)return e.Size.Zero();if(this._texture._size){return new e.Size(this._texture._size,this._texture._size)}return new e.Size(this._texture.baseWidth,this._texture.baseHeight)};t.prototype.scale=function(e){};Object.defineProperty(t.prototype,"canRescale",{get:function(){return false},enumerable:true,configurable:true});t.prototype._getFromCache=function(e,t,i){if(!this._scene){return null}var r=this._scene.getEngine().getLoadedTexturesCache();for(var n=0;n<r.length;n++){var o=r[n];if(o.url===e&&o.generateMipMaps===!t){if(!i||i===o.samplingMode){o.incrementReferences();return o}}}return null};t.prototype._rebuild=function(){};t.prototype.delayLoad=function(){};t.prototype.clone=function(){return null};Object.defineProperty(t.prototype,"textureType",{get:function(){if(!this._texture){return e.Engine.TEXTURETYPE_UNSIGNED_INT}return this._texture.type!==undefined?this._texture.type:e.Engine.TEXTURETYPE_UNSIGNED_INT},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"textureFormat",{get:function(){if(!this._texture){return e.Engine.TEXTUREFORMAT_RGBA}return this._texture.format!==undefined?this._texture.format:e.Engine.TEXTUREFORMAT_RGBA},enumerable:true,configurable:true});t.prototype.readPixels=function(e){if(e===void 0){e=0}if(!this._texture){return null}var t=this.getSize();var i=this.getScene();if(!i){return null}var r=i.getEngine();if(this._texture.isCube){return r._readTexturePixels(this._texture,t.width,t.height,e)}return r._readTexturePixels(this._texture,t.width,t.height,-1)};t.prototype.releaseInternalTexture=function(){if(this._texture){this._texture.dispose();this._texture=null}};Object.defineProperty(t.prototype,"sphericalPolynomial",{get:function(){if(!this._texture||!e.CubeMapToSphericalPolynomialTools||!this.isReady()){return null}if(!this._texture._sphericalPolynomial){this._texture._sphericalPolynomial=e.CubeMapToSphericalPolynomialTools.ConvertCubeMapTextureToSphericalPolynomial(this)}return this._texture._sphericalPolynomial},set:function(e){if(this._texture){this._texture._sphericalPolynomial=e}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"_lodTextureHigh",{get:function(){if(this._texture){return this._texture._lodTextureHigh}return null},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"_lodTextureMid",{get:function(){if(this._texture){return this._texture._lodTextureMid}return null},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"_lodTextureLow",{get:function(){if(this._texture){return this._texture._lodTextureLow}return null},enumerable:true,configurable:true});t.prototype.dispose=function(){if(!this._scene){return}this._scene.stopAnimation(this);this._scene._removePendingData(this);var e=this._scene.textures.indexOf(this);if(e>=0){this._scene.textures.splice(e,1)}if(this._texture===undefined){return}this.releaseInternalTexture();this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear()};t.prototype.serialize=function(){if(!this.name){return null}var t=e.SerializationHelper.Serialize(this);e.Animation.AppendSerializedAnimations(this,t);return t};t.WhenAllReady=function(e,t){var i=e.length;if(i===0){t();return}var r=function(){n=e[s];if(n.isReady()){if(--i===0){t()}}else{o=n.onLoadObservable;var r=function(){o.removeCallback(r);if(--i===0){t()}};o.add(r)}};var n,o;for(var s=0;s<e.length;s++){r()}};t.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4;__decorate([e.serialize()],t.prototype,"name",void 0);__decorate([e.serialize("hasAlpha")],t.prototype,"_hasAlpha",void 0);__decorate([e.serialize()],t.prototype,"getAlphaFromRGB",void 0);__decorate([e.serialize()],t.prototype,"level",void 0);__decorate([e.serialize()],t.prototype,"coordinatesIndex",void 0);__decorate([e.serialize("coordinatesMode")],t.prototype,"_coordinatesMode",void 0);__decorate([e.serialize()],t.prototype,"wrapU",void 0);__decorate([e.serialize()],t.prototype,"wrapV",void 0);__decorate([e.serialize()],t.prototype,"wrapR",void 0);__decorate([e.serialize()],t.prototype,"anisotropicFilteringLevel",void 0);__decorate([e.serialize()],t.prototype,"isCube",void 0);__decorate([e.serialize()],t.prototype,"is3D",void 0)
;__decorate([e.serialize()],t.prototype,"gammaSpace",void 0);__decorate([e.serialize()],t.prototype,"invertZ",void 0);__decorate([e.serialize()],t.prototype,"lodLevelInAlpha",void 0);__decorate([e.serialize()],t.prototype,"lodGenerationOffset",void 0);__decorate([e.serialize()],t.prototype,"lodGenerationScale",void 0);__decorate([e.serialize()],t.prototype,"isRenderTarget",void 0);return t}();e.BaseTexture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(r,n,o,s,a,u,l,c,h,f){if(o===void 0){o=false}if(s===void 0){s=true}if(a===void 0){a=i.TRILINEAR_SAMPLINGMODE}if(u===void 0){u=null}if(l===void 0){l=null}if(c===void 0){c=null}if(h===void 0){h=false}var d=t.call(this,n)||this;d.uOffset=0;d.vOffset=0;d.uScale=1;d.vScale=1;d.uAng=0;d.vAng=0;d.wAng=0;d._isBlocking=true;d.name=r||"";d.url=r;d._noMipmap=o;d._invertY=s;d._samplingMode=a;d._buffer=c;d._deleteBuffer=h;if(f){d._format=f}n=d.getScene();if(!n){return d}n.getEngine().onBeforeTextureInitObservable.notifyObservers(d);var p=function(){if(d._onLoadObservable&&d._onLoadObservable.hasObservers()){d.onLoadObservable.notifyObservers(d)}if(u){u()}if(!d.isBlocking&&n){n.resetCachedMaterial()}};if(!d.url){d._delayedOnLoad=p;d._delayedOnError=l;return d}d._texture=d._getFromCache(d.url,o,a);if(!d._texture){if(!n.useDelayedTextureLoading){d._texture=n.getEngine().createTexture(d.url,o,s,n,d._samplingMode,p,l,d._buffer,undefined,d._format);if(h){delete d._buffer}}else{d.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED;d._delayedOnLoad=p;d._delayedOnError=l}}else{if(d._texture.isReady){e.Tools.SetImmediate(function(){return p()})}else{d._texture.onLoadedObservable.add(p)}}return d}Object.defineProperty(i.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"isBlocking",{get:function(){return this._isBlocking},set:function(e){this._isBlocking=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"samplingMode",{get:function(){return this._samplingMode},enumerable:true,configurable:true});i.prototype.updateURL=function(t){this.url=t;this.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED;this.delayLoad()};i.prototype.delayLoad=function(){if(this.delayLoadState!==e.Engine.DELAYLOADSTATE_NOTLOADED){return}var t=this.getScene();if(!t){return}this.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED;this._texture=this._getFromCache(this.url,this._noMipmap,this._samplingMode);if(!this._texture){this._texture=t.getEngine().createTexture(this.url,this._noMipmap,this._invertY,t,this._samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format);if(this._deleteBuffer){delete this._buffer}}else{if(this._delayedOnLoad){if(this._texture.isReady){e.Tools.SetImmediate(this._delayedOnLoad)}else{this._texture.onLoadedObservable.add(this._delayedOnLoad)}}}this._delayedOnLoad=null;this._delayedOnError=null};i.prototype.updateSamplingMode=function(e){if(!this._texture){return}var t=this.getScene();if(!t){return}this._samplingMode=e;t.getEngine().updateTextureSamplingMode(e,this._texture)};i.prototype._prepareRowForTextureGeneration=function(t,i,r,n){t*=this.uScale;i*=this.vScale;t-=.5*this.uScale;i-=.5*this.vScale;r-=.5;e.Vector3.TransformCoordinatesFromFloatsToRef(t,i,r,this._rowGenerationMatrix,n);n.x+=.5*this.uScale+this.uOffset;n.y+=.5*this.vScale+this.vOffset;n.z+=.5};i.prototype.getTextureMatrix=function(){var t=this;if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng){return this._cachedTextureMatrix}this._cachedUOffset=this.uOffset;this._cachedVOffset=this.vOffset;this._cachedUScale=this.uScale;this._cachedVScale=this.vScale;this._cachedUAng=this.uAng;this._cachedVAng=this.vAng;this._cachedWAng=this.wAng;if(!this._cachedTextureMatrix){this._cachedTextureMatrix=e.Matrix.Zero();this._rowGenerationMatrix=new e.Matrix;this._t0=e.Vector3.Zero();this._t1=e.Vector3.Zero();this._t2=e.Vector3.Zero()}e.Matrix.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix);this._prepareRowForTextureGeneration(0,0,0,this._t0);this._prepareRowForTextureGeneration(1,0,0,this._t1);this._prepareRowForTextureGeneration(0,1,0,this._t2);this._t1.subtractInPlace(this._t0);this._t2.subtractInPlace(this._t0);e.Matrix.IdentityToRef(this._cachedTextureMatrix);this._cachedTextureMatrix.m[0]=this._t1.x;this._cachedTextureMatrix.m[1]=this._t1.y;this._cachedTextureMatrix.m[2]=this._t1.z;this._cachedTextureMatrix.m[4]=this._t2.x;this._cachedTextureMatrix.m[5]=this._t2.y;this._cachedTextureMatrix.m[6]=this._t2.z;this._cachedTextureMatrix.m[8]=this._t0.x;this._cachedTextureMatrix.m[9]=this._t0.y;this._cachedTextureMatrix.m[10]=this._t0.z;var i=this.getScene();if(!i){return this._cachedTextureMatrix}i.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag,function(e){return e.hasTexture(t)});return this._cachedTextureMatrix};i.prototype.getReflectionTextureMatrix=function(){var t=this;var r=this.getScene();if(!r){return this._cachedTextureMatrix}if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.coordinatesMode===this._cachedCoordinatesMode){if(this.coordinatesMode===i.PROJECTION_MODE){if(this._cachedProjectionMatrixId===r.getProjectionMatrix().updateFlag){return this._cachedTextureMatrix}}else{return this._cachedTextureMatrix}}if(!this._cachedTextureMatrix){this._cachedTextureMatrix=e.Matrix.Zero()}if(!this._projectionModeMatrix){this._projectionModeMatrix=e.Matrix.Zero()}this._cachedUOffset=this.uOffset;this._cachedVOffset=this.vOffset;this._cachedUScale=this.uScale;this._cachedVScale=this.vScale;this._cachedCoordinatesMode=this.coordinatesMode;switch(this.coordinatesMode){case i.PLANAR_MODE:e.Matrix.IdentityToRef(this._cachedTextureMatrix);this._cachedTextureMatrix[0]=this.uScale;this._cachedTextureMatrix[5]=this.vScale;this._cachedTextureMatrix[12]=this.uOffset;this._cachedTextureMatrix[13]=this.vOffset;break;case i.PROJECTION_MODE:e.Matrix.IdentityToRef(this._projectionModeMatrix);this._projectionModeMatrix.m[0]=.5;this._projectionModeMatrix.m[5]=-.5;this._projectionModeMatrix.m[10]=0;this._projectionModeMatrix.m[12]=.5;this._projectionModeMatrix.m[13]=.5;this._projectionModeMatrix.m[14]=1;this._projectionModeMatrix.m[15]=1;var n=r.getProjectionMatrix();this._cachedProjectionMatrixId=n.updateFlag;n.multiplyToRef(this._projectionModeMatrix,this._cachedTextureMatrix);break;default:e.Matrix.IdentityToRef(this._cachedTextureMatrix);break}r.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag,function(e){return e.getActiveTextures().indexOf(t)!==-1});return this._cachedTextureMatrix};i.prototype.clone=function(){var t=this;return e.SerializationHelper.Clone(function(){return new i(t._texture?t._texture.url:null,t.getScene(),t._noMipmap,t._invertY,t._samplingMode)},this)};Object.defineProperty(i.prototype,"onLoadObservable",{get:function(){if(!this._onLoadObservable){this._onLoadObservable=new e.Observable}return this._onLoadObservable},enumerable:true,configurable:true});i.prototype.serialize=function(){var e=t.prototype.serialize.call(this);if(typeof this._buffer==="string"&&this._buffer.substr(0,5)==="data:"){e.base64String=this._buffer;e.name=e.name.replace("data:","")}return e};i.prototype.getClassName=function(){return"Texture"};i.prototype.dispose=function(){t.prototype.dispose.call(this);if(this.onLoadObservable){this.onLoadObservable.clear();this._onLoadObservable=null}this._delayedOnLoad=null;this._delayedOnError=null};i.CreateFromBase64String=function(t,r,n,o,s,a,u,l,c){if(a===void 0){a=i.TRILINEAR_SAMPLINGMODE}if(u===void 0){u=null}if(l===void 0){l=null}if(c===void 0){c=e.Engine.TEXTUREFORMAT_RGBA}return new i("data:"+r,n,o,s,a,u,l,t,false,c)};i.Parse=function(t,r,n){if(t.customType){var o=e.Tools.Instantiate(t.customType);var s=o.Parse(t,r,n);if(t.samplingMode&&s.updateSamplingMode&&s._samplingMode){if(s._samplingMode!==t.samplingMode){s.updateSamplingMode(t.samplingMode)}}return s}if(t.isCube){return e.CubeTexture.Parse(t,r,n)}if(!t.name&&!t.isRenderTarget){return null}var a=e.SerializationHelper.Parse(function(){var o=true;if(t.noMipmap){o=false}if(t.mirrorPlane){var s=new e.MirrorTexture(t.name,t.renderTargetSize,r,o);s._waitingRenderList=t.renderList;s.mirrorPlane=e.Plane.FromArray(t.mirrorPlane);return s}else if(t.isRenderTarget){var a=new e.RenderTargetTexture(t.name,t.renderTargetSize,r,o);a._waitingRenderList=t.renderList;return a}else{var u;if(t.base64String){u=i.CreateFromBase64String(t.base64String,t.name,r,!o)}else{var l=n+t.name;if(i.UseSerializedUrlIfAny&&t.url){l=t.url}u=new i(l,r,!o)}return u}},t,r);if(t.samplingMode){var u=t.samplingMode;if(a._samplingMode!==u){a.updateSamplingMode(u)}}if(t.animations){for(var l=0;l<t.animations.length;l++){var c=t.animations[l];a.animations.push(e.Animation.Parse(c))}}return a};i.LoadFromDataString=function(t,r,n,o,s,a,u,l,c,h){if(o===void 0){o=false}if(s===void 0){s=false}if(a===void 0){a=true}if(u===void 0){u=i.TRILINEAR_SAMPLINGMODE}if(l===void 0){l=null}if(c===void 0){c=null}if(h===void 0){h=e.Engine.TEXTUREFORMAT_RGBA}if(t.substr(0,5)!=="data:"){t="data:"+t}return new i(t,n,s,a,u,l,c,r,o,h)};i.NEAREST_SAMPLINGMODE=1;i.NEAREST_NEAREST_MIPLINEAR=1;i.BILINEAR_SAMPLINGMODE=2;i.LINEAR_LINEAR_MIPNEAREST=2;i.TRILINEAR_SAMPLINGMODE=3;i.LINEAR_LINEAR_MIPLINEAR=3;i.NEAREST_NEAREST_MIPNEAREST=4;i.NEAREST_LINEAR_MIPNEAREST=5;i.NEAREST_LINEAR_MIPLINEAR=6;i.NEAREST_LINEAR=7;i.NEAREST_NEAREST=8;i.LINEAR_NEAREST_MIPNEAREST=9;i.LINEAR_NEAREST_MIPLINEAR=10;i.LINEAR_LINEAR=11;i.LINEAR_NEAREST=12;i.EXPLICIT_MODE=0;i.SPHERICAL_MODE=1;i.PLANAR_MODE=2;i.CUBIC_MODE=3;i.PROJECTION_MODE=4;i.SKYBOX_MODE=5;i.INVCUBIC_MODE=6;i.EQUIRECTANGULAR_MODE=7;i.FIXED_EQUIRECTANGULAR_MODE=8;i.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;i.CLAMP_ADDRESSMODE=0;i.WRAP_ADDRESSMODE=1;i.MIRROR_ADDRESSMODE=2;i.UseSerializedUrlIfAny=false;__decorate([e.serialize()],i.prototype,"url",void 0);__decorate([e.serialize()],i.prototype,"uOffset",void 0);__decorate([e.serialize()],i.prototype,"vOffset",void 0);__decorate([e.serialize()],i.prototype,"uScale",void 0);__decorate([e.serialize()],i.prototype,"vScale",void 0);__decorate([e.serialize()],i.prototype,"uAng",void 0);__decorate([e.serialize()],i.prototype,"vAng",void 0);__decorate([e.serialize()],i.prototype,"wAng",void 0);__decorate([e.serialize()],i.prototype,"isBlocking",null);return i}(e.BaseTexture);e.Texture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this.mustReturn=false;this.visibleInstances=new Array;this.renderSelf=new Array}return e}();e._InstancesBatch=t;var i=function(i){__extends(r,i);function r(n,o,s,a,u,l){if(o===void 0){o=null}if(s===void 0){s=null}if(a===void 0){a=null}if(l===void 0){l=true}var c=i.call(this,n,o)||this;c.onBeforeRenderObservable=new e.Observable;c.onAfterRenderObservable=new e.Observable;c.onBeforeDrawObservable=new e.Observable;c.delayLoadState=e.Engine.DELAYLOADSTATE_NONE;c.instances=new Array;c._LODLevels=new Array;c._visibleInstances={};c._renderIdForInstances=new Array;c._batchCache=new t;c._instancesBufferSize=32*16*4;c._originalBuilderSideOrientation=r._DEFAULTSIDE;c.overrideMaterialSideOrientation=null;c._areNormalsFrozen=false;c._source=null;o=c.getScene();if(a){c._source=a;if(a._geometry){a._geometry.applyToMesh(c)}e.Tools.DeepCopy(a,c,["name","material","skeleton","instances","parent","uniqueId","source","metadata","hasLODLevels","geometry","isBlocked","areNormalsFrozen"],["_poseMatrix","_source"]);if(a.metadata&&a.metadata.clone){c.metadata=a.metadata.clone()}else{c.metadata=a.metadata}if(e.Tags&&e.Tags.HasTags(a)){e.Tags.AddTagsTo(c,e.Tags.GetTags(a,true))}c.parent=a.parent;c.setPivotMatrix(a.getPivotMatrix());c.id=n+"."+a.id;c.material=a.material;var h;if(!u){var f=a.getDescendants(true);for(var d=0;d<f.length;d++){var p=f[d];if(p.clone){p.clone(n+"."+p.name,c)}}}var _=c.getScene().getPhysicsEngine();if(l&&_){var m=_.getImpostorForPhysicsObject(a);if(m){c.physicsImpostor=m.clone(c)}}for(h=0;h<o.particleSystems.length;h++){var g=o.particleSystems[h];if(g.emitter===a){g.clone(g.name,c)}}c.computeWorldMatrix(true)}if(s!==null){c.parent=s}return c}Object.defineProperty(r,"FRONTSIDE",{get:function(){return r._FRONTSIDE},enumerable:true,configurable:true});Object.defineProperty(r,"BACKSIDE",{get:function(){return r._BACKSIDE},enumerable:true,configurable:true});Object.defineProperty(r,"DOUBLESIDE",{get:function(){return r._DOUBLESIDE},enumerable:true,configurable:true});Object.defineProperty(r,"DEFAULTSIDE",{get:function(){return r._DEFAULTSIDE},enumerable:true,configurable:true});Object.defineProperty(r,"NO_CAP",{get:function(){return r._NO_CAP},enumerable:true,configurable:true});Object.defineProperty(r,"CAP_START",{get:function(){return r._CAP_START},enumerable:true,configurable:true});Object.defineProperty(r,"CAP_END",{get:function(){return r._CAP_END},enumerable:true,configurable:true});Object.defineProperty(r,"CAP_ALL",{get:function(){return r._CAP_ALL},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"onBeforeDraw",{set:function(e){if(this._onBeforeDrawObserver){this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver)}this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"morphTargetManager",{get:function(){return this._morphTargetManager},set:function(e){if(this._morphTargetManager===e){return}this._morphTargetManager=e;this._syncGeometryWithMorphTargetManager()},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"source",{get:function(){return this._source},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"isUnIndexed",{get:function(){return this._unIndexed},set:function(e){if(this._unIndexed!==e){this._unIndexed=e;this._markSubMeshesAsAttributesDirty()}},enumerable:true,configurable:true});r.prototype.getClassName=function(){return"Mesh"};r.prototype.toString=function(t){var r=i.prototype.toString.call(this,t);r+=", n vertices: "+this.getTotalVertices();r+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE");if(this.animations){for(var n=0;n<this.animations.length;n++){r+=", animation[0]: "+this.animations[n].toString(t)}}if(t){if(this._geometry){var o=this.getIndices();var s=this.getVerticesData(e.VertexBuffer.PositionKind);if(s&&o){r+=", flat shading: "+(s.length/3===o.length?"YES":"NO")}}else{r+=", flat shading: UNKNOWN"}}return r};Object.defineProperty(r.prototype,"hasLODLevels",{get:function(){return this._LODLevels.length>0},enumerable:true,configurable:true});r.prototype.getLODLevels=function(){return this._LODLevels};r.prototype._sortLODLevels=function(){this._LODLevels.sort(function(e,t){if(e.distance<t.distance){return 1}if(e.distance>t.distance){return-1}return 0})};r.prototype.addLODLevel=function(t,i){if(i&&i._masterMesh){e.Tools.Warn("You cannot use a mesh as LOD level twice");return this}var r=new e.MeshLODLevel(t,i);this._LODLevels.push(r);if(i){i._masterMesh=this}this._sortLODLevels();return this};r.prototype.getLODLevelAtDistance=function(e){for(var t=0;t<this._LODLevels.length;t++){var i=this._LODLevels[t];if(i.distance===e){return i.mesh}}return null};r.prototype.removeLODLevel=function(e){for(var t=0;t<this._LODLevels.length;t++){if(this._LODLevels[t].mesh===e){this._LODLevels.splice(t,1);if(e){e._masterMesh=null}}}this._sortLODLevels();return this};r.prototype.getLOD=function(e,t){if(!this._LODLevels||this._LODLevels.length===0){return this}var i;if(t){i=t}else{var r=this.getBoundingInfo();i=r.boundingSphere}var n=i.centerWorld.subtract(e.globalPosition).length();if(this._LODLevels[this._LODLevels.length-1].distance>n){if(this.onLODLevelSelection){this.onLODLevelSelection(n,this,this._LODLevels[this._LODLevels.length-1].mesh)}return this}for(var o=0;o<this._LODLevels.length;o++){var s=this._LODLevels[o];if(s.distance<n){if(s.mesh){s.mesh._preActivate();s.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}if(this.onLODLevelSelection){this.onLODLevelSelection(n,this,s.mesh)}return s.mesh}}if(this.onLODLevelSelection){this.onLODLevelSelection(n,this,this)}return this};Object.defineProperty(r.prototype,"geometry",{get:function(){return this._geometry},enumerable:true,configurable:true});r.prototype.getTotalVertices=function(){if(this._geometry===null||this._geometry===undefined){return 0}return this._geometry.getTotalVertices()};r.prototype.getVerticesData=function(e,t,i){if(!this._geometry){return null}return this._geometry.getVerticesData(e,t,i)};r.prototype.getVertexBuffer=function(e){if(!this._geometry){return null}return this._geometry.getVertexBuffer(e)};r.prototype.isVerticesDataPresent=function(e){if(!this._geometry){if(this._delayInfo){return this._delayInfo.indexOf(e)!==-1}return false}return this._geometry.isVerticesDataPresent(e)};r.prototype.isVertexBufferUpdatable=function(e){if(!this._geometry){if(this._delayInfo){return this._delayInfo.indexOf(e)!==-1}return false}return this._geometry.isVertexBufferUpdatable(e)};r.prototype.getVerticesDataKinds=function(){if(!this._geometry){var e=new Array;if(this._delayInfo){this._delayInfo.forEach(function(t,i,r){e.push(t)})}return e}return this._geometry.getVerticesDataKinds()};r.prototype.getTotalIndices=function(){if(!this._geometry){return 0}return this._geometry.getTotalIndices()};r.prototype.getIndices=function(e){if(!this._geometry){return[]}return this._geometry.getIndices(e)};Object.defineProperty(r.prototype,"isBlocked",{get:function(){return this._masterMesh!==null&&this._masterMesh!==undefined},enumerable:true,configurable:true});r.prototype.isReady=function(t,r){if(t===void 0){t=false}if(r===void 0){r=false}if(this.delayLoadState===e.Engine.DELAYLOADSTATE_LOADING){return false}if(!i.prototype.isReady.call(this,t)){return false}if(!this.subMeshes||this.subMeshes.length===0){return true}if(!t){return true}var n=this.getEngine();var o=this.getScene();var s=r||n.getCaps().instancedArrays&&this.instances.length>0;this.computeWorldMatrix();var a=this.material||o.defaultMaterial;if(a){if(a.storeEffectOnSubMeshes){for(var u=0,l=this.subMeshes;u<l.length;u++){var c=l[u];var h=c.getMaterial();if(h){if(!h.isReadyForSubMesh(this,c,s)){return false}}}}else{if(!a.isReady(this,s)){return false}}}for(var f=0,d=this._lightSources;f<d.length;f++){var p=d[f];var _=p.getShadowGenerator();if(_){for(var m=0,g=this.subMeshes;m<g.length;m++){var c=g[m];if(!_.isReady(c,s)){return false}}}}for(var v=0,y=this._LODLevels;v<y.length;v++){var b=y[v];if(b.mesh&&!b.mesh.isReady(s)){return false}}return true};Object.defineProperty(r.prototype,"areNormalsFrozen",{get:function(){return this._areNormalsFrozen},enumerable:true,configurable:true});r.prototype.freezeNormals=function(){this._areNormalsFrozen=true;return this};r.prototype.unfreezeNormals=function(){this._areNormalsFrozen=false;return this};Object.defineProperty(r.prototype,"overridenInstanceCount",{set:function(e){this._overridenInstanceCount=e},enumerable:true,configurable:true});r.prototype._preActivate=function(){var e=this.getScene().getRenderId();if(this._preActivateId===e){return this}this._preActivateId=e;this._visibleInstances=null;return this};r.prototype._preActivateForIntermediateRendering=function(e){if(this._visibleInstances){this._visibleInstances.intermediateDefaultRenderId=e}return this};r.prototype._registerInstanceForRenderId=function(e,t){if(!this._visibleInstances){this._visibleInstances={};this._visibleInstances.defaultRenderId=t;this._visibleInstances.selfDefaultRenderId=this._renderId}if(!this._visibleInstances[t]){this._visibleInstances[t]=new Array}this._visibleInstances[t].push(e);return this};r.prototype.refreshBoundingInfo=function(){return this._refreshBoundingInfo(false)};r.prototype._refreshBoundingInfo=function(t){if(this._boundingInfo&&this._boundingInfo.isLocked){return this}var i=this._getPositionData(t);if(i){var r=e.Tools.ExtractMinAndMax(i,0,this.getTotalVertices());this._boundingInfo=new e.BoundingInfo(r.minimum,r.maximum)}if(this.subMeshes){for(var n=0;n<this.subMeshes.length;n++){this.subMeshes[n].refreshBoundingInfo()}}this._updateBoundingInfo();return this};r.prototype._getPositionData=function(t){var i=this.getVerticesData(e.VertexBuffer.PositionKind);if(i&&t&&this.skeleton){i=e.Tools.Slice(i);var r=this.getVerticesData(e.VertexBuffer.MatricesIndicesKind);var n=this.getVerticesData(e.VertexBuffer.MatricesWeightsKind);if(n&&r){var o=this.numBoneInfluencers>4;var s=o?this.getVerticesData(e.VertexBuffer.MatricesIndicesExtraKind):null;var a=o?this.getVerticesData(e.VertexBuffer.MatricesWeightsExtraKind):null;var u=this.skeleton.getTransformMatrices(this);var l=e.Tmp.Vector3[0];var c=e.Tmp.Matrix[0];var h=e.Tmp.Matrix[1];var f=0;for(var d=0;d<i.length;d+=3,f+=4){c.reset();var p;var _;for(p=0;p<4;p++){_=n[f+p];if(_<=0)break;e.Matrix.FromFloat32ArrayToRefScaled(u,Math.floor(r[f+p]*16),_,h);c.addToSelf(h)}if(o){for(p=0;p<4;p++){_=a[f+p];if(_<=0)break;e.Matrix.FromFloat32ArrayToRefScaled(u,Math.floor(s[f+p]*16),_,h);c.addToSelf(h)}}e.Vector3.TransformCoordinatesFromFloatsToRef(i[d],i[d+1],i[d+2],c,l);l.toArray(i,d)}}}return i};r.prototype._createGlobalSubMesh=function(t){var i=this.getTotalVertices();if(!i||!this.getIndices()){return null}if(this.subMeshes&&this.subMeshes.length>0){var r=this.getIndices();if(!r){return null}var n=r.length;var o=false;if(t){o=true}else{for(var s=0,a=this.subMeshes;s<a.length;s++){var u=a[s];if(u.indexStart+u.indexCount>=n){o=true;break}if(u.verticesStart+u.verticesCount>=i){o=true;break}}}if(!o){return this.subMeshes[0]}}this.releaseSubMeshes();return new e.SubMesh(0,0,i,0,this.getTotalIndices(),this)};r.prototype.subdivide=function(t){if(t<1){return}var i=this.getTotalIndices();var r=i/t|0;var n=0;while(r%3!==0){r++}this.releaseSubMeshes();for(var o=0;o<t;o++){if(n>=i){break}e.SubMesh.CreateFromIndices(0,n,Math.min(r,i-n),this);n+=r}this.synchronizeInstances()};r.prototype.setVerticesData=function(t,i,r,n){if(r===void 0){r=false}if(!this._geometry){var o=new e.VertexData;o.set(i,t);var s=this.getScene();new e.Geometry(e.Geometry.RandomId(),s,o,r,this)}else{this._geometry.setVerticesData(t,i,r,n)}return this};r.prototype.markVerticesDataAsUpdatable=function(e,t){if(t===void 0){t=true}var i=this.getVertexBuffer(e);if(!i||i.isUpdatable()===t){return}this.setVerticesData(e,this.getVerticesData(e),t)};r.prototype.setVerticesBuffer=function(t){if(!this._geometry){this._geometry=e.Geometry.CreateGeometryForMesh(this)}this._geometry.setVerticesBuffer(t);return this};r.prototype.updateVerticesData=function(e,t,i,r){if(!this._geometry){return this}if(!r){this._geometry.updateVerticesData(e,t,i)}else{this.makeGeometryUnique();this.updateVerticesData(e,t,i,false)}return this};r.prototype.updateMeshPositions=function(t,i){if(i===void 0){i=true}var r=this.getVerticesData(e.VertexBuffer.PositionKind);if(!r){return this}t(r);this.updateVerticesData(e.VertexBuffer.PositionKind,r,false,false);if(i){var n=this.getIndices();var o=this.getVerticesData(e.VertexBuffer.NormalKind);if(!o){return this}e.VertexData.ComputeNormals(r,n,o);this.updateVerticesData(e.VertexBuffer.NormalKind,o,false,false)}return this};r.prototype.makeGeometryUnique=function(){if(!this._geometry){return this}var t=this._geometry;var i=this._geometry.copy(e.Geometry.RandomId());t.releaseForMesh(this,true);i.applyToMesh(this);return this};r.prototype.setIndices=function(t,i,r){if(i===void 0){i=null}if(r===void 0){r=false}if(!this._geometry){var n=new e.VertexData;n.indices=t;var o=this.getScene();new e.Geometry(e.Geometry.RandomId(),o,n,r,this)}else{this._geometry.setIndices(t,i,r)}return this};r.prototype.updateIndices=function(e,t){if(!this._geometry){return this}this._geometry.updateIndices(e,t);return this};r.prototype.toLeftHanded=function(){if(!this._geometry){return this}this._geometry.toLeftHanded();return this};r.prototype._bind=function(t,i,r){if(!this._geometry){return this}var n=this.getScene().getEngine();var o;if(this._unIndexed){o=null}else{switch(r){case e.Material.PointFillMode:o=null;break;case e.Material.WireFrameFillMode:o=t.getLinesIndexBuffer(this.getIndices(),n);break;default:case e.Material.TriangleFillMode:o=this._unIndexed?null:this._geometry.getIndexBuffer();break}}this._geometry._bind(i,o);return this};r.prototype._draw=function(t,i,r,n){if(n===void 0){n=false}if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer()){return this}this.onBeforeDrawObservable.notifyObservers(this);var o=this.getScene();var s=o.getEngine();if(this._unIndexed||i==e.Material.PointFillMode){s.drawArraysType(i,t.verticesStart,t.verticesCount,r)}else if(i==e.Material.WireFrameFillMode){s.drawElementsType(i,0,t.linesIndexCount,r)}else{s.drawElementsType(i,t.indexStart,t.indexCount,r)}if(o._isAlternateRenderingEnabled&&!n){var a=t.effect||this._effectiveMaterial.getEffect();if(!a||!o.activeCamera){return this}o._switchToAlternateCameraConfiguration(true);this._effectiveMaterial.bindView(a);this._effectiveMaterial.bindViewProjection(a);s.setViewport(o.activeCamera._alternateCamera.viewport);this._draw(t,i,r,true);s.setViewport(o.activeCamera.viewport);o._switchToAlternateCameraConfiguration(false);this._effectiveMaterial.bindView(a);this._effectiveMaterial.bindViewProjection(a)}return this};r.prototype.registerBeforeRender=function(e){this.onBeforeRenderObservable.add(e);return this};r.prototype.unregisterBeforeRender=function(e){this.onBeforeRenderObservable.removeCallback(e);return this};r.prototype.registerAfterRender=function(e){this.onAfterRenderObservable.add(e);return this};r.prototype.unregisterAfterRender=function(e){this.onAfterRenderObservable.removeCallback(e);return this};r.prototype._getInstancesRenderList=function(e){var t=this.getScene();this._batchCache.mustReturn=false;this._batchCache.renderSelf[e]=this.isEnabled()&&this.isVisible;this._batchCache.visibleInstances[e]=null;if(this._visibleInstances){var i=t.getRenderId();var r=t._isInIntermediateRendering()?this._visibleInstances.intermediateDefaultRenderId:this._visibleInstances.defaultRenderId;this._batchCache.visibleInstances[e]=this._visibleInstances[i];var n=this._renderId;if(!this._batchCache.visibleInstances[e]&&r){this._batchCache.visibleInstances[e]=this._visibleInstances[r];i=Math.max(r,i);n=Math.max(this._visibleInstances.selfDefaultRenderId,i)}var o=this._batchCache.visibleInstances[e];if(o&&o.length){if(this._renderIdForInstances[e]===i){this._batchCache.mustReturn=true;return this._batchCache}if(i!==n){this._batchCache.renderSelf[e]=false}}this._renderIdForInstances[e]=i}return this._batchCache};r.prototype._renderWithInstances=function(t,i,r,n,o){var s=r.visibleInstances[t._id];if(!s){return this}var a=s.length+1;var u=a*16*4;var l=this._instancesBufferSize;var c=this._instancesBuffer;while(this._instancesBufferSize<u){this._instancesBufferSize*=2}if(!this._instancesData||l!=this._instancesBufferSize){this._instancesData=new Float32Array(this._instancesBufferSize/4)}var h=0;var f=0;var d=this.getWorldMatrix();if(r.renderSelf[t._id]){d.copyToArray(this._instancesData,h);h+=16;f++}if(s){for(var p=0;p<s.length;p++){var _=s[p];_.getWorldMatrix().copyToArray(this._instancesData,h);h+=16;f++}}if(!c||l!=this._instancesBufferSize){if(c){c.dispose()}c=new e.Buffer(o,this._instancesData,true,16,false,true);this._instancesBuffer=c;this.setVerticesBuffer(c.createVertexBuffer("world0",0,4));this.setVerticesBuffer(c.createVertexBuffer("world1",4,4));this.setVerticesBuffer(c.createVertexBuffer("world2",8,4));this.setVerticesBuffer(c.createVertexBuffer("world3",12,4))}else{c.updateDirectly(this._instancesData,0,f)}this._bind(t,n,i);this._draw(t,i,f);o.unbindInstanceAttributes();return this};r.prototype._processRendering=function(e,t,i,r,n,o,s){var a=this.getScene();var u=a.getEngine();if(n){this._renderWithInstances(e,i,r,t,u)}else{if(r.renderSelf[e._id]){if(o){o(false,this.getWorldMatrix(),s)}this._draw(e,i,this._overridenInstanceCount)}var l=r.visibleInstances[e._id];if(l){for(var c=0;c<l.length;c++){var h=l[c];var f=h.getWorldMatrix();if(o){o(true,f,s)}this._draw(e,i)}}}return this};r.prototype.render=function(t,i){this.checkOcclusionQuery();if(this._isOccluded){return this}var r=this.getScene();var n=this._getInstancesRenderList(t._id);if(n.mustReturn){return this}if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer()){return this}this.onBeforeRenderObservable.notifyObservers(this);var o=r.getEngine();var s=o.getCaps().instancedArrays&&n.visibleInstances[t._id]!==null&&n.visibleInstances[t._id]!==undefined;var a=t.getMaterial();if(!a){return this}this._effectiveMaterial=a;if(this._effectiveMaterial.storeEffectOnSubMeshes){if(!this._effectiveMaterial.isReadyForSubMesh(this,t,s)){return this}}else if(!this._effectiveMaterial.isReady(this,s)){return this}if(i){o.setAlphaMode(this._effectiveMaterial.alphaMode)}var u=o.getDepthWrite();if(this.renderOutline){o.setDepthWrite(false);r.getOutlineRenderer().render(t,n);o.setDepthWrite(u)}var l;if(this._effectiveMaterial.storeEffectOnSubMeshes){l=t.effect}else{l=this._effectiveMaterial.getEffect()}if(!l){return this}var c=this.overrideMaterialSideOrientation;if(c==null){c=this._effectiveMaterial.sideOrientation;if(this._getWorldMatrixDeterminant()<0){c=c===e.Material.ClockWiseSideOrientation?e.Material.CounterClockWiseSideOrientation:e.Material.ClockWiseSideOrientation}}var h=this._effectiveMaterial._preBind(l,c);if(this._effectiveMaterial.forceDepthWrite){o.setDepthWrite(true)}var f=r.forcePointsCloud?e.Material.PointFillMode:r.forceWireframe?e.Material.WireFrameFillMode:this._effectiveMaterial.fillMode;if(!s){this._bind(t,l,f)}var d=this.getWorldMatrix();if(this._effectiveMaterial.storeEffectOnSubMeshes){this._effectiveMaterial.bindForSubMesh(d,this,t)}else{this._effectiveMaterial.bind(d,this)}if(!this._effectiveMaterial.backFaceCulling&&this._effectiveMaterial.separateCullingPass){o.setState(true,this._effectiveMaterial.zOffset,false,!h);this._processRendering(t,l,f,n,s,this._onBeforeDraw,this._effectiveMaterial);o.setState(true,this._effectiveMaterial.zOffset,false,h)}this._processRendering(t,l,f,n,s,this._onBeforeDraw,this._effectiveMaterial);this._effectiveMaterial.unbind();if(this.renderOutline&&u){o.setDepthWrite(true);o.setColorWrite(false);r.getOutlineRenderer().render(t,n);o.setColorWrite(true)}if(this.renderOverlay){var p=o.getAlphaMode();o.setAlphaMode(e.Engine.ALPHA_COMBINE);r.getOutlineRenderer().render(t,n,true);o.setAlphaMode(p)}this.onAfterRenderObservable.notifyObservers(this);return this};r.prototype._onBeforeDraw=function(e,t,i){if(e&&i){i.bindOnlyWorldMatrix(t)}};r.prototype.getEmittedParticleSystems=function(){var e=new Array;for(var t=0;t<this.getScene().particleSystems.length;t++){var i=this.getScene().particleSystems[t];if(i.emitter===this){e.push(i)}}return e};r.prototype.getHierarchyEmittedParticleSystems=function(){var e=new Array;var t=this.getDescendants();t.push(this);for(var i=0;i<this.getScene().particleSystems.length;i++){var r=this.getScene().particleSystems[i];var n=r.emitter;if(n.position&&t.indexOf(n)!==-1){e.push(r)}}return e};r.prototype._checkDelayState=function(){var t=this.getScene();if(this._geometry){this._geometry.load(t)}else if(this.delayLoadState===e.Engine.DELAYLOADSTATE_NOTLOADED){this.delayLoadState=e.Engine.DELAYLOADSTATE_LOADING;this._queueLoad(t)}return this};r.prototype._queueLoad=function(t){var i=this;t._addPendingData(this);var r=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;e.Tools.LoadFile(this.delayLoadingFile,function(r){if(r instanceof ArrayBuffer){i._delayLoadingFunction(r,i)}else{i._delayLoadingFunction(JSON.parse(r),i)}i.instances.forEach(function(e){e._syncSubMeshes()})
;i.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED;t._removePendingData(i)},function(){},t.database,r);return this};r.prototype.isInFrustum=function(t){if(this.delayLoadState===e.Engine.DELAYLOADSTATE_LOADING){return false}if(!i.prototype.isInFrustum.call(this,t)){return false}this._checkDelayState();return true};r.prototype.setMaterialByID=function(e){var t=this.getScene().materials;var i;for(i=t.length-1;i>-1;i--){if(t[i].id===e){this.material=t[i];return this}}var r=this.getScene().multiMaterials;for(i=r.length-1;i>-1;i--){if(r[i].id===e){this.material=r[i];return this}}return this};r.prototype.getAnimatables=function(){var e=new Array;if(this.material){e.push(this.material)}if(this.skeleton){e.push(this.skeleton)}return e};r.prototype.bakeTransformIntoVertices=function(t){if(!this.isVerticesDataPresent(e.VertexBuffer.PositionKind)){return this}var i=this.subMeshes.splice(0);this._resetPointsArrayCache();var r=this.getVerticesData(e.VertexBuffer.PositionKind);var n=new Array;var o;for(o=0;o<r.length;o+=3){e.Vector3.TransformCoordinates(e.Vector3.FromArray(r,o),t).toArray(n,o)}this.setVerticesData(e.VertexBuffer.PositionKind,n,this.getVertexBuffer(e.VertexBuffer.PositionKind).isUpdatable());if(!this.isVerticesDataPresent(e.VertexBuffer.NormalKind)){return this}r=this.getVerticesData(e.VertexBuffer.NormalKind);n=[];for(o=0;o<r.length;o+=3){e.Vector3.TransformNormal(e.Vector3.FromArray(r,o),t).normalize().toArray(n,o)}this.setVerticesData(e.VertexBuffer.NormalKind,n,this.getVertexBuffer(e.VertexBuffer.NormalKind).isUpdatable());if(t.m[0]*t.m[5]*t.m[10]<0){this.flipFaces()}this.releaseSubMeshes();this.subMeshes=i;return this};r.prototype.bakeCurrentTransformIntoVertices=function(){this.bakeTransformIntoVertices(this.computeWorldMatrix(true));this.scaling.copyFromFloats(1,1,1);this.position.copyFromFloats(0,0,0);this.rotation.copyFromFloats(0,0,0);if(this.rotationQuaternion){this.rotationQuaternion=e.Quaternion.Identity()}this._worldMatrix=e.Matrix.Identity();return this};Object.defineProperty(r.prototype,"_positions",{get:function(){if(this._geometry){return this._geometry._positions}return null},enumerable:true,configurable:true});r.prototype._resetPointsArrayCache=function(){if(this._geometry){this._geometry._resetPointsArrayCache()}return this};r.prototype._generatePointsArray=function(){if(this._geometry){return this._geometry._generatePointsArray()}return false};r.prototype.clone=function(e,t,i,n){if(n===void 0){n=true}return new r(e,this.getScene(),t,this,i,n)};r.prototype.dispose=function(e,t){var r=this;if(t===void 0){t=false}this.morphTargetManager=null;if(this._geometry){this._geometry.releaseForMesh(this,true)}var n=this.getScene().meshes;n.forEach(function(e){var t=e;if(t._source&&t._source===r){t._source=null}});this._source=null;if(this._instancesBuffer){this._instancesBuffer.dispose();this._instancesBuffer=null}while(this.instances.length){this.instances[0].dispose()}var o=this.getScene().effectLayers;for(var s=0;s<o.length;s++){var a=o[s];if(a){a._disposeMesh(this)}}i.prototype.dispose.call(this,e,t)};r.prototype.applyDisplacementMap=function(t,i,r,n,o,s){var a=this;var u=this.getScene();var l=function(e){var t=document.createElement("canvas");var u=t.getContext("2d");var l=e.width;var c=e.height;t.width=l;t.height=c;u.drawImage(e,0,0);var h=u.getImageData(0,0,l,c).data;a.applyDisplacementMapFromBuffer(h,l,c,i,r,o,s);if(n){n(a)}};e.Tools.LoadImage(t,l,function(){},u.database);return this};r.prototype.applyDisplacementMapFromBuffer=function(t,i,r,n,o,s,a){if(!this.isVerticesDataPresent(e.VertexBuffer.PositionKind)||!this.isVerticesDataPresent(e.VertexBuffer.NormalKind)||!this.isVerticesDataPresent(e.VertexBuffer.UVKind)){e.Tools.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing");return this}var u=this.getVerticesData(e.VertexBuffer.PositionKind);var l=this.getVerticesData(e.VertexBuffer.NormalKind);var c=this.getVerticesData(e.VertexBuffer.UVKind);var h=e.Vector3.Zero();var f=e.Vector3.Zero();var d=e.Vector2.Zero();s=s||e.Vector2.Zero();a=a||new e.Vector2(1,1);for(var p=0;p<u.length;p+=3){e.Vector3.FromArrayToRef(u,p,h);e.Vector3.FromArrayToRef(l,p,f);e.Vector2.FromArrayToRef(c,p/3*2,d);var _=Math.abs(d.x*a.x+s.x)*i%i|0;var m=Math.abs(d.y*a.y+s.y)*r%r|0;var g=(_+m*i)*4;var v=t[g]/255;var y=t[g+1]/255;var b=t[g+2]/255;var x=v*.3+y*.59+b*.11;f.normalize();f.scaleInPlace(n+(o-n)*x);h=h.add(f);h.toArray(u,p)}e.VertexData.ComputeNormals(u,this.getIndices(),l);this.updateVerticesData(e.VertexBuffer.PositionKind,u);this.updateVerticesData(e.VertexBuffer.NormalKind,l);return this};r.prototype.convertToFlatShadedMesh=function(){var t=this.getVerticesDataKinds();var i={};var r={};var n={};var o=false;var s;var a;for(s=0;s<t.length;s++){a=t[s];var u=this.getVertexBuffer(a);if(a===e.VertexBuffer.NormalKind){o=u.isUpdatable();t.splice(s,1);s--;continue}i[a]=u;r[a]=i[a].getData();n[a]=[]}var l=this.subMeshes.slice(0);var c=this.getIndices();var h=this.getTotalIndices();var f;for(f=0;f<h;f++){var d=c[f];for(s=0;s<t.length;s++){a=t[s];var p=i[a].getStrideSize();for(var _=0;_<p;_++){n[a].push(r[a][d*p+_])}}}var m=[];var g=n[e.VertexBuffer.PositionKind];for(f=0;f<h;f+=3){c[f]=f;c[f+1]=f+1;c[f+2]=f+2;var v=e.Vector3.FromArray(g,f*3);var y=e.Vector3.FromArray(g,(f+1)*3);var b=e.Vector3.FromArray(g,(f+2)*3);var x=v.subtract(y);var T=b.subtract(y);var E=e.Vector3.Normalize(e.Vector3.Cross(x,T));for(var P=0;P<3;P++){m.push(E.x);m.push(E.y);m.push(E.z)}}this.setIndices(c);this.setVerticesData(e.VertexBuffer.NormalKind,m,o);for(s=0;s<t.length;s++){a=t[s];this.setVerticesData(a,n[a],i[a].isUpdatable())}this.releaseSubMeshes();for(var A=0;A<l.length;A++){var M=l[A];e.SubMesh.AddToMesh(M.materialIndex,M.indexStart,M.indexCount,M.indexStart,M.indexCount,this)}this.synchronizeInstances();return this};r.prototype.convertToUnIndexedMesh=function(){var t=this.getVerticesDataKinds();var i={};var r={};var n={};var o;var s;for(o=0;o<t.length;o++){s=t[o];var a=this.getVertexBuffer(s);i[s]=a;r[s]=i[s].getData();n[s]=[]}var u=this.subMeshes.slice(0);var l=this.getIndices();var c=this.getTotalIndices();var h;for(h=0;h<c;h++){var f=l[h];for(o=0;o<t.length;o++){s=t[o];var d=i[s].getStrideSize();for(var p=0;p<d;p++){n[s].push(r[s][f*d+p])}}}for(h=0;h<c;h+=3){l[h]=h;l[h+1]=h+1;l[h+2]=h+2}this.setIndices(l);for(o=0;o<t.length;o++){s=t[o];this.setVerticesData(s,n[s],i[s].isUpdatable())}this.releaseSubMeshes();for(var _=0;_<u.length;_++){var m=u[_];e.SubMesh.AddToMesh(m.materialIndex,m.indexStart,m.indexCount,m.indexStart,m.indexCount,this)}this._unIndexed=true;this.synchronizeInstances();return this};r.prototype.flipFaces=function(t){if(t===void 0){t=false}var i=e.VertexData.ExtractFromMesh(this);var r;if(t&&this.isVerticesDataPresent(e.VertexBuffer.NormalKind)&&i.normals){for(r=0;r<i.normals.length;r++){i.normals[r]*=-1}}if(i.indices){var n;for(r=0;r<i.indices.length;r+=3){n=i.indices[r+1];i.indices[r+1]=i.indices[r+2];i.indices[r+2]=n}}i.applyToMesh(this);return this};r.prototype.createInstance=function(t){return new e.InstancedMesh(t,this)};r.prototype.synchronizeInstances=function(){for(var e=0;e<this.instances.length;e++){var t=this.instances[e];t._syncSubMeshes()}return this};r.prototype.simplify=function(t,i,r,n){if(i===void 0){i=true}if(r===void 0){r=e.SimplificationType.QUADRATIC}this.getScene().simplificationQueue.addTask({settings:t,parallelProcessing:i,mesh:this,simplificationType:r,successCallback:n});return this};r.prototype.optimizeIndices=function(t){var i=this;var r=this.getIndices();var n=this.getVerticesData(e.VertexBuffer.PositionKind);if(!n||!r){return this}var o=new Array;for(var s=0;s<n.length;s=s+3){o.push(e.Vector3.FromArray(n,s))}var a=new Array;e.AsyncLoop.SyncAsyncForLoop(o.length,40,function(e){var t=o.length-1-e;var i=o[t];for(var r=0;r<t;++r){var n=o[r];if(i.equals(n)){a[t]=r;break}}},function(){for(var e=0;e<r.length;++e){r[e]=a[r[e]]||r[e]}var n=i.subMeshes.slice(0);i.setIndices(r);i.subMeshes=n;if(t){t(i)}});return this};r.prototype.serialize=function(t){t.name=this.name;t.id=this.id;t.type=this.getClassName();if(e.Tags&&e.Tags.HasTags(this)){t.tags=e.Tags.GetTags(this)}t.position=this.position.asArray();if(this.rotationQuaternion){t.rotationQuaternion=this.rotationQuaternion.asArray()}else if(this.rotation){t.rotation=this.rotation.asArray()}t.scaling=this.scaling.asArray();t.localMatrix=this.getPivotMatrix().asArray();t.isEnabled=this.isEnabled(false);t.isVisible=this.isVisible;t.infiniteDistance=this.infiniteDistance;t.pickable=this.isPickable;t.receiveShadows=this.receiveShadows;t.billboardMode=this.billboardMode;t.visibility=this.visibility;t.checkCollisions=this.checkCollisions;t.isBlocker=this.isBlocker;if(this.parent){t.parentId=this.parent.id}t.isUnIndexed=this.isUnIndexed;var i=this._geometry;if(i){var r=i.id;t.geometryId=r;t.subMeshes=[];for(var n=0;n<this.subMeshes.length;n++){var o=this.subMeshes[n];t.subMeshes.push({materialIndex:o.materialIndex,verticesStart:o.verticesStart,verticesCount:o.verticesCount,indexStart:o.indexStart,indexCount:o.indexCount})}}if(this.material){t.materialId=this.material.id}else{this.material=null}if(this.morphTargetManager){t.morphTargetManagerId=this.morphTargetManager.uniqueId}if(this.skeleton){t.skeletonId=this.skeleton.id}var s=this.getPhysicsImpostor();if(s){t.physicsMass=s.getParam("mass");t.physicsFriction=s.getParam("friction");t.physicsRestitution=s.getParam("mass");t.physicsImpostor=s.type}if(this.metadata){t.metadata=this.metadata}t.instances=[];for(var a=0;a<this.instances.length;a++){var u=this.instances[a];var l={name:u.name,id:u.id,position:u.position.asArray(),scaling:u.scaling.asArray()};if(u.rotationQuaternion){l.rotationQuaternion=u.rotationQuaternion.asArray()}else if(u.rotation){l.rotation=u.rotation.asArray()}t.instances.push(l);e.Animation.AppendSerializedAnimations(u,l);l.ranges=u.serializeAnimationRanges()}e.Animation.AppendSerializedAnimations(this,t);t.ranges=this.serializeAnimationRanges();t.layerMask=this.layerMask;t.alphaIndex=this.alphaIndex;t.hasVertexAlpha=this.hasVertexAlpha;t.overlayAlpha=this.overlayAlpha;t.overlayColor=this.overlayColor.asArray();t.renderOverlay=this.renderOverlay;t.applyFog=this.applyFog;if(this.actionManager){t.actions=this.actionManager.serialize(this.name)}};r.prototype._syncGeometryWithMorphTargetManager=function(){if(!this.geometry){return}this._markSubMeshesAsAttributesDirty();var t=this._morphTargetManager;if(t&&t.vertexCount){if(t.vertexCount!==this.getTotalVertices()){e.Tools.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count.");this.morphTargetManager=null;return}for(var i=0;i<t.numInfluencers;i++){var r=t.getActiveTarget(i);var n=r.getPositions();if(!n){e.Tools.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(e.VertexBuffer.PositionKind+i,n,false,3);var o=r.getNormals();if(o){this.geometry.setVerticesData(e.VertexBuffer.NormalKind+i,o,false,3)}var s=r.getTangents();if(s){this.geometry.setVerticesData(e.VertexBuffer.TangentKind+i,s,false,3)}}}else{var i=0;while(this.geometry.isVerticesDataPresent(e.VertexBuffer.PositionKind+i)){this.geometry.removeVerticesData(e.VertexBuffer.PositionKind+i);if(this.geometry.isVerticesDataPresent(e.VertexBuffer.NormalKind+i)){this.geometry.removeVerticesData(e.VertexBuffer.NormalKind+i)}if(this.geometry.isVerticesDataPresent(e.VertexBuffer.TangentKind+i)){this.geometry.removeVerticesData(e.VertexBuffer.TangentKind+i)}i++}}};r.Parse=function(t,i,n){var o;if(t.type&&t.type==="GroundMesh"){o=e.GroundMesh.Parse(t,i)}else{o=new r(t.name,i)}o.id=t.id;if(e.Tags){e.Tags.AddTagsTo(o,t.tags)}o.position=e.Vector3.FromArray(t.position);if(t.metadata!==undefined){o.metadata=t.metadata}if(t.rotationQuaternion){o.rotationQuaternion=e.Quaternion.FromArray(t.rotationQuaternion)}else if(t.rotation){o.rotation=e.Vector3.FromArray(t.rotation)}o.scaling=e.Vector3.FromArray(t.scaling);if(t.localMatrix){o.setPreTransformMatrix(e.Matrix.FromArray(t.localMatrix))}else if(t.pivotMatrix){o.setPivotMatrix(e.Matrix.FromArray(t.pivotMatrix))}o.setEnabled(t.isEnabled);o.isVisible=t.isVisible;o.infiniteDistance=t.infiniteDistance;o.showBoundingBox=t.showBoundingBox;o.showSubMeshesBoundingBox=t.showSubMeshesBoundingBox;if(t.applyFog!==undefined){o.applyFog=t.applyFog}if(t.pickable!==undefined){o.isPickable=t.pickable}if(t.alphaIndex!==undefined){o.alphaIndex=t.alphaIndex}o.receiveShadows=t.receiveShadows;o.billboardMode=t.billboardMode;if(t.visibility!==undefined){o.visibility=t.visibility}o.checkCollisions=t.checkCollisions;if(t.isBlocker!==undefined){o.isBlocker=t.isBlocker}o._shouldGenerateFlatShading=t.useFlatShading;if(t.freezeWorldMatrix){o._waitingFreezeWorldMatrix=t.freezeWorldMatrix}if(t.parentId){o._waitingParentId=t.parentId}if(t.actions!==undefined){o._waitingActions=t.actions}if(t.overlayAlpha!==undefined){o.overlayAlpha=t.overlayAlpha}if(t.overlayColor!==undefined){o.overlayColor=e.Color3.FromArray(t.overlayColor)}if(t.renderOverlay!==undefined){o.renderOverlay=t.renderOverlay}o.isUnIndexed=!!t.isUnIndexed;o.hasVertexAlpha=t.hasVertexAlpha;if(t.delayLoadingFile){o.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED;o.delayLoadingFile=n+t.delayLoadingFile;o._boundingInfo=new e.BoundingInfo(e.Vector3.FromArray(t.boundingBoxMinimum),e.Vector3.FromArray(t.boundingBoxMaximum));if(t._binaryInfo){o._binaryInfo=t._binaryInfo}o._delayInfo=[];if(t.hasUVs){o._delayInfo.push(e.VertexBuffer.UVKind)}if(t.hasUVs2){o._delayInfo.push(e.VertexBuffer.UV2Kind)}if(t.hasUVs3){o._delayInfo.push(e.VertexBuffer.UV3Kind)}if(t.hasUVs4){o._delayInfo.push(e.VertexBuffer.UV4Kind)}if(t.hasUVs5){o._delayInfo.push(e.VertexBuffer.UV5Kind)}if(t.hasUVs6){o._delayInfo.push(e.VertexBuffer.UV6Kind)}if(t.hasColors){o._delayInfo.push(e.VertexBuffer.ColorKind)}if(t.hasMatricesIndices){o._delayInfo.push(e.VertexBuffer.MatricesIndicesKind)}if(t.hasMatricesWeights){o._delayInfo.push(e.VertexBuffer.MatricesWeightsKind)}o._delayLoadingFunction=e.Geometry._ImportGeometry;if(e.SceneLoader.ForceFullSceneLoadingForIncremental){o._checkDelayState()}}else{e.Geometry._ImportGeometry(t,o)}if(t.materialId){o.setMaterialByID(t.materialId)}else{o.material=null}if(t.morphTargetManagerId>-1){o.morphTargetManager=i.getMorphTargetManagerById(t.morphTargetManagerId)}if(t.skeletonId>-1){o.skeleton=i.getLastSkeletonByID(t.skeletonId);if(t.numBoneInfluencers){o.numBoneInfluencers=t.numBoneInfluencers}}if(t.animations){for(var s=0;s<t.animations.length;s++){var a=t.animations[s];o.animations.push(e.Animation.Parse(a))}e.Node.ParseAnimationRanges(o,t,i)}if(t.autoAnimate){i.beginAnimation(o,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1)}if(t.layerMask&&!isNaN(t.layerMask)){o.layerMask=Math.abs(parseInt(t.layerMask))}else{o.layerMask=268435455}if(t.physicsImpostor){o.physicsImpostor=new e.PhysicsImpostor(o,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},i)}if(t.instances){for(var u=0;u<t.instances.length;u++){var l=t.instances[u];var c=o.createInstance(l.name);if(l.id){c.id=l.id}if(e.Tags){e.Tags.AddTagsTo(c,l.tags)}c.position=e.Vector3.FromArray(l.position);if(l.parentId){c._waitingParentId=l.parentId}if(l.rotationQuaternion){c.rotationQuaternion=e.Quaternion.FromArray(l.rotationQuaternion)}else if(l.rotation){c.rotation=e.Vector3.FromArray(l.rotation)}c.scaling=e.Vector3.FromArray(l.scaling);c.checkCollisions=o.checkCollisions;if(t.animations){for(s=0;s<t.animations.length;s++){a=t.animations[s];c.animations.push(e.Animation.Parse(a))}e.Node.ParseAnimationRanges(c,t,i)}}}return o};r.CreateRibbon=function(t,i,r,n,o,s,a,u,l){if(r===void 0){r=false}if(a===void 0){a=false}return e.MeshBuilder.CreateRibbon(t,{pathArray:i,closeArray:r,closePath:n,offset:o,updatable:a,sideOrientation:u,instance:l},s)};r.CreateDisc=function(t,i,r,n,o,s){if(n===void 0){n=null}var a={radius:i,tessellation:r,sideOrientation:s,updatable:o};return e.MeshBuilder.CreateDisc(t,a,n)};r.CreateBox=function(t,i,r,n,o){if(r===void 0){r=null}var s={size:i,sideOrientation:o,updatable:n};return e.MeshBuilder.CreateBox(t,s,r)};r.CreateSphere=function(t,i,r,n,o,s){var a={segments:i,diameterX:r,diameterY:r,diameterZ:r,sideOrientation:s,updatable:o};return e.MeshBuilder.CreateSphere(t,a,n)};r.CreateCylinder=function(t,i,n,o,s,a,u,l,c){if(u===undefined||!(u instanceof e.Scene)){if(u!==undefined){c=l||r.DEFAULTSIDE;l=u}u=a;a=1}var h={height:i,diameterTop:n,diameterBottom:o,tessellation:s,subdivisions:a,sideOrientation:c,updatable:l};return e.MeshBuilder.CreateCylinder(t,h,u)};r.CreateTorus=function(t,i,r,n,o,s,a){var u={diameter:i,thickness:r,tessellation:n,sideOrientation:a,updatable:s};return e.MeshBuilder.CreateTorus(t,u,o)};r.CreateTorusKnot=function(t,i,r,n,o,s,a,u,l,c){var h={radius:i,tube:r,radialSegments:n,tubularSegments:o,p:s,q:a,sideOrientation:c,updatable:l};return e.MeshBuilder.CreateTorusKnot(t,h,u)};r.CreateLines=function(t,i,r,n,o){if(r===void 0){r=null}if(n===void 0){n=false}if(o===void 0){o=null}var s={points:i,updatable:n,instance:o};return e.MeshBuilder.CreateLines(t,s,r)};r.CreateDashedLines=function(t,i,r,n,o,s,a,u){if(s===void 0){s=null}var l={points:i,dashSize:r,gapSize:n,dashNb:o,updatable:a,instance:u};return e.MeshBuilder.CreateDashedLines(t,l,s)};r.CreatePolygon=function(t,i,r,n,o,s){var a={shape:i,holes:n,updatable:o,sideOrientation:s};return e.MeshBuilder.CreatePolygon(t,a,r)};r.ExtrudePolygon=function(t,i,r,n,o,s,a){var u={shape:i,holes:o,depth:r,updatable:s,sideOrientation:a};return e.MeshBuilder.ExtrudePolygon(t,u,n)};r.ExtrudeShape=function(t,i,n,o,s,a,u,l,c,h){if(u===void 0){u=null}var f={shape:i,path:n,scale:o,rotation:s,cap:a===0?0:a||r.NO_CAP,sideOrientation:c,instance:h,updatable:l};return e.MeshBuilder.ExtrudeShape(t,f,u)};r.ExtrudeShapeCustom=function(t,i,n,o,s,a,u,l,c,h,f,d){var p={shape:i,path:n,scaleFunction:o,rotationFunction:s,ribbonCloseArray:a,ribbonClosePath:u,cap:l===0?0:l||r.NO_CAP,sideOrientation:f,instance:d,updatable:h};return e.MeshBuilder.ExtrudeShapeCustom(t,p,c)};r.CreateLathe=function(t,i,r,n,o,s,a){var u={shape:i,radius:r,tessellation:n,sideOrientation:a,updatable:s};return e.MeshBuilder.CreateLathe(t,u,o)};r.CreatePlane=function(t,i,r,n,o){var s={size:i,width:i,height:i,sideOrientation:o,updatable:n};return e.MeshBuilder.CreatePlane(t,s,r)};r.CreateGround=function(t,i,r,n,o,s){var a={width:i,height:r,subdivisions:n,updatable:s};return e.MeshBuilder.CreateGround(t,a,o)};r.CreateTiledGround=function(t,i,r,n,o,s,a,u,l){var c={xmin:i,zmin:r,xmax:n,zmax:o,subdivisions:s,precision:a,updatable:l};return e.MeshBuilder.CreateTiledGround(t,c,u)};r.CreateGroundFromHeightMap=function(t,i,r,n,o,s,a,u,l,c){var h={width:r,height:n,subdivisions:o,minHeight:s,maxHeight:a,updatable:l,onReady:c};return e.MeshBuilder.CreateGroundFromHeightMap(t,i,h,u)};r.CreateTube=function(t,i,r,n,o,s,a,u,l,c){var h={path:i,radius:r,tessellation:n,radiusFunction:o,arc:1,cap:s,updatable:u,sideOrientation:l,instance:c};return e.MeshBuilder.CreateTube(t,h,a)};r.CreatePolyhedron=function(t,i,r){return e.MeshBuilder.CreatePolyhedron(t,i,r)};r.CreateIcoSphere=function(t,i,r){return e.MeshBuilder.CreateIcoSphere(t,i,r)};r.CreateDecal=function(t,i,r,n,o,s){var a={position:r,normal:n,size:o,angle:s};return e.MeshBuilder.CreateDecal(t,i,a)};r.prototype.setPositionsForCPUSkinning=function(){if(!this._sourcePositions){var t=this.getVerticesData(e.VertexBuffer.PositionKind);if(!t){return this._sourcePositions}this._sourcePositions=new Float32Array(t);if(!this.isVertexBufferUpdatable(e.VertexBuffer.PositionKind)){this.setVerticesData(e.VertexBuffer.PositionKind,t,true)}}return this._sourcePositions};r.prototype.setNormalsForCPUSkinning=function(){if(!this._sourceNormals){var t=this.getVerticesData(e.VertexBuffer.NormalKind);if(!t){return this._sourceNormals}this._sourceNormals=new Float32Array(t);if(!this.isVertexBufferUpdatable(e.VertexBuffer.NormalKind)){this.setVerticesData(e.VertexBuffer.NormalKind,t,true)}}return this._sourceNormals};r.prototype.applySkeleton=function(t){if(!this.geometry){return this}if(this.geometry._softwareSkinningRenderId==this.getScene().getRenderId()){return this}this.geometry._softwareSkinningRenderId=this.getScene().getRenderId();if(!this.isVerticesDataPresent(e.VertexBuffer.PositionKind)){return this}if(!this.isVerticesDataPresent(e.VertexBuffer.NormalKind)){return this}if(!this.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)){return this}if(!this.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind)){return this}if(!this._sourcePositions){var i=this.subMeshes.slice();this.setPositionsForCPUSkinning();this.subMeshes=i}if(!this._sourceNormals){this.setNormalsForCPUSkinning()}var r=this.getVerticesData(e.VertexBuffer.PositionKind);if(!r){return this}if(!(r instanceof Float32Array)){r=new Float32Array(r)}var n=this.getVerticesData(e.VertexBuffer.NormalKind);if(!n){return this}if(!(n instanceof Float32Array)){n=new Float32Array(n)}var o=this.getVerticesData(e.VertexBuffer.MatricesIndicesKind);var s=this.getVerticesData(e.VertexBuffer.MatricesWeightsKind);if(!s||!o){return this}var a=this.numBoneInfluencers>4;var u=a?this.getVerticesData(e.VertexBuffer.MatricesIndicesExtraKind):null;var l=a?this.getVerticesData(e.VertexBuffer.MatricesWeightsExtraKind):null;var c=t.getTransformMatrices(this);var h=e.Vector3.Zero();var f=new e.Matrix;var d=new e.Matrix;var p=0;var _;for(var m=0;m<r.length;m+=3,p+=4){var g;for(_=0;_<4;_++){g=s[p+_];if(g>0){e.Matrix.FromFloat32ArrayToRefScaled(c,Math.floor(o[p+_]*16),g,d);f.addToSelf(d)}else break}if(a){for(_=0;_<4;_++){g=l[p+_];if(g>0){e.Matrix.FromFloat32ArrayToRefScaled(c,Math.floor(u[p+_]*16),g,d);f.addToSelf(d)}else break}}e.Vector3.TransformCoordinatesFromFloatsToRef(this._sourcePositions[m],this._sourcePositions[m+1],this._sourcePositions[m+2],f,h);h.toArray(r,m);e.Vector3.TransformNormalFromFloatsToRef(this._sourceNormals[m],this._sourceNormals[m+1],this._sourceNormals[m+2],f,h);h.toArray(n,m);f.reset()}this.updateVerticesData(e.VertexBuffer.PositionKind,r);this.updateVerticesData(e.VertexBuffer.NormalKind,n);return this};r.MinMax=function(t){var i=null;var r=null;t.forEach(function(e,t,n){var o=e.getBoundingInfo();var s=o.boundingBox;if(!i||!r){i=s.minimumWorld;r=s.maximumWorld}else{i.minimizeInPlace(s.minimumWorld);r.maximizeInPlace(s.maximumWorld)}});if(!i||!r){return{min:e.Vector3.Zero(),max:e.Vector3.Zero()}}return{min:i,max:r}};r.Center=function(t){var i=t instanceof Array?r.MinMax(t):t;return e.Vector3.Center(i.min,i.max)};r.MergeMeshes=function(t,i,n,o,s){if(i===void 0){i=true}var a;if(!n){var u=0;for(a=0;a<t.length;a++){if(t[a]){u+=t[a].getTotalVertices();if(u>65536){e.Tools.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices");return null}}}}var l=null;var c;var h=new Array;var f=null;for(a=0;a<t.length;a++){if(t[a]){t[a].computeWorldMatrix(true);c=e.VertexData.ExtractFromMesh(t[a],true);c.transform(t[a].getWorldMatrix());if(l){l.merge(c)}else{l=c;f=t[a]}if(s){h.push(t[a].getTotalIndices())}}}f=f;if(!o){o=new r(f.name+"_merged",f.getScene())}l.applyToMesh(o);o.material=f.material;o.checkCollisions=f.checkCollisions;if(i){for(a=0;a<t.length;a++){if(t[a]){t[a].dispose()}}}if(s){o.releaseSubMeshes();a=0;var d=0;while(a<h.length){e.SubMesh.CreateFromIndices(0,d,h[a],o);d+=h[a];a++}}return o};r._FRONTSIDE=0;r._BACKSIDE=1;r._DOUBLESIDE=2;r._DEFAULTSIDE=0;r._NO_CAP=0;r._CAP_START=1;r._CAP_END=2;r._CAP_ALL=3;return r}(e.AbstractMesh);e.Mesh=i})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){}Object.defineProperty(e.prototype,"effect",{get:function(){return this._materialEffect},enumerable:true,configurable:true});e.prototype.setEffect=function(e,t){if(t===void 0){t=null}if(this._materialEffect===e){if(!e){this._materialDefines=null}return}this._materialDefines=t;this._materialEffect=e};return e}();e.BaseSubMesh=t;var i=function(t){__extends(i,t);function i(e,i,r,n,o,s,a,u){if(u===void 0){u=true}var l=t.call(this)||this;l.materialIndex=e;l.verticesStart=i;l.verticesCount=r;l.indexStart=n;l.indexCount=o;l._renderId=0;l._mesh=s;l._renderingMesh=a||s;s.subMeshes.push(l);l._trianglePlanes=[];l._id=s.subMeshes.length-1;if(u){l.refreshBoundingInfo();s.computeWorldMatrix(true)}return l}i.AddToMesh=function(e,t,r,n,o,s,a,u){if(u===void 0){u=true}return new i(e,t,r,n,o,s,a,u)};Object.defineProperty(i.prototype,"IsGlobal",{get:function(){return this.verticesStart===0&&this.verticesCount==this._mesh.getTotalVertices()},enumerable:true,configurable:true});i.prototype.getBoundingInfo=function(){if(this.IsGlobal){return this._mesh.getBoundingInfo()}return this._boundingInfo};i.prototype.setBoundingInfo=function(e){this._boundingInfo=e;return this};i.prototype.getMesh=function(){return this._mesh};i.prototype.getRenderingMesh=function(){return this._renderingMesh};i.prototype.getMaterial=function(){var e=this._renderingMesh.material;if(e===null||e===undefined){return this._mesh.getScene().defaultMaterial}else if(e.getSubMaterial){var t=e;var i=t.getSubMaterial(this.materialIndex);if(this._currentMaterial!==i){this._currentMaterial=i;this._materialDefines=null}return i}return e};i.prototype.refreshBoundingInfo=function(){this._lastColliderWorldVertices=null;if(this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry){return this}var t=this._renderingMesh.getVerticesData(e.VertexBuffer.PositionKind);if(!t){this._boundingInfo=this._mesh.getBoundingInfo();return this}var i=this._renderingMesh.getIndices();var r;if(this.indexStart===0&&this.indexCount===i.length){var n=this._renderingMesh.getBoundingInfo();r={minimum:n.minimum.clone(),maximum:n.maximum.clone()}}else{r=e.Tools.ExtractMinAndMaxIndexed(t,i,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias)}this._boundingInfo=new e.BoundingInfo(r.minimum,r.maximum);return this};i.prototype._checkCollision=function(e){var t=this.getBoundingInfo();return t._checkCollision(e)};i.prototype.updateBoundingInfo=function(e){var t=this.getBoundingInfo();if(!t){this.refreshBoundingInfo();t=this.getBoundingInfo()}t.update(e);return this};i.prototype.isInFrustum=function(e){var t=this.getBoundingInfo();if(!t){return false}return t.isInFrustum(e)};i.prototype.isCompletelyInFrustum=function(e){var t=this.getBoundingInfo();if(!t){return false}return t.isCompletelyInFrustum(e)};i.prototype.render=function(e){this._renderingMesh.render(this,e);return this};i.prototype.getLinesIndexBuffer=function(e,t){if(!this._linesIndexBuffer){var i=[];for(var r=this.indexStart;r<this.indexStart+this.indexCount;r+=3){i.push(e[r],e[r+1],e[r+1],e[r+2],e[r+2],e[r])}this._linesIndexBuffer=t.createIndexBuffer(i);this.linesIndexCount=i.length}return this._linesIndexBuffer};i.prototype.canIntersects=function(e){var t=this.getBoundingInfo();if(!t){return false}return e.intersectsBox(t.boundingBox)};i.prototype.intersects=function(t,i,r,n){var o=null;var s=this.getMaterial();if(!s){return null}switch(s.fillMode){case e.Material.PointListDrawMode:case e.Material.LineListDrawMode:case e.Material.LineLoopDrawMode:case e.Material.LineStripDrawMode:case e.Material.TriangleFanDrawMode:case e.Material.TriangleStripDrawMode:return null}if(e.LinesMesh&&this._mesh instanceof e.LinesMesh){var a=this._mesh;for(var u=this.indexStart;u<this.indexStart+this.indexCount;u+=2){var l=i[r[u]];var c=i[r[u+1]];var h=t.intersectionSegment(l,c,a.intersectionThreshold);if(h<0){continue}if(n||!o||h<o.distance){o=new e.IntersectionInfo(null,null,h);if(n){break}}}}else{for(var u=this.indexStart;u<this.indexStart+this.indexCount;u+=3){var l=i[r[u]];var c=i[r[u+1]];var f=i[r[u+2]];var d=t.intersectsTriangle(l,c,f);if(d){if(d.distance<0){continue}if(n||!o||d.distance<o.distance){o=d;o.faceId=u/3;if(n){break}}}}}return o};i.prototype._rebuild=function(){if(this._linesIndexBuffer){this._linesIndexBuffer=null}};i.prototype.clone=function(t,r){var n=new i(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,t,r,false);if(!this.IsGlobal){var o=this.getBoundingInfo();if(!o){return n}n._boundingInfo=new e.BoundingInfo(o.minimum,o.maximum)}return n};i.prototype.dispose=function(){if(this._linesIndexBuffer){this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer);this._linesIndexBuffer=null}var e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1)};i.CreateFromIndices=function(e,t,r,n,o){var s=Number.MAX_VALUE;var a=-Number.MAX_VALUE;o=o||n;var u=o.getIndices();for(var l=t;l<t+r;l++){var c=u[l];if(c<s)s=c;if(c>a)a=c}return new i(e,s,a-s+1,t,r,n,o)};return i}(t);e.SubMesh=i})(r||(r={}));"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++){t=arguments[i];for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n))e[n]=t[n]}return e};var r;(function(e){var t=function(){function e(){this._isDirty=true;this._areLightsDirty=true;this._areAttributesDirty=true;this._areTexturesDirty=true;this._areFresnelDirty=true;this._areMiscDirty=true;this._areImageProcessingDirty=true;this._normals=false;this._uvs=false;this._needNormals=false;this._needUVs=false}Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isDirty},enumerable:true,configurable:true});e.prototype.markAsProcessed=function(){this._isDirty=false;this._areAttributesDirty=false;this._areTexturesDirty=false;this._areFresnelDirty=false;this._areLightsDirty=false;this._areMiscDirty=false;this._areImageProcessingDirty=false};e.prototype.markAsUnprocessed=function(){this._isDirty=true};e.prototype.markAllAsDirty=function(){this._areTexturesDirty=true;this._areAttributesDirty=true;this._areLightsDirty=true;this._areFresnelDirty=true;this._areMiscDirty=true;this._areImageProcessingDirty=true;this._isDirty=true};e.prototype.markAsImageProcessingDirty=function(){this._areImageProcessingDirty=true;this._isDirty=true};e.prototype.markAsLightDirty=function(){this._areLightsDirty=true;this._isDirty=true};e.prototype.markAsAttributesDirty=function(){this._areAttributesDirty=true;this._isDirty=true};e.prototype.markAsTexturesDirty=function(){this._areTexturesDirty=true;this._isDirty=true};e.prototype.markAsFresnelDirty=function(){this._areFresnelDirty=true;this._isDirty=true};e.prototype.markAsMiscDirty=function(){this._areMiscDirty=true;this._isDirty=true};e.prototype.rebuild=function(){if(this._keys){delete this._keys}this._keys=[];for(var e=0,t=Object.keys(this);e<t.length;e++){var i=t[e];if(i[0]==="_"){continue}this._keys.push(i)}};e.prototype.isEqual=function(e){if(this._keys.length!==e._keys.length){return false}for(var t=0;t<this._keys.length;t++){var i=this._keys[t];if(this[i]!==e[i]){return false}}return true};e.prototype.cloneTo=function(e){if(this._keys.length!==e._keys.length){e._keys=this._keys.slice(0)}for(var t=0;t<this._keys.length;t++){var i=this._keys[t];e[i]=this[i]}};e.prototype.reset=function(){for(var e=0;e<this._keys.length;e++){var t=this._keys[e];var i=typeof this[t];switch(i){case"number":this[t]=0;break;case"string":this[t]="";break;default:this[t]=false;break}}};e.prototype.toString=function(){var e="";for(var t=0;t<this._keys.length;t++){var i=this._keys[t];var r=this[i];var n=typeof r;switch(n){case"number":case"string":e+="#define "+i+" "+r+"\n";break;default:if(r){e+="#define "+i+"\n"}break}}return e};return e}();e.MaterialDefines=t;var i=function(){function t(i,r,n){this.checkReadyOnEveryCall=false;this.checkReadyOnlyOnce=false;this.state="";this._alpha=1;this._backFaceCulling=true;this.doNotSerialize=false;this.storeEffectOnSubMeshes=false;this.onDisposeObservable=new e.Observable;this.onBindObservable=new e.Observable;this.onUnBindObservable=new e.Observable;this._alphaMode=e.Engine.ALPHA_COMBINE;this._needDepthPrePass=false;this.disableDepthWrite=false;this.forceDepthWrite=false;this.separateCullingPass=false;this._fogEnabled=true;this.pointSize=1
;this.zOffset=0;this._wasPreviouslyReady=false;this._fillMode=t.TriangleFillMode;this.name=i;this.id=i||e.Tools.RandomId();this._scene=r||e.Engine.LastCreatedScene;if(this._scene.useRightHandedSystem){this.sideOrientation=t.ClockWiseSideOrientation}else{this.sideOrientation=t.CounterClockWiseSideOrientation}this._uniformBuffer=new e.UniformBuffer(this._scene.getEngine());this._useUBO=this.getScene().getEngine().supportsUniformBuffers;if(!n){this._scene.materials.push(this)}}Object.defineProperty(t,"TriangleFillMode",{get:function(){return t._TriangleFillMode},enumerable:true,configurable:true});Object.defineProperty(t,"WireFrameFillMode",{get:function(){return t._WireFrameFillMode},enumerable:true,configurable:true});Object.defineProperty(t,"PointFillMode",{get:function(){return t._PointFillMode},enumerable:true,configurable:true});Object.defineProperty(t,"PointListDrawMode",{get:function(){return t._PointListDrawMode},enumerable:true,configurable:true});Object.defineProperty(t,"LineListDrawMode",{get:function(){return t._LineListDrawMode},enumerable:true,configurable:true});Object.defineProperty(t,"LineLoopDrawMode",{get:function(){return t._LineLoopDrawMode},enumerable:true,configurable:true});Object.defineProperty(t,"LineStripDrawMode",{get:function(){return t._LineStripDrawMode},enumerable:true,configurable:true});Object.defineProperty(t,"TriangleStripDrawMode",{get:function(){return t._TriangleStripDrawMode},enumerable:true,configurable:true});Object.defineProperty(t,"TriangleFanDrawMode",{get:function(){return t._TriangleFanDrawMode},enumerable:true,configurable:true});Object.defineProperty(t,"ClockWiseSideOrientation",{get:function(){return t._ClockWiseSideOrientation},enumerable:true,configurable:true});Object.defineProperty(t,"CounterClockWiseSideOrientation",{get:function(){return t._CounterClockWiseSideOrientation},enumerable:true,configurable:true});Object.defineProperty(t,"TextureDirtyFlag",{get:function(){return t._TextureDirtyFlag},enumerable:true,configurable:true});Object.defineProperty(t,"LightDirtyFlag",{get:function(){return t._LightDirtyFlag},enumerable:true,configurable:true});Object.defineProperty(t,"FresnelDirtyFlag",{get:function(){return t._FresnelDirtyFlag},enumerable:true,configurable:true});Object.defineProperty(t,"AttributesDirtyFlag",{get:function(){return t._AttributesDirtyFlag},enumerable:true,configurable:true});Object.defineProperty(t,"MiscDirtyFlag",{get:function(){return t._MiscDirtyFlag},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"alpha",{get:function(){return this._alpha},set:function(e){if(this._alpha===e){return}this._alpha=e;this.markAsDirty(t.MiscDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"backFaceCulling",{get:function(){return this._backFaceCulling},set:function(e){if(this._backFaceCulling===e){return}this._backFaceCulling=e;this.markAsDirty(t.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"onDispose",{set:function(e){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"onBind",{set:function(e){if(this._onBindObserver){this.onBindObservable.remove(this._onBindObserver)}this._onBindObserver=this.onBindObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"alphaMode",{get:function(){return this._alphaMode},set:function(e){if(this._alphaMode===e){return}this._alphaMode=e;this.markAsDirty(t.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"needDepthPrePass",{get:function(){return this._needDepthPrePass},set:function(e){if(this._needDepthPrePass===e){return}this._needDepthPrePass=e;if(this._needDepthPrePass){this.checkReadyOnEveryCall=true}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"fogEnabled",{get:function(){return this._fogEnabled},set:function(e){if(this._fogEnabled===e){return}this._fogEnabled=e;this.markAsDirty(t.MiscDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"wireframe",{get:function(){switch(this._fillMode){case t.WireFrameFillMode:case t.LineListDrawMode:case t.LineLoopDrawMode:case t.LineStripDrawMode:return true}return this._scene.forceWireframe},set:function(e){this.fillMode=e?t.WireFrameFillMode:t.TriangleFillMode},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"pointsCloud",{get:function(){switch(this._fillMode){case t.PointFillMode:case t.PointListDrawMode:return true}return this._scene.forcePointsCloud},set:function(e){this.fillMode=e?t.PointFillMode:t.TriangleFillMode},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"fillMode",{get:function(){return this._fillMode},set:function(e){if(this._fillMode===e){return}this._fillMode=e;this.markAsDirty(t.MiscDirtyFlag)},enumerable:true,configurable:true});t.prototype.toString=function(e){var t="Name: "+this.name;if(e){}return t};t.prototype.getClassName=function(){return"Material"};Object.defineProperty(t.prototype,"isFrozen",{get:function(){return this.checkReadyOnlyOnce},enumerable:true,configurable:true});t.prototype.freeze=function(){this.checkReadyOnlyOnce=true};t.prototype.unfreeze=function(){this.checkReadyOnlyOnce=false};t.prototype.isReady=function(e,t){return true};t.prototype.isReadyForSubMesh=function(e,t,i){return false};t.prototype.getEffect=function(){return this._effect};t.prototype.getScene=function(){return this._scene};t.prototype.needAlphaBlending=function(){return this.alpha<1};t.prototype.needAlphaBlendingForMesh=function(e){return this.needAlphaBlending()||e.visibility<1||e.hasVertexAlpha};t.prototype.needAlphaTesting=function(){return false};t.prototype.getAlphaTestTexture=function(){return null};t.prototype.markDirty=function(){this._wasPreviouslyReady=false};t.prototype._preBind=function(e,i){if(i===void 0){i=null}var r=this._scene.getEngine();var n=i==null?this.sideOrientation:i;var o=n===t.ClockWiseSideOrientation;r.enableEffect(e?e:this._effect);r.setState(this.backFaceCulling,this.zOffset,false,o);return o};t.prototype.bind=function(e,t){};t.prototype.bindForSubMesh=function(e,t,i){};t.prototype.bindOnlyWorldMatrix=function(e){};t.prototype.bindSceneUniformBuffer=function(e,t){t.bindToEffect(e,"Scene")};t.prototype.bindView=function(e){if(!this._useUBO){e.setMatrix("view",this.getScene().getViewMatrix())}else{this.bindSceneUniformBuffer(e,this.getScene().getSceneUniformBuffer())}};t.prototype.bindViewProjection=function(e){if(!this._useUBO){e.setMatrix("viewProjection",this.getScene().getTransformMatrix())}else{this.bindSceneUniformBuffer(e,this.getScene().getSceneUniformBuffer())}};t.prototype._shouldTurnAlphaTestOn=function(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()};t.prototype._afterBind=function(e){this._scene._cachedMaterial=this;if(e){this._scene._cachedVisibility=e.visibility}else{this._scene._cachedVisibility=1}if(e){this.onBindObservable.notifyObservers(e)}if(this.disableDepthWrite){var t=this._scene.getEngine();this._cachedDepthWriteState=t.getDepthWrite();t.setDepthWrite(false)}};t.prototype.unbind=function(){this.onUnBindObservable.notifyObservers(this);if(this.disableDepthWrite){var e=this._scene.getEngine();e.setDepthWrite(this._cachedDepthWriteState)}};t.prototype.getActiveTextures=function(){return[]};t.prototype.hasTexture=function(e){return false};t.prototype.clone=function(e){return null};t.prototype.getBindedMeshes=function(){var e=new Array;for(var t=0;t<this._scene.meshes.length;t++){var i=this._scene.meshes[t];if(i.material===this){e.push(i)}}return e};t.prototype.forceCompilation=function(t,i,r){var o=this;var s=n({clipPlane:false},r);var a=new e.BaseSubMesh;var u=this.getScene();var l=function(){if(!o._scene||!o._scene.getEngine()){return}if(a._materialDefines){a._materialDefines._renderId=-1}var r=u.clipPlane;if(s.clipPlane){u.clipPlane=new e.Plane(0,0,0,1)}if(o.storeEffectOnSubMeshes){if(o.isReadyForSubMesh(t,a)){if(i){i(o)}}else{setTimeout(l,16)}}else{if(o.isReady(t)){if(i){i(o)}}else{setTimeout(l,16)}}if(s.clipPlane){u.clipPlane=r}};l()};t.prototype.forceCompilationAsync=function(e,t){var i=this;return new Promise(function(r){i.forceCompilation(e,function(){r()},t)})};t.prototype.markAsDirty=function(e){if(e&t.TextureDirtyFlag){this._markAllSubMeshesAsTexturesDirty()}if(e&t.LightDirtyFlag){this._markAllSubMeshesAsLightsDirty()}if(e&t.FresnelDirtyFlag){this._markAllSubMeshesAsFresnelDirty()}if(e&t.AttributesDirtyFlag){this._markAllSubMeshesAsAttributesDirty()}if(e&t.MiscDirtyFlag){this._markAllSubMeshesAsMiscDirty()}this.getScene().resetCachedMaterial()};t.prototype._markAllSubMeshesAsDirty=function(e){for(var t=0,i=this.getScene().meshes;t<i.length;t++){var r=i[t];if(!r.subMeshes){continue}for(var n=0,o=r.subMeshes;n<o.length;n++){var s=o[n];if(s.getMaterial()!==this){continue}if(!s._materialDefines){continue}e(s._materialDefines)}}};t.prototype._markAllSubMeshesAsImageProcessingDirty=function(){this._markAllSubMeshesAsDirty(function(e){return e.markAsImageProcessingDirty()})};t.prototype._markAllSubMeshesAsTexturesDirty=function(){this._markAllSubMeshesAsDirty(function(e){return e.markAsTexturesDirty()})};t.prototype._markAllSubMeshesAsFresnelDirty=function(){this._markAllSubMeshesAsDirty(function(e){return e.markAsFresnelDirty()})};t.prototype._markAllSubMeshesAsFresnelAndMiscDirty=function(){this._markAllSubMeshesAsDirty(function(e){e.markAsFresnelDirty();e.markAsMiscDirty()})};t.prototype._markAllSubMeshesAsLightsDirty=function(){this._markAllSubMeshesAsDirty(function(e){return e.markAsLightDirty()})};t.prototype._markAllSubMeshesAsAttributesDirty=function(){this._markAllSubMeshesAsDirty(function(e){return e.markAsAttributesDirty()})};t.prototype._markAllSubMeshesAsMiscDirty=function(){this._markAllSubMeshesAsDirty(function(e){return e.markAsMiscDirty()})};t.prototype._markAllSubMeshesAsTexturesAndMiscDirty=function(){this._markAllSubMeshesAsDirty(function(e){e.markAsTexturesDirty();e.markAsMiscDirty()})};t.prototype.dispose=function(e,t){this.getScene().stopAnimation(this);this.getScene().freeProcessedMaterials();var i=this._scene.materials.indexOf(this);if(i>=0){this._scene.materials.splice(i,1)}for(i=0;i<this._scene.meshes.length;i++){var r=this._scene.meshes[i];if(r.material===this){r.material=null;if(r.geometry){var n=r.geometry;if(this.storeEffectOnSubMeshes){for(var o=0,s=r.subMeshes;o<s.length;o++){var a=s[o];n._releaseVertexArrayObject(a._materialEffect);if(e&&a._materialEffect){this._scene.getEngine()._releaseEffect(a._materialEffect)}}}else{n._releaseVertexArrayObject(this._effect)}}}}this._uniformBuffer.dispose();if(e&&this._effect){if(!this.storeEffectOnSubMeshes){this._scene.getEngine()._releaseEffect(this._effect)}this._effect=null}this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onBindObservable.clear();this.onUnBindObservable.clear()};t.prototype.serialize=function(){return e.SerializationHelper.Serialize(this)};t.ParseMultiMaterial=function(t,i){var r=new e.MultiMaterial(t.name,i);r.id=t.id;if(e.Tags){e.Tags.AddTagsTo(r,t.tags)}for(var n=0;n<t.materials.length;n++){var o=t.materials[n];if(o){r.subMaterials.push(i.getMaterialByID(o))}else{r.subMaterials.push(null)}}return r};t.Parse=function(t,i,r){if(!t.customType||t.customType==="BABYLON.StandardMaterial"){return e.StandardMaterial.Parse(t,i,r)}if(t.customType==="BABYLON.PBRMaterial"&&t.overloadedAlbedo){t.customType="BABYLON.LegacyPBRMaterial";if(!e.LegacyPBRMaterial){e.Tools.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library.");return}}var n=e.Tools.Instantiate(t.customType);return n.Parse(t,i,r)};t._TriangleFillMode=0;t._WireFrameFillMode=1;t._PointFillMode=2;t._PointListDrawMode=3;t._LineListDrawMode=4;t._LineLoopDrawMode=5;t._LineStripDrawMode=6;t._TriangleStripDrawMode=7;t._TriangleFanDrawMode=8;t._ClockWiseSideOrientation=0;t._CounterClockWiseSideOrientation=1;t._TextureDirtyFlag=1;t._LightDirtyFlag=2;t._FresnelDirtyFlag=4;t._AttributesDirtyFlag=8;t._MiscDirtyFlag=16;__decorate([e.serialize()],t.prototype,"id",void 0);__decorate([e.serialize()],t.prototype,"name",void 0);__decorate([e.serialize()],t.prototype,"checkReadyOnEveryCall",void 0);__decorate([e.serialize()],t.prototype,"checkReadyOnlyOnce",void 0);__decorate([e.serialize()],t.prototype,"state",void 0);__decorate([e.serialize("alpha")],t.prototype,"_alpha",void 0);__decorate([e.serialize("backFaceCulling")],t.prototype,"_backFaceCulling",void 0);__decorate([e.serialize()],t.prototype,"sideOrientation",void 0);__decorate([e.serialize("alphaMode")],t.prototype,"_alphaMode",void 0);__decorate([e.serialize()],t.prototype,"_needDepthPrePass",void 0);__decorate([e.serialize()],t.prototype,"disableDepthWrite",void 0);__decorate([e.serialize()],t.prototype,"forceDepthWrite",void 0);__decorate([e.serialize()],t.prototype,"separateCullingPass",void 0);__decorate([e.serialize("fogEnabled")],t.prototype,"_fogEnabled",void 0);__decorate([e.serialize()],t.prototype,"pointSize",void 0);__decorate([e.serialize()],t.prototype,"zOffset",void 0);__decorate([e.serialize()],t.prototype,"wireframe",null);__decorate([e.serialize()],t.prototype,"pointsCloud",null);__decorate([e.serialize()],t.prototype,"fillMode",null);return t}();e.Material=i})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,t,i){this._engine=e;this._noUBO=!e.supportsUniformBuffers;this._dynamic=i;this._data=t||[];this._uniformLocations={};this._uniformSizes={};this._uniformLocationPointer=0;this._needSync=false;if(this._noUBO){this.updateMatrix3x3=this._updateMatrix3x3ForEffect;this.updateMatrix2x2=this._updateMatrix2x2ForEffect;this.updateFloat=this._updateFloatForEffect;this.updateFloat2=this._updateFloat2ForEffect;this.updateFloat3=this._updateFloat3ForEffect;this.updateFloat4=this._updateFloat4ForEffect;this.updateMatrix=this._updateMatrixForEffect;this.updateVector3=this._updateVector3ForEffect;this.updateVector4=this._updateVector4ForEffect;this.updateColor3=this._updateColor3ForEffect;this.updateColor4=this._updateColor4ForEffect}else{this._engine._uniformBuffers.push(this);this.updateMatrix3x3=this._updateMatrix3x3ForUniform;this.updateMatrix2x2=this._updateMatrix2x2ForUniform;this.updateFloat=this._updateFloatForUniform;this.updateFloat2=this._updateFloat2ForUniform;this.updateFloat3=this._updateFloat3ForUniform;this.updateFloat4=this._updateFloat4ForUniform;this.updateMatrix=this._updateMatrixForUniform;this.updateVector3=this._updateVector3ForUniform;this.updateVector4=this._updateVector4ForUniform;this.updateColor3=this._updateColor3ForUniform;this.updateColor4=this._updateColor4ForUniform}}Object.defineProperty(t.prototype,"useUbo",{get:function(){return!this._noUBO},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"isSync",{get:function(){return!this._needSync},enumerable:true,configurable:true});t.prototype.isDynamic=function(){return this._dynamic!==undefined};t.prototype.getData=function(){return this._bufferData};t.prototype.getBuffer=function(){return this._buffer};t.prototype._fillAlignment=function(e){var t;if(e<=2){t=e}else{t=4}if(this._uniformLocationPointer%t!==0){var i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;var r=this._uniformLocationPointer-i;for(var n=0;n<r;n++){this._data.push(0)}}};t.prototype.addUniform=function(e,t){if(this._noUBO){return}if(this._uniformLocations[e]!==undefined){return}var i;if(t instanceof Array){i=t;t=i.length}else{t=t;i=[];for(var r=0;r<t;r++){i.push(0)}}this._fillAlignment(t);this._uniformSizes[e]=t;this._uniformLocations[e]=this._uniformLocationPointer;this._uniformLocationPointer+=t;for(var r=0;r<t;r++){this._data.push(i[r])}this._needSync=true};t.prototype.addMatrix=function(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))};t.prototype.addFloat2=function(e,t,i){var r=[t,i];this.addUniform(e,r)};t.prototype.addFloat3=function(e,t,i,r){var n=[t,i,r];this.addUniform(e,n)};t.prototype.addColor3=function(e,t){var i=new Array;t.toArray(i);this.addUniform(e,i)};t.prototype.addColor4=function(e,t,i){var r=new Array;t.toArray(r);r.push(i);this.addUniform(e,r)};t.prototype.addVector3=function(e,t){var i=new Array;t.toArray(i);this.addUniform(e,i)};t.prototype.addMatrix3x3=function(e){this.addUniform(e,12)};t.prototype.addMatrix2x2=function(e){this.addUniform(e,8)};t.prototype.create=function(){if(this._noUBO){return}if(this._buffer){return}this._fillAlignment(4);this._bufferData=new Float32Array(this._data);this._rebuild();this._needSync=true};t.prototype._rebuild=function(){if(this._noUBO){return}if(this._dynamic){this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData)}else{this._buffer=this._engine.createUniformBuffer(this._bufferData)}};t.prototype.update=function(){if(!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){return}this._engine.updateUniformBuffer(this._buffer,this._bufferData);this._needSync=false};t.prototype.updateUniform=function(t,i,r){var n=this._uniformLocations[t];if(n===undefined){if(this._buffer){e.Tools.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(t,r);n=this._uniformLocations[t]}if(!this._buffer){this.create()}if(!this._dynamic){var o=false;for(var s=0;s<r;s++){if(this._bufferData[n+s]!==i[s]){o=true;this._bufferData[n+s]=i[s]}}this._needSync=this._needSync||o}else{for(var s=0;s<r;s++){this._bufferData[n+s]=i[s]}}};t.prototype._updateMatrix3x3ForUniform=function(e,i){for(var r=0;r<3;r++){t._tempBuffer[r*4]=i[r*3];t._tempBuffer[r*4+1]=i[r*3+1];t._tempBuffer[r*4+2]=i[r*3+2];t._tempBuffer[r*4+3]=0}this.updateUniform(e,t._tempBuffer,12)};t.prototype._updateMatrix3x3ForEffect=function(e,t){this._currentEffect.setMatrix3x3(e,t)};t.prototype._updateMatrix2x2ForEffect=function(e,t){this._currentEffect.setMatrix2x2(e,t)};t.prototype._updateMatrix2x2ForUniform=function(e,i){for(var r=0;r<2;r++){t._tempBuffer[r*4]=i[r*2];t._tempBuffer[r*4+1]=i[r*2+1];t._tempBuffer[r*4+2]=0;t._tempBuffer[r*4+3]=0}this.updateUniform(e,t._tempBuffer,8)};t.prototype._updateFloatForEffect=function(e,t){this._currentEffect.setFloat(e,t)};t.prototype._updateFloatForUniform=function(e,i){t._tempBuffer[0]=i;this.updateUniform(e,t._tempBuffer,1)};t.prototype._updateFloat2ForEffect=function(e,t,i,r){if(r===void 0){r=""}this._currentEffect.setFloat2(e+r,t,i)};t.prototype._updateFloat2ForUniform=function(e,i,r,n){if(n===void 0){n=""}t._tempBuffer[0]=i;t._tempBuffer[1]=r;this.updateUniform(e,t._tempBuffer,2)};t.prototype._updateFloat3ForEffect=function(e,t,i,r,n){if(n===void 0){n=""}this._currentEffect.setFloat3(e+n,t,i,r)};t.prototype._updateFloat3ForUniform=function(e,i,r,n,o){if(o===void 0){o=""}t._tempBuffer[0]=i;t._tempBuffer[1]=r;t._tempBuffer[2]=n;this.updateUniform(e,t._tempBuffer,3)};t.prototype._updateFloat4ForEffect=function(e,t,i,r,n,o){if(o===void 0){o=""}this._currentEffect.setFloat4(e+o,t,i,r,n)};t.prototype._updateFloat4ForUniform=function(e,i,r,n,o,s){if(s===void 0){s=""}t._tempBuffer[0]=i;t._tempBuffer[1]=r;t._tempBuffer[2]=n;t._tempBuffer[3]=o;this.updateUniform(e,t._tempBuffer,4)};t.prototype._updateMatrixForEffect=function(e,t){this._currentEffect.setMatrix(e,t)};t.prototype._updateMatrixForUniform=function(e,t){this.updateUniform(e,t.toArray(),16)};t.prototype._updateVector3ForEffect=function(e,t){this._currentEffect.setVector3(e,t)};t.prototype._updateVector3ForUniform=function(e,i){i.toArray(t._tempBuffer);this.updateUniform(e,t._tempBuffer,3)};t.prototype._updateVector4ForEffect=function(e,t){this._currentEffect.setVector4(e,t)};t.prototype._updateVector4ForUniform=function(e,i){i.toArray(t._tempBuffer);this.updateUniform(e,t._tempBuffer,4)};t.prototype._updateColor3ForEffect=function(e,t,i){if(i===void 0){i=""}this._currentEffect.setColor3(e+i,t)};t.prototype._updateColor3ForUniform=function(e,i,r){if(r===void 0){r=""}i.toArray(t._tempBuffer);this.updateUniform(e,t._tempBuffer,3)};t.prototype._updateColor4ForEffect=function(e,t,i,r){if(r===void 0){r=""}this._currentEffect.setColor4(e+r,t,i)};t.prototype._updateColor4ForUniform=function(e,i,r,n){if(n===void 0){n=""}i.toArray(t._tempBuffer);t._tempBuffer[3]=r;this.updateUniform(e,t._tempBuffer,4)};t.prototype.setTexture=function(e,t){this._currentEffect.setTexture(e,t)};t.prototype.updateUniformDirectly=function(e,t){this.updateUniform(e,t,t.length);this.update()};t.prototype.bindToEffect=function(e,t){this._currentEffect=e;if(this._noUBO||!this._buffer){return}e.bindUniformBuffer(this._buffer,t)};t.prototype.dispose=function(){if(this._noUBO){return}var e=this._engine._uniformBuffers.indexOf(this);if(e!==-1){this._engine._uniformBuffers.splice(e,1)}if(!this._buffer){return}if(this._engine._releaseBuffer(this._buffer)){this._buffer=null}};t._MAX_UNIFORM_SIZE=256;t._tempBuffer=new Float32Array(t._MAX_UNIFORM_SIZE);return t}();e.UniformBuffer=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){}t.prototype.set=function(t,i){switch(i){case e.VertexBuffer.PositionKind:this.positions=t;break;case e.VertexBuffer.NormalKind:this.normals=t;break;case e.VertexBuffer.TangentKind:this.tangents=t;break;case e.VertexBuffer.UVKind:this.uvs=t;break;case e.VertexBuffer.UV2Kind:this.uvs2=t;break;case e.VertexBuffer.UV3Kind:this.uvs3=t;break;case e.VertexBuffer.UV4Kind:this.uvs4=t;break;case e.VertexBuffer.UV5Kind:this.uvs5=t;break;case e.VertexBuffer.UV6Kind:this.uvs6=t;break;case e.VertexBuffer.ColorKind:this.colors=t;break;case e.VertexBuffer.MatricesIndicesKind:this.matricesIndices=t;break;case e.VertexBuffer.MatricesWeightsKind:this.matricesWeights=t;break;case e.VertexBuffer.MatricesIndicesExtraKind:this.matricesIndicesExtra=t;break;case e.VertexBuffer.MatricesWeightsExtraKind:this.matricesWeightsExtra=t;break}};t.prototype.applyToMesh=function(e,t){this._applyTo(e,t);return this};t.prototype.applyToGeometry=function(e,t){this._applyTo(e,t);return this};t.prototype.updateMesh=function(e,t,i){this._update(e);return this};t.prototype.updateGeometry=function(e,t,i){this._update(e);return this};t.prototype._applyTo=function(t,i){if(i===void 0){i=false}if(this.positions){t.setVerticesData(e.VertexBuffer.PositionKind,this.positions,i)}if(this.normals){t.setVerticesData(e.VertexBuffer.NormalKind,this.normals,i)}if(this.tangents){t.setVerticesData(e.VertexBuffer.TangentKind,this.tangents,i)}if(this.uvs){t.setVerticesData(e.VertexBuffer.UVKind,this.uvs,i)}if(this.uvs2){t.setVerticesData(e.VertexBuffer.UV2Kind,this.uvs2,i)}if(this.uvs3){t.setVerticesData(e.VertexBuffer.UV3Kind,this.uvs3,i)}if(this.uvs4){t.setVerticesData(e.VertexBuffer.UV4Kind,this.uvs4,i)}if(this.uvs5){t.setVerticesData(e.VertexBuffer.UV5Kind,this.uvs5,i)}if(this.uvs6){t.setVerticesData(e.VertexBuffer.UV6Kind,this.uvs6,i)}if(this.colors){t.setVerticesData(e.VertexBuffer.ColorKind,this.colors,i)}if(this.matricesIndices){t.setVerticesData(e.VertexBuffer.MatricesIndicesKind,this.matricesIndices,i)}if(this.matricesWeights){t.setVerticesData(e.VertexBuffer.MatricesWeightsKind,this.matricesWeights,i)}if(this.matricesIndicesExtra){t.setVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,i)}if(this.matricesWeightsExtra){t.setVerticesData(e.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,i)}if(this.indices){t.setIndices(this.indices,null,i)}return this};t.prototype._update=function(t,i,r){if(this.positions){t.updateVerticesData(e.VertexBuffer.PositionKind,this.positions,i,r)}if(this.normals){t.updateVerticesData(e.VertexBuffer.NormalKind,this.normals,i,r)}if(this.tangents){t.updateVerticesData(e.VertexBuffer.TangentKind,this.tangents,i,r)}if(this.uvs){t.updateVerticesData(e.VertexBuffer.UVKind,this.uvs,i,r)}if(this.uvs2){t.updateVerticesData(e.VertexBuffer.UV2Kind,this.uvs2,i,r)}if(this.uvs3){t.updateVerticesData(e.VertexBuffer.UV3Kind,this.uvs3,i,r)}if(this.uvs4){t.updateVerticesData(e.VertexBuffer.UV4Kind,this.uvs4,i,r)}if(this.uvs5){t.updateVerticesData(e.VertexBuffer.UV5Kind,this.uvs5,i,r)}if(this.uvs6){t.updateVerticesData(e.VertexBuffer.UV6Kind,this.uvs6,i,r)}if(this.colors){t.updateVerticesData(e.VertexBuffer.ColorKind,this.colors,i,r)}if(this.matricesIndices){t.updateVerticesData(e.VertexBuffer.MatricesIndicesKind,this.matricesIndices,i,r)}if(this.matricesWeights){t.updateVerticesData(e.VertexBuffer.MatricesWeightsKind,this.matricesWeights,i,r)}if(this.matricesIndicesExtra){t.updateVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,i,r)}if(this.matricesWeightsExtra){t.updateVerticesData(e.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,i,r)}if(this.indices){t.setIndices(this.indices,null)}return this};t.prototype.transform=function(t){var i=e.Vector3.Zero();var r;if(this.positions){var n=e.Vector3.Zero();for(r=0;r<this.positions.length;r+=3){e.Vector3.FromArrayToRef(this.positions,r,n);e.Vector3.TransformCoordinatesToRef(n,t,i);this.positions[r]=i.x;this.positions[r+1]=i.y;this.positions[r+2]=i.z}}if(this.normals){var o=e.Vector3.Zero();for(r=0;r<this.normals.length;r+=3){e.Vector3.FromArrayToRef(this.normals,r,o);e.Vector3.TransformNormalToRef(o,t,i);this.normals[r]=i.x;this.normals[r+1]=i.y;this.normals[r+2]=i.z}}if(this.tangents){var s=e.Vector4.Zero();var a=e.Vector4.Zero();for(r=0;r<this.tangents.length;r+=4){e.Vector4.FromArrayToRef(this.tangents,r,s);e.Vector4.TransformNormalToRef(s,t,a);this.tangents[r]=a.x;this.tangents[r+1]=a.y;this.tangents[r+2]=a.z;this.tangents[r+3]=a.w}}return this};t.prototype.merge=function(e){this._validate();e._validate();if(!this.normals!==!e.normals||!this.tangents!==!e.tangents||!this.uvs!==!e.uvs||!this.uvs2!==!e.uvs2||!this.uvs3!==!e.uvs3||!this.uvs4!==!e.uvs4||!this.uvs5!==!e.uvs5||!this.uvs6!==!e.uvs6||!this.colors!==!e.colors||!this.matricesIndices!==!e.matricesIndices||!this.matricesWeights!==!e.matricesWeights||!this.matricesIndicesExtra!==!e.matricesIndicesExtra||!this.matricesWeightsExtra!==!e.matricesWeightsExtra){throw new Error("Cannot merge vertex data that do not have the same set of attributes")}if(e.indices){if(!this.indices){this.indices=[]}var t=this.positions?this.positions.length/3:0;for(var i=0;i<e.indices.length;i++){this.indices.push(e.indices[i]+t)}}this.positions=this._mergeElement(this.positions,e.positions);this.normals=this._mergeElement(this.normals,e.normals);this.tangents=this._mergeElement(this.tangents,e.tangents);this.uvs=this._mergeElement(this.uvs,e.uvs);this.uvs2=this._mergeElement(this.uvs2,e.uvs2);this.uvs3=this._mergeElement(this.uvs3,e.uvs3);this.uvs4=this._mergeElement(this.uvs4,e.uvs4);this.uvs5=this._mergeElement(this.uvs5,e.uvs5);this.uvs6=this._mergeElement(this.uvs6,e.uvs6);this.colors=this._mergeElement(this.colors,e.colors);this.matricesIndices=this._mergeElement(this.matricesIndices,e.matricesIndices);this.matricesWeights=this._mergeElement(this.matricesWeights,e.matricesWeights);this.matricesIndicesExtra=this._mergeElement(this.matricesIndicesExtra,e.matricesIndicesExtra);this.matricesWeightsExtra=this._mergeElement(this.matricesWeightsExtra,e.matricesWeightsExtra);return this};t.prototype._mergeElement=function(e,t){if(!e){return t}if(!t){return e}var i=t.length+e.length;var r=e instanceof Float32Array;var n=t instanceof Float32Array;if(r){var o=new Float32Array(i);o.set(e);o.set(t,e.length);return o}else if(!n){return e.concat(t)}else{var s=e.slice(0);for(var a=0,i=t.length;a<i;a++){s.push(t[a])}return s}};t.prototype._validate=function(){if(!this.positions){throw new Error("Positions are required")}var t=function(t,i){var r=e.VertexBuffer.DeduceStride(t);if(i.length%r!==0){throw new Error("The "+t+"s array count must be a multiple of "+r)}return i.length/r};var i=t(e.VertexBuffer.PositionKind,this.positions);var r=function(e,r){var n=t(e,r);if(n!==i){throw new Error("The "+e+"s element count ("+n+") does not match the positions count ("+i+")")}};if(this.normals)r(e.VertexBuffer.NormalKind,this.normals);if(this.tangents)r(e.VertexBuffer.TangentKind,this.tangents);if(this.uvs)r(e.VertexBuffer.UVKind,this.uvs);if(this.uvs2)r(e.VertexBuffer.UV2Kind,this.uvs2);if(this.uvs3)r(e.VertexBuffer.UV3Kind,this.uvs3);if(this.uvs4)r(e.VertexBuffer.UV4Kind,this.uvs4);if(this.uvs5)r(e.VertexBuffer.UV5Kind,this.uvs5);if(this.uvs6)r(e.VertexBuffer.UV6Kind,this.uvs6);if(this.colors)r(e.VertexBuffer.ColorKind,this.colors);if(this.matricesIndices)r(e.VertexBuffer.MatricesIndicesKind,this.matricesIndices);if(this.matricesWeights)r(e.VertexBuffer.MatricesWeightsKind,this.matricesWeights);if(this.matricesIndicesExtra)r(e.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra);if(this.matricesWeightsExtra)r(e.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra)};t.prototype.serialize=function(){var e=this.serialize();if(this.positions){e.positions=this.positions}if(this.normals){e.normals=this.normals}if(this.tangents){e.tangents=this.tangents}if(this.uvs){e.uvs=this.uvs}if(this.uvs2){e.uvs2=this.uvs2}if(this.uvs3){e.uvs3=this.uvs3}if(this.uvs4){e.uvs4=this.uvs4}if(this.uvs5){e.uvs5=this.uvs5}if(this.uvs6){e.uvs6=this.uvs6}if(this.colors){e.colors=this.colors}if(this.matricesIndices){e.matricesIndices=this.matricesIndices;e.matricesIndices._isExpanded=true}if(this.matricesWeights){e.matricesWeights=this.matricesWeights}if(this.matricesIndicesExtra){e.matricesIndicesExtra=this.matricesIndicesExtra;e.matricesIndicesExtra._isExpanded=true}if(this.matricesWeightsExtra){e.matricesWeightsExtra=this.matricesWeightsExtra}e.indices=this.indices;return e};t.ExtractFromMesh=function(e,i,r){return t._ExtractFrom(e,i,r)};t.ExtractFromGeometry=function(e,i,r){return t._ExtractFrom(e,i,r)};t._ExtractFrom=function(i,r,n){var o=new t;if(i.isVerticesDataPresent(e.VertexBuffer.PositionKind)){o.positions=i.getVerticesData(e.VertexBuffer.PositionKind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.NormalKind)){o.normals=i.getVerticesData(e.VertexBuffer.NormalKind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.TangentKind)){o.tangents=i.getVerticesData(e.VertexBuffer.TangentKind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.UVKind)){o.uvs=i.getVerticesData(e.VertexBuffer.UVKind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.UV2Kind)){o.uvs2=i.getVerticesData(e.VertexBuffer.UV2Kind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.UV3Kind)){o.uvs3=i.getVerticesData(e.VertexBuffer.UV3Kind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.UV4Kind)){o.uvs4=i.getVerticesData(e.VertexBuffer.UV4Kind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.UV5Kind)){o.uvs5=i.getVerticesData(e.VertexBuffer.UV5Kind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.UV6Kind)){o.uvs6=i.getVerticesData(e.VertexBuffer.UV6Kind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.ColorKind)){o.colors=i.getVerticesData(e.VertexBuffer.ColorKind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)){o.matricesIndices=i.getVerticesData(e.VertexBuffer.MatricesIndicesKind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind)){o.matricesWeights=i.getVerticesData(e.VertexBuffer.MatricesWeightsKind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesExtraKind)){o.matricesIndicesExtra=i.getVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,r,n)}if(i.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsExtraKind)){o.matricesWeightsExtra=i.getVerticesData(e.VertexBuffer.MatricesWeightsExtraKind,r,n)}o.indices=i.getIndices(r);return o};t.CreateRibbon=function(i){var r=i.pathArray;var n=i.closeArray||false;var o=i.closePath||false;var s=i.invertUV||false;var a=Math.floor(r[0].length/2);var u=i.offset||a;u=u>a?a:Math.floor(u);var l=i.sideOrientation===0?0:i.sideOrientation||e.Mesh.DEFAULTSIDE;var c=i.uvs;var h=i.colors;var f=[];var d=[];var p=[];var _=[];var m=[];var g=[];var v=[];var y=[];var b;var x=[];var T=[];var E;var P;var A;if(r.length<2){var M=[];var S=[]
;for(P=0;P<r[0].length-u;P++){M.push(r[0][P]);S.push(r[0][P+u])}r=[M,S]}var C=0;var R=o?1:0;var O;var I;b=r[0].length;var D;var w;for(E=0;E<r.length;E++){v[E]=0;m[E]=[0];O=r[E];I=O.length;b=b<I?b:I;A=0;while(A<I){f.push(O[A].x,O[A].y,O[A].z);if(A>0){D=O[A].subtract(O[A-1]).length();w=D+v[E];m[E].push(w);v[E]=w}A++}if(o){A--;f.push(O[0].x,O[0].y,O[0].z);D=O[A].subtract(O[0]).length();w=D+v[E];m[E].push(w);v[E]=w}x[E]=I+R;T[E]=C;C+=I+R}var L;var F;var B=null;var V=null;for(P=0;P<b+R;P++){y[P]=0;g[P]=[0];for(E=0;E<r.length-1;E++){L=r[E];F=r[E+1];if(P===b){B=L[0];V=F[0]}else{B=L[P];V=F[P]}D=V.subtract(B).length();w=D+y[P];g[P].push(w);y[P]=w}if(n&&V&&B){L=r[E];F=r[0];if(P===b){V=F[0]}D=V.subtract(B).length();w=D+y[P];y[P]=w}}var N;var U;if(c){for(E=0;E<c.length;E++){_.push(c[E].x,c[E].y)}}else{for(E=0;E<r.length;E++){for(P=0;P<b+R;P++){N=v[E]!=0?m[E][P]/v[E]:0;U=y[P]!=0?g[P][E]/y[P]:0;if(s){_.push(U,N)}else{_.push(N,U)}}}}E=0;var k=0;var z=x[E]-1;var G=x[E+1]-1;var W=z<G?z:G;var H=T[1]-T[0];var j=n?x.length:x.length-1;while(k<=W&&E<j){d.push(k,k+H,k+1);d.push(k+H+1,k+1,k+H);k+=1;if(k===W){E++;if(E===x.length-1){H=T[0]-T[E];z=x[E]-1;G=x[0]-1}else{H=T[E+1]-T[E];z=x[E]-1;G=x[E+1]-1}k=T[E];W=z<G?z+k:G+k}}t.ComputeNormals(f,d,p);if(o){var X=0;var Y=0;for(E=0;E<r.length;E++){X=T[E]*3;if(E+1<r.length){Y=(T[E+1]-1)*3}else{Y=p.length-3}p[X]=(p[X]+p[Y])*.5;p[X+1]=(p[X+1]+p[Y+1])*.5;p[X+2]=(p[X+2]+p[Y+2])*.5;p[Y]=p[X];p[Y+1]=p[X+1];p[Y+2]=p[X+2]}}t._ComputeSides(l,f,d,p,_,i.frontUVs,i.backUVs);var K=null;if(h){K=new Float32Array(h.length*4);for(var Q=0;Q<h.length;Q++){K[Q*4]=h[Q].r;K[Q*4+1]=h[Q].g;K[Q*4+2]=h[Q].b;K[Q*4+3]=h[Q].a}}var Z=new t;var q=new Float32Array(f);var J=new Float32Array(p);var $=new Float32Array(_);Z.indices=d;Z.positions=q;Z.normals=J;Z.uvs=$;if(K){Z.set(K,e.VertexBuffer.ColorKind)}if(o){Z._idx=T}return Z};t.CreateBox=function(i){var r=[new e.Vector3(0,0,1),new e.Vector3(0,0,-1),new e.Vector3(1,0,0),new e.Vector3(-1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,-1,0)];var n=[];var o=[];var s=[];var a=[];var u=i.width||i.size||1;var l=i.height||i.size||1;var c=i.depth||i.size||1;var h=i.sideOrientation===0?0:i.sideOrientation||e.Mesh.DEFAULTSIDE;var f=i.faceUV||new Array(6);var d=i.faceColors;var p=[];for(var _=0;_<6;_++){if(f[_]===undefined){f[_]=new e.Vector4(0,0,1,1)}if(d&&d[_]===undefined){d[_]=new e.Color4(1,1,1,1)}}var m=new e.Vector3(u/2,l/2,c/2);for(var g=0;g<r.length;g++){var v=r[g];var y=new e.Vector3(v.y,v.z,v.x);var b=e.Vector3.Cross(v,y);var x=o.length/3;n.push(x);n.push(x+1);n.push(x+2);n.push(x);n.push(x+2);n.push(x+3);var T=v.subtract(y).subtract(b).multiply(m);o.push(T.x,T.y,T.z);s.push(v.x,v.y,v.z);a.push(f[g].z,f[g].w);if(d){p.push(d[g].r,d[g].g,d[g].b,d[g].a)}T=v.subtract(y).add(b).multiply(m);o.push(T.x,T.y,T.z);s.push(v.x,v.y,v.z);a.push(f[g].x,f[g].w);if(d){p.push(d[g].r,d[g].g,d[g].b,d[g].a)}T=v.add(y).add(b).multiply(m);o.push(T.x,T.y,T.z);s.push(v.x,v.y,v.z);a.push(f[g].x,f[g].y);if(d){p.push(d[g].r,d[g].g,d[g].b,d[g].a)}T=v.add(y).subtract(b).multiply(m);o.push(T.x,T.y,T.z);s.push(v.x,v.y,v.z);a.push(f[g].z,f[g].y);if(d){p.push(d[g].r,d[g].g,d[g].b,d[g].a)}}t._ComputeSides(h,o,n,s,a,i.frontUVs,i.backUVs);var E=new t;E.indices=n;E.positions=o;E.normals=s;E.uvs=a;if(d){var P=h===e.Mesh.DOUBLESIDE?p.concat(p):p;E.colors=P}return E};t.CreateSphere=function(i){var r=i.segments||32;var n=i.diameterX||i.diameter||1;var o=i.diameterY||i.diameter||1;var s=i.diameterZ||i.diameter||1;var a=i.arc&&(i.arc<=0||i.arc>1)?1:i.arc||1;var u=i.slice&&i.slice<=0?1:i.slice||1;var l=i.sideOrientation===0?0:i.sideOrientation||e.Mesh.DEFAULTSIDE;var c=new e.Vector3(n/2,o/2,s/2);var h=2+r;var f=2*h;var d=[];var p=[];var _=[];var m=[];for(var g=0;g<=h;g++){var v=g/h;var y=v*Math.PI*u;for(var b=0;b<=f;b++){var x=b/f;var T=x*Math.PI*2*a;var E=e.Matrix.RotationZ(-y);var P=e.Matrix.RotationY(T);var A=e.Vector3.TransformCoordinates(e.Vector3.Up(),E);var M=e.Vector3.TransformCoordinates(A,P);var S=M.multiply(c);var C=M.divide(c).normalize();p.push(S.x,S.y,S.z);_.push(C.x,C.y,C.z);m.push(x,v)}if(g>0){var R=p.length/3;for(var O=R-2*(f+1);O+f+2<R;O++){d.push(O);d.push(O+1);d.push(O+f+1);d.push(O+f+1);d.push(O+1);d.push(O+f+2)}}}t._ComputeSides(l,p,d,_,m,i.frontUVs,i.backUVs);var I=new t;I.indices=d;I.positions=p;I.normals=_;I.uvs=m;return I};t.CreateCylinder=function(i){var r=i.height||2;var n=i.diameterTop===0?0:i.diameterTop||i.diameter||1;var o=i.diameterBottom===0?0:i.diameterBottom||i.diameter||1;var s=i.tessellation||24;var a=i.subdivisions||1;var u=i.hasRings?true:false;var l=i.enclose?true:false;var c=i.arc&&(i.arc<=0||i.arc>1)?1:i.arc||1;var h=i.sideOrientation===0?0:i.sideOrientation||e.Mesh.DEFAULTSIDE;var f=i.faceUV||new Array(3);var d=i.faceColors;var p=c!==1&&l?2:0;var _=u?a:1;var m=2+(1+p)*_;var g;for(g=0;g<m;g++){if(d&&d[g]===undefined){d[g]=new e.Color4(1,1,1,1)}}for(g=0;g<m;g++){if(f&&f[g]===undefined){f[g]=new e.Vector4(0,0,1,1)}}var v=new Array;var y=new Array;var b=new Array;var x=new Array;var T=new Array;var E=Math.PI*2*c/s;var P;var A;var M;var S=(o-n)/2/r;var C=e.Vector3.Zero();var R=e.Vector3.Zero();var O=e.Vector3.Zero();var I=e.Vector3.Zero();var D=e.Vector3.Zero();var w=e.Axis.Y;var L;var F;var B;var V=1;var N=1;var U=0;var k=0;for(L=0;L<=a;L++){A=L/a;M=(A*(n-o)+o)/2;V=u&&L!==0&&L!==a?2:1;for(B=0;B<V;B++){if(u){N+=B}if(l){N+=2*B}for(F=0;F<=s;F++){P=F*E;C.x=Math.cos(-P)*M;C.y=-r/2+A*r;C.z=Math.sin(-P)*M;if(n===0&&L===a){R.x=b[b.length-(s+1)*3];R.y=b[b.length-(s+1)*3+1];R.z=b[b.length-(s+1)*3+2]}else{R.x=C.x;R.z=C.z;R.y=Math.sqrt(R.x*R.x+R.z*R.z)*S;R.normalize()}if(F===0){O.copyFrom(C);I.copyFrom(R)}y.push(C.x,C.y,C.z);b.push(R.x,R.y,R.z);if(u){k=U!==N?f[N].y:f[N].w}else{k=f[N].y+(f[N].w-f[N].y)*A}x.push(f[N].x+(f[N].z-f[N].x)*F/s,k);if(d){T.push(d[N].r,d[N].g,d[N].b,d[N].a)}}if(c!==1&&l){y.push(C.x,C.y,C.z);y.push(0,C.y,0);y.push(0,C.y,0);y.push(O.x,O.y,O.z);e.Vector3.CrossToRef(w,R,D);D.normalize();b.push(D.x,D.y,D.z,D.x,D.y,D.z);e.Vector3.CrossToRef(I,w,D);D.normalize();b.push(D.x,D.y,D.z,D.x,D.y,D.z);if(u){k=U!==N?f[N+1].y:f[N+1].w}else{k=f[N+1].y+(f[N+1].w-f[N+1].y)*A}x.push(f[N+1].x,k);x.push(f[N+1].z,k);if(u){k=U!==N?f[N+2].y:f[N+2].w}else{k=f[N+2].y+(f[N+2].w-f[N+2].y)*A}x.push(f[N+2].x,k);x.push(f[N+2].z,k);if(d){T.push(d[N+1].r,d[N+1].g,d[N+1].b,d[N+1].a);T.push(d[N+1].r,d[N+1].g,d[N+1].b,d[N+1].a);T.push(d[N+2].r,d[N+2].g,d[N+2].b,d[N+2].a);T.push(d[N+2].r,d[N+2].g,d[N+2].b,d[N+2].a)}}if(U!==N){U=N}}}var z=c!==1&&l?s+4:s;var N;L=0;for(N=0;N<a;N++){var G=0;var W=0;var H=0;var j=0;for(F=0;F<s;F++){G=L*(z+1)+F;W=(L+1)*(z+1)+F;H=L*(z+1)+(F+1);j=(L+1)*(z+1)+(F+1);v.push(G,W,H);v.push(j,H,W)}if(c!==1&&l){v.push(G+2,W+2,H+2);v.push(j+2,H+2,W+2);v.push(G+4,W+4,H+4);v.push(j+4,H+4,W+4)}L=u?L+2:L+1}var X=function(t){var i=t?n/2:o/2;if(i===0){return}var a;var u;var l;var h=t?f[m-1]:f[0];var p=null;if(d){p=t?d[m-1]:d[0]}var _=y.length/3;var g=t?r/2:-r/2;var E=new e.Vector3(0,g,0);y.push(E.x,E.y,E.z);b.push(0,t?1:-1,0);x.push(h.x+(h.z-h.x)*.5,h.y+(h.w-h.y)*.5);if(p){T.push(p.r,p.g,p.b,p.a)}var P=new e.Vector2(.5,.5);for(l=0;l<=s;l++){a=Math.PI*2*l*c/s;var A=Math.cos(-a);var M=Math.sin(-a);u=new e.Vector3(A*i,g,M*i);var S=new e.Vector2(A*P.x+.5,M*P.y+.5);y.push(u.x,u.y,u.z);b.push(0,t?1:-1,0);x.push(h.x+(h.z-h.x)*S.x,h.y+(h.w-h.y)*S.y);if(p){T.push(p.r,p.g,p.b,p.a)}}for(l=0;l<s;l++){if(!t){v.push(_);v.push(_+(l+1));v.push(_+(l+2))}else{v.push(_);v.push(_+(l+2));v.push(_+(l+1))}}};X(false);X(true);t._ComputeSides(h,y,v,b,x,i.frontUVs,i.backUVs);var Y=new t;Y.indices=v;Y.positions=y;Y.normals=b;Y.uvs=x;if(d){Y.colors=T}return Y};t.CreateTorus=function(i){var r=[];var n=[];var o=[];var s=[];var a=i.diameter||1;var u=i.thickness||.5;var l=i.tessellation||16;var c=i.sideOrientation===0?0:i.sideOrientation||e.Mesh.DEFAULTSIDE;var h=l+1;for(var f=0;f<=l;f++){var d=f/l;var p=f*Math.PI*2/l-Math.PI/2;var _=e.Matrix.Translation(a/2,0,0).multiply(e.Matrix.RotationY(p));for(var m=0;m<=l;m++){var g=1-m/l;var v=m*Math.PI*2/l+Math.PI;var y=Math.cos(v);var b=Math.sin(v);var x=new e.Vector3(y,b,0);var T=x.scale(u/2);var E=new e.Vector2(d,g);T=e.Vector3.TransformCoordinates(T,_);x=e.Vector3.TransformNormal(x,_);n.push(T.x,T.y,T.z);o.push(x.x,x.y,x.z);s.push(E.x,E.y);var P=(f+1)%h;var A=(m+1)%h;r.push(f*h+m);r.push(f*h+A);r.push(P*h+m);r.push(f*h+A);r.push(P*h+A);r.push(P*h+m)}}t._ComputeSides(c,n,r,o,s,i.frontUVs,i.backUVs);var M=new t;M.indices=r;M.positions=n;M.normals=o;M.uvs=s;return M};t.CreateLineSystem=function(e){var i=[];var r=[];var n=e.lines;var o=e.colors;var s=[];var a=0;for(var u=0;u<n.length;u++){var l=n[u];for(var c=0;c<l.length;c++){r.push(l[c].x,l[c].y,l[c].z);if(o){var h=o[u];s.push(h[c].r,h[c].g,h[c].b,h[c].a)}if(c>0){i.push(a-1);i.push(a)}a++}}var f=new t;f.indices=i;f.positions=r;if(o){f.colors=s}return f};t.CreateDashedLines=function(i){var r=i.dashSize||3;var n=i.gapSize||1;var o=i.dashNb||200;var s=i.points;var a=new Array;var u=new Array;var l=e.Vector3.Zero();var c=0;var h=0;var f=0;var d=0;var p=0;var _=0;var m=0;for(m=0;m<s.length-1;m++){s[m+1].subtractToRef(s[m],l);c+=l.length()}f=c/o;d=r*f/(r+n);for(m=0;m<s.length-1;m++){s[m+1].subtractToRef(s[m],l);h=Math.floor(l.length()/f);l.normalize();for(var g=0;g<h;g++){p=f*g;a.push(s[m].x+p*l.x,s[m].y+p*l.y,s[m].z+p*l.z);a.push(s[m].x+(p+d)*l.x,s[m].y+(p+d)*l.y,s[m].z+(p+d)*l.z);u.push(_,_+1);_+=2}}var v=new t;v.positions=a;v.indices=u;return v};t.CreateGround=function(i){var r=[];var n=[];var o=[];var s=[];var a,u;var l=i.width||1;var c=i.height||1;var h=i.subdivisionsX||i.subdivisions||1;var f=i.subdivisionsY||i.subdivisions||1;for(a=0;a<=f;a++){for(u=0;u<=h;u++){var d=new e.Vector3(u*l/h-l/2,0,(f-a)*c/f-c/2);var p=new e.Vector3(0,1,0);n.push(d.x,d.y,d.z);o.push(p.x,p.y,p.z);s.push(u/h,1-a/f)}}for(a=0;a<f;a++){for(u=0;u<h;u++){r.push(u+1+(a+1)*(h+1));r.push(u+1+a*(h+1));r.push(u+a*(h+1));r.push(u+(a+1)*(h+1));r.push(u+1+(a+1)*(h+1));r.push(u+a*(h+1))}}var _=new t;_.indices=r;_.positions=n;_.normals=o;_.uvs=s;return _};t.CreateTiledGround=function(i){var r=i.xmin!==undefined&&i.xmin!==null?i.xmin:-1;var n=i.zmin!==undefined&&i.zmin!==null?i.zmin:-1;var o=i.xmax!==undefined&&i.xmax!==null?i.xmax:1;var s=i.zmax!==undefined&&i.zmax!==null?i.zmax:1;var a=i.subdivisions||{w:1,h:1};var u=i.precision||{w:1,h:1};var l=new Array;var c=new Array;var h=new Array;var f=new Array;var d,p,_,m;a.h=a.h<1?1:a.h;a.w=a.w<1?1:a.w;u.w=u.w<1?1:u.w;u.h=u.h<1?1:u.h;var g={w:(o-r)/a.w,h:(s-n)/a.h};function v(t,i,r,n){var o=c.length/3;var s=u.w+1;for(d=0;d<u.h;d++){for(p=0;p<u.w;p++){var a=[o+p+d*s,o+(p+1)+d*s,o+(p+1)+(d+1)*s,o+p+(d+1)*s];l.push(a[1]);l.push(a[2]);l.push(a[3]);l.push(a[0]);l.push(a[1]);l.push(a[3])}}var _=e.Vector3.Zero();var m=new e.Vector3(0,1,0);for(d=0;d<=u.h;d++){_.z=d*(n-i)/u.h+i;for(p=0;p<=u.w;p++){_.x=p*(r-t)/u.w+t;_.y=0;c.push(_.x,_.y,_.z);h.push(m.x,m.y,m.z);f.push(p/u.w,d/u.h)}}}for(_=0;_<a.h;_++){for(m=0;m<a.w;m++){v(r+m*g.w,n+_*g.h,r+(m+1)*g.w,n+(_+1)*g.h)}}var y=new t;y.indices=l;y.positions=c;y.normals=h;y.uvs=f;return y};t.CreateGroundFromHeightMap=function(i){var r=[];var n=[];var o=[];var s=[];var a,u;var l=i.colorFilter||new e.Color3(.3,.59,.11);for(a=0;a<=i.subdivisions;a++){for(u=0;u<=i.subdivisions;u++){var c=new e.Vector3(u*i.width/i.subdivisions-i.width/2,0,(i.subdivisions-a)*i.height/i.subdivisions-i.height/2);var h=(c.x+i.width/2)/i.width*(i.bufferWidth-1)|0;var f=(1-(c.z+i.height/2)/i.height)*(i.bufferHeight-1)|0;var d=(h+f*i.bufferWidth)*4;var p=i.buffer[d]/255;var _=i.buffer[d+1]/255;var m=i.buffer[d+2]/255;var g=p*l.r+_*l.g+m*l.b;c.y=i.minHeight+(i.maxHeight-i.minHeight)*g;n.push(c.x,c.y,c.z);o.push(0,0,0);s.push(u/i.subdivisions,1-a/i.subdivisions)}}for(a=0;a<i.subdivisions;a++){for(u=0;u<i.subdivisions;u++){r.push(u+1+(a+1)*(i.subdivisions+1));r.push(u+1+a*(i.subdivisions+1));r.push(u+a*(i.subdivisions+1));r.push(u+(a+1)*(i.subdivisions+1));r.push(u+1+(a+1)*(i.subdivisions+1));r.push(u+a*(i.subdivisions+1))}}t.ComputeNormals(n,r,o);var v=new t;v.indices=r;v.positions=n;v.normals=o;v.uvs=s;return v};t.CreatePlane=function(i){var r=[];var n=[];var o=[];var s=[];var a=i.width||i.size||1;var u=i.height||i.size||1;var l=i.sideOrientation===0?0:i.sideOrientation||e.Mesh.DEFAULTSIDE;var c=a/2;var h=u/2;n.push(-c,-h,0);o.push(0,0,-1);s.push(0,0);n.push(c,-h,0);o.push(0,0,-1);s.push(1,0);n.push(c,h,0);o.push(0,0,-1);s.push(1,1);n.push(-c,h,0);o.push(0,0,-1);s.push(0,1);r.push(0);r.push(1);r.push(2);r.push(0);r.push(2);r.push(3);t._ComputeSides(l,n,r,o,s,i.frontUVs,i.backUVs);var f=new t;f.indices=r;f.positions=n;f.normals=o;f.uvs=s;return f};t.CreateDisc=function(i){var r=new Array;var n=new Array;var o=new Array;var s=new Array;var a=i.radius||.5;var u=i.tessellation||64;var l=i.arc&&(i.arc<=0||i.arc>1)?1:i.arc||1;var c=i.sideOrientation===0?0:i.sideOrientation||e.Mesh.DEFAULTSIDE;r.push(0,0,0);s.push(.5,.5);var h=Math.PI*2*l;var f=h/u;for(var d=0;d<h;d+=f){var p=Math.cos(d);var _=Math.sin(d);var m=(p+1)/2;var g=(1-_)/2;r.push(a*p,a*_,0);s.push(m,g)}if(l===1){r.push(r[3],r[4],r[5]);s.push(s[2],s[3])}var v=r.length/3;for(var y=1;y<v-1;y++){n.push(y+1,0,y)}t.ComputeNormals(r,n,o);t._ComputeSides(c,r,n,o,s,i.frontUVs,i.backUVs);var b=new t;b.indices=n;b.positions=r;b.normals=o;b.uvs=s;return b};t.CreatePolygon=function(i,r,n,o,s,a){var u=n||new Array(3);var l=o;var c=[];for(var h=0;h<3;h++){if(u[h]===undefined){u[h]=new e.Vector4(0,0,1,1)}if(l&&l[h]===undefined){l[h]=new e.Color4(1,1,1,1)}}var f=i.getVerticesData(e.VertexBuffer.PositionKind);var d=i.getVerticesData(e.VertexBuffer.NormalKind);var p=i.getVerticesData(e.VertexBuffer.UVKind);var _=i.getIndices();var m=0;var g=0;for(var v=0;v<d.length;v+=3){if(Math.abs(d[v+1])<.001){g=1}if(Math.abs(d[v+1]-1)<.001){g=0}if(Math.abs(d[v+1]+1)<.001){g=2}m=v/3;p[2*m]=(1-p[2*m])*u[g].x+p[2*m]*u[g].z;p[2*m+1]=(1-p[2*m+1])*u[g].y+p[2*m+1]*u[g].w;if(l){c.push(l[g].r,l[g].g,l[g].b,l[g].a)}}t._ComputeSides(r,f,_,d,p,s,a);var y=new t;y.indices=_;y.positions=f;y.normals=d;y.uvs=p;if(l){var b=r===e.Mesh.DOUBLESIDE?c.concat(c):c;y.colors=b}return y};t.CreateIcoSphere=function(i){var r=i.sideOrientation||e.Mesh.DEFAULTSIDE;var n=i.radius||1;var o=i.flat===undefined?true:i.flat;var s=i.subdivisions||4;var a=i.radiusX||n;var u=i.radiusY||n;var l=i.radiusZ||n;var c=(1+Math.sqrt(5))/2;var h=[-1,c,-0,1,c,0,-1,-c,0,1,-c,0,0,-1,-c,0,1,-c,0,-1,c,0,1,c,c,0,1,c,0,-1,-c,0,1,-c,0,-1];var f=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1];var d=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11];var p=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4];var _=138/1024;var m=239/1024;var g=60/1024;var v=26/1024;var y=-40/1024;var b=+20/1024;var x=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0];var T=new Array;var E=new Array;var P=new Array;var A=new Array;var M=0;var S=new Array(3);var C=new Array(3);var R;for(R=0;R<3;R++){S[R]=e.Vector3.Zero();C[R]=e.Vector2.Zero()}for(var O=0;O<20;O++){for(R=0;R<3;R++){var I=f[3*O+R];S[R].copyFromFloats(h[3*d[I]],h[3*d[I]+1],h[3*d[I]+2]);S[R].normalize().scaleInPlace(n);C[R].copyFromFloats(p[2*I]*_+g+x[O]*y,p[2*I+1]*m+v+x[O]*b)}var D=function(t,i,r,n){var c=e.Vector3.Lerp(S[0],S[2],i/s);var h=e.Vector3.Lerp(S[1],S[2],i/s);var f=s===i?S[2]:e.Vector3.Lerp(c,h,t/(s-i));f.normalize();var d;if(o){var p=e.Vector3.Lerp(S[0],S[2],n/s);var _=e.Vector3.Lerp(S[1],S[2],n/s);d=e.Vector3.Lerp(p,_,r/(s-n))}else{d=new e.Vector3(f.x,f.y,f.z)}d.x/=a;d.y/=u;d.z/=l;d.normalize();var m=e.Vector2.Lerp(C[0],C[2],i/s);var g=e.Vector2.Lerp(C[1],C[2],i/s);var v=s===i?C[2]:e.Vector2.Lerp(m,g,t/(s-i));E.push(f.x*a,f.y*u,f.z*l);P.push(d.x,d.y,d.z);A.push(v.x,v.y);T.push(M);M++};for(var w=0;w<s;w++){for(var L=0;L+w<s;L++){D(L,w,L+1/3,w+1/3);D(L+1,w,L+1/3,w+1/3);D(L,w+1,L+1/3,w+1/3);if(L+w+1<s){D(L+1,w,L+2/3,w+2/3);D(L+1,w+1,L+2/3,w+2/3);D(L,w+1,L+2/3,w+2/3)}}}}t._ComputeSides(r,E,T,P,A,i.frontUVs,i.backUVs);var F=new t;F.indices=T;F.positions=E;F.normals=P;F.uvs=A;return F};t.CreatePolyhedron=function(i){var r=[];r[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]};r[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]};r[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]};r[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]};r[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]};r[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]};r[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]};r[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]};r[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]};r[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]};r[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]};r[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]};r[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]};r[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]};r[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};var n=i.type&&(i.type<0||i.type>=r.length)?0:i.type||0;var o=i.size;var s=i.sizeX||o||1;var a=i.sizeY||o||1;var u=i.sizeZ||o||1;var l=i.custom||r[n];var c=l.face.length;var h=i.faceUV||new Array(c);var f=i.faceColors;var d=i.flat===undefined?true:i.flat;var p=i.sideOrientation===0?0:i.sideOrientation||e.Mesh.DEFAULTSIDE;var _=new Array;var m=new Array;var g=new Array;var v=new Array;var y=new Array;var b=0;var x=0;var T=new Array;var E=0;var P=0;var A,M,S,C,R,O;if(d){for(P=0;P<c;P++){if(f&&f[P]===undefined){f[P]=new e.Color4(1,1,1,1)}if(h&&h[P]===undefined){h[P]=new e.Vector4(0,0,1,1)}}}if(!d){for(E=0;E<l.vertex.length;E++){_.push(l.vertex[E][0]*s,l.vertex[E][1]*a,l.vertex[E][2]*u);v.push(0,0)}for(P=0;P<c;P++){for(E=0;E<l.face[P].length-2;E++){m.push(l.face[P][0],l.face[P][E+2],l.face[P][E+1])}}}else{for(P=0;P<c;P++){var I=l.face[P].length;S=2*Math.PI/I;C=.5*Math.tan(S/2);R=.5;for(E=0;E<I;E++){_.push(l.vertex[l.face[P][E]][0]*s,l.vertex[l.face[P][E]][1]*a,l.vertex[l.face[P][E]][2]*u);T.push(b);b++;A=h[P].x+(h[P].z-h[P].x)*(.5+C);M=h[P].y+(h[P].w-h[P].y)*(R-.5);v.push(A,M);O=C*Math.cos(S)-R*Math.sin(S);R=C*Math.sin(S)+R*Math.cos(S);C=O;if(f){y.push(f[P].r,f[P].g,f[P].b,f[P].a)}}for(E=0;E<I-2;E++){m.push(T[0+x],T[E+2+x],T[E+1+x])}x+=I}}t.ComputeNormals(_,m,g);t._ComputeSides(p,_,m,g,v,i.frontUVs,i.backUVs);var D=new t;D.positions=_;D.indices=m;D.normals=g;D.uvs=v;if(f&&d){D.colors=y}return D};t.CreateTorusKnot=function(i){var r=new Array;var n=new Array;var o=new Array;var s=new Array;var a=i.radius||2;var u=i.tube||.5;var l=i.radialSegments||32;var c=i.tubularSegments||32;var h=i.p||2;var f=i.q||3;var d=i.sideOrientation===0?0:i.sideOrientation||e.Mesh.DEFAULTSIDE;var p=function(t){var i=Math.cos(t);var r=Math.sin(t);var n=f/h*t;var o=Math.cos(n);var s=a*(2+o)*.5*i;var u=a*(2+o)*r*.5;var l=a*Math.sin(n)*.5;return new e.Vector3(s,u,l)};var _;var m;for(_=0;_<=l;_++){var g=_%l;var v=g/l*2*h*Math.PI;var y=p(v);var b=p(v+.01);var x=b.subtract(y);var T=b.add(y);var E=e.Vector3.Cross(x,T);T=e.Vector3.Cross(E,x);E.normalize();T.normalize();for(m=0;m<c;m++){var P=m%c;var A=P/c*2*Math.PI;var M=-u*Math.cos(A);var S=u*Math.sin(A);n.push(y.x+M*T.x+S*E.x);n.push(y.y+M*T.y+S*E.y);n.push(y.z+M*T.z+S*E.z);s.push(_/l);s.push(m/c)}}for(_=0;_<l;_++){for(m=0;m<c;m++){var C=(m+1)%c;var R=_*c+m;var O=(_+1)*c+m;var I=(_+1)*c+C;var D=_*c+C;r.push(D);r.push(O);r.push(R);r.push(D);r.push(I);r.push(O)}}t.ComputeNormals(n,r,o);t._ComputeSides(d,n,r,o,s,i.frontUVs,i.backUVs);var w=new t;w.indices=r;w.positions=n;w.normals=o;w.uvs=s;return w};t.ComputeNormals=function(t,i,r,n){var o=0;var s=0;var a=0;var u=0;var l=0;var c=0;var h=0;var f=0;var d=0;var p=0;var _=0;var m=0;var g=0;var v=0;var y=0;var b=0;var x=0;var T=0;var E=0;var P=0;var A=false;var M=false;var S=false;var C=false;var R=1;var O=0;var I=null;if(n){A=n.facetNormals?true:false;M=n.facetPositions?true:false;S=n.facetPartitioning?true:false;R=n.useRightHandedSystem===true?-1:1;O=n.ratio||0;C=n.depthSort?true:false;I=n.distanceTo;if(C){if(I===undefined){I=e.Vector3.Zero()}var D=n.depthSortedFacets}}var w=0;var L=0;var F=0;var B=0;if(S&&n&&n.bbSize){var V=0;var N=0;var U=0;var k=0;var z=0;var G=0;var W=0;var H=0;var j=0;var X=0;var Y=0;var K=0;var Q=0;var Z=0;var q=0;var J=0;var $=n.bbSize.x>n.bbSize.y?n.bbSize.x:n.bbSize.y;$=$>n.bbSize.z?$:n.bbSize.z;w=n.subDiv.X*O/n.bbSize.x;L=n.subDiv.Y*O/n.bbSize.y;F=n.subDiv.Z*O/n.bbSize.z;B=n.subDiv.max*n.subDiv.max;n.facetPartitioning.length=0}for(o=0;o<t.length;o++){r[o]=0}var ee=i.length/3|0;for(o=0;o<ee;o++){m=i[o*3]*3;g=m+1;v=m+2;y=i[o*3+1]*3;b=y+1;x=y+2;T=i[o*3+2]*3;E=T+1;P=T+2;s=t[m]-t[y];a=t[g]-t[b];u=t[v]-t[x];l=t[T]-t[y];c=t[E]-t[b];h=t[P]-t[x];f=R*(a*h-u*c);d=R*(u*l-s*h);p=R*(s*c-a*l);_=Math.sqrt(f*f+d*d+p*p);_=_===0?1:_;f/=_;d/=_;p/=_;if(A&&n){n.facetNormals[o].x=f;n.facetNormals[o].y=d;n.facetNormals[o].z=p}if(M&&n){n.facetPositions[o].x=(t[m]+t[y]+t[T])/3;n.facetPositions[o].y=(t[g]+t[b]+t[E])/3;n.facetPositions[o].z=(t[v]+t[x]+t[P])/3}if(S&&n){V=Math.floor((n.facetPositions[o].x-n.bInfo.minimum.x*O)*w);N=Math.floor((n.facetPositions[o].y-n.bInfo.minimum.y*O)*L);U=Math.floor((n.facetPositions[o].z-n.bInfo.minimum.z*O)*F);k=Math.floor((t[m]-n.bInfo.minimum.x*O)*w);z=Math.floor((t[g]-n.bInfo.minimum.y*O)*L);G=Math.floor((t[v]-n.bInfo.minimum.z*O)*F);W=Math.floor((t[y]-n.bInfo.minimum.x*O)*w);H=Math.floor((t[b]-n.bInfo.minimum.y*O)*L);j=Math.floor((t[x]-n.bInfo.minimum.z*O)*F);X=Math.floor((t[T]-n.bInfo.minimum.x*O)*w);Y=Math.floor((t[E]-n.bInfo.minimum.y*O)*L);K=Math.floor((t[P]-n.bInfo.minimum.z*O)*F);Z=k+n.subDiv.max*z+B*G;q=W+n.subDiv.max*H+B*j;J=X+n.subDiv.max*Y+B*K;Q=V+n.subDiv.max*N+B*U;n.facetPartitioning[Q]=n.facetPartitioning[Q]?n.facetPartitioning[Q]:new Array;n.facetPartitioning[Z]=n.facetPartitioning[Z]?n.facetPartitioning[Z]:new Array;n.facetPartitioning[q]=n.facetPartitioning[q]?n.facetPartitioning[q]:new Array;n.facetPartitioning[J]=n.facetPartitioning[J]?n.facetPartitioning[J]:new Array;n.facetPartitioning[Z].push(o);if(q!=Z){n.facetPartitioning[q].push(o)}if(!(J==q||J==Z)){n.facetPartitioning[J].push(o)}if(!(Q==Z||Q==q||Q==J)){n.facetPartitioning[Q].push(o)}}if(C&&n&&n.facetPositions){var te=D[o];te.ind=o*3;te.sqDistance=e.Vector3.DistanceSquared(n.facetPositions[o],I)}r[m]+=f;r[g]+=d;r[v]+=p;r[y]+=f;r[b]+=d;r[x]+=p;r[T]+=f;r[E]+=d;r[P]+=p}for(o=0;o<r.length/3;o++){f=r[o*3];d=r[o*3+1];p=r[o*3+2];_=Math.sqrt(f*f+d*d+p*p);_=_===0?1:_;f/=_;d/=_;p/=_;r[o*3]=f;r[o*3+1]=d;r[o*3+2]=p}};t._ComputeSides=function(t,i,r,n,o,s,a){var u=r.length;var l=n.length;var c;var h;t=t||e.Mesh.DEFAULTSIDE;switch(t){case e.Mesh.FRONTSIDE:break;case e.Mesh.BACKSIDE:var f;for(c=0;c<u;c+=3){f=r[c];r[c]=r[c+2];r[c+2]=f}for(h=0;h<l;h++){n[h]=-n[h]}break;case e.Mesh.DOUBLESIDE:var d=i.length;var p=d/3;for(var _=0;_<d;_++){i[d+_]=i[_]}for(c=0;c<u;c+=3){r[c+u]=r[c+2]+p;r[c+1+u]=r[c+1]+p;r[c+2+u]=r[c]+p}for(h=0;h<l;h++){n[l+h]=-n[h]}var m=o.length;var g=0;for(g=0;g<m;g++){o[g+m]=o[g]}s=s?s:new e.Vector4(0,0,1,1);a=a?a:new e.Vector4(0,0,1,1);g=0;for(c=0;c<m/2;c++){o[g]=s.x+(s.z-s.x)*o[g];o[g+1]=s.y+(s.w-s.y)*o[g+1];o[g+m]=a.x+(a.z-a.x)*o[g+m];o[g+m+1]=a.y+(a.w-a.y)*o[g+m+1];g+=2}break}};t.ImportVertexData=function(i,r){var n=new t;var o=i.positions;if(o){n.set(o,e.VertexBuffer.PositionKind)}var s=i.normals;if(s){n.set(s,e.VertexBuffer.NormalKind)}var a=i.tangents;if(a){n.set(a,e.VertexBuffer.TangentKind)}var u=i.uvs;if(u){n.set(u,e.VertexBuffer.UVKind)}var l=i.uv2s;if(l){n.set(l,e.VertexBuffer.UV2Kind)}var c=i.uv3s;if(c){n.set(c,e.VertexBuffer.UV3Kind)}var h=i.uv4s;if(h){n.set(h,e.VertexBuffer.UV4Kind)}var f=i.uv5s;if(f){n.set(f,e.VertexBuffer.UV5Kind)}var d=i.uv6s;if(d){n.set(d,e.VertexBuffer.UV6Kind)}var p=i.colors;if(p){n.set(e.Color4.CheckColors4(p,o.length/3),e.VertexBuffer.ColorKind)}var _=i.matricesIndices;if(_){n.set(_,e.VertexBuffer.MatricesIndicesKind)}var m=i.matricesWeights;if(m){n.set(m,e.VertexBuffer.MatricesWeightsKind)}var g=i.indices;if(g){n.indices=g}r.setAllVerticesData(n,i.updatable)};return t}();e.VertexData=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r,n,o){if(n===void 0){n=false}if(o===void 0){o=null}this.delayLoadState=e.Engine.DELAYLOADSTATE_NONE;this._totalVertices=0;this._isDisposed=false;this._indexBufferIsUpdatable=false;this.id=t;this._engine=i.getEngine();this._meshes=[];this._scene=i;this._vertexBuffers={};this._indices=[];this._updatable=n;if(r){this.setAllVerticesData(r,n)}else{this._totalVertices=0;this._indices=[]}if(this._engine.getCaps().vertexArrayObject){this._vertexArrayObjects={}}if(o){if(o.getClassName()==="LinesMesh"){this.boundingBias=new e.Vector2(0,o.intersectionThreshold);this._updateExtend()}this.applyToMesh(o);o.computeWorldMatrix(true)}}Object.defineProperty(t.prototype,"boundingBias",{get:function(){return this._boundingBias},set:function(e){if(this._boundingBias&&this._boundingBias.equals(e)){return}this._boundingBias=e.clone();this._updateBoundingInfo(true,null)},enumerable:true,configurable:true});t.CreateGeometryForMesh=function(e){var i=new t(t.RandomId(),e.getScene());i.applyToMesh(e);return i};Object.defineProperty(t.prototype,"extend",{get:function(){return this._extend},enumerable:true,configurable:true});t.prototype.getScene=function(){return this._scene};t.prototype.getEngine=function(){return this._engine};t.prototype.isReady=function(){return this.delayLoadState===e.Engine.DELAYLOADSTATE_LOADED||this.delayLoadState===e.Engine.DELAYLOADSTATE_NONE};Object.defineProperty(t.prototype,"doNotSerialize",{get:function(){for(var e=0;e<this._meshes.length;e++){if(!this._meshes[e].doNotSerialize){return false}}return true},enumerable:true,configurable:true});t.prototype._rebuild=function(){if(this._vertexArrayObjects){this._vertexArrayObjects={}}if(this._meshes.length!==0&&this._indices){this._indexBuffer=this._engine.createIndexBuffer(this._indices)}for(var e in this._vertexBuffers){var t=this._vertexBuffers[e];t._rebuild()}};t.prototype.setAllVerticesData=function(e,t){e.applyToGeometry(this,t);this.notifyUpdate()};t.prototype.setVerticesData=function(t,i,r,n){if(r===void 0){r=false}if(t===e.VertexBuffer.PositionKind){this._totalVertices=i.length/(n||3)}var o=new e.VertexBuffer(this._engine,i,t,r,this._meshes.length===0,n);this.setVerticesBuffer(o)};t.prototype.removeVerticesData=function(e){if(this._vertexBuffers[e]){this._vertexBuffers[e].dispose();delete this._vertexBuffers[e]}};t.prototype.setVerticesBuffer=function(t,i){if(i===void 0){i=null}var r=t.getKind();if(this._vertexBuffers[r]){this._vertexBuffers[r].dispose()}this._vertexBuffers[r]=t
;if(r===e.VertexBuffer.PositionKind){if(i!=null){this._totalVertices=i}this._updateExtend();this._resetPointsArrayCache();var n=this._meshes;var o=n.length;for(var s=0;s<o;s++){var a=n[s];a._boundingInfo=new e.BoundingInfo(this._extend.minimum,this._extend.maximum);a._createGlobalSubMesh(false);a.computeWorldMatrix(true)}}this.notifyUpdate(r);if(this._vertexArrayObjects){this._disposeVertexArrayObjects();this._vertexArrayObjects={}}};t.prototype.updateVerticesDataDirectly=function(e,t,i){var r=this.getVertexBuffer(e);if(!r){return}r.updateDirectly(t,i);this.notifyUpdate(e)};t.prototype.updateVerticesData=function(t,i,r){if(r===void 0){r=false}var n=this.getVertexBuffer(t);if(!n){return}n.update(i);if(t===e.VertexBuffer.PositionKind){this._updateBoundingInfo(r,i)}this.notifyUpdate(t)};t.prototype._updateBoundingInfo=function(t,i){if(t){this._updateExtend(i)}var r=this._meshes;var n=r.length;this._resetPointsArrayCache();for(var o=0;o<n;o++){var s=r[o];if(t){s._boundingInfo=new e.BoundingInfo(this._extend.minimum,this._extend.maximum);for(var a=0;a<s.subMeshes.length;a++){var u=s.subMeshes[a];u.refreshBoundingInfo()}}}};t.prototype._bind=function(e,t){if(!e){return}if(t===undefined){t=this._indexBuffer}var i=this.getVertexBuffers();if(!i){return}if(t!=this._indexBuffer||!this._vertexArrayObjects){this._engine.bindBuffers(i,t,e);return}if(!this._vertexArrayObjects[e.key]){this._vertexArrayObjects[e.key]=this._engine.recordVertexArrayObject(i,t,e)}this._engine.bindVertexArrayObject(this._vertexArrayObjects[e.key],t)};t.prototype.getTotalVertices=function(){if(!this.isReady()){return 0}return this._totalVertices};t.prototype.getVerticesData=function(t,i,r){var n=this.getVertexBuffer(t);if(!n){return null}var o=n.getData();if(!o){return null}var s=e.VertexBuffer.DeduceStride(n.getKind());var a=s*e.VertexBuffer.GetTypeByteLength(n.type);var u=this._totalVertices*s;if(n.type!==e.VertexBuffer.FLOAT||n.byteStride!==a){var l=new Array(u);n.forEach(u,function(e,t){l[t]=e});return l}if(!(o instanceof Array||o instanceof Float32Array)||n.byteOffset!==0||o.length!==u){if(o instanceof Array){var c=n.byteOffset/4;return e.Tools.Slice(o,c,c+u)}else if(o instanceof ArrayBuffer){return new Float32Array(o,n.byteOffset,u)}else{return new Float32Array(o.buffer,o.byteOffset+n.byteOffset,u)}}if(r||i&&this._meshes.length!==1){return e.Tools.Slice(o)}return o};t.prototype.isVertexBufferUpdatable=function(e){var t=this._vertexBuffers[e];if(!t){return false}return t.isUpdatable()};t.prototype.getVertexBuffer=function(e){if(!this.isReady()){return null}return this._vertexBuffers[e]};t.prototype.getVertexBuffers=function(){if(!this.isReady()){return null}return this._vertexBuffers};t.prototype.isVerticesDataPresent=function(e){if(!this._vertexBuffers){if(this._delayInfo){return this._delayInfo.indexOf(e)!==-1}return false}return this._vertexBuffers[e]!==undefined};t.prototype.getVerticesDataKinds=function(){var e=[];var t;if(!this._vertexBuffers&&this._delayInfo){for(t in this._delayInfo){e.push(t)}}else{for(t in this._vertexBuffers){e.push(t)}}return e};t.prototype.updateIndices=function(e,t){if(!this._indexBuffer){return}if(!this._indexBufferIsUpdatable){this.setIndices(e,null,true)}else{this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t)}};t.prototype.setIndices=function(e,t,i){if(t===void 0){t=null}if(i===void 0){i=false}if(this._indexBuffer){this._engine._releaseBuffer(this._indexBuffer)}this._disposeVertexArrayObjects();this._indices=e;this._indexBufferIsUpdatable=i;if(this._meshes.length!==0&&this._indices){this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)}if(t!=undefined){this._totalVertices=t}var r=this._meshes;var n=r.length;for(var o=0;o<n;o++){r[o]._createGlobalSubMesh(true)}this.notifyUpdate()};t.prototype.getTotalIndices=function(){if(!this.isReady()){return 0}return this._indices.length};t.prototype.getIndices=function(e){if(!this.isReady()){return null}var t=this._indices;if(!e||this._meshes.length===1){return t}else{var i=t.length;var r=[];for(var n=0;n<i;n++){r.push(t[n])}return r}};t.prototype.getIndexBuffer=function(){if(!this.isReady()){return null}return this._indexBuffer};t.prototype._releaseVertexArrayObject=function(e){if(e===void 0){e=null}if(!e||!this._vertexArrayObjects){return}if(this._vertexArrayObjects[e.key]){this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]);delete this._vertexArrayObjects[e.key]}};t.prototype.releaseForMesh=function(e,t){var i=this._meshes;var r=i.indexOf(e);if(r===-1){return}i.splice(r,1);e._geometry=null;if(i.length===0&&t){this.dispose()}};t.prototype.applyToMesh=function(e){if(e._geometry===this){return}var t=e._geometry;if(t){t.releaseForMesh(e)}var i=this._meshes;e._geometry=this;this._scene.pushGeometry(this);i.push(e);if(this.isReady()){this._applyToMesh(e)}else{e._boundingInfo=this._boundingInfo}};t.prototype._updateExtend=function(t){if(t===void 0){t=null}if(!t){t=this.getVerticesData(e.VertexBuffer.PositionKind)}this._extend=e.Tools.ExtractMinAndMax(t,0,this._totalVertices,this.boundingBias,3)};t.prototype._applyToMesh=function(t){var i=this._meshes.length;for(var r in this._vertexBuffers){if(i===1){this._vertexBuffers[r].create()}var n=this._vertexBuffers[r].getBuffer();if(n)n.references=i;if(r===e.VertexBuffer.PositionKind){if(!this._extend){this._updateExtend()}t._boundingInfo=new e.BoundingInfo(this._extend.minimum,this._extend.maximum);t._createGlobalSubMesh(false);t._updateBoundingInfo()}}if(i===1&&this._indices&&this._indices.length>0){this._indexBuffer=this._engine.createIndexBuffer(this._indices)}if(this._indexBuffer){this._indexBuffer.references=i}};t.prototype.notifyUpdate=function(e){if(this.onGeometryUpdated){this.onGeometryUpdated(this,e)}for(var t=0,i=this._meshes;t<i.length;t++){var r=i[t];r._markSubMeshesAsAttributesDirty()}};t.prototype.load=function(t,i){if(this.delayLoadState===e.Engine.DELAYLOADSTATE_LOADING){return}if(this.isReady()){if(i){i()}return}this.delayLoadState=e.Engine.DELAYLOADSTATE_LOADING;this._queueLoad(t,i)};t.prototype._queueLoad=function(t,i){var r=this;if(!this.delayLoadingFile){return}t._addPendingData(this);t._loadFile(this.delayLoadingFile,function(n){if(!r._delayLoadingFunction){return}r._delayLoadingFunction(JSON.parse(n),r);r.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED;r._delayInfo=[];t._removePendingData(r);var o=r._meshes;var s=o.length;for(var a=0;a<s;a++){r._applyToMesh(o[a])}if(i){i()}},undefined,true)};t.prototype.toLeftHanded=function(){var t=this.getIndices(false);if(t!=null&&t.length>0){for(var i=0;i<t.length;i+=3){var r=t[i+0];t[i+0]=t[i+2];t[i+2]=r}this.setIndices(t)}var n=this.getVerticesData(e.VertexBuffer.PositionKind,false);if(n!=null&&n.length>0){for(var i=0;i<n.length;i+=3){n[i+2]=-n[i+2]}this.setVerticesData(e.VertexBuffer.PositionKind,n,false)}var o=this.getVerticesData(e.VertexBuffer.NormalKind,false);if(o!=null&&o.length>0){for(var i=0;i<o.length;i+=3){o[i+2]=-o[i+2]}this.setVerticesData(e.VertexBuffer.NormalKind,o,false)}};t.prototype._resetPointsArrayCache=function(){this._positions=null};t.prototype._generatePointsArray=function(){if(this._positions)return true;this._positions=[];var t=this.getVerticesData(e.VertexBuffer.PositionKind);if(!t){return false}for(var i=0;i<t.length;i+=3){this._positions.push(e.Vector3.FromArray(t,i))}return true};t.prototype.isDisposed=function(){return this._isDisposed};t.prototype._disposeVertexArrayObjects=function(){if(this._vertexArrayObjects){for(var e in this._vertexArrayObjects){this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e])}this._vertexArrayObjects={}}};t.prototype.dispose=function(){var t=this._meshes;var i=t.length;var r;for(r=0;r<i;r++){this.releaseForMesh(t[r])}this._meshes=[];this._disposeVertexArrayObjects();for(var n in this._vertexBuffers){this._vertexBuffers[n].dispose()}this._vertexBuffers={};this._totalVertices=0;if(this._indexBuffer){this._engine._releaseBuffer(this._indexBuffer)}this._indexBuffer=null;this._indices=[];this.delayLoadState=e.Engine.DELAYLOADSTATE_NONE;this.delayLoadingFile=null;this._delayLoadingFunction=null;this._delayInfo=[];this._boundingInfo=null;this._scene.removeGeometry(this);this._isDisposed=true};t.prototype.copy=function(i){var r=new e.VertexData;r.indices=[];var n=this.getIndices();if(n){for(var o=0;o<n.length;o++){r.indices.push(n[o])}}var s=false;var a=false;var u;for(u in this._vertexBuffers){var l=this.getVerticesData(u);if(l instanceof Float32Array){r.set(new Float32Array(l),u)}else{r.set(l.slice(0),u)}if(!a){var c=this.getVertexBuffer(u);if(c){s=c.isUpdatable();a=!s}}}var h=new t(i,this._scene,r,s);h.delayLoadState=this.delayLoadState;h.delayLoadingFile=this.delayLoadingFile;h._delayLoadingFunction=this._delayLoadingFunction;for(u in this._delayInfo){h._delayInfo=h._delayInfo||[];h._delayInfo.push(u)}h._boundingInfo=new e.BoundingInfo(this._extend.minimum,this._extend.maximum);return h};t.prototype.serialize=function(){var t={};t.id=this.id;t.updatable=this._updatable;if(e.Tags&&e.Tags.HasTags(this)){t.tags=e.Tags.GetTags(this)}return t};t.prototype.toNumberArray=function(e){if(Array.isArray(e)){return e}else{return Array.prototype.slice.call(e)}};t.prototype.serializeVerticeData=function(){var t=this.serialize();if(this.isVerticesDataPresent(e.VertexBuffer.PositionKind)){t.positions=this.toNumberArray(this.getVerticesData(e.VertexBuffer.PositionKind));if(this.isVertexBufferUpdatable(e.VertexBuffer.PositionKind)){t.positions._updatable=true}}if(this.isVerticesDataPresent(e.VertexBuffer.NormalKind)){t.normals=this.toNumberArray(this.getVerticesData(e.VertexBuffer.NormalKind));if(this.isVertexBufferUpdatable(e.VertexBuffer.NormalKind)){t.normals._updatable=true}}if(this.isVerticesDataPresent(e.VertexBuffer.TangentKind)){t.tangets=this.toNumberArray(this.getVerticesData(e.VertexBuffer.TangentKind));if(this.isVertexBufferUpdatable(e.VertexBuffer.TangentKind)){t.tangets._updatable=true}}if(this.isVerticesDataPresent(e.VertexBuffer.UVKind)){t.uvs=this.toNumberArray(this.getVerticesData(e.VertexBuffer.UVKind));if(this.isVertexBufferUpdatable(e.VertexBuffer.UVKind)){t.uvs._updatable=true}}if(this.isVerticesDataPresent(e.VertexBuffer.UV2Kind)){t.uv2s=this.toNumberArray(this.getVerticesData(e.VertexBuffer.UV2Kind));if(this.isVertexBufferUpdatable(e.VertexBuffer.UV2Kind)){t.uv2s._updatable=true}}if(this.isVerticesDataPresent(e.VertexBuffer.UV3Kind)){t.uv3s=this.toNumberArray(this.getVerticesData(e.VertexBuffer.UV3Kind));if(this.isVertexBufferUpdatable(e.VertexBuffer.UV3Kind)){t.uv3s._updatable=true}}if(this.isVerticesDataPresent(e.VertexBuffer.UV4Kind)){t.uv4s=this.toNumberArray(this.getVerticesData(e.VertexBuffer.UV4Kind));if(this.isVertexBufferUpdatable(e.VertexBuffer.UV4Kind)){t.uv4s._updatable=true}}if(this.isVerticesDataPresent(e.VertexBuffer.UV5Kind)){t.uv5s=this.toNumberArray(this.getVerticesData(e.VertexBuffer.UV5Kind));if(this.isVertexBufferUpdatable(e.VertexBuffer.UV5Kind)){t.uv5s._updatable=true}}if(this.isVerticesDataPresent(e.VertexBuffer.UV6Kind)){t.uv6s=this.toNumberArray(this.getVerticesData(e.VertexBuffer.UV6Kind));if(this.isVertexBufferUpdatable(e.VertexBuffer.UV6Kind)){t.uv6s._updatable=true}}if(this.isVerticesDataPresent(e.VertexBuffer.ColorKind)){t.colors=this.toNumberArray(this.getVerticesData(e.VertexBuffer.ColorKind));if(this.isVertexBufferUpdatable(e.VertexBuffer.ColorKind)){t.colors._updatable=true}}if(this.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)){t.matricesIndices=this.toNumberArray(this.getVerticesData(e.VertexBuffer.MatricesIndicesKind));t.matricesIndices._isExpanded=true;if(this.isVertexBufferUpdatable(e.VertexBuffer.MatricesIndicesKind)){t.matricesIndices._updatable=true}}if(this.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind)){t.matricesWeights=this.toNumberArray(this.getVerticesData(e.VertexBuffer.MatricesWeightsKind));if(this.isVertexBufferUpdatable(e.VertexBuffer.MatricesWeightsKind)){t.matricesWeights._updatable=true}}t.indices=this.toNumberArray(this.getIndices());return t};t.ExtractFromMesh=function(e,t){var i=e._geometry;if(!i){return null}return i.copy(t)};t.RandomId=function(){return e.Tools.RandomId()};t._ImportGeometry=function(i,r){var n=r.getScene();var o=i.geometryId;if(o){var s=n.getGeometryByID(o);if(s){s.applyToMesh(r)}}else if(i instanceof ArrayBuffer){var a=r._binaryInfo;if(a.positionsAttrDesc&&a.positionsAttrDesc.count>0){var u=new Float32Array(i,a.positionsAttrDesc.offset,a.positionsAttrDesc.count);r.setVerticesData(e.VertexBuffer.PositionKind,u,false)}if(a.normalsAttrDesc&&a.normalsAttrDesc.count>0){var l=new Float32Array(i,a.normalsAttrDesc.offset,a.normalsAttrDesc.count);r.setVerticesData(e.VertexBuffer.NormalKind,l,false)}if(a.tangetsAttrDesc&&a.tangetsAttrDesc.count>0){var c=new Float32Array(i,a.tangetsAttrDesc.offset,a.tangetsAttrDesc.count);r.setVerticesData(e.VertexBuffer.TangentKind,c,false)}if(a.uvsAttrDesc&&a.uvsAttrDesc.count>0){var h=new Float32Array(i,a.uvsAttrDesc.offset,a.uvsAttrDesc.count);r.setVerticesData(e.VertexBuffer.UVKind,h,false)}if(a.uvs2AttrDesc&&a.uvs2AttrDesc.count>0){var f=new Float32Array(i,a.uvs2AttrDesc.offset,a.uvs2AttrDesc.count);r.setVerticesData(e.VertexBuffer.UV2Kind,f,false)}if(a.uvs3AttrDesc&&a.uvs3AttrDesc.count>0){var d=new Float32Array(i,a.uvs3AttrDesc.offset,a.uvs3AttrDesc.count);r.setVerticesData(e.VertexBuffer.UV3Kind,d,false)}if(a.uvs4AttrDesc&&a.uvs4AttrDesc.count>0){var p=new Float32Array(i,a.uvs4AttrDesc.offset,a.uvs4AttrDesc.count);r.setVerticesData(e.VertexBuffer.UV4Kind,p,false)}if(a.uvs5AttrDesc&&a.uvs5AttrDesc.count>0){var _=new Float32Array(i,a.uvs5AttrDesc.offset,a.uvs5AttrDesc.count);r.setVerticesData(e.VertexBuffer.UV5Kind,_,false)}if(a.uvs6AttrDesc&&a.uvs6AttrDesc.count>0){var m=new Float32Array(i,a.uvs6AttrDesc.offset,a.uvs6AttrDesc.count);r.setVerticesData(e.VertexBuffer.UV6Kind,m,false)}if(a.colorsAttrDesc&&a.colorsAttrDesc.count>0){var g=new Float32Array(i,a.colorsAttrDesc.offset,a.colorsAttrDesc.count);r.setVerticesData(e.VertexBuffer.ColorKind,g,false,a.colorsAttrDesc.stride)}if(a.matricesIndicesAttrDesc&&a.matricesIndicesAttrDesc.count>0){var v=new Int32Array(i,a.matricesIndicesAttrDesc.offset,a.matricesIndicesAttrDesc.count);r.setVerticesData(e.VertexBuffer.MatricesIndicesKind,v,false)}if(a.matricesWeightsAttrDesc&&a.matricesWeightsAttrDesc.count>0){var y=new Float32Array(i,a.matricesWeightsAttrDesc.offset,a.matricesWeightsAttrDesc.count);r.setVerticesData(e.VertexBuffer.MatricesWeightsKind,y,false)}if(a.indicesAttrDesc&&a.indicesAttrDesc.count>0){var b=new Int32Array(i,a.indicesAttrDesc.offset,a.indicesAttrDesc.count);r.setIndices(b,null)}if(a.subMeshesAttrDesc&&a.subMeshesAttrDesc.count>0){var x=new Int32Array(i,a.subMeshesAttrDesc.offset,a.subMeshesAttrDesc.count*5);r.subMeshes=[];for(var T=0;T<a.subMeshesAttrDesc.count;T++){var E=x[T*5+0];var P=x[T*5+1];var A=x[T*5+2];var M=x[T*5+3];var S=x[T*5+4];e.SubMesh.AddToMesh(E,P,A,M,S,r)}}}else if(i.positions&&i.normals&&i.indices){r.setVerticesData(e.VertexBuffer.PositionKind,i.positions,i.positions._updatable);r.setVerticesData(e.VertexBuffer.NormalKind,i.normals,i.normals._updatable);if(i.tangents){r.setVerticesData(e.VertexBuffer.TangentKind,i.tangents,i.tangents._updatable)}if(i.uvs){r.setVerticesData(e.VertexBuffer.UVKind,i.uvs,i.uvs._updatable)}if(i.uvs2){r.setVerticesData(e.VertexBuffer.UV2Kind,i.uvs2,i.uvs2._updatable)}if(i.uvs3){r.setVerticesData(e.VertexBuffer.UV3Kind,i.uvs3,i.uvs3._updatable)}if(i.uvs4){r.setVerticesData(e.VertexBuffer.UV4Kind,i.uvs4,i.uvs4._updatable)}if(i.uvs5){r.setVerticesData(e.VertexBuffer.UV5Kind,i.uvs5,i.uvs5._updatable)}if(i.uvs6){r.setVerticesData(e.VertexBuffer.UV6Kind,i.uvs6,i.uvs6._updatable)}if(i.colors){r.setVerticesData(e.VertexBuffer.ColorKind,e.Color4.CheckColors4(i.colors,i.positions.length/3),i.colors._updatable)}if(i.matricesIndices){if(!i.matricesIndices._isExpanded){var C=[];for(var T=0;T<i.matricesIndices.length;T++){var R=i.matricesIndices[T];C.push(R&255);C.push((R&65280)>>8);C.push((R&16711680)>>16);C.push(R>>24)}r.setVerticesData(e.VertexBuffer.MatricesIndicesKind,C,i.matricesIndices._updatable)}else{delete i.matricesIndices._isExpanded;r.setVerticesData(e.VertexBuffer.MatricesIndicesKind,i.matricesIndices,i.matricesIndices._updatable)}}if(i.matricesIndicesExtra){if(!i.matricesIndicesExtra._isExpanded){var C=[];for(var T=0;T<i.matricesIndicesExtra.length;T++){var R=i.matricesIndicesExtra[T];C.push(R&255);C.push((R&65280)>>8);C.push((R&16711680)>>16);C.push(R>>24)}r.setVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,C,i.matricesIndicesExtra._updatable)}else{delete i.matricesIndices._isExpanded;r.setVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,i.matricesIndicesExtra,i.matricesIndicesExtra._updatable)}}if(i.matricesWeights){t._CleanMatricesWeights(i,r);r.setVerticesData(e.VertexBuffer.MatricesWeightsKind,i.matricesWeights,i.matricesWeights._updatable)}if(i.matricesWeightsExtra){r.setVerticesData(e.VertexBuffer.MatricesWeightsExtraKind,i.matricesWeightsExtra,i.matricesWeights._updatable)}r.setIndices(i.indices,null)}if(i.subMeshes){r.subMeshes=[];for(var O=0;O<i.subMeshes.length;O++){var I=i.subMeshes[O];e.SubMesh.AddToMesh(I.materialIndex,I.verticesStart,I.verticesCount,I.indexStart,I.indexCount,r)}}if(r._shouldGenerateFlatShading){r.convertToFlatShadedMesh();delete r._shouldGenerateFlatShading}r.computeWorldMatrix(true);var D=n.selectionOctree;if(D!==undefined&&D!==null){D.addMesh(r)}};t._CleanMatricesWeights=function(t,i){var r=.001;if(!e.SceneLoader.CleanBoneMatrixWeights){return}var n=0;if(t.skeletonId>-1){var o=i.getScene().getLastSkeletonByID(t.skeletonId);if(!o){return}n=o.bones.length}else{return}var s=i.getVerticesData(e.VertexBuffer.MatricesIndicesKind);var a=i.getVerticesData(e.VertexBuffer.MatricesIndicesExtraKind);var u=t.matricesWeights;var l=t.matricesWeightsExtra;var c=t.numBoneInfluencer;var h=u.length;for(var f=0;f<h;f+=4){var d=0;var p=-1;for(var _=0;_<4;_++){var m=u[f+_];d+=m;if(m<r&&p<0){p=_}}if(l){for(var _=0;_<4;_++){var m=l[f+_];d+=m;if(m<r&&p<0){p=_+4}}}if(p<0||p>c-1){p=c-1}if(d>r){var g=1/d;for(var _=0;_<4;_++){u[f+_]*=g}if(l){for(var _=0;_<4;_++){l[f+_]*=g}}}else{if(p>=4){l[f+p-4]=1-d;a[f+p-4]=n}else{u[f+p]=1-d;s[f+p]=n}}}i.setVerticesData(e.VertexBuffer.MatricesIndicesKind,s);if(t.matricesWeightsExtra){i.setVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,a)}};t.Parse=function(i,r,n){if(r.getGeometryByID(i.id)){return null}var o=new t(i.id,r,undefined,i.updatable);if(e.Tags){e.Tags.AddTagsTo(o,i.tags)}if(i.delayLoadingFile){o.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED;o.delayLoadingFile=n+i.delayLoadingFile;o._boundingInfo=new e.BoundingInfo(e.Vector3.FromArray(i.boundingBoxMinimum),e.Vector3.FromArray(i.boundingBoxMaximum));o._delayInfo=[];if(i.hasUVs){o._delayInfo.push(e.VertexBuffer.UVKind)}if(i.hasUVs2){o._delayInfo.push(e.VertexBuffer.UV2Kind)}if(i.hasUVs3){o._delayInfo.push(e.VertexBuffer.UV3Kind)}if(i.hasUVs4){o._delayInfo.push(e.VertexBuffer.UV4Kind)}if(i.hasUVs5){o._delayInfo.push(e.VertexBuffer.UV5Kind)}if(i.hasUVs6){o._delayInfo.push(e.VertexBuffer.UV6Kind)}if(i.hasColors){o._delayInfo.push(e.VertexBuffer.ColorKind)}if(i.hasMatricesIndices){o._delayInfo.push(e.VertexBuffer.MatricesIndicesKind)}if(i.hasMatricesWeights){o._delayInfo.push(e.VertexBuffer.MatricesWeightsKind)}o._delayLoadingFunction=e.VertexData.ImportVertexData}else{e.VertexData.ImportVertexData(i,o)}r.pushGeometry(o,true);return o};return t}();e.Geometry=t;var i=function(e){__extends(t,e);function t(t,i,r,n){if(r===void 0){r=false}if(n===void 0){n=null}var o=e.call(this,t,i,undefined,false,n)||this;o._canBeRegenerated=r;o._beingRegenerated=true;o.regenerate();o._beingRegenerated=false;return o}t.prototype.canBeRegenerated=function(){return this._canBeRegenerated};t.prototype.regenerate=function(){if(!this._canBeRegenerated){return}this._beingRegenerated=true;this.setAllVerticesData(this._regenerateVertexData(),false);this._beingRegenerated=false};t.prototype.asNewGeometry=function(t){return e.prototype.copy.call(this,t)};t.prototype.setAllVerticesData=function(t,i){if(!this._beingRegenerated){return}e.prototype.setAllVerticesData.call(this,t,false)};t.prototype.setVerticesData=function(t,i,r){if(!this._beingRegenerated){return}e.prototype.setVerticesData.call(this,t,i,false)};t.prototype._regenerateVertexData=function(){throw new Error("Abstract method")};t.prototype.copy=function(e){throw new Error("Must be overriden in sub-classes.")};t.prototype.serialize=function(){var t=e.prototype.serialize.call(this);t.canBeRegenerated=this.canBeRegenerated();return t};return t}(t);e._PrimitiveGeometry=i;var r=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c){if(c===void 0){c=e.Mesh.DEFAULTSIDE}var h=t.call(this,i,r,u,l)||this;h.pathArray=n;h.closeArray=o;h.closePath=s;h.offset=a;h.side=c;return h}i.prototype._regenerateVertexData=function(){return e.VertexData.CreateRibbon({pathArray:this.pathArray,closeArray:this.closeArray,closePath:this.closePath,offset:this.offset,sideOrientation:this.side})};i.prototype.copy=function(e){return new i(e,this.getScene(),this.pathArray,this.closeArray,this.closePath,this.offset,this.canBeRegenerated(),undefined,this.side)};return i}(i);e.RibbonGeometry=r;var n=function(t){__extends(i,t);function i(i,r,n,o,s,a){if(s===void 0){s=null}if(a===void 0){a=e.Mesh.DEFAULTSIDE}var u=t.call(this,i,r,o,s)||this;u.size=n;u.side=a;return u}i.prototype._regenerateVertexData=function(){return e.VertexData.CreateBox({size:this.size,sideOrientation:this.side})};i.prototype.copy=function(e){return new i(e,this.getScene(),this.size,this.canBeRegenerated(),undefined,this.side)};i.prototype.serialize=function(){var e=t.prototype.serialize.call(this);e.size=this.size;return e};i.Parse=function(t,r){if(r.getGeometryByID(t.id)){return null}var n=new i(t.id,r,t.size,t.canBeRegenerated,null);if(e.Tags){e.Tags.AddTagsTo(n,t.tags)}r.pushGeometry(n,true);return n};return i}(i);e.BoxGeometry=n;var o=function(t){__extends(i,t);function i(i,r,n,o,s,a,u){if(a===void 0){a=null}if(u===void 0){u=e.Mesh.DEFAULTSIDE}var l=t.call(this,i,r,s,a)||this;l.segments=n;l.diameter=o;l.side=u;return l}i.prototype._regenerateVertexData=function(){return e.VertexData.CreateSphere({segments:this.segments,diameter:this.diameter,sideOrientation:this.side})};i.prototype.copy=function(e){return new i(e,this.getScene(),this.segments,this.diameter,this.canBeRegenerated(),null,this.side)};i.prototype.serialize=function(){var e=t.prototype.serialize.call(this);e.segments=this.segments;e.diameter=this.diameter;return e};i.Parse=function(t,r){if(r.getGeometryByID(t.id)){return null}var n=new i(t.id,r,t.segments,t.diameter,t.canBeRegenerated,null);if(e.Tags){e.Tags.AddTagsTo(n,t.tags)}r.pushGeometry(n,true);return n};return i}(i);e.SphereGeometry=o;var s=function(t){__extends(i,t);function i(i,r,n,o,s,a,u){if(a===void 0){a=null}if(u===void 0){u=e.Mesh.DEFAULTSIDE}var l=t.call(this,i,r,s,a)||this;l.radius=n;l.tessellation=o;l.side=u;return l}i.prototype._regenerateVertexData=function(){return e.VertexData.CreateDisc({radius:this.radius,tessellation:this.tessellation,sideOrientation:this.side})};i.prototype.copy=function(e){return new i(e,this.getScene(),this.radius,this.tessellation,this.canBeRegenerated(),null,this.side)};return i}(i);e.DiscGeometry=s;var a=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c,h){if(u===void 0){u=1}if(c===void 0){c=null}if(h===void 0){h=e.Mesh.DEFAULTSIDE}var f=t.call(this,i,r,l,c)||this;f.height=n;f.diameterTop=o;f.diameterBottom=s;f.tessellation=a;f.subdivisions=u;f.side=h;return f}i.prototype._regenerateVertexData=function(){return e.VertexData.CreateCylinder({height:this.height,diameterTop:this.diameterTop,diameterBottom:this.diameterBottom,tessellation:this.tessellation,subdivisions:this.subdivisions,sideOrientation:this.side})};i.prototype.copy=function(e){return new i(e,this.getScene(),this.height,this.diameterTop,this.diameterBottom,this.tessellation,this.subdivisions,this.canBeRegenerated(),null,this.side)};i.prototype.serialize=function(){var e=t.prototype.serialize.call(this);e.height=this.height;e.diameterTop=this.diameterTop;e.diameterBottom=this.diameterBottom;e.tessellation=this.tessellation;return e};i.Parse=function(t,r){if(r.getGeometryByID(t.id)){return null}var n=new i(t.id,r,t.height,t.diameterTop,t.diameterBottom,t.tessellation,t.subdivisions,t.canBeRegenerated,null);if(e.Tags){e.Tags.AddTagsTo(n,t.tags)}r.pushGeometry(n,true);return n};return i}(i);e.CylinderGeometry=a;var u=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l){if(u===void 0){u=null}if(l===void 0){l=e.Mesh.DEFAULTSIDE}var c=t.call(this,i,r,a,u)||this;c.diameter=n;c.thickness=o;c.tessellation=s;c.side=l;return c}i.prototype._regenerateVertexData=function(){return e.VertexData.CreateTorus({diameter:this.diameter,thickness:this.thickness,tessellation:this.tessellation,sideOrientation:this.side})};i.prototype.copy=function(e){return new i(e,this.getScene(),this.diameter,this.thickness,this.tessellation,this.canBeRegenerated(),null,this.side)};i.prototype.serialize=function(){var e=t.prototype.serialize.call(this);e.diameter=this.diameter;e.thickness=this.thickness;e.tessellation=this.tessellation;return e};i.Parse=function(t,r){if(r.getGeometryByID(t.id)){return null}var n=new i(t.id,r,t.diameter,t.thickness,t.tessellation,t.canBeRegenerated,null);if(e.Tags){e.Tags.AddTagsTo(n,t.tags)}r.pushGeometry(n,true);return n};return i}(i);e.TorusGeometry=u;var l=function(t){__extends(i,t);function i(e,i,r,n,o,s,a){if(a===void 0){a=null}var u=t.call(this,e,i,s,a)||this;u.width=r;u.height=n;u.subdivisions=o;return u}i.prototype._regenerateVertexData=function(){return e.VertexData.CreateGround({width:this.width,height:this.height,subdivisions:this.subdivisions})};i.prototype.copy=function(e){return new i(e,this.getScene(),this.width,this.height,this.subdivisions,this.canBeRegenerated(),null)};i.prototype.serialize=function(){var e=t.prototype.serialize.call(this);e.width=this.width;e.height=this.height;e.subdivisions=this.subdivisions;return e};i.Parse=function(t,r){if(r.getGeometryByID(t.id)){return null}var n=new i(t.id,r,t.width,t.height,t.subdivisions,t.canBeRegenerated,null);if(e.Tags){e.Tags.AddTagsTo(n,t.tags)}r.pushGeometry(n,true);return n};return i}(i);e.GroundGeometry=l;var c=function(t){__extends(i,t);function i(e,i,r,n,o,s,a,u,l,c){if(c===void 0){c=null}var h=t.call(this,e,i,l,c)||this;h.xmin=r;h.zmin=n;h.xmax=o;h.zmax=s;h.subdivisions=a;h.precision=u;return h}i.prototype._regenerateVertexData=function(){return e.VertexData.CreateTiledGround({xmin:this.xmin,zmin:this.zmin,xmax:this.xmax,zmax:this.zmax,subdivisions:this.subdivisions,precision:this.precision})};i.prototype.copy=function(e){return new i(e,this.getScene(),this.xmin,this.zmin,this.xmax,this.zmax,this.subdivisions,this.precision,this.canBeRegenerated(),null)};return i}(i);e.TiledGroundGeometry=c;var h=function(t){__extends(i,t);function i(i,r,n,o,s,a){if(s===void 0){s=null}if(a===void 0){a=e.Mesh.DEFAULTSIDE}var u=t.call(this,i,r,o,s)||this;u.size=n;u.side=a;return u}i.prototype._regenerateVertexData=function(){return e.VertexData.CreatePlane({size:this.size,sideOrientation:this.side})};i.prototype.copy=function(e){return new i(e,this.getScene(),this.size,this.canBeRegenerated(),null,this.side)};i.prototype.serialize=function(){var e=t.prototype.serialize.call(this);e.size=this.size;return e};i.Parse=function(t,r){if(r.getGeometryByID(t.id)){return null}var n=new i(t.id,r,t.size,t.canBeRegenerated,null);if(e.Tags){e.Tags.AddTagsTo(n,t.tags)}r.pushGeometry(n,true);return n};return i}(i);e.PlaneGeometry=h;var f=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c,h,f){if(h===void 0){h=null}if(f===void 0){f=e.Mesh.DEFAULTSIDE}var d=t.call(this,i,r,c,h)||this;d.radius=n;d.tube=o;d.radialSegments=s;d.tubularSegments=a;d.p=u;d.q=l;d.side=f;return d}i.prototype._regenerateVertexData=function(){return e.VertexData.CreateTorusKnot({radius:this.radius,tube:this.tube,radialSegments:this.radialSegments,tubularSegments:this.tubularSegments,p:this.p,q:this.q,sideOrientation:this.side})};i.prototype.copy=function(e){return new i(e,this.getScene(),this.radius,this.tube,this.radialSegments,this.tubularSegments,this.p,this.q,this.canBeRegenerated(),null,this.side)};i.prototype.serialize=function(){var e=t.prototype.serialize.call(this);e.radius=this.radius;e.tube=this.tube;e.radialSegments=this.radialSegments;e.tubularSegments=this.tubularSegments;e.p=this.p;e.q=this.q;return e};i.Parse=function(t,r){if(r.getGeometryByID(t.id)){return null}var n=new i(t.id,r,t.radius,t.tube,t.radialSegments,t.tubularSegments,t.p,t.q,t.canBeRegenerated,null);if(e.Tags){e.Tags.AddTagsTo(n,t.tags)}r.pushGeometry(n,true);return n};return i}(i);e.TorusKnotGeometry=f})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e){this._vertexBuffers={};this._scene=e}t.prototype._prepareBuffers=function(){if(this._vertexBuffers[e.VertexBuffer.PositionKind]){return}var t=[];t.push(1,1);t.push(-1,1);t.push(-1,-1);t.push(1,-1);this._vertexBuffers[e.VertexBuffer.PositionKind]=new e.VertexBuffer(this._scene.getEngine(),t,e.VertexBuffer.PositionKind,false,false,2);this._buildIndexBuffer()};t.prototype._buildIndexBuffer=function(){var e=[];e.push(0);e.push(1);e.push(2);e.push(0);e.push(2);e.push(3);this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)};t.prototype._rebuild=function(){var t=this._vertexBuffers[e.VertexBuffer.PositionKind];if(!t){return}t._rebuild();this._buildIndexBuffer()};t.prototype._prepareFrame=function(e,t){if(e===void 0){e=null}if(t===void 0){t=null}var i=this._scene.activeCamera;if(!i){return false}var t=t||i._postProcesses.filter(function(e){return e!=null});if(!t||t.length===0||!this._scene.postProcessesEnabled){return false}t[0].activate(i,e,t!==null&&t!==undefined);return true};t.prototype.directRender=function(t,i,r){if(i===void 0){i=null}if(r===void 0){r=false}var n=this._scene.getEngine();for(var o=0;o<t.length;o++){if(o<t.length-1){t[o+1].activate(this._scene.activeCamera,i)}else{if(i){n.bindFramebuffer(i,0,undefined,undefined,r)}else{n.restoreDefaultFramebuffer()}}var s=t[o];var a=s.apply();if(a){s.onBeforeRenderObservable.notifyObservers(a);this._prepareBuffers();n.bindBuffers(this._vertexBuffers,this._indexBuffer,a);n.drawElementsType(e.Material.TriangleFillMode,0,6);s.onAfterRenderObservable.notifyObservers(a)}}n.setDepthBuffer(true);n.setDepthWrite(true)};t.prototype._finalizeFrame=function(t,i,r,n,o){if(o===void 0){o=false}var s=this._scene.activeCamera;if(!s){return}n=n||s._postProcesses.filter(function(e){return e!=null});if(n.length===0||!this._scene.postProcessesEnabled){return}var a=this._scene.getEngine();for(var u=0,l=n.length;u<l;u++){var c=n[u];if(u<l-1){c._outputTexture=n[u+1].activate(s,i)}else{if(i){a.bindFramebuffer(i,r,undefined,undefined,o);c._outputTexture=i}else{a.restoreDefaultFramebuffer();c._outputTexture=null}}if(t){break}var h=c.apply();if(h){c.onBeforeRenderObservable.notifyObservers(h);this._prepareBuffers();a.bindBuffers(this._vertexBuffers,this._indexBuffer,h);a.drawElementsType(e.Material.TriangleFillMode,0,6);c.onAfterRenderObservable.notifyObservers(h)}}a.setDepthBuffer(true);a.setDepthWrite(true);a.setAlphaMode(e.Engine.ALPHA_DISABLE)};t.prototype.dispose=function(){var t=this._vertexBuffers[e.VertexBuffer.PositionKind];if(t){t.dispose();this._vertexBuffers[e.VertexBuffer.PositionKind]=null}if(this._indexBuffer){this._scene.getEngine()._releaseBuffer(this._indexBuffer);this._indexBuffer=null}};return t}();e.PostProcessManager=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e){if(e===void 0){e=30}this._enabled=true;this._rollingFrameTime=new i(e)}t.prototype.sampleFrame=function(t){if(t===void 0){t=e.Tools.Now}if(!this._enabled)return;if(this._lastFrameTimeMs!=null){var i=t-this._lastFrameTimeMs;this._rollingFrameTime.add(i)}this._lastFrameTimeMs=t};Object.defineProperty(t.prototype,"averageFrameTime",{get:function(){
return this._rollingFrameTime.average},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"averageFrameTimeVariance",{get:function(){return this._rollingFrameTime.variance},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"instantaneousFrameTime",{get:function(){return this._rollingFrameTime.history(0)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"averageFPS",{get:function(){return 1e3/this._rollingFrameTime.average},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"instantaneousFPS",{get:function(){var e=this._rollingFrameTime.history(0);if(e===0){return 0}return 1e3/e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"isSaturated",{get:function(){return this._rollingFrameTime.isSaturated()},enumerable:true,configurable:true});t.prototype.enable=function(){this._enabled=true};t.prototype.disable=function(){this._enabled=false;this._lastFrameTimeMs=null};Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._enabled},enumerable:true,configurable:true});t.prototype.reset=function(){this._lastFrameTimeMs=null;this._rollingFrameTime.reset()};return t}();e.PerformanceMonitor=t;var i=function(){function e(e){this._samples=new Array(e);this.reset()}e.prototype.add=function(e){var t;if(this.isSaturated()){var i=this._samples[this._pos];t=i-this.average;this.average-=t/(this._sampleCount-1);this._m2-=t*(i-this.average)}else{this._sampleCount++}t=e-this.average;this.average+=t/this._sampleCount;this._m2+=t*(e-this.average);this.variance=this._m2/(this._sampleCount-1);this._samples[this._pos]=e;this._pos++;this._pos%=this._samples.length};e.prototype.history=function(e){if(e>=this._sampleCount||e>=this._samples.length){return 0}var t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]};e.prototype.isSaturated=function(){return this._sampleCount>=this._samples.length};e.prototype.reset=function(){this.average=0;this.variance=0;this._sampleCount=0;this._pos=0;this._m2=0};e.prototype._wrapPosition=function(e){var t=this._samples.length;return(e%t+t)%t};return e}();e.RollingAverage=i})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this.colorCurves=new e.ColorCurves;this._colorCurvesEnabled=false;this._colorGradingEnabled=false;this._colorGradingWithGreenDepth=true;this._colorGradingBGR=true;this._exposure=1;this._toneMappingEnabled=false;this._contrast=1;this.vignetteStretch=0;this.vignetteCentreX=0;this.vignetteCentreY=0;this.vignetteWeight=1.5;this.vignetteColor=new e.Color4(0,0,0,0);this.vignetteCameraFov=.5;this._vignetteBlendMode=t.VIGNETTEMODE_MULTIPLY;this._vignetteEnabled=false;this._applyByPostProcess=false;this._isEnabled=true;this.onUpdateParameters=new e.Observable}Object.defineProperty(t.prototype,"colorCurvesEnabled",{get:function(){return this._colorCurvesEnabled},set:function(e){if(this._colorCurvesEnabled===e){return}this._colorCurvesEnabled=e;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"colorGradingEnabled",{get:function(){return this._colorGradingEnabled},set:function(e){if(this._colorGradingEnabled===e){return}this._colorGradingEnabled=e;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"colorGradingWithGreenDepth",{get:function(){return this._colorGradingWithGreenDepth},set:function(e){if(this._colorGradingWithGreenDepth===e){return}this._colorGradingWithGreenDepth=e;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"colorGradingBGR",{get:function(){return this._colorGradingBGR},set:function(e){if(this._colorGradingBGR===e){return}this._colorGradingBGR=e;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"exposure",{get:function(){return this._exposure},set:function(e){if(this._exposure===e){return}this._exposure=e;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"toneMappingEnabled",{get:function(){return this._toneMappingEnabled},set:function(e){if(this._toneMappingEnabled===e){return}this._toneMappingEnabled=e;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"contrast",{get:function(){return this._contrast},set:function(e){if(this._contrast===e){return}this._contrast=e;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"vignetteBlendMode",{get:function(){return this._vignetteBlendMode},set:function(e){if(this._vignetteBlendMode===e){return}this._vignetteBlendMode=e;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"vignetteEnabled",{get:function(){return this._vignetteEnabled},set:function(e){if(this._vignetteEnabled===e){return}this._vignetteEnabled=e;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"applyByPostProcess",{get:function(){return this._applyByPostProcess},set:function(e){if(this._applyByPostProcess===e){return}this._applyByPostProcess=e;this._updateParameters()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){if(this._isEnabled===e){return}this._isEnabled=e;this._updateParameters()},enumerable:true,configurable:true});t.prototype._updateParameters=function(){this.onUpdateParameters.notifyObservers(this)};t.prototype.getClassName=function(){return"ImageProcessingConfiguration"};t.PrepareUniforms=function(t,i){if(i.EXPOSURE){t.push("exposureLinear")}if(i.CONTRAST){t.push("contrast")}if(i.COLORGRADING){t.push("colorTransformSettings")}if(i.VIGNETTE){t.push("vInverseScreenSize");t.push("vignetteSettings1");t.push("vignetteSettings2")}if(i.COLORCURVES){e.ColorCurves.PrepareUniforms(t)}};t.PrepareSamplers=function(e,t){if(t.COLORGRADING){e.push("txColorTransform")}};t.prototype.prepareDefines=function(e,i){if(i===void 0){i=false}if(i!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=false;e.TONEMAPPING=false;e.CONTRAST=false;e.EXPOSURE=false;e.COLORCURVES=false;e.COLORGRADING=false;e.COLORGRADING3D=false;e.IMAGEPROCESSING=false;e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}e.VIGNETTE=this.vignetteEnabled;e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===t._VIGNETTEMODE_MULTIPLY;e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY;e.TONEMAPPING=this.toneMappingEnabled;e.CONTRAST=this.contrast!==1;e.EXPOSURE=this.exposure!==1;e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves;e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture;if(e.COLORGRADING){e.COLORGRADING3D=this.colorGradingTexture.is3D}else{e.COLORGRADING3D=false}e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth;e.SAMPLER3DBGRMAP=this.colorGradingBGR;e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess;e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING};t.prototype.isReady=function(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()};t.prototype.bind=function(t,i){if(i===void 0){i=1}if(this._colorCurvesEnabled&&this.colorCurves){e.ColorCurves.Bind(this.colorCurves,t)}if(this._vignetteEnabled){var r=1/t.getEngine().getRenderWidth();var n=1/t.getEngine().getRenderHeight();t.setFloat2("vInverseScreenSize",r,n);var o=Math.tan(this.vignetteCameraFov*.5);var s=o*i;var a=Math.sqrt(s*o);s=e.Tools.Mix(s,a,this.vignetteStretch);o=e.Tools.Mix(o,a,this.vignetteStretch);t.setFloat4("vignetteSettings1",s,o,-s*this.vignetteCentreX,-o*this.vignetteCentreY);var u=-2*this.vignetteWeight;t.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,u)}t.setFloat("exposureLinear",this.exposure);t.setFloat("contrast",this.contrast);if(this.colorGradingTexture){t.setTexture("txColorTransform",this.colorGradingTexture);var l=this.colorGradingTexture.getSize().height;t.setFloat4("colorTransformSettings",(l-1)/l,.5/l,l,this.colorGradingTexture.level)}};t.prototype.clone=function(){return e.SerializationHelper.Clone(function(){return new t},this)};t.prototype.serialize=function(){return e.SerializationHelper.Serialize(this)};t.Parse=function(i){return e.SerializationHelper.Parse(function(){return new t},i,null,null)};Object.defineProperty(t,"VIGNETTEMODE_MULTIPLY",{get:function(){return this._VIGNETTEMODE_MULTIPLY},enumerable:true,configurable:true});Object.defineProperty(t,"VIGNETTEMODE_OPAQUE",{get:function(){return this._VIGNETTEMODE_OPAQUE},enumerable:true,configurable:true});t._VIGNETTEMODE_MULTIPLY=0;t._VIGNETTEMODE_OPAQUE=1;__decorate([e.serializeAsColorCurves()],t.prototype,"colorCurves",void 0);__decorate([e.serialize()],t.prototype,"_colorCurvesEnabled",void 0);__decorate([e.serializeAsTexture()],t.prototype,"colorGradingTexture",void 0);__decorate([e.serialize()],t.prototype,"_colorGradingEnabled",void 0);__decorate([e.serialize()],t.prototype,"_colorGradingWithGreenDepth",void 0);__decorate([e.serialize()],t.prototype,"_colorGradingBGR",void 0);__decorate([e.serialize()],t.prototype,"_exposure",void 0);__decorate([e.serialize()],t.prototype,"_toneMappingEnabled",void 0);__decorate([e.serialize()],t.prototype,"_contrast",void 0);__decorate([e.serialize()],t.prototype,"vignetteStretch",void 0);__decorate([e.serialize()],t.prototype,"vignetteCentreX",void 0);__decorate([e.serialize()],t.prototype,"vignetteCentreY",void 0);__decorate([e.serialize()],t.prototype,"vignetteWeight",void 0);__decorate([e.serializeAsColor4()],t.prototype,"vignetteColor",void 0);__decorate([e.serialize()],t.prototype,"vignetteCameraFov",void 0);__decorate([e.serialize()],t.prototype,"_vignetteBlendMode",void 0);__decorate([e.serialize()],t.prototype,"_vignetteEnabled",void 0);__decorate([e.serialize()],t.prototype,"_applyByPostProcess",void 0);__decorate([e.serialize()],t.prototype,"_isEnabled",void 0);return t}();e.ImageProcessingConfiguration=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r){var n=t.call(this,r)||this;if(!i){return n}n._engine=r.getEngine();n._textureMatrix=e.Matrix.Identity();n.name=i;n.url=i;n.hasAlpha=false;n.isCube=false;n.is3D=n._engine.webGLVersion>1;n.wrapU=e.Texture.CLAMP_ADDRESSMODE;n.wrapV=e.Texture.CLAMP_ADDRESSMODE;n.wrapR=e.Texture.CLAMP_ADDRESSMODE;n.anisotropicFilteringLevel=1;n._texture=n._getFromCache(i,true);if(!n._texture){if(!r.useDelayedTextureLoading){n.loadTexture()}else{n.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED}}return n}i.prototype.getTextureMatrix=function(){return this._textureMatrix};i.prototype.load3dlTexture=function(){var t=this._engine;var r;if(t.webGLVersion===1){r=t.createRawTexture(null,1,1,e.Engine.TEXTUREFORMAT_RGBA,false,false,e.Texture.BILINEAR_SAMPLINGMODE)}else{r=t.createRawTexture3D(null,1,1,1,e.Engine.TEXTUREFORMAT_RGBA,false,false,e.Texture.BILINEAR_SAMPLINGMODE)}this._texture=r;var n=function(n){if(typeof n!=="string"){return}var o=null;var s=null;var a;var u=n.split("\n");var l=0,c=0,h=0,f=0;var d=0;for(var p=0;p<u.length;p++){a=u[p];if(!i._noneEmptyLineRegex.test(a))continue;if(a.indexOf("#")===0)continue;var _=a.split(" ");if(l===0){l=_.length;o=new Uint8Array(l*l*l*4);s=new Float32Array(l*l*l*4);continue}if(l!=0){var m=Math.max(parseInt(_[0]),0);var g=Math.max(parseInt(_[1]),0);var v=Math.max(parseInt(_[2]),0);d=Math.max(m,d);d=Math.max(g,d);d=Math.max(v,d);var y=(c+f*l+h*l*l)*4;if(s){s[y+0]=m;s[y+1]=g;s[y+2]=v}f++;if(f%l==0){h++;f=0;if(h%l==0){c++;h=0}}}}if(s&&o){for(var p=0;p<s.length;p++){if(p>0&&(p+1)%4===0){o[p]=255}else{var b=s[p];o[p]=b/d*255}}}if(r.is3D){r.updateSize(l,l,l);t.updateRawTexture3D(r,o,e.Engine.TEXTUREFORMAT_RGBA,false)}else{r.updateSize(l*l,l);t.updateRawTexture(r,o,e.Engine.TEXTUREFORMAT_RGBA,false)}};var o=this.getScene();if(o){o._loadFile(this.url,n)}else{this._engine._loadFile(this.url,n)}return this._texture};i.prototype.loadTexture=function(){if(this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4){this.load3dlTexture()}};i.prototype.clone=function(){var e=new i(this.url,this.getScene());e.level=this.level;return e};i.prototype.delayLoad=function(){if(this.delayLoadState!==e.Engine.DELAYLOADSTATE_NOTLOADED){return}this.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED;this._texture=this._getFromCache(this.url,true);if(!this._texture){this.loadTexture()}};i.Parse=function(e,t,r){var n=null;if(e.name&&!e.isRenderTarget){n=new i(e.name,t);n.name=e.name;n.level=e.level}return n};i.prototype.serialize=function(){if(!this.name){return null}var e={};e.name=this.name;e.level=this.level;e.customType="BABYLON.ColorGradingTexture";return e};i._noneEmptyLineRegex=/\S+/;return i}(e.BaseTexture);e.ColorGradingTexture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this._dirty=true;this._tempColor=new e.Color4(0,0,0,0);this._globalCurve=new e.Color4(0,0,0,0);this._highlightsCurve=new e.Color4(0,0,0,0);this._midtonesCurve=new e.Color4(0,0,0,0);this._shadowsCurve=new e.Color4(0,0,0,0);this._positiveCurve=new e.Color4(0,0,0,0);this._negativeCurve=new e.Color4(0,0,0,0);this._globalHue=30;this._globalDensity=0;this._globalSaturation=0;this._globalExposure=0;this._highlightsHue=30;this._highlightsDensity=0;this._highlightsSaturation=0;this._highlightsExposure=0;this._midtonesHue=30;this._midtonesDensity=0;this._midtonesSaturation=0;this._midtonesExposure=0;this._shadowsHue=30;this._shadowsDensity=0;this._shadowsSaturation=0;this._shadowsExposure=0}Object.defineProperty(t.prototype,"globalHue",{get:function(){return this._globalHue},set:function(e){this._globalHue=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"globalDensity",{get:function(){return this._globalDensity},set:function(e){this._globalDensity=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"globalSaturation",{get:function(){return this._globalSaturation},set:function(e){this._globalSaturation=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"highlightsHue",{get:function(){return this._highlightsHue},set:function(e){this._highlightsHue=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"highlightsDensity",{get:function(){return this._highlightsDensity},set:function(e){this._highlightsDensity=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"highlightsSaturation",{get:function(){return this._highlightsSaturation},set:function(e){this._highlightsSaturation=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"highlightsExposure",{get:function(){return this._highlightsExposure},set:function(e){this._highlightsExposure=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"midtonesHue",{get:function(){return this._midtonesHue},set:function(e){this._midtonesHue=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"midtonesDensity",{get:function(){return this._midtonesDensity},set:function(e){this._midtonesDensity=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"midtonesSaturation",{get:function(){return this._midtonesSaturation},set:function(e){this._midtonesSaturation=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"midtonesExposure",{get:function(){return this._midtonesExposure},set:function(e){this._midtonesExposure=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"shadowsHue",{get:function(){return this._shadowsHue},set:function(e){this._shadowsHue=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"shadowsDensity",{get:function(){return this._shadowsDensity},set:function(e){this._shadowsDensity=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"shadowsSaturation",{get:function(){return this._shadowsSaturation},set:function(e){this._shadowsSaturation=e;this._dirty=true},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"shadowsExposure",{get:function(){return this._shadowsExposure},set:function(e){this._shadowsExposure=e;this._dirty=true},enumerable:true,configurable:true});t.prototype.getClassName=function(){return"ColorCurves"};t.Bind=function(e,t,i,r,n){if(i===void 0){i="vCameraColorCurvePositive"}if(r===void 0){r="vCameraColorCurveNeutral"}if(n===void 0){n="vCameraColorCurveNegative"}if(e._dirty){e._dirty=false;e.getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve);e.getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor);e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve);e.getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor);e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve);e.getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor);e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve);e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve);e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)}if(t){t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a);t.setFloat4(r,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a);t.setFloat4(n,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a)}};t.PrepareUniforms=function(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")};t.prototype.getColorGradingDataToRef=function(e,i,r,n,o){if(e==null){return}e=t.clamp(e,0,360);i=t.clamp(i,-100,100);r=t.clamp(r,-100,100);n=t.clamp(n,-100,100);i=t.applyColorGradingSliderNonlinear(i);i*=.5;n=t.applyColorGradingSliderNonlinear(n);if(i<0){i*=-1;e=(e+180)%360}t.fromHSBToRef(e,i,50+.25*n,o);o.scaleToRef(2,o);o.a=1+.01*r};t.applyColorGradingSliderNonlinear=function(e){e/=100;var t=Math.abs(e);t=Math.pow(t,2);if(e<0){t*=-1}t*=100;return t};t.fromHSBToRef=function(e,i,r,n){var o=t.clamp(e,0,360);var s=t.clamp(i/100,0,1);var a=t.clamp(r/100,0,1);if(s===0){n.r=a;n.g=a;n.b=a}else{o/=60;var u=Math.floor(o);var l=o-u;var c=a*(1-s);var h=a*(1-s*l);var f=a*(1-s*(1-l));switch(u){case 0:n.r=a;n.g=f;n.b=c;break;case 1:n.r=h;n.g=a;n.b=c;break;case 2:n.r=c;n.g=a;n.b=f;break;case 3:n.r=c;n.g=h;n.b=a;break;case 4:n.r=f;n.g=c;n.b=a;break;default:n.r=a;n.g=c;n.b=h;break}}n.a=1};t.clamp=function(e,t,i){return Math.min(Math.max(e,t),i)};t.prototype.clone=function(){return e.SerializationHelper.Clone(function(){return new t},this)};t.prototype.serialize=function(){return e.SerializationHelper.Serialize(this)};t.Parse=function(i){return e.SerializationHelper.Parse(function(){return new t},i,null,null)};__decorate([e.serialize()],t.prototype,"_globalHue",void 0);__decorate([e.serialize()],t.prototype,"_globalDensity",void 0);__decorate([e.serialize()],t.prototype,"_globalSaturation",void 0);__decorate([e.serialize()],t.prototype,"_globalExposure",void 0);__decorate([e.serialize()],t.prototype,"_highlightsHue",void 0);__decorate([e.serialize()],t.prototype,"_highlightsDensity",void 0);__decorate([e.serialize()],t.prototype,"_highlightsSaturation",void 0);__decorate([e.serialize()],t.prototype,"_highlightsExposure",void 0);__decorate([e.serialize()],t.prototype,"_midtonesHue",void 0);__decorate([e.serialize()],t.prototype,"_midtonesDensity",void 0);__decorate([e.serialize()],t.prototype,"_midtonesSaturation",void 0);__decorate([e.serialize()],t.prototype,"_midtonesExposure",void 0);return t}();e.ColorCurves=t})(r||(r={}));"use strict";"use strict";var r;(function(e){var t=function(){function t(){}t.BindEyePosition=function(e,t){if(t._forcedViewPosition){e.setVector3("vEyePosition",t._forcedViewPosition);return}e.setVector3("vEyePosition",t._mirroredCameraPosition?t._mirroredCameraPosition:t.activeCamera.globalPosition)};t.PrepareDefinesForMergedUV=function(e,t,i){t._needUVs=true;t[i]=true;if(e.getTextureMatrix().isIdentity(true)){t[i+"DIRECTUV"]=e.coordinatesIndex+1;if(e.coordinatesIndex===0){t["MAINUV1"]=true}else{t["MAINUV2"]=true}}else{t[i+"DIRECTUV"]=0}};t.BindTextureMatrix=function(e,t,i){var r=e.getTextureMatrix();if(!r.isIdentity(true)){t.updateMatrix(i+"Matrix",r)}};t.PrepareDefinesForMisc=function(t,i,r,n,o,s,a){if(a._areMiscDirty){a["LOGARITHMICDEPTH"]=r;a["POINTSIZE"]=n;a["FOG"]=i.fogEnabled&&t.applyFog&&i.fogMode!==e.Scene.FOGMODE_NONE&&o;a["NONUNIFORMSCALING"]=t.nonUniformScaling;a["ALPHATEST"]=s}};t.PrepareDefinesForFrameBoundValues=function(e,t,i,r,n){if(n===void 0){n=null}var o=false;if(n==null){n=e.clipPlane!==undefined&&e.clipPlane!==null}if(i["CLIPPLANE"]!==n){i["CLIPPLANE"]=n;o=true}if(i["DEPTHPREPASS"]!==!t.getColorWrite()){i["DEPTHPREPASS"]=!i["DEPTHPREPASS"];o=true}if(i["INSTANCES"]!==r){i["INSTANCES"]=r;o=true}if(o){i.markAsUnprocessed()}};t.PrepareDefinesForAttributes=function(t,i,r,n,o,s){if(o===void 0){o=false}if(s===void 0){s=true}if(!i._areAttributesDirty&&i._needNormals===i._normals&&i._needUVs===i._uvs){return false}i._normals=i._needNormals;i._uvs=i._needUVs;i["NORMAL"]=i._needNormals&&t.isVerticesDataPresent(e.VertexBuffer.NormalKind);if(i._needNormals&&t.isVerticesDataPresent(e.VertexBuffer.TangentKind)){i["TANGENT"]=true}if(i._needUVs){i["UV1"]=t.isVerticesDataPresent(e.VertexBuffer.UVKind);i["UV2"]=t.isVerticesDataPresent(e.VertexBuffer.UV2Kind)}else{i["UV1"]=false;i["UV2"]=false}if(r){var a=t.useVertexColors&&t.isVerticesDataPresent(e.VertexBuffer.ColorKind);i["VERTEXCOLOR"]=a;i["VERTEXALPHA"]=t.hasVertexAlpha&&a&&s}if(n){if(t.useBones&&t.computeBonesUsingShaders&&t.skeleton){i["NUM_BONE_INFLUENCERS"]=t.numBoneInfluencers;i["BonesPerMesh"]=t.skeleton.bones.length+1}else{i["NUM_BONE_INFLUENCERS"]=0;i["BonesPerMesh"]=0}}if(o){var u=t.morphTargetManager;if(u){i["MORPHTARGETS_TANGENT"]=u.supportsTangents&&i["TANGENT"];i["MORPHTARGETS_NORMAL"]=u.supportsNormals&&i["NORMAL"];i["MORPHTARGETS"]=u.numInfluencers>0;i["NUM_MORPH_INFLUENCERS"]=u.numInfluencers}else{i["MORPHTARGETS_TANGENT"]=false;i["MORPHTARGETS_NORMAL"]=false;i["MORPHTARGETS"]=false;i["NUM_MORPH_INFLUENCERS"]=0}}return true};t.PrepareDefinesForLights=function(t,i,r,n,o,s){if(o===void 0){o=4}if(s===void 0){s=false}if(!r._areLightsDirty){return r._needNormals}var a=0;var u=false;var l=false;var c=false;var h=false;var f=false;if(t.lightsEnabled&&!s){for(var d=0,p=i._lightSources;d<p.length;d++){var _=p[d];u=true;if(r["LIGHT"+a]===undefined){l=true}r["LIGHT"+a]=true;r["SPOTLIGHT"+a]=false;r["HEMILIGHT"+a]=false;r["POINTLIGHT"+a]=false;r["DIRLIGHT"+a]=false;var m;if(_.getTypeID()===e.Light.LIGHTTYPEID_SPOTLIGHT){m="SPOTLIGHT"+a;var g=_;r["PROJECTEDLIGHTTEXTURE"+a]=g.projectionTexture?g.projectionTexture.isReady():false}else if(_.getTypeID()===e.Light.LIGHTTYPEID_HEMISPHERICLIGHT){m="HEMILIGHT"+a}else if(_.getTypeID()===e.Light.LIGHTTYPEID_POINTLIGHT){m="POINTLIGHT"+a}else{m="DIRLIGHT"+a}r[m]=true;if(n&&!_.specular.equalsFloats(0,0,0)){f=true}r["SHADOW"+a]=false;r["SHADOWPCF"+a]=false;r["SHADOWPCSS"+a]=false;r["SHADOWPOISSON"+a]=false;r["SHADOWESM"+a]=false;r["SHADOWCUBE"+a]=false;r["SHADOWLOWQUALITY"+a]=false;r["SHADOWMEDIUMQUALITY"+a]=false;if(i&&i.receiveShadows&&t.shadowsEnabled&&_.shadowEnabled){var v=_.getShadowGenerator();if(v){h=true;v.prepareDefines(r,a)}}if(_.lightmapMode!=e.Light.LIGHTMAP_DEFAULT){c=true;r["LIGHTMAPEXCLUDED"+a]=true;r["LIGHTMAPNOSPECULAR"+a]=_.lightmapMode==e.Light.LIGHTMAP_SHADOWSONLY}else{r["LIGHTMAPEXCLUDED"+a]=false;r["LIGHTMAPNOSPECULAR"+a]=false}a++;if(a===o)break}}r["SPECULARTERM"]=f;r["SHADOWS"]=h;for(var y=a;y<o;y++){if(r["LIGHT"+y]!==undefined){r["LIGHT"+y]=false;r["HEMILIGHT"+a]=false;r["POINTLIGHT"+a]=false;r["DIRLIGHT"+a]=false;r["SPOTLIGHT"+a]=false;r["SHADOW"+a]=false}}var b=t.getEngine().getCaps();if(r["SHADOWFLOAT"]===undefined){l=true}r["SHADOWFLOAT"]=h&&(b.textureFloatRender&&b.textureFloatLinearFiltering||b.textureHalfFloatRender&&b.textureHalfFloatLinearFiltering);r["LIGHTMAPEXCLUDED"]=c;if(l){r.rebuild()}return u};t.PrepareUniformsAndSamplersList=function(e,t,i,r){if(r===void 0){r=4}var n;var o=null;if(e.uniformsNames){var s=e;n=s.uniformsNames;o=s.uniformBuffersNames;t=s.samplers;i=s.defines;r=s.maxSimultaneousLights}else{n=e;if(!t){t=[]}}for(var a=0;a<r;a++){if(!i["LIGHT"+a]){break}n.push("vLightData"+a,"vLightDiffuse"+a,"vLightSpecular"+a,"vLightDirection"+a,"vLightGround"+a,"lightMatrix"+a,"shadowsInfo"+a,"depthValues"+a);if(o){o.push("Light"+a)}t.push("shadowSampler"+a);t.push("depthSampler"+a);if(i["PROJECTEDLIGHTTEXTURE"+a]){t.push("projectionLightSampler"+a);n.push("textureProjectionMatrix"+a)}}if(i["NUM_MORPH_INFLUENCERS"]){n.push("morphTargetInfluences")}};t.HandleFallbacksForShadows=function(e,t,i,r){if(i===void 0){i=4}if(r===void 0){r=0}var n=0;for(var o=0;o<i;o++){if(!e["LIGHT"+o]){break}if(o>0){n=r+o;t.addFallback(n,"LIGHT"+o)}if(!e["SHADOWS"]){if(e["SHADOW"+o]){t.addFallback(r,"SHADOW"+o)}if(e["SHADOWPCF"+o]){t.addFallback(r,"SHADOWPCF"+o)}if(e["SHADOWPCSS"+o]){t.addFallback(r,"SHADOWPCSS"+o)}if(e["SHADOWPOISSON"+o]){t.addFallback(r,"SHADOWPOISSON"+o)}if(e["SHADOWESM"+o]){t.addFallback(r,"SHADOWESM"+o)}}}return n++};t.PrepareAttributesForMorphTargets=function(t,i,r){var n=r["NUM_MORPH_INFLUENCERS"];if(n>0&&e.Engine.LastCreatedEngine){var o=e.Engine.LastCreatedEngine.getCaps().maxVertexAttribs;var s=i.morphTargetManager;var a=s&&s.supportsNormals&&r["NORMAL"];var u=s&&s.supportsTangents&&r["TANGENT"];for(var l=0;l<n;l++){t.push(e.VertexBuffer.PositionKind+l);if(a){t.push(e.VertexBuffer.NormalKind+l)}if(u){t.push(e.VertexBuffer.TangentKind+l)}if(t.length>o){e.Tools.Error("Cannot add more vertex attributes for mesh "+i.name)}}}};t.PrepareAttributesForBones=function(t,i,r,n){if(r["NUM_BONE_INFLUENCERS"]>0){n.addCPUSkinningFallback(0,i);t.push(e.VertexBuffer.MatricesIndicesKind);t.push(e.VertexBuffer.MatricesWeightsKind);if(r["NUM_BONE_INFLUENCERS"]>4){t.push(e.VertexBuffer.MatricesIndicesExtraKind);t.push(e.VertexBuffer.MatricesWeightsExtraKind)}}};t.PrepareAttributesForInstances=function(e,t){if(t["INSTANCES"]){e.push("world0");e.push("world1");e.push("world2");e.push("world3")}};t.BindLightShadow=function(e,t,i,r,n){if(e.shadowEnabled&&i.receiveShadows){var o=e.getShadowGenerator();if(o){o.bindShadowLight(r,n)}}};t.BindLightProperties=function(e,t,i){e.transferToEffect(t,i+"")};t.BindLights=function(i,r,n,o,s,a){if(s===void 0){s=4}if(a===void 0){a=false}var u=Math.min(r._lightSources.length,s);for(var l=0;l<u;l++){var c=r._lightSources[l];var h=l.toString();var f=c.getScaledIntensity();c._uniformBuffer.bindToEffect(n,"Light"+l);t.BindLightProperties(c,n,l);c.diffuse.scaleToRef(f,e.Tmp.Color3[0]);c._uniformBuffer.updateColor4("vLightDiffuse",e.Tmp.Color3[0],a?c.radius:c.range,h);if(o["SPECULARTERM"]){c.specular.scaleToRef(f,e.Tmp.Color3[1]);c._uniformBuffer.updateColor3("vLightSpecular",e.Tmp.Color3[1],h)}if(i.shadowsEnabled){this.BindLightShadow(c,i,r,h,n)}c._uniformBuffer.update()}};t.BindFogParameters=function(t,i,r){if(t.fogEnabled&&i.applyFog&&t.fogMode!==e.Scene.FOGMODE_NONE){r.setFloat4("vFogInfos",t.fogMode,t.fogStart,t.fogEnd,t.fogDensity);r.setColor3("vFogColor",t.fogColor)}};t.BindBonesParameters=function(e,t){if(e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){var i=e.skeleton.getTransformMatrices(e);if(i&&t){t.setMatrices("mBones",i)}}};t.BindMorphTargetParameters=function(e,t){var i=e.morphTargetManager;if(!e||!i){return}t.setFloatArray("morphTargetInfluences",i.influences)};t.BindLogDepth=function(e,t,i){if(e["LOGARITHMICDEPTH"]){t.setFloat("logarithmicDepthConstant",2/(Math.log(i.activeCamera.maxZ+1)/Math.LN2))}};t.BindClipPlane=function(e,t){if(t.clipPlane){var i=t.clipPlane;e.setFloat4("vClipPlane",i.normal.x,i.normal.y,i.normal.z,i.d)}};return t}();e.MaterialHelper=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r){var n=t.call(this,i,r)||this;n._normalMatrix=new e.Matrix;n.storeEffectOnSubMeshes=true;return n}i.prototype.getEffect=function(){return this._activeEffect};i.prototype.isReady=function(e,t){if(!e){return false}if(!e.subMeshes||e.subMeshes.length===0){return true}return this.isReadyForSubMesh(e,e.subMeshes[0],t)};i.prototype.bindOnlyWorldMatrix=function(e){this._activeEffect.setMatrix("world",e)};i.prototype.bindOnlyNormalMatrix=function(e){this._activeEffect.setMatrix("normalMatrix",e)};i.prototype.bind=function(e,t){if(!t){return}this.bindForSubMesh(e,t,t.subMeshes[0])};i.prototype._afterBind=function(e,i){if(i===void 0){i=null}t.prototype._afterBind.call(this,e);this.getScene()._cachedEffect=i};i.prototype._mustRebind=function(e,t,i){if(i===void 0){i=1}return e.isCachedMaterialInvalid(this,t,i)};return i}(e.Material);e.PushMaterial=t})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(){var t=e.call(this)||this;t.MAINUV1=false;t.MAINUV2=false;t.DIFFUSE=false;t.DIFFUSEDIRECTUV=0;t.AMBIENT=false;t.AMBIENTDIRECTUV=0;t.OPACITY=false;t.OPACITYDIRECTUV=0;t.OPACITYRGB=false;t.REFLECTION=false;t.EMISSIVE=false;t.EMISSIVEDIRECTUV=0;t.SPECULAR=false;t.SPECULARDIRECTUV=0;t.BUMP=false;t.BUMPDIRECTUV=0;t.PARALLAX=false;t.PARALLAXOCCLUSION=false;t.SPECULAROVERALPHA=false;t.CLIPPLANE=false;t.ALPHATEST=false;t.DEPTHPREPASS=false;t.ALPHAFROMDIFFUSE=false;t.POINTSIZE=false;t.FOG=false;t.SPECULARTERM=false;t.DIFFUSEFRESNEL=false;t.OPACITYFRESNEL=false;t.REFLECTIONFRESNEL=false;t.REFRACTIONFRESNEL=false;t.EMISSIVEFRESNEL=false;t.FRESNEL=false;t.NORMAL=false;t.UV1=false;t.UV2=false;t.VERTEXCOLOR=false;t.VERTEXALPHA=false;t.NUM_BONE_INFLUENCERS=0;t.BonesPerMesh=0;t.INSTANCES=false;t.GLOSSINESS=false;t.ROUGHNESS=false;t.EMISSIVEASILLUMINATION=false;t.LINKEMISSIVEWITHDIFFUSE=false;t.REFLECTIONFRESNELFROMSPECULAR=false;t.LIGHTMAP=false;t.LIGHTMAPDIRECTUV=0;t.OBJECTSPACE_NORMALMAP=false;t.USELIGHTMAPASSHADOWMAP=false;t.REFLECTIONMAP_3D=false;t.REFLECTIONMAP_SPHERICAL=false;t.REFLECTIONMAP_PLANAR=false;t.REFLECTIONMAP_CUBIC=false;t.USE_LOCAL_REFLECTIONMAP_CUBIC=false;t.REFLECTIONMAP_PROJECTION=false;t.REFLECTIONMAP_SKYBOX=false;t.REFLECTIONMAP_EXPLICIT=false;t.REFLECTIONMAP_EQUIRECTANGULAR=false;t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false;t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false;t.INVERTCUBICMAP=false;t.LOGARITHMICDEPTH=false;t.REFRACTION=false;t.REFRACTIONMAP_3D=false;t.REFLECTIONOVERALPHA=false;t.TWOSIDEDLIGHTING=false;t.SHADOWFLOAT=false;t.MORPHTARGETS=false;t.MORPHTARGETS_NORMAL=false;t.MORPHTARGETS_TANGENT=false;t.NUM_MORPH_INFLUENCERS=0;t.NONUNIFORMSCALING=false;t.PREMULTIPLYALPHA=false;t.IMAGEPROCESSING=false;t.VIGNETTE=false;t.VIGNETTEBLENDMODEMULTIPLY=false;t.VIGNETTEBLENDMODEOPAQUE=false;t.TONEMAPPING=false;t.CONTRAST=false;t.COLORCURVES=false;t.COLORGRADING=false;t.COLORGRADING3D=false;t.SAMPLER3DGREENDEPTH=false;t.SAMPLER3DBGRMAP=false;t.IMAGEPROCESSINGPOSTPROCESS=false;t.EXPOSURE=false;t.rebuild();return t}t.prototype.setReflectionMode=function(e){var t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(var i=0,r=t;i<r.length;i++){var n=r[i];this[n]=n===e}};return t}(e.MaterialDefines);e.StandardMaterialDefines=t;var i=function(i){__extends(r,i);function r(t,n){var o=i.call(this,t,n)||this;o.ambientColor=new e.Color3(0,0,0);o.diffuseColor=new e.Color3(1,1,1);o.specularColor=new e.Color3(1,1,1);o.emissiveColor=new e.Color3(0,0,0);o.specularPower=64;o._useAlphaFromDiffuseTexture=false;o._useEmissiveAsIllumination=false;o._linkEmissiveWithDiffuse=false
;o._useSpecularOverAlpha=false;o._useReflectionOverAlpha=false;o._disableLighting=false;o._useObjectSpaceNormalMap=false;o._useParallax=false;o._useParallaxOcclusion=false;o.parallaxScaleBias=.05;o._roughness=0;o.indexOfRefraction=.98;o.invertRefractionY=true;o._useLightmapAsShadowmap=false;o._useReflectionFresnelFromSpecular=false;o._useGlossinessFromSpecularMapAlpha=false;o._maxSimultaneousLights=4;o._invertNormalMapX=false;o._invertNormalMapY=false;o._twoSidedLighting=false;o._renderTargets=new e.SmartArray(16);o._worldViewProjectionMatrix=e.Matrix.Zero();o._globalAmbientColor=new e.Color3(0,0,0);o._attachImageProcessingConfiguration(null);o.getRenderTargetTextures=function(){o._renderTargets.reset();if(r.ReflectionTextureEnabled&&o._reflectionTexture&&o._reflectionTexture.isRenderTarget){o._renderTargets.push(o._reflectionTexture)}if(r.RefractionTextureEnabled&&o._refractionTexture&&o._refractionTexture.isRenderTarget){o._renderTargets.push(o._refractionTexture)}return o._renderTargets};return o}Object.defineProperty(r.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e);this._markAllSubMeshesAsTexturesDirty()},enumerable:true,configurable:true});r.prototype._attachImageProcessingConfiguration=function(e){var t=this;if(e===this._imageProcessingConfiguration){return}if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}if(!e){this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration}else{this._imageProcessingConfiguration=e}this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(e){t._markAllSubMeshesAsImageProcessingDirty()})};Object.defineProperty(r.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(e){this._imageProcessingConfiguration.exposure=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(e){this._imageProcessingConfiguration.contrast=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(e){this._imageProcessingConfiguration.colorGradingTexture=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(e){this._imageProcessingConfiguration.colorCurves=e},enumerable:true,configurable:true});r.prototype.getClassName=function(){return"StandardMaterial"};Object.defineProperty(r.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported;this._markAllSubMeshesAsMiscDirty()},enumerable:true,configurable:true});r.prototype.needAlphaBlending=function(){return this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled};r.prototype.needAlphaTesting=function(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha};r.prototype._shouldUseAlphaFromDiffuseTexture=function(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture};r.prototype.getAlphaTestTexture=function(){return this._diffuseTexture};r.prototype.isReadyForSubMesh=function(i,n,o){if(o===void 0){o=false}if(n.effect&&this.isFrozen){if(this._wasPreviouslyReady&&n.effect){return true}}if(!n._materialDefines){n._materialDefines=new t}var s=this.getScene();var a=n._materialDefines;if(!this.checkReadyOnEveryCall&&n.effect){if(a._renderId===s.getRenderId()){return true}}var u=s.getEngine();a._needNormals=e.MaterialHelper.PrepareDefinesForLights(s,i,a,true,this._maxSimultaneousLights,this._disableLighting);if(a._areTexturesDirty){a._needUVs=false;a.MAINUV1=false;a.MAINUV2=false;if(s.texturesEnabled){if(this._diffuseTexture&&r.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking()){return false}else{e.MaterialHelper.PrepareDefinesForMergedUV(this._diffuseTexture,a,"DIFFUSE")}}else{a.DIFFUSE=false}if(this._ambientTexture&&r.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking()){return false}else{e.MaterialHelper.PrepareDefinesForMergedUV(this._ambientTexture,a,"AMBIENT")}}else{a.AMBIENT=false}if(this._opacityTexture&&r.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking()){return false}else{e.MaterialHelper.PrepareDefinesForMergedUV(this._opacityTexture,a,"OPACITY");a.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}}else{a.OPACITY=false}if(this._reflectionTexture&&r.ReflectionTextureEnabled){if(!this._reflectionTexture.isReadyOrNotBlocking()){return false}else{a._needNormals=true;a.REFLECTION=true;a.ROUGHNESS=this._roughness>0;a.REFLECTIONOVERALPHA=this._useReflectionOverAlpha;a.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===e.Texture.INVCUBIC_MODE;a.REFLECTIONMAP_3D=this._reflectionTexture.isCube;switch(this._reflectionTexture.coordinatesMode){case e.Texture.CUBIC_MODE:case e.Texture.INVCUBIC_MODE:a.setReflectionMode("REFLECTIONMAP_CUBIC");break;case e.Texture.EXPLICIT_MODE:a.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case e.Texture.PLANAR_MODE:a.setReflectionMode("REFLECTIONMAP_PLANAR");break;case e.Texture.PROJECTION_MODE:a.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case e.Texture.SKYBOX_MODE:a.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case e.Texture.SPHERICAL_MODE:a.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case e.Texture.EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case e.Texture.FIXED_EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case e.Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break}a.USE_LOCAL_REFLECTIONMAP_CUBIC=this._reflectionTexture.boundingBoxSize?true:false}}else{a.REFLECTION=false}if(this._emissiveTexture&&r.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking()){return false}else{e.MaterialHelper.PrepareDefinesForMergedUV(this._emissiveTexture,a,"EMISSIVE")}}else{a.EMISSIVE=false}if(this._lightmapTexture&&r.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking()){return false}else{e.MaterialHelper.PrepareDefinesForMergedUV(this._lightmapTexture,a,"LIGHTMAP");a.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap}}else{a.LIGHTMAP=false}if(this._specularTexture&&r.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking()){return false}else{e.MaterialHelper.PrepareDefinesForMergedUV(this._specularTexture,a,"SPECULAR");a.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha}}else{a.SPECULAR=false}if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&r.BumpTextureEnabled){if(!this._bumpTexture.isReady()){return false}else{e.MaterialHelper.PrepareDefinesForMergedUV(this._bumpTexture,a,"BUMP");a.PARALLAX=this._useParallax;a.PARALLAXOCCLUSION=this._useParallaxOcclusion}a.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else{a.BUMP=false}if(this._refractionTexture&&r.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking()){return false}else{a._needUVs=true;a.REFRACTION=true;a.REFRACTIONMAP_3D=this._refractionTexture.isCube}}else{a.REFRACTION=false}a.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else{a.DIFFUSE=false;a.AMBIENT=false;a.OPACITY=false;a.REFLECTION=false;a.EMISSIVE=false;a.LIGHTMAP=false;a.BUMP=false;a.REFRACTION=false}a.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture();a.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination;a.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse;a.SPECULAROVERALPHA=this._useSpecularOverAlpha;a.PREMULTIPLYALPHA=this.alphaMode===e.Engine.ALPHA_PREMULTIPLIED||this.alphaMode===e.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF}if(a._areImageProcessingDirty){if(!this._imageProcessingConfiguration.isReady()){return false}this._imageProcessingConfiguration.prepareDefines(a)}if(a._areFresnelDirty){if(r.FresnelEnabled){if(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters){a.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled;a.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled;a.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled;a.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular;a.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled;a.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled;a._needNormals=true;a.FRESNEL=true}}else{a.FRESNEL=false}}e.MaterialHelper.PrepareDefinesForMisc(i,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(i),a);e.MaterialHelper.PrepareDefinesForAttributes(i,a,true,true,true);e.MaterialHelper.PrepareDefinesForFrameBoundValues(s,u,a,o);if(a.isDirty){a.markAsProcessed();s.resetCachedMaterial();var l=new e.EffectFallbacks;if(a.REFLECTION){l.addFallback(0,"REFLECTION")}if(a.SPECULAR){l.addFallback(0,"SPECULAR")}if(a.BUMP){l.addFallback(0,"BUMP")}if(a.PARALLAX){l.addFallback(1,"PARALLAX")}if(a.PARALLAXOCCLUSION){l.addFallback(0,"PARALLAXOCCLUSION")}if(a.SPECULAROVERALPHA){l.addFallback(0,"SPECULAROVERALPHA")}if(a.FOG){l.addFallback(1,"FOG")}if(a.POINTSIZE){l.addFallback(0,"POINTSIZE")}if(a.LOGARITHMICDEPTH){l.addFallback(0,"LOGARITHMICDEPTH")}e.MaterialHelper.HandleFallbacksForShadows(a,l,this._maxSimultaneousLights);if(a.SPECULARTERM){l.addFallback(0,"SPECULARTERM")}if(a.DIFFUSEFRESNEL){l.addFallback(1,"DIFFUSEFRESNEL")}if(a.OPACITYFRESNEL){l.addFallback(2,"OPACITYFRESNEL")}if(a.REFLECTIONFRESNEL){l.addFallback(3,"REFLECTIONFRESNEL")}if(a.EMISSIVEFRESNEL){l.addFallback(4,"EMISSIVEFRESNEL")}if(a.FRESNEL){l.addFallback(4,"FRESNEL")}var c=[e.VertexBuffer.PositionKind];if(a.NORMAL){c.push(e.VertexBuffer.NormalKind)}if(a.UV1){c.push(e.VertexBuffer.UVKind)}if(a.UV2){c.push(e.VertexBuffer.UV2Kind)}if(a.VERTEXCOLOR){c.push(e.VertexBuffer.ColorKind)}e.MaterialHelper.PrepareAttributesForBones(c,i,a,l);e.MaterialHelper.PrepareAttributesForInstances(c,a);e.MaterialHelper.PrepareAttributesForMorphTargets(c,i,a);var h="default";var f=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","logarithmicDepthConstant","vTangentSpaceParams"];var d=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler"];var p=["Material","Scene"];e.ImageProcessingConfiguration.PrepareUniforms(f,a);e.ImageProcessingConfiguration.PrepareSamplers(d,a);e.MaterialHelper.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:p,samplers:d,defines:a,maxSimultaneousLights:this._maxSimultaneousLights});if(this.customShaderNameResolve){h=this.customShaderNameResolve(h,f,p,d,a)}var _=a.toString();n.setEffect(s.getEngine().createEffect(h,{attributes:c,uniformsNames:f,uniformBuffersNames:p,samplers:d,defines:_,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:a.NUM_MORPH_INFLUENCERS}},u),a);this.buildUniformLayout()}if(!n.effect||!n.effect.isReady()){return false}a._renderId=s.getRenderId();this._wasPreviouslyReady=true;return true};r.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform("diffuseLeftColor",4);this._uniformBuffer.addUniform("diffuseRightColor",4);this._uniformBuffer.addUniform("opacityParts",4);this._uniformBuffer.addUniform("reflectionLeftColor",4);this._uniformBuffer.addUniform("reflectionRightColor",4);this._uniformBuffer.addUniform("refractionLeftColor",4);this._uniformBuffer.addUniform("refractionRightColor",4);this._uniformBuffer.addUniform("emissiveLeftColor",4);this._uniformBuffer.addUniform("emissiveRightColor",4);this._uniformBuffer.addUniform("vDiffuseInfos",2);this._uniformBuffer.addUniform("vAmbientInfos",2);this._uniformBuffer.addUniform("vOpacityInfos",2);this._uniformBuffer.addUniform("vReflectionInfos",2);this._uniformBuffer.addUniform("vReflectionPosition",3);this._uniformBuffer.addUniform("vReflectionSize",3);this._uniformBuffer.addUniform("vEmissiveInfos",2);this._uniformBuffer.addUniform("vLightmapInfos",2);this._uniformBuffer.addUniform("vSpecularInfos",2);this._uniformBuffer.addUniform("vBumpInfos",3);this._uniformBuffer.addUniform("diffuseMatrix",16);this._uniformBuffer.addUniform("ambientMatrix",16);this._uniformBuffer.addUniform("opacityMatrix",16);this._uniformBuffer.addUniform("reflectionMatrix",16);this._uniformBuffer.addUniform("emissiveMatrix",16);this._uniformBuffer.addUniform("lightmapMatrix",16);this._uniformBuffer.addUniform("specularMatrix",16);this._uniformBuffer.addUniform("bumpMatrix",16);this._uniformBuffer.addUniform("vTangentSpaceParams",2);this._uniformBuffer.addUniform("refractionMatrix",16);this._uniformBuffer.addUniform("vRefractionInfos",4);this._uniformBuffer.addUniform("vSpecularColor",4);this._uniformBuffer.addUniform("vEmissiveColor",3);this._uniformBuffer.addUniform("vDiffuseColor",4);this._uniformBuffer.addUniform("pointSize",1);this._uniformBuffer.create()};r.prototype.unbind=function(){if(this._activeEffect){if(this._reflectionTexture&&this._reflectionTexture.isRenderTarget){this._activeEffect.setTexture("reflection2DSampler",null)}if(this._refractionTexture&&this._refractionTexture.isRenderTarget){this._activeEffect.setTexture("refraction2DSampler",null)}}i.prototype.unbind.call(this)};r.prototype.bindForSubMesh=function(t,i,n){var o=this.getScene();var s=n._materialDefines;if(!s){return}var a=n.effect;if(!a){return}this._activeEffect=a;this.bindOnlyWorldMatrix(t);if(s.OBJECTSPACE_NORMALMAP){t.toNormalMatrix(this._normalMatrix);this.bindOnlyNormalMatrix(this._normalMatrix)}var u=this._mustRebind(o,a,i.visibility);e.MaterialHelper.BindBonesParameters(i,a);if(u){this._uniformBuffer.bindToEffect(a,"Material");this.bindViewProjection(a);if(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync){if(r.FresnelEnabled&&s.FRESNEL){if(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled){this._uniformBuffer.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power);this._uniformBuffer.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)}if(this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled){this._uniformBuffer.updateColor4("opacityParts",new e.Color3(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power)}if(this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled){this._uniformBuffer.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power);this._uniformBuffer.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)}if(this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled){this._uniformBuffer.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power);this._uniformBuffer.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)}if(this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled){this._uniformBuffer.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power);this._uniformBuffer.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias)}}if(o.texturesEnabled){if(this._diffuseTexture&&r.DiffuseTextureEnabled){this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level);e.MaterialHelper.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")}if(this._ambientTexture&&r.AmbientTextureEnabled){this._uniformBuffer.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level);e.MaterialHelper.BindTextureMatrix(this._ambientTexture,this._uniformBuffer,"ambient")}if(this._opacityTexture&&r.OpacityTextureEnabled){this._uniformBuffer.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level);e.MaterialHelper.BindTextureMatrix(this._opacityTexture,this._uniformBuffer,"opacity")}if(this._reflectionTexture&&r.ReflectionTextureEnabled){this._uniformBuffer.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness);this._uniformBuffer.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix());if(this._reflectionTexture.boundingBoxSize){var l=this._reflectionTexture;this._uniformBuffer.updateVector3("vReflectionPosition",l.boundingBoxPosition);this._uniformBuffer.updateVector3("vReflectionSize",l.boundingBoxSize)}}if(this._emissiveTexture&&r.EmissiveTextureEnabled){this._uniformBuffer.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level);e.MaterialHelper.BindTextureMatrix(this._emissiveTexture,this._uniformBuffer,"emissive")}if(this._lightmapTexture&&r.LightmapTextureEnabled){this._uniformBuffer.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level);e.MaterialHelper.BindTextureMatrix(this._lightmapTexture,this._uniformBuffer,"lightmap")}if(this._specularTexture&&r.SpecularTextureEnabled){this._uniformBuffer.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level);e.MaterialHelper.BindTextureMatrix(this._specularTexture,this._uniformBuffer,"specular")}if(this._bumpTexture&&o.getEngine().getCaps().standardDerivatives&&r.BumpTextureEnabled){this._uniformBuffer.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias);e.MaterialHelper.BindTextureMatrix(this._bumpTexture,this._uniformBuffer,"bump");if(o._mirroredCameraPosition){this._uniformBuffer.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1)}else{this._uniformBuffer.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)}}if(this._refractionTexture&&r.RefractionTextureEnabled){var c=1;if(!this._refractionTexture.isCube){this._uniformBuffer.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix());if(this._refractionTexture.depth){c=this._refractionTexture.depth}}this._uniformBuffer.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,c,this.invertRefractionY?-1:1)}}if(this.pointsCloud){this._uniformBuffer.updateFloat("pointSize",this.pointSize)}if(s.SPECULARTERM){this._uniformBuffer.updateColor4("vSpecularColor",this.specularColor,this.specularPower)}this._uniformBuffer.updateColor3("vEmissiveColor",this.emissiveColor);this._uniformBuffer.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha*i.visibility)}if(o.texturesEnabled){if(this._diffuseTexture&&r.DiffuseTextureEnabled){a.setTexture("diffuseSampler",this._diffuseTexture)}if(this._ambientTexture&&r.AmbientTextureEnabled){a.setTexture("ambientSampler",this._ambientTexture)}if(this._opacityTexture&&r.OpacityTextureEnabled){a.setTexture("opacitySampler",this._opacityTexture)}if(this._reflectionTexture&&r.ReflectionTextureEnabled){if(this._reflectionTexture.isCube){a.setTexture("reflectionCubeSampler",this._reflectionTexture)}else{a.setTexture("reflection2DSampler",this._reflectionTexture)}}if(this._emissiveTexture&&r.EmissiveTextureEnabled){a.setTexture("emissiveSampler",this._emissiveTexture)}if(this._lightmapTexture&&r.LightmapTextureEnabled){a.setTexture("lightmapSampler",this._lightmapTexture)}if(this._specularTexture&&r.SpecularTextureEnabled){a.setTexture("specularSampler",this._specularTexture)}if(this._bumpTexture&&o.getEngine().getCaps().standardDerivatives&&r.BumpTextureEnabled){a.setTexture("bumpSampler",this._bumpTexture)}if(this._refractionTexture&&r.RefractionTextureEnabled){var c=1;if(this._refractionTexture.isCube){a.setTexture("refractionCubeSampler",this._refractionTexture)}else{a.setTexture("refraction2DSampler",this._refractionTexture)}}}e.MaterialHelper.BindClipPlane(a,o);o.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor);e.MaterialHelper.BindEyePosition(a,o);a.setColor3("vAmbientColor",this._globalAmbientColor)}if(u||!this.isFrozen){if(o.lightsEnabled&&!this._disableLighting){e.MaterialHelper.BindLights(o,i,a,s,this._maxSimultaneousLights)}if(o.fogEnabled&&i.applyFog&&o.fogMode!==e.Scene.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture){this.bindView(a)}e.MaterialHelper.BindFogParameters(o,i,a);if(s.NUM_MORPH_INFLUENCERS){e.MaterialHelper.BindMorphTargetParameters(i,a)}e.MaterialHelper.BindLogDepth(s,a,o);if(!this._imageProcessingConfiguration.applyByPostProcess){this._imageProcessingConfiguration.bind(this._activeEffect)}}this._uniformBuffer.update();this._afterBind(i,this._activeEffect)};r.prototype.getAnimatables=function(){var e=[];if(this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0){e.push(this._diffuseTexture)}if(this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0){e.push(this._ambientTexture)}if(this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0){e.push(this._opacityTexture)}if(this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0){e.push(this._reflectionTexture)}if(this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0){e.push(this._emissiveTexture)}if(this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0){e.push(this._specularTexture)}if(this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0){e.push(this._bumpTexture)}if(this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0){e.push(this._lightmapTexture)}if(this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0){e.push(this._refractionTexture)}return e};r.prototype.getActiveTextures=function(){var e=i.prototype.getActiveTextures.call(this);if(this._diffuseTexture){e.push(this._diffuseTexture)}if(this._ambientTexture){e.push(this._ambientTexture)}if(this._opacityTexture){e.push(this._opacityTexture)}if(this._reflectionTexture){e.push(this._reflectionTexture)}if(this._emissiveTexture){e.push(this._emissiveTexture)}if(this._specularTexture){e.push(this._specularTexture)}if(this._bumpTexture){e.push(this._bumpTexture)}if(this._lightmapTexture){e.push(this._lightmapTexture)}if(this._refractionTexture){e.push(this._refractionTexture)}return e};r.prototype.hasTexture=function(e){if(i.prototype.hasTexture.call(this,e)){return true}if(this._diffuseTexture===e){return true}if(this._ambientTexture===e){return true}if(this._opacityTexture===e){return true}if(this._reflectionTexture===e){return true}if(this._emissiveTexture===e){return true}if(this._specularTexture===e){return true}if(this._bumpTexture===e){return true}if(this._lightmapTexture===e){return true}if(this._refractionTexture===e){return true}return false};r.prototype.dispose=function(e,t){if(t){if(this._diffuseTexture){this._diffuseTexture.dispose()}if(this._ambientTexture){this._ambientTexture.dispose()}if(this._opacityTexture){this._opacityTexture.dispose()}if(this._reflectionTexture){this._reflectionTexture.dispose()}if(this._emissiveTexture){this._emissiveTexture.dispose()}if(this._specularTexture){this._specularTexture.dispose()}if(this._bumpTexture){this._bumpTexture.dispose()}if(this._lightmapTexture){this._lightmapTexture.dispose()}if(this._refractionTexture){this._refractionTexture.dispose()}}if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}i.prototype.dispose.call(this,e,t)};r.prototype.clone=function(t){var i=this;var n=e.SerializationHelper.Clone(function(){return new r(t,i.getScene())},this);n.name=t;n.id=t;return n};r.prototype.serialize=function(){return e.SerializationHelper.Serialize(this)};r.Parse=function(t,i,n){return e.SerializationHelper.Parse(function(){return new r(t.name,i)},t,i,n)};Object.defineProperty(r,"DiffuseTextureEnabled",{get:function(){return r._DiffuseTextureEnabled},set:function(t){if(r._DiffuseTextureEnabled===t){return}r._DiffuseTextureEnabled=t;e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(r,"AmbientTextureEnabled",{get:function(){return r._AmbientTextureEnabled},set:function(t){if(r._AmbientTextureEnabled===t){return}r._AmbientTextureEnabled=t;e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(r,"OpacityTextureEnabled",{get:function(){return r._OpacityTextureEnabled},set:function(t){if(r._OpacityTextureEnabled===t){return}r._OpacityTextureEnabled=t;e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(r,"ReflectionTextureEnabled",{get:function(){return r._ReflectionTextureEnabled},set:function(t){if(r._ReflectionTextureEnabled===t){return}r._ReflectionTextureEnabled=t;e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(r,"EmissiveTextureEnabled",{get:function(){return r._EmissiveTextureEnabled},set:function(t){if(r._EmissiveTextureEnabled===t){return}r._EmissiveTextureEnabled=t;e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(r,"SpecularTextureEnabled",{get:function(){return r._SpecularTextureEnabled},set:function(t){if(r._SpecularTextureEnabled===t){return}r._SpecularTextureEnabled=t;e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(r,"BumpTextureEnabled",{get:function(){return r._BumpTextureEnabled},set:function(t){if(r._BumpTextureEnabled===t){return}r._BumpTextureEnabled=t;e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(r,"LightmapTextureEnabled",{get:function(){return r._LightmapTextureEnabled},set:function(t){if(r._LightmapTextureEnabled===t){return}r._LightmapTextureEnabled=t;e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(r,"RefractionTextureEnabled",{get:function(){return r._RefractionTextureEnabled},set:function(t){if(r._RefractionTextureEnabled===t){return}r._RefractionTextureEnabled=t;e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(r,"ColorGradingTextureEnabled",{get:function(){return r._ColorGradingTextureEnabled},set:function(t){if(r._ColorGradingTextureEnabled===t){return}r._ColorGradingTextureEnabled=t;e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},enumerable:true,configurable:true});Object.defineProperty(r,"FresnelEnabled",{get:function(){return r._FresnelEnabled},set:function(t){if(r._FresnelEnabled===t){return}r._FresnelEnabled=t;e.Engine.MarkAllMaterialsAsDirty(e.Material.FresnelDirtyFlag)},enumerable:true,configurable:true});r._DiffuseTextureEnabled=true;r._AmbientTextureEnabled=true;r._OpacityTextureEnabled=true;r._ReflectionTextureEnabled=true;r._EmissiveTextureEnabled=true;r._SpecularTextureEnabled=true;r._BumpTextureEnabled=true;r._LightmapTextureEnabled=true;r._RefractionTextureEnabled=true;r._ColorGradingTextureEnabled=true;r._FresnelEnabled=true;__decorate([e.serializeAsTexture("diffuseTexture")],r.prototype,"_diffuseTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesAndMiscDirty")],r.prototype,"diffuseTexture",void 0);__decorate([e.serializeAsTexture("ambientTexture")],r.prototype,"_ambientTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"ambientTexture",void 0);__decorate([e.serializeAsTexture("opacityTexture")],r.prototype,"_opacityTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesAndMiscDirty")],r.prototype,"opacityTexture",void 0);__decorate([e.serializeAsTexture("reflectionTexture")],r.prototype,"_reflectionTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionTexture",void 0);__decorate([e.serializeAsTexture("emissiveTexture")],r.prototype,"_emissiveTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"emissiveTexture",void 0);__decorate([e.serializeAsTexture("specularTexture")],r.prototype,"_specularTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"specularTexture",void 0);__decorate([e.serializeAsTexture("bumpTexture")],r.prototype,"_bumpTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"bumpTexture",void 0);__decorate([e.serializeAsTexture("lightmapTexture")],r.prototype,"_lightmapTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"lightmapTexture",void 0);__decorate([e.serializeAsTexture("refractionTexture")],r.prototype,"_refractionTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"refractionTexture",void 0);__decorate([e.serializeAsColor3("ambient")],r.prototype,"ambientColor",void 0);__decorate([e.serializeAsColor3("diffuse")],r.prototype,"diffuseColor",void 0);__decorate([e.serializeAsColor3("specular")],r.prototype,"specularColor",void 0)
;__decorate([e.serializeAsColor3("emissive")],r.prototype,"emissiveColor",void 0);__decorate([e.serialize()],r.prototype,"specularPower",void 0);__decorate([e.serialize("useAlphaFromDiffuseTexture")],r.prototype,"_useAlphaFromDiffuseTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useAlphaFromDiffuseTexture",void 0);__decorate([e.serialize("useEmissiveAsIllumination")],r.prototype,"_useEmissiveAsIllumination",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useEmissiveAsIllumination",void 0);__decorate([e.serialize("linkEmissiveWithDiffuse")],r.prototype,"_linkEmissiveWithDiffuse",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"linkEmissiveWithDiffuse",void 0);__decorate([e.serialize("useSpecularOverAlpha")],r.prototype,"_useSpecularOverAlpha",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useSpecularOverAlpha",void 0);__decorate([e.serialize("useReflectionOverAlpha")],r.prototype,"_useReflectionOverAlpha",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useReflectionOverAlpha",void 0);__decorate([e.serialize("disableLighting")],r.prototype,"_disableLighting",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsLightsDirty")],r.prototype,"disableLighting",void 0);__decorate([e.serialize("useObjectSpaceNormalMap")],r.prototype,"_useObjectSpaceNormalMap",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useObjectSpaceNormalMap",void 0);__decorate([e.serialize("useParallax")],r.prototype,"_useParallax",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useParallax",void 0);__decorate([e.serialize("useParallaxOcclusion")],r.prototype,"_useParallaxOcclusion",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useParallaxOcclusion",void 0);__decorate([e.serialize()],r.prototype,"parallaxScaleBias",void 0);__decorate([e.serialize("roughness")],r.prototype,"_roughness",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"roughness",void 0);__decorate([e.serialize()],r.prototype,"indexOfRefraction",void 0);__decorate([e.serialize()],r.prototype,"invertRefractionY",void 0);__decorate([e.serialize("useLightmapAsShadowmap")],r.prototype,"_useLightmapAsShadowmap",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useLightmapAsShadowmap",void 0);__decorate([e.serializeAsFresnelParameters("diffuseFresnelParameters")],r.prototype,"_diffuseFresnelParameters",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsFresnelDirty")],r.prototype,"diffuseFresnelParameters",void 0);__decorate([e.serializeAsFresnelParameters("opacityFresnelParameters")],r.prototype,"_opacityFresnelParameters",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsFresnelAndMiscDirty")],r.prototype,"opacityFresnelParameters",void 0);__decorate([e.serializeAsFresnelParameters("reflectionFresnelParameters")],r.prototype,"_reflectionFresnelParameters",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsFresnelDirty")],r.prototype,"reflectionFresnelParameters",void 0);__decorate([e.serializeAsFresnelParameters("refractionFresnelParameters")],r.prototype,"_refractionFresnelParameters",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsFresnelDirty")],r.prototype,"refractionFresnelParameters",void 0);__decorate([e.serializeAsFresnelParameters("emissiveFresnelParameters")],r.prototype,"_emissiveFresnelParameters",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsFresnelDirty")],r.prototype,"emissiveFresnelParameters",void 0);__decorate([e.serialize("useReflectionFresnelFromSpecular")],r.prototype,"_useReflectionFresnelFromSpecular",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsFresnelDirty")],r.prototype,"useReflectionFresnelFromSpecular",void 0);__decorate([e.serialize("useGlossinessFromSpecularMapAlpha")],r.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useGlossinessFromSpecularMapAlpha",void 0);__decorate([e.serialize("maxSimultaneousLights")],r.prototype,"_maxSimultaneousLights",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsLightsDirty")],r.prototype,"maxSimultaneousLights",void 0);__decorate([e.serialize("invertNormalMapX")],r.prototype,"_invertNormalMapX",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"invertNormalMapX",void 0);__decorate([e.serialize("invertNormalMapY")],r.prototype,"_invertNormalMapY",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"invertNormalMapY",void 0);__decorate([e.serialize("twoSidedLighting")],r.prototype,"_twoSidedLighting",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"twoSidedLighting",void 0);__decorate([e.serialize()],r.prototype,"useLogarithmicDepth",null);return r}(e.PushMaterial);e.StandardMaterial=i})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(){var t=e.call(this)||this;t.PBR=true;t.MAINUV1=false;t.MAINUV2=false;t.UV1=false;t.UV2=false;t.ALBEDO=false;t.ALBEDODIRECTUV=0;t.VERTEXCOLOR=false;t.AMBIENT=false;t.AMBIENTDIRECTUV=0;t.AMBIENTINGRAYSCALE=false;t.OPACITY=false;t.VERTEXALPHA=false;t.OPACITYDIRECTUV=0;t.OPACITYRGB=false;t.ALPHATEST=false;t.DEPTHPREPASS=false;t.ALPHABLEND=false;t.ALPHAFROMALBEDO=false;t.ALPHATESTVALUE="0.5";t.SPECULAROVERALPHA=false;t.RADIANCEOVERALPHA=false;t.ALPHAFRESNEL=false;t.LINEARALPHAFRESNEL=false;t.PREMULTIPLYALPHA=false;t.EMISSIVE=false;t.EMISSIVEDIRECTUV=0;t.REFLECTIVITY=false;t.REFLECTIVITYDIRECTUV=0;t.SPECULARTERM=false;t.MICROSURFACEFROMREFLECTIVITYMAP=false;t.MICROSURFACEAUTOMATIC=false;t.LODBASEDMICROSFURACE=false;t.MICROSURFACEMAP=false;t.MICROSURFACEMAPDIRECTUV=0;t.METALLICWORKFLOW=false;t.ROUGHNESSSTOREINMETALMAPALPHA=false;t.ROUGHNESSSTOREINMETALMAPGREEN=false;t.METALLNESSSTOREINMETALMAPBLUE=false;t.AOSTOREINMETALMAPRED=false;t.ENVIRONMENTBRDF=false;t.NORMAL=false;t.TANGENT=false;t.BUMP=false;t.BUMPDIRECTUV=0;t.OBJECTSPACE_NORMALMAP=false;t.PARALLAX=false;t.PARALLAXOCCLUSION=false;t.NORMALXYSCALE=true;t.LIGHTMAP=false;t.LIGHTMAPDIRECTUV=0;t.USELIGHTMAPASSHADOWMAP=false;t.GAMMALIGHTMAP=false;t.REFLECTION=false;t.REFLECTIONMAP_3D=false;t.REFLECTIONMAP_SPHERICAL=false;t.REFLECTIONMAP_PLANAR=false;t.REFLECTIONMAP_CUBIC=false;t.USE_LOCAL_REFLECTIONMAP_CUBIC=false;t.REFLECTIONMAP_PROJECTION=false;t.REFLECTIONMAP_SKYBOX=false;t.REFLECTIONMAP_EXPLICIT=false;t.REFLECTIONMAP_EQUIRECTANGULAR=false;t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false;t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false;t.INVERTCUBICMAP=false;t.USESPHERICALFROMREFLECTIONMAP=false;t.USESPHERICALINVERTEX=false;t.REFLECTIONMAP_OPPOSITEZ=false;t.LODINREFLECTIONALPHA=false;t.GAMMAREFLECTION=false;t.RADIANCEOCCLUSION=false;t.HORIZONOCCLUSION=false;t.REFRACTION=false;t.REFRACTIONMAP_3D=false;t.REFRACTIONMAP_OPPOSITEZ=false;t.LODINREFRACTIONALPHA=false;t.GAMMAREFRACTION=false;t.LINKREFRACTIONTOTRANSPARENCY=false;t.INSTANCES=false;t.NUM_BONE_INFLUENCERS=0;t.BonesPerMesh=0;t.NONUNIFORMSCALING=false;t.MORPHTARGETS=false;t.MORPHTARGETS_NORMAL=false;t.MORPHTARGETS_TANGENT=false;t.NUM_MORPH_INFLUENCERS=0;t.IMAGEPROCESSING=false;t.VIGNETTE=false;t.VIGNETTEBLENDMODEMULTIPLY=false;t.VIGNETTEBLENDMODEOPAQUE=false;t.TONEMAPPING=false;t.CONTRAST=false;t.COLORCURVES=false;t.COLORGRADING=false;t.COLORGRADING3D=false;t.SAMPLER3DGREENDEPTH=false;t.SAMPLER3DBGRMAP=false;t.IMAGEPROCESSINGPOSTPROCESS=false;t.EXPOSURE=false;t.USEPHYSICALLIGHTFALLOFF=false;t.TWOSIDEDLIGHTING=false;t.SHADOWFLOAT=false;t.CLIPPLANE=false;t.POINTSIZE=false;t.FOG=false;t.LOGARITHMICDEPTH=false;t.FORCENORMALFORWARD=false;t.GEOMETRYAA=false;t.UNLIT=false;t.rebuild();return t}t.prototype.reset=function(){e.prototype.reset.call(this);this.ALPHATESTVALUE="0.5";this.PBR=true};return t}(e.MaterialDefines);var i=function(i){__extends(r,i);function r(t,r){var n=i.call(this,t,r)||this;n._directIntensity=1;n._emissiveIntensity=1;n._environmentIntensity=1;n._specularIntensity=1;n._lightingInfos=new e.Vector4(n._directIntensity,n._emissiveIntensity,n._environmentIntensity,n._specularIntensity);n._disableBumpMap=false;n._ambientTextureStrength=1;n._ambientColor=new e.Color3(0,0,0);n._albedoColor=new e.Color3(1,1,1);n._reflectivityColor=new e.Color3(1,1,1);n._reflectionColor=new e.Color3(1,1,1);n._emissiveColor=new e.Color3(0,0,0);n._microSurface=.9;n._indexOfRefraction=.66;n._invertRefractionY=false;n._linkRefractionWithTransparency=false;n._useLightmapAsShadowmap=false;n._useHorizonOcclusion=true;n._useRadianceOcclusion=true;n._useAlphaFromAlbedoTexture=false;n._useSpecularOverAlpha=true;n._useMicroSurfaceFromReflectivityMapAlpha=false;n._useRoughnessFromMetallicTextureAlpha=true;n._useRoughnessFromMetallicTextureGreen=false;n._useMetallnessFromMetallicTextureBlue=false;n._useAmbientOcclusionFromMetallicTextureRed=false;n._useAmbientInGrayScale=false;n._useAutoMicroSurfaceFromReflectivityMap=false;n._usePhysicalLightFalloff=true;n._useRadianceOverAlpha=true;n._useObjectSpaceNormalMap=false;n._useParallax=false;n._useParallaxOcclusion=false;n._parallaxScaleBias=.05;n._disableLighting=false;n._maxSimultaneousLights=4;n._invertNormalMapX=false;n._invertNormalMapY=false;n._twoSidedLighting=false;n._alphaCutOff=.4;n._forceAlphaTest=false;n._useAlphaFresnel=false;n._useLinearAlphaFresnel=false;n._transparencyMode=null;n._environmentBRDFTexture=null;n._forceIrradianceInFragment=false;n._forceNormalForward=false;n._enableSpecularAntiAliasing=false;n._renderTargets=new e.SmartArray(16);n._globalAmbientColor=new e.Color3(0,0,0);n._unlit=false;n._attachImageProcessingConfiguration(null);n.getRenderTargetTextures=function(){n._renderTargets.reset();if(e.StandardMaterial.ReflectionTextureEnabled&&n._reflectionTexture&&n._reflectionTexture.isRenderTarget){n._renderTargets.push(n._reflectionTexture)}if(e.StandardMaterial.RefractionTextureEnabled&&n._refractionTexture&&n._refractionTexture.isRenderTarget){n._renderTargets.push(n._refractionTexture)}return n._renderTargets};n._environmentBRDFTexture=e.TextureTools.GetEnvironmentBRDFTexture(r);return n}r.prototype._attachImageProcessingConfiguration=function(e){var t=this;if(e===this._imageProcessingConfiguration){return}if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}if(!e){this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration}else{this._imageProcessingConfiguration=e}this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(e){t._markAllSubMeshesAsImageProcessingDirty()})};r.prototype.getClassName=function(){return"PBRBaseMaterial"};Object.defineProperty(r.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"transparencyMode",{get:function(){return this._transparencyMode},set:function(t){if(this._transparencyMode===t){return}this._transparencyMode=t;this._forceAlphaTest=t===e.PBRMaterial.PBRMATERIAL_ALPHATESTANDBLEND;this._markAllSubMeshesAsTexturesAndMiscDirty()},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"_disableAlphaBlending",{get:function(){return this._linkRefractionWithTransparency||this._transparencyMode===e.PBRMaterial.PBRMATERIAL_OPAQUE||this._transparencyMode===e.PBRMaterial.PBRMATERIAL_ALPHATEST},enumerable:true,configurable:true});r.prototype.needAlphaBlending=function(){if(this._disableAlphaBlending){return false}return this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()};r.prototype.needAlphaBlendingForMesh=function(e){if(this._disableAlphaBlending){return false}return i.prototype.needAlphaBlendingForMesh.call(this,e)};r.prototype.needAlphaTesting=function(){if(this._forceAlphaTest){return true}if(this._linkRefractionWithTransparency){return false}return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&(this._transparencyMode==null||this._transparencyMode===e.PBRMaterial.PBRMATERIAL_ALPHATEST)};r.prototype._shouldUseAlphaFromAlbedoTexture=function(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==e.PBRMaterial.PBRMATERIAL_OPAQUE};r.prototype.getAlphaTestTexture=function(){return this._albedoTexture};r.prototype.isReadyForSubMesh=function(i,r,n){if(r.effect&&this.isFrozen){if(this._wasPreviouslyReady){return true}}if(!r._materialDefines){r._materialDefines=new t}var o=r._materialDefines;if(!this.checkReadyOnEveryCall&&r.effect){if(o._renderId===this.getScene().getRenderId()){return true}}var s=this.getScene();var a=s.getEngine();if(o._areTexturesDirty){if(s.texturesEnabled){if(this._albedoTexture&&e.StandardMaterial.DiffuseTextureEnabled){if(!this._albedoTexture.isReadyOrNotBlocking()){return false}}if(this._ambientTexture&&e.StandardMaterial.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking()){return false}}if(this._opacityTexture&&e.StandardMaterial.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking()){return false}}var u=this._getReflectionTexture();if(u&&e.StandardMaterial.ReflectionTextureEnabled){if(!u.isReadyOrNotBlocking()){return false}}if(this._lightmapTexture&&e.StandardMaterial.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking()){return false}}if(this._emissiveTexture&&e.StandardMaterial.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking()){return false}}if(e.StandardMaterial.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking()){return false}}else if(this._reflectivityTexture){if(!this._reflectivityTexture.isReadyOrNotBlocking()){return false}}if(this._microSurfaceTexture){if(!this._microSurfaceTexture.isReadyOrNotBlocking()){return false}}}if(a.getCaps().standardDerivatives&&this._bumpTexture&&e.StandardMaterial.BumpTextureEnabled&&!this._disableBumpMap){if(!this._bumpTexture.isReady()){return false}}var l=this._getRefractionTexture();if(l&&e.StandardMaterial.RefractionTextureEnabled){if(!l.isReadyOrNotBlocking()){return false}}if(this._environmentBRDFTexture&&e.StandardMaterial.ReflectionTextureEnabled){if(!this._environmentBRDFTexture.isReady()){return false}}}}if(o._areImageProcessingDirty){if(!this._imageProcessingConfiguration.isReady()){return false}}if(!a.getCaps().standardDerivatives&&!i.isVerticesDataPresent(e.VertexBuffer.NormalKind)){i.createNormals(true);e.Tools.Warn("PBRMaterial: Normals have been created for the mesh: "+i.name)}var c=this._prepareEffect(i,o,this.onCompiled,this.onError,n);if(c){s.resetCachedMaterial();r.setEffect(c,o);this.buildUniformLayout()}if(!r.effect||!r.effect.isReady()){return false}o._renderId=s.getRenderId();this._wasPreviouslyReady=true;return true};r.prototype.isMetallicWorkflow=function(){if(this._metallic!=null||this._roughness!=null||this._metallicTexture){return true}return false};r.prototype._prepareEffect=function(t,i,r,n,o,s){if(r===void 0){r=null}if(n===void 0){n=null}if(o===void 0){o=null}if(s===void 0){s=null}this._prepareDefines(t,i,o,s);if(!i.isDirty){return null}i.markAsProcessed();var a=this.getScene();var u=a.getEngine();var l=new e.EffectFallbacks;var c=0;if(i.USESPHERICALINVERTEX){l.addFallback(c++,"USESPHERICALINVERTEX")}if(i.FOG){l.addFallback(c,"FOG")}if(i.POINTSIZE){l.addFallback(c,"POINTSIZE")}if(i.LOGARITHMICDEPTH){l.addFallback(c,"LOGARITHMICDEPTH")}if(i.PARALLAX){l.addFallback(c,"PARALLAX")}if(i.PARALLAXOCCLUSION){l.addFallback(c++,"PARALLAXOCCLUSION")}if(i.ENVIRONMENTBRDF){l.addFallback(c++,"ENVIRONMENTBRDF")}if(i.TANGENT){l.addFallback(c++,"TANGENT")}if(i.BUMP){l.addFallback(c++,"BUMP")}c=e.MaterialHelper.HandleFallbacksForShadows(i,l,this._maxSimultaneousLights,c++);if(i.SPECULARTERM){l.addFallback(c++,"SPECULARTERM")}if(i.USESPHERICALFROMREFLECTIONMAP){l.addFallback(c++,"USESPHERICALFROMREFLECTIONMAP")}if(i.LIGHTMAP){l.addFallback(c++,"LIGHTMAP")}if(i.NORMAL){l.addFallback(c++,"NORMAL")}if(i.AMBIENT){l.addFallback(c++,"AMBIENT")}if(i.EMISSIVE){l.addFallback(c++,"EMISSIVE")}if(i.VERTEXCOLOR){l.addFallback(c++,"VERTEXCOLOR")}if(i.NUM_BONE_INFLUENCERS>0){l.addCPUSkinningFallback(c++,t)}if(i.MORPHTARGETS){l.addFallback(c++,"MORPHTARGETS")}var h=[e.VertexBuffer.PositionKind];if(i.NORMAL){h.push(e.VertexBuffer.NormalKind)}if(i.TANGENT){h.push(e.VertexBuffer.TangentKind)}if(i.UV1){h.push(e.VertexBuffer.UVKind)}if(i.UV2){h.push(e.VertexBuffer.UV2Kind)}if(i.VERTEXCOLOR){h.push(e.VertexBuffer.ColorKind)}e.MaterialHelper.PrepareAttributesForBones(h,t,i,l);e.MaterialHelper.PrepareAttributesForInstances(h,i);e.MaterialHelper.PrepareAttributesForMorphTargets(h,t,i);var f=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vEmissiveColor","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","refractionMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX","vSphericalYY","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vReflectionMicrosurfaceInfos","vRefractionMicrosurfaceInfos","vTangentSpaceParams"];var d=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","microSurfaceSampler","environmentBrdfSampler"];var p=["Material","Scene"];e.ImageProcessingConfiguration.PrepareUniforms(f,i);e.ImageProcessingConfiguration.PrepareSamplers(d,i);e.MaterialHelper.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:p,samplers:d,defines:i,maxSimultaneousLights:this._maxSimultaneousLights});var _=i.toString();return u.createEffect("pbr",{attributes:h,uniformsNames:f,uniformBuffersNames:p,samplers:d,defines:_,fallbacks:l,onCompiled:r,onError:n,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:i.NUM_MORPH_INFLUENCERS}},u)};r.prototype._prepareDefines=function(t,i,r,n){if(r===void 0){r=null}if(n===void 0){n=null}var o=this.getScene();var s=o.getEngine();e.MaterialHelper.PrepareDefinesForLights(o,t,i,true,this._maxSimultaneousLights,this._disableLighting);i._needNormals=true;i.METALLICWORKFLOW=this.isMetallicWorkflow();if(i._areTexturesDirty){i._needUVs=false;if(o.texturesEnabled){if(o.getEngine().getCaps().textureLOD){i.LODBASEDMICROSFURACE=true}if(this._albedoTexture&&e.StandardMaterial.DiffuseTextureEnabled){e.MaterialHelper.PrepareDefinesForMergedUV(this._albedoTexture,i,"ALBEDO")}else{i.ALBEDO=false}if(this._ambientTexture&&e.StandardMaterial.AmbientTextureEnabled){e.MaterialHelper.PrepareDefinesForMergedUV(this._ambientTexture,i,"AMBIENT");i.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale}else{i.AMBIENT=false}if(this._opacityTexture&&e.StandardMaterial.OpacityTextureEnabled){e.MaterialHelper.PrepareDefinesForMergedUV(this._opacityTexture,i,"OPACITY");i.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}else{i.OPACITY=false}var a=this._getReflectionTexture();if(a&&e.StandardMaterial.ReflectionTextureEnabled){i.REFLECTION=true;i.GAMMAREFLECTION=a.gammaSpace;i.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!a.invertZ:a.invertZ;i.LODINREFLECTIONALPHA=a.lodLevelInAlpha;if(a.coordinatesMode===e.Texture.INVCUBIC_MODE){i.INVERTCUBICMAP=true}i.REFLECTIONMAP_3D=a.isCube;switch(a.coordinatesMode){case e.Texture.CUBIC_MODE:case e.Texture.INVCUBIC_MODE:i.REFLECTIONMAP_CUBIC=true;i.USE_LOCAL_REFLECTIONMAP_CUBIC=a.boundingBoxSize?true:false;break;case e.Texture.EXPLICIT_MODE:i.REFLECTIONMAP_EXPLICIT=true;break;case e.Texture.PLANAR_MODE:i.REFLECTIONMAP_PLANAR=true;break;case e.Texture.PROJECTION_MODE:i.REFLECTIONMAP_PROJECTION=true;break;case e.Texture.SKYBOX_MODE:i.REFLECTIONMAP_SKYBOX=true;break;case e.Texture.SPHERICAL_MODE:i.REFLECTIONMAP_SPHERICAL=true;break;case e.Texture.EQUIRECTANGULAR_MODE:i.REFLECTIONMAP_EQUIRECTANGULAR=true;break;case e.Texture.FIXED_EQUIRECTANGULAR_MODE:i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=true;break;case e.Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=true;break}if(a.coordinatesMode!==e.Texture.SKYBOX_MODE){if(a.sphericalPolynomial){i.USESPHERICALFROMREFLECTIONMAP=true;if(this._forceIrradianceInFragment||o.getEngine().getCaps().maxVaryingVectors<=8){i.USESPHERICALINVERTEX=false}else{i.USESPHERICALINVERTEX=true}}}}else{i.REFLECTION=false;i.REFLECTIONMAP_3D=false;i.REFLECTIONMAP_SPHERICAL=false;i.REFLECTIONMAP_PLANAR=false;i.REFLECTIONMAP_CUBIC=false;i.USE_LOCAL_REFLECTIONMAP_CUBIC=false;i.REFLECTIONMAP_PROJECTION=false;i.REFLECTIONMAP_SKYBOX=false;i.REFLECTIONMAP_EXPLICIT=false;i.REFLECTIONMAP_EQUIRECTANGULAR=false;i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false;i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false;i.INVERTCUBICMAP=false;i.USESPHERICALFROMREFLECTIONMAP=false;i.USESPHERICALINVERTEX=false;i.REFLECTIONMAP_OPPOSITEZ=false;i.LODINREFLECTIONALPHA=false;i.GAMMAREFLECTION=false}if(this._lightmapTexture&&e.StandardMaterial.LightmapTextureEnabled){e.MaterialHelper.PrepareDefinesForMergedUV(this._lightmapTexture,i,"LIGHTMAP");i.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap;i.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace}else{i.LIGHTMAP=false}if(this._emissiveTexture&&e.StandardMaterial.EmissiveTextureEnabled){e.MaterialHelper.PrepareDefinesForMergedUV(this._emissiveTexture,i,"EMISSIVE")}else{i.EMISSIVE=false}if(e.StandardMaterial.SpecularTextureEnabled){if(this._metallicTexture){e.MaterialHelper.PrepareDefinesForMergedUV(this._metallicTexture,i,"REFLECTIVITY");i.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha;i.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen;i.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue;i.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed}else if(this._reflectivityTexture){e.MaterialHelper.PrepareDefinesForMergedUV(this._reflectivityTexture,i,"REFLECTIVITY");i.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha;i.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap}else{i.REFLECTIVITY=false}if(this._microSurfaceTexture){e.MaterialHelper.PrepareDefinesForMergedUV(this._microSurfaceTexture,i,"MICROSURFACEMAP")}else{i.MICROSURFACEMAP=false}}else{i.REFLECTIVITY=false;i.MICROSURFACEMAP=false}if(o.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&e.StandardMaterial.BumpTextureEnabled&&!this._disableBumpMap){e.MaterialHelper.PrepareDefinesForMergedUV(this._bumpTexture,i,"BUMP");if(this._useParallax&&this._albedoTexture&&e.StandardMaterial.DiffuseTextureEnabled){i.PARALLAX=true;i.PARALLAXOCCLUSION=!!this._useParallaxOcclusion}else{i.PARALLAX=false}i.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else{i.BUMP=false}var u=this._getRefractionTexture();if(u&&e.StandardMaterial.RefractionTextureEnabled){i.REFRACTION=true;i.REFRACTIONMAP_3D=u.isCube;i.GAMMAREFRACTION=u.gammaSpace;i.REFRACTIONMAP_OPPOSITEZ=u.invertZ;i.LODINREFRACTIONALPHA=u.lodLevelInAlpha;if(this._linkRefractionWithTransparency){i.LINKREFRACTIONTOTRANSPARENCY=true}}else{i.REFRACTION=false}if(this._environmentBRDFTexture&&e.StandardMaterial.ReflectionTextureEnabled){i.ENVIRONMENTBRDF=true}else{i.ENVIRONMENTBRDF=false}if(this._shouldUseAlphaFromAlbedoTexture()){i.ALPHAFROMALBEDO=true}else{i.ALPHAFROMALBEDO=false}}i.SPECULAROVERALPHA=this._useSpecularOverAlpha;i.USEPHYSICALLIGHTFALLOFF=this._usePhysicalLightFalloff;i.RADIANCEOVERALPHA=this._useRadianceOverAlpha;if(!this.backFaceCulling&&this._twoSidedLighting){i.TWOSIDEDLIGHTING=true}else{i.TWOSIDEDLIGHTING=false}i.ALPHATESTVALUE=""+this._alphaCutOff+(this._alphaCutOff%1===0?".":"");i.PREMULTIPLYALPHA=this.alphaMode===e.Engine.ALPHA_PREMULTIPLIED||this.alphaMode===e.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;i.ALPHABLEND=this.needAlphaBlendingForMesh(t);i.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel;i.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel;i.GEOMETRYAA=o.getEngine().getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}if(i._areImageProcessingDirty){this._imageProcessingConfiguration.prepareDefines(i)}i.FORCENORMALFORWARD=this._forceNormalForward;i.RADIANCEOCCLUSION=this._useRadianceOcclusion;i.HORIZONOCCLUSION=this._useHorizonOcclusion;if(i._areMiscDirty){e.MaterialHelper.PrepareDefinesForMisc(t,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(t)||this._forceAlphaTest,i);i.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!t.isVerticesDataPresent(e.VertexBuffer.NormalKind)}e.MaterialHelper.PrepareDefinesForFrameBoundValues(o,s,i,r?true:false,n);e.MaterialHelper.PrepareDefinesForAttributes(t,i,true,true,true,this._transparencyMode!==e.PBRMaterial.PBRMATERIAL_OPAQUE)};r.prototype.forceCompilation=function(e,i,r){var o=this;var s=n({clipPlane:false},r);var a=new t;var u=this._prepareEffect(e,a,undefined,undefined,undefined,s.clipPlane);if(u.isReady()){if(i){i(this)}}else{u.onCompileObservable.add(function(){if(i){i(o)}})}};r.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform("vAlbedoInfos",2);this._uniformBuffer.addUniform("vAmbientInfos",3);this._uniformBuffer.addUniform("vOpacityInfos",2);this._uniformBuffer.addUniform("vEmissiveInfos",2);this._uniformBuffer.addUniform("vLightmapInfos",2);this._uniformBuffer.addUniform("vReflectivityInfos",3);this._uniformBuffer.addUniform("vMicroSurfaceSamplerInfos",2);this._uniformBuffer.addUniform("vRefractionInfos",4);this._uniformBuffer.addUniform("vReflectionInfos",2);this._uniformBuffer.addUniform("vReflectionPosition",3);this._uniformBuffer.addUniform("vReflectionSize",3);this._uniformBuffer.addUniform("vBumpInfos",3);this._uniformBuffer.addUniform("albedoMatrix",16);this._uniformBuffer.addUniform("ambientMatrix",16);this._uniformBuffer.addUniform("opacityMatrix",16);this._uniformBuffer.addUniform("emissiveMatrix",16);this._uniformBuffer.addUniform("lightmapMatrix",16);this._uniformBuffer.addUniform("reflectivityMatrix",16);this._uniformBuffer.addUniform("microSurfaceSamplerMatrix",16);this._uniformBuffer.addUniform("bumpMatrix",16);this._uniformBuffer.addUniform("vTangentSpaceParams",2);this._uniformBuffer.addUniform("refractionMatrix",16);this._uniformBuffer.addUniform("reflectionMatrix",16);this._uniformBuffer.addUniform("vReflectionColor",3);this._uniformBuffer.addUniform("vAlbedoColor",4);this._uniformBuffer.addUniform("vLightingIntensity",4);this._uniformBuffer.addUniform("vRefractionMicrosurfaceInfos",3);this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3);this._uniformBuffer.addUniform("vReflectivityColor",4);this._uniformBuffer.addUniform("vEmissiveColor",3);this._uniformBuffer.addUniform("pointSize",1);this._uniformBuffer.create()};r.prototype.unbind=function(){if(this._reflectionTexture&&this._reflectionTexture.isRenderTarget){this._uniformBuffer.setTexture("reflectionSampler",null)}if(this._refractionTexture&&this._refractionTexture.isRenderTarget){this._uniformBuffer.setTexture("refractionSampler",null)}i.prototype.unbind.call(this)};r.prototype.bindForSubMesh=function(t,i,r){var n=this.getScene();var o=r._materialDefines;if(!o){return}var s=r.effect;if(!s){return}this._activeEffect=s;this.bindOnlyWorldMatrix(t);if(o.OBJECTSPACE_NORMALMAP){t.toNormalMatrix(this._normalMatrix);this.bindOnlyNormalMatrix(this._normalMatrix)}var a=this._mustRebind(n,s,i.visibility);e.MaterialHelper.BindBonesParameters(i,this._activeEffect);var u=null;if(a){this._uniformBuffer.bindToEffect(s,"Material");this.bindViewProjection(s);u=this._getReflectionTexture();var l=this._getRefractionTexture();if(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync){if(n.texturesEnabled){if(this._albedoTexture&&e.StandardMaterial.DiffuseTextureEnabled){this._uniformBuffer.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level);e.MaterialHelper.BindTextureMatrix(this._albedoTexture,this._uniformBuffer,"albedo")}if(this._ambientTexture&&e.StandardMaterial.AmbientTextureEnabled){this._uniformBuffer.updateFloat3("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength);e.MaterialHelper.BindTextureMatrix(this._ambientTexture,this._uniformBuffer,"ambient")}if(this._opacityTexture&&e.StandardMaterial.OpacityTextureEnabled){this._uniformBuffer.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level);e.MaterialHelper.BindTextureMatrix(this._opacityTexture,this._uniformBuffer,"opacity")}if(u&&e.StandardMaterial.ReflectionTextureEnabled){this._uniformBuffer.updateMatrix("reflectionMatrix",u.getReflectionTextureMatrix());this._uniformBuffer.updateFloat2("vReflectionInfos",u.level,0);if(u.boundingBoxSize){var c=u;this._uniformBuffer.updateVector3("vReflectionPosition",c.boundingBoxPosition);this._uniformBuffer.updateVector3("vReflectionSize",c.boundingBoxSize)}var h=u.sphericalPolynomial;if(o.USESPHERICALFROMREFLECTIONMAP&&h){this._activeEffect.setFloat3("vSphericalX",h.x.x,h.x.y,h.x.z);this._activeEffect.setFloat3("vSphericalY",h.y.x,h.y.y,h.y.z);this._activeEffect.setFloat3("vSphericalZ",h.z.x,h.z.y,h.z.z);this._activeEffect.setFloat3("vSphericalXX_ZZ",h.xx.x-h.zz.x,h.xx.y-h.zz.y,h.xx.z-h.zz.z);this._activeEffect.setFloat3("vSphericalYY_ZZ",h.yy.x-h.zz.x,h.yy.y-h.zz.y,h.yy.z-h.zz.z);this._activeEffect.setFloat3("vSphericalZZ",h.zz.x,h.zz.y,h.zz.z);this._activeEffect.setFloat3("vSphericalXY",h.xy.x,h.xy.y,h.xy.z);this._activeEffect.setFloat3("vSphericalYZ",h.yz.x,h.yz.y,h.yz.z);this._activeEffect.setFloat3("vSphericalZX",h.zx.x,h.zx.y,h.zx.z)}this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",u.getSize().width,u.lodGenerationScale,u.lodGenerationOffset)}if(this._emissiveTexture&&e.StandardMaterial.EmissiveTextureEnabled){this._uniformBuffer.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level);e.MaterialHelper.BindTextureMatrix(this._emissiveTexture,this._uniformBuffer,"emissive")}if(this._lightmapTexture&&e.StandardMaterial.LightmapTextureEnabled){this._uniformBuffer.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level);e.MaterialHelper.BindTextureMatrix(this._lightmapTexture,this._uniformBuffer,"lightmap")}if(e.StandardMaterial.SpecularTextureEnabled){if(this._metallicTexture){this._uniformBuffer.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength);e.MaterialHelper.BindTextureMatrix(this._metallicTexture,this._uniformBuffer,"reflectivity")}else if(this._reflectivityTexture){this._uniformBuffer.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1);e.MaterialHelper.BindTextureMatrix(this._reflectivityTexture,this._uniformBuffer,"reflectivity")}if(this._microSurfaceTexture){this._uniformBuffer.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level)
;e.MaterialHelper.BindTextureMatrix(this._microSurfaceTexture,this._uniformBuffer,"microSurfaceSampler")}}if(this._bumpTexture&&n.getEngine().getCaps().standardDerivatives&&e.StandardMaterial.BumpTextureEnabled&&!this._disableBumpMap){this._uniformBuffer.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias);e.MaterialHelper.BindTextureMatrix(this._bumpTexture,this._uniformBuffer,"bump");if(n._mirroredCameraPosition){this._uniformBuffer.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1)}else{this._uniformBuffer.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)}}if(l&&e.StandardMaterial.RefractionTextureEnabled){this._uniformBuffer.updateMatrix("refractionMatrix",l.getReflectionTextureMatrix());var f=1;if(!l.isCube){if(l.depth){f=l.depth}}this._uniformBuffer.updateFloat4("vRefractionInfos",l.level,this._indexOfRefraction,f,this._invertRefractionY?-1:1);this._uniformBuffer.updateFloat3("vRefractionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset)}}if(this.pointsCloud){this._uniformBuffer.updateFloat("pointSize",this.pointSize)}if(o.METALLICWORKFLOW){e.PBRMaterial._scaledReflectivity.r=this._metallic===undefined||this._metallic===null?1:this._metallic;e.PBRMaterial._scaledReflectivity.g=this._roughness===undefined||this._roughness===null?1:this._roughness;this._uniformBuffer.updateColor4("vReflectivityColor",e.PBRMaterial._scaledReflectivity,0)}else{this._uniformBuffer.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface)}this._uniformBuffer.updateColor3("vEmissiveColor",this._emissiveColor);this._uniformBuffer.updateColor3("vReflectionColor",this._reflectionColor);this._uniformBuffer.updateColor4("vAlbedoColor",this._albedoColor,this.alpha*i.visibility);this._lightingInfos.x=this._directIntensity;this._lightingInfos.y=this._emissiveIntensity;this._lightingInfos.z=this._environmentIntensity;this._lightingInfos.w=this._specularIntensity;this._uniformBuffer.updateVector4("vLightingIntensity",this._lightingInfos)}if(n.texturesEnabled){if(this._albedoTexture&&e.StandardMaterial.DiffuseTextureEnabled){this._uniformBuffer.setTexture("albedoSampler",this._albedoTexture)}if(this._ambientTexture&&e.StandardMaterial.AmbientTextureEnabled){this._uniformBuffer.setTexture("ambientSampler",this._ambientTexture)}if(this._opacityTexture&&e.StandardMaterial.OpacityTextureEnabled){this._uniformBuffer.setTexture("opacitySampler",this._opacityTexture)}if(u&&e.StandardMaterial.ReflectionTextureEnabled){if(o.LODBASEDMICROSFURACE){this._uniformBuffer.setTexture("reflectionSampler",u)}else{this._uniformBuffer.setTexture("reflectionSampler",u._lodTextureMid||u);this._uniformBuffer.setTexture("reflectionSamplerLow",u._lodTextureLow||u);this._uniformBuffer.setTexture("reflectionSamplerHigh",u._lodTextureHigh||u)}}if(o.ENVIRONMENTBRDF){this._uniformBuffer.setTexture("environmentBrdfSampler",this._environmentBRDFTexture)}if(l&&e.StandardMaterial.RefractionTextureEnabled){if(o.LODBASEDMICROSFURACE){this._uniformBuffer.setTexture("refractionSampler",l)}else{this._uniformBuffer.setTexture("refractionSampler",l._lodTextureMid||l);this._uniformBuffer.setTexture("refractionSamplerLow",l._lodTextureLow||l);this._uniformBuffer.setTexture("refractionSamplerHigh",l._lodTextureHigh||l)}}if(this._emissiveTexture&&e.StandardMaterial.EmissiveTextureEnabled){this._uniformBuffer.setTexture("emissiveSampler",this._emissiveTexture)}if(this._lightmapTexture&&e.StandardMaterial.LightmapTextureEnabled){this._uniformBuffer.setTexture("lightmapSampler",this._lightmapTexture)}if(e.StandardMaterial.SpecularTextureEnabled){if(this._metallicTexture){this._uniformBuffer.setTexture("reflectivitySampler",this._metallicTexture)}else if(this._reflectivityTexture){this._uniformBuffer.setTexture("reflectivitySampler",this._reflectivityTexture)}if(this._microSurfaceTexture){this._uniformBuffer.setTexture("microSurfaceSampler",this._microSurfaceTexture)}}if(this._bumpTexture&&n.getEngine().getCaps().standardDerivatives&&e.StandardMaterial.BumpTextureEnabled&&!this._disableBumpMap){this._uniformBuffer.setTexture("bumpSampler",this._bumpTexture)}}e.MaterialHelper.BindClipPlane(this._activeEffect,n);n.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor);var d=n._forcedViewPosition?n._forcedViewPosition:n._mirroredCameraPosition?n._mirroredCameraPosition:n.activeCamera.globalPosition;var p=n.useRightHandedSystem===(n._mirroredCameraPosition!=null);s.setFloat4("vEyePosition",d.x,d.y,d.z,p?-1:1);s.setColor3("vAmbientColor",this._globalAmbientColor)}if(a||!this.isFrozen){if(n.lightsEnabled&&!this._disableLighting){e.MaterialHelper.BindLights(n,i,this._activeEffect,o,this._maxSimultaneousLights,this._usePhysicalLightFalloff)}if(n.fogEnabled&&i.applyFog&&n.fogMode!==e.Scene.FOGMODE_NONE||u){this.bindView(s)}e.MaterialHelper.BindFogParameters(n,i,this._activeEffect);if(o.NUM_MORPH_INFLUENCERS){e.MaterialHelper.BindMorphTargetParameters(i,this._activeEffect)}this._imageProcessingConfiguration.bind(this._activeEffect);e.MaterialHelper.BindLogDepth(o,this._activeEffect,n)}this._uniformBuffer.update();this._afterBind(i)};r.prototype.getAnimatables=function(){var e=[];if(this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0){e.push(this._albedoTexture)}if(this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0){e.push(this._ambientTexture)}if(this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0){e.push(this._opacityTexture)}if(this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0){e.push(this._reflectionTexture)}if(this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0){e.push(this._emissiveTexture)}if(this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0){e.push(this._metallicTexture)}else if(this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0){e.push(this._reflectivityTexture)}if(this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0){e.push(this._bumpTexture)}if(this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0){e.push(this._lightmapTexture)}if(this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0){e.push(this._refractionTexture)}return e};r.prototype._getReflectionTexture=function(){if(this._reflectionTexture){return this._reflectionTexture}return this.getScene().environmentTexture};r.prototype._getRefractionTexture=function(){if(this._refractionTexture){return this._refractionTexture}if(this._linkRefractionWithTransparency){return this.getScene().environmentTexture}return null};r.prototype.dispose=function(e,t){if(t){if(this._albedoTexture){this._albedoTexture.dispose()}if(this._ambientTexture){this._ambientTexture.dispose()}if(this._opacityTexture){this._opacityTexture.dispose()}if(this._reflectionTexture){this._reflectionTexture.dispose()}if(this._environmentBRDFTexture&&this.getScene()._environmentBRDFTexture!==this._environmentBRDFTexture){this._environmentBRDFTexture.dispose()}if(this._emissiveTexture){this._emissiveTexture.dispose()}if(this._metallicTexture){this._metallicTexture.dispose()}if(this._reflectivityTexture){this._reflectivityTexture.dispose()}if(this._bumpTexture){this._bumpTexture.dispose()}if(this._lightmapTexture){this._lightmapTexture.dispose()}if(this._refractionTexture){this._refractionTexture.dispose()}}this._renderTargets.dispose();if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}i.prototype.dispose.call(this,e,t)};r._scaledReflectivity=new e.Color3;__decorate([e.serializeAsImageProcessingConfiguration()],r.prototype,"_imageProcessingConfiguration",void 0);__decorate([e.serialize()],r.prototype,"useLogarithmicDepth",null);__decorate([e.serialize()],r.prototype,"transparencyMode",null);return r}(e.PushMaterial);e.PBRBaseMaterial=i})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r){var n=t.call(this,i,r)||this;n.maxSimultaneousLights=4;n.disableLighting=false;n.invertNormalMapX=false;n.invertNormalMapY=false;n.emissiveColor=new e.Color3(0,0,0);n.occlusionStrength=1;n.useLightmapAsShadowmap=false;n._useAlphaFromAlbedoTexture=true;n._useAmbientInGrayScale=true;return n}Object.defineProperty(i.prototype,"doubleSided",{get:function(){return this._twoSidedLighting},set:function(e){if(this._twoSidedLighting===e){return}this._twoSidedLighting=e;this.backFaceCulling=!e;this._markAllSubMeshesAsTexturesDirty()},enumerable:true,configurable:true});i.prototype.getActiveTextures=function(){var e=t.prototype.getActiveTextures.call(this);if(this.environmentTexture){e.push(this.environmentTexture)}if(this.normalTexture){e.push(this.normalTexture)}if(this.emissiveTexture){e.push(this.emissiveTexture)}if(this.occlusionTexture){e.push(this.occlusionTexture)}if(this.lightmapTexture){e.push(this.lightmapTexture)}return e};i.prototype.hasTexture=function(e){if(t.prototype.hasTexture.call(this,e)){return true}if(this.lightmapTexture===e){return true}return false};i.prototype.getClassName=function(){return"PBRBaseSimpleMaterial"};__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsLightsDirty")],i.prototype,"maxSimultaneousLights",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsLightsDirty")],i.prototype,"disableLighting",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],i.prototype,"environmentTexture",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"invertNormalMapX",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"invertNormalMapY",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],i.prototype,"normalTexture",void 0);__decorate([e.serializeAsColor3("emissive"),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"emissiveColor",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"emissiveTexture",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],i.prototype,"occlusionStrength",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],i.prototype,"occlusionTexture",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],i.prototype,"alphaCutOff",void 0);__decorate([e.serialize()],i.prototype,"doubleSided",null);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty",null)],i.prototype,"lightmapTexture",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useLightmapAsShadowmap",void 0);return i}(e.PBRBaseMaterial);e.PBRBaseSimpleMaterial=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r){var n=t.call(this,i,r)||this;n.directIntensity=1;n.emissiveIntensity=1;n.environmentIntensity=1;n.specularIntensity=1;n.disableBumpMap=false;n.ambientTextureStrength=1;n.ambientColor=new e.Color3(0,0,0);n.albedoColor=new e.Color3(1,1,1);n.reflectivityColor=new e.Color3(1,1,1);n.reflectionColor=new e.Color3(1,1,1);n.emissiveColor=new e.Color3(0,0,0);n.microSurface=1;n.indexOfRefraction=.66;n.invertRefractionY=false;n.linkRefractionWithTransparency=false;n.useLightmapAsShadowmap=false;n.useAlphaFromAlbedoTexture=false;n.forceAlphaTest=false;n.alphaCutOff=.4;n.useSpecularOverAlpha=true;n.useMicroSurfaceFromReflectivityMapAlpha=false;n.useRoughnessFromMetallicTextureAlpha=true;n.useRoughnessFromMetallicTextureGreen=false;n.useMetallnessFromMetallicTextureBlue=false;n.useAmbientOcclusionFromMetallicTextureRed=false;n.useAmbientInGrayScale=false;n.useAutoMicroSurfaceFromReflectivityMap=false;n.usePhysicalLightFalloff=true;n.useRadianceOverAlpha=true;n.useObjectSpaceNormalMap=false;n.useParallax=false;n.useParallaxOcclusion=false;n.parallaxScaleBias=.05;n.disableLighting=false;n.forceIrradianceInFragment=false;n.maxSimultaneousLights=4;n.invertNormalMapX=false;n.invertNormalMapY=false;n.twoSidedLighting=false;n.useAlphaFresnel=false;n.useLinearAlphaFresnel=false;n.environmentBRDFTexture=null;n.forceNormalForward=false;n.enableSpecularAntiAliasing=false;n.useHorizonOcclusion=true;n.useRadianceOcclusion=true;n.unlit=false;n._environmentBRDFTexture=e.TextureTools.GetEnvironmentBRDFTexture(r);return n}Object.defineProperty(i,"PBRMATERIAL_OPAQUE",{get:function(){return this._PBRMATERIAL_OPAQUE},enumerable:true,configurable:true});Object.defineProperty(i,"PBRMATERIAL_ALPHATEST",{get:function(){return this._PBRMATERIAL_ALPHATEST},enumerable:true,configurable:true});Object.defineProperty(i,"PBRMATERIAL_ALPHABLEND",{get:function(){return this._PBRMATERIAL_ALPHABLEND},enumerable:true,configurable:true});Object.defineProperty(i,"PBRMATERIAL_ALPHATESTANDBLEND",{get:function(){return this._PBRMATERIAL_ALPHATESTANDBLEND},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e);this._markAllSubMeshesAsTexturesDirty()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(e){this._imageProcessingConfiguration.exposure=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(e){this._imageProcessingConfiguration.contrast=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(e){this._imageProcessingConfiguration.colorGradingTexture=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(e){this._imageProcessingConfiguration.colorCurves=e},enumerable:true,configurable:true});i.prototype.getClassName=function(){return"PBRMaterial"};i.prototype.getActiveTextures=function(){var e=t.prototype.getActiveTextures.call(this);if(this._albedoTexture){e.push(this._albedoTexture)}if(this._ambientTexture){e.push(this._ambientTexture)}if(this._opacityTexture){e.push(this._opacityTexture)}if(this._reflectionTexture){e.push(this._reflectionTexture)}if(this._emissiveTexture){e.push(this._emissiveTexture)}if(this._reflectivityTexture){e.push(this._reflectivityTexture)}if(this._metallicTexture){e.push(this._metallicTexture)}if(this._microSurfaceTexture){e.push(this._microSurfaceTexture)}if(this._bumpTexture){e.push(this._bumpTexture)}if(this._lightmapTexture){e.push(this._lightmapTexture)}if(this._refractionTexture){e.push(this._refractionTexture)}return e};i.prototype.hasTexture=function(e){if(t.prototype.hasTexture.call(this,e)){return true}if(this._albedoTexture===e){return true}if(this._ambientTexture===e){return true}if(this._opacityTexture===e){return true}if(this._reflectionTexture===e){return true}if(this._reflectivityTexture===e){return true}if(this._metallicTexture===e){return true}if(this._microSurfaceTexture===e){return true}if(this._bumpTexture===e){return true}if(this._lightmapTexture===e){return true}if(this._refractionTexture===e){return true}return false};i.prototype.clone=function(t){var r=this;var n=e.SerializationHelper.Clone(function(){return new i(t,r.getScene())},this);n.id=t;n.name=t;return n};i.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);t.customType="BABYLON.PBRMaterial";return t};i.Parse=function(t,r,n){return e.SerializationHelper.Parse(function(){return new i(t.name,r)},t,r,n)};i._PBRMATERIAL_OPAQUE=0;i._PBRMATERIAL_ALPHATEST=1;i._PBRMATERIAL_ALPHABLEND=2;i._PBRMATERIAL_ALPHATESTANDBLEND=3;__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"directIntensity",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"emissiveIntensity",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"environmentIntensity",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"specularIntensity",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"disableBumpMap",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"albedoTexture",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"ambientTexture",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"ambientTextureStrength",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesAndMiscDirty")],i.prototype,"opacityTexture",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"reflectionTexture",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"emissiveTexture",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"reflectivityTexture",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"metallicTexture",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"metallic",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"roughness",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"microSurfaceTexture",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"bumpTexture",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty",null)],i.prototype,"lightmapTexture",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"refractionTexture",void 0);__decorate([e.serializeAsColor3("ambient"),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"ambientColor",void 0);__decorate([e.serializeAsColor3("albedo"),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"albedoColor",void 0);__decorate([e.serializeAsColor3("reflectivity"),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"reflectivityColor",void 0);__decorate([e.serializeAsColor3("reflection"),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"reflectionColor",void 0);__decorate([e.serializeAsColor3("emissive"),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"emissiveColor",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"microSurface",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"indexOfRefraction",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"invertRefractionY",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"linkRefractionWithTransparency",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useLightmapAsShadowmap",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesAndMiscDirty")],i.prototype,"useAlphaFromAlbedoTexture",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesAndMiscDirty")],i.prototype,"forceAlphaTest",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesAndMiscDirty")],i.prototype,"alphaCutOff",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useSpecularOverAlpha",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useRoughnessFromMetallicTextureAlpha",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useRoughnessFromMetallicTextureGreen",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useMetallnessFromMetallicTextureBlue",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useAmbientInGrayScale",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"usePhysicalLightFalloff",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useRadianceOverAlpha",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useObjectSpaceNormalMap",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useParallax",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useParallaxOcclusion",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"parallaxScaleBias",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsLightsDirty")],i.prototype,"disableLighting",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"forceIrradianceInFragment",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsLightsDirty")],i.prototype,"maxSimultaneousLights",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"invertNormalMapX",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"invertNormalMapY",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"twoSidedLighting",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useAlphaFresnel",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useLinearAlphaFresnel",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"environmentBRDFTexture",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"forceNormalForward",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"enableSpecularAntiAliasing",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useHorizonOcclusion",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useRadianceOcclusion",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsLightsDirty")],i.prototype,"unlit",void 0);return i}(e.PBRBaseMaterial);e.PBRMaterial=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(e,i){var r=t.call(this,e,i)||this;r._useRoughnessFromMetallicTextureAlpha=false;r._useRoughnessFromMetallicTextureGreen=true;r._useMetallnessFromMetallicTextureBlue=true;r.metallic=1;r.roughness=1;return r}i.prototype.getClassName=function(){return"PBRMetallicRoughnessMaterial"};i.prototype.getActiveTextures=function(){var e=t.prototype.getActiveTextures.call(this);if(this.baseTexture){e.push(this.baseTexture)}if(this.metallicRoughnessTexture){e.push(this.metallicRoughnessTexture)}return e};i.prototype.hasTexture=function(e){if(t.prototype.hasTexture.call(this,e)){return true}if(this.baseTexture===e){return true}if(this.metallicRoughnessTexture===e){return true}return false};i.prototype.clone=function(t){var r=this;var n=e.SerializationHelper.Clone(function(){return new i(t,r.getScene())},this);n.id=t;n.name=t;return n};i.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);t.customType="BABYLON.PBRMetallicRoughnessMaterial";return t};i.Parse=function(t,r,n){return e.SerializationHelper.Parse(function(){return new i(t.name,r)},t,r,n)};__decorate([e.serializeAsColor3(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_albedoColor")],i.prototype,"baseColor",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],i.prototype,"baseTexture",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"metallic",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"roughness",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],i.prototype,"metallicRoughnessTexture",void 0);return i}(e.PBRBaseSimpleMaterial);e.PBRMetallicRoughnessMaterial=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(e,i){var r=t.call(this,e,i)||this;r._useMicroSurfaceFromReflectivityMapAlpha=true;return r}i.prototype.getClassName=function(){return"PBRSpecularGlossinessMaterial"};i.prototype.getActiveTextures=function(){var e=t.prototype.getActiveTextures.call(this);if(this.diffuseTexture){e.push(this.diffuseTexture)}if(this.specularGlossinessTexture){e.push(this.specularGlossinessTexture)}return e};i.prototype.hasTexture=function(e){if(t.prototype.hasTexture.call(this,e)){return true}if(this.diffuseTexture===e){return true}if(this.specularGlossinessTexture===e){return true}return false};i.prototype.clone=function(t){var r=this;var n=e.SerializationHelper.Clone(function(){return new i(t,r.getScene())},this);n.id=t;n.name=t;return n};i.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);t.customType="BABYLON.PBRSpecularGlossinessMaterial";return t};i.Parse=function(t,r,n){return e.SerializationHelper.Parse(function(){return new i(t.name,r)},t,r,n)};__decorate([e.serializeAsColor3("diffuse"),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_albedoColor")],i.prototype,"diffuseColor",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],i.prototype,"diffuseTexture",void 0);__decorate([e.serializeAsColor3("specular"),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],i.prototype,"specularColor",void 0);__decorate([e.serialize(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_microSurface")],i.prototype,"glossiness",void 0);__decorate([e.serializeAsTexture(),e.expandToProperty("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],i.prototype,"specularGlossinessTexture",void 0);return i}(e.PBRBaseSimpleMaterial);e.PBRSpecularGlossinessMaterial=t})(r||(r={}));"use strict";var r;(function(e){e.CameraInputTypes={};var t=function(){function t(e){this.attached={};this.camera=e;this.checkInputs=function(){}}t.prototype.add=function(t){var i=t.getSimpleName();if(this.attached[i]){e.Tools.Warn("camera input of type "+i+" already exists on camera");return}this.attached[i]=t;t.camera=this.camera;if(t.checkInputs){this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t))}if(this.attachedElement){t.attachControl(this.attachedElement)}};t.prototype.remove=function(e){for(var t in this.attached){var i=this.attached[t];if(i===e){i.detachControl(this.attachedElement);i.camera=null;delete this.attached[t];this.rebuildInputCheck()}}};t.prototype.removeByType=function(e){for(var t in this.attached){var i=this.attached[t];if(i.getClassName()===e){i.detachControl(this.attachedElement);i.camera=null;delete this.attached[t];this.rebuildInputCheck()}}};t.prototype._addCheckInputs=function(e){var t=this.checkInputs;return function(){t();e()}};t.prototype.attachInput=function(e){if(this.attachedElement){e.attachControl(this.attachedElement,this.noPreventDefault)}};t.prototype.attachElement=function(t,i){if(i===void 0){i=false}if(this.attachedElement){return}i=e.Camera.ForceAttachControlToAlwaysPreventDefault?false:i;this.attachedElement=t;this.noPreventDefault=i;for(var r in this.attached){this.attached[r].attachControl(t,i)}};t.prototype.detachElement=function(e,t){if(t===void 0){t=false}if(this.attachedElement!==e){return}for(var i in this.attached){this.attached[i].detachControl(e);if(t){this.attached[i].camera=null}}this.attachedElement=null};t.prototype.rebuildInputCheck=function(){this.checkInputs=function(){};for(var e in this.attached){var t=this.attached[e];if(t.checkInputs){this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t))}}};t.prototype.clear=function(){if(this.attachedElement){this.detachElement(this.attachedElement,true)}this.attached={};this.attachedElement=null;this.checkInputs=function(){}};t.prototype.serialize=function(t){var i={};for(var r in this.attached){var n=this.attached[r];var o=e.SerializationHelper.Serialize(n);i[n.getClassName()]=o}t.inputsmgr=i};t.prototype.parse=function(t){var i=t.inputsmgr;if(i){this.clear();for(var r in i){var n=e.CameraInputTypes[r];if(n){var o=i[r];var s=e.SerializationHelper.Parse(function(){return new n},o,null);this.add(s)}}}else{for(var r in this.attached){var n=e.CameraInputTypes[this.attached[r].getClassName()];if(n){var s=e.SerializationHelper.Parse(function(){return new n},t,null);this.remove(this.attached[r]);this.add(s)}}}};return t}();e.CameraInputsManager=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n){var o=t.call(this,i,r,n)||this;o.cameraDirection=new e.Vector3(0,0,0);o.cameraRotation=new e.Vector2(0,0);o.rotation=new e.Vector3(0,0,0);o.speed=2;o.noRotationConstraint=false;o.lockedTarget=null;o._currentTarget=e.Vector3.Zero();o._viewMatrix=e.Matrix.Zero();o._camMatrix=e.Matrix.Zero();o._cameraTransformMatrix=e.Matrix.Zero();o._cameraRotationMatrix=e.Matrix.Zero();o._referencePoint=new e.Vector3(0,0,1);o._currentUpVector=new e.Vector3(0,1,0);o._transformedReferencePoint=e.Vector3.Zero();o._lookAtTemp=e.Matrix.Zero()
;o._tempMatrix=e.Matrix.Zero();return o}i.prototype.getFrontPosition=function(e){this.getWorldMatrix();var t=this.getTarget().subtract(this.position);t.normalize();t.scaleInPlace(e);return this.globalPosition.add(t)};i.prototype._getLockedTargetPosition=function(){if(!this.lockedTarget){return null}if(this.lockedTarget.absolutePosition){this.lockedTarget.computeWorldMatrix()}return this.lockedTarget.absolutePosition||this.lockedTarget};i.prototype.storeState=function(){this._storedPosition=this.position.clone();this._storedRotation=this.rotation.clone();if(this.rotationQuaternion){this._storedRotationQuaternion=this.rotationQuaternion.clone()}return t.prototype.storeState.call(this)};i.prototype._restoreStateValues=function(){if(!t.prototype._restoreStateValues.call(this)){return false}this.position=this._storedPosition.clone();this.rotation=this._storedRotation.clone();if(this.rotationQuaternion){this.rotationQuaternion=this._storedRotationQuaternion.clone()}this.cameraDirection.copyFromFloats(0,0,0);this.cameraRotation.copyFromFloats(0,0);return true};i.prototype._initCache=function(){t.prototype._initCache.call(this);this._cache.lockedTarget=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.rotation=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.rotationQuaternion=new e.Quaternion(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};i.prototype._updateCache=function(e){if(!e){t.prototype._updateCache.call(this)}var i=this._getLockedTargetPosition();if(!i){this._cache.lockedTarget=null}else{if(!this._cache.lockedTarget){this._cache.lockedTarget=i.clone()}else{this._cache.lockedTarget.copyFrom(i)}}this._cache.rotation.copyFrom(this.rotation);if(this.rotationQuaternion)this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)};i.prototype._isSynchronizedViewMatrix=function(){if(!t.prototype._isSynchronizedViewMatrix.call(this)){return false}var e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))};i.prototype._computeLocalCameraSpeed=function(){var e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))};i.prototype.setTarget=function(t){this.upVector.normalize();e.Matrix.LookAtLHToRef(this.position,t,this.upVector,this._camMatrix);this._camMatrix.invert();this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var i=t.subtract(this.position);if(i.x>=0){this.rotation.y=-Math.atan(i.z/i.x)+Math.PI/2}else{this.rotation.y=-Math.atan(i.z/i.x)-Math.PI/2}this.rotation.z=0;if(isNaN(this.rotation.x)){this.rotation.x=0}if(isNaN(this.rotation.y)){this.rotation.y=0}if(isNaN(this.rotation.z)){this.rotation.z=0}if(this.rotationQuaternion){e.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}};i.prototype.getTarget=function(){return this._currentTarget};i.prototype._decideIfNeedsToMove=function(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0};i.prototype._updatePosition=function(){if(this.parent){this.parent.getWorldMatrix().invertToRef(e.Tmp.Matrix[0]);e.Vector3.TransformNormalToRef(this.cameraDirection,e.Tmp.Matrix[0],e.Tmp.Vector3[0]);this.position.addInPlace(e.Tmp.Vector3[0]);return}this.position.addInPlace(this.cameraDirection)};i.prototype._checkInputs=function(){var i=this._decideIfNeedsToMove();var r=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;if(i){this._updatePosition()}if(r){this.rotation.x+=this.cameraRotation.x;this.rotation.y+=this.cameraRotation.y;if(this.rotationQuaternion){var n=this.rotation.lengthSquared();if(n){e.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}}if(!this.noRotationConstraint){var o=Math.PI/2*.95;if(this.rotation.x>o)this.rotation.x=o;if(this.rotation.x<-o)this.rotation.x=-o}}if(i){if(Math.abs(this.cameraDirection.x)<this.speed*e.Epsilon){this.cameraDirection.x=0}if(Math.abs(this.cameraDirection.y)<this.speed*e.Epsilon){this.cameraDirection.y=0}if(Math.abs(this.cameraDirection.z)<this.speed*e.Epsilon){this.cameraDirection.z=0}this.cameraDirection.scaleInPlace(this.inertia)}if(r){if(Math.abs(this.cameraRotation.x)<this.speed*e.Epsilon){this.cameraRotation.x=0}if(Math.abs(this.cameraRotation.y)<this.speed*e.Epsilon){this.cameraRotation.y=0}this.cameraRotation.scaleInPlace(this.inertia)}t.prototype._checkInputs.call(this)};i.prototype._updateCameraRotationMatrix=function(){if(this.rotationQuaternion){this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix)}else{e.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}e.Vector3.TransformNormalToRef(this.upVector,this._cameraRotationMatrix,this._currentUpVector)};i.prototype._getViewMatrix=function(){if(this.lockedTarget){this.setTarget(this._getLockedTargetPosition())}this._updateCameraRotationMatrix();e.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint);this.position.addToRef(this._transformedReferencePoint,this._currentTarget);if(this.getScene().useRightHandedSystem){e.Matrix.LookAtRHToRef(this.position,this._currentTarget,this._currentUpVector,this._viewMatrix)}else{e.Matrix.LookAtLHToRef(this.position,this._currentTarget,this._currentUpVector,this._viewMatrix)}return this._viewMatrix};i.prototype.createRigCamera=function(t,r){if(this.cameraRigMode!==e.Camera.RIG_MODE_NONE){var n=new i(t,this.position.clone(),this.getScene());if(this.cameraRigMode===e.Camera.RIG_MODE_VR||this.cameraRigMode===e.Camera.RIG_MODE_WEBVR){if(!this.rotationQuaternion){this.rotationQuaternion=new e.Quaternion}n._cameraRigParams={};n.rotationQuaternion=new e.Quaternion}return n}return null};i.prototype._updateRigCameras=function(){var i=this._rigCameras[0];var r=this._rigCameras[1];switch(this.cameraRigMode){case e.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case e.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:var n=this.cameraRigMode===e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1;var o=this.cameraRigMode===e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPosition(this._cameraRigParams.stereoHalfAngle*n,i.position);this._getRigCamPosition(this._cameraRigParams.stereoHalfAngle*o,r.position);i.setTarget(this.getTarget());r.setTarget(this.getTarget());break;case e.Camera.RIG_MODE_VR:if(i.rotationQuaternion){i.rotationQuaternion.copyFrom(this.rotationQuaternion);r.rotationQuaternion.copyFrom(this.rotationQuaternion)}else{i.rotation.copyFrom(this.rotation);r.rotation.copyFrom(this.rotation)}i.position.copyFrom(this.position);r.position.copyFrom(this.position);break}t.prototype._updateRigCameras.call(this)};i.prototype._getRigCamPosition=function(t,i){if(!this._rigCamTransformMatrix){this._rigCamTransformMatrix=new e.Matrix}var r=this.getTarget();e.Matrix.Translation(-r.x,-r.y,-r.z).multiplyToRef(e.Matrix.RotationY(t),this._rigCamTransformMatrix);this._rigCamTransformMatrix=this._rigCamTransformMatrix.multiply(e.Matrix.Translation(r.x,r.y,r.z));e.Vector3.TransformCoordinatesToRef(this.position,this._rigCamTransformMatrix,i)};i.prototype.getClassName=function(){return"TargetCamera"};__decorate([e.serializeAsVector3()],i.prototype,"rotation",void 0);__decorate([e.serialize()],i.prototype,"speed",void 0);__decorate([e.serializeAsMeshReference("lockedTargetId")],i.prototype,"lockedTarget",void 0);return i}(e.Camera);e.TargetCamera=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e){if(e===void 0){e=true}this.touchEnabled=e;this.buttons=[0,1,2];this.angularSensibility=2e3;this.previousPosition=null}t.prototype.attachControl=function(t,i){var r=this;var n=this.camera.getEngine();if(!this._pointerInput){this._pointerInput=function(o,s){var a=o.event;if(n.isInVRExclusivePointerMode){return}if(!r.touchEnabled&&a.pointerType==="touch"){return}if(o.type!==e.PointerEventTypes.POINTERMOVE&&r.buttons.indexOf(a.button)===-1){return}var u=a.srcElement||a.target;if(o.type===e.PointerEventTypes.POINTERDOWN&&u){try{u.setPointerCapture(a.pointerId)}catch(e){}r.previousPosition={x:a.clientX,y:a.clientY};if(!i){a.preventDefault();t.focus()}}else if(o.type===e.PointerEventTypes.POINTERUP&&u){try{u.releasePointerCapture(a.pointerId)}catch(e){}r.previousPosition=null;if(!i){a.preventDefault()}}else if(o.type===e.PointerEventTypes.POINTERMOVE){if(!r.previousPosition||n.isPointerLock){return}var l=a.clientX-r.previousPosition.x;var c=a.clientY-r.previousPosition.y;if(r.camera.getScene().useRightHandedSystem){r.camera.cameraRotation.y-=l/r.angularSensibility}else{r.camera.cameraRotation.y+=l/r.angularSensibility}r.camera.cameraRotation.x+=c/r.angularSensibility;r.previousPosition={x:a.clientX,y:a.clientY};if(!i){a.preventDefault()}}}}this._onMouseMove=function(e){if(!n.isPointerLock){return}if(n.isInVRExclusivePointerMode){return}var t=e.movementX||e.mozMovementX||e.webkitMovementX||e.msMovementX||0;var o=e.movementY||e.mozMovementY||e.webkitMovementY||e.msMovementY||0;if(r.camera.getScene().useRightHandedSystem){r.camera.cameraRotation.y-=t/r.angularSensibility}else{r.camera.cameraRotation.y+=t/r.angularSensibility}r.camera.cameraRotation.x+=o/r.angularSensibility;r.previousPosition=null;if(!i){e.preventDefault()}};this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,e.PointerEventTypes.POINTERDOWN|e.PointerEventTypes.POINTERUP|e.PointerEventTypes.POINTERMOVE);t.addEventListener("mousemove",this._onMouseMove,false)};t.prototype.detachControl=function(e){if(this._observer&&e){this.camera.getScene().onPointerObservable.remove(this._observer);if(this._onMouseMove){e.removeEventListener("mousemove",this._onMouseMove)}this._observer=null;this._onMouseMove=null;this.previousPosition=null}};t.prototype.getClassName=function(){return"FreeCameraMouseInput"};t.prototype.getSimpleName=function(){return"mouse"};__decorate([e.serialize()],t.prototype,"buttons",void 0);__decorate([e.serialize()],t.prototype,"angularSensibility",void 0);return t}();e.FreeCameraMouseInput=t;e.CameraInputTypes["FreeCameraMouseInput"]=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this._keys=new Array;this.keysUp=[38];this.keysDown=[40];this.keysLeft=[37];this.keysRight=[39]}t.prototype.attachControl=function(t,i){var r=this;if(this._onCanvasBlurObserver){return}this._scene=this.camera.getScene();this._engine=this._scene.getEngine();this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){r._keys=[]});this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(t){var n=t.event;if(t.type===e.KeyboardEventTypes.KEYDOWN){if(r.keysUp.indexOf(n.keyCode)!==-1||r.keysDown.indexOf(n.keyCode)!==-1||r.keysLeft.indexOf(n.keyCode)!==-1||r.keysRight.indexOf(n.keyCode)!==-1){var o=r._keys.indexOf(n.keyCode);if(o===-1){r._keys.push(n.keyCode)}if(!i){n.preventDefault()}}}else{if(r.keysUp.indexOf(n.keyCode)!==-1||r.keysDown.indexOf(n.keyCode)!==-1||r.keysLeft.indexOf(n.keyCode)!==-1||r.keysRight.indexOf(n.keyCode)!==-1){var o=r._keys.indexOf(n.keyCode);if(o>=0){r._keys.splice(o,1)}if(!i){n.preventDefault()}}}})};t.prototype.detachControl=function(e){if(this._scene){if(this._onKeyboardObserver){this._scene.onKeyboardObservable.remove(this._onKeyboardObserver)}if(this._onCanvasBlurObserver){this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver)}this._onKeyboardObserver=null;this._onCanvasBlurObserver=null}this._keys=[]};t.prototype.checkInputs=function(){if(this._onKeyboardObserver){var t=this.camera;for(var i=0;i<this._keys.length;i++){var r=this._keys[i];var n=t._computeLocalCameraSpeed();if(this.keysLeft.indexOf(r)!==-1){t._localDirection.copyFromFloats(-n,0,0)}else if(this.keysUp.indexOf(r)!==-1){t._localDirection.copyFromFloats(0,0,n)}else if(this.keysRight.indexOf(r)!==-1){t._localDirection.copyFromFloats(n,0,0)}else if(this.keysDown.indexOf(r)!==-1){t._localDirection.copyFromFloats(0,0,-n)}if(t.getScene().useRightHandedSystem){t._localDirection.z*=-1}t.getViewMatrix().invertToRef(t._cameraTransformMatrix);e.Vector3.TransformNormalToRef(t._localDirection,t._cameraTransformMatrix,t._transformedDirection);t.cameraDirection.addInPlace(t._transformedDirection)}}};t.prototype.getClassName=function(){return"FreeCameraKeyboardMoveInput"};t.prototype._onLostFocus=function(e){this._keys=[]};t.prototype.getSimpleName=function(){return"keyboard"};__decorate([e.serialize()],t.prototype,"keysUp",void 0);__decorate([e.serialize()],t.prototype,"keysDown",void 0);__decorate([e.serialize()],t.prototype,"keysLeft",void 0);__decorate([e.serialize()],t.prototype,"keysRight",void 0);return t}();e.FreeCameraKeyboardMoveInput=t;e.CameraInputTypes["FreeCameraKeyboardMoveInput"]=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(e){return t.call(this,e)||this}i.prototype.addKeyboard=function(){this.add(new e.FreeCameraKeyboardMoveInput);return this};i.prototype.addMouse=function(t){if(t===void 0){t=true}this.add(new e.FreeCameraMouseInput(t));return this};i.prototype.addGamepad=function(){this.add(new e.FreeCameraGamepadInput);return this};i.prototype.addDeviceOrientation=function(){this.add(new e.FreeCameraDeviceOrientationInput);return this};i.prototype.addTouch=function(){this.add(new e.FreeCameraTouchInput);return this};i.prototype.addVirtualJoystick=function(){this.add(new e.FreeCameraVirtualJoystickInput);return this};return i}(e.CameraInputsManager);e.FreeCameraInputsManager=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n){var o=t.call(this,i,r,n)||this;o.ellipsoid=new e.Vector3(.5,1,.5);o.ellipsoidOffset=new e.Vector3(0,0,0);o.checkCollisions=false;o.applyGravity=false;o._needMoveForGravity=false;o._oldPosition=e.Vector3.Zero();o._diffPosition=e.Vector3.Zero();o._newPosition=e.Vector3.Zero();o._collisionMask=-1;o._onCollisionPositionChange=function(t,i,r){if(r===void 0){r=null}if(o.getScene().workerCollisions)i.multiplyInPlace(o._collider._radius);var n=function(t){o._newPosition.copyFrom(t);o._newPosition.subtractToRef(o._oldPosition,o._diffPosition);if(o._diffPosition.length()>e.Engine.CollisionsEpsilon){o.position.addInPlace(o._diffPosition);if(o.onCollide&&r){o.onCollide(r)}}};n(i)};o.inputs=new e.FreeCameraInputsManager(o);o.inputs.addKeyboard().addMouse();return o}Object.defineProperty(i.prototype,"angularSensibility",{get:function(){var e=this.inputs.attached["mouse"];if(e)return e.angularSensibility;return 0},set:function(e){var t=this.inputs.attached["mouse"];if(t)t.angularSensibility=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"keysUp",{get:function(){var e=this.inputs.attached["keyboard"];if(e)return e.keysUp;return[]},set:function(e){var t=this.inputs.attached["keyboard"];if(t)t.keysUp=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"keysDown",{get:function(){var e=this.inputs.attached["keyboard"];if(e)return e.keysDown;return[]},set:function(e){var t=this.inputs.attached["keyboard"];if(t)t.keysDown=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"keysLeft",{get:function(){var e=this.inputs.attached["keyboard"];if(e)return e.keysLeft;return[]},set:function(e){var t=this.inputs.attached["keyboard"];if(t)t.keysLeft=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"keysRight",{get:function(){var e=this.inputs.attached["keyboard"];if(e)return e.keysRight;return[]},set:function(e){var t=this.inputs.attached["keyboard"];if(t)t.keysRight=e},enumerable:true,configurable:true});i.prototype.attachControl=function(e,t){this.inputs.attachElement(e,t)};i.prototype.detachControl=function(t){this.inputs.detachElement(t);this.cameraDirection=new e.Vector3(0,0,0);this.cameraRotation=new e.Vector2(0,0)};Object.defineProperty(i.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(e){this._collisionMask=!isNaN(e)?e:-1},enumerable:true,configurable:true});i.prototype._collideWithWorld=function(t){var i;if(this.parent){i=e.Vector3.TransformCoordinates(this.position,this.parent.getWorldMatrix())}else{i=this.position}i.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition);this._oldPosition.addInPlace(this.ellipsoidOffset);if(!this._collider){this._collider=new e.Collider}this._collider._radius=this.ellipsoid;this._collider.collisionMask=this._collisionMask;var r=t;if(this.applyGravity){r=t.add(this.getScene().gravity)}this.getScene().collisionCoordinator.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)};i.prototype._checkInputs=function(){if(!this._localDirection){this._localDirection=e.Vector3.Zero();this._transformedDirection=e.Vector3.Zero()}this.inputs.checkInputs();t.prototype._checkInputs.call(this)};i.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0};i.prototype._updatePosition=function(){if(this.checkCollisions&&this.getScene().collisionsEnabled){this._collideWithWorld(this.cameraDirection)}else{t.prototype._updatePosition.call(this)}};i.prototype.dispose=function(){this.inputs.clear();t.prototype.dispose.call(this)};i.prototype.getClassName=function(){return"FreeCamera"};__decorate([e.serializeAsVector3()],i.prototype,"ellipsoid",void 0);__decorate([e.serializeAsVector3()],i.prototype,"ellipsoidOffset",void 0);__decorate([e.serialize()],i.prototype,"checkCollisions",void 0);__decorate([e.serialize()],i.prototype,"applyGravity",void 0);return i}(e.TargetCamera);e.FreeCamera=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this._keys=new Array;this.keysUp=[38];this.keysDown=[40];this.keysLeft=[37];this.keysRight=[39];this.keysReset=[220];this.panningSensibility=50;this.zoomingSensibility=25;this.useAltToZoom=true}t.prototype.attachControl=function(t,i){var r=this;if(this._onCanvasBlurObserver){return}this._scene=this.camera.getScene();this._engine=this._scene.getEngine();this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){r._keys=[]});this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(t){var n=t.event;if(t.type===e.KeyboardEventTypes.KEYDOWN){r._ctrlPressed=n.ctrlKey;r._altPressed=n.altKey;if(r.keysUp.indexOf(n.keyCode)!==-1||r.keysDown.indexOf(n.keyCode)!==-1||r.keysLeft.indexOf(n.keyCode)!==-1||r.keysRight.indexOf(n.keyCode)!==-1||r.keysReset.indexOf(n.keyCode)!==-1){var o=r._keys.indexOf(n.keyCode);if(o===-1){r._keys.push(n.keyCode)}if(n.preventDefault){if(!i){n.preventDefault()}}}}else{if(r.keysUp.indexOf(n.keyCode)!==-1||r.keysDown.indexOf(n.keyCode)!==-1||r.keysLeft.indexOf(n.keyCode)!==-1||r.keysRight.indexOf(n.keyCode)!==-1||r.keysReset.indexOf(n.keyCode)!==-1){var o=r._keys.indexOf(n.keyCode);if(o>=0){r._keys.splice(o,1)}if(n.preventDefault){if(!i){n.preventDefault()}}}}})};t.prototype.detachControl=function(e){if(this._scene){if(this._onKeyboardObserver){this._scene.onKeyboardObservable.remove(this._onKeyboardObserver)}if(this._onCanvasBlurObserver){this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver)}this._onKeyboardObserver=null;this._onCanvasBlurObserver=null}this._keys=[]};t.prototype.checkInputs=function(){if(this._onKeyboardObserver){var e=this.camera;for(var t=0;t<this._keys.length;t++){var i=this._keys[t];if(this.keysLeft.indexOf(i)!==-1){if(this._ctrlPressed&&this.camera._useCtrlForPanning){e.inertialPanningX-=1/this.panningSensibility}else{e.inertialAlphaOffset-=.01}}else if(this.keysUp.indexOf(i)!==-1){if(this._ctrlPressed&&this.camera._useCtrlForPanning){e.inertialPanningY+=1/this.panningSensibility}else if(this._altPressed&&this.useAltToZoom){e.inertialRadiusOffset+=1/this.zoomingSensibility}else{e.inertialBetaOffset-=.01}}else if(this.keysRight.indexOf(i)!==-1){if(this._ctrlPressed&&this.camera._useCtrlForPanning){e.inertialPanningX+=1/this.panningSensibility}else{e.inertialAlphaOffset+=.01}}else if(this.keysDown.indexOf(i)!==-1){if(this._ctrlPressed&&this.camera._useCtrlForPanning){e.inertialPanningY-=1/this.panningSensibility}else if(this._altPressed&&this.useAltToZoom){e.inertialRadiusOffset-=1/this.zoomingSensibility}else{e.inertialBetaOffset+=.01}}else if(this.keysReset.indexOf(i)!==-1){e.restoreState()}}}};t.prototype.getClassName=function(){return"ArcRotateCameraKeyboardMoveInput"};t.prototype.getSimpleName=function(){return"keyboard"};__decorate([e.serialize()],t.prototype,"keysUp",void 0);__decorate([e.serialize()],t.prototype,"keysDown",void 0);__decorate([e.serialize()],t.prototype,"keysLeft",void 0);__decorate([e.serialize()],t.prototype,"keysRight",void 0);__decorate([e.serialize()],t.prototype,"keysReset",void 0);__decorate([e.serialize()],t.prototype,"panningSensibility",void 0);__decorate([e.serialize()],t.prototype,"zoomingSensibility",void 0);__decorate([e.serialize()],t.prototype,"useAltToZoom",void 0);return t}();e.ArcRotateCameraKeyboardMoveInput=t;e.CameraInputTypes["ArcRotateCameraKeyboardMoveInput"]=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this.wheelPrecision=3;this.wheelDeltaPercentage=0}t.prototype.attachControl=function(t,i){var r=this;this._wheel=function(t,n){if(t.type!==e.PointerEventTypes.POINTERWHEEL)return;var o=t.event;var s=0;if(o.wheelDelta){if(r.wheelDeltaPercentage){var a=o.wheelDelta*.01*r.wheelDeltaPercentage*r.camera.radius;if(o.wheelDelta>0){s=a/(1+r.wheelDeltaPercentage)}else{s=a*(1+r.wheelDeltaPercentage)}}else{s=o.wheelDelta/(r.wheelPrecision*40)}}else if(o.detail){s=-o.detail/r.wheelPrecision}if(s)r.camera.inertialRadiusOffset+=s;if(o.preventDefault){if(!i){o.preventDefault()}}};this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,e.PointerEventTypes.POINTERWHEEL)};t.prototype.detachControl=function(e){if(this._observer&&e){this.camera.getScene().onPointerObservable.remove(this._observer);this._observer=null;this._wheel=null}};t.prototype.getClassName=function(){return"ArcRotateCameraMouseWheelInput"};t.prototype.getSimpleName=function(){return"mousewheel"};__decorate([e.serialize()],t.prototype,"wheelPrecision",void 0);__decorate([e.serialize()],t.prototype,"wheelDeltaPercentage",void 0);return t}();e.ArcRotateCameraMouseWheelInput=t;e.CameraInputTypes["ArcRotateCameraMouseWheelInput"]=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this.buttons=[0,1,2];this.angularSensibilityX=1e3;this.angularSensibilityY=1e3;this.pinchPrecision=12;this.pinchDeltaPercentage=0;this.panningSensibility=1e3;this.multiTouchPanning=true;this.multiTouchPanAndZoom=true;this._isPanClick=false;this.pinchInwards=true}t.prototype.attachControl=function(t,i){var r=this;var n=this.camera.getEngine();var o;var s=null;var a=null;var u=0;var l=0;var c=0;var h={x:0,y:0,isPaning:false,isPinching:false};this._pointerInput=function(f,d){var p=f.event;var _=f.event.pointerType==="touch";if(n.isInVRExclusivePointerMode){return}if(f.type!==e.PointerEventTypes.POINTERMOVE&&r.buttons.indexOf(p.button)===-1){return}var m=p.srcElement||p.target;if(f.type===e.PointerEventTypes.POINTERDOWN&&m){try{m.setPointerCapture(p.pointerId)}catch(e){}r._isPanClick=p.button===r.camera._panningMouseButton;o={x:p.clientX,y:p.clientY,pointerId:p.pointerId,type:p.pointerType};if(s===null){s=o}else if(a===null){a=o}if(!i){p.preventDefault();t.focus()}}else if(f.type===e.PointerEventTypes.POINTERDOUBLETAP){r.camera.restoreState()}else if(f.type===e.PointerEventTypes.POINTERUP&&m){try{m.releasePointerCapture(p.pointerId)}catch(e){}o=null;u=0;h.isPaning=false;h.isPinching=false;c=0;l=0;if(!_){a=null}if(n._badOS){s=a=null}else{if(a&&s&&s.pointerId==p.pointerId){s=a;a=null;o={x:s.x,y:s.y,pointerId:s.pointerId,type:p.pointerType}}else if(s&&a&&a.pointerId==p.pointerId){a=null;o={x:s.x,y:s.y,pointerId:s.pointerId,type:p.pointerType}}else{s=a=null}}if(!i){p.preventDefault()}}else if(f.type===e.PointerEventTypes.POINTERMOVE){if(!i){p.preventDefault()}if(s&&a===null&&o){if(r.panningSensibility!==0&&(p.ctrlKey&&r.camera._useCtrlForPanning||r._isPanClick)){r.camera.inertialPanningX+=-(p.clientX-o.x)/r.panningSensibility;r.camera.inertialPanningY+=(p.clientY-o.y)/r.panningSensibility}else{var g=p.clientX-o.x;var v=p.clientY-o.y;r.camera.inertialAlphaOffset-=g/r.angularSensibilityX;r.camera.inertialBetaOffset-=v/r.angularSensibilityY}o.x=p.clientX;o.y=p.clientY}else if(s&&a){var y=s.pointerId===p.pointerId?s:a;y.x=p.clientX;y.y=p.clientY;var b=r.pinchInwards?1:-1;var x=s.x-a.x;var T=s.y-a.y;var E=x*x+T*T;var P=Math.sqrt(E);if(u===0){l=P;u=E;h.x=(s.x+a.x)/2;h.y=(s.y+a.y)/2;return}if(r.multiTouchPanAndZoom){if(r.pinchDeltaPercentage){r.camera.inertialRadiusOffset+=(E-u)*.001*r.camera.radius*r.pinchDeltaPercentage}else{r.camera.inertialRadiusOffset+=(E-u)/(r.pinchPrecision*((r.angularSensibilityX+r.angularSensibilityY)/2)*b)}if(r.panningSensibility!==0){var A=(s.x+a.x)/2;var M=(s.y+a.y)/2;var S=A-h.x;var C=M-h.y;h.x=A;h.y=M;r.camera.inertialPanningX+=-S/r.panningSensibility;r.camera.inertialPanningY+=C/r.panningSensibility}}else{c++;if(h.isPinching||c<20&&Math.abs(P-l)>r.camera.pinchToPanMaxDistance){if(r.pinchDeltaPercentage){r.camera.inertialRadiusOffset+=(E-u)*.001*r.camera.radius*r.pinchDeltaPercentage}else{r.camera.inertialRadiusOffset+=(E-u)/(r.pinchPrecision*((r.angularSensibilityX+r.angularSensibilityY)/2)*b)}h.isPaning=false;h.isPinching=true}else{if(o&&o.pointerId===y.pointerId&&r.panningSensibility!==0&&r.multiTouchPanning){if(!h.isPaning){h.isPaning=true;h.isPinching=false;h.x=y.x;h.y=y.y;return}r.camera.inertialPanningX+=-(y.x-h.x)/r.panningSensibility;r.camera.inertialPanningY+=(y.y-h.y)/r.panningSensibility}}if(o&&o.pointerId===p.pointerId){h.x=y.x;h.y=y.y}}u=E}}};this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,e.PointerEventTypes.POINTERDOWN|e.PointerEventTypes.POINTERUP|e.PointerEventTypes.POINTERMOVE|e.PointerEventTypes._POINTERDOUBLETAP);this._onContextMenu=function(e){e.preventDefault()};if(!this.camera._useCtrlForPanning){t.addEventListener("contextmenu",this._onContextMenu,false)}this._onLostFocus=function(){s=a=null;u=0;h.isPaning=false;h.isPinching=false;c=0;o=null;l=0};this._onMouseMove=function(e){if(!n.isPointerLock){return}var t=e.movementX||e.mozMovementX||e.webkitMovementX||e.msMovementX||0;var o=e.movementY||e.mozMovementY||e.webkitMovementY||e.msMovementY||0;r.camera.inertialAlphaOffset-=t/r.angularSensibilityX;r.camera.inertialBetaOffset-=o/r.angularSensibilityY;if(!i){e.preventDefault()}};this._onGestureStart=function(e){if(window.MSGesture===undefined){return}if(!r._MSGestureHandler){r._MSGestureHandler=new MSGesture;r._MSGestureHandler.target=t}r._MSGestureHandler.addPointer(e.pointerId)};this._onGesture=function(e){r.camera.radius*=e.scale;if(e.preventDefault){if(!i){e.stopPropagation();e.preventDefault()}}};t.addEventListener("mousemove",this._onMouseMove,false);t.addEventListener("MSPointerDown",this._onGestureStart,false);t.addEventListener("MSGestureChange",this._onGesture,false);e.Tools.RegisterTopRootEvents([{name:"blur",handler:this._onLostFocus}])};t.prototype.detachControl=function(t){if(this._onLostFocus){e.Tools.UnregisterTopRootEvents([{name:"blur",handler:this._onLostFocus}])}if(t&&this._observer){this.camera.getScene().onPointerObservable.remove(this._observer);this._observer=null;if(this._onContextMenu){t.removeEventListener("contextmenu",this._onContextMenu)}if(this._onMouseMove){t.removeEventListener("mousemove",this._onMouseMove)}if(this._onGestureStart){t.removeEventListener("MSPointerDown",this._onGestureStart)}if(this._onGesture){t.removeEventListener("MSGestureChange",this._onGesture)}this._isPanClick=false;this.pinchInwards=true;this._onMouseMove=null;this._onGestureStart=null;this._onGesture=null;this._MSGestureHandler=null;this._onLostFocus=null;this._onContextMenu=null}};t.prototype.getClassName=function(){return"ArcRotateCameraPointersInput"};t.prototype.getSimpleName=function(){return"pointers"};__decorate([e.serialize()],t.prototype,"buttons",void 0);__decorate([e.serialize()],t.prototype,"angularSensibilityX",void 0);__decorate([e.serialize()],t.prototype,"angularSensibilityY",void 0);__decorate([e.serialize()],t.prototype,"pinchPrecision",void 0);__decorate([e.serialize()],t.prototype,"pinchDeltaPercentage",void 0);__decorate([e.serialize()],t.prototype,"panningSensibility",void 0);__decorate([e.serialize()],t.prototype,"multiTouchPanning",void 0);__decorate([e.serialize()],t.prototype,"multiTouchPanAndZoom",void 0);return t}();e.ArcRotateCameraPointersInput=t;e.CameraInputTypes["ArcRotateCameraPointersInput"]=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(e){return t.call(this,e)||this}i.prototype.addMouseWheel=function(){this.add(new e.ArcRotateCameraMouseWheelInput);return this};i.prototype.addPointers=function(){this.add(new e.ArcRotateCameraPointersInput);return this};i.prototype.addKeyboard=function(){this.add(new e.ArcRotateCameraKeyboardMoveInput);return this};i.prototype.addGamepad=function(){this.add(new e.ArcRotateCameraGamepadInput);return this};i.prototype.addVRDeviceOrientation=function(){this.add(new e.ArcRotateCameraVRDeviceOrientationInput);return this};return i}(e.CameraInputsManager);e.ArcRotateCameraInputsManager=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a){var u=t.call(this,i,e.Vector3.Zero(),a)||this;u.inertialAlphaOffset=0;u.inertialBetaOffset=0;u.inertialRadiusOffset=0;u.lowerAlphaLimit=null;u.upperAlphaLimit=null;u.lowerBetaLimit=.01;u.upperBetaLimit=Math.PI;u.lowerRadiusLimit=null;u.upperRadiusLimit=null;u.inertialPanningX=0;u.inertialPanningY=0;u.pinchToPanMaxDistance=20;u.panningDistanceLimit=null;u.panningOriginTarget=e.Vector3.Zero();u.panningInertia=.9;u.zoomOnFactor=1;u.targetScreenOffset=e.Vector2.Zero();u.allowUpsideDown=true;u._viewMatrix=new e.Matrix;u.panningAxis=new e.Vector3(1,1,0);u.onMeshTargetChangedObservable=new e.Observable;u.checkCollisions=false;u.collisionRadius=new e.Vector3(.5,.5,.5);u._previousPosition=e.Vector3.Zero();u._collisionVelocity=e.Vector3.Zero();u._newPosition=e.Vector3.Zero();u._computationVector=e.Vector3.Zero();u._onCollisionPositionChange=function(t,i,r){if(r===void 0){r=null}if(u.getScene().workerCollisions&&u.checkCollisions){i.multiplyInPlace(u._collider._radius)}if(!r){u._previousPosition.copyFrom(u.position)}else{u.setPosition(i);if(u.onCollide){u.onCollide(r)}}var n=Math.cos(u.alpha);var o=Math.sin(u.alpha);var s=Math.cos(u.beta);var a=Math.sin(u.beta);if(a===0){a=1e-4}var l=u._getTargetPosition();u._computationVector.copyFromFloats(u.radius*n*a,u.radius*s,u.radius*o*a);l.addToRef(u._computationVector,u._newPosition);u.position.copyFrom(u._newPosition);var c=u.upVector;if(u.allowUpsideDown&&u.beta<0){c=c.clone();c=c.negate()}e.Matrix.LookAtLHToRef(u.position,l,c,u._viewMatrix);u._viewMatrix.m[12]+=u.targetScreenOffset.x;u._viewMatrix.m[13]+=u.targetScreenOffset.y;u._collisionTriggered=false};u._target=e.Vector3.Zero();if(s){u.setTarget(s)}u.alpha=r;u.beta=n;u.radius=o;u.getViewMatrix();u.inputs=new e.ArcRotateCameraInputsManager(u);u.inputs.addKeyboard().addMouseWheel().addPointers();return u}Object.defineProperty(i.prototype,"target",{get:function(){return this._target},set:function(e){this.setTarget(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"angularSensibilityX",{get:function(){var e=this.inputs.attached["pointers"];if(e)return e.angularSensibilityX;return 0},set:function(e){var t=this.inputs.attached["pointers"];if(t){t.angularSensibilityX=e}},
enumerable:true,configurable:true});Object.defineProperty(i.prototype,"angularSensibilityY",{get:function(){var e=this.inputs.attached["pointers"];if(e)return e.angularSensibilityY;return 0},set:function(e){var t=this.inputs.attached["pointers"];if(t){t.angularSensibilityY=e}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"pinchPrecision",{get:function(){var e=this.inputs.attached["pointers"];if(e)return e.pinchPrecision;return 0},set:function(e){var t=this.inputs.attached["pointers"];if(t){t.pinchPrecision=e}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"pinchDeltaPercentage",{get:function(){var e=this.inputs.attached["pointers"];if(e)return e.pinchDeltaPercentage;return 0},set:function(e){var t=this.inputs.attached["pointers"];if(t){t.pinchDeltaPercentage=e}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"panningSensibility",{get:function(){var e=this.inputs.attached["pointers"];if(e)return e.panningSensibility;return 0},set:function(e){var t=this.inputs.attached["pointers"];if(t){t.panningSensibility=e}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"keysUp",{get:function(){var e=this.inputs.attached["keyboard"];if(e)return e.keysUp;return[]},set:function(e){var t=this.inputs.attached["keyboard"];if(t)t.keysUp=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"keysDown",{get:function(){var e=this.inputs.attached["keyboard"];if(e)return e.keysDown;return[]},set:function(e){var t=this.inputs.attached["keyboard"];if(t)t.keysDown=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"keysLeft",{get:function(){var e=this.inputs.attached["keyboard"];if(e)return e.keysLeft;return[]},set:function(e){var t=this.inputs.attached["keyboard"];if(t)t.keysLeft=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"keysRight",{get:function(){var e=this.inputs.attached["keyboard"];if(e)return e.keysRight;return[]},set:function(e){var t=this.inputs.attached["keyboard"];if(t)t.keysRight=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"wheelPrecision",{get:function(){var e=this.inputs.attached["mousewheel"];if(e)return e.wheelPrecision;return 0},set:function(e){var t=this.inputs.attached["mousewheel"];if(t)t.wheelPrecision=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"wheelDeltaPercentage",{get:function(){var e=this.inputs.attached["mousewheel"];if(e)return e.wheelDeltaPercentage;return 0},set:function(e){var t=this.inputs.attached["mousewheel"];if(t)t.wheelDeltaPercentage=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"bouncingBehavior",{get:function(){return this._bouncingBehavior},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"useBouncingBehavior",{get:function(){return this._bouncingBehavior!=null},set:function(t){if(t===this.useBouncingBehavior){return}if(t){this._bouncingBehavior=new e.BouncingBehavior;this.addBehavior(this._bouncingBehavior)}else if(this._bouncingBehavior){this.removeBehavior(this._bouncingBehavior);this._bouncingBehavior=null}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"framingBehavior",{get:function(){return this._framingBehavior},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"useFramingBehavior",{get:function(){return this._framingBehavior!=null},set:function(t){if(t===this.useFramingBehavior){return}if(t){this._framingBehavior=new e.FramingBehavior;this.addBehavior(this._framingBehavior)}else if(this._framingBehavior){this.removeBehavior(this._framingBehavior);this._framingBehavior=null}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"autoRotationBehavior",{get:function(){return this._autoRotationBehavior},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"useAutoRotationBehavior",{get:function(){return this._autoRotationBehavior!=null},set:function(t){if(t===this.useAutoRotationBehavior){return}if(t){this._autoRotationBehavior=new e.AutoRotationBehavior;this.addBehavior(this._autoRotationBehavior)}else if(this._autoRotationBehavior){this.removeBehavior(this._autoRotationBehavior);this._autoRotationBehavior=null}},enumerable:true,configurable:true});i.prototype._initCache=function(){t.prototype._initCache.call(this);this._cache._target=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.alpha=undefined;this._cache.beta=undefined;this._cache.radius=undefined;this._cache.targetScreenOffset=e.Vector2.Zero()};i.prototype._updateCache=function(e){if(!e){t.prototype._updateCache.call(this)}this._cache._target.copyFrom(this._getTargetPosition());this._cache.alpha=this.alpha;this._cache.beta=this.beta;this._cache.radius=this.radius;this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)};i.prototype._getTargetPosition=function(){if(this._targetHost&&this._targetHost.getAbsolutePosition){var e=this._targetHost.getAbsolutePosition();if(this._targetBoundingCenter){e.addToRef(this._targetBoundingCenter,this._target)}else{this._target.copyFrom(e)}}var t=this._getLockedTargetPosition();if(t){return t}return this._target};i.prototype.storeState=function(){this._storedAlpha=this.alpha;this._storedBeta=this.beta;this._storedRadius=this.radius;this._storedTarget=this._getTargetPosition().clone();return t.prototype.storeState.call(this)};i.prototype._restoreStateValues=function(){if(!t.prototype._restoreStateValues.call(this)){return false}this.alpha=this._storedAlpha;this.beta=this._storedBeta;this.radius=this._storedRadius;this.setTarget(this._storedTarget.clone());this.inertialAlphaOffset=0;this.inertialBetaOffset=0;this.inertialRadiusOffset=0;this.inertialPanningX=0;this.inertialPanningY=0;return true};i.prototype._isSynchronizedViewMatrix=function(){if(!t.prototype._isSynchronizedViewMatrix.call(this))return false;return this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset)};i.prototype.attachControl=function(e,t,i,r){var n=this;if(i===void 0){i=true}if(r===void 0){r=2}this._useCtrlForPanning=i;this._panningMouseButton=r;this.inputs.attachElement(e,t);this._reset=function(){n.inertialAlphaOffset=0;n.inertialBetaOffset=0;n.inertialRadiusOffset=0;n.inertialPanningX=0;n.inertialPanningY=0}};i.prototype.detachControl=function(e){this.inputs.detachElement(e);if(this._reset){this._reset()}};i.prototype._checkInputs=function(){if(this._collisionTriggered){return}this.inputs.checkInputs();if(this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){if(this.getScene().useRightHandedSystem){this.alpha-=this.beta<=0?-this.inertialAlphaOffset:this.inertialAlphaOffset}else{this.alpha+=this.beta<=0?-this.inertialAlphaOffset:this.inertialAlphaOffset}this.beta+=this.inertialBetaOffset;this.radius-=this.inertialRadiusOffset;this.inertialAlphaOffset*=this.inertia;this.inertialBetaOffset*=this.inertia;this.inertialRadiusOffset*=this.inertia;if(Math.abs(this.inertialAlphaOffset)<e.Epsilon)this.inertialAlphaOffset=0;if(Math.abs(this.inertialBetaOffset)<e.Epsilon)this.inertialBetaOffset=0;if(Math.abs(this.inertialRadiusOffset)<this.speed*e.Epsilon)this.inertialRadiusOffset=0}if(this.inertialPanningX!==0||this.inertialPanningY!==0){if(!this._localDirection){this._localDirection=e.Vector3.Zero();this._transformedDirection=e.Vector3.Zero()}this._localDirection.copyFromFloats(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);this._localDirection.multiplyInPlace(this.panningAxis);this._viewMatrix.invertToRef(this._cameraTransformMatrix);e.Vector3.TransformNormalToRef(this._localDirection,this._cameraTransformMatrix,this._transformedDirection);if(!this.panningAxis.y){this._transformedDirection.y=0}if(!this._targetHost){if(this.panningDistanceLimit){this._transformedDirection.addInPlace(this._target);var i=e.Vector3.DistanceSquared(this._transformedDirection,this.panningOriginTarget);if(i<=this.panningDistanceLimit*this.panningDistanceLimit){this._target.copyFrom(this._transformedDirection)}}else{this._target.addInPlace(this._transformedDirection)}}this.inertialPanningX*=this.panningInertia;this.inertialPanningY*=this.panningInertia;if(Math.abs(this.inertialPanningX)<this.speed*e.Epsilon)this.inertialPanningX=0;if(Math.abs(this.inertialPanningY)<this.speed*e.Epsilon)this.inertialPanningY=0}this._checkLimits();t.prototype._checkInputs.call(this)};i.prototype._checkLimits=function(){if(this.lowerBetaLimit===null||this.lowerBetaLimit===undefined){if(this.allowUpsideDown&&this.beta>Math.PI){this.beta=this.beta-2*Math.PI}}else{if(this.beta<this.lowerBetaLimit){this.beta=this.lowerBetaLimit}}if(this.upperBetaLimit===null||this.upperBetaLimit===undefined){if(this.allowUpsideDown&&this.beta<-Math.PI){this.beta=this.beta+2*Math.PI}}else{if(this.beta>this.upperBetaLimit){this.beta=this.upperBetaLimit}}if(this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit){this.alpha=this.lowerAlphaLimit}if(this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit){this.alpha=this.upperAlphaLimit}if(this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit){this.radius=this.lowerRadiusLimit}if(this.upperRadiusLimit&&this.radius>this.upperRadiusLimit){this.radius=this.upperRadiusLimit}};i.prototype.rebuildAnglesAndRadius=function(){this.position.subtractToRef(this._getTargetPosition(),this._computationVector);this.radius=this._computationVector.length();if(this.radius===0){this.radius=1e-4}this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2)));if(this._computationVector.z<0){this.alpha=2*Math.PI-this.alpha}this.beta=Math.acos(this._computationVector.y/this.radius);this._checkLimits()};i.prototype.setPosition=function(e){if(this.position.equals(e)){return}this.position.copyFrom(e);this.rebuildAnglesAndRadius()};i.prototype.setTarget=function(e,t,i){if(t===void 0){t=false}if(i===void 0){i=false}if(e.getBoundingInfo){if(t){this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone()}else{this._targetBoundingCenter=null}this._targetHost=e;this._target=this._getTargetPosition();this.onMeshTargetChangedObservable.notifyObservers(this._targetHost)}else{var r=e;var n=this._getTargetPosition();if(n&&!i&&n.equals(r)){return}this._targetHost=null;this._target=r;this._targetBoundingCenter=null;this.onMeshTargetChangedObservable.notifyObservers(null)}this.rebuildAnglesAndRadius()};i.prototype._getViewMatrix=function(){var t=Math.cos(this.alpha);var i=Math.sin(this.alpha);var r=Math.cos(this.beta);var n=Math.sin(this.beta);if(n===0){n=1e-4}var o=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*t*n,this.radius*r,this.radius*i*n);o.addToRef(this._computationVector,this._newPosition);if(this.getScene().collisionsEnabled&&this.checkCollisions){if(!this._collider){this._collider=new e.Collider}this._collider._radius=this.collisionRadius;this._newPosition.subtractToRef(this.position,this._collisionVelocity);this._collisionTriggered=true;this.getScene().collisionCoordinator.getNewPosition(this.position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this.position.copyFrom(this._newPosition);var s=this.upVector;if(this.allowUpsideDown&&n<0){s=s.clone();s=s.negate()}if(this.getScene().useRightHandedSystem){e.Matrix.LookAtRHToRef(this.position,o,s,this._viewMatrix)}else{e.Matrix.LookAtLHToRef(this.position,o,s,this._viewMatrix)}this._viewMatrix.m[12]+=this.targetScreenOffset.x;this._viewMatrix.m[13]+=this.targetScreenOffset.y}this._currentTarget=o;return this._viewMatrix};i.prototype.zoomOn=function(t,i){if(i===void 0){i=false}t=t||this.getScene().meshes;var r=e.Mesh.MinMax(t);var n=e.Vector3.Distance(r.min,r.max);this.radius=n*this.zoomOnFactor;this.focusOn({min:r.min,max:r.max,distance:n},i)};i.prototype.focusOn=function(t,i){if(i===void 0){i=false}var r;var n;if(t.min===undefined){var o=t||this.getScene().meshes;r=e.Mesh.MinMax(o);n=e.Vector3.Distance(r.min,r.max)}else{var s=t;r=s;n=s.distance}this._target=e.Mesh.Center(r);if(!i){this.maxZ=n*2}};i.prototype.createRigCamera=function(t,r){var n=0;switch(this.cameraRigMode){case e.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case e.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case e.Camera.RIG_MODE_VR:n=this._cameraRigParams.stereoHalfAngle*(r===0?1:-1);break;case e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:n=this._cameraRigParams.stereoHalfAngle*(r===0?-1:1);break}var o=new i(t,this.alpha+n,this.beta,this.radius,this._target,this.getScene());o._cameraRigParams={};return o};i.prototype._updateRigCameras=function(){var i=this._rigCameras[0];var r=this._rigCameras[1];i.beta=r.beta=this.beta;i.radius=r.radius=this.radius;switch(this.cameraRigMode){case e.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case e.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case e.Camera.RIG_MODE_VR:i.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;r.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;r.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}t.prototype._updateRigCameras.call(this)};i.prototype.dispose=function(){this.inputs.clear();t.prototype.dispose.call(this)};i.prototype.getClassName=function(){return"ArcRotateCamera"};__decorate([e.serialize()],i.prototype,"alpha",void 0);__decorate([e.serialize()],i.prototype,"beta",void 0);__decorate([e.serialize()],i.prototype,"radius",void 0);__decorate([e.serializeAsVector3("target")],i.prototype,"_target",void 0);__decorate([e.serialize()],i.prototype,"inertialAlphaOffset",void 0);__decorate([e.serialize()],i.prototype,"inertialBetaOffset",void 0);__decorate([e.serialize()],i.prototype,"inertialRadiusOffset",void 0);__decorate([e.serialize()],i.prototype,"lowerAlphaLimit",void 0);__decorate([e.serialize()],i.prototype,"upperAlphaLimit",void 0);__decorate([e.serialize()],i.prototype,"lowerBetaLimit",void 0);__decorate([e.serialize()],i.prototype,"upperBetaLimit",void 0);__decorate([e.serialize()],i.prototype,"lowerRadiusLimit",void 0);__decorate([e.serialize()],i.prototype,"upperRadiusLimit",void 0);__decorate([e.serialize()],i.prototype,"inertialPanningX",void 0);__decorate([e.serialize()],i.prototype,"inertialPanningY",void 0);__decorate([e.serialize()],i.prototype,"pinchToPanMaxDistance",void 0);__decorate([e.serialize()],i.prototype,"panningDistanceLimit",void 0);__decorate([e.serializeAsVector3()],i.prototype,"panningOriginTarget",void 0);__decorate([e.serialize()],i.prototype,"panningInertia",void 0);__decorate([e.serialize()],i.prototype,"zoomOnFactor",void 0);__decorate([e.serialize()],i.prototype,"allowUpsideDown",void 0);return i}(e.TargetCamera);e.ArcRotateCamera=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n){var o=t.call(this,i,n)||this;o.groundColor=new e.Color3(0,0,0);o.direction=r||e.Vector3.Up();return o}i.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4);this._uniformBuffer.addUniform("vLightDiffuse",4);this._uniformBuffer.addUniform("vLightSpecular",3);this._uniformBuffer.addUniform("vLightGround",3);this._uniformBuffer.addUniform("shadowsInfo",3);this._uniformBuffer.addUniform("depthValues",2);this._uniformBuffer.create()};i.prototype.getClassName=function(){return"HemisphericLight"};i.prototype.setDirectionToTarget=function(t){this.direction=e.Vector3.Normalize(t.subtract(e.Vector3.Zero()));return this.direction};i.prototype.getShadowGenerator=function(){return null};i.prototype.transferToEffect=function(t,i){var r=e.Vector3.Normalize(this.direction);this._uniformBuffer.updateFloat4("vLightData",r.x,r.y,r.z,0,i);this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),i);return this};i.prototype._getWorldMatrix=function(){if(!this._worldMatrix){this._worldMatrix=e.Matrix.Identity()}return this._worldMatrix};i.prototype.getTypeID=function(){return e.Light.LIGHTTYPEID_HEMISPHERICLIGHT};__decorate([e.serializeAsColor3()],i.prototype,"groundColor",void 0);__decorate([e.serializeAsVector3()],i.prototype,"direction",void 0);return i}(e.Light);e.HemisphericLight=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(){var e=t!==null&&t.apply(this,arguments)||this;e._needProjectionMatrixCompute=true;return e}i.prototype._setPosition=function(e){this._position=e};Object.defineProperty(i.prototype,"position",{get:function(){return this._position},set:function(e){this._setPosition(e)},enumerable:true,configurable:true});i.prototype._setDirection=function(e){this._direction=e};Object.defineProperty(i.prototype,"direction",{get:function(){return this._direction},set:function(e){this._setDirection(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"shadowMinZ",{get:function(){return this._shadowMinZ},set:function(e){this._shadowMinZ=e;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"shadowMaxZ",{get:function(){return this._shadowMaxZ},set:function(e){this._shadowMaxZ=e;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});i.prototype.computeTransformedInformation=function(){if(this.parent&&this.parent.getWorldMatrix){if(!this.transformedPosition){this.transformedPosition=e.Vector3.Zero()}e.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition);if(this.direction){if(!this.transformedDirection){this.transformedDirection=e.Vector3.Zero()}e.Vector3.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)}return true}return false};i.prototype.getDepthScale=function(){return 50};i.prototype.getShadowDirection=function(e){return this.transformedDirection?this.transformedDirection:this.direction};i.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position};i.prototype.setDirectionToTarget=function(t){this.direction=e.Vector3.Normalize(t.subtract(this.position));return this.direction};i.prototype.getRotation=function(){this.direction.normalize();var t=e.Vector3.Cross(this.direction,e.Axis.Y);var i=e.Vector3.Cross(t,this.direction);return e.Vector3.RotationFromAxis(t,i,this.direction)};i.prototype.needCube=function(){return false};i.prototype.needProjectionMatrixCompute=function(){return this._needProjectionMatrixCompute};i.prototype.forceProjectionMatrixCompute=function(){this._needProjectionMatrixCompute=true};i.prototype._getWorldMatrix=function(){if(!this._worldMatrix){this._worldMatrix=e.Matrix.Identity()}e.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix);return this._worldMatrix};i.prototype.getDepthMinZ=function(e){return this.shadowMinZ!==undefined?this.shadowMinZ:e.minZ};i.prototype.getDepthMaxZ=function(e){return this.shadowMaxZ!==undefined?this.shadowMaxZ:e.maxZ};i.prototype.setShadowProjectionMatrix=function(e,t,i){if(this.customProjectionMatrixBuilder){this.customProjectionMatrixBuilder(t,i,e)}else{this._setDefaultShadowProjectionMatrix(e,t,i)}return this};__decorate([e.serializeAsVector3()],i.prototype,"position",null);__decorate([e.serializeAsVector3()],i.prototype,"direction",null);__decorate([e.serialize()],i.prototype,"shadowMinZ",null);__decorate([e.serialize()],i.prototype,"shadowMaxZ",null);return i}(e.Light);e.ShadowLight=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(e,i,r){var n=t.call(this,e,r)||this;n._shadowAngle=Math.PI/2;n.position=i;return n}Object.defineProperty(i.prototype,"shadowAngle",{get:function(){return this._shadowAngle},set:function(e){this._shadowAngle=e;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"direction",{get:function(){return this._direction},set:function(e){var t=this.needCube();this._direction=e;if(this.needCube()!==t&&this._shadowGenerator){this._shadowGenerator.recreateShadowMap()}},enumerable:true,configurable:true});i.prototype.getClassName=function(){return"PointLight"};i.prototype.getTypeID=function(){return e.Light.LIGHTTYPEID_POINTLIGHT};i.prototype.needCube=function(){return!this.direction};i.prototype.getShadowDirection=function(i){if(this.direction){return t.prototype.getShadowDirection.call(this,i)}else{switch(i){case 0:return new e.Vector3(1,0,0);case 1:return new e.Vector3(-1,0,0);case 2:return new e.Vector3(0,-1,0);case 3:return new e.Vector3(0,1,0);case 4:return new e.Vector3(0,0,1);case 5:return new e.Vector3(0,0,-1)}}return e.Vector3.Zero()};i.prototype._setDefaultShadowProjectionMatrix=function(t,i,r){var n=this.getScene().activeCamera;if(!n){return}e.Matrix.PerspectiveFovLHToRef(this.shadowAngle,1,this.getDepthMinZ(n),this.getDepthMaxZ(n),t)};i.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4);this._uniformBuffer.addUniform("vLightDiffuse",4);this._uniformBuffer.addUniform("vLightSpecular",3);this._uniformBuffer.addUniform("shadowsInfo",3);this._uniformBuffer.addUniform("depthValues",2);this._uniformBuffer.create()};i.prototype.transferToEffect=function(e,t){if(this.computeTransformedInformation()){this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t);return this}this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t);return this};__decorate([e.serialize()],i.prototype,"shadowAngle",null);return i}(e.ShadowLight);e.PointLight=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(e,i,r){var n=t.call(this,e,r)||this;n._shadowFrustumSize=0;n._shadowOrthoScale=.1;n.autoUpdateExtends=true;n._orthoLeft=Number.MAX_VALUE;n._orthoRight=Number.MIN_VALUE;n._orthoTop=Number.MIN_VALUE;n._orthoBottom=Number.MAX_VALUE;n.position=i.scale(-1);n.direction=i;return n}Object.defineProperty(i.prototype,"shadowFrustumSize",{get:function(){return this._shadowFrustumSize},set:function(e){this._shadowFrustumSize=e;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"shadowOrthoScale",{get:function(){return this._shadowOrthoScale},set:function(e){this._shadowOrthoScale=e;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});i.prototype.getClassName=function(){return"DirectionalLight"};i.prototype.getTypeID=function(){return e.Light.LIGHTTYPEID_DIRECTIONALLIGHT};i.prototype._setDefaultShadowProjectionMatrix=function(e,t,i){if(this.shadowFrustumSize>0){this._setDefaultFixedFrustumShadowProjectionMatrix(e,t)}else{this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}};i.prototype._setDefaultFixedFrustumShadowProjectionMatrix=function(t,i){var r=this.getScene().activeCamera;if(!r){return}e.Matrix.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==undefined?this.shadowMinZ:r.minZ,this.shadowMaxZ!==undefined?this.shadowMaxZ:r.maxZ,t)};i.prototype._setDefaultAutoExtendShadowProjectionMatrix=function(t,i,r){var n=this.getScene().activeCamera;if(!n){return}if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){var o=e.Vector3.Zero();this._orthoLeft=Number.MAX_VALUE;this._orthoRight=Number.MIN_VALUE;this._orthoTop=Number.MIN_VALUE;this._orthoBottom=Number.MAX_VALUE;for(var s=0;s<r.length;s++){var a=r[s];if(!a){continue}var u=a.getBoundingInfo();var l=u.boundingBox;for(var c=0;c<l.vectorsWorld.length;c++){e.Vector3.TransformCoordinatesToRef(l.vectorsWorld[c],i,o);if(o.x<this._orthoLeft)this._orthoLeft=o.x;if(o.y<this._orthoBottom)this._orthoBottom=o.y;if(o.x>this._orthoRight)this._orthoRight=o.x;if(o.y>this._orthoTop)this._orthoTop=o.y}}}var h=this._orthoRight-this._orthoLeft;var f=this._orthoTop-this._orthoBottom;e.Matrix.OrthoOffCenterLHToRef(this._orthoLeft-h*this.shadowOrthoScale,this._orthoRight+h*this.shadowOrthoScale,this._orthoBottom-f*this.shadowOrthoScale,this._orthoTop+f*this.shadowOrthoScale,this.shadowMinZ!==undefined?this.shadowMinZ:n.minZ,this.shadowMaxZ!==undefined?this.shadowMaxZ:n.maxZ,t)};i.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4);this._uniformBuffer.addUniform("vLightDiffuse",4);this._uniformBuffer.addUniform("vLightSpecular",3);this._uniformBuffer.addUniform("shadowsInfo",3);this._uniformBuffer.addUniform("depthValues",2);this._uniformBuffer.create()};i.prototype.transferToEffect=function(e,t){if(this.computeTransformedInformation()){this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t);return this}this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t);return this};i.prototype.getDepthMinZ=function(e){return 1};i.prototype.getDepthMaxZ=function(e){return 1};__decorate([e.serialize()],i.prototype,"shadowFrustumSize",null);__decorate([e.serialize()],i.prototype,"shadowOrthoScale",null);__decorate([e.serialize()],i.prototype,"autoUpdateExtends",void 0);return i}(e.ShadowLight);e.DirectionalLight=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a){var u=t.call(this,i,a)||this;u._projectionTextureMatrix=e.Matrix.Zero();u._projectionTextureLightNear=1e-6;u._projectionTextureLightFar=1e3;u._projectionTextureUpDirection=e.Vector3.Up();u._projectionTextureViewLightDirty=true;u._projectionTextureProjectionLightDirty=true;u._projectionTextureDirty=true;u._projectionTextureViewTargetVector=e.Vector3.Zero();u._projectionTextureViewLightMatrix=e.Matrix.Zero();u._projectionTextureProjectionLightMatrix=e.Matrix.Zero();u._projectionTextureScalingMatrix=e.Matrix.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1);u.position=r;u.direction=n;u.angle=o;u.exponent=s;return u}Object.defineProperty(i.prototype,"angle",{get:function(){return this._angle},set:function(e){this._angle=e;this._projectionTextureProjectionLightDirty=true;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"shadowAngleScale",{get:function(){return this._shadowAngleScale},set:function(e){this._shadowAngleScale=e;this.forceProjectionMatrixCompute()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"projectionTextureMatrix",{get:function(){return this._projectionTextureMatrix},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"projectionTextureLightNear",{get:function(){return this._projectionTextureLightNear},set:function(e){this._projectionTextureLightNear=e;this._projectionTextureProjectionLightDirty=true},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"projectionTextureLightFar",{get:function(){return this._projectionTextureLightFar},set:function(e){this._projectionTextureLightFar=e;this._projectionTextureProjectionLightDirty=true},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"projectionTextureUpDirection",{get:function(){return this._projectionTextureUpDirection},set:function(e){this._projectionTextureUpDirection=e;this._projectionTextureProjectionLightDirty=true},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"projectionTexture",{get:function(){return this._projectionTexture},set:function(e){this._projectionTexture=e;this._projectionTextureDirty=true},enumerable:true,configurable:true});i.prototype.getClassName=function(){return"SpotLight"};i.prototype.getTypeID=function(){return e.Light.LIGHTTYPEID_SPOTLIGHT};i.prototype._setDirection=function(e){t.prototype._setDirection.call(this,e);this._projectionTextureViewLightDirty=true};i.prototype._setPosition=function(e){t.prototype._setPosition.call(this,e);this._projectionTextureViewLightDirty=true};i.prototype._setDefaultShadowProjectionMatrix=function(t,i,r){var n=this.getScene().activeCamera;if(!n){return}this._shadowAngleScale=this._shadowAngleScale||1;var o=this._shadowAngleScale*this._angle;e.Matrix.PerspectiveFovLHToRef(o,1,this.getDepthMinZ(n),this.getDepthMaxZ(n),t)};i.prototype._computeProjectionTextureViewLightMatrix=function(){this._projectionTextureViewLightDirty=false;this._projectionTextureDirty=true;this.position.addToRef(this.direction,this._projectionTextureViewTargetVector);e.Matrix.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)};i.prototype._computeProjectionTextureProjectionLightMatrix=function(){this._projectionTextureProjectionLightDirty=false;this._projectionTextureDirty=true;var t=this.projectionTextureLightFar;var i=this.projectionTextureLightNear;var r=t/(t-i);var n=-r*i;var o=1/Math.tan(this._angle/2);var s=1;e.Matrix.FromValuesToRef(o/s,0,0,0,0,o,0,0,0,0,r,1,0,0,n,0,this._projectionTextureProjectionLightMatrix)};i.prototype._computeProjectionTextureMatrix=function(){this._projectionTextureDirty=false;this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix);this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)};i.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4);this._uniformBuffer.addUniform("vLightDiffuse",4);this._uniformBuffer.addUniform("vLightSpecular",3);this._uniformBuffer.addUniform("vLightDirection",3);this._uniformBuffer.addUniform("shadowsInfo",3);this._uniformBuffer.addUniform("depthValues",2);this._uniformBuffer.create()};i.prototype.transferToEffect=function(t,i){var r;if(this.computeTransformedInformation()){this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,i);r=e.Vector3.Normalize(this.transformedDirection)}else{this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,i);r=e.Vector3.Normalize(this.direction)}this._uniformBuffer.updateFloat4("vLightDirection",r.x,r.y,r.z,Math.cos(this.angle*.5),i);if(this.projectionTexture&&this.projectionTexture.isReady()){if(this._projectionTextureViewLightDirty){this._computeProjectionTextureViewLightMatrix()}if(this._projectionTextureProjectionLightDirty){this._computeProjectionTextureProjectionLightMatrix()}if(this._projectionTextureDirty){this._computeProjectionTextureMatrix()}t.setMatrix("textureProjectionMatrix"+i,this._projectionTextureMatrix);t.setTexture("projectionLightSampler"+i,this.projectionTexture)}return this};i.prototype.dispose=function(){t.prototype.dispose.call(this);if(this._projectionTexture){this._projectionTexture.dispose()}};__decorate([e.serialize()],i.prototype,"angle",null);__decorate([e.serialize()],i.prototype,"shadowAngleScale",null);__decorate([e.serialize()],i.prototype,"exponent",void 0);__decorate([e.serialize()],i.prototype,"projectionTextureLightNear",null);__decorate([e.serialize()],i.prototype,"projectionTextureLightFar",null);__decorate([e.serialize()],i.prototype,"projectionTextureUpDirection",null);__decorate([e.serializeAsTexture("projectedLightTexture")],i.prototype,"_projectionTexture",void 0);return i}(e.ShadowLight);e.SpotLight=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this.enableBlending=false;this.blendingSpeed=.01;this.loopMode=e.Animation.ANIMATIONLOOPMODE_CYCLE}return t}();e.AnimationPropertiesOverride=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e,t,i){this.name=e;this.from=t;this.to=i}e.prototype.clone=function(){return new e(this.name,this.from,this.to)};return e}();e.AnimationRange=t;var i=function(){function e(e,t,i){this.frame=e
;this.action=t;this.onlyOnce=i;this.isDone=false}return e}();e.AnimationEvent=i;var r=function(){function t(e){this.path=e;this._onchange=new Array;this.value=0;this.animations=new Array}t.prototype.getPoint=function(){var t=this.path.getPointAtLengthPosition(this.value);return new e.Vector3(t.x,0,t.y)};t.prototype.moveAhead=function(e){if(e===void 0){e=.002}this.move(e);return this};t.prototype.moveBack=function(e){if(e===void 0){e=.002}this.move(-e);return this};t.prototype.move=function(e){if(Math.abs(e)>1){throw"step size should be less than 1."}this.value+=e;this.ensureLimits();this.raiseOnChange();return this};t.prototype.ensureLimits=function(){while(this.value>1){this.value-=1}while(this.value<0){this.value+=1}return this};t.prototype.raiseOnChange=function(){var e=this;this._onchange.forEach(function(t){return t(e)});return this};t.prototype.onchange=function(e){this._onchange.push(e);return this};return t}();e.PathCursor=r;var n;(function(e){e[e["STEP"]=1]="STEP"})(n=e.AnimationKeyInterpolation||(e.AnimationKeyInterpolation={}));var o=function(){function i(e,t,r,n,o,s){this.name=e;this.targetProperty=t;this.framePerSecond=r;this.dataType=n;this.loopMode=o;this.enableBlending=s;this._runtimeAnimations=new Array;this._events=new Array;this.blendingSpeed=.01;this._ranges={};this.targetPropertyPath=t.split(".");this.dataType=n;this.loopMode=o===undefined?i.ANIMATIONLOOPMODE_CYCLE:o}i._PrepareAnimation=function(t,r,n,o,s,a,u,l){var c=undefined;if(!isNaN(parseFloat(s))&&isFinite(s)){c=i.ANIMATIONTYPE_FLOAT}else if(s instanceof e.Quaternion){c=i.ANIMATIONTYPE_QUATERNION}else if(s instanceof e.Vector3){c=i.ANIMATIONTYPE_VECTOR3}else if(s instanceof e.Vector2){c=i.ANIMATIONTYPE_VECTOR2}else if(s instanceof e.Color3){c=i.ANIMATIONTYPE_COLOR3}else if(s instanceof e.Size){c=i.ANIMATIONTYPE_SIZE}if(c==undefined){return null}var h=new i(t,r,n,c,u);var f=[{frame:0,value:s},{frame:o,value:a}];h.setKeys(f);if(l!==undefined){h.setEasingFunction(l)}return h};i.CreateAnimation=function(e,t,r,n){var o=new i(e+"Animation",e,r,t,i.ANIMATIONLOOPMODE_CONSTANT);o.setEasingFunction(n);return o};i.CreateAndStartAnimation=function(e,t,r,n,o,s,a,u,l,c){var h=i._PrepareAnimation(e,r,n,o,s,a,u,l);if(!h){return null}return t.getScene().beginDirectAnimation(t,[h],0,o,h.loopMode===1,1,c)};i.CreateAndStartHierarchyAnimation=function(e,t,r,n,o,s,a,u,l,c,h){var f=i._PrepareAnimation(e,n,o,s,a,u,l,c);if(!f){return null}var d=t.getScene();return d.beginDirectHierarchyAnimation(t,r,[f],0,s,f.loopMode===1,1,h)};i.CreateMergeAndStartAnimation=function(e,t,r,n,o,s,a,u,l,c){var h=i._PrepareAnimation(e,r,n,o,s,a,u,l);if(!h){return null}t.animations.push(h);return t.getScene().beginAnimation(t,0,o,h.loopMode===1,1,c)};i.TransitionTo=function(e,t,i,r,n,o,s,a){if(a===void 0){a=null}if(s<=0){i[e]=t;if(a){a()}return null}var u=n*(s/1e3);o.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:u,value:t}]);if(!i.animations){i.animations=[]}i.animations.push(o);var l=r.beginAnimation(i,0,u,false);l.onAnimationEnd=a;return l};Object.defineProperty(i.prototype,"runtimeAnimations",{get:function(){return this._runtimeAnimations},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"hasRunningRuntimeAnimations",{get:function(){for(var e=0,t=this._runtimeAnimations;e<t.length;e++){var i=t[e];if(!i.isStopped){return true}}return false},enumerable:true,configurable:true});i.prototype.toString=function(e){var t="Name: "+this.name+", property: "+this.targetProperty;t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType];t+=", nKeys: "+(this._keys?this._keys.length:"none");t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none");if(e){t+=", Ranges: {";var i=true;for(var r in this._ranges){if(i){t+=", ";i=false}t+=r}t+="}"}return t};i.prototype.addEvent=function(e){this._events.push(e)};i.prototype.removeEvents=function(e){for(var t=0;t<this._events.length;t++){if(this._events[t].frame===e){this._events.splice(t,1);t--}}};i.prototype.getEvents=function(){return this._events};i.prototype.createRange=function(e,i,r){if(!this._ranges[e]){this._ranges[e]=new t(e,i,r)}};i.prototype.deleteRange=function(e,t){if(t===void 0){t=true}var i=this._ranges[e];if(!i){return}if(t){var r=i.from;var n=i.to;for(var o=this._keys.length-1;o>=0;o--){if(this._keys[o].frame>=r&&this._keys[o].frame<=n){this._keys.splice(o,1)}}}this._ranges[e]=null};i.prototype.getRange=function(e){return this._ranges[e]};i.prototype.getKeys=function(){return this._keys};i.prototype.getHighestFrame=function(){var e=0;for(var t=0,i=this._keys.length;t<i;t++){if(e<this._keys[t].frame){e=this._keys[t].frame}}return e};i.prototype.getEasingFunction=function(){return this._easingFunction};i.prototype.setEasingFunction=function(e){this._easingFunction=e};i.prototype.floatInterpolateFunction=function(t,i,r){return e.Scalar.Lerp(t,i,r)};i.prototype.floatInterpolateFunctionWithTangents=function(t,i,r,n,o){return e.Scalar.Hermite(t,i,r,n,o)};i.prototype.quaternionInterpolateFunction=function(t,i,r){return e.Quaternion.Slerp(t,i,r)};i.prototype.quaternionInterpolateFunctionWithTangents=function(t,i,r,n,o){return e.Quaternion.Hermite(t,i,r,n,o).normalize()};i.prototype.vector3InterpolateFunction=function(t,i,r){return e.Vector3.Lerp(t,i,r)};i.prototype.vector3InterpolateFunctionWithTangents=function(t,i,r,n,o){return e.Vector3.Hermite(t,i,r,n,o)};i.prototype.vector2InterpolateFunction=function(t,i,r){return e.Vector2.Lerp(t,i,r)};i.prototype.vector2InterpolateFunctionWithTangents=function(t,i,r,n,o){return e.Vector2.Hermite(t,i,r,n,o)};i.prototype.sizeInterpolateFunction=function(t,i,r){return e.Size.Lerp(t,i,r)};i.prototype.color3InterpolateFunction=function(t,i,r){return e.Color3.Lerp(t,i,r)};i.prototype.matrixInterpolateFunction=function(t,i,r){return e.Matrix.Lerp(t,i,r)};i.prototype.clone=function(){var e=new i(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);e.enableBlending=this.enableBlending;e.blendingSpeed=this.blendingSpeed;if(this._keys){e.setKeys(this._keys)}if(this._ranges){e._ranges={};for(var t in this._ranges){var r=this._ranges[t];if(!r){continue}e._ranges[t]=r.clone()}}return e};i.prototype.setKeys=function(e){this._keys=e.slice(0)};i.prototype.serialize=function(){var e={};e.name=this.name;e.property=this.targetProperty;e.framePerSecond=this.framePerSecond;e.dataType=this.dataType;e.loopBehavior=this.loopMode;e.enableBlending=this.enableBlending;e.blendingSpeed=this.blendingSpeed;var t=this.dataType;e.keys=[];var r=this.getKeys();for(var n=0;n<r.length;n++){var o=r[n];var s={};s.frame=o.frame;switch(t){case i.ANIMATIONTYPE_FLOAT:s.values=[o.value];break;case i.ANIMATIONTYPE_QUATERNION:case i.ANIMATIONTYPE_MATRIX:case i.ANIMATIONTYPE_VECTOR3:case i.ANIMATIONTYPE_COLOR3:s.values=o.value.asArray();break}e.keys.push(s)}e.ranges=[];for(var a in this._ranges){var u=this._ranges[a];if(!u){continue}var l={};l.name=a;l.from=u.from;l.to=u.to;e.ranges.push(l)}return e};Object.defineProperty(i,"ANIMATIONTYPE_FLOAT",{get:function(){return i._ANIMATIONTYPE_FLOAT},enumerable:true,configurable:true});Object.defineProperty(i,"ANIMATIONTYPE_VECTOR3",{get:function(){return i._ANIMATIONTYPE_VECTOR3},enumerable:true,configurable:true});Object.defineProperty(i,"ANIMATIONTYPE_VECTOR2",{get:function(){return i._ANIMATIONTYPE_VECTOR2},enumerable:true,configurable:true});Object.defineProperty(i,"ANIMATIONTYPE_SIZE",{get:function(){return i._ANIMATIONTYPE_SIZE},enumerable:true,configurable:true});Object.defineProperty(i,"ANIMATIONTYPE_QUATERNION",{get:function(){return i._ANIMATIONTYPE_QUATERNION},enumerable:true,configurable:true});Object.defineProperty(i,"ANIMATIONTYPE_MATRIX",{get:function(){return i._ANIMATIONTYPE_MATRIX},enumerable:true,configurable:true});Object.defineProperty(i,"ANIMATIONTYPE_COLOR3",{get:function(){return i._ANIMATIONTYPE_COLOR3},enumerable:true,configurable:true});Object.defineProperty(i,"ANIMATIONLOOPMODE_RELATIVE",{get:function(){return i._ANIMATIONLOOPMODE_RELATIVE},enumerable:true,configurable:true});Object.defineProperty(i,"ANIMATIONLOOPMODE_CYCLE",{get:function(){return i._ANIMATIONLOOPMODE_CYCLE},enumerable:true,configurable:true});Object.defineProperty(i,"ANIMATIONLOOPMODE_CONSTANT",{get:function(){return i._ANIMATIONLOOPMODE_CONSTANT},enumerable:true,configurable:true});i.Parse=function(t){var r=new i(t.name,t.property,t.framePerSecond,t.dataType,t.loopBehavior);var n=t.dataType;var o=[];var s;var a;if(t.enableBlending){r.enableBlending=t.enableBlending}if(t.blendingSpeed){r.blendingSpeed=t.blendingSpeed}for(a=0;a<t.keys.length;a++){var u=t.keys[a];var l;var c;switch(n){case i.ANIMATIONTYPE_FLOAT:s=u.values[0];if(u.values.length>=1){l=u.values[1]}if(u.values.length>=2){c=u.values[2]}break;case i.ANIMATIONTYPE_QUATERNION:s=e.Quaternion.FromArray(u.values);if(u.values.length>=8){var h=e.Quaternion.FromArray(u.values.slice(4,8));if(!h.equals(e.Quaternion.Zero())){l=h}}if(u.values.length>=12){var f=e.Quaternion.FromArray(u.values.slice(8,12));if(!f.equals(e.Quaternion.Zero())){c=f}}break;case i.ANIMATIONTYPE_MATRIX:s=e.Matrix.FromArray(u.values);break;case i.ANIMATIONTYPE_COLOR3:s=e.Color3.FromArray(u.values);break;case i.ANIMATIONTYPE_VECTOR3:default:s=e.Vector3.FromArray(u.values);break}var d={};d.frame=u.frame;d.value=s;if(l!=undefined){d.inTangent=l}if(c!=undefined){d.outTangent=c}o.push(d)}r.setKeys(o);if(t.ranges){for(a=0;a<t.ranges.length;a++){s=t.ranges[a];r.createRange(s.name,s.from,s.to)}}return r};i.AppendSerializedAnimations=function(e,t){if(e.animations){t.animations=[];for(var i=0;i<e.animations.length;i++){var r=e.animations[i];t.animations.push(r.serialize())}}};i.AllowMatricesInterpolation=false;i._ANIMATIONTYPE_FLOAT=0;i._ANIMATIONTYPE_VECTOR3=1;i._ANIMATIONTYPE_QUATERNION=2;i._ANIMATIONTYPE_MATRIX=3;i._ANIMATIONTYPE_COLOR3=4;i._ANIMATIONTYPE_VECTOR2=5;i._ANIMATIONTYPE_SIZE=6;i._ANIMATIONLOOPMODE_RELATIVE=0;i._ANIMATIONLOOPMODE_CYCLE=1;i._ANIMATIONLOOPMODE_CONSTANT=2;return i}();e.Animation=o})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){}return e}();e.TargetedAnimation=t;var i=function(){function t(t,i){if(i===void 0){i=null}this.name=t;this._targetedAnimations=new Array;this._animatables=new Array;this._from=Number.MAX_VALUE;this._to=-Number.MAX_VALUE;this._speedRatio=1;this.onAnimationEndObservable=new e.Observable;this._scene=i||e.Engine.LastCreatedScene;this._scene.animationGroups.push(this)}Object.defineProperty(t.prototype,"isStarted",{get:function(){return this._isStarted},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"speedRatio",{get:function(){return this._speedRatio},set:function(e){if(this._speedRatio===e){return}this._speedRatio=e;for(var t=0;t<this._animatables.length;t++){var i=this._animatables[t];i.speedRatio=this._speedRatio}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"targetedAnimations",{get:function(){return this._targetedAnimations},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"animatables",{get:function(){return this._animatables},enumerable:true,configurable:true});t.prototype.addTargetedAnimation=function(e,t){var i={animation:e,target:t};var r=e.getKeys();if(this._from>r[0].frame){this._from=r[0].frame}if(this._to<r[r.length-1].frame){this._to=r[r.length-1].frame}this._targetedAnimations.push(i);return i};t.prototype.normalize=function(e,t){if(e===void 0){e=-Number.MAX_VALUE}if(t===void 0){t=Number.MAX_VALUE}e=Math.max(e,this._from);t=Math.min(t,this._to);for(var i=0;i<this._targetedAnimations.length;i++){var r=this._targetedAnimations[i];var n=r.animation.getKeys();var o=n[0];var s=n[n.length-1];if(o.frame>e){var a={frame:e,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation};n.splice(0,0,a)}if(s.frame<t){var a={frame:t,value:s.value,inTangent:s.outTangent,outTangent:s.outTangent,interpolation:s.interpolation};n.push(a)}}return this};t.prototype.start=function(e,t,i,r){var n=this;if(e===void 0){e=false}if(t===void 0){t=1}if(this._isStarted||this._targetedAnimations.length===0){return this}var o=function(){var o=s._targetedAnimations[a];if(!o.target.animations){o.target.animations=[]}if(o.target.animations.indexOf(o.animation)===-1){o.target.animations.push(o.animation)}s._animatables.push(s._scene.beginDirectAnimation(o.target,[o.animation],i!==undefined?i:s._from,r!==undefined?r:s._to,e,t,function(){n.onAnimationEndObservable.notifyObservers(o)}))};var s=this;for(var a=0;a<this._targetedAnimations.length;a++){o()}this._speedRatio=t;this._isStarted=true;return this};t.prototype.pause=function(){if(!this._isStarted){return this}for(var e=0;e<this._animatables.length;e++){var t=this._animatables[e];t.pause()}return this};t.prototype.play=function(e){if(this.isStarted){if(e!==undefined){for(var t=0;t<this._animatables.length;t++){var i=this._animatables[t];i.loopAnimation=e}}this.restart()}else{this.start(e,this._speedRatio)}return this};t.prototype.reset=function(){if(!this._isStarted){return this}for(var e=0;e<this._animatables.length;e++){var t=this._animatables[e];t.reset()}return this};t.prototype.restart=function(){if(!this._isStarted){return this}for(var e=0;e<this._animatables.length;e++){var t=this._animatables[e];t.restart()}return this};t.prototype.stop=function(){if(!this._isStarted){return this}for(var e=0;e<this._animatables.length;e++){var t=this._animatables[e];t.stop()}this._isStarted=false;return this};t.prototype.goToFrame=function(e){if(!this._isStarted){return this}for(var t=0;t<this._animatables.length;t++){var i=this._animatables[t];i.goToFrame(e)}return this};t.prototype.dispose=function(){this._targetedAnimations=[];this._animatables=[];var e=this._scene.animationGroups.indexOf(this);if(e>-1){this._scene.animationGroups.splice(e,1)}};return t}();e.AnimationGroup=i})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,t,i,r){this._currentFrame=0;this._offsetsCache={};this._highLimitsCache={};this._stopped=false;this._blendingFactor=0;this._targetPath="";this._weight=1;this._ratioOffset=0;this._previousDelay=0;this._previousRatio=0;this._animation=t;this._target=e;this._scene=i;this._host=r;t._runtimeAnimations.push(this)}Object.defineProperty(t.prototype,"currentFrame",{get:function(){return this._currentFrame},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"weight",{get:function(){return this._weight},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"originalValue",{get:function(){return this._originalValue},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"currentValue",{get:function(){return this._currentValue},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"targetPath",{get:function(){return this._targetPath},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"target",{get:function(){return this._activeTarget},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"animation",{get:function(){return this._animation},enumerable:true,configurable:true});t.prototype.reset=function(){this._offsetsCache={};this._highLimitsCache={};this._currentFrame=0;this._blendingFactor=0;this._originalValue=null};t.prototype.isStopped=function(){return this._stopped};t.prototype.dispose=function(){var e=this._animation.runtimeAnimations.indexOf(this);if(e>-1){this._animation.runtimeAnimations.splice(e,1)}};t.prototype._getKeyValue=function(e){if(typeof e==="function"){return e()}return e};t.prototype._interpolate=function(t,i,r,n,o){if(r===e.Animation.ANIMATIONLOOPMODE_CONSTANT&&i>0){return o.clone?o.clone():o}this._currentFrame=t;var s=this._animation.getKeys();var a=Math.max(0,Math.min(s.length-1,Math.floor(s.length*(t-s[0].frame)/(s[s.length-1].frame-s[0].frame))-1));if(s[a].frame>=t){while(a-1>=0&&s[a].frame>=t){a--}}for(var u=a;u<s.length;u++){var l=s[u+1];if(l.frame>=t){var c=s[u];var h=this._getKeyValue(c.value);if(c.interpolation===e.AnimationKeyInterpolation.STEP){return h}var f=this._getKeyValue(l.value);var d=c.outTangent!==undefined&&l.inTangent!==undefined;var p=l.frame-c.frame;var _=(t-c.frame)/p;var m=this._animation.getEasingFunction();if(m!=null){_=m.ease(_)}switch(this._animation.dataType){case e.Animation.ANIMATIONTYPE_FLOAT:var g=d?this._animation.floatInterpolateFunctionWithTangents(h,c.outTangent*p,f,l.inTangent*p,_):this._animation.floatInterpolateFunction(h,f,_);switch(r){case e.Animation.ANIMATIONLOOPMODE_CYCLE:case e.Animation.ANIMATIONLOOPMODE_CONSTANT:return g;case e.Animation.ANIMATIONLOOPMODE_RELATIVE:return n*i+g}break;case e.Animation.ANIMATIONTYPE_QUATERNION:var v=d?this._animation.quaternionInterpolateFunctionWithTangents(h,c.outTangent.scale(p),f,l.inTangent.scale(p),_):this._animation.quaternionInterpolateFunction(h,f,_);switch(r){case e.Animation.ANIMATIONLOOPMODE_CYCLE:case e.Animation.ANIMATIONLOOPMODE_CONSTANT:return v;case e.Animation.ANIMATIONLOOPMODE_RELATIVE:return v.add(n.scale(i))}return v;case e.Animation.ANIMATIONTYPE_VECTOR3:var y=d?this._animation.vector3InterpolateFunctionWithTangents(h,c.outTangent.scale(p),f,l.inTangent.scale(p),_):this._animation.vector3InterpolateFunction(h,f,_);switch(r){case e.Animation.ANIMATIONLOOPMODE_CYCLE:case e.Animation.ANIMATIONLOOPMODE_CONSTANT:return y;case e.Animation.ANIMATIONLOOPMODE_RELATIVE:return y.add(n.scale(i))}case e.Animation.ANIMATIONTYPE_VECTOR2:var b=d?this._animation.vector2InterpolateFunctionWithTangents(h,c.outTangent.scale(p),f,l.inTangent.scale(p),_):this._animation.vector2InterpolateFunction(h,f,_);switch(r){case e.Animation.ANIMATIONLOOPMODE_CYCLE:case e.Animation.ANIMATIONLOOPMODE_CONSTANT:return b;case e.Animation.ANIMATIONLOOPMODE_RELATIVE:return b.add(n.scale(i))}case e.Animation.ANIMATIONTYPE_SIZE:switch(r){case e.Animation.ANIMATIONLOOPMODE_CYCLE:case e.Animation.ANIMATIONLOOPMODE_CONSTANT:return this._animation.sizeInterpolateFunction(h,f,_);case e.Animation.ANIMATIONLOOPMODE_RELATIVE:return this._animation.sizeInterpolateFunction(h,f,_).add(n.scale(i))}case e.Animation.ANIMATIONTYPE_COLOR3:switch(r){case e.Animation.ANIMATIONLOOPMODE_CYCLE:case e.Animation.ANIMATIONLOOPMODE_CONSTANT:return this._animation.color3InterpolateFunction(h,f,_);case e.Animation.ANIMATIONLOOPMODE_RELATIVE:return this._animation.color3InterpolateFunction(h,f,_).add(n.scale(i))}case e.Animation.ANIMATIONTYPE_MATRIX:switch(r){case e.Animation.ANIMATIONLOOPMODE_CYCLE:case e.Animation.ANIMATIONLOOPMODE_CONSTANT:if(e.Animation.AllowMatricesInterpolation){return this._animation.matrixInterpolateFunction(h,f,_)}case e.Animation.ANIMATIONLOOPMODE_RELATIVE:return h}default:break}break}}return this._getKeyValue(s[s.length-1].value)};t.prototype.setValue=function(t,i){if(i===void 0){i=1}var r;var n;var o=this._animation.targetPropertyPath;if(o.length>1){var s=this._target[o[0]];for(var a=1;a<o.length-1;a++){s=s[o[a]]}r=o[o.length-1];n=s}else{r=o[0];n=this._target}this._targetPath=r;this._activeTarget=n;this._weight=i;var u=this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.enableBlending:this._animation.enableBlending;var l=this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;if(u&&this._blendingFactor<=1){if(!this._originalBlendValue){var c=n[r];if(c.clone){this._originalBlendValue=c.clone()}else{this._originalBlendValue=c}}}if(i!==-1){if(!this._originalValue){var c=void 0;if(n.getRestPose){c=n.getRestPose()}else{c=n[r]}if(c.clone){this._originalValue=c.clone()}else{this._originalValue=c}}}if(u&&this._blendingFactor<=1){if(this._originalBlendValue.prototype){if(this._originalBlendValue.prototype.Lerp){this._currentValue=this._originalBlendValue.construtor.prototype.Lerp(t,this._originalBlendValue,this._blendingFactor)}else{this._currentValue=t}}else if(this._originalBlendValue.m){this._currentValue=e.Matrix.Lerp(this._originalBlendValue,t,this._blendingFactor)}else{this._currentValue=this._originalBlendValue*(1-this._blendingFactor)+this._blendingFactor*t}this._blendingFactor+=l}else{this._currentValue=t}if(i!==-1){this._scene._registerTargetForLateAnimationBinding(this)}else{n[r]=this._currentValue}if(this._target.markAsDirty){this._target.markAsDirty(this._animation.targetProperty)}};t.prototype._getCorrectLoopMode=function(){if(this._target&&this._target.animationPropertiesOverride){return this._target.animationPropertiesOverride.loopMode}return this._animation.loopMode};t.prototype.goToFrame=function(e){var t=this._animation.getKeys();if(e<t[0].frame){e=t[0].frame}else if(e>t[t.length-1].frame){e=t[t.length-1].frame}var i=this._interpolate(e,0,this._getCorrectLoopMode());this.setValue(i,-1)};t.prototype._prepareForSpeedRatioChange=function(e){var t=this._previousDelay*(this._animation.framePerSecond*e)/1e3;this._ratioOffset=this._previousRatio-t};t.prototype.animate=function(t,i,r,n,o,s){if(s===void 0){s=-1}var a=this._animation.targetPropertyPath;if(!a||a.length<1){this._stopped=true;return false}var u=true;var l=this._animation.getKeys();if(l[0].frame!==0){var c={frame:0,value:l[0].value};l.splice(0,0,c)}if(i<l[0].frame||i>l[l.length-1].frame){i=l[0].frame}if(r<l[0].frame||r>l[l.length-1].frame){r=l[l.length-1].frame}if(i===r){if(i>l[0].frame){i--}else if(r<l[l.length-1].frame){r++}}var h=r-i;var f;var d=t*(this._animation.framePerSecond*o)/1e3+this._ratioOffset;var p=0;this._previousDelay=t;this._previousRatio=d;if((r>i&&d>h||i>r&&d<h)&&!n){u=false;p=this._getKeyValue(l[l.length-1].value)}else{if(this._getCorrectLoopMode()!==e.Animation.ANIMATIONLOOPMODE_CYCLE){var _=r.toString()+i.toString();if(!this._offsetsCache[_]){var m=this._interpolate(i,0,e.Animation.ANIMATIONLOOPMODE_CYCLE);var g=this._interpolate(r,0,e.Animation.ANIMATIONLOOPMODE_CYCLE);switch(this._animation.dataType){case e.Animation.ANIMATIONTYPE_FLOAT:this._offsetsCache[_]=g-m;break;case e.Animation.ANIMATIONTYPE_QUATERNION:this._offsetsCache[_]=g.subtract(m);break;case e.Animation.ANIMATIONTYPE_VECTOR3:this._offsetsCache[_]=g.subtract(m);case e.Animation.ANIMATIONTYPE_VECTOR2:this._offsetsCache[_]=g.subtract(m);case e.Animation.ANIMATIONTYPE_SIZE:this._offsetsCache[_]=g.subtract(m);case e.Animation.ANIMATIONTYPE_COLOR3:this._offsetsCache[_]=g.subtract(m);default:break}this._highLimitsCache[_]=g}p=this._highLimitsCache[_];f=this._offsetsCache[_]}}if(f===undefined){switch(this._animation.dataType){case e.Animation.ANIMATIONTYPE_FLOAT:f=0;break;case e.Animation.ANIMATIONTYPE_QUATERNION:f=new e.Quaternion(0,0,0,0);break;case e.Animation.ANIMATIONTYPE_VECTOR3:f=e.Vector3.Zero();break;case e.Animation.ANIMATIONTYPE_VECTOR2:f=e.Vector2.Zero();break;case e.Animation.ANIMATIONTYPE_SIZE:f=e.Size.Zero();break;case e.Animation.ANIMATIONTYPE_COLOR3:f=e.Color3.Black()}}var v=d/h>>0;var y=u?i+d%h:r;if(this._host&&this._host.syncRoot){var b=this._host.syncRoot;var x=(b.masterFrame-b.fromFrame)/(b.toFrame-b.fromFrame);y=i+(r-i)*x}var T=this._interpolate(y,v,this._getCorrectLoopMode(),f,p);this.setValue(T,s);var E=this._animation.getEvents();for(var P=0;P<E.length;P++){if(h>0&&y>=E[P].frame&&E[P].frame>=i||h<0&&y<=E[P].frame&&E[P].frame<=i){var A=E[P];if(!A.isDone){if(A.onlyOnce){E.splice(P,1);P--}A.isDone=true;A.action()}}else if(E[P].isDone&&!E[P].onlyOnce){E[P].isDone=false}}if(!u){this._stopped=true}return u};return t}();e.RuntimeAnimation=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,t,i,r,n,o,s,a){if(i===void 0){i=0}if(r===void 0){r=100}if(n===void 0){n=false}if(o===void 0){o=1}this.target=t;this.fromFrame=i;this.toFrame=r;this.loopAnimation=n;this.onAnimationEnd=s;this._localDelayOffset=null;this._pausedDelay=null;this._runtimeAnimations=new Array;this._paused=false;this._speedRatio=1;this._weight=-1;this.animationStarted=false;if(a){this.appendAnimations(t,a)}this._speedRatio=o;this._scene=e;e._activeAnimatables.push(this)}Object.defineProperty(t.prototype,"syncRoot",{get:function(){return this._syncRoot},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"masterFrame",{get:function(){if(this._runtimeAnimations.length===0){return 0}return this._runtimeAnimations[0].currentFrame},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"weight",{get:function(){return this._weight},set:function(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"speedRatio",{get:function(){return this._speedRatio},set:function(e){for(var t=0;t<this._runtimeAnimations.length;t++){var i=this._runtimeAnimations[t];i._prepareForSpeedRatioChange(e)}this._speedRatio=e},enumerable:true,configurable:true});t.prototype.syncWith=function(e){this._syncRoot=e;if(e){var t=this._scene._activeAnimatables.indexOf(this);if(t>-1){this._scene._activeAnimatables.splice(t,1);this._scene._activeAnimatables.push(this)}}return this};t.prototype.getAnimations=function(){return this._runtimeAnimations};t.prototype.appendAnimations=function(t,i){for(var r=0;r<i.length;r++){var n=i[r];this._runtimeAnimations.push(new e.RuntimeAnimation(t,n,this._scene,this))}};t.prototype.getAnimationByTargetProperty=function(e){var t=this._runtimeAnimations;for(var i=0;i<t.length;i++){if(t[i].animation.targetProperty===e){return t[i].animation}}return null};t.prototype.getRuntimeAnimationByTargetProperty=function(e){var t=this._runtimeAnimations;for(var i=0;i<t.length;i++){if(t[i].animation.targetProperty===e){return t[i]}}return null};t.prototype.reset=function(){var e=this._runtimeAnimations;for(var t=0;t<e.length;t++){e[t].reset()}for(t=0;t<e.length;t++){var i=e[t];i.animate(0,this.fromFrame,this.toFrame,false,this._speedRatio)}this._localDelayOffset=null;this._pausedDelay=null};t.prototype.enableBlending=function(e){var t=this._runtimeAnimations;for(var i=0;i<t.length;i++){t[i].animation.enableBlending=true;t[i].animation.blendingSpeed=e}};t.prototype.disableBlending=function(){var e=this._runtimeAnimations;for(var t=0;t<e.length;t++){e[t].animation.enableBlending=false}};t.prototype.goToFrame=function(e){var t=this._runtimeAnimations;if(t[0]){var i=t[0].animation.framePerSecond;var r=t[0].currentFrame;var n=e-r;var o=n*1e3/(i*this.speedRatio);if(this._localDelayOffset===null){this._localDelayOffset=0}this._localDelayOffset-=o}for(var s=0;s<t.length;s++){t[s].goToFrame(e)}};t.prototype.pause=function(){if(this._paused){return}this._paused=true};t.prototype.restart=function(){this._paused=false};t.prototype.stop=function(e){if(e){var t=this._scene._activeAnimatables.indexOf(this);if(t>-1){var i=this._runtimeAnimations;for(var r=i.length-1;r>=0;r--){if(typeof e==="string"&&i[r].animation.name!=e){continue}i[r].dispose();i.splice(r,1)}if(i.length==0){this._scene._activeAnimatables.splice(t,1);if(this.onAnimationEnd){this.onAnimationEnd()}}}}else{var r=this._scene._activeAnimatables.indexOf(this);if(r>-1){this._scene._activeAnimatables.splice(r,1);var i=this._runtimeAnimations;for(var r=0;r<i.length;r++){i[r].dispose()}if(this.onAnimationEnd){this.onAnimationEnd()}}}};t.prototype._animate=function(e){if(this._paused){this.animationStarted=false;if(this._pausedDelay===null){this._pausedDelay=e}return true}if(this._localDelayOffset===null){this._localDelayOffset=e;this._pausedDelay=null}else if(this._pausedDelay!==null){this._localDelayOffset+=e-this._pausedDelay;this._pausedDelay=null}if(this._weight===0){return true}var t=false;var i=this._runtimeAnimations;var r;for(r=0;r<i.length;r++){var n=i[r];var o=n.animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||o}this.animationStarted=t;if(!t){r=this._scene._activeAnimatables.indexOf(this);this._scene._activeAnimatables.splice(r,1);for(r=0;r<i.length;r++){i[r].dispose()}}if(!t&&this.onAnimationEnd){this.onAnimationEnd();this.onAnimationEnd=null}return t};return t}();e.Animatable=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this._easingMode=e.EASINGMODE_EASEIN}Object.defineProperty(e,"EASINGMODE_EASEIN",{get:function(){return e._EASINGMODE_EASEIN},enumerable:true,configurable:true});Object.defineProperty(e,"EASINGMODE_EASEOUT",{get:function(){return e._EASINGMODE_EASEOUT},enumerable:true,configurable:true});Object.defineProperty(e,"EASINGMODE_EASEINOUT",{get:function(){return e._EASINGMODE_EASEINOUT},enumerable:true,configurable:true});e.prototype.setEasingMode=function(e){var t=Math.min(Math.max(e,0),2);this._easingMode=t};e.prototype.getEasingMode=function(){return this._easingMode};e.prototype.easeInCore=function(e){throw new Error("You must implement this method")};e.prototype.ease=function(t){switch(this._easingMode){case e.EASINGMODE_EASEIN:return this.easeInCore(t);case e.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-t)}if(t>=.5){return(1-this.easeInCore((1-t)*2))*.5+.5}return this.easeInCore(t*2)*.5};e._EASINGMODE_EASEIN=0;e._EASINGMODE_EASEOUT=1;e._EASINGMODE_EASEINOUT=2;return e}();e.EasingFunction=t;var i=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.easeInCore=function(e){e=Math.max(0,Math.min(1,e));return 1-Math.sqrt(1-e*e)};return t}(t);e.CircleEase=i;var r=function(e){__extends(t,e);function t(t){if(t===void 0){t=1}var i=e.call(this)||this;i.amplitude=t;return i}t.prototype.easeInCore=function(e){var t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)};return t}(t);e.BackEase=r;var n=function(e){__extends(t,e);function t(t,i){if(t===void 0){t=3}if(i===void 0){i=2}var r=e.call(this)||this;r.bounces=t;r.bounciness=i;return r}t.prototype.easeInCore=function(e){var t=Math.max(0,this.bounces);var i=this.bounciness;if(i<=1){i=1.001}var r=Math.pow(i,t);var n=1-i;var o=(1-r)/n+r*.5;var s=e*o;var a=Math.log(-s*(1-i)+1)/Math.log(i);var u=Math.floor(a);var l=u+1;var c=(1-Math.pow(i,u))/(n*o);var h=(1-Math.pow(i,l))/(n*o);var f=(c+h)*.5;var d=e-f;var p=f-c;return-Math.pow(1/i,t-u)/(p*p)*(d-p)*(d+p)};return t}(t);e.BounceEase=n;var o=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.easeInCore=function(e){return e*e*e};return t}(t);e.CubicEase=o;var s=function(e){__extends(t,e);function t(t,i){if(t===void 0){t=3}if(i===void 0){i=3}var r=e.call(this)||this;r.oscillations=t;r.springiness=i;return r}t.prototype.easeInCore=function(e){var t;var i=Math.max(0,this.oscillations);var r=Math.max(0,this.springiness);if(r==0){t=e}else{t=(Math.exp(r*e)-1)/(Math.exp(r)-1)}return t*Math.sin((6.283185307179586*i+1.5707963267948966)*e)};return t}(t);e.ElasticEase=s;var a=function(e){__extends(t,e);function t(t){if(t===void 0){t=2}var i=e.call(this)||this;i.exponent=t;return i}t.prototype.easeInCore=function(e){if(this.exponent<=0){return e}return(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)};return t}(t);e.ExponentialEase=a;var u=function(e){__extends(t,e);function t(t){if(t===void 0){t=2}var i=e.call(this)||this;i.power=t;return i}t.prototype.easeInCore=function(e){var t=Math.max(0,this.power);return Math.pow(e,t)};return t}(t);e.PowerEase=u;var l=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.easeInCore=function(e){return e*e};return t}(t);e.QuadraticEase=l;var c=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.easeInCore=function(e){return e*e*e*e};return t}(t);e.QuarticEase=c;var h=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.easeInCore=function(e){return e*e*e*e*e};return t}(t);e.QuinticEase=h;var f=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.easeInCore=function(e){return 1-Math.sin(1.5707963267948966*(1-e))};return t}(t);e.SineEase=f;var d=function(t){__extends(i,t);function i(e,i,r,n){if(e===void 0){e=0}if(i===void 0){i=0}if(r===void 0){r=1}if(n===void 0){n=1}
var o=t.call(this)||this;o.x1=e;o.y1=i;o.x2=r;o.y2=n;return o}i.prototype.easeInCore=function(t){return e.BezierCurve.interpolate(t,this.x1,this.y1,this.x2,this.y2)};return i}(t);e.BezierCurveEase=d})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e){this._actionManager=e}e.prototype.isValid=function(){return true};e.prototype._getProperty=function(e){return this._actionManager._getProperty(e)};e.prototype._getEffectiveTarget=function(e,t){return this._actionManager._getEffectiveTarget(e,t)};e.prototype.serialize=function(){};e.prototype._serialize=function(e){return{type:2,children:[],name:e.name,properties:e.properties}};return e}();e.Condition=t;var i=function(t){__extends(i,t);function i(e,r,n,o,s){if(s===void 0){s=i.IsEqual}var a=t.call(this,e)||this;a.propertyPath=n;a.value=o;a.operator=s;a._target=r;a._effectiveTarget=a._getEffectiveTarget(r,a.propertyPath);a._property=a._getProperty(a.propertyPath);return a}Object.defineProperty(i,"IsEqual",{get:function(){return i._IsEqual},enumerable:true,configurable:true});Object.defineProperty(i,"IsDifferent",{get:function(){return i._IsDifferent},enumerable:true,configurable:true});Object.defineProperty(i,"IsGreater",{get:function(){return i._IsGreater},enumerable:true,configurable:true});Object.defineProperty(i,"IsLesser",{get:function(){return i._IsLesser},enumerable:true,configurable:true});i.prototype.isValid=function(){switch(this.operator){case i.IsGreater:return this._effectiveTarget[this._property]>this.value;case i.IsLesser:return this._effectiveTarget[this._property]<this.value;case i.IsEqual:case i.IsDifferent:var e;if(this.value.equals){e=this.value.equals(this._effectiveTarget[this._property])}else{e=this.value===this._effectiveTarget[this._property]}return this.operator===i.IsEqual?e:!e}return false};i.prototype.serialize=function(){return this._serialize({name:"ValueCondition",properties:[e.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:e.Action._SerializeValueAsString(this.value)},{name:"operator",value:i.GetOperatorName(this.operator)}]})};i.GetOperatorName=function(e){switch(e){case i._IsEqual:return"IsEqual";case i._IsDifferent:return"IsDifferent";case i._IsGreater:return"IsGreater";case i._IsLesser:return"IsLesser";default:return""}};i._IsEqual=0;i._IsDifferent=1;i._IsGreater=2;i._IsLesser=3;return i}(t);e.ValueCondition=i;var r=function(e){__extends(t,e);function t(t,i){var r=e.call(this,t)||this;r.predicate=i;return r}t.prototype.isValid=function(){return this.predicate()};return t}(t);e.PredicateCondition=r;var n=function(t){__extends(i,t);function i(e,i,r){var n=t.call(this,e)||this;n.value=r;n._target=i;return n}i.prototype.isValid=function(){return this._target.state===this.value};i.prototype.serialize=function(){return this._serialize({name:"StateCondition",properties:[e.Action._GetTargetProperty(this._target),{name:"value",value:this.value}]})};return i}(t);e.StateCondition=n})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i){this.triggerOptions=t;this.onBeforeExecuteObservable=new e.Observable;if(t.parameter){this.trigger=t.trigger;this._triggerParameter=t.parameter}else{this.trigger=t}this._nextActiveAction=this;this._condition=i}t.prototype._prepare=function(){};t.prototype.getTriggerParameter=function(){return this._triggerParameter};t.prototype._executeCurrent=function(e){if(this._nextActiveAction._condition){var t=this._nextActiveAction._condition;var i=this._actionManager.getScene().getRenderId();if(t._evaluationId===i){if(!t._currentResult){return}}else{t._evaluationId=i;if(!t.isValid()){t._currentResult=false;return}t._currentResult=true}}this.onBeforeExecuteObservable.notifyObservers(this);this._nextActiveAction.execute(e);this.skipToNextActiveAction()};t.prototype.execute=function(e){};t.prototype.skipToNextActiveAction=function(){if(this._nextActiveAction._child){if(!this._nextActiveAction._child._actionManager){this._nextActiveAction._child._actionManager=this._actionManager}this._nextActiveAction=this._nextActiveAction._child}else{this._nextActiveAction=this}};t.prototype.then=function(e){this._child=e;e._actionManager=this._actionManager;e._prepare();return e};t.prototype._getProperty=function(e){return this._actionManager._getProperty(e)};t.prototype._getEffectiveTarget=function(e,t){return this._actionManager._getEffectiveTarget(e,t)};t.prototype.serialize=function(e){};t.prototype._serialize=function(e,t){var i={type:1,children:[],name:e.name,properties:e.properties||[]};if(this._child){this._child.serialize(i)}if(this._condition){var r=this._condition.serialize();r.children.push(i);if(t){t.children.push(r)}return r}if(t){t.children.push(i)}return i};t._SerializeValueAsString=function(t){if(typeof t==="number"){return t.toString()}if(typeof t==="boolean"){return t?"true":"false"}if(t instanceof e.Vector2){return t.x+", "+t.y}if(t instanceof e.Vector3){return t.x+", "+t.y+", "+t.z}if(t instanceof e.Color3){return t.r+", "+t.g+", "+t.b}if(t instanceof e.Color4){return t.r+", "+t.g+", "+t.b+", "+t.a}return t};t._GetTargetProperty=function(t){return{name:"target",targetType:t instanceof e.Mesh?"MeshProperties":t instanceof e.Light?"LightProperties":t instanceof e.Camera?"CameraProperties":"SceneProperties",value:t instanceof e.Scene?"Scene":t.name}};return t}();e.Action=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e,t,i,r,n,o){this.source=e;this.pointerX=t;this.pointerY=i;this.meshUnderPointer=r;this.sourceEvent=n;this.additionalData=o}e.CreateNew=function(t,i,r){var n=t.getScene();return new e(t,n.pointerX,n.pointerY,n.meshUnderPointer,i,r)};e.CreateNewFromSprite=function(t,i,r,n){return new e(t,i.pointerX,i.pointerY,i.meshUnderPointer,r,n)};e.CreateNewFromScene=function(t,i){return new e(null,t.pointerX,t.pointerY,t.meshUnderPointer,i)};e.CreateNewFromPrimitive=function(t,i,r,n){return new e(t,i.x,i.y,null,r,n)};return e}();e.ActionEvent=t;var i=function(){function t(e){this.actions=new Array;this.hoverCursor="";this._scene=e;e._actionManagers.push(this)}Object.defineProperty(t,"NothingTrigger",{get:function(){return t._NothingTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnPickTrigger",{get:function(){return t._OnPickTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnLeftPickTrigger",{get:function(){return t._OnLeftPickTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnRightPickTrigger",{get:function(){return t._OnRightPickTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnCenterPickTrigger",{get:function(){return t._OnCenterPickTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnPickDownTrigger",{get:function(){return t._OnPickDownTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnDoublePickTrigger",{get:function(){return t._OnDoublePickTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnPickUpTrigger",{get:function(){return t._OnPickUpTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnPickOutTrigger",{get:function(){return t._OnPickOutTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnLongPressTrigger",{get:function(){return t._OnLongPressTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnPointerOverTrigger",{get:function(){return t._OnPointerOverTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnPointerOutTrigger",{get:function(){return t._OnPointerOutTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnEveryFrameTrigger",{get:function(){return t._OnEveryFrameTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnIntersectionEnterTrigger",{get:function(){return t._OnIntersectionEnterTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnIntersectionExitTrigger",{get:function(){return t._OnIntersectionExitTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnKeyDownTrigger",{get:function(){return t._OnKeyDownTrigger},enumerable:true,configurable:true});Object.defineProperty(t,"OnKeyUpTrigger",{get:function(){return t._OnKeyUpTrigger},enumerable:true,configurable:true});t.prototype.dispose=function(){var e=this._scene._actionManagers.indexOf(this);for(var i=0;i<this.actions.length;i++){var r=this.actions[i];t.Triggers[r.trigger]--;if(t.Triggers[r.trigger]===0){delete t.Triggers[r.trigger]}}if(e>-1){this._scene._actionManagers.splice(e,1)}};t.prototype.getScene=function(){return this._scene};t.prototype.hasSpecificTriggers=function(e){for(var t=0;t<this.actions.length;t++){var i=this.actions[t];if(e.indexOf(i.trigger)>-1){return true}}return false};t.prototype.hasSpecificTrigger=function(e){for(var t=0;t<this.actions.length;t++){var i=this.actions[t];if(i.trigger===e){return true}}return false};Object.defineProperty(t.prototype,"hasPointerTriggers",{get:function(){for(var e=0;e<this.actions.length;e++){var i=this.actions[e];if(i.trigger>=t._OnPickTrigger&&i.trigger<=t._OnPointerOutTrigger){return true}}return false},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"hasPickTriggers",{get:function(){for(var e=0;e<this.actions.length;e++){var i=this.actions[e];if(i.trigger>=t._OnPickTrigger&&i.trigger<=t._OnPickUpTrigger){return true}}return false},enumerable:true,configurable:true});Object.defineProperty(t,"HasTriggers",{get:function(){for(var e in t.Triggers){if(t.Triggers.hasOwnProperty(e)){return true}}return false},enumerable:true,configurable:true});Object.defineProperty(t,"HasPickTriggers",{get:function(){for(var e in t.Triggers){if(t.Triggers.hasOwnProperty(e)){var i=parseInt(e);if(i>=t._OnPickTrigger&&i<=t._OnPickUpTrigger){return true}}}return false},enumerable:true,configurable:true});t.HasSpecificTrigger=function(e){for(var i in t.Triggers){if(t.Triggers.hasOwnProperty(i)){var r=parseInt(i);if(r===e){return true}}}return false};t.prototype.registerAction=function(i){if(i.trigger===t.OnEveryFrameTrigger){if(this.getScene().actionManager!==this){e.Tools.Warn("OnEveryFrameTrigger can only be used with scene.actionManager");return null}}this.actions.push(i);if(t.Triggers[i.trigger]){t.Triggers[i.trigger]++}else{t.Triggers[i.trigger]=1}i._actionManager=this;i._prepare();return i};t.prototype.unregisterAction=function(e){var i=this.actions.indexOf(e);if(i!==-1){this.actions.splice(i,1);t.Triggers[e.trigger]-=1;if(t.Triggers[e.trigger]===0){delete t.Triggers[e.trigger]}delete e._actionManager;return true}return false};t.prototype.processTrigger=function(e,i){for(var r=0;r<this.actions.length;r++){var n=this.actions[r];if(n.trigger===e){if(i){if(e===t.OnKeyUpTrigger||e===t.OnKeyDownTrigger){var o=n.getTriggerParameter();if(o&&o!==i.sourceEvent.keyCode){if(!o.toLowerCase){continue}var s=o.toLowerCase();if(s!==i.sourceEvent.key){var a=i.sourceEvent.charCode?i.sourceEvent.charCode:i.sourceEvent.keyCode;var u=String.fromCharCode(a).toLowerCase();if(u!==s){continue}}}}}n._executeCurrent(i)}}};t.prototype._getEffectiveTarget=function(e,t){var i=t.split(".");for(var r=0;r<i.length-1;r++){e=e[i[r]]}return e};t.prototype._getProperty=function(e){var t=e.split(".");return t[t.length-1]};t.prototype.serialize=function(i){var r={children:new Array,name:i,type:3,properties:new Array};for(var n=0;n<this.actions.length;n++){var o={type:0,children:new Array,name:t.GetTriggerName(this.actions[n].trigger),properties:new Array};var s=this.actions[n].triggerOptions;if(s&&typeof s!=="number"){if(s.parameter instanceof e.Node){o.properties.push(e.Action._GetTargetProperty(s.parameter))}else{var a={};e.Tools.DeepCopy(s.parameter,a,["mesh"]);if(s.parameter.mesh){a._meshId=s.parameter.mesh.id}o.properties.push({name:"parameter",targetType:null,value:a})}}this.actions[n].serialize(o);r.children.push(o)}return r};t.Parse=function(i,r,n){var o=new t(n);if(r===null)n.actionManager=o;else r.actionManager=o;var s=function(t,i){var r=Object.create(e.Tools.Instantiate("BABYLON."+t).prototype);r.constructor.apply(r,i);return r};var a=function(t,i,r,n){if(n===null){var o=parseFloat(i);if(i==="true"||i==="false")return i==="true";else return isNaN(o)?i:o}var s=n.split(".");var a=i.split(",");for(var u=0;u<s.length;u++){r=r[s[u]]}if(typeof r==="boolean")return a[0]==="true";if(typeof r==="string")return a[0];var l=new Array;for(var u=0;u<a.length;u++)l.push(parseFloat(a[u]));if(r instanceof e.Vector3)return e.Vector3.FromArray(l);if(r instanceof e.Vector4)return e.Vector4.FromArray(l);if(r instanceof e.Color3)return e.Color3.FromArray(l);if(r instanceof e.Color4)return e.Color4.FromArray(l);return parseFloat(a[0])};var u=function(i,r,l,c,h){if(h===void 0){h=null}if(i.detached)return;var f=new Array;var d=null;var p=null;var _=i.combine&&i.combine.length>0;if(i.type===2)f.push(o);else f.push(r);if(_){var m=new Array;for(var g=0;g<i.combine.length;g++){u(i.combine[g],t.NothingTrigger,l,c,m)}f.push(m)}else{for(var v=0;v<i.properties.length;v++){var y=i.properties[v].value;var b=i.properties[v].name;var x=i.properties[v].targetType;if(b==="target")if(x!==null&&x==="SceneProperties")y=d=n;else y=d=n.getNodeByName(y);else if(b==="parent")y=n.getNodeByName(y);else if(b==="sound")y=n.getSoundByName(y);else if(b!=="propertyPath"){if(i.type===2&&b==="operator")y=e.ValueCondition[y];else y=a(b,y,d,b==="value"?p:null)}else{p=y}f.push(y)}}if(h===null){f.push(l)}else{f.push(null)}if(i.name==="InterpolateValueAction"){var T=f[f.length-2];f[f.length-1]=T;f[f.length-2]=l}var E=s(i.name,f);if(E instanceof e.Condition&&l!==null){var P=new e.DoNothingAction(r,l);if(c)c.then(P);else o.registerAction(P);c=P}if(h===null){if(E instanceof e.Condition){l=E;E=c}else{l=null;if(c)c.then(E);else o.registerAction(E)}}else{h.push(E)}for(var v=0;v<i.children.length;v++)u(i.children[v],r,l,E,null)};for(var l=0;l<i.children.length;l++){var c;var h=i.children[l];if(h.properties.length>0){var f=h.properties[0].value;var d=h.properties[0].targetType===null?f:n.getMeshByName(f);if(d._meshId){d.mesh=n.getMeshByID(d._meshId)}c={trigger:t[h.name],parameter:d}}else c=t[h.name];for(var p=0;p<h.children.length;p++){if(!h.detached)u(h.children[p],c,null,null)}}};t.GetTriggerName=function(e){switch(e){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnPickUpTrigger";case 7:return"OnLongPressTrigger";case 8:return"OnPointerOverTrigger";case 9:return"OnPointerOutTrigger";case 10:return"OnEveryFrameTrigger";case 11:return"OnIntersectionEnterTrigger";case 12:return"OnIntersectionExitTrigger";case 13:return"OnKeyDownTrigger";case 14:return"OnKeyUpTrigger";case 15:return"OnPickOutTrigger";default:return""}};t._NothingTrigger=0;t._OnPickTrigger=1;t._OnLeftPickTrigger=2;t._OnRightPickTrigger=3;t._OnCenterPickTrigger=4;t._OnPickDownTrigger=5;t._OnDoublePickTrigger=6;t._OnPickUpTrigger=7;t._OnLongPressTrigger=8;t._OnPointerOverTrigger=9;t._OnPointerOutTrigger=10;t._OnEveryFrameTrigger=11;t._OnIntersectionEnterTrigger=12;t._OnIntersectionExitTrigger=13;t._OnKeyDownTrigger=14;t._OnKeyUpTrigger=15;t._OnPickOutTrigger=16;t.Triggers={};return t}();e.ActionManager=i})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l){if(s===void 0){s=1e3}var c=t.call(this,i,a)||this;c.propertyPath=n;c.value=o;c.duration=s;c.stopOtherAnimations=u;c.onInterpolationDone=l;c.onInterpolationDoneObservable=new e.Observable;c._target=c._effectiveTarget=r;return c}i.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath);this._property=this._getProperty(this.propertyPath)};i.prototype.execute=function(){var t=this;var i=this._actionManager.getScene();var r=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];var n;if(typeof this.value==="number"){n=e.Animation.ANIMATIONTYPE_FLOAT}else if(this.value instanceof e.Color3){n=e.Animation.ANIMATIONTYPE_COLOR3}else if(this.value instanceof e.Vector3){n=e.Animation.ANIMATIONTYPE_VECTOR3}else if(this.value instanceof e.Matrix){n=e.Animation.ANIMATIONTYPE_MATRIX}else if(this.value instanceof e.Quaternion){n=e.Animation.ANIMATIONTYPE_QUATERNION}else{e.Tools.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");return}var o=new e.Animation("InterpolateValueAction",this._property,100*(1e3/this.duration),n,e.Animation.ANIMATIONLOOPMODE_CONSTANT);o.setKeys(r);if(this.stopOtherAnimations){i.stopAnimation(this._effectiveTarget)}var s=function(){t.onInterpolationDoneObservable.notifyObservers(t);if(t.onInterpolationDone){t.onInterpolationDone()}};i.beginDirectAnimation(this._effectiveTarget,[o],0,100,false,1,s)};i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"InterpolateValueAction",properties:[e.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:e.Action._SerializeValueAsString(this.value)},{name:"duration",value:e.Action._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:e.Action._SerializeValueAsString(this.stopOtherAnimations)||false}]},i)};return i}(e.Action);e.InterpolateValueAction=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(e,i,r,n){var o=t.call(this,e,n)||this;o.propertyPath=r;o._target=o._effectiveTarget=i;return o}i.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath);this._property=this._getProperty(this.propertyPath)};i.prototype.execute=function(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]};i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"SwitchBooleanAction",properties:[e.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},i)};return i}(e.Action);e.SwitchBooleanAction=t;var i=function(t){__extends(i,t);function i(e,i,r,n){var o=t.call(this,e,n)||this;o.value=r;o._target=i;return o}i.prototype.execute=function(){this._target.state=this.value};i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"SetStateAction",properties:[e.Action._GetTargetProperty(this._target),{name:"value",value:this.value}]},i)};return i}(e.Action);e.SetStateAction=i;var r=function(t){__extends(i,t);function i(e,i,r,n,o){var s=t.call(this,e,o)||this;s.propertyPath=r;s.value=n;s._target=s._effectiveTarget=i;return s}i.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath);this._property=this._getProperty(this.propertyPath)};i.prototype.execute=function(){this._effectiveTarget[this._property]=this.value;if(this._target.markAsDirty){this._target.markAsDirty(this._property)}};i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"SetValueAction",properties:[e.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:e.Action._SerializeValueAsString(this.value)}]},i)};return i}(e.Action);e.SetValueAction=r;var n=function(t){__extends(i,t);function i(e,i,r,n,o){var s=t.call(this,e,o)||this;s.propertyPath=r;s.value=n;s._target=s._effectiveTarget=i;return s}i.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath);this._property=this._getProperty(this.propertyPath);if(typeof this._effectiveTarget[this._property]!=="number"){e.Tools.Warn("Warning: IncrementValueAction can only be used with number values")}};i.prototype.execute=function(){this._effectiveTarget[this._property]+=this.value;if(this._target.markAsDirty){this._target.markAsDirty(this._property)}};i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"IncrementValueAction",properties:[e.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:e.Action._SerializeValueAsString(this.value)}]},i)};return i}(e.Action);e.IncrementValueAction=n;var o=function(t){__extends(i,t);function i(e,i,r,n,o,s){var a=t.call(this,e,s)||this;a.from=r;a.to=n;a.loop=o;a._target=i;return a}i.prototype._prepare=function(){};i.prototype.execute=function(){var e=this._actionManager.getScene();e.beginAnimation(this._target,this.from,this.to,this.loop)};i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"PlayAnimationAction",properties:[e.Action._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:e.Action._SerializeValueAsString(this.loop)||false}]},i)};return i}(e.Action);e.PlayAnimationAction=o;var s=function(t){__extends(i,t);function i(e,i,r){var n=t.call(this,e,r)||this;n._target=i;return n}i.prototype._prepare=function(){};i.prototype.execute=function(){var e=this._actionManager.getScene();e.stopAnimation(this._target)};i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"StopAnimationAction",properties:[e.Action._GetTargetProperty(this._target)]},i)};return i}(e.Action);e.StopAnimationAction=s;var a=function(t){__extends(i,t);function i(i,r){if(i===void 0){i=e.ActionManager.NothingTrigger}return t.call(this,i,r)||this}i.prototype.execute=function(){};i.prototype.serialize=function(e){return t.prototype._serialize.call(this,{name:"DoNothingAction",properties:[]},e)};return i}(e.Action);e.DoNothingAction=a;var u=function(e){__extends(t,e);function t(t,i,r){var n=e.call(this,t,r)||this;n.children=i;return n}t.prototype._prepare=function(){for(var e=0;e<this.children.length;e++){this.children[e]._actionManager=this._actionManager;this.children[e]._prepare()}};t.prototype.execute=function(e){for(var t=0;t<this.children.length;t++){this.children[t].execute(e)}};t.prototype.serialize=function(t){var i=e.prototype._serialize.call(this,{name:"CombineAction",properties:[],combine:[]},t);for(var r=0;r<this.children.length;r++){i.combine.push(this.children[r].serialize(null))}return i};return t}(e.Action);e.CombineAction=u;var l=function(e){__extends(t,e);function t(t,i,r){var n=e.call(this,t,r)||this;n.func=i;return n}t.prototype.execute=function(e){this.func(e)};return t}(e.Action);e.ExecuteCodeAction=l;var c=function(t){__extends(i,t);function i(e,i,r,n){var o=t.call(this,e,n)||this;o._target=i;o._parent=r;return o}i.prototype._prepare=function(){};i.prototype.execute=function(){if(this._target.parent===this._parent){return}var t=this._parent.getWorldMatrix().clone();t.invert();this._target.position=e.Vector3.TransformCoordinates(this._target.position,t);this._target.parent=this._parent};i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"SetParentAction",properties:[e.Action._GetTargetProperty(this._target),e.Action._GetTargetProperty(this._parent)]},i)};return i}(e.Action);e.SetParentAction=c;var h=function(e){__extends(t,e);function t(t,i,r){var n=e.call(this,t,r)||this;n._sound=i;return n}t.prototype._prepare=function(){};t.prototype.execute=function(){if(this._sound!==undefined)this._sound.play()};t.prototype.serialize=function(t){return e.prototype._serialize.call(this,{name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},t)};return t}(e.Action);e.PlaySoundAction=h;var f=function(e){__extends(t,e);function t(t,i,r){var n=e.call(this,t,r)||this;n._sound=i;return n}t.prototype._prepare=function(){};t.prototype.execute=function(){if(this._sound!==undefined)this._sound.stop()};t.prototype.serialize=function(t){return e.prototype._serialize.call(this,{name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},t)};return t}(e.Action);e.StopSoundAction=f})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r,n,o,s,a){if(s===void 0){s=.01}if(a===void 0){a=e.Texture.TRILINEAR_SAMPLINGMODE}this.name=t;this.sprites=new Array;this.renderingGroupId=0;this.layerMask=268435455;this.fogEnabled=true;this.isPickable=false;this.onDisposeObservable=new e.Observable;this._vertexBuffers={};this._capacity=r;this._spriteTexture=new e.Texture(i,o,true,false,a);this._spriteTexture.wrapU=e.Texture.CLAMP_ADDRESSMODE;this._spriteTexture.wrapV=e.Texture.CLAMP_ADDRESSMODE;if(n.width&&n.height){this.cellWidth=n.width;this.cellHeight=n.height}else if(n!==undefined){this.cellWidth=n;this.cellHeight=n}else{return}this._epsilon=s;this._scene=o;this._scene.spriteManagers.push(this);var u=[];var l=0;for(var c=0;c<r;c++){u.push(l);u.push(l+1);u.push(l+2);u.push(l);u.push(l+2);u.push(l+3);l+=4}this._indexBuffer=o.getEngine().createIndexBuffer(u);this._vertexData=new Float32Array(r*16*4);this._buffer=new e.Buffer(o.getEngine(),this._vertexData,true,16);var h=this._buffer.createVertexBuffer(e.VertexBuffer.PositionKind,0,4);var f=this._buffer.createVertexBuffer("options",4,4);var d=this._buffer.createVertexBuffer("cellInfo",8,4);var p=this._buffer.createVertexBuffer(e.VertexBuffer.ColorKind,12,4);this._vertexBuffers[e.VertexBuffer.PositionKind]=h;this._vertexBuffers["options"]=f;this._vertexBuffers["cellInfo"]=d;this._vertexBuffers[e.VertexBuffer.ColorKind]=p;this._effectBase=this._scene.getEngine().createEffect("sprites",[e.VertexBuffer.PositionKind,"options","cellInfo",e.VertexBuffer.ColorKind],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],"");this._effectFog=this._scene.getEngine().createEffect("sprites",[e.VertexBuffer.PositionKind,"options","cellInfo",e.VertexBuffer.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],"#define FOG")}Object.defineProperty(t.prototype,"onDispose",{set:function(e){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"texture",{get:function(){return this._spriteTexture},set:function(e){this._spriteTexture=e},enumerable:true,configurable:true});t.prototype._appendSpriteVertex=function(e,t,i,r,n){var o=e*16;if(i===0)i=this._epsilon;else if(i===1)i=1-this._epsilon;if(r===0)r=this._epsilon;else if(r===1)r=1-this._epsilon;this._vertexData[o]=t.position.x;this._vertexData[o+1]=t.position.y;this._vertexData[o+2]=t.position.z;this._vertexData[o+3]=t.angle;this._vertexData[o+4]=t.width;this._vertexData[o+5]=t.height;this._vertexData[o+6]=i;this._vertexData[o+7]=r;this._vertexData[o+8]=t.invertU?1:0;this._vertexData[o+9]=t.invertV?1:0;var s=t.cellIndex/n>>0;this._vertexData[o+10]=t.cellIndex-s*n;this._vertexData[o+11]=s;this._vertexData[o+12]=t.color.r;this._vertexData[o+13]=t.color.g;this._vertexData[o+14]=t.color.b;this._vertexData[o+15]=t.color.a};t.prototype.intersects=function(t,i,r,n){var o=Math.min(this._capacity,this.sprites.length);var s=e.Vector3.Zero();var a=e.Vector3.Zero();var u=Number.MAX_VALUE;var l=null;var c=e.Vector3.Zero();var h=i.getViewMatrix();for(var f=0;f<o;f++){var d=this.sprites[f];if(!d){continue}if(r){if(!r(d)){continue}}else if(!d.isPickable){continue}e.Vector3.TransformCoordinatesToRef(d.position,h,c);s.copyFromFloats(c.x-d.width/2,c.y-d.height/2,c.z);a.copyFromFloats(c.x+d.width/2,c.y+d.height/2,c.z);if(t.intersectsBoxMinMax(s,a)){var p=e.Vector3.Distance(c,t.origin);if(u>p){u=p;l=d;if(n){break}}}}if(l){var _=new e.PickingInfo;_.hit=true;_.pickedSprite=l;_.distance=u;return _}return null};t.prototype.render=function(){if(!this._effectBase.isReady()||!this._effectFog.isReady()||!this._spriteTexture||!this._spriteTexture.isReady())return;var t=this._scene.getEngine();var i=this._spriteTexture.getBaseSize();var r=t.getDeltaTime();var n=Math.min(this._capacity,this.sprites.length);var o=i.width/this.cellWidth;var s=0;for(var a=0;a<n;a++){var u=this.sprites[a];if(!u){continue}u._animate(r);this._appendSpriteVertex(s++,u,0,0,o);this._appendSpriteVertex(s++,u,1,0,o);this._appendSpriteVertex(s++,u,1,1,o);this._appendSpriteVertex(s++,u,0,1,o)}this._buffer.update(this._vertexData);var l=this._effectBase;if(this._scene.fogEnabled&&this._scene.fogMode!==e.Scene.FOGMODE_NONE&&this.fogEnabled){l=this._effectFog}t.enableEffect(l);var c=this._scene.getViewMatrix();l.setTexture("diffuseSampler",this._spriteTexture);l.setMatrix("view",c);l.setMatrix("projection",this._scene.getProjectionMatrix());l.setFloat2("textureInfos",this.cellWidth/i.width,this.cellHeight/i.height);if(this._scene.fogEnabled&&this._scene.fogMode!==e.Scene.FOGMODE_NONE&&this.fogEnabled){l.setFloat4("vFogInfos",this._scene.fogMode,this._scene.fogStart,this._scene.fogEnd,this._scene.fogDensity);l.setColor3("vFogColor",this._scene.fogColor)}t.bindBuffers(this._vertexBuffers,this._indexBuffer,l);t.setDepthFunctionToLessOrEqual();l.setBool("alphaTest",true);t.setColorWrite(false);t.drawElementsType(e.Material.TriangleFillMode,0,n*6);t.setColorWrite(true);l.setBool("alphaTest",false);t.setAlphaMode(e.Engine.ALPHA_COMBINE);t.drawElementsType(e.Material.TriangleFillMode,0,n*6);t.setAlphaMode(e.Engine.ALPHA_DISABLE)};t.prototype.dispose=function(){if(this._buffer){this._buffer.dispose();this._buffer=null}if(this._indexBuffer){this._scene.getEngine()._releaseBuffer(this._indexBuffer);this._indexBuffer=null}if(this._spriteTexture){this._spriteTexture.dispose();this._spriteTexture=null}var e=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(e,1);this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear()};return t}();e.SpriteManager=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i){this.name=t;this.color=new e.Color4(1,1,1,1);this.width=1;this.height=1;this.angle=0;this.cellIndex=0;this.invertU=0;this.invertV=0;this.animations=new Array;this.isPickable=false;this._animationStarted=false;this._loopAnimation=false;this._fromIndex=0;this._toIndex=0;this._delay=0;this._direction=1;this._time=0;this._manager=i;this._manager.sprites.push(this);this.position=e.Vector3.Zero()}Object.defineProperty(t.prototype,"size",{get:function(){return this.width},set:function(e){this.width=e;this.height=e},enumerable:true,configurable:true});t.prototype.playAnimation=function(e,t,i,r,n){this._fromIndex=e;this._toIndex=t;this._loopAnimation=i;this._delay=r;this._animationStarted=true;this._direction=e<t?1:-1;this.cellIndex=e;this._time=0;this._onAnimationEnd=n};t.prototype.stopAnimation=function(){this._animationStarted=false};t.prototype._animate=function(e){if(!this._animationStarted)return;this._time+=e;if(this._time>this._delay){this._time=this._time%this._delay;this.cellIndex+=this._direction;if(this.cellIndex>this._toIndex){if(this._loopAnimation){this.cellIndex=this._fromIndex}else{this.cellIndex=this._toIndex;this._animationStarted=false;if(this._onAnimationEnd){this._onAnimationEnd()}if(this.disposeWhenFinishedAnimating){this.dispose()}}}}};t.prototype.dispose=function(){for(var e=0;e<this._manager.sprites.length;e++){if(this._manager.sprites[e]==this){this._manager.sprites.splice(e,1)}}};return t}();e.Sprite=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e,t,i){this.bu=e;this.bv=t;this.distance=i;this.faceId=0;this.subMeshId=0}return e}();e.IntersectionInfo=t;var i=function(){function t(){this.hit=false;this.distance=0;this.pickedPoint=null;this.pickedMesh=null;this.bu=0;this.bv=0;this.faceId=-1;this.subMeshId=0;this.pickedSprite=null}t.prototype.getNormal=function(t,i){if(t===void 0){t=false}if(i===void 0){i=true}if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e.VertexBuffer.NormalKind)){return null}var r=this.pickedMesh.getIndices();if(!r){return null}var n;if(i){var o=this.pickedMesh.getVerticesData(e.VertexBuffer.NormalKind);var s=e.Vector3.FromArray(o,r[this.faceId*3]*3);var a=e.Vector3.FromArray(o,r[this.faceId*3+1]*3);var u=e.Vector3.FromArray(o,r[this.faceId*3+2]*3);s=s.scale(this.bu);a=a.scale(this.bv);u=u.scale(1-this.bu-this.bv)
;n=new e.Vector3(s.x+a.x+u.x,s.y+a.y+u.y,s.z+a.z+u.z)}else{var l=this.pickedMesh.getVerticesData(e.VertexBuffer.PositionKind);var c=e.Vector3.FromArray(l,r[this.faceId*3]*3);var h=e.Vector3.FromArray(l,r[this.faceId*3+1]*3);var f=e.Vector3.FromArray(l,r[this.faceId*3+2]*3);var d=c.subtract(h);var p=f.subtract(h);n=e.Vector3.Cross(d,p)}if(t){n=e.Vector3.TransformNormal(n,this.pickedMesh.getWorldMatrix())}return e.Vector3.Normalize(n)};t.prototype.getTextureCoordinates=function(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e.VertexBuffer.UVKind)){return null}var t=this.pickedMesh.getIndices();if(!t){return null}var i=this.pickedMesh.getVerticesData(e.VertexBuffer.UVKind);if(!i){return null}var r=e.Vector2.FromArray(i,t[this.faceId*3]*2);var n=e.Vector2.FromArray(i,t[this.faceId*3+1]*2);var o=e.Vector2.FromArray(i,t[this.faceId*3+2]*2);r=r.scale(1-this.bu-this.bv);n=n.scale(this.bu);o=o.scale(this.bv);return new e.Vector2(r.x+n.x+o.x,r.y+n.y+o.y)};return t}();e.PickingInfo=i})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,t,i){if(i===void 0){i=Number.MAX_VALUE}this.origin=e;this.direction=t;this.length=i}t.prototype.intersectsBoxMinMax=function(e,t){var i=0;var r=Number.MAX_VALUE;var n;var o;var s;var a;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<e.x||this.origin.x>t.x){return false}}else{n=1/this.direction.x;o=(e.x-this.origin.x)*n;s=(t.x-this.origin.x)*n;if(s===-Infinity){s=Infinity}if(o>s){a=o;o=s;s=a}i=Math.max(o,i);r=Math.min(s,r);if(i>r){return false}}if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<e.y||this.origin.y>t.y){return false}}else{n=1/this.direction.y;o=(e.y-this.origin.y)*n;s=(t.y-this.origin.y)*n;if(s===-Infinity){s=Infinity}if(o>s){a=o;o=s;s=a}i=Math.max(o,i);r=Math.min(s,r);if(i>r){return false}}if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<e.z||this.origin.z>t.z){return false}}else{n=1/this.direction.z;o=(e.z-this.origin.z)*n;s=(t.z-this.origin.z)*n;if(s===-Infinity){s=Infinity}if(o>s){a=o;o=s;s=a}i=Math.max(o,i);r=Math.min(s,r);if(i>r){return false}}return true};t.prototype.intersectsBox=function(e){return this.intersectsBoxMinMax(e.minimum,e.maximum)};t.prototype.intersectsSphere=function(e){var t=e.center.x-this.origin.x;var i=e.center.y-this.origin.y;var r=e.center.z-this.origin.z;var n=t*t+i*i+r*r;var o=e.radius*e.radius;if(n<=o){return true}var s=t*this.direction.x+i*this.direction.y+r*this.direction.z;if(s<0){return false}var a=n-s*s;return a<=o};t.prototype.intersectsTriangle=function(t,i,r){if(!this._edge1){this._edge1=e.Vector3.Zero();this._edge2=e.Vector3.Zero();this._pvec=e.Vector3.Zero();this._tvec=e.Vector3.Zero();this._qvec=e.Vector3.Zero()}i.subtractToRef(t,this._edge1);r.subtractToRef(t,this._edge2);e.Vector3.CrossToRef(this.direction,this._edge2,this._pvec);var n=e.Vector3.Dot(this._edge1,this._pvec);if(n===0){return null}var o=1/n;this.origin.subtractToRef(t,this._tvec);var s=e.Vector3.Dot(this._tvec,this._pvec)*o;if(s<0||s>1){return null}e.Vector3.CrossToRef(this._tvec,this._edge1,this._qvec);var a=e.Vector3.Dot(this.direction,this._qvec)*o;if(a<0||s+a>1){return null}var u=e.Vector3.Dot(this._edge2,this._qvec)*o;if(u>this.length){return null}return new e.IntersectionInfo(s,a,u)};t.prototype.intersectsPlane=function(t){var i;var r=e.Vector3.Dot(t.normal,this.direction);if(Math.abs(r)<9.99999997475243e-7){return null}else{var n=e.Vector3.Dot(t.normal,this.origin);i=(-t.d-n)/r;if(i<0){if(i<-9.99999997475243e-7){return null}else{return 0}}return i}};t.prototype.intersectsMesh=function(i,r){var n=e.Tmp.Matrix[0];i.getWorldMatrix().invertToRef(n);if(this._tmpRay){t.TransformToRef(this,n,this._tmpRay)}else{this._tmpRay=t.Transform(this,n)}return i.intersects(this._tmpRay,r)};t.prototype.intersectsMeshes=function(e,t,i){if(i){i.length=0}else{i=[]}for(var r=0;r<e.length;r++){var n=this.intersectsMesh(e[r],t);if(n.hit){i.push(n)}}i.sort(this._comparePickingInfo);return i};t.prototype._comparePickingInfo=function(e,t){if(e.distance<t.distance){return-1}else if(e.distance>t.distance){return 1}else{return 0}};t.prototype.intersectionSegment=function(i,r,n){var o=this.origin.add(this.direction.multiplyByFloats(t.rayl,t.rayl,t.rayl));var s=r.subtract(i);var a=o.subtract(this.origin);var u=i.subtract(this.origin);var l=e.Vector3.Dot(s,s);var c=e.Vector3.Dot(s,a);var h=e.Vector3.Dot(a,a);var f=e.Vector3.Dot(s,u);var d=e.Vector3.Dot(a,u);var p=l*h-c*c;var _,m,g=p;var v,y,b=p;if(p<t.smallnum){m=0;g=1;y=d;b=h}else{m=c*d-h*f;y=l*d-c*f;if(m<0){m=0;y=d;b=h}else if(m>g){m=g;y=d+c;b=h}}if(y<0){y=0;if(-f<0){m=0}else if(-f>l)m=g;else{m=-f;g=l}}else if(y>b){y=b;if(-f+c<0){m=0}else if(-f+c>l){m=g}else{m=-f+c;g=l}}_=Math.abs(m)<t.smallnum?0:m/g;v=Math.abs(y)<t.smallnum?0:y/b;var x=a.multiplyByFloats(v,v,v);var T=u.add(s.multiplyByFloats(_,_,_)).subtract(x);var E=v>0&&v<=this.length&&T.lengthSquared()<n*n;if(E){return x.length()}return-1};t.prototype.update=function(t,i,r,n,o,s,a){e.Vector3.UnprojectFloatsToRef(t,i,0,r,n,o,s,a,this.origin);e.Vector3.UnprojectFloatsToRef(t,i,1,r,n,o,s,a,e.Tmp.Vector3[0]);e.Tmp.Vector3[0].subtractToRef(this.origin,this.direction);this.direction.normalize();return this};t.Zero=function(){return new t(e.Vector3.Zero(),e.Vector3.Zero())};t.CreateNew=function(e,i,r,n,o,s,a){var u=t.Zero();return u.update(e,i,r,n,o,s,a)};t.CreateNewFromTo=function(i,r,n){if(n===void 0){n=e.Matrix.Identity()}var o=r.subtract(i);var s=Math.sqrt(o.x*o.x+o.y*o.y+o.z*o.z);o.normalize();return t.Transform(new t(i,o,s),n)};t.Transform=function(i,r){var n=new t(new e.Vector3(0,0,0),new e.Vector3(0,0,0));t.TransformToRef(i,r,n);return n};t.TransformToRef=function(t,i,r){e.Vector3.TransformCoordinatesToRef(t.origin,i,r.origin);e.Vector3.TransformNormalToRef(t.direction,i,r.direction);r.length=t.length;var n=r.direction;var o=n.length();if(!(o===0||o===1)){var s=1/o;n.x*=s;n.y*=s;n.z*=s;r.length*=o}};t.smallnum=1e-8;t.rayl=1e9;return t}();e.Ray=t})(r||(r={}));"use strict";var r;(function(e){var t=function(e,t,i,r){if(e.x>i.x+r)return false;if(i.x-r>t.x)return false;if(e.y>i.y+r)return false;if(i.y-r>t.y)return false;if(e.z>i.z+r)return false;if(i.z-r>t.z)return false;return true};var i=function(){var e={root:0,found:false};return function(t,i,r,n){e.root=0;e.found=false;var o=i*i-4*t*r;if(o<0)return e;var s=Math.sqrt(o);var a=(-i-s)/(2*t);var u=(-i+s)/(2*t);if(a>u){var l=u;u=a;a=l}if(a>0&&a<n){e.root=a;e.found=true;return e}if(u>0&&u<n){e.root=u;e.found=true;return e}return e}}();var r=function(){function r(){this._collisionPoint=e.Vector3.Zero();this._planeIntersectionPoint=e.Vector3.Zero();this._tempVector=e.Vector3.Zero();this._tempVector2=e.Vector3.Zero();this._tempVector3=e.Vector3.Zero();this._tempVector4=e.Vector3.Zero();this._edge=e.Vector3.Zero();this._baseToVertex=e.Vector3.Zero();this._destinationPoint=e.Vector3.Zero();this._slidePlaneNormal=e.Vector3.Zero();this._displacementVector=e.Vector3.Zero();this._radius=e.Vector3.One();this._retry=0;this._basePointWorld=e.Vector3.Zero();this._velocityWorld=e.Vector3.Zero();this._normalizedVelocity=e.Vector3.Zero();this._collisionMask=-1}Object.defineProperty(r.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(e){this._collisionMask=!isNaN(e)?e:-1},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"slidePlaneNormal",{get:function(){return this._slidePlaneNormal},enumerable:true,configurable:true});r.prototype._initialize=function(t,i,r){this._velocity=i;e.Vector3.NormalizeToRef(i,this._normalizedVelocity);this._basePoint=t;t.multiplyToRef(this._radius,this._basePointWorld);i.multiplyToRef(this._radius,this._velocityWorld);this._velocityWorldLength=this._velocityWorld.length();this._epsilon=r;this.collisionFound=false};r.prototype._checkPointInTriangle=function(t,i,r,n,o){i.subtractToRef(t,this._tempVector);r.subtractToRef(t,this._tempVector2);e.Vector3.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);var s=e.Vector3.Dot(this._tempVector4,o);if(s<0)return false;n.subtractToRef(t,this._tempVector3);e.Vector3.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4);s=e.Vector3.Dot(this._tempVector4,o);if(s<0)return false;e.Vector3.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4);s=e.Vector3.Dot(this._tempVector4,o);return s>=0};r.prototype._canDoCollision=function(i,r,n,o){var s=e.Vector3.Distance(this._basePointWorld,i);var a=Math.max(this._radius.x,this._radius.y,this._radius.z);if(s>this._velocityWorldLength+a+r){return false}if(!t(n,o,this._basePointWorld,this._velocityWorldLength+a))return false;return true};r.prototype._testTriangle=function(t,r,n,o,s,a){var u;var l=false;if(!r){r=[]}if(!r[t]){r[t]=new e.Plane(0,0,0,0);r[t].copyFromPoints(n,o,s)}var c=r[t];if(!a&&!c.isFrontFacingTo(this._normalizedVelocity,0))return;var h=c.signedDistanceTo(this._basePoint);var f=e.Vector3.Dot(c.normal,this._velocity);if(f==0){if(Math.abs(h)>=1)return;l=true;u=0}else{u=(-1-h)/f;var d=(1-h)/f;if(u>d){var p=d;d=u;u=p}if(u>1||d<0)return;if(u<0)u=0;if(u>1)u=1}this._collisionPoint.copyFromFloats(0,0,0);var _=false;var m=1;if(!l){this._basePoint.subtractToRef(c.normal,this._planeIntersectionPoint);this._velocity.scaleToRef(u,this._tempVector);this._planeIntersectionPoint.addInPlace(this._tempVector);if(this._checkPointInTriangle(this._planeIntersectionPoint,n,o,s,c.normal)){_=true;m=u;this._collisionPoint.copyFrom(this._planeIntersectionPoint)}}if(!_){var g=this._velocity.lengthSquared();var v=g;this._basePoint.subtractToRef(n,this._tempVector);var y=2*e.Vector3.Dot(this._velocity,this._tempVector);var b=this._tempVector.lengthSquared()-1;var x=i(v,y,b,m);if(x.found){m=x.root;_=true;this._collisionPoint.copyFrom(n)}this._basePoint.subtractToRef(o,this._tempVector);y=2*e.Vector3.Dot(this._velocity,this._tempVector);b=this._tempVector.lengthSquared()-1;x=i(v,y,b,m);if(x.found){m=x.root;_=true;this._collisionPoint.copyFrom(o)}this._basePoint.subtractToRef(s,this._tempVector);y=2*e.Vector3.Dot(this._velocity,this._tempVector);b=this._tempVector.lengthSquared()-1;x=i(v,y,b,m);if(x.found){m=x.root;_=true;this._collisionPoint.copyFrom(s)}o.subtractToRef(n,this._edge);n.subtractToRef(this._basePoint,this._baseToVertex);var T=this._edge.lengthSquared();var E=e.Vector3.Dot(this._edge,this._velocity);var P=e.Vector3.Dot(this._edge,this._baseToVertex);v=T*-g+E*E;y=T*(2*e.Vector3.Dot(this._velocity,this._baseToVertex))-2*E*P;b=T*(1-this._baseToVertex.lengthSquared())+P*P;x=i(v,y,b,m);if(x.found){var A=(E*x.root-P)/T;if(A>=0&&A<=1){m=x.root;_=true;this._edge.scaleInPlace(A);n.addToRef(this._edge,this._collisionPoint)}}s.subtractToRef(o,this._edge);o.subtractToRef(this._basePoint,this._baseToVertex);T=this._edge.lengthSquared();E=e.Vector3.Dot(this._edge,this._velocity);P=e.Vector3.Dot(this._edge,this._baseToVertex);v=T*-g+E*E;y=T*(2*e.Vector3.Dot(this._velocity,this._baseToVertex))-2*E*P;b=T*(1-this._baseToVertex.lengthSquared())+P*P;x=i(v,y,b,m);if(x.found){A=(E*x.root-P)/T;if(A>=0&&A<=1){m=x.root;_=true;this._edge.scaleInPlace(A);o.addToRef(this._edge,this._collisionPoint)}}n.subtractToRef(s,this._edge);s.subtractToRef(this._basePoint,this._baseToVertex);T=this._edge.lengthSquared();E=e.Vector3.Dot(this._edge,this._velocity);P=e.Vector3.Dot(this._edge,this._baseToVertex);v=T*-g+E*E;y=T*(2*e.Vector3.Dot(this._velocity,this._baseToVertex))-2*E*P;b=T*(1-this._baseToVertex.lengthSquared())+P*P;x=i(v,y,b,m);if(x.found){A=(E*x.root-P)/T;if(A>=0&&A<=1){m=x.root;_=true;this._edge.scaleInPlace(A);s.addToRef(this._edge,this._collisionPoint)}}}if(_){var M=m*this._velocity.length();if(!this.collisionFound||M<this._nearestDistance){if(!this.intersectionPoint){this.intersectionPoint=this._collisionPoint.clone()}else{this.intersectionPoint.copyFrom(this._collisionPoint)}this._nearestDistance=M;this.collisionFound=true}}};r.prototype._collide=function(e,t,i,r,n,o,s){for(var a=r;a<n;a+=3){var u=t[i[a]-o];var l=t[i[a+1]-o];var c=t[i[a+2]-o];this._testTriangle(a,e,c,l,u,s)}};r.prototype._getResponse=function(t,i){t.addToRef(i,this._destinationPoint);i.scaleInPlace(this._nearestDistance/i.length());this._basePoint.addToRef(i,t);t.subtractToRef(this.intersectionPoint,this._slidePlaneNormal);this._slidePlaneNormal.normalize();this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector);t.addInPlace(this._displacementVector);this.intersectionPoint.addInPlace(this._displacementVector);this._slidePlaneNormal.scaleInPlace(e.Plane.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint));this._destinationPoint.subtractInPlace(this._slidePlaneNormal);this._destinationPoint.subtractToRef(this.intersectionPoint,i)};return r}();e.Collider=r})(r||(r={}));"use strict";var r;(function(e){e.CollisionWorker="";var t;(function(e){e[e["INIT"]=0]="INIT";e[e["UPDATE"]=1]="UPDATE";e[e["COLLIDE"]=2]="COLLIDE"})(t=e.WorkerTaskType||(e.WorkerTaskType={}));var i;(function(e){e[e["SUCCESS"]=0]="SUCCESS";e[e["UNKNOWN_ERROR"]=1]="UNKNOWN_ERROR"})(i=e.WorkerReplyType||(e.WorkerReplyType={}));var r=function(){function r(){var n=this;this._scaledPosition=e.Vector3.Zero();this._scaledVelocity=e.Vector3.Zero();this.onMeshUpdated=function(e){n._addUpdateMeshesList[e.uniqueId]=r.SerializeMesh(e)};this.onGeometryUpdated=function(e){n._addUpdateGeometriesList[e.id]=r.SerializeGeometry(e)};this._afterRender=function(){if(!n._init)return;if(n._toRemoveGeometryArray.length==0&&n._toRemoveMeshesArray.length==0&&Object.keys(n._addUpdateGeometriesList).length==0&&Object.keys(n._addUpdateMeshesList).length==0){return}if(n._runningUpdated>4){return}++n._runningUpdated;var e={updatedMeshes:n._addUpdateMeshesList,updatedGeometries:n._addUpdateGeometriesList,removedGeometries:n._toRemoveGeometryArray,removedMeshes:n._toRemoveMeshesArray};var i={payload:e,taskType:t.UPDATE};var r=[];for(var o in e.updatedGeometries){if(e.updatedGeometries.hasOwnProperty(o)){r.push(i.payload.updatedGeometries[o].indices.buffer);r.push(i.payload.updatedGeometries[o].normals.buffer);r.push(i.payload.updatedGeometries[o].positions.buffer)}}n._worker.postMessage(i,r);n._addUpdateMeshesList={};n._addUpdateGeometriesList={};n._toRemoveGeometryArray=[];n._toRemoveMeshesArray=[]};this._onMessageFromWorker=function(r){var o=r.data;if(o.error!=i.SUCCESS){e.Tools.Warn("error returned from worker!");return}switch(o.taskType){case t.INIT:n._init=true;n._scene.meshes.forEach(function(e){n.onMeshAdded(e)});n._scene.getGeometries().forEach(function(e){n.onGeometryAdded(e)});break;case t.UPDATE:n._runningUpdated--;break;case t.COLLIDE:var s=o.payload;if(!n._collisionsCallbackArray[s.collisionId])return;var a=n._collisionsCallbackArray[s.collisionId];if(a){var u=n._scene.getMeshByUniqueID(s.collidedMeshUniqueId);if(u){a(s.collisionId,e.Vector3.FromArray(s.newPosition),u)}}n._collisionsCallbackArray[s.collisionId]=null;break}};this._collisionsCallbackArray=[];this._init=false;this._runningUpdated=0;this._addUpdateMeshesList={};this._addUpdateGeometriesList={};this._toRemoveGeometryArray=[];this._toRemoveMeshesArray=[]}r.prototype.getNewPosition=function(e,i,r,n,o,s,a){if(!this._init)return;if(this._collisionsCallbackArray[a]||this._collisionsCallbackArray[a+1e5])return;e.divideToRef(r._radius,this._scaledPosition);i.divideToRef(r._radius,this._scaledVelocity);this._collisionsCallbackArray[a]=s;var u={collider:{position:this._scaledPosition.asArray(),velocity:this._scaledVelocity.asArray(),radius:r._radius.asArray()},collisionId:a,excludedMeshUniqueId:o?o.uniqueId:null,maximumRetry:n};var l={payload:u,taskType:t.COLLIDE};this._worker.postMessage(l)};r.prototype.init=function(i){this._scene=i;this._scene.registerAfterRender(this._afterRender);var r=e.WorkerIncluded?e.Engine.CodeRepository+"Collisions/babylon.collisionWorker.js":URL.createObjectURL(new Blob([e.CollisionWorker],{type:"application/javascript"}));this._worker=new Worker(r);this._worker.onmessage=this._onMessageFromWorker;var n={payload:{},taskType:t.INIT};this._worker.postMessage(n)};r.prototype.destroy=function(){this._scene.unregisterAfterRender(this._afterRender);this._worker.terminate()};r.prototype.onMeshAdded=function(e){e.registerAfterWorldMatrixUpdate(this.onMeshUpdated);this.onMeshUpdated(e)};r.prototype.onMeshRemoved=function(e){this._toRemoveMeshesArray.push(e.uniqueId)};r.prototype.onGeometryAdded=function(e){e.onGeometryUpdated=this.onGeometryUpdated;this.onGeometryUpdated(e)};r.prototype.onGeometryDeleted=function(e){this._toRemoveGeometryArray.push(e.id)};r.SerializeMesh=function(t){var i=[];if(t.subMeshes){i=t.subMeshes.map(function(e,t){var i=e.getBoundingInfo();return{position:t,verticesStart:e.verticesStart,verticesCount:e.verticesCount,indexStart:e.indexStart,indexCount:e.indexCount,hasMaterial:!!e.getMaterial(),sphereCenter:i.boundingSphere.centerWorld.asArray(),sphereRadius:i.boundingSphere.radiusWorld,boxMinimum:i.boundingBox.minimumWorld.asArray(),boxMaximum:i.boundingBox.maximumWorld.asArray()}})}var r=null;if(t instanceof e.Mesh){var n=t.geometry;r=n?n.id:null}else if(t instanceof e.InstancedMesh){var n=t.sourceMesh&&t.sourceMesh.geometry;r=n?n.id:null}var o=t.getBoundingInfo();return{uniqueId:t.uniqueId,id:t.id,name:t.name,geometryId:r,sphereCenter:o.boundingSphere.centerWorld.asArray(),sphereRadius:o.boundingSphere.radiusWorld,boxMinimum:o.boundingBox.minimumWorld.asArray(),boxMaximum:o.boundingBox.maximumWorld.asArray(),worldMatrixFromCache:t.worldMatrixFromCache.asArray(),subMeshes:i,checkCollisions:t.checkCollisions}};r.SerializeGeometry=function(t){return{id:t.id,positions:new Float32Array(t.getVerticesData(e.VertexBuffer.PositionKind)||[]),normals:new Float32Array(t.getVerticesData(e.VertexBuffer.NormalKind)||[]),indices:new Uint32Array(t.getIndices()||[])}};return r}();e.CollisionCoordinatorWorker=r;var n=function(){function t(){this._scaledPosition=e.Vector3.Zero();this._scaledVelocity=e.Vector3.Zero();this._finalPosition=e.Vector3.Zero()}t.prototype.getNewPosition=function(e,t,i,r,n,o,s){e.divideToRef(i._radius,this._scaledPosition);t.divideToRef(i._radius,this._scaledVelocity);i.collidedMesh=null;i._retry=0;i._initialVelocity=this._scaledVelocity;i._initialPosition=this._scaledPosition;this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,n);this._finalPosition.multiplyInPlace(i._radius);o(s,this._finalPosition,i.collidedMesh)};t.prototype.init=function(e){this._scene=e};t.prototype.destroy=function(){};t.prototype.onMeshAdded=function(e){};t.prototype.onMeshUpdated=function(e){};t.prototype.onMeshRemoved=function(e){};t.prototype.onGeometryAdded=function(e){};t.prototype.onGeometryUpdated=function(e){};t.prototype.onGeometryDeleted=function(e){};t.prototype._collideWithWorld=function(t,i,r,n,o,s){if(s===void 0){s=null}var a=e.Engine.CollisionsEpsilon*10;if(r._retry>=n){o.copyFrom(t);return}var u=s?s.collisionMask:r.collisionMask;r._initialize(t,i,a);for(var l=0;l<this._scene.meshes.length;l++){var c=this._scene.meshes[l];if(c.isEnabled()&&c.checkCollisions&&c.subMeshes&&c!==s&&(u&c.collisionGroup)!==0){c._checkCollision(r)}}if(!r.collisionFound){t.addToRef(i,o);return}if(i.x!==0||i.y!==0||i.z!==0){r._getResponse(t,i)}if(i.length()<=a){o.copyFrom(t);return}r._retry++;this._collideWithWorld(t,i,r,n,o,s)};return t}();e.CollisionCoordinatorLegacy=n})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t){this.particleSystem=t;this.position=e.Vector3.Zero();this.direction=e.Vector3.Zero();this.color=new e.Color4(0,0,0,0);this.colorStep=new e.Color4(0,0,0,0);this.lifeTime=1;this.age=0;this.size=0;this.angle=0;this.angularSpeed=0;this.cellIndex=0;this._currentFrameCounter=0;if(!this.particleSystem.isAnimationSheetEnabled){return}this.updateCellInfoFromSystem()}t.prototype.updateCellInfoFromSystem=function(){this.cellIndex=this.particleSystem.startSpriteCellID;if(this.particleSystem.spriteCellChangeSpeed==0){this.updateCellIndex=this._updateCellIndexWithSpeedCalculated}else{this.updateCellIndex=this._updateCellIndexWithCustomSpeed}};t.prototype._updateCellIndexWithSpeedCalculated=function(e){var t=(this.lifeTime-this.age)/e/(this.particleSystem.endSpriteCellID+1-this.cellIndex);this._currentFrameCounter+=e;if(this._currentFrameCounter>=t*e){this._currentFrameCounter=0;this.cellIndex++;if(this.cellIndex>this.particleSystem.endSpriteCellID){this.cellIndex=this.particleSystem.endSpriteCellID}}};t.prototype._updateCellIndexWithCustomSpeed=function(){if(this._currentFrameCounter>=this.particleSystem.spriteCellChangeSpeed){this.cellIndex++;this._currentFrameCounter=0;if(this.cellIndex>this.particleSystem.endSpriteCellID){if(this.particleSystem.spriteCellLoop){this.cellIndex=this.particleSystem.startSpriteCellID}else{this.cellIndex=this.particleSystem.endSpriteCellID}}}else{this._currentFrameCounter++}};t.prototype.copyTo=function(e){e.position.copyFrom(this.position);e.direction.copyFrom(this.direction);e.color.copyFrom(this.color);e.colorStep.copyFrom(this.colorStep);e.lifeTime=this.lifeTime;e.age=this.age;e.size=this.size;e.angle=this.angle;e.angularSpeed=this.angularSpeed;e.particleSystem=this.particleSystem;e.cellIndex=this.cellIndex};return t}();e.Particle=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(i,r,n,o,s,a){if(o===void 0){o=null}if(s===void 0){s=false}if(a===void 0){a=.01}var u=this;this.animations=[];this.renderingGroupId=0;this.emitter=null;this.emitRate=10;this.manualEmitCount=-1;this.updateSpeed=.01;this.targetStopDuration=0;this.disposeOnStop=false;this.minEmitPower=1;this.maxEmitPower=1;this.minLifeTime=1;this.maxLifeTime=1;this.minSize=1;this.maxSize=1;this.minAngularSpeed=0;this.maxAngularSpeed=0;this.layerMask=268435455;this.customShader=null;this.preventAutoStart=false;this.onAnimationEnd=null;this.blendMode=t.BLENDMODE_ONEONE;this.forceDepthWrite=false;this.gravity=e.Vector3.Zero();this.color1=new e.Color4(1,1,1,1);this.color2=new e.Color4(1,1,1,1);this.colorDead=new e.Color4(0,0,0,1);this.textureMask=new e.Color4(1,1,1,1);this.spriteCellLoop=true;this.spriteCellChangeSpeed=0;this.startSpriteCellID=0;this.endSpriteCellID=0;this.spriteCellWidth=0;this.spriteCellHeight=0;this.onDisposeObservable=new e.Observable;this._particles=new Array;this._stockParticles=new Array;this._newPartsExcess=0;this._vertexBuffers={};this._scaledColorStep=new e.Color4(0,0,0,0);this._colorDiff=new e.Color4(0,0,0,0);this._scaledDirection=e.Vector3.Zero();this._scaledGravity=e.Vector3.Zero();this._currentRenderId=-1;this._started=false;this._stopped=false;this._actualFrame=0;this._vertexBufferSize=11;this.recycleParticle=function(e){var t=u._particles.pop();if(t!==e){t.copyTo(e)}u._stockParticles.push(t)};this._createParticle=function(){var t;if(u._stockParticles.length!==0){t=u._stockParticles.pop();t.age=0;t.cellIndex=u.startSpriteCellID}else{t=new e.Particle(u)}return t};this._emitFromParticle=function(e){if(!u.subEmitters||u.subEmitters.length===0){return}var t=Math.floor(Math.random()*u.subEmitters.length);var i=u.subEmitters[t].clone(u.name+"_sub",e.position.clone());i._rootParticleSystem=u;u.activeSubSystems.push(i);i.start()};this._appendParticleVertexes=null;this.id=i;this.name=i;this._capacity=r;this._epsilon=a;this._isAnimationSheetEnabled=s;if(s){this._vertexBufferSize=12}this._scene=n||e.Engine.LastCreatedScene;this._customEffect=o;n.particleSystems.push(this);this._createIndexBuffer();this._vertexData=new Float32Array(r*this._vertexBufferSize*4);this._vertexBuffer=new e.Buffer(n.getEngine(),this._vertexData,true,this._vertexBufferSize);var l=this._vertexBuffer.createVertexBuffer(e.VertexBuffer.PositionKind,0,3);var c=this._vertexBuffer.createVertexBuffer(e.VertexBuffer.ColorKind,3,4);var h=this._vertexBuffer.createVertexBuffer("options",7,4);if(this._isAnimationSheetEnabled){var f=this._vertexBuffer.createVertexBuffer("cellIndex",11,1);this._vertexBuffers["cellIndex"]=f}this._vertexBuffers[e.VertexBuffer.PositionKind]=l;this._vertexBuffers[e.VertexBuffer.ColorKind]=c;this._vertexBuffers["options"]=h;this.particleEmitterType=new e.BoxParticleEmitter;this.updateFunction=function(e){for(var t=0;t<e.length;t++){var i=e[t];i.age+=u._scaledUpdateSpeed;if(i.age>=i.lifeTime){u._emitFromParticle(i);u.recycleParticle(i);t--;continue}else{i.colorStep.scaleToRef(u._scaledUpdateSpeed,u._scaledColorStep);i.color.addInPlace(u._scaledColorStep);if(i.color.a<0)i.color.a=0;i.angle+=i.angularSpeed*u._scaledUpdateSpeed;i.direction.scaleToRef(u._scaledUpdateSpeed,u._scaledDirection);i.position.addInPlace(u._scaledDirection);u.gravity.scaleToRef(u._scaledUpdateSpeed,u._scaledGravity);i.direction.addInPlace(u._scaledGravity);if(u._isAnimationSheetEnabled){i.updateCellIndex(u._scaledUpdateSpeed)}}}}}Object.defineProperty(t.prototype,"direction1",{get:function(){if(this.particleEmitterType.direction1){return this.particleEmitterType.direction1}return e.Vector3.Zero()},set:function(e){if(this.particleEmitterType.direction1){this.particleEmitterType.direction1=e}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"direction2",{get:function(){if(this.particleEmitterType.direction2){return this.particleEmitterType.direction2}return e.Vector3.Zero()},set:function(e){if(this.particleEmitterType.direction2){this.particleEmitterType.direction2=e}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"minEmitBox",{get:function(){if(this.particleEmitterType.minEmitBox){return this.particleEmitterType.minEmitBox}return e.Vector3.Zero()},set:function(e){if(this.particleEmitterType.minEmitBox){this.particleEmitterType.minEmitBox=e}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"maxEmitBox",{get:function(){if(this.particleEmitterType.maxEmitBox){return this.particleEmitterType.maxEmitBox}return e.Vector3.Zero()},set:function(e){if(this.particleEmitterType.maxEmitBox){this.particleEmitterType.maxEmitBox=e}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"onDispose",{set:function(e){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"isAnimationSheetEnabled",{get:function(){return this._isAnimationSheetEnabled},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"particles",{get:function(){return this._particles},enumerable:true,configurable:true});t.prototype.getClassName=function(){return"ParticleSystem"};t.prototype._createIndexBuffer=function(){var e=[];var t=0;for(var i=0;i<this._capacity;i++){e.push(t);e.push(t+1);e.push(t+2);e.push(t);e.push(t+2);e.push(t+3);t+=4}this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)};t.prototype.getCapacity=function(){return this._capacity};t.prototype.isAlive=function(){return this._alive};t.prototype.isStarted=function(){return this._started};t.prototype.start=function(){this._started=true;this._stopped=false;this._actualFrame=0;if(this.subEmitters&&this.subEmitters.length!=0){this.activeSubSystems=new Array}};t.prototype.stop=function(e){if(e===void 0){e=true}this._stopped=true;if(e){this._stopSubEmitters()}};t.prototype.reset=function(){this._stockParticles=[];this._particles=[]};t.prototype._appendParticleVertex=function(e,t,i,r){var n=e*this._vertexBufferSize;this._vertexData[n]=t.position.x;this._vertexData[n+1]=t.position.y;this._vertexData[n+2]=t.position.z;this._vertexData[n+3]=t.color.r;this._vertexData[n+4]=t.color.g;this._vertexData[n+5]=t.color.b;this._vertexData[n+6]=t.color.a;this._vertexData[n+7]=t.angle;this._vertexData[n+8]=t.size;this._vertexData[n+9]=i;this._vertexData[n+10]=r};t.prototype._appendParticleVertexWithAnimation=function(e,t,i,r){if(i===0)i=this._epsilon;else if(i===1)i=1-this._epsilon;if(r===0)r=this._epsilon;else if(r===1)r=1-this._epsilon;var n=e*this._vertexBufferSize;this._vertexData[n]=t.position.x;this._vertexData[n+1]=t.position.y;this._vertexData[n+2]=t.position.z;this._vertexData[n+3]=t.color.r;this._vertexData[n+4]=t.color.g;this._vertexData[n+5]=t.color.b;this._vertexData[n+6]=t.color.a;this._vertexData[n+7]=t.angle;this._vertexData[n+8]=t.size;this._vertexData[n+9]=i;this._vertexData[n+10]=r;this._vertexData[n+11]=t.cellIndex};t.prototype._stopSubEmitters=function(){if(!this.activeSubSystems){return}this.activeSubSystems.forEach(function(e){e.stop(true)});this.activeSubSystems=new Array};t.prototype._removeFromRoot=function(){if(!this._rootParticleSystem){return}var e=this._rootParticleSystem.activeSubSystems.indexOf(this);if(e!==-1){this._rootParticleSystem.activeSubSystems.splice(e,1)}};t.prototype._update=function(t){this._alive=this._particles.length>0;this.updateFunction(this._particles);var i;if(this.emitter.position){var r=this.emitter;i=r.getWorldMatrix()}else{var n=this.emitter;i=e.Matrix.Translation(n.x,n.y,n.z)}var o;for(var s=0;s<t;s++){if(this._particles.length===this._capacity){break}o=this._createParticle();this._particles.push(o);var a=e.Scalar.RandomRange(this.minEmitPower,this.maxEmitPower);if(this.startPositionFunction){this.startPositionFunction(i,o.position,o)}else{this.particleEmitterType.startPositionFunction(i,o.position,o)}if(this.startDirectionFunction){this.startDirectionFunction(a,i,o.direction,o)}else{this.particleEmitterType.startDirectionFunction(a,i,o.direction,o)}o.lifeTime=e.Scalar.RandomRange(this.minLifeTime,this.maxLifeTime);o.size=e.Scalar.RandomRange(this.minSize,this.maxSize);o.angularSpeed=e.Scalar.RandomRange(this.minAngularSpeed,this.maxAngularSpeed);var u=e.Scalar.RandomRange(0,1);e.Color4.LerpToRef(this.color1,this.color2,u,o.color);this.colorDead.subtractToRef(o.color,this._colorDiff);this._colorDiff.scaleToRef(1/o.lifeTime,o.colorStep)}};t.prototype._getEffect=function(){if(this._customEffect){return this._customEffect}var t=[];if(this._scene.clipPlane){t.push("#define CLIPPLANE")}if(this._isAnimationSheetEnabled){t.push("#define ANIMATESHEET")}var i=t.join("\n");if(this._cachedDefines!==i){this._cachedDefines=i;var r;var n;if(this._isAnimationSheetEnabled){r=[e.VertexBuffer.PositionKind,e.VertexBuffer.ColorKind,"options","cellIndex"];n=["invView","view","projection","particlesInfos","vClipPlane","textureMask"]}else{r=[e.VertexBuffer.PositionKind,e.VertexBuffer.ColorKind,"options"];n=["invView","view","projection","vClipPlane","textureMask"]}this._effect=this._scene.getEngine().createEffect("particles",r,n,["diffuseSampler"],i)}return this._effect};t.prototype.animate=function(){if(!this._started)return;var e=this._getEffect();if(!this.emitter||!e.isReady()||!this.particleTexture||!this.particleTexture.isReady())return;if(this._currentRenderId===this._scene.getRenderId()){return}this._currentRenderId=this._scene.getRenderId();this._scaledUpdateSpeed=this.updateSpeed*this._scene.getAnimationRatio();var t;if(this.manualEmitCount>-1){t=this.manualEmitCount;this._newPartsExcess=0;this.manualEmitCount=0}else{t=this.emitRate*this._scaledUpdateSpeed>>0;this._newPartsExcess+=this.emitRate*this._scaledUpdateSpeed-t}if(this._newPartsExcess>1){t+=this._newPartsExcess>>0;this._newPartsExcess-=this._newPartsExcess>>0}this._alive=false;if(!this._stopped){this._actualFrame+=this._scaledUpdateSpeed;if(this.targetStopDuration&&this._actualFrame>=this.targetStopDuration)this.stop()}else{t=0}this._update(t);if(this._stopped){if(!this._alive){this._started=false;if(this.onAnimationEnd){this.onAnimationEnd()}if(this.disposeOnStop){this._scene._toBeDisposed.push(this)}}}if(this._isAnimationSheetEnabled){this._appendParticleVertexes=this._appenedParticleVertexesWithSheet}else{this._appendParticleVertexes=this._appenedParticleVertexesNoSheet}var i=0;for(var r=0;r<this._particles.length;r++){var n=this._particles[r];this._appendParticleVertexes(i,n);i+=4}if(this._vertexBuffer){this._vertexBuffer.update(this._vertexData)}if(this.manualEmitCount===0&&this.disposeOnStop){this.stop()}};t.prototype._appenedParticleVertexesWithSheet=function(e,t){this._appendParticleVertexWithAnimation(e++,t,0,0)
;this._appendParticleVertexWithAnimation(e++,t,1,0);this._appendParticleVertexWithAnimation(e++,t,1,1);this._appendParticleVertexWithAnimation(e++,t,0,1)};t.prototype._appenedParticleVertexesNoSheet=function(e,t){this._appendParticleVertex(e++,t,0,0);this._appendParticleVertex(e++,t,1,0);this._appendParticleVertex(e++,t,1,1);this._appendParticleVertex(e++,t,0,1)};t.prototype.rebuild=function(){this._createIndexBuffer();if(this._vertexBuffer){this._vertexBuffer._rebuild()}};t.prototype.isReady=function(){var e=this._getEffect();if(!this.emitter||!e.isReady()||!this.particleTexture||!this.particleTexture.isReady()){return false}return true};t.prototype.render=function(){var i=this._getEffect();if(!this.isReady()||!this._particles.length){return 0}var r=this._scene.getEngine();r.enableEffect(i);r.setState(false);var n=this._scene.getViewMatrix();i.setTexture("diffuseSampler",this.particleTexture);i.setMatrix("view",n);i.setMatrix("projection",this._scene.getProjectionMatrix());if(this._isAnimationSheetEnabled&&this.particleTexture){var o=this.particleTexture.getBaseSize();i.setFloat3("particlesInfos",this.spriteCellWidth/o.width,this.spriteCellHeight/o.height,o.width/this.spriteCellWidth)}i.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a);if(this._scene.clipPlane){var s=this._scene.clipPlane;var a=n.clone();a.invert();i.setMatrix("invView",a);i.setFloat4("vClipPlane",s.normal.x,s.normal.y,s.normal.z,s.d)}r.bindBuffers(this._vertexBuffers,this._indexBuffer,i);if(this.blendMode===t.BLENDMODE_ONEONE){r.setAlphaMode(e.Engine.ALPHA_ONEONE)}else{r.setAlphaMode(e.Engine.ALPHA_COMBINE)}if(this.forceDepthWrite){r.setDepthWrite(true)}r.drawElementsType(e.Material.TriangleFillMode,0,this._particles.length*6);r.setAlphaMode(e.Engine.ALPHA_DISABLE);return this._particles.length};t.prototype.dispose=function(e){if(e===void 0){e=true}if(this._vertexBuffer){this._vertexBuffer.dispose();this._vertexBuffer=null}if(this._indexBuffer){this._scene.getEngine()._releaseBuffer(this._indexBuffer);this._indexBuffer=null}if(e&&this.particleTexture){this.particleTexture.dispose();this.particleTexture=null}this._removeFromRoot();var t=this._scene.particleSystems.indexOf(this);if(t>-1){this._scene.particleSystems.splice(t,1)}this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear()};t.prototype.createSphereEmitter=function(t){if(t===void 0){t=1}var i=new e.SphereParticleEmitter(t);this.particleEmitterType=i;return i};t.prototype.createDirectedSphereEmitter=function(t,i,r){if(t===void 0){t=1}if(i===void 0){i=new e.Vector3(0,1,0)}if(r===void 0){r=new e.Vector3(0,1,0)}var n=new e.SphereDirectedParticleEmitter(t,i,r);this.particleEmitterType=n;return n};t.prototype.createConeEmitter=function(t,i){if(t===void 0){t=1}if(i===void 0){i=Math.PI/4}var r=new e.ConeParticleEmitter(t,i);this.particleEmitterType=r;return r};t.prototype.createBoxEmitter=function(t,i,r,n){var o=new e.BoxParticleEmitter;this.particleEmitterType=o;this.direction1=t;this.direction2=i;this.minEmitBox=r;this.maxEmitBox=n;return o};t.prototype.clone=function(i,r){var n=null;var o=null;if(this.customShader!=null){o=this.customShader;var s=o.shaderOptions.defines.length>0?o.shaderOptions.defines.join("\n"):"";n=this._scene.getEngine().createEffectForParticles(o.shaderPath.fragmentElement,o.shaderOptions.uniforms,o.shaderOptions.samplers,s)}var a=new t(i,this._capacity,this._scene,n);a.customShader=o;e.Tools.DeepCopy(this,a,["particles","customShader"]);if(r===undefined){r=this.emitter}a.emitter=r;if(this.particleTexture){a.particleTexture=new e.Texture(this.particleTexture.url,this._scene)}if(!this.preventAutoStart){a.start()}return a};t.prototype.serialize=function(){var t={};t.name=this.name;t.id=this.id;if(this.emitter.position){var i=this.emitter;t.emitterId=i.id}else{var r=this.emitter;t.emitter=r.asArray()}t.capacity=this.getCapacity();if(this.particleTexture){t.textureName=this.particleTexture.name}e.Animation.AppendSerializedAnimations(this,t);t.minAngularSpeed=this.minAngularSpeed;t.maxAngularSpeed=this.maxAngularSpeed;t.minSize=this.minSize;t.maxSize=this.maxSize;t.minEmitPower=this.minEmitPower;t.maxEmitPower=this.maxEmitPower;t.minLifeTime=this.minLifeTime;t.maxLifeTime=this.maxLifeTime;t.emitRate=this.emitRate;t.minEmitBox=this.minEmitBox.asArray();t.maxEmitBox=this.maxEmitBox.asArray();t.gravity=this.gravity.asArray();t.direction1=this.direction1.asArray();t.direction2=this.direction2.asArray();t.color1=this.color1.asArray();t.color2=this.color2.asArray();t.colorDead=this.colorDead.asArray();t.updateSpeed=this.updateSpeed;t.targetStopDuration=this.targetStopDuration;t.textureMask=this.textureMask.asArray();t.blendMode=this.blendMode;t.customShader=this.customShader;t.preventAutoStart=this.preventAutoStart;t.startSpriteCellID=this.startSpriteCellID;t.endSpriteCellID=this.endSpriteCellID;t.spriteCellLoop=this.spriteCellLoop;t.spriteCellChangeSpeed=this.spriteCellChangeSpeed;t.spriteCellWidth=this.spriteCellWidth;t.spriteCellHeight=this.spriteCellHeight;t.isAnimationSheetEnabled=this._isAnimationSheetEnabled;if(this.particleEmitterType){t.particleEmitterType=this.particleEmitterType.serialize()}return t};t.Parse=function(i,r,n){var o=i.name;var s=null;var a=null;if(i.customShader){a=i.customShader;var u=a.shaderOptions.defines.length>0?a.shaderOptions.defines.join("\n"):"";s=r.getEngine().createEffectForParticles(a.shaderPath.fragmentElement,a.shaderOptions.uniforms,a.shaderOptions.samplers,u)}var l=new t(o,i.capacity,r,s,i.isAnimationSheetEnabled);l.customShader=a;if(i.id){l.id=i.id}if(i.preventAutoStart){l.preventAutoStart=i.preventAutoStart}if(i.textureName){l.particleTexture=new e.Texture(n+i.textureName,r);l.particleTexture.name=i.textureName}if(i.emitterId){l.emitter=r.getLastMeshByID(i.emitterId)}else{l.emitter=e.Vector3.FromArray(i.emitter)}if(i.animations){for(var c=0;c<i.animations.length;c++){var h=i.animations[c];l.animations.push(e.Animation.Parse(h))}}if(i.autoAnimate){r.beginAnimation(l,i.autoAnimateFrom,i.autoAnimateTo,i.autoAnimateLoop,i.autoAnimateSpeed||1)}l.minAngularSpeed=i.minAngularSpeed;l.maxAngularSpeed=i.maxAngularSpeed;l.minSize=i.minSize;l.maxSize=i.maxSize;l.minLifeTime=i.minLifeTime;l.maxLifeTime=i.maxLifeTime;l.minEmitPower=i.minEmitPower;l.maxEmitPower=i.maxEmitPower;l.emitRate=i.emitRate;l.minEmitBox=e.Vector3.FromArray(i.minEmitBox);l.maxEmitBox=e.Vector3.FromArray(i.maxEmitBox);l.gravity=e.Vector3.FromArray(i.gravity);l.direction1=e.Vector3.FromArray(i.direction1);l.direction2=e.Vector3.FromArray(i.direction2);l.color1=e.Color4.FromArray(i.color1);l.color2=e.Color4.FromArray(i.color2);l.colorDead=e.Color4.FromArray(i.colorDead);l.updateSpeed=i.updateSpeed;l.targetStopDuration=i.targetStopDuration;l.textureMask=e.Color4.FromArray(i.textureMask);l.blendMode=i.blendMode;l.startSpriteCellID=i.startSpriteCellID;l.endSpriteCellID=i.endSpriteCellID;l.spriteCellLoop=i.spriteCellLoop;l.spriteCellChangeSpeed=i.spriteCellChangeSpeed;l.spriteCellWidth=i.spriteCellWidth;l.spriteCellHeight=i.spriteCellHeight;if(!l.preventAutoStart){l.start()}return l};t.BLENDMODE_ONEONE=0;t.BLENDMODE_STANDARD=1;return t}();e.ParticleSystem=t})(r||(r={}));"use strict";"use strict";var r;(function(e){var t=function(){function t(){this.direction1=new e.Vector3(0,1,0);this.direction2=new e.Vector3(0,1,0);this.minEmitBox=new e.Vector3(-.5,-.5,-.5);this.maxEmitBox=new e.Vector3(.5,.5,.5)}t.prototype.startDirectionFunction=function(t,i,r,n){var o=e.Scalar.RandomRange(this.direction1.x,this.direction2.x);var s=e.Scalar.RandomRange(this.direction1.y,this.direction2.y);var a=e.Scalar.RandomRange(this.direction1.z,this.direction2.z);e.Vector3.TransformNormalFromFloatsToRef(o*t,s*t,a*t,i,r)};t.prototype.startPositionFunction=function(t,i,r){var n=e.Scalar.RandomRange(this.minEmitBox.x,this.maxEmitBox.x);var o=e.Scalar.RandomRange(this.minEmitBox.y,this.maxEmitBox.y);var s=e.Scalar.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);e.Vector3.TransformCoordinatesFromFloatsToRef(n,o,s,t,i)};t.prototype.clone=function(){var i=new t;e.Tools.DeepCopy(this,i);return i};t.prototype.applyToShader=function(e){e.setVector3("direction1",this.direction1);e.setVector3("direction2",this.direction2);e.setVector3("minEmitBox",this.minEmitBox);e.setVector3("maxEmitBox",this.maxEmitBox)};t.prototype.getEffectDefines=function(){return"#define BOXEMITTER"};t.prototype.getClassName=function(){return"BoxEmitter"};t.prototype.serialize=function(){var e={};e.type=this.getClassName();e.direction1=this.direction1.asArray();e.direction2=this.direction2.asArray();e.minEmitBox=this.minEmitBox.asArray();e.maxEmitBox=this.maxEmitBox.asArray();return e};t.prototype.parse=function(e){this.direction1.copyFrom(e.direction1);this.direction2.copyFrom(e.direction2);this.minEmitBox.copyFrom(e.minEmitBox);this.maxEmitBox.copyFrom(e.maxEmitBox)};return t}();e.BoxParticleEmitter=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,t,i){if(e===void 0){e=1}if(t===void 0){t=Math.PI}if(i===void 0){i=0}this.angle=t;this.directionRandomizer=i;this.radius=e}Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},set:function(e){this._radius=e;if(this.angle!==0){this._height=e/Math.tan(this.angle/2)}else{this._height=1}},enumerable:true,configurable:true});t.prototype.startDirectionFunction=function(t,i,r,n){if(this.angle===0){e.Vector3.TransformNormalFromFloatsToRef(0,t,0,i,r)}else{var o=n.position.subtract(i.getTranslation()).normalize();var s=e.Scalar.RandomRange(0,this.directionRandomizer);var a=e.Scalar.RandomRange(0,this.directionRandomizer);var u=e.Scalar.RandomRange(0,this.directionRandomizer);o.x+=s;o.y+=a;o.z+=u;o.normalize();e.Vector3.TransformNormalFromFloatsToRef(o.x*t,o.y*t,o.z*t,i,r)}};t.prototype.startPositionFunction=function(t,i,r){var n=e.Scalar.RandomRange(0,Math.PI*2);var o=e.Scalar.RandomRange(0,1);o=1-o*o;var s=e.Scalar.RandomRange(0,this._radius);s=s*o;var a=s*Math.sin(n);var u=s*Math.cos(n);var l=o*this._height;e.Vector3.TransformCoordinatesFromFloatsToRef(a,l,u,t,i)};t.prototype.clone=function(){var i=new t(this.radius,this.angle,this.directionRandomizer);e.Tools.DeepCopy(this,i);return i};t.prototype.applyToShader=function(e){e.setFloat("radius",this.radius);e.setFloat("angle",this.angle);e.setFloat("height",this._height);e.setFloat("directionRandomizer",this.directionRandomizer)};t.prototype.getEffectDefines=function(){return"#define CONEEMITTER"};t.prototype.getClassName=function(){return"ConeEmitter"};t.prototype.serialize=function(){var e={};e.type=this.getClassName();e.radius=this.radius;e.angle=this.angle;e.directionRandomizer=this.directionRandomizer;return e};t.prototype.parse=function(e){this.radius=e.radius;this.angle=e.angle;this.directionRandomizer=e.directionRandomizer};return t}();e.ConeParticleEmitter=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,t){if(e===void 0){e=1}if(t===void 0){t=0}this.radius=e;this.directionRandomizer=t}t.prototype.startDirectionFunction=function(t,i,r,n){var o=n.position.subtract(i.getTranslation()).normalize();var s=e.Scalar.RandomRange(0,this.directionRandomizer);var a=e.Scalar.RandomRange(0,this.directionRandomizer);var u=e.Scalar.RandomRange(0,this.directionRandomizer);o.x+=s;o.y+=a;o.z+=u;o.normalize();e.Vector3.TransformNormalFromFloatsToRef(o.x*t,o.y*t,o.z*t,i,r)};t.prototype.startPositionFunction=function(t,i,r){var n=e.Scalar.RandomRange(0,2*Math.PI);var o=e.Scalar.RandomRange(0,Math.PI);var s=e.Scalar.RandomRange(0,this.radius);var a=s*Math.cos(n)*Math.sin(o);var u=s*Math.cos(o);var l=s*Math.sin(n)*Math.sin(o);e.Vector3.TransformCoordinatesFromFloatsToRef(a,u,l,t,i)};t.prototype.clone=function(){var i=new t(this.radius,this.directionRandomizer);e.Tools.DeepCopy(this,i);return i};t.prototype.applyToShader=function(e){e.setFloat("radius",this.radius);e.setFloat("directionRandomizer",this.directionRandomizer)};t.prototype.getEffectDefines=function(){return"#define SPHEREEMITTER"};t.prototype.getClassName=function(){return"SphereParticleEmitter"};t.prototype.serialize=function(){var e={};e.type=this.getClassName();e.radius=this.radius;e.directionRandomizer=this.directionRandomizer;return e};t.prototype.parse=function(e){this.radius=e.radius;this.directionRandomizer=e.directionRandomizer};return t}();e.SphereParticleEmitter=t;var i=function(t){__extends(i,t);function i(i,r,n){if(i===void 0){i=1}if(r===void 0){r=new e.Vector3(0,1,0)}if(n===void 0){n=new e.Vector3(0,1,0)}var o=t.call(this,i)||this;o.direction1=r;o.direction2=n;return o}i.prototype.startDirectionFunction=function(t,i,r,n){var o=e.Scalar.RandomRange(this.direction1.x,this.direction2.x);var s=e.Scalar.RandomRange(this.direction1.y,this.direction2.y);var a=e.Scalar.RandomRange(this.direction1.z,this.direction2.z);e.Vector3.TransformNormalFromFloatsToRef(o*t,s*t,a*t,i,r)};i.prototype.clone=function(){var t=new i(this.radius,this.direction1,this.direction2);e.Tools.DeepCopy(this,t);return t};i.prototype.applyToShader=function(e){e.setFloat("radius",this.radius);e.setVector3("direction1",this.direction1);e.setVector3("direction2",this.direction2)};i.prototype.getEffectDefines=function(){return"#define SPHEREEMITTER\n#define DIRECTEDSPHEREEMITTER"};i.prototype.getClassName=function(){return"SphereDirectedParticleEmitter"};i.prototype.serialize=function(){var e=t.prototype.serialize.call(this);e.direction1=this.direction1.asArray();e.direction2=this.direction2.asArray();return e};i.prototype.parse=function(e){t.prototype.parse.call(this,e);this.direction1.copyFrom(e.direction1);this.direction2.copyFrom(e.direction2)};return i}(t);e.SphereDirectedParticleEmitter=i})(r||(r={}));"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++){t=arguments[i];for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n))e[n]=t[n]}return e};var r;(function(e){var t=function(){function t(t,i,r){this.emitter=null;this.renderingGroupId=0;this.layerMask=268435455;this._targetIndex=0;this._currentRenderId=-1;this._started=false;this._stopped=false;this._timeDelta=0;this._attributesStrideSize=14;this._actualFrame=0;this.animations=[];this.onDisposeObservable=new e.Observable;this.updateSpeed=.01;this.targetStopDuration=0;this.blendMode=e.ParticleSystem.BLENDMODE_ONEONE;this.minLifeTime=1;this.maxLifeTime=1;this.minSize=1;this.maxSize=1;this.color1=new e.Color4(1,1,1,1);this.color2=new e.Color4(1,1,1,1);this.colorDead=new e.Color4(0,0,0,0);this.emitRate=100;this.gravity=e.Vector3.Zero();this.minEmitPower=1;this.maxEmitPower=1;this.forceDepthWrite=false;this.id=t;this.name=t;this._scene=r||e.Engine.LastCreatedScene;this._engine=this._scene.getEngine();var o=n({capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize},i);this._capacity=o.capacity;this._activeCount=o.capacity;this._currentActiveCount=0;this._scene.particleSystems.push(this);this._updateEffectOptions={attributes:["position","age","life","seed","size","color","direction"],uniformsNames:["currentCount","timeDelta","generalRandoms","emitterWM","lifeTime","color1","color2","sizeRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","angle","stopFactor"],uniformBuffersNames:[],samplers:["randomSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:["outPosition","outAge","outLife","outSeed","outSize","outColor","outDirection"]};var s=Math.min(this._engine.getCaps().maxTextureSize,o.randomTextureSize);var a=[];for(var u=0;u<s;++u){a.push(Math.random());a.push(Math.random());a.push(Math.random());a.push(Math.random())}this._randomTexture=new e.RawTexture(new Float32Array(a),s,1,e.Engine.TEXTUREFORMAT_RGBA32F,this._scene,false,false,e.Texture.NEAREST_SAMPLINGMODE,e.Engine.TEXTURETYPE_FLOAT);this._randomTexture.wrapU=e.Texture.WRAP_ADDRESSMODE;this._randomTexture.wrapV=e.Texture.WRAP_ADDRESSMODE;this._randomTextureSize=s;this.particleEmitterType=new e.BoxParticleEmitter}Object.defineProperty(t,"IsSupported",{get:function(){if(!e.Engine.LastCreatedEngine){return false}return e.Engine.LastCreatedEngine.webGLVersion>1},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"direction1",{get:function(){if(this.particleEmitterType.direction1){return this.particleEmitterType.direction1}return e.Vector3.Zero()},set:function(e){if(this.particleEmitterType.direction1){this.particleEmitterType.direction1=e}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"direction2",{get:function(){if(this.particleEmitterType.direction2){return this.particleEmitterType.direction2}return e.Vector3.Zero()},set:function(e){if(this.particleEmitterType.direction2){this.particleEmitterType.direction2=e}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"minEmitBox",{get:function(){if(this.particleEmitterType.minEmitBox){return this.particleEmitterType.minEmitBox}return e.Vector3.Zero()},set:function(e){if(this.particleEmitterType.minEmitBox){this.particleEmitterType.minEmitBox=e}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"maxEmitBox",{get:function(){if(this.particleEmitterType.maxEmitBox){return this.particleEmitterType.maxEmitBox}return e.Vector3.Zero()},set:function(e){if(this.particleEmitterType.maxEmitBox){this.particleEmitterType.maxEmitBox=e}},enumerable:true,configurable:true});t.prototype.getCapacity=function(){return this._capacity};Object.defineProperty(t.prototype,"activeParticleCount",{get:function(){return this._activeCount},set:function(e){this._activeCount=Math.min(e,this._capacity)},enumerable:true,configurable:true});t.prototype.isReady=function(){if(!this._updateEffect){this._recreateUpdateEffect();this._recreateRenderEffect();return false}if(!this.emitter||!this._updateEffect.isReady()||!this._renderEffect.isReady()||!this.particleTexture||!this.particleTexture.isReady()){return false}return true};t.prototype.isStarted=function(){return this._started};t.prototype.start=function(){this._started=true;this._stopped=false};t.prototype.stop=function(){this._stopped=true};t.prototype.reset=function(){this._releaseBuffers();this._releaseVAOs();this._currentActiveCount=0;this._targetIndex=0};t.prototype.getClassName=function(){return"GPUParticleSystem"};t.prototype._createUpdateVAO=function(e){var t={};t["position"]=e.createVertexBuffer("position",0,3);t["age"]=e.createVertexBuffer("age",3,1);t["life"]=e.createVertexBuffer("life",4,1);t["seed"]=e.createVertexBuffer("seed",5,1);t["size"]=e.createVertexBuffer("size",6,1);t["color"]=e.createVertexBuffer("color",7,4);t["direction"]=e.createVertexBuffer("direction",11,3);var i=this._engine.recordVertexArrayObject(t,null,this._updateEffect);this._engine.bindArrayBuffer(null);return i};t.prototype._createRenderVAO=function(e,t){var i={};i["position"]=e.createVertexBuffer("position",0,3,this._attributesStrideSize,true);i["age"]=e.createVertexBuffer("age",3,1,this._attributesStrideSize,true);i["life"]=e.createVertexBuffer("life",4,1,this._attributesStrideSize,true);i["size"]=e.createVertexBuffer("size",6,1,this._attributesStrideSize,true);i["color"]=e.createVertexBuffer("color",7,4,this._attributesStrideSize,true);i["offset"]=t.createVertexBuffer("offset",0,2);i["uv"]=t.createVertexBuffer("uv",2,2);var r=this._engine.recordVertexArrayObject(i,null,this._renderEffect);this._engine.bindArrayBuffer(null);return r};t.prototype._initialize=function(t){if(t===void 0){t=false}if(this._buffer0&&!t){return}var i=this._scene.getEngine();var r=new Array;for(var n=0;n<this._capacity;n++){r.push(0);r.push(0);r.push(0);r.push(0);r.push(0);r.push(Math.random());r.push(0);r.push(0);r.push(0);r.push(0);r.push(0);r.push(0);r.push(0);r.push(0)}var o=new Float32Array([.5,.5,1,1,-.5,.5,0,1,-.5,-.5,0,0,.5,-.5,1,0]);this._buffer0=new e.Buffer(i,r,false,this._attributesStrideSize);this._buffer1=new e.Buffer(i,r,false,this._attributesStrideSize);this._spriteBuffer=new e.Buffer(i,o,false,4);this._updateVAO=[];this._updateVAO.push(this._createUpdateVAO(this._buffer0));this._updateVAO.push(this._createUpdateVAO(this._buffer1));this._renderVAO=[];this._renderVAO.push(this._createRenderVAO(this._buffer1,this._spriteBuffer));this._renderVAO.push(this._createRenderVAO(this._buffer0,this._spriteBuffer));this._sourceBuffer=this._buffer0;this._targetBuffer=this._buffer1};t.prototype._recreateUpdateEffect=function(){var t=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";if(this._updateEffect&&this._updateEffectOptions.defines===t){return}this._updateEffectOptions.defines=t;this._updateEffect=new e.Effect("gpuUpdateParticles",this._updateEffectOptions,this._scene.getEngine())};t.prototype._recreateRenderEffect=function(){var t="";if(this._scene.clipPlane){t="\n#define CLIPPLANE"}if(this._renderEffect&&this._renderEffect.defines===t){return}this._renderEffect=new e.Effect("gpuRenderParticles",["position","age","life","size","color","offset","uv"],["view","projection","colorDead","invView","vClipPlane"],["textureSampler"],this._scene.getEngine(),t)};t.prototype.animate=function(){this._timeDelta=this.updateSpeed*this._scene.getAnimationRatio();this._actualFrame+=this._timeDelta;if(!this._stopped){if(this.targetStopDuration&&this._actualFrame>=this.targetStopDuration){this.stop()}}};t.prototype.render=function(){if(!this._started){return 0}this._recreateUpdateEffect();this._recreateRenderEffect();if(!this.isReady()){return 0}if(this._currentRenderId===this._scene.getRenderId()){return 0}this._currentRenderId=this._scene.getRenderId();this._initialize();this._currentActiveCount=Math.min(this._activeCount,this._currentActiveCount+this.emitRate*this._timeDelta|0);this._engine.enableEffect(this._updateEffect);this._engine.setState(false);this._updateEffect.setFloat("currentCount",this._currentActiveCount);this._updateEffect.setFloat("timeDelta",this._timeDelta);this._updateEffect.setFloat("stopFactor",this._stopped?0:1);this._updateEffect.setFloat3("generalRandoms",Math.random(),Math.random(),Math.random());this._updateEffect.setTexture("randomSampler",this._randomTexture);this._updateEffect.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime);this._updateEffect.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower);this._updateEffect.setDirectColor4("color1",this.color1);this._updateEffect.setDirectColor4("color2",this.color2);this._updateEffect.setFloat2("sizeRange",this.minSize,this.maxSize);this._updateEffect.setVector3("gravity",this.gravity);if(this.particleEmitterType){this.particleEmitterType.applyToShader(this._updateEffect)}var t;if(this.emitter.position){var i=this.emitter;t=i.getWorldMatrix()}else{var r=this.emitter;t=e.Matrix.Translation(r.x,r.y,r.z)}this._updateEffect.setMatrix("emitterWM",t);this._engine.bindVertexArrayObject(this._updateVAO[this._targetIndex],null);this._engine.bindTransformFeedbackBuffer(this._targetBuffer.getBuffer());this._engine.setRasterizerState(false);this._engine.beginTransformFeedback();this._engine.drawArraysType(e.Material.PointListDrawMode,0,this._currentActiveCount);this._engine.endTransformFeedback();this._engine.setRasterizerState(true);this._engine.bindTransformFeedbackBuffer(null);this._engine.enableEffect(this._renderEffect);var n=this._scene.getViewMatrix();this._renderEffect.setMatrix("view",n);this._renderEffect.setMatrix("projection",this._scene.getProjectionMatrix());this._renderEffect.setTexture("textureSampler",this.particleTexture);this._renderEffect.setDirectColor4("colorDead",this.colorDead);if(this._scene.clipPlane){var o=this._scene.clipPlane;var s=n.clone();s.invert();this._renderEffect.setMatrix("invView",s);this._renderEffect.setFloat4("vClipPlane",o.normal.x,o.normal.y,o.normal.z,o.d)}if(this.blendMode===e.ParticleSystem.BLENDMODE_ONEONE){this._engine.setAlphaMode(e.Engine.ALPHA_ONEONE)}else{this._engine.setAlphaMode(e.Engine.ALPHA_COMBINE)}if(this.forceDepthWrite){this._engine.setDepthWrite(true)}this._engine.bindVertexArrayObject(this._renderVAO[this._targetIndex],null);this._engine.drawArraysType(e.Material.TriangleFanDrawMode,0,4,this._currentActiveCount);this._engine.setAlphaMode(e.Engine.ALPHA_DISABLE);this._targetIndex++;if(this._targetIndex===2){this._targetIndex=0}var a=this._sourceBuffer;this._sourceBuffer=this._targetBuffer;this._targetBuffer=a;return this._currentActiveCount};t.prototype.rebuild=function(){this._initialize(true)};t.prototype._releaseBuffers=function(){if(this._buffer0){this._buffer0.dispose();this._buffer0=null}if(this._buffer1){this._buffer1.dispose();this._buffer1=null}if(this._spriteBuffer){this._spriteBuffer.dispose();this._spriteBuffer=null}};t.prototype._releaseVAOs=function(){if(!this._updateVAO){return}for(var e=0;e<this._updateVAO.length;e++){this._engine.releaseVertexArrayObject(this._updateVAO[e])}this._updateVAO=[];for(var e=0;e<this._renderVAO.length;e++){this._engine.releaseVertexArrayObject(this._renderVAO[e])}this._renderVAO=[]};t.prototype.dispose=function(e){if(e===void 0){e=true}var t=this._scene.particleSystems.indexOf(this);if(t>-1){this._scene.particleSystems.splice(t,1)}this._releaseBuffers();this._releaseVAOs();if(this._randomTexture){this._randomTexture.dispose();this._randomTexture=null}if(e&&this.particleTexture){this.particleTexture.dispose();this.particleTexture=null}this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear()};t.prototype.clone=function(i,r){var n=new t(i,{capacity:this._capacity,randomTextureSize:this._randomTextureSize},this._scene);e.Tools.DeepCopy(this,n);if(r===undefined){r=this.emitter}n.emitter=r;if(this.particleTexture){n.particleTexture=new e.Texture(this.particleTexture.url,this._scene)}return n};t.prototype.serialize=function(){var t={};t.name=this.name;t.id=this.id;if(this.emitter.position){var i=this.emitter;t.emitterId=i.id}else{var r=this.emitter;t.emitter=r.asArray()}t.capacity=this.getCapacity();if(this.particleTexture){t.textureName=this.particleTexture.name}e.Animation.AppendSerializedAnimations(this,t);t.activeParticleCount=this.activeParticleCount;t.randomTextureSize=this._randomTextureSize;t.minSize=this.minSize;t.maxSize=this.maxSize;t.minEmitPower=this.minEmitPower;t.maxEmitPower=this.maxEmitPower;t.minLifeTime=this.minLifeTime;t.maxLifeTime=this.maxLifeTime;t.emitRate=this.emitRate;t.gravity=this.gravity.asArray();t.color1=this.color1.asArray();t.color2=this.color2.asArray();t.colorDead=this.colorDead.asArray();t.updateSpeed=this.updateSpeed;t.targetStopDuration=this.targetStopDuration;t.blendMode=this.blendMode;if(this.particleEmitterType){t.particleEmitterType=this.particleEmitterType.serialize()}return t};t.Parse=function(i,r,n){var o=i.name;var s=new t(o,{capacity:i.capacity,randomTextureSize:i.randomTextureSize},r);if(i.id){s.id=i.id}if(i.textureName){s.particleTexture=new e.Texture(n+i.textureName,r);s.particleTexture.name=i.textureName}if(i.emitterId){s.emitter=r.getLastMeshByID(i.emitterId)}else{s.emitter=e.Vector3.FromArray(i.emitter)}if(i.animations){for(var a=0;a<i.animations.length;a++){var u=i.animations[a];s.animations.push(e.Animation.Parse(u))}}s.activeParticleCount=i.activeParticleCount;s.minSize=i.minSize;s.maxSize=i.maxSize;s.minLifeTime=i.minLifeTime;s.maxLifeTime=i.maxLifeTime;s.minEmitPower=i.minEmitPower;s.maxEmitPower=i.maxEmitPower;s.emitRate=i.emitRate;s.gravity=e.Vector3.FromArray(i.gravity);s.color1=e.Color4.FromArray(i.color1);s.color2=e.Color4.FromArray(i.color2);s.colorDead=e.Color4.FromArray(i.colorDead);s.updateSpeed=i.updateSpeed;s.targetStopDuration=i.targetStopDuration;s.blendMode=i.blendMode;if(i.particleEmitterType){var l=void 0;switch(i.particleEmitterType.type){case"SphereEmitter":l=new e.SphereParticleEmitter;break;case"SphereDirectedParticleEmitter":l=new e.SphereDirectedParticleEmitter;break;case"ConeEmitter":l=new e.ConeParticleEmitter;break;case"BoxEmitter":default:l=new e.BoxParticleEmitter;break}l.parse(i.particleEmitterType);s.particleEmitterType=l}return s};return t}();e.GPUParticleSystem=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r,n,o,s,a,u){if(u===void 0){u=null}this.idx=0;this.color=new e.Color4(1,1,1,1);this.position=e.Vector3.Zero();this.rotation=e.Vector3.Zero();this.scaling=e.Vector3.One();this.uvs=new e.Vector4(0,0,1,1);this.velocity=e.Vector3.Zero();this.pivot=e.Vector3.Zero();this.translateFromPivot=false;this.alive=true;this.isVisible=true;this._pos=0;this._ind=0;this.shapeId=0;this.idxInShape=0;this._stillInvisible=false;this._rotationMatrix=[1,0,0,0,1,0,0,0,1];this.parentId=null;this._globalPosition=e.Vector3.Zero();this.idx=t;this._pos=i;this._ind=r;this._model=n;this.shapeId=o;this.idxInShape=s;this._sps=a;if(u){this._modelBoundingInfo=u;this._boundingInfo=new e.BoundingInfo(u.minimum,u.maximum)}}Object.defineProperty(t.prototype,"scale",{get:function(){return this.scaling},set:function(e){this.scaling=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(e){this.rotationQuaternion=e},enumerable:true,configurable:true});t.prototype.intersectsMesh=function(t){if(!this._boundingInfo||!t._boundingInfo){return false}if(this._sps._bSphereOnly){return e.BoundingSphere.Intersects(this._boundingInfo.boundingSphere,t._boundingInfo.boundingSphere)}return this._boundingInfo.intersects(t._boundingInfo,false)};return t}();e.SolidParticle=t;var i=function(){function e(e,t,i,r,n,o){this._indicesLength=0;this.shapeID=e;this._shape=t;this._indicesLength=i;this._shapeUV=r;this._positionFunction=n;this._vertexFunction=o}return e}();e.ModelShape=i;var r=function(){function e(){this.ind=0;this.indicesLength=0;this.sqDistance=0}return e}();e.DepthSortedParticle=r})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r){this.particles=new Array;this.nbParticles=0;this.billboard=false;this.recomputeNormals=true;this.counter=0;this.vars={};this._bSphereOnly=false;this._bSphereRadiusFactor=1;this._positions=new Array;this._indices=new Array;this._normals=new Array;this._colors=new Array;this._uvs=new Array;this._index=0;this._updatable=true;this._pickable=false;this._isVisibilityBoxLocked=false;this._alwaysVisible=false;this._depthSort=false;this._shapeCounter=0;this._copy=new e.SolidParticle(0,0,0,null,0,0,this);this._color=new e.Color4(0,0,0,0);this._computeParticleColor=true;this._computeParticleTexture=true;this._computeParticleRotation=true;this._computeParticleVertex=false;this._computeBoundingBox=false;this._depthSortParticles=true;this._cam_axisZ=e.Vector3.Zero();this._cam_axisY=e.Vector3.Zero();this._cam_axisX=e.Vector3.Zero();this._axisZ=e.Axis.Z;this._camDir=e.Vector3.Zero();this._camInvertedPosition=e.Vector3.Zero();this._rotMatrix=new e.Matrix;this._invertMatrix=new e.Matrix;this._rotated=e.Vector3.Zero();this._quaternion=new e.Quaternion;this._vertex=e.Vector3.Zero();this._normal=e.Vector3.Zero();this._yaw=0;this._pitch=0;this._roll=0;this._halfroll=0;this._halfpitch=0;this._halfyaw=0;this._sinRoll=0;this._cosRoll=0;this._sinPitch=0;this._cosPitch=0;this._sinYaw=0;this._cosYaw=0;this._mustUnrotateFixedNormals=false;this._minimum=e.Vector3.Zero();this._maximum=e.Vector3.Zero();this._minBbox=e.Vector3.Zero();this._maxBbox=e.Vector3.Zero();this._particlesIntersect=false;this._depthSortFunction=function(e,t){return t.sqDistance-e.sqDistance};this._needs32Bits=false;this._pivotBackTranslation=e.Vector3.Zero();this._scaledPivot=e.Vector3.Zero();this._particleHasParent=false;this.name=t;this._scene=i||e.Engine.LastCreatedScene;this._camera=i.activeCamera;this._pickable=r?r.isPickable:false;this._depthSort=r?r.enableDepthSort:false;this._particlesIntersect=r?r.particleIntersection:false;this._bSphereOnly=r?r.boundingSphereOnly:false;this._bSphereRadiusFactor=r&&r.bSphereRadiusFactor?r.bSphereRadiusFactor:1;if(r&&r.updatable){this._updatable=r.updatable}else{this._updatable=true}if(this._pickable){
this.pickedParticles=[]}if(this._depthSort){this.depthSortedParticles=[]}}t.prototype.buildMesh=function(){if(this.nbParticles===0){var t=e.MeshBuilder.CreateDisc("",{radius:1,tessellation:3},this._scene);this.addShape(t,1);t.dispose()}this._indices32=this._needs32Bits?new Uint32Array(this._indices):new Uint16Array(this._indices);this._positions32=new Float32Array(this._positions);this._uvs32=new Float32Array(this._uvs);this._colors32=new Float32Array(this._colors);if(this.recomputeNormals){e.VertexData.ComputeNormals(this._positions32,this._indices32,this._normals)}this._normals32=new Float32Array(this._normals);this._fixedNormal32=new Float32Array(this._normals);if(this._mustUnrotateFixedNormals){this._unrotateFixedNormals()}var i=new e.VertexData;i.indices=this._depthSort?this._indices:this._indices32;i.set(this._positions32,e.VertexBuffer.PositionKind);i.set(this._normals32,e.VertexBuffer.NormalKind);if(this._uvs32){i.set(this._uvs32,e.VertexBuffer.UVKind)}if(this._colors32){i.set(this._colors32,e.VertexBuffer.ColorKind)}var r=new e.Mesh(this.name,this._scene);i.applyToMesh(r,this._updatable);this.mesh=r;this.mesh.isPickable=this._pickable;if(!this._depthSort){this._indices=null}this._positions=null;this._normals=null;this._uvs=null;this._colors=null;if(!this._updatable){this.particles.length=0}return r};t.prototype.digest=function(t,i){var r=i&&i.facetNb||1;var n=i&&i.number||0;var o=i&&i.delta||0;var s=t.getVerticesData(e.VertexBuffer.PositionKind);var a=t.getIndices();var u=t.getVerticesData(e.VertexBuffer.UVKind);var l=t.getVerticesData(e.VertexBuffer.ColorKind);var c=t.getVerticesData(e.VertexBuffer.NormalKind);var h=0;var f=a.length/3;if(n){n=n>f?f:n;r=Math.round(f/n);o=0}else{r=r>f?f:r}var d=[];var p=[];var _=[];var m=[];var g=e.Vector3.Zero();var v=r;while(h<f){r=v+Math.floor((1+o)*Math.random());if(h>f-r){r=f-h}d.length=0;p.length=0;_.length=0;m.length=0;var y=0;for(var b=h*3;b<(h+r)*3;b++){p.push(y);var x=a[b];d.push(s[x*3],s[x*3+1],s[x*3+2]);if(u){_.push(u[x*2],u[x*2+1])}if(l){m.push(l[x*4],l[x*4+1],l[x*4+2],l[x*4+3])}y++}var T=this.nbParticles;var E=this._posToShape(d);var P=this._uvsToShapeUV(_);var A;for(A=0;A<E.length;A++){g.addInPlace(E[A])}g.scaleInPlace(1/E.length);for(A=0;A<E.length;A++){E[A].subtractInPlace(g)}var M;if(this._particlesIntersect){M=new e.BoundingInfo(g,g)}var S=new e.ModelShape(this._shapeCounter,E,r*3,P,null,null);var C=this._positions.length;var R=this._indices.length;this._meshBuilder(this._index,E,this._positions,p,this._indices,_,this._uvs,m,this._colors,c,this._normals,T,0,null);this._addParticle(T,C,R,S,this._shapeCounter,0,M);this.particles[this.nbParticles].position.addInPlace(g);this._index+=E.length;T++;this.nbParticles++;this._shapeCounter++;h+=r}return this};t.prototype._unrotateFixedNormals=function(){var t=0;var i=0;for(var r=0;r<this.particles.length;r++){this._particle=this.particles[r];this._shape=this._particle._model._shape;if(this._particle.rotationQuaternion){this._quaternion.copyFrom(this._particle.rotationQuaternion)}else{this._yaw=this._particle.rotation.y;this._pitch=this._particle.rotation.x;this._roll=this._particle.rotation.z;this._quaternionRotationYPR()}this._quaternionToRotationMatrix();this._rotMatrix.invertToRef(this._invertMatrix);for(var n=0;n<this._shape.length;n++){i=t+n*3;e.Vector3.TransformNormalFromFloatsToRef(this._normals32[i],this._normals32[i+1],this._normals32[i+2],this._invertMatrix,this._normal);this._fixedNormal32[i]=this._normal.x;this._fixedNormal32[i+1]=this._normal.y;this._fixedNormal32[i+2]=this._normal.z}t=i+3}};t.prototype._resetCopy=function(){this._copy.position.x=0;this._copy.position.y=0;this._copy.position.z=0;this._copy.rotation.x=0;this._copy.rotation.y=0;this._copy.rotation.z=0;this._copy.rotationQuaternion=null;this._copy.scaling.x=1;this._copy.scaling.y=1;this._copy.scaling.z=1;this._copy.uvs.x=0;this._copy.uvs.y=0;this._copy.uvs.z=1;this._copy.uvs.w=1;this._copy.color=null;this._copy.translateFromPivot=false};t.prototype._meshBuilder=function(t,i,r,n,o,s,a,u,l,c,h,f,d,p){var _;var m=0;var g=0;var v=0;this._resetCopy();if(p&&p.positionFunction){p.positionFunction(this._copy,f,d);this._mustUnrotateFixedNormals=true}if(this._copy.rotationQuaternion){this._quaternion.copyFrom(this._copy.rotationQuaternion)}else{this._yaw=this._copy.rotation.y;this._pitch=this._copy.rotation.x;this._roll=this._copy.rotation.z;this._quaternionRotationYPR()}this._quaternionToRotationMatrix();this._scaledPivot.x=this._copy.pivot.x*this._copy.scaling.x;this._scaledPivot.y=this._copy.pivot.y*this._copy.scaling.y;this._scaledPivot.z=this._copy.pivot.z*this._copy.scaling.z;if(this._copy.translateFromPivot){this._pivotBackTranslation.copyFromFloats(0,0,0)}else{this._pivotBackTranslation.copyFrom(this._scaledPivot)}for(_=0;_<i.length;_++){this._vertex.x=i[_].x;this._vertex.y=i[_].y;this._vertex.z=i[_].z;if(p&&p.vertexFunction){p.vertexFunction(this._copy,this._vertex,_)}this._vertex.x*=this._copy.scaling.x;this._vertex.y*=this._copy.scaling.y;this._vertex.z*=this._copy.scaling.z;this._vertex.x-=this._scaledPivot.x;this._vertex.y-=this._scaledPivot.y;this._vertex.z-=this._scaledPivot.z;e.Vector3.TransformCoordinatesToRef(this._vertex,this._rotMatrix,this._rotated);this._rotated.addInPlace(this._pivotBackTranslation);r.push(this._copy.position.x+this._rotated.x,this._copy.position.y+this._rotated.y,this._copy.position.z+this._rotated.z);if(s){a.push((this._copy.uvs.z-this._copy.uvs.x)*s[m]+this._copy.uvs.x,(this._copy.uvs.w-this._copy.uvs.y)*s[m+1]+this._copy.uvs.y);m+=2}if(this._copy.color){this._color=this._copy.color}else if(u&&u[g]!==undefined){this._color.r=u[g];this._color.g=u[g+1];this._color.b=u[g+2];this._color.a=u[g+3]}else{this._color.r=1;this._color.g=1;this._color.b=1;this._color.a=1}l.push(this._color.r,this._color.g,this._color.b,this._color.a);g+=4;if(!this.recomputeNormals&&c){this._normal.x=c[v];this._normal.y=c[v+1];this._normal.z=c[v+2];e.Vector3.TransformNormalToRef(this._normal,this._rotMatrix,this._normal);h.push(this._normal.x,this._normal.y,this._normal.z);v+=3}}for(_=0;_<n.length;_++){var y=t+n[_];o.push(y);if(y>65535){this._needs32Bits=true}}if(this._pickable){var b=n.length/3;for(_=0;_<b;_++){this.pickedParticles.push({idx:f,faceId:_})}}if(this._depthSort){this.depthSortedParticles.push(new e.DepthSortedParticle)}return this._copy};t.prototype._posToShape=function(t){var i=[];for(var r=0;r<t.length;r+=3){i.push(new e.Vector3(t[r],t[r+1],t[r+2]))}return i};t.prototype._uvsToShapeUV=function(e){var t=[];if(e){for(var i=0;i<e.length;i++)t.push(e[i])}return t};t.prototype._addParticle=function(t,i,r,n,o,s,a){if(a===void 0){a=null}var u=new e.SolidParticle(t,i,r,n,o,s,this,a);this.particles.push(u);return u};t.prototype.addShape=function(t,i,r){var n=t.getVerticesData(e.VertexBuffer.PositionKind);var o=t.getIndices();var s=t.getVerticesData(e.VertexBuffer.UVKind);var a=t.getVerticesData(e.VertexBuffer.ColorKind);var u=t.getVerticesData(e.VertexBuffer.NormalKind);var l;if(this._particlesIntersect){l=t.getBoundingInfo()}var c=this._posToShape(n);var h=this._uvsToShapeUV(s);var f=r?r.positionFunction:null;var d=r?r.vertexFunction:null;var p=new e.ModelShape(this._shapeCounter,c,o.length,h,f,d);var _;var m;var g=this.nbParticles;for(var v=0;v<i;v++){var y=this._positions.length;var b=this._indices.length;m=this._meshBuilder(this._index,c,this._positions,o,this._indices,s,this._uvs,a,this._colors,u,this._normals,g,v,r);if(this._updatable){_=this._addParticle(g,y,b,p,this._shapeCounter,v,l);_.position.copyFrom(m.position);_.rotation.copyFrom(m.rotation);if(m.rotationQuaternion&&_.rotationQuaternion){_.rotationQuaternion.copyFrom(m.rotationQuaternion)}if(m.color&&_.color){_.color.copyFrom(m.color)}_.scaling.copyFrom(m.scaling);_.uvs.copyFrom(m.uvs)}this._index+=c.length;g++}this.nbParticles+=i;this._shapeCounter++;return this._shapeCounter-1};t.prototype._rebuildParticle=function(t){this._resetCopy();if(t._model._positionFunction){t._model._positionFunction(this._copy,t.idx,t.idxInShape)}if(this._copy.rotationQuaternion){this._quaternion.copyFrom(this._copy.rotationQuaternion)}else{this._yaw=this._copy.rotation.y;this._pitch=this._copy.rotation.x;this._roll=this._copy.rotation.z;this._quaternionRotationYPR()}this._quaternionToRotationMatrix();this._scaledPivot.x=this._particle.pivot.x*this._particle.scaling.x;this._scaledPivot.y=this._particle.pivot.y*this._particle.scaling.y;this._scaledPivot.z=this._particle.pivot.z*this._particle.scaling.z;if(this._copy.translateFromPivot){this._pivotBackTranslation.copyFromFloats(0,0,0)}else{this._pivotBackTranslation.copyFrom(this._scaledPivot)}this._shape=t._model._shape;for(var i=0;i<this._shape.length;i++){this._vertex.x=this._shape[i].x;this._vertex.y=this._shape[i].y;this._vertex.z=this._shape[i].z;if(t._model._vertexFunction){t._model._vertexFunction(this._copy,this._vertex,i)}this._vertex.x*=this._copy.scaling.x;this._vertex.y*=this._copy.scaling.y;this._vertex.z*=this._copy.scaling.z;this._vertex.x-=this._scaledPivot.x;this._vertex.y-=this._scaledPivot.y;this._vertex.z-=this._scaledPivot.z;e.Vector3.TransformCoordinatesToRef(this._vertex,this._rotMatrix,this._rotated);this._rotated.addInPlace(this._pivotBackTranslation);this._positions32[t._pos+i*3]=this._copy.position.x+this._rotated.x;this._positions32[t._pos+i*3+1]=this._copy.position.y+this._rotated.y;this._positions32[t._pos+i*3+2]=this._copy.position.z+this._rotated.z}t.position.x=0;t.position.y=0;t.position.z=0;t.rotation.x=0;t.rotation.y=0;t.rotation.z=0;t.rotationQuaternion=null;t.scaling.x=1;t.scaling.y=1;t.scaling.z=1;t.uvs.x=0;t.uvs.y=0;t.uvs.z=1;t.uvs.w=1;t.pivot.x=0;t.pivot.y=0;t.pivot.z=0;t.translateFromPivot=false;t.parentId=null};t.prototype.rebuildMesh=function(){for(var t=0;t<this.particles.length;t++){this._rebuildParticle(this.particles[t])}this.mesh.updateVerticesData(e.VertexBuffer.PositionKind,this._positions32,false,false);return this};t.prototype.setParticles=function(t,i,r){if(t===void 0){t=0}if(i===void 0){i=this.nbParticles-1}if(r===void 0){r=true}if(!this._updatable){return this}this.beforeUpdateParticles(t,i,r);this._cam_axisX.x=1;this._cam_axisX.y=0;this._cam_axisX.z=0;this._cam_axisY.x=0;this._cam_axisY.y=1;this._cam_axisY.z=0;this._cam_axisZ.x=0;this._cam_axisZ.y=0;this._cam_axisZ.z=1;if(this.billboard||this._depthSort){this.mesh.computeWorldMatrix(true);this.mesh._worldMatrix.invertToRef(this._invertMatrix)}if(this.billboard){this._camera.getDirectionToRef(this._axisZ,this._camDir);e.Vector3.TransformNormalToRef(this._camDir,this._invertMatrix,this._cam_axisZ);this._cam_axisZ.normalize();var n=this._camera.getViewMatrix(true);e.Vector3.TransformNormalFromFloatsToRef(n.m[1],n.m[5],n.m[9],this._invertMatrix,this._cam_axisY);e.Vector3.CrossToRef(this._cam_axisY,this._cam_axisZ,this._cam_axisX);this._cam_axisY.normalize();this._cam_axisX.normalize()}if(this._depthSort){e.Vector3.TransformCoordinatesToRef(this._camera.globalPosition,this._invertMatrix,this._camInvertedPosition)}e.Matrix.IdentityToRef(this._rotMatrix);var o=0;var s=0;var a=0;var u=0;var l=0;var c=0;var h=0;if(this.mesh.isFacetDataEnabled){this._computeBoundingBox=true}i=i>=this.nbParticles?this.nbParticles-1:i;if(this._computeBoundingBox){if(t==0&&i==this.nbParticles-1){e.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this._minimum);e.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this._maximum)}else{if(this.mesh._boundingInfo){this._minimum.copyFrom(this.mesh._boundingInfo.boundingBox.minimum);this._maximum.copyFrom(this.mesh._boundingInfo.boundingBox.maximum)}}}s=this.particles[t]._pos;var f=s/3|0;u=f*4;c=f*2;for(var d=t;d<=i;d++){this._particle=this.particles[d];this._shape=this._particle._model._shape;this._shapeUV=this._particle._model._shapeUV;this.updateParticle(this._particle);if(this._depthSort&&this._depthSortParticles){var p=this.depthSortedParticles[d];p.ind=this._particle._ind;p.indicesLength=this._particle._model._indicesLength;p.sqDistance=e.Vector3.DistanceSquared(this._particle.position,this._camInvertedPosition)}if(!this._particle.alive||this._particle._stillInvisible&&!this._particle.isVisible){h=this._shape.length;s+=h*3;u+=h*4;c+=h*2;continue}if(this._particle.isVisible){this._particle._stillInvisible=false;this._particleHasParent=this._particle.parentId!==null;this._scaledPivot.x=this._particle.pivot.x*this._particle.scaling.x;this._scaledPivot.y=this._particle.pivot.y*this._particle.scaling.y;this._scaledPivot.z=this._particle.pivot.z*this._particle.scaling.z;if(this.billboard){this._particle.rotation.x=0;this._particle.rotation.y=0}if(this._computeParticleRotation||this.billboard){if(this._particle.rotationQuaternion){this._quaternion.copyFrom(this._particle.rotationQuaternion)}else{this._yaw=this._particle.rotation.y;this._pitch=this._particle.rotation.x;this._roll=this._particle.rotation.z;this._quaternionRotationYPR()}this._quaternionToRotationMatrix()}if(this._particleHasParent){this._parent=this.particles[this._particle.parentId];this._rotated.x=this._particle.position.x*this._parent._rotationMatrix[0]+this._particle.position.y*this._parent._rotationMatrix[3]+this._particle.position.z*this._parent._rotationMatrix[6];this._rotated.y=this._particle.position.x*this._parent._rotationMatrix[1]+this._particle.position.y*this._parent._rotationMatrix[4]+this._particle.position.z*this._parent._rotationMatrix[7];this._rotated.z=this._particle.position.x*this._parent._rotationMatrix[2]+this._particle.position.y*this._parent._rotationMatrix[5]+this._particle.position.z*this._parent._rotationMatrix[8];this._particle._globalPosition.x=this._parent._globalPosition.x+this._rotated.x;this._particle._globalPosition.y=this._parent._globalPosition.y+this._rotated.y;this._particle._globalPosition.z=this._parent._globalPosition.z+this._rotated.z;if(this._computeParticleRotation||this.billboard){this._particle._rotationMatrix[0]=this._rotMatrix.m[0]*this._parent._rotationMatrix[0]+this._rotMatrix.m[1]*this._parent._rotationMatrix[3]+this._rotMatrix.m[2]*this._parent._rotationMatrix[6];this._particle._rotationMatrix[1]=this._rotMatrix.m[0]*this._parent._rotationMatrix[1]+this._rotMatrix.m[1]*this._parent._rotationMatrix[4]+this._rotMatrix.m[2]*this._parent._rotationMatrix[7];this._particle._rotationMatrix[2]=this._rotMatrix.m[0]*this._parent._rotationMatrix[2]+this._rotMatrix.m[1]*this._parent._rotationMatrix[5]+this._rotMatrix.m[2]*this._parent._rotationMatrix[8];this._particle._rotationMatrix[3]=this._rotMatrix.m[4]*this._parent._rotationMatrix[0]+this._rotMatrix.m[5]*this._parent._rotationMatrix[3]+this._rotMatrix.m[6]*this._parent._rotationMatrix[6];this._particle._rotationMatrix[4]=this._rotMatrix.m[4]*this._parent._rotationMatrix[1]+this._rotMatrix.m[5]*this._parent._rotationMatrix[4]+this._rotMatrix.m[6]*this._parent._rotationMatrix[7];this._particle._rotationMatrix[5]=this._rotMatrix.m[4]*this._parent._rotationMatrix[2]+this._rotMatrix.m[5]*this._parent._rotationMatrix[5]+this._rotMatrix.m[6]*this._parent._rotationMatrix[8];this._particle._rotationMatrix[6]=this._rotMatrix.m[8]*this._parent._rotationMatrix[0]+this._rotMatrix.m[9]*this._parent._rotationMatrix[3]+this._rotMatrix.m[10]*this._parent._rotationMatrix[6];this._particle._rotationMatrix[7]=this._rotMatrix.m[8]*this._parent._rotationMatrix[1]+this._rotMatrix.m[9]*this._parent._rotationMatrix[4]+this._rotMatrix.m[10]*this._parent._rotationMatrix[7];this._particle._rotationMatrix[8]=this._rotMatrix.m[8]*this._parent._rotationMatrix[2]+this._rotMatrix.m[9]*this._parent._rotationMatrix[5]+this._rotMatrix.m[10]*this._parent._rotationMatrix[8]}}else{this._particle._globalPosition.x=this._particle.position.x;this._particle._globalPosition.y=this._particle.position.y;this._particle._globalPosition.z=this._particle.position.z;if(this._computeParticleRotation||this.billboard){this._particle._rotationMatrix[0]=this._rotMatrix.m[0];this._particle._rotationMatrix[1]=this._rotMatrix.m[1];this._particle._rotationMatrix[2]=this._rotMatrix.m[2];this._particle._rotationMatrix[3]=this._rotMatrix.m[4];this._particle._rotationMatrix[4]=this._rotMatrix.m[5];this._particle._rotationMatrix[5]=this._rotMatrix.m[6];this._particle._rotationMatrix[6]=this._rotMatrix.m[8];this._particle._rotationMatrix[7]=this._rotMatrix.m[9];this._particle._rotationMatrix[8]=this._rotMatrix.m[10]}}if(this._particle.translateFromPivot){this._pivotBackTranslation.x=0;this._pivotBackTranslation.y=0;this._pivotBackTranslation.z=0}else{this._pivotBackTranslation.x=this._scaledPivot.x;this._pivotBackTranslation.y=this._scaledPivot.y;this._pivotBackTranslation.z=this._scaledPivot.z}for(h=0;h<this._shape.length;h++){o=s+h*3;a=u+h*4;l=c+h*2;this._vertex.x=this._shape[h].x;this._vertex.y=this._shape[h].y;this._vertex.z=this._shape[h].z;if(this._computeParticleVertex){this.updateParticleVertex(this._particle,this._vertex,h)}this._vertex.x*=this._particle.scaling.x;this._vertex.y*=this._particle.scaling.y;this._vertex.z*=this._particle.scaling.z;this._vertex.x-=this._scaledPivot.x;this._vertex.y-=this._scaledPivot.y;this._vertex.z-=this._scaledPivot.z;this._rotated.x=this._vertex.x*this._particle._rotationMatrix[0]+this._vertex.y*this._particle._rotationMatrix[3]+this._vertex.z*this._particle._rotationMatrix[6];this._rotated.y=this._vertex.x*this._particle._rotationMatrix[1]+this._vertex.y*this._particle._rotationMatrix[4]+this._vertex.z*this._particle._rotationMatrix[7];this._rotated.z=this._vertex.x*this._particle._rotationMatrix[2]+this._vertex.y*this._particle._rotationMatrix[5]+this._vertex.z*this._particle._rotationMatrix[8];this._rotated.x+=this._pivotBackTranslation.x;this._rotated.y+=this._pivotBackTranslation.y;this._rotated.z+=this._pivotBackTranslation.z;this._positions32[o]=this._particle._globalPosition.x+this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z;this._positions32[o+1]=this._particle._globalPosition.y+this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z;this._positions32[o+2]=this._particle._globalPosition.z+this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z;if(this._computeBoundingBox){if(this._positions32[o]<this._minimum.x){this._minimum.x=this._positions32[o]}if(this._positions32[o]>this._maximum.x){this._maximum.x=this._positions32[o]}if(this._positions32[o+1]<this._minimum.y){this._minimum.y=this._positions32[o+1]}if(this._positions32[o+1]>this._maximum.y){this._maximum.y=this._positions32[o+1]}if(this._positions32[o+2]<this._minimum.z){this._minimum.z=this._positions32[o+2]}if(this._positions32[o+2]>this._maximum.z){this._maximum.z=this._positions32[o+2]}}if(!this._computeParticleVertex){this._normal.x=this._fixedNormal32[o];this._normal.y=this._fixedNormal32[o+1];this._normal.z=this._fixedNormal32[o+2];this._rotated.x=this._normal.x*this._particle._rotationMatrix[0]+this._normal.y*this._particle._rotationMatrix[3]+this._normal.z*this._particle._rotationMatrix[6];this._rotated.y=this._normal.x*this._particle._rotationMatrix[1]+this._normal.y*this._particle._rotationMatrix[4]+this._normal.z*this._particle._rotationMatrix[7];this._rotated.z=this._normal.x*this._particle._rotationMatrix[2]+this._normal.y*this._particle._rotationMatrix[5]+this._normal.z*this._particle._rotationMatrix[8];this._normals32[o]=this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z;this._normals32[o+1]=this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z;this._normals32[o+2]=this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z}if(this._computeParticleColor&&this._particle.color){this._colors32[a]=this._particle.color.r;this._colors32[a+1]=this._particle.color.g;this._colors32[a+2]=this._particle.color.b;this._colors32[a+3]=this._particle.color.a}if(this._computeParticleTexture){this._uvs32[l]=this._shapeUV[h*2]*(this._particle.uvs.z-this._particle.uvs.x)+this._particle.uvs.x;this._uvs32[l+1]=this._shapeUV[h*2+1]*(this._particle.uvs.w-this._particle.uvs.y)+this._particle.uvs.y}}}else{this._particle._stillInvisible=true;for(h=0;h<this._shape.length;h++){o=s+h*3;a=u+h*4;l=c+h*2;this._positions32[o]=0;this._positions32[o+1]=0;this._positions32[o+2]=0;this._normals32[o]=0;this._normals32[o+1]=0;this._normals32[o+2]=0;if(this._computeParticleColor&&this._particle.color){this._colors32[a]=this._particle.color.r;this._colors32[a+1]=this._particle.color.g;this._colors32[a+2]=this._particle.color.b;this._colors32[a+3]=this._particle.color.a}if(this._computeParticleTexture){this._uvs32[l]=this._shapeUV[h*2]*(this._particle.uvs.z-this._particle.uvs.x)+this._particle.uvs.x;this._uvs32[l+1]=this._shapeUV[h*2+1]*(this._particle.uvs.w-this._particle.uvs.y)+this._particle.uvs.y}}}if(this._particlesIntersect){var _=this._particle._boundingInfo;var m=_.boundingBox;var g=_.boundingSphere;if(!this._bSphereOnly){for(var v=0;v<m.vectors.length;v++){this._vertex.x=this._particle._modelBoundingInfo.boundingBox.vectors[v].x*this._particle.scaling.x;this._vertex.y=this._particle._modelBoundingInfo.boundingBox.vectors[v].y*this._particle.scaling.y;this._vertex.z=this._particle._modelBoundingInfo.boundingBox.vectors[v].z*this._particle.scaling.z;this._rotated.x=this._vertex.x*this._particle._rotationMatrix[0]+this._vertex.y*this._particle._rotationMatrix[3]+this._vertex.z*this._particle._rotationMatrix[6];this._rotated.y=this._vertex.x*this._particle._rotationMatrix[1]+this._vertex.y*this._particle._rotationMatrix[4]+this._vertex.z*this._particle._rotationMatrix[7];this._rotated.z=this._vertex.x*this._particle._rotationMatrix[2]+this._vertex.y*this._particle._rotationMatrix[5]+this._vertex.z*this._particle._rotationMatrix[8];m.vectors[v].x=this._particle.position.x+this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z;m.vectors[v].y=this._particle.position.y+this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z;m.vectors[v].z=this._particle.position.z+this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z}m._update(this.mesh._worldMatrix)}this._minBbox.x=this._particle._modelBoundingInfo.minimum.x*this._particle.scaling.x;this._minBbox.y=this._particle._modelBoundingInfo.minimum.y*this._particle.scaling.y;this._minBbox.z=this._particle._modelBoundingInfo.minimum.z*this._particle.scaling.z;this._maxBbox.x=this._particle._modelBoundingInfo.maximum.x*this._particle.scaling.x;this._maxBbox.y=this._particle._modelBoundingInfo.maximum.y*this._particle.scaling.y;this._maxBbox.z=this._particle._modelBoundingInfo.maximum.z*this._particle.scaling.z;g.center.x=this._particle._globalPosition.x+(this._minBbox.x+this._maxBbox.x)*.5;g.center.y=this._particle._globalPosition.y+(this._minBbox.y+this._maxBbox.y)*.5;g.center.z=this._particle._globalPosition.z+(this._minBbox.z+this._maxBbox.z)*.5;g.radius=this._bSphereRadiusFactor*.5*Math.sqrt((this._maxBbox.x-this._minBbox.x)*(this._maxBbox.x-this._minBbox.x)+(this._maxBbox.y-this._minBbox.y)*(this._maxBbox.y-this._minBbox.y)+(this._maxBbox.z-this._minBbox.z)*(this._maxBbox.z-this._minBbox.z));g._update(this.mesh._worldMatrix)}s=o+3;u=a+4;c=l+2}if(r){if(this._computeParticleColor){this.mesh.updateVerticesData(e.VertexBuffer.ColorKind,this._colors32,false,false)}if(this._computeParticleTexture){this.mesh.updateVerticesData(e.VertexBuffer.UVKind,this._uvs32,false,false)}this.mesh.updateVerticesData(e.VertexBuffer.PositionKind,this._positions32,false,false);if(!this.mesh.areNormalsFrozen||this.mesh.isFacetDataEnabled){if(this._computeParticleVertex||this.mesh.isFacetDataEnabled){var y=this.mesh.isFacetDataEnabled?this.mesh.getFacetDataParameters():null;e.VertexData.ComputeNormals(this._positions32,this._indices32,this._normals32,y);for(var b=0;b<this._normals32.length;b++){this._fixedNormal32[b]=this._normals32[b]}}if(!this.mesh.areNormalsFrozen){this.mesh.updateVerticesData(e.VertexBuffer.NormalKind,this._normals32,false,false)}}if(this._depthSort&&this._depthSortParticles){this.depthSortedParticles.sort(this._depthSortFunction);var x=this.depthSortedParticles.length;var T=0;var E=0;var P=0;var A=0;for(T=0;T<x;T++){E=this.depthSortedParticles[T].indicesLength;P=this.depthSortedParticles[T].ind;for(var b=0;b<E;b++){this._indices32[A]=this._indices[P+b];A++}}this.mesh.updateIndices(this._indices32)}}if(this._computeBoundingBox){this.mesh._boundingInfo=new e.BoundingInfo(this._minimum,this._maximum);this.mesh._boundingInfo.update(this.mesh._worldMatrix)}this.afterUpdateParticles(t,i,r);return this};t.prototype._quaternionRotationYPR=function(){this._halfroll=this._roll*.5;this._halfpitch=this._pitch*.5;this._halfyaw=this._yaw*.5;this._sinRoll=Math.sin(this._halfroll);this._cosRoll=Math.cos(this._halfroll);this._sinPitch=Math.sin(this._halfpitch);this._cosPitch=Math.cos(this._halfpitch);this._sinYaw=Math.sin(this._halfyaw);this._cosYaw=Math.cos(this._halfyaw);this._quaternion.x=this._cosYaw*this._sinPitch*this._cosRoll+this._sinYaw*this._cosPitch*this._sinRoll;this._quaternion.y=this._sinYaw*this._cosPitch*this._cosRoll-this._cosYaw*this._sinPitch*this._sinRoll;this._quaternion.z=this._cosYaw*this._cosPitch*this._sinRoll-this._sinYaw*this._sinPitch*this._cosRoll;this._quaternion.w=this._cosYaw*this._cosPitch*this._cosRoll+this._sinYaw*this._sinPitch*this._sinRoll};t.prototype._quaternionToRotationMatrix=function(){this._rotMatrix.m[0]=1-2*(this._quaternion.y*this._quaternion.y+this._quaternion.z*this._quaternion.z);this._rotMatrix.m[1]=2*(this._quaternion.x*this._quaternion.y+this._quaternion.z*this._quaternion.w);this._rotMatrix.m[2]=2*(this._quaternion.z*this._quaternion.x-this._quaternion.y*this._quaternion.w);this._rotMatrix.m[3]=0;this._rotMatrix.m[4]=2*(this._quaternion.x*this._quaternion.y-this._quaternion.z*this._quaternion.w);this._rotMatrix.m[5]=1-2*(this._quaternion.z*this._quaternion.z+this._quaternion.x*this._quaternion.x);this._rotMatrix.m[6]=2*(this._quaternion.y*this._quaternion.z+this._quaternion.x*this._quaternion.w);this._rotMatrix.m[7]=0;this._rotMatrix.m[8]=2*(this._quaternion.z*this._quaternion.x+this._quaternion.y*this._quaternion.w);this._rotMatrix.m[9]=2*(this._quaternion.y*this._quaternion.z-this._quaternion.x*this._quaternion.w);this._rotMatrix.m[10]=1-2*(this._quaternion.y*this._quaternion.y+this._quaternion.x*this._quaternion.x);this._rotMatrix.m[11]=0;this._rotMatrix.m[12]=0;this._rotMatrix.m[13]=0;this._rotMatrix.m[14]=0;this._rotMatrix.m[15]=1};t.prototype.dispose=function(){this.mesh.dispose();this.vars=null;this._positions=null;this._indices=null;this._normals=null;this._uvs=null;this._colors=null;this._indices32=null;this._positions32=null;this._normals32=null;this._fixedNormal32=null;this._uvs32=null;this._colors32=null;this.pickedParticles=null};t.prototype.refreshVisibleSize=function(){if(!this._isVisibilityBoxLocked){this.mesh.refreshBoundingInfo()}return this};t.prototype.setVisibilityBox=function(t){var i=t/2;this.mesh._boundingInfo=new e.BoundingInfo(new e.Vector3(-i,-i,-i),new e.Vector3(i,i,i))};Object.defineProperty(t.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(e){this._alwaysVisible=e;this.mesh.alwaysSelectAsActiveMesh=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"isVisibilityBoxLocked",{get:function(){return this._isVisibilityBoxLocked},set:function(e){this._isVisibilityBoxLocked=e;var t=this.mesh.getBoundingInfo();t.isLocked=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"computeParticleRotation",{get:function(){return this._computeParticleRotation},set:function(e){this._computeParticleRotation=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(e){this._computeParticleColor=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(e){this._computeParticleTexture=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"computeParticleVertex",{get:function(){return this._computeParticleVertex},set:function(e){this._computeParticleVertex=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(e){this._computeBoundingBox=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"depthSortParticles",{get:function(){return this._depthSortParticles},set:function(e){this._depthSortParticles=e},enumerable:true,configurable:true});t.prototype.initParticles=function(){};t.prototype.recycleParticle=function(e){return e};t.prototype.updateParticle=function(e){return e};t.prototype.updateParticleVertex=function(e,t,i){return t};t.prototype.beforeUpdateParticles=function(e,t,i){};t.prototype.afterUpdateParticles=function(e,t,i){};return t}();e.SolidParticleSystem=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o){var s=t.call(this,i,r)||this;s._textures={};s._textureArrays={};s._floats={};s._ints={};s._floatsArrays={};s._colors3={};s._colors3Arrays={};s._colors4={};s._vectors2={};s._vectors3={};s._vectors4={};s._matrices={};s._matrices3x3={};s._matrices2x2={};s._vectors2Arrays={};s._vectors3Arrays={};s._cachedWorldViewMatrix=new e.Matrix;s._shaderPath=n;o.needAlphaBlending=o.needAlphaBlending||false;o.needAlphaTesting=o.needAlphaTesting||false;o.attributes=o.attributes||["position","normal","uv"];o.uniforms=o.uniforms||["worldViewProjection"];o.uniformBuffers=o.uniformBuffers||[];o.samplers=o.samplers||[];o.defines=o.defines||[];s._options=o;return s}i.prototype.getClassName=function(){return"ShaderMaterial"};i.prototype.needAlphaBlending=function(){return this._options.needAlphaBlending};i.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting};i.prototype._checkUniform=function(e){if(this._options.uniforms.indexOf(e)===-1){this._options.uniforms.push(e)}};i.prototype.setTexture=function(e,t){if(this._options.samplers.indexOf(e)===-1){this._options.samplers.push(e)}this._textures[e]=t;return this};i.prototype.setTextureArray=function(e,t){if(this._options.samplers.indexOf(e)===-1){this._options.samplers.push(e)}this._checkUniform(e);this._textureArrays[e]=t;return this};i.prototype.setFloat=function(e,t){this._checkUniform(e);this._floats[e]=t;return this};i.prototype.setInt=function(e,t){this._checkUniform(e);this._ints[e]=t;return this};i.prototype.setFloats=function(e,t){this._checkUniform(e);this._floatsArrays[e]=t;return this};i.prototype.setColor3=function(e,t){this._checkUniform(e);this._colors3[e]=t;return this};i.prototype.setColor3Array=function(e,t){this._checkUniform(e);this._colors3Arrays[e]=t.reduce(function(e,t){t.toArray(e,e.length);return e},[]);return this};i.prototype.setColor4=function(e,t){this._checkUniform(e);this._colors4[e]=t;return this};i.prototype.setVector2=function(e,t){this._checkUniform(e);this._vectors2[e]=t;return this};i.prototype.setVector3=function(e,t){this._checkUniform(e);this._vectors3[e]=t;return this};i.prototype.setVector4=function(e,t){this._checkUniform(e);this._vectors4[e]=t;return this};i.prototype.setMatrix=function(e,t){this._checkUniform(e);this._matrices[e]=t;return this};i.prototype.setMatrix3x3=function(e,t){this._checkUniform(e);this._matrices3x3[e]=t;return this};i.prototype.setMatrix2x2=function(e,t){this._checkUniform(e);this._matrices2x2[e]=t;return this};i.prototype.setArray2=function(e,t){this._checkUniform(e);this._vectors2Arrays[e]=t;return this};i.prototype.setArray3=function(e,t){this._checkUniform(e);this._vectors3Arrays[e]=t;return this};i.prototype._checkCache=function(e,t,i){if(!t){return true}
if(this._effect&&this._effect.defines.indexOf("#define INSTANCES")!==-1!==i){return false}return false};i.prototype.isReady=function(t,i){var r=this.getScene();var n=r.getEngine();if(!this.checkReadyOnEveryCall){if(this._renderId===r.getRenderId()){if(this._checkCache(r,t,i)){return true}}}var o=[];var s=[];var a=new e.EffectFallbacks;if(i){o.push("#define INSTANCES")}for(var u=0;u<this._options.defines.length;u++){o.push(this._options.defines[u])}for(var u=0;u<this._options.attributes.length;u++){s.push(this._options.attributes[u])}if(t&&t.isVerticesDataPresent(e.VertexBuffer.ColorKind)){s.push(e.VertexBuffer.ColorKind);o.push("#define VERTEXCOLOR")}if(t&&t.useBones&&t.computeBonesUsingShaders&&t.skeleton){s.push(e.VertexBuffer.MatricesIndicesKind);s.push(e.VertexBuffer.MatricesWeightsKind);if(t.numBoneInfluencers>4){s.push(e.VertexBuffer.MatricesIndicesExtraKind);s.push(e.VertexBuffer.MatricesWeightsExtraKind)}o.push("#define NUM_BONE_INFLUENCERS "+t.numBoneInfluencers);o.push("#define BonesPerMesh "+(t.skeleton.bones.length+1));a.addCPUSkinningFallback(0,t);if(this._options.uniforms.indexOf("mBones")===-1){this._options.uniforms.push("mBones")}}else{o.push("#define NUM_BONE_INFLUENCERS 0")}for(var l in this._textures){if(!this._textures[l].isReady()){return false}}if(t&&this._shouldTurnAlphaTestOn(t)){o.push("#define ALPHATEST")}var c=this._effect;var h=o.join("\n");this._effect=n.createEffect(this._shaderPath,{attributes:s,uniformsNames:this._options.uniforms,uniformBuffersNames:this._options.uniformBuffers,samplers:this._options.samplers,defines:h,fallbacks:a,onCompiled:this.onCompiled,onError:this.onError},n);if(!this._effect.isReady()){return false}if(c!==this._effect){r.resetCachedMaterial()}this._renderId=r.getRenderId();return true};i.prototype.bindOnlyWorldMatrix=function(e){var t=this.getScene();if(!this._effect){return}if(this._options.uniforms.indexOf("world")!==-1){this._effect.setMatrix("world",e)}if(this._options.uniforms.indexOf("worldView")!==-1){e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix);this._effect.setMatrix("worldView",this._cachedWorldViewMatrix)}if(this._options.uniforms.indexOf("worldViewProjection")!==-1){this._effect.setMatrix("worldViewProjection",e.multiply(t.getTransformMatrix()))}};i.prototype.bind=function(t,i){this.bindOnlyWorldMatrix(t);if(this._effect&&this.getScene().getCachedMaterial()!==this){if(this._options.uniforms.indexOf("view")!==-1){this._effect.setMatrix("view",this.getScene().getViewMatrix())}if(this._options.uniforms.indexOf("projection")!==-1){this._effect.setMatrix("projection",this.getScene().getProjectionMatrix())}if(this._options.uniforms.indexOf("viewProjection")!==-1){this._effect.setMatrix("viewProjection",this.getScene().getTransformMatrix())}e.MaterialHelper.BindBonesParameters(i,this._effect);var r;for(r in this._textures){this._effect.setTexture(r,this._textures[r])}for(r in this._textureArrays){this._effect.setTextureArray(r,this._textureArrays[r])}for(r in this._ints){this._effect.setInt(r,this._ints[r])}for(r in this._floats){this._effect.setFloat(r,this._floats[r])}for(r in this._floatsArrays){this._effect.setArray(r,this._floatsArrays[r])}for(r in this._colors3){this._effect.setColor3(r,this._colors3[r])}for(r in this._colors3Arrays){this._effect.setArray3(r,this._colors3Arrays[r])}for(r in this._colors4){var n=this._colors4[r];this._effect.setFloat4(r,n.r,n.g,n.b,n.a)}for(r in this._vectors2){this._effect.setVector2(r,this._vectors2[r])}for(r in this._vectors3){this._effect.setVector3(r,this._vectors3[r])}for(r in this._vectors4){this._effect.setVector4(r,this._vectors4[r])}for(r in this._matrices){this._effect.setMatrix(r,this._matrices[r])}for(r in this._matrices3x3){this._effect.setMatrix3x3(r,this._matrices3x3[r])}for(r in this._matrices2x2){this._effect.setMatrix2x2(r,this._matrices2x2[r])}for(r in this._vectors2Arrays){this._effect.setArray2(r,this._vectors2Arrays[r])}for(r in this._vectors3Arrays){this._effect.setArray3(r,this._vectors3Arrays[r])}}this._afterBind(i)};i.prototype.getActiveTextures=function(){var e=t.prototype.getActiveTextures.call(this);for(var i in this._textures){e.push(this._textures[i])}for(var i in this._textureArrays){var r=this._textureArrays[i];for(var n=0;n<r.length;n++){e.push(r[n])}}return e};i.prototype.hasTexture=function(e){if(t.prototype.hasTexture.call(this,e)){return true}for(var i in this._textures){if(this._textures[i]===e){return true}}for(var i in this._textureArrays){var r=this._textureArrays[i];for(var n=0;n<r.length;n++){if(r[n]===e){return true}}}return false};i.prototype.clone=function(e){var t=new i(e,this.getScene(),this._shaderPath,this._options);return t};i.prototype.dispose=function(e,i){if(i){var r;for(r in this._textures){this._textures[r].dispose()}for(r in this._textureArrays){var n=this._textureArrays[r];for(var o=0;o<n.length;o++){n[o].dispose()}}}this._textures={};t.prototype.dispose.call(this,e,i)};i.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);t.customType="BABYLON.ShaderMaterial";t.options=this._options;t.shaderPath=this._shaderPath;var i;t.textures={};for(i in this._textures){t.textures[i]=this._textures[i].serialize()}t.textureArrays={};for(i in this._textureArrays){t.textureArrays[i]=[];var r=this._textureArrays[i];for(var n=0;n<r.length;n++){t.textureArrays[i].push(r[n].serialize())}}t.floats={};for(i in this._floats){t.floats[i]=this._floats[i]}t.FloatArrays={};for(i in this._floatsArrays){t.FloatArrays[i]=this._floatsArrays[i]}t.colors3={};for(i in this._colors3){t.colors3[i]=this._colors3[i].asArray()}t.colors3Arrays={};for(i in this._colors3Arrays){t.colors3Arrays[i]=this._colors3Arrays[i]}t.colors4={};for(i in this._colors4){t.colors4[i]=this._colors4[i].asArray()}t.vectors2={};for(i in this._vectors2){t.vectors2[i]=this._vectors2[i].asArray()}t.vectors3={};for(i in this._vectors3){t.vectors3[i]=this._vectors3[i].asArray()}t.vectors4={};for(i in this._vectors4){t.vectors4[i]=this._vectors4[i].asArray()}t.matrices={};for(i in this._matrices){t.matrices[i]=this._matrices[i].asArray()}t.matrices3x3={};for(i in this._matrices3x3){t.matrices3x3[i]=this._matrices3x3[i]}t.matrices2x2={};for(i in this._matrices2x2){t.matrices2x2[i]=this._matrices2x2[i]}t.vectors2Arrays={};for(i in this._vectors2Arrays){t.vectors2Arrays[i]=this._vectors2Arrays[i]}t.vectors3Arrays={};for(i in this._vectors3Arrays){t.vectors3Arrays[i]=this._vectors3Arrays[i]}return t};i.Parse=function(t,r,n){var o=e.SerializationHelper.Parse(function(){return new i(t.name,r,t.shaderPath,t.options)},t,r,n);var s;for(s in t.textures){o.setTexture(s,e.Texture.Parse(t.textures[s],r,n))}for(s in t.textureArrays){var a=t.textureArrays[s];var u=new Array;for(var l=0;l<a.length;l++){u.push(e.Texture.Parse(a[l],r,n))}o.setTextureArray(s,u)}for(s in t.floats){o.setFloat(s,t.floats[s])}for(s in t.floatsArrays){o.setFloats(s,t.floatsArrays[s])}for(s in t.colors3){o.setColor3(s,e.Color3.FromArray(t.colors3[s]))}for(s in t.colors3Arrays){var c=t.colors3Arrays[s].reduce(function(e,t,i){if(i%3===0){e.push([t])}else{e[e.length-1].push(t)}return e},[]).map(function(t){return e.Color3.FromArray(t)});o.setColor3Array(s,c)}for(s in t.colors4){o.setColor4(s,e.Color4.FromArray(t.colors4[s]))}for(s in t.vectors2){o.setVector2(s,e.Vector2.FromArray(t.vectors2[s]))}for(s in t.vectors3){o.setVector3(s,e.Vector3.FromArray(t.vectors3[s]))}for(s in t.vectors4){o.setVector4(s,e.Vector4.FromArray(t.vectors4[s]))}for(s in t.matrices){o.setMatrix(s,e.Matrix.FromArray(t.matrices[s]))}for(s in t.matrices3x3){o.setMatrix3x3(s,t.matrices3x3[s])}for(s in t.matrices2x2){o.setMatrix2x2(s,t.matrices2x2[s])}for(s in t.vectors2Arrays){o.setArray2(s,t.vectors2Arrays[s])}for(s in t.vectors3Arrays){o.setArray3(s,t.vectors3Arrays[s])}return o};return i}(e.Material);e.ShaderMaterial=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(e,i){var r=t.call(this,e,i)||this;r.generateOctree=false;return r}i.prototype.getClassName=function(){return"GroundMesh"};Object.defineProperty(i.prototype,"subdivisions",{get:function(){return Math.min(this._subdivisionsX,this._subdivisionsY)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"subdivisionsX",{get:function(){return this._subdivisionsX},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"subdivisionsY",{get:function(){return this._subdivisionsY},enumerable:true,configurable:true});i.prototype.optimize=function(e,t){if(t===void 0){t=32}this._subdivisionsX=e;this._subdivisionsY=e;this.subdivide(e);this.createOrUpdateSubmeshesOctree(t)};i.prototype.getHeightAtCoordinates=function(t,i){var r=this.getWorldMatrix();var n=e.Tmp.Matrix[5];r.invertToRef(n);var o=e.Tmp.Vector3[8];e.Vector3.TransformCoordinatesFromFloatsToRef(t,0,i,n,o);t=o.x;i=o.z;if(t<this._minX||t>this._maxX||i<this._minZ||i>this._maxZ){return this.position.y}if(!this._heightQuads||this._heightQuads.length==0){this._initHeightQuads();this._computeHeightQuads()}var s=this._getFacetAt(t,i);var a=-(s.x*t+s.z*i+s.w)/s.y;e.Vector3.TransformCoordinatesFromFloatsToRef(0,a,0,r,o);return o.y};i.prototype.getNormalAtCoordinates=function(t,i){var r=new e.Vector3(0,1,0);this.getNormalAtCoordinatesToRef(t,i,r);return r};i.prototype.getNormalAtCoordinatesToRef=function(t,i,r){var n=this.getWorldMatrix();var o=e.Tmp.Matrix[5];n.invertToRef(o);var s=e.Tmp.Vector3[8];e.Vector3.TransformCoordinatesFromFloatsToRef(t,0,i,o,s);t=s.x;i=s.z;if(t<this._minX||t>this._maxX||i<this._minZ||i>this._maxZ){return this}if(!this._heightQuads||this._heightQuads.length==0){this._initHeightQuads();this._computeHeightQuads()}var a=this._getFacetAt(t,i);e.Vector3.TransformNormalFromFloatsToRef(a.x,a.y,a.z,n,r);return this};i.prototype.updateCoordinateHeights=function(){if(!this._heightQuads||this._heightQuads.length==0){this._initHeightQuads()}this._computeHeightQuads();return this};i.prototype._getFacetAt=function(e,t){var i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width);var r=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY);var n=this._heightQuads[r*this._subdivisionsX+i];var o;if(t<n.slope.x*e+n.slope.y){o=n.facet1}else{o=n.facet2}return o};i.prototype._initHeightQuads=function(){var t=this._subdivisionsX;var i=this._subdivisionsY;this._heightQuads=new Array;for(var r=0;r<i;r++){for(var n=0;n<t;n++){var o={slope:e.Vector2.Zero(),facet1:new e.Vector4(0,0,0,0),facet2:new e.Vector4(0,0,0,0)};this._heightQuads[r*t+n]=o}}return this};i.prototype._computeHeightQuads=function(){var t=this.getVerticesData(e.VertexBuffer.PositionKind);if(!t){return this}var i=e.Tmp.Vector3[3];var r=e.Tmp.Vector3[2];var n=e.Tmp.Vector3[1];var o=e.Tmp.Vector3[0];var s=e.Tmp.Vector3[4];var a=e.Tmp.Vector3[5];var u=e.Tmp.Vector3[6];var l=e.Tmp.Vector3[7];var c=e.Tmp.Vector3[8];var h=0;var f=0;var d=0;var p=0;var _=0;var m=0;var g=0;var v=this._subdivisionsX;var y=this._subdivisionsY;for(var b=0;b<y;b++){for(var x=0;x<v;x++){h=x*3;f=b*(v+1)*3;d=(b+1)*(v+1)*3;i.x=t[f+h];i.y=t[f+h+1];i.z=t[f+h+2];r.x=t[f+h+3];r.y=t[f+h+4];r.z=t[f+h+5];n.x=t[d+h];n.y=t[d+h+1];n.z=t[d+h+2];o.x=t[d+h+3];o.y=t[d+h+4];o.z=t[d+h+5];p=(o.z-i.z)/(o.x-i.x);_=i.z-p*i.x;r.subtractToRef(i,s);n.subtractToRef(i,a);o.subtractToRef(i,u);e.Vector3.CrossToRef(u,a,l);e.Vector3.CrossToRef(s,u,c);l.normalize();c.normalize();m=-(l.x*i.x+l.y*i.y+l.z*i.z);g=-(c.x*r.x+c.y*r.y+c.z*r.z);var T=this._heightQuads[b*v+x];T.slope.copyFromFloats(p,_);T.facet1.copyFromFloats(l.x,l.y,l.z,m);T.facet2.copyFromFloats(c.x,c.y,c.z,g)}}return this};i.prototype.serialize=function(e){t.prototype.serialize.call(this,e);e.subdivisionsX=this._subdivisionsX;e.subdivisionsY=this._subdivisionsY;e.minX=this._minX;e.maxX=this._maxX;e.minZ=this._minZ;e.maxZ=this._maxZ;e.width=this._width;e.height=this._height};i.Parse=function(e,t){var r=new i(e.name,t);r._subdivisionsX=e.subdivisionsX||1;r._subdivisionsY=e.subdivisionsY||1;r._minX=e.minX;r._maxX=e.maxX;r._minZ=e.minZ;r._maxZ=e.maxZ;r._width=e.width;r._height=e.height;return r};return i}(e.Mesh);e.GroundMesh=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(e,i){var r=t.call(this,e,i.getScene())||this;i.instances.push(r);r._sourceMesh=i;r.position.copyFrom(i.position);r.rotation.copyFrom(i.rotation);r.scaling.copyFrom(i.scaling);if(i.rotationQuaternion){r.rotationQuaternion=i.rotationQuaternion.clone()}r.infiniteDistance=i.infiniteDistance;r.setPivotMatrix(i.getPivotMatrix());r.refreshBoundingInfo();r._syncSubMeshes();return r}i.prototype.getClassName=function(){return"InstancedMesh"};Object.defineProperty(i.prototype,"receiveShadows",{get:function(){return this._sourceMesh.receiveShadows},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"material",{get:function(){return this._sourceMesh.material},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"visibility",{get:function(){return this._sourceMesh.visibility},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"skeleton",{get:function(){return this._sourceMesh.skeleton},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"renderingGroupId",{get:function(){return this._sourceMesh.renderingGroupId},set:function(t){if(!this._sourceMesh||t===this._sourceMesh.renderingGroupId){return}e.Tools.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")},enumerable:true,configurable:true});i.prototype.getTotalVertices=function(){return this._sourceMesh.getTotalVertices()};Object.defineProperty(i.prototype,"sourceMesh",{get:function(){return this._sourceMesh},enumerable:true,configurable:true});i.prototype.isReady=function(e){if(e===void 0){e=false}return this._sourceMesh.isReady(e,true)};i.prototype.getVerticesData=function(e,t){return this._sourceMesh.getVerticesData(e,t)};i.prototype.setVerticesData=function(e,t,i,r){if(this.sourceMesh){this.sourceMesh.setVerticesData(e,t,i,r)}return this.sourceMesh};i.prototype.updateVerticesData=function(e,t,i,r){if(this.sourceMesh){this.sourceMesh.updateVerticesData(e,t,i,r)}return this.sourceMesh};i.prototype.setIndices=function(e,t){if(t===void 0){t=null}if(this.sourceMesh){this.sourceMesh.setIndices(e,t)}return this.sourceMesh};i.prototype.isVerticesDataPresent=function(e){return this._sourceMesh.isVerticesDataPresent(e)};i.prototype.getIndices=function(){return this._sourceMesh.getIndices()};Object.defineProperty(i.prototype,"_positions",{get:function(){return this._sourceMesh._positions},enumerable:true,configurable:true});i.prototype.refreshBoundingInfo=function(){var t=this._sourceMesh.getBoundingInfo();this._boundingInfo=new e.BoundingInfo(t.minimum.clone(),t.maximum.clone());this._updateBoundingInfo();return this};i.prototype._preActivate=function(){if(this._currentLOD){this._currentLOD._preActivate()}return this};i.prototype._activate=function(e){if(this._currentLOD){this._currentLOD._registerInstanceForRenderId(this,e)}return this};i.prototype.getLOD=function(e){if(!e){return this}var t=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,t.boundingSphere);if(this._currentLOD===this.sourceMesh){return this}return this._currentLOD};i.prototype._syncSubMeshes=function(){this.releaseSubMeshes();if(this._sourceMesh.subMeshes){for(var e=0;e<this._sourceMesh.subMeshes.length;e++){this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh)}}return this};i.prototype._generatePointsArray=function(){return this._sourceMesh._generatePointsArray()};i.prototype.clone=function(t,i,r){var n=this._sourceMesh.createInstance(t);e.Tools.DeepCopy(this,n,["name","subMeshes","uniqueId"],[]);this.refreshBoundingInfo();if(i){n.parent=i}if(!r){for(var o=0;o<this.getScene().meshes.length;o++){var s=this.getScene().meshes[o];if(s.parent===this){s.clone(s.name,n)}}}n.computeWorldMatrix(true);return n};i.prototype.dispose=function(e,i){if(i===void 0){i=false}var r=this._sourceMesh.instances.indexOf(this);this._sourceMesh.instances.splice(r,1);t.prototype.dispose.call(this,e,i)};return i}(e.AbstractMesh);e.InstancedMesh=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u){if(r===void 0){r=null}if(n===void 0){n=null}var l=t.call(this,i,r,n,o,s)||this;l.useVertexColor=a;l.useVertexAlpha=u;l.color=new e.Color3(1,1,1);l.alpha=1;if(o){l.color=o.color.clone();l.alpha=o.alpha;l.useVertexColor=o.useVertexColor;l.useVertexAlpha=o.useVertexAlpha}l._intersectionThreshold=.1;var c=[];var h={attributes:[e.VertexBuffer.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:true,defines:c};if(u===false){h.needAlphaBlending=false}if(!a){h.uniforms.push("color")}else{h.defines.push("#define VERTEXCOLOR");h.attributes.push(e.VertexBuffer.ColorKind)}l._colorShader=new e.ShaderMaterial("colorShader",l.getScene(),"color",h);return l}Object.defineProperty(i.prototype,"intersectionThreshold",{get:function(){return this._intersectionThreshold},set:function(t){if(this._intersectionThreshold===t){return}this._intersectionThreshold=t;if(this.geometry){this.geometry.boundingBias=new e.Vector2(0,t)}},enumerable:true,configurable:true});i.prototype.getClassName=function(){return"LinesMesh"};Object.defineProperty(i.prototype,"material",{get:function(){return this._colorShader},set:function(e){},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"checkCollisions",{get:function(){return false},enumerable:true,configurable:true});i.prototype.createInstance=function(e){throw new Error("LinesMeshes do not support createInstance.")};i.prototype._bind=function(e,t,i){if(!this._geometry){return this}this._geometry._bind(this._colorShader.getEffect());if(!this.useVertexColor){this._colorShader.setColor4("color",this.color.toColor4(this.alpha))}return this};i.prototype._draw=function(t,i,r){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer()){return this}var n=this.getScene().getEngine();n.drawElementsType(e.Material.LineListDrawMode,t.indexStart,t.indexCount);return this};i.prototype.dispose=function(e){this._colorShader.dispose();t.prototype.dispose.call(this,e)};i.prototype.clone=function(e,t,r){return new i(e,this.getScene(),t,this,r)};return i}(e.Mesh);e.LinesMesh=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){}t.updateSideOrientation=function(t){if(t==e.Mesh.DOUBLESIDE){return e.Mesh.DOUBLESIDE}if(t===undefined||t===null){return e.Mesh.FRONTSIDE}return t};t.CreateBox=function(i,r,n){if(n===void 0){n=null}var o=new e.Mesh(i,n);r.sideOrientation=t.updateSideOrientation(r.sideOrientation);o._originalBuilderSideOrientation=r.sideOrientation;var s=e.VertexData.CreateBox(r);s.applyToMesh(o,r.updatable);return o};t.CreateSphere=function(i,r,n){var o=new e.Mesh(i,n);r.sideOrientation=t.updateSideOrientation(r.sideOrientation);o._originalBuilderSideOrientation=r.sideOrientation;var s=e.VertexData.CreateSphere(r);s.applyToMesh(o,r.updatable);return o};t.CreateDisc=function(i,r,n){if(n===void 0){n=null}var o=new e.Mesh(i,n);r.sideOrientation=t.updateSideOrientation(r.sideOrientation);o._originalBuilderSideOrientation=r.sideOrientation;var s=e.VertexData.CreateDisc(r);s.applyToMesh(o,r.updatable);return o};t.CreateIcoSphere=function(i,r,n){var o=new e.Mesh(i,n);r.sideOrientation=t.updateSideOrientation(r.sideOrientation);o._originalBuilderSideOrientation=r.sideOrientation;var s=e.VertexData.CreateIcoSphere(r);s.applyToMesh(o,r.updatable);return o};t.CreateRibbon=function(i,r,n){if(n===void 0){n=null}var o=r.pathArray;var s=r.closeArray;var a=r.closePath;var u=t.updateSideOrientation(r.sideOrientation);var l=r.instance;var c=r.updatable;if(l){e.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,e.Tmp.Vector3[0]);e.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,e.Tmp.Vector3[1]);var h=function(t){var i=o[0].length;var r=0;var n=l._originalBuilderSideOrientation===e.Mesh.DOUBLESIDE?2:1;for(var s=1;s<=n;s++){for(var a=0;a<o.length;a++){var u=o[a];var c=u.length;i=i<c?i:c;var h=0;while(h<i){t[r]=u[h].x;t[r+1]=u[h].y;t[r+2]=u[h].z;if(u[h].x<e.Tmp.Vector3[0].x){e.Tmp.Vector3[0].x=u[h].x}if(u[h].x>e.Tmp.Vector3[1].x){e.Tmp.Vector3[1].x=u[h].x}if(u[h].y<e.Tmp.Vector3[0].y){e.Tmp.Vector3[0].y=u[h].y}if(u[h].y>e.Tmp.Vector3[1].y){e.Tmp.Vector3[1].y=u[h].y}if(u[h].z<e.Tmp.Vector3[0].z){e.Tmp.Vector3[0].z=u[h].z}if(u[h].z>e.Tmp.Vector3[1].z){e.Tmp.Vector3[1].z=u[h].z}h++;r+=3}if(l._closePath){t[r]=u[0].x;t[r+1]=u[0].y;t[r+2]=u[0].z;r+=3}}}};var f=l.getVerticesData(e.VertexBuffer.PositionKind);h(f);l._boundingInfo=new e.BoundingInfo(e.Tmp.Vector3[0],e.Tmp.Vector3[1]);l._boundingInfo.update(l._worldMatrix);l.updateVerticesData(e.VertexBuffer.PositionKind,f,false,false);if(r.colors){var d=l.getVerticesData(e.VertexBuffer.ColorKind);for(var p=0;p<r.colors.length;p++){d[p*4]=r.colors[p].r;d[p*4+1]=r.colors[p].g;d[p*4+2]=r.colors[p].b;d[p*4+3]=r.colors[p].a}l.updateVerticesData(e.VertexBuffer.ColorKind,d,false,false)}if(r.uvs){var _=l.getVerticesData(e.VertexBuffer.UVKind);for(var m=0;m<r.uvs.length;m++){_[m*2]=r.uvs[m].x;_[m*2+1]=r.uvs[m].y}l.updateVerticesData(e.VertexBuffer.UVKind,_,false,false)}if(!l.areNormalsFrozen||l.isFacetDataEnabled){var g=l.getIndices();var v=l.getVerticesData(e.VertexBuffer.NormalKind);var y=l.isFacetDataEnabled?l.getFacetDataParameters():null;e.VertexData.ComputeNormals(f,g,v,y);if(l._closePath){var b=0;var x=0;for(var T=0;T<o.length;T++){b=l._idx[T]*3;if(T+1<o.length){x=(l._idx[T+1]-1)*3}else{x=v.length-3}v[b]=(v[b]+v[x])*.5;v[b+1]=(v[b+1]+v[x+1])*.5;v[b+2]=(v[b+2]+v[x+2])*.5;v[x]=v[b];v[x+1]=v[b+1];v[x+2]=v[b+2]}}if(!l.areNormalsFrozen){l.updateVerticesData(e.VertexBuffer.NormalKind,v,false,false)}}return l}else{var E=new e.Mesh(i,n);E._originalBuilderSideOrientation=u;var P=e.VertexData.CreateRibbon(r);if(a){E._idx=P._idx}E._closePath=a;E._closeArray=s;P.applyToMesh(E,c);return E}};t.CreateCylinder=function(i,r,n){var o=new e.Mesh(i,n);r.sideOrientation=t.updateSideOrientation(r.sideOrientation);o._originalBuilderSideOrientation=r.sideOrientation;var s=e.VertexData.CreateCylinder(r);s.applyToMesh(o,r.updatable);return o};t.CreateTorus=function(i,r,n){var o=new e.Mesh(i,n);r.sideOrientation=t.updateSideOrientation(r.sideOrientation);o._originalBuilderSideOrientation=r.sideOrientation;var s=e.VertexData.CreateTorus(r);s.applyToMesh(o,r.updatable);return o};t.CreateTorusKnot=function(i,r,n){var o=new e.Mesh(i,n);r.sideOrientation=t.updateSideOrientation(r.sideOrientation);o._originalBuilderSideOrientation=r.sideOrientation;var s=e.VertexData.CreateTorusKnot(r);s.applyToMesh(o,r.updatable);return o};t.CreateLineSystem=function(t,i,r){var n=i.instance;var o=i.lines;var s=i.colors;if(n){var a=n.getVerticesData(e.VertexBuffer.PositionKind);var u;var l;if(s){u=n.getVerticesData(e.VertexBuffer.ColorKind)}var c=0;var h=0;for(var f=0;f<o.length;f++){var d=o[f];for(var p=0;p<d.length;p++){a[c]=d[p].x;a[c+1]=d[p].y;a[c+2]=d[p].z;if(s&&u){l=s[f];u[h]=l[p].r;u[h+1]=l[p].g;u[h+2]=l[p].b;u[h+3]=l[p].a;h+=4}c+=3}}n.updateVerticesData(e.VertexBuffer.PositionKind,a,false,false);if(s&&u){n.updateVerticesData(e.VertexBuffer.ColorKind,u,false,false)}return n}var _=s?true:false;var m=new e.LinesMesh(t,r,null,undefined,undefined,_,i.useVertexAlpha);var g=e.VertexData.CreateLineSystem(i);g.applyToMesh(m,i.updatable);return m};t.CreateLines=function(e,i,r){if(r===void 0){r=null}var n=i.colors?[i.colors]:null;var o=t.CreateLineSystem(e,{lines:[i.points],updatable:i.updatable,instance:i.instance,colors:n,useVertexAlpha:i.useVertexAlpha},r);return o};t.CreateDashedLines=function(t,i,r){if(r===void 0){r=null}var n=i.points;var o=i.instance;var s=i.gapSize||1;var a=i.dashSize||3;if(o){var u=function(t){var i=e.Vector3.Zero();var r=t.length/6;var s=0;var a=0;var u=0;var l=0;var c=0;var h=0;var f=0;var d=0;for(f=0;f<n.length-1;f++){n[f+1].subtractToRef(n[f],i);s+=i.length()}u=s/r;l=o.dashSize*u/(o.dashSize+o.gapSize);for(f=0;f<n.length-1;f++){n[f+1].subtractToRef(n[f],i);a=Math.floor(i.length()/u);i.normalize();d=0;while(d<a&&h<t.length){c=u*d;t[h]=n[f].x+c*i.x;t[h+1]=n[f].y+c*i.y;t[h+2]=n[f].z+c*i.z;t[h+3]=n[f].x+(c+l)*i.x;t[h+4]=n[f].y+(c+l)*i.y;t[h+5]=n[f].z+(c+l)*i.z;h+=6;d++}}while(h<t.length){t[h]=n[f].x;t[h+1]=n[f].y;t[h+2]=n[f].z;h+=3}};o.updateMeshPositions(u,false);return o}var l=new e.LinesMesh(t,r);var c=e.VertexData.CreateDashedLines(i);c.applyToMesh(l,i.updatable);l.dashSize=a;l.gapSize=s;return l};t.ExtrudeShape=function(i,r,n){if(n===void 0){n=null}var o=r.path;var s=r.shape;var a=r.scale||1;var u=r.rotation||0;var l=r.cap===0?0:r.cap||e.Mesh.NO_CAP;var c=r.updatable;var h=t.updateSideOrientation(r.sideOrientation);var f=r.instance||null;var d=r.invertUV||false;return t._ExtrudeShapeGeneric(i,s,o,a,u,null,null,false,false,l,false,n,c?true:false,h,f,d,r.frontUVs||null,r.backUVs||null)};t.ExtrudeShapeCustom=function(i,r,n){var o=r.path;var s=r.shape;var a=r.scaleFunction||function(){return 1};var u=r.rotationFunction||function(){return 0};var l=r.ribbonCloseArray||false;var c=r.ribbonClosePath||false;var h=r.cap===0?0:r.cap||e.Mesh.NO_CAP;var f=r.updatable;var d=t.updateSideOrientation(r.sideOrientation);var p=r.instance;var _=r.invertUV||false;return t._ExtrudeShapeGeneric(i,s,o,null,null,a,u,l,c,h,true,n,f?true:false,d,p||null,_,r.frontUVs||null,r.backUVs||null)};t.CreateLathe=function(i,r,n){var o=r.arc?r.arc<=0||r.arc>1?1:r.arc:1;var s=r.closed===undefined?true:r.closed;var a=r.shape;var u=r.radius||1;var l=r.tessellation||64;var c=r.updatable;var h=t.updateSideOrientation(r.sideOrientation);var f=r.cap||e.Mesh.NO_CAP;var d=Math.PI*2;var p=new Array;var _=r.invertUV||false;var m=0;var g=0;var v=d/l*o;var y;var b=new Array;for(m=0;m<=l;m++){var b=[];if(f==e.Mesh.CAP_START||f==e.Mesh.CAP_ALL){b.push(new e.Vector3(0,a[0].y,0));b.push(new e.Vector3(Math.cos(m*v)*a[0].x*u,a[0].y,Math.sin(m*v)*a[0].x*u))}for(g=0;g<a.length;g++){y=new e.Vector3(Math.cos(m*v)*a[g].x*u,a[g].y,Math.sin(m*v)*a[g].x*u);b.push(y)}if(f==e.Mesh.CAP_END||f==e.Mesh.CAP_ALL){b.push(new e.Vector3(Math.cos(m*v)*a[a.length-1].x*u,a[a.length-1].y,Math.sin(m*v)*a[a.length-1].x*u));b.push(new e.Vector3(0,a[a.length-1].y,0))}p.push(b)}var x=t.CreateRibbon(i,{pathArray:p,closeArray:s,sideOrientation:h,updatable:c,invertUV:_,frontUVs:r.frontUVs,backUVs:r.backUVs},n);return x};t.CreatePlane=function(i,r,n){var o=new e.Mesh(i,n);r.sideOrientation=t.updateSideOrientation(r.sideOrientation);o._originalBuilderSideOrientation=r.sideOrientation;var s=e.VertexData.CreatePlane(r);s.applyToMesh(o,r.updatable);if(r.sourcePlane){o.translate(r.sourcePlane.normal,r.sourcePlane.d);var a=Math.acos(e.Vector3.Dot(r.sourcePlane.normal,e.Axis.Z));var u=e.Vector3.Cross(e.Axis.Z,r.sourcePlane.normal);o.rotate(u,a)}return o};t.CreateGround=function(t,i,r){var n=new e.GroundMesh(t,r);n._setReady(false);n._subdivisionsX=i.subdivisionsX||i.subdivisions||1;n._subdivisionsY=i.subdivisionsY||i.subdivisions||1;n._width=i.width||1;n._height=i.height||1;n._maxX=n._width/2;n._maxZ=n._height/2;n._minX=-n._maxX;n._minZ=-n._maxZ;var o=e.VertexData.CreateGround(i);o.applyToMesh(n,i.updatable);n._setReady(true);return n};t.CreateTiledGround=function(t,i,r){var n=new e.Mesh(t,r);var o=e.VertexData.CreateTiledGround(i);o.applyToMesh(n,i.updatable);return n};t.CreateGroundFromHeightMap=function(t,i,r,n){var o=r.width||10;var s=r.height||10;var a=r.subdivisions||1|0;var u=r.minHeight||0;var l=r.maxHeight||1;var c=r.colorFilter||new e.Color3(.3,.59,.11);var h=r.updatable;var f=r.onReady;var d=new e.GroundMesh(t,n);d._subdivisionsX=a;d._subdivisionsY=a;d._width=o;d._height=s;d._maxX=d._width/2;d._maxZ=d._height/2;d._minX=-d._maxX;d._minZ=-d._maxZ;d._setReady(false);var p=function(t){var i=document.createElement("canvas");var r=i.getContext("2d");if(!r){throw new Error("Unable to get 2d context for CreateGroundFromHeightMap")}if(n.isDisposed){return}var p=t.width;var _=t.height;i.width=p;i.height=_;r.drawImage(t,0,0);var m=r.getImageData(0,0,p,_).data;var g=e.VertexData.CreateGroundFromHeightMap({width:o,height:s,subdivisions:a,minHeight:u,maxHeight:l,colorFilter:c,buffer:m,bufferWidth:p,bufferHeight:_});g.applyToMesh(d,h);if(f){f(d)}d._setReady(true)};e.Tools.LoadImage(i,p,function(){},n.database);return d};t.CreatePolygon=function(i,r,n){r.sideOrientation=t.updateSideOrientation(r.sideOrientation);var o=r.shape;var s=r.holes||[];var a=r.depth||0;var u=[];var l=[];for(var c=0;c<o.length;c++){u[c]=new e.Vector2(o[c].x,o[c].z)}var h=1e-8;if(u[0].equalsWithEpsilon(u[u.length-1],h)){u.pop()}var f=new e.PolygonMeshBuilder(i,u,n);for(var d=0;d<s.length;d++){l=[];for(var p=0;p<s[d].length;p++){l.push(new e.Vector2(s[d][p].x,s[d][p].z))}f.addHole(l)}var _=f.build(r.updatable,a);_._originalBuilderSideOrientation=r.sideOrientation;var m=e.VertexData.CreatePolygon(_,r.sideOrientation,r.faceUV,r.faceColors,r.frontUVs,r.backUVs);m.applyToMesh(_,r.updatable);return _};t.ExtrudePolygon=function(e,i,r){return t.CreatePolygon(e,i,r)};t.CreateTube=function(i,r,n){var o=r.path;var s=r.instance;var a=1;if(s){a=s.radius}if(r.radius!==undefined){a=r.radius}var u=r.tessellation||64|0;var l=r.radiusFunction||null;var c=r.cap||e.Mesh.NO_CAP;var h=r.invertUV||false;var f=r.updatable;var d=t.updateSideOrientation(r.sideOrientation);r.arc=r.arc&&(r.arc<=0||r.arc>1)?1:r.arc||1;var p=function(t,i,r,n,o,s,a,u){var l=i.getTangents();var c=i.getNormals();var h=i.getDistances();var f=Math.PI*2;var d=f/o*u;var p=function(){return n};var _=s||p;var m;var g;var v;var y;var b=e.Tmp.Matrix[0];var x=a===e.Mesh._NO_CAP||a===e.Mesh.CAP_END?0:2;for(var T=0;T<t.length;T++){g=_(T,h[T]);m=Array();v=c[T];for(var E=0;E<o;E++){e.Matrix.RotationAxisToRef(l[T],d*E,b);y=m[E]?m[E]:e.Vector3.Zero();e.Vector3.TransformCoordinatesToRef(v,b,y);y.scaleInPlace(g).addInPlace(t[T]);m[E]=y}r[x]=m;x++}var P=function(e,i){var r=Array();for(var n=0;n<e;n++){r.push(t[i])}return r};switch(a){case e.Mesh.NO_CAP:break;case e.Mesh.CAP_START:r[0]=P(o,0);r[1]=r[2].slice(0);break;case e.Mesh.CAP_END:r[x]=r[x-1].slice(0);r[x+1]=P(o,t.length-1);break;case e.Mesh.CAP_ALL:r[0]=P(o,0);r[1]=r[2].slice(0);r[x]=r[x-1].slice(0);r[x+1]=P(o,t.length-1);break;default:break}return r};var _;var m;if(s){var g=r.arc||s.arc;_=s.path3D.update(o);m=p(o,_,s.pathArray,a,s.tessellation,l,s.cap,g);s=t.CreateRibbon("",{pathArray:m,instance:s});s.path3D=_;s.pathArray=m;s.arc=g;s.radius=a;return s}_=new e.Path3D(o);var v=new Array;c=c<0||c>3?0:c;m=p(o,_,v,a,u,l,c,r.arc);var y=t.CreateRibbon(i,{pathArray:m,closePath:true,closeArray:false,updatable:f,sideOrientation:d,invertUV:h,frontUVs:r.frontUVs,backUVs:r.backUVs},n);y.pathArray=m;y.path3D=_;y.tessellation=u;y.cap=c;y.arc=r.arc;y.radius=a;return y};t.CreatePolyhedron=function(i,r,n){var o=new e.Mesh(i,n);r.sideOrientation=t.updateSideOrientation(r.sideOrientation);o._originalBuilderSideOrientation=r.sideOrientation;var s=e.VertexData.CreatePolyhedron(r);s.applyToMesh(o,r.updatable);return o};t.CreateDecal=function(t,i,r){var n=i.getIndices();var o=i.getVerticesData(e.VertexBuffer.PositionKind);var s=i.getVerticesData(e.VertexBuffer.NormalKind);var a=r.position||e.Vector3.Zero();var u=r.normal||e.Vector3.Up();var l=r.size||e.Vector3.One();var c=r.angle||0;if(!u){var h=new e.Vector3(0,0,1);var f=i.getScene().activeCamera;var d=e.Vector3.TransformCoordinates(h,f.getWorldMatrix());u=f.globalPosition.subtract(d)}var p=-Math.atan2(u.z,u.x)-Math.PI/2;var _=Math.sqrt(u.x*u.x+u.z*u.z);var m=Math.atan2(u.y,_);var g=e.Matrix.RotationYawPitchRoll(p,m,c).multiply(e.Matrix.Translation(a.x,a.y,a.z));var v=e.Matrix.Invert(g);var y=i.getWorldMatrix();var b=y.multiply(v);var x=new e.VertexData;x.indices=[];x.positions=[];x.normals=[];x.uvs=[];var T=0;var E=function(t){var i=new e.PositionNormalVertex;if(!n||!o||!s){return i}var r=n[t];i.position=new e.Vector3(o[r*3],o[r*3+1],o[r*3+2]);i.position=e.Vector3.TransformCoordinates(i.position,b);i.normal=new e.Vector3(s[r*3],s[r*3+1],s[r*3+2])
;i.normal=e.Vector3.TransformNormal(i.normal,b);return i};var P=function(t,i){if(t.length===0){return t}var r=.5*Math.abs(e.Vector3.Dot(l,i));var n=function(t,n){var o=e.Vector3.GetClipFactor(t.position,n.position,i,r);return new e.PositionNormalVertex(e.Vector3.Lerp(t.position,n.position,o),e.Vector3.Lerp(t.normal,n.normal,o))};var o=new Array;for(var s=0;s<t.length;s+=3){var a;var u;var c;var h=0;var f=null;var d=null;var p=null;var _=null;var m=e.Vector3.Dot(t[s].position,i)-r;var g=e.Vector3.Dot(t[s+1].position,i)-r;var v=e.Vector3.Dot(t[s+2].position,i)-r;a=m>0;u=g>0;c=v>0;h=(a?1:0)+(u?1:0)+(c?1:0);switch(h){case 0:o.push(t[s]);o.push(t[s+1]);o.push(t[s+2]);break;case 1:if(a){f=t[s+1];d=t[s+2];p=n(t[s],f);_=n(t[s],d)}if(u){f=t[s];d=t[s+2];p=n(t[s+1],f);_=n(t[s+1],d);o.push(p);o.push(d.clone());o.push(f.clone());o.push(d.clone());o.push(p.clone());o.push(_);break}if(c){f=t[s];d=t[s+1];p=n(t[s+2],f);_=n(t[s+2],d)}if(f&&d&&p&&_){o.push(f.clone());o.push(d.clone());o.push(p);o.push(_);o.push(p.clone());o.push(d.clone())}break;case 2:if(!a){f=t[s].clone();d=n(f,t[s+1]);p=n(f,t[s+2]);o.push(f);o.push(d);o.push(p)}if(!u){f=t[s+1].clone();d=n(f,t[s+2]);p=n(f,t[s]);o.push(f);o.push(d);o.push(p)}if(!c){f=t[s+2].clone();d=n(f,t[s]);p=n(f,t[s+1]);o.push(f);o.push(d);o.push(p)}break;case 3:break}}return o};for(var A=0;A<n.length;A+=3){var M=new Array;M.push(E(A));M.push(E(A+1));M.push(E(A+2));M=P(M,new e.Vector3(1,0,0));M=P(M,new e.Vector3(-1,0,0));M=P(M,new e.Vector3(0,1,0));M=P(M,new e.Vector3(0,-1,0));M=P(M,new e.Vector3(0,0,1));M=P(M,new e.Vector3(0,0,-1));if(M.length===0){continue}for(var S=0;S<M.length;S++){var C=M[S];x.indices.push(T);C.position.toArray(x.positions,T*3);C.normal.toArray(x.normals,T*3);x.uvs.push(.5+C.position.x/l.x);x.uvs.push(.5+C.position.y/l.y);T++}}var R=new e.Mesh(t,i.getScene());x.applyToMesh(R);R.position=a.clone();R.rotation=new e.Vector3(m,p,c);return R};t._ExtrudeShapeGeneric=function(i,r,n,o,s,a,u,l,c,h,f,d,p,_,m,g,v,y){var b=function(t,i,r,n,o,s,a,u,l,c){var h=r.getTangents();var f=r.getNormals();var d=r.getBinormals();var p=r.getDistances();var _=0;var m=function(){return o!==null?o:1};var g=function(){return s!==null?s:0};var v=c&&u?u:g;var y=c&&a?a:m;var b=l===e.Mesh.NO_CAP||l===e.Mesh.CAP_END?0:2;var x=e.Tmp.Matrix[0];for(var T=0;T<i.length;T++){var E=new Array;var P=v(T,p[T]);var A=y(T,p[T]);for(var M=0;M<t.length;M++){e.Matrix.RotationAxisToRef(h[T],_,x);var S=h[T].scale(t[M].z).add(f[T].scale(t[M].x)).add(d[T].scale(t[M].y));var C=E[M]?E[M]:e.Vector3.Zero();e.Vector3.TransformCoordinatesToRef(S,x,C);C.scaleInPlace(A).addInPlace(i[T]);E[M]=C}n[b]=E;_+=P;b++}var R=function(t){var i=Array();var r=e.Vector3.Zero();var n;for(n=0;n<t.length;n++){r.addInPlace(t[n])}r.scaleInPlace(1/t.length);for(n=0;n<t.length;n++){i.push(r)}return i};switch(l){case e.Mesh.NO_CAP:break;case e.Mesh.CAP_START:n[0]=R(n[2]);n[1]=n[2];break;case e.Mesh.CAP_END:n[b]=n[b-1];n[b+1]=R(n[b-1]);break;case e.Mesh.CAP_ALL:n[0]=R(n[2]);n[1]=n[2];n[b]=n[b-1];n[b+1]=R(n[b-1]);break;default:break}return n};var x;var T;if(m){x=m.path3D.update(n);T=b(r,n,m.path3D,m.pathArray,o,s,a,u,m.cap,f);m=e.Mesh.CreateRibbon("",T,false,false,0,d||undefined,false,0,m);return m}x=new e.Path3D(n);var E=new Array;h=h<0||h>3?0:h;T=b(r,n,x,E,o,s,a,u,h,f);var P=t.CreateRibbon(i,{pathArray:T,closeArray:l,closePath:c,updatable:p,sideOrientation:_,invertUV:g,frontUVs:v||undefined,backUVs:y||undefined},d);P.pathArray=T;P.path3D=x;P.cap=h;return P};return t}();e.MeshBuilder=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(i){if(i===void 0){i=navigator.hardwareConcurrency||4}var r=URL&&URL.createObjectURL&&URL.createObjectURL(new Blob(["("+t._Worker.toString()+")()"],{type:"application/javascript"}));if(!r||!Worker){e.Tools.Error("Draco Compression disabled. The current context doesn't support worker creation or URL.createObjectURL");return}var n=new Array(i);for(var o=0;o<n.length;o++){var s=new Worker(r);s.postMessage({id:"initDecoder",url:t.DecoderUrl});n[o]=s}this._workerPool=new e.WorkerPool(n)}t.prototype.dispose=function(){this._workerPool.dispose();delete this._workerPool};t.prototype.decodeMeshAsync=function(t,i){var r=this;return new Promise(function(n,o){r._workerPool.push(function(r,s){var a=new e.VertexData;var u=function(e){r.removeEventListener("error",u);r.removeEventListener("message",l);o(e);s()};var l=function(e){if(e.data==="done"){r.removeEventListener("error",u);r.removeEventListener("message",l);n(a);s()}else if(e.data.id==="indices"){a.indices=e.data.value}else{a.set(e.data.value,e.data.id)}};r.addEventListener("error",u);r.addEventListener("message",l);var c=new Uint8Array(t.byteLength);c.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength));r.postMessage({id:"decodeMesh",data:c,attributes:i},[c.buffer])})})};t._Worker=function(){var e=self;var t=function(t,i){var r=new DracoDecoderModule;var n=new r.DecoderBuffer;n.Init(t,t.byteLength);var o=new r.Decoder;var s;var a;try{var u=o.GetEncodedGeometryType(n);switch(u){case r.TRIANGULAR_MESH:s=new r.Mesh;a=o.DecodeBufferToMesh(n,s);break;case r.POINT_CLOUD:s=new r.PointCloud;a=o.DecodeBufferToPointCloud(n,s);break;default:throw new Error("Invalid geometry type "+u)}if(!a.ok()||!s.ptr){throw new Error(a.error_msg())}var l=s.num_points();if(u===r.TRIANGULAR_MESH){var c=s.num_faces();var h=new r.DracoInt32Array;try{var f=new Uint32Array(c*3);for(var d=0;d<c;d++){o.GetFaceFromMesh(s,d,h);var p=d*3;f[p+0]=h.GetValue(0);f[p+1]=h.GetValue(1);f[p+2]=h.GetValue(2)}e.postMessage({id:"indices",value:f},[f.buffer])}finally{r.destroy(h)}}for(var _ in i){var m=i[_];var g=o.GetAttributeByUniqueId(s,m);var v=new r.DracoFloat32Array;try{o.GetAttributeFloatForAllPoints(s,g,v);var y=new Float32Array(l*g.num_components());for(var d=0;d<y.length;d++){y[d]=v.GetValue(d)}e.postMessage({id:_,value:y},[y.buffer])}finally{r.destroy(v)}}}finally{if(s){r.destroy(s)}r.destroy(o);r.destroy(n)}e.postMessage("done")};e.onmessage=function(e){switch(e.data.id){case"initDecoder":{importScripts(e.data.url);break}case"decodeMesh":{t(e.data.data,e.data.attributes);break}}}};t._GetDefaultDecoderUrl=function(){if(!e.Tools.IsWindowObjectExist()){return null}for(var t=0;t<document.scripts.length;t++){if(document.scripts[t].type==="text/x-draco-decoder"){return document.scripts[t].src}}return null};t.DecoderUrl=t._GetDefaultDecoderUrl();return t}();e.DracoCompression=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this._audioContext=null;this._audioContextInitialized=false;this.canUseWebAudio=false;this.WarnedWebAudioUnsupported=false;this.unlocked=false;this.isMP3supported=false;this.isOGGsupported=false;if(typeof window.AudioContext!=="undefined"||typeof window.webkitAudioContext!=="undefined"){window.AudioContext=window.AudioContext||window.webkitAudioContext;this.canUseWebAudio=true}var e=document.createElement("audio");try{if(e&&!!e.canPlayType&&e.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")){this.isMP3supported=true}}catch(e){}try{if(e&&!!e.canPlayType&&e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")){this.isOGGsupported=true}}catch(e){}if(/iPad|iPhone|iPod/.test(navigator.platform)){this._unlockiOSaudio()}else{this.unlocked=true}}Object.defineProperty(t.prototype,"audioContext",{get:function(){if(!this._audioContextInitialized){this._initializeAudioContext()}return this._audioContext},enumerable:true,configurable:true});t.prototype._unlockiOSaudio=function(){var e=this;var t=function(){if(!e.audioContext){return}var i=e.audioContext.createBuffer(1,1,22050);var r=e.audioContext.createBufferSource();r.buffer=i;r.connect(e.audioContext.destination);r.start(0);setTimeout(function(){if(r.playbackState===r.PLAYING_STATE||r.playbackState===r.FINISHED_STATE){e.unlocked=true;window.removeEventListener("touchend",t,false);if(e.onAudioUnlocked){e.onAudioUnlocked()}}},0)};window.addEventListener("touchend",t,false)};t.prototype._initializeAudioContext=function(){try{if(this.canUseWebAudio){this._audioContext=new AudioContext;this.masterGain=this._audioContext.createGain();this.masterGain.gain.value=1;this.masterGain.connect(this._audioContext.destination);this._audioContextInitialized=true}}catch(t){this.canUseWebAudio=false;e.Tools.Error("Web Audio: "+t.message)}};t.prototype.dispose=function(){if(this.canUseWebAudio&&this._audioContextInitialized){if(this._connectedAnalyser&&this._audioContext){this._connectedAnalyser.stopDebugCanvas();this._connectedAnalyser.dispose();this.masterGain.disconnect();this.masterGain.connect(this._audioContext.destination);this._connectedAnalyser=null}this.masterGain.gain.value=1}this.WarnedWebAudioUnsupported=false};t.prototype.getGlobalVolume=function(){if(this.canUseWebAudio&&this._audioContextInitialized){return this.masterGain.gain.value}else{return-1}};t.prototype.setGlobalVolume=function(e){if(this.canUseWebAudio&&this._audioContextInitialized){this.masterGain.gain.value=e}};t.prototype.connectToAnalyser=function(e){if(this._connectedAnalyser){this._connectedAnalyser.stopDebugCanvas()}if(this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext){this._connectedAnalyser=e;this.masterGain.disconnect();this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination)}};return t}();e.AudioEngine=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r,n,o){if(n===void 0){n=null}var s=this;this.autoplay=false;this.loop=false;this.useCustomAttenuation=false;this.spatialSound=false;this.refDistance=1;this.rolloffFactor=1;this.maxDistance=100;this.distanceModel="linear";this._panningModel="equalpower";this._playbackRate=1;this._streaming=false;this._startTime=0;this._startOffset=0;this._position=e.Vector3.Zero();this._localDirection=new e.Vector3(1,0,0);this._volume=1;this._isReadyToPlay=false;this.isPlaying=false;this.isPaused=false;this._isDirectional=false;this._coneInnerAngle=360;this._coneOuterAngle=360;this._coneOuterGain=0;this._isOutputConnected=false;this._urlType="Unknown";this.name=t;this._scene=r;this._readyToPlayCallback=n;this._customAttenuationFunction=function(e,t,i,r,n){if(t<i){return e*(1-t/i)}else{return 0}};if(o){this.autoplay=o.autoplay||false;this.loop=o.loop||false;if(o.volume!==undefined){this._volume=o.volume}this.spatialSound=o.spatialSound||false;this.maxDistance=o.maxDistance||100;this.useCustomAttenuation=o.useCustomAttenuation||false;this.rolloffFactor=o.rolloffFactor||1;this.refDistance=o.refDistance||1;this.distanceModel=o.distanceModel||"linear";this._playbackRate=o.playbackRate||1;this._streaming=o.streaming||false}if(e.Engine.audioEngine.canUseWebAudio&&e.Engine.audioEngine.audioContext){this._soundGain=e.Engine.audioEngine.audioContext.createGain();this._soundGain.gain.value=this._volume;this._inputAudioNode=this._soundGain;this._ouputAudioNode=this._soundGain;if(this.spatialSound){this._createSpatialParameters()}this._scene.mainSoundTrack.AddSound(this);var a=true;if(i){try{if(typeof i==="string")this._urlType="String";if(Array.isArray(i))this._urlType="Array";if(i instanceof ArrayBuffer)this._urlType="ArrayBuffer";var u=[];var l=false;switch(this._urlType){case"ArrayBuffer":if(i.byteLength>0){l=true;this._soundLoaded(i)}break;case"String":u.push(i);case"Array":if(u.length===0)u=i;for(var c=0;c<u.length;c++){var h=u[c];if(h.indexOf(".mp3",h.length-4)!==-1&&e.Engine.audioEngine.isMP3supported){l=true}if(h.indexOf(".ogg",h.length-4)!==-1&&e.Engine.audioEngine.isOGGsupported){l=true}if(h.indexOf(".wav",h.length-4)!==-1){l=true}if(h.indexOf("blob:")!==-1){l=true}if(l){if(!this._streaming){this._scene._loadFile(h,function(e){s._soundLoaded(e)},undefined,true,true,function(t){if(t){e.Tools.Error("XHR "+t.status+" error on: "+h+".")}e.Tools.Error("Sound creation aborted.");s._scene.mainSoundTrack.RemoveSound(s)})}else{this._htmlAudioElement=new Audio(h);this._htmlAudioElement.controls=false;this._htmlAudioElement.loop=this.loop;e.Tools.SetCorsBehavior(h,this._htmlAudioElement);this._htmlAudioElement.preload="auto";this._htmlAudioElement.addEventListener("canplaythrough",function(){s._isReadyToPlay=true;if(s.autoplay){s.play()}if(s._readyToPlayCallback){s._readyToPlayCallback()}});document.body.appendChild(this._htmlAudioElement)}break}}break;default:a=false;break}if(!a){e.Tools.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}else{if(!l){this._isReadyToPlay=true;if(this._readyToPlayCallback){window.setTimeout(function(){if(s._readyToPlayCallback){s._readyToPlayCallback()}},1e3)}}}}catch(t){e.Tools.Error("Unexpected error. Sound creation aborted.");this._scene.mainSoundTrack.RemoveSound(this)}}}else{this._scene.mainSoundTrack.AddSound(this);if(!e.Engine.audioEngine.WarnedWebAudioUnsupported){e.Tools.Error("Web Audio is not supported by your browser.");e.Engine.audioEngine.WarnedWebAudioUnsupported=true}if(this._readyToPlayCallback){window.setTimeout(function(){if(s._readyToPlayCallback){s._readyToPlayCallback()}},1e3)}}}t.prototype.dispose=function(){if(e.Engine.audioEngine.canUseWebAudio){if(this.isPlaying){this.stop()}this._isReadyToPlay=false;if(this.soundTrackId===-1){this._scene.mainSoundTrack.RemoveSound(this)}else{this._scene.soundTracks[this.soundTrackId].RemoveSound(this)}if(this._soundGain){this._soundGain.disconnect();this._soundGain=null}if(this._soundPanner){this._soundPanner.disconnect();this._soundPanner=null}if(this._soundSource){this._soundSource.disconnect();this._soundSource=null}this._audioBuffer=null;if(this._htmlAudioElement){this._htmlAudioElement.pause();this._htmlAudioElement.src="";document.body.removeChild(this._htmlAudioElement)}if(this._connectedMesh&&this._registerFunc){this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc);this._connectedMesh=null}}};t.prototype.isReady=function(){return this._isReadyToPlay};t.prototype._soundLoaded=function(t){var i=this;if(!e.Engine.audioEngine.audioContext){return}e.Engine.audioEngine.audioContext.decodeAudioData(t,function(e){i._audioBuffer=e;i._isReadyToPlay=true;if(i.autoplay){i.play()}if(i._readyToPlayCallback){i._readyToPlayCallback()}},function(t){e.Tools.Error("Error while decoding audio data for: "+i.name+" / Error: "+t)})};t.prototype.setAudioBuffer=function(t){if(e.Engine.audioEngine.canUseWebAudio){this._audioBuffer=t;this._isReadyToPlay=true}};t.prototype.updateOptions=function(e){if(e){this.loop=e.loop||this.loop;this.maxDistance=e.maxDistance||this.maxDistance;this.useCustomAttenuation=e.useCustomAttenuation||this.useCustomAttenuation;this.rolloffFactor=e.rolloffFactor||this.rolloffFactor;this.refDistance=e.refDistance||this.refDistance;this.distanceModel=e.distanceModel||this.distanceModel;this._playbackRate=e.playbackRate||this._playbackRate;this._updateSpatialParameters();if(this.isPlaying){if(this._streaming){this._htmlAudioElement.playbackRate=this._playbackRate}else{if(this._soundSource){this._soundSource.playbackRate.value=this._playbackRate}}}}};t.prototype._createSpatialParameters=function(){if(e.Engine.audioEngine.canUseWebAudio&&e.Engine.audioEngine.audioContext){if(this._scene.headphone){this._panningModel="HRTF"}this._soundPanner=e.Engine.audioEngine.audioContext.createPanner();this._updateSpatialParameters();this._soundPanner.connect(this._ouputAudioNode);this._inputAudioNode=this._soundPanner}};t.prototype._updateSpatialParameters=function(){if(this.spatialSound&&this._soundPanner){if(this.useCustomAttenuation){this._soundPanner.distanceModel="linear";this._soundPanner.maxDistance=Number.MAX_VALUE;this._soundPanner.refDistance=1;this._soundPanner.rolloffFactor=1;this._soundPanner.panningModel=this._panningModel}else{this._soundPanner.distanceModel=this.distanceModel;this._soundPanner.maxDistance=this.maxDistance;this._soundPanner.refDistance=this.refDistance;this._soundPanner.rolloffFactor=this.rolloffFactor;this._soundPanner.panningModel=this._panningModel}}};t.prototype.switchPanningModelToHRTF=function(){this._panningModel="HRTF";this._switchPanningModel()};t.prototype.switchPanningModelToEqualPower=function(){this._panningModel="equalpower";this._switchPanningModel()};t.prototype._switchPanningModel=function(){if(e.Engine.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner){this._soundPanner.panningModel=this._panningModel}};t.prototype.connectToSoundTrackAudioNode=function(t){if(e.Engine.audioEngine.canUseWebAudio){if(this._isOutputConnected){this._ouputAudioNode.disconnect()}this._ouputAudioNode.connect(t);this._isOutputConnected=true}};t.prototype.setDirectionalCone=function(t,i,r){if(i<t){e.Tools.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t;this._coneOuterAngle=i;this._coneOuterGain=r;this._isDirectional=true;if(this.isPlaying&&this.loop){this.stop();this.play()}};t.prototype.setPosition=function(t){this._position=t;if(e.Engine.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner){this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z)}};t.prototype.setLocalDirectionToMesh=function(t){this._localDirection=t;if(e.Engine.audioEngine.canUseWebAudio&&this._connectedMesh&&this.isPlaying){this._updateDirection()}};t.prototype._updateDirection=function(){if(!this._connectedMesh||!this._soundPanner){return}var t=this._connectedMesh.getWorldMatrix();var i=e.Vector3.TransformNormal(this._localDirection,t);i.normalize();this._soundPanner.setOrientation(i.x,i.y,i.z)};t.prototype.updateDistanceFromListener=function(){if(e.Engine.audioEngine.canUseWebAudio&&this._connectedMesh&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){var t=this._connectedMesh.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}};t.prototype.setAttenuationFunction=function(e){this._customAttenuationFunction=e};t.prototype.play=function(t,i){var r=this;if(this._isReadyToPlay&&this._scene.audioEnabled&&e.Engine.audioEngine.audioContext){try{if(this._startOffset<0){t=-this._startOffset;this._startOffset=0}var n=t?e.Engine.audioEngine.audioContext.currentTime+t:e.Engine.audioEngine.audioContext.currentTime;if(!this._soundSource||!this._streamingSource){if(this.spatialSound&&this._soundPanner){this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z);if(this._isDirectional){this._soundPanner.coneInnerAngle=this._coneInnerAngle;this._soundPanner.coneOuterAngle=this._coneOuterAngle;this._soundPanner.coneOuterGain=this._coneOuterGain;if(this._connectedMesh){this._updateDirection()}else{this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z)}}}}if(this._streaming){if(!this._streamingSource){this._streamingSource=e.Engine.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement);this._htmlAudioElement.onended=function(){r._onended()};this._htmlAudioElement.playbackRate=this._playbackRate}this._streamingSource.disconnect();this._streamingSource.connect(this._inputAudioNode);this._htmlAudioElement.play()}else{this._soundSource=e.Engine.audioEngine.audioContext.createBufferSource();this._soundSource.buffer=this._audioBuffer;this._soundSource.connect(this._inputAudioNode);this._soundSource.loop=this.loop;this._soundSource.playbackRate.value=this._playbackRate;this._soundSource.onended=function(){r._onended()};if(this._soundSource.buffer){this._soundSource.start(n,this.isPaused?this._startOffset%this._soundSource.buffer.duration:i?i:0)}}this._startTime=n;this.isPlaying=true;this.isPaused=false}catch(t){e.Tools.Error("Error while trying to play audio: "+this.name+", "+t.message)}}};t.prototype._onended=function(){this.isPlaying=false;if(this.onended){this.onended()}};t.prototype.stop=function(t){if(this.isPlaying){if(this._streaming){this._htmlAudioElement.pause();if(this._htmlAudioElement.currentTime>0){this._htmlAudioElement.currentTime=0}}else if(e.Engine.audioEngine.audioContext&&this._soundSource){var i=t?e.Engine.audioEngine.audioContext.currentTime+t:e.Engine.audioEngine.audioContext.currentTime;this._soundSource.stop(i);this._soundSource.onended=function(){};if(!this.isPaused){this._startOffset=0}}this.isPlaying=false}};t.prototype.pause=function(){if(this.isPlaying){this.isPaused=true;if(this._streaming){this._htmlAudioElement.pause()}else if(e.Engine.audioEngine.audioContext){this.stop(0);this._startOffset+=e.Engine.audioEngine.audioContext.currentTime-this._startTime}}};t.prototype.setVolume=function(t,i){if(e.Engine.audioEngine.canUseWebAudio&&this._soundGain){if(i&&e.Engine.audioEngine.audioContext){this._soundGain.gain.cancelScheduledValues(e.Engine.audioEngine.audioContext.currentTime);this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,e.Engine.audioEngine.audioContext.currentTime);this._soundGain.gain.linearRampToValueAtTime(t,e.Engine.audioEngine.audioContext.currentTime+i)}else{this._soundGain.gain.value=t}}this._volume=t};t.prototype.setPlaybackRate=function(e){this._playbackRate=e;if(this.isPlaying){if(this._streaming){this._htmlAudioElement.playbackRate=this._playbackRate}else if(this._soundSource){this._soundSource.playbackRate.value=this._playbackRate}}};t.prototype.getVolume=function(){return this._volume};t.prototype.attachToMesh=function(e){var t=this;if(this._connectedMesh&&this._registerFunc){this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc);this._registerFunc=null}this._connectedMesh=e;if(!this.spatialSound){this.spatialSound=true;this._createSpatialParameters();if(this.isPlaying&&this.loop){this.stop();this.play()}}this._onRegisterAfterWorldMatrixUpdate(this._connectedMesh);this._registerFunc=function(e){return t._onRegisterAfterWorldMatrixUpdate(e)};e.registerAfterWorldMatrixUpdate(this._registerFunc)};t.prototype.detachFromMesh=function(){if(this._connectedMesh&&this._registerFunc){this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc);this._registerFunc=null;this._connectedMesh=null}};t.prototype._onRegisterAfterWorldMatrixUpdate=function(t){if(!t.getBoundingInfo){return}var i=t;var r=i.getBoundingInfo();this.setPosition(r.boundingSphere.centerWorld);if(e.Engine.audioEngine.canUseWebAudio&&this._isDirectional&&this.isPlaying){this._updateDirection()}};t.prototype.clone=function(){var e=this;if(!this._streaming){var i=function(){if(e._isReadyToPlay){n._audioBuffer=e.getAudioBuffer();n._isReadyToPlay=true;if(n.autoplay){n.play()}}else{window.setTimeout(i,300)}};var r={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel};var n=new t(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,r);if(this.useCustomAttenuation){n.setAttenuationFunction(this._customAttenuationFunction)}n.setPosition(this._position);n.setPlaybackRate(this._playbackRate);i();return n}else{return null}};t.prototype.getAudioBuffer=function(){return this._audioBuffer};t.prototype.serialize=function(){var e={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId};if(this.spatialSound){if(this._connectedMesh)e.connectedMeshId=this._connectedMesh.id;e.position=this._position.asArray();e.refDistance=this.refDistance;e.distanceModel=this.distanceModel;e.isDirectional=this._isDirectional;e.localDirectionToMesh=this._localDirection.asArray();e.coneInnerAngle=this._coneInnerAngle;e.coneOuterAngle=this._coneOuterAngle;e.coneOuterGain=this._coneOuterGain}return e};t.Parse=function(i,r,n,o){var s=i.name;var a;if(i.url){a=n+i.url}else{a=n+s}var u={autoplay:i.autoplay,loop:i.loop,volume:i.volume,spatialSound:i.spatialSound,maxDistance:i.maxDistance,rolloffFactor:i.rolloffFactor,refDistance:i.refDistance,distanceModel:i.distanceModel,playbackRate:i.playbackRate};var l;if(!o){l=new t(s,a,r,function(){r._removePendingData(l)},u);r._addPendingData(l)}else{var c=function(){if(o._isReadyToPlay){l._audioBuffer=o.getAudioBuffer();l._isReadyToPlay=true;if(l.autoplay){l.play()}}else{window.setTimeout(c,300)}};l=new t(s,new ArrayBuffer(0),r,null,u);c()}if(i.position){var h=e.Vector3.FromArray(i.position);l.setPosition(h)}if(i.isDirectional){l.setDirectionalCone(i.coneInnerAngle||360,i.coneOuterAngle||360,i.coneOuterGain||0);if(i.localDirectionToMesh){var f=e.Vector3.FromArray(i.localDirectionToMesh);l.setLocalDirectionToMesh(f)}}if(i.connectedMeshId){var d=r.getMeshByID(i.connectedMeshId);if(d){l.attachToMesh(d)}}return l};return t}();e.Sound=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,t){this.id=-1;this._isMainTrack=false;this._isInitialized=false;this._scene=e;this.soundCollection=new Array;this._options=t;if(!this._isMainTrack){this._scene.soundTracks.push(this);this.id=this._scene.soundTracks.length-1}}t.prototype._initializeSoundTrackAudioGraph=function(){if(e.Engine.audioEngine.canUseWebAudio&&e.Engine.audioEngine.audioContext){this._outputAudioNode=e.Engine.audioEngine.audioContext.createGain();this._outputAudioNode.connect(e.Engine.audioEngine.masterGain);if(this._options){if(this._options.volume){this._outputAudioNode.gain.value=this._options.volume}if(this._options.mainTrack){this._isMainTrack=this._options.mainTrack}}this._isInitialized=true}};t.prototype.dispose=function(){if(e.Engine.audioEngine&&e.Engine.audioEngine.canUseWebAudio){if(this._connectedAnalyser){this._connectedAnalyser.stopDebugCanvas()}while(this.soundCollection.length){this.soundCollection[0].dispose()}if(this._outputAudioNode){this._outputAudioNode.disconnect()}this._outputAudioNode=null}};t.prototype.AddSound=function(t){if(!this._isInitialized){this._initializeSoundTrackAudioGraph()}if(e.Engine.audioEngine.canUseWebAudio&&this._outputAudioNode){t.connectToSoundTrackAudioNode(this._outputAudioNode)}if(t.soundTrackId){if(t.soundTrackId===-1){this._scene.mainSoundTrack.RemoveSound(t)}else{this._scene.soundTracks[t.soundTrackId].RemoveSound(t)}}this.soundCollection.push(t);t.soundTrackId=this.id};t.prototype.RemoveSound=function(e){var t=this.soundCollection.indexOf(e);if(t!==-1){this.soundCollection.splice(t,1)}};t.prototype.setVolume=function(t){if(e.Engine.audioEngine.canUseWebAudio&&this._outputAudioNode){this._outputAudioNode.gain.value=t}};t.prototype.switchPanningModelToHRTF=function(){if(e.Engine.audioEngine.canUseWebAudio){for(var t=0;t<this.soundCollection.length;t++){this.soundCollection[t].switchPanningModelToHRTF()}}};t.prototype.switchPanningModelToEqualPower=function(){if(e.Engine.audioEngine.canUseWebAudio){for(var t=0;t<this.soundCollection.length;t++){this.soundCollection[t].switchPanningModelToEqualPower()}}};t.prototype.connectToAnalyser=function(t){if(this._connectedAnalyser){this._connectedAnalyser.stopDebugCanvas()}this._connectedAnalyser=t;if(e.Engine.audioEngine.canUseWebAudio&&this._outputAudioNode){this._outputAudioNode.disconnect();this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,e.Engine.audioEngine.masterGain)}};return t}();e.SoundTrack=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t){this.SMOOTHING=.75;this.FFT_SIZE=512;this.BARGRAPHAMPLITUDE=256;this.DEBUGCANVASPOS={x:20,y:20};this.DEBUGCANVASSIZE={width:320,height:200};this._scene=t;this._audioEngine=e.Engine.audioEngine;if(this._audioEngine.canUseWebAudio&&this._audioEngine.audioContext){this._webAudioAnalyser=this._audioEngine.audioContext.createAnalyser();this._webAudioAnalyser.minDecibels=-140;this._webAudioAnalyser.maxDecibels=0;this._byteFreqs=new Uint8Array(this._webAudioAnalyser.frequencyBinCount);this._byteTime=new Uint8Array(this._webAudioAnalyser.frequencyBinCount);this._floatFreqs=new Float32Array(this._webAudioAnalyser.frequencyBinCount)}}t.prototype.getFrequencyBinCount=function(){if(this._audioEngine.canUseWebAudio){return this._webAudioAnalyser.frequencyBinCount}else{return 0}};t.prototype.getByteFrequencyData=function(){if(this._audioEngine.canUseWebAudio){this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING;this._webAudioAnalyser.fftSize=this.FFT_SIZE;this._webAudioAnalyser.getByteFrequencyData(this._byteFreqs)}return this._byteFreqs};t.prototype.getByteTimeDomainData=function(){if(this._audioEngine.canUseWebAudio){this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING;this._webAudioAnalyser.fftSize=this.FFT_SIZE;this._webAudioAnalyser.getByteTimeDomainData(this._byteTime)}return this._byteTime};t.prototype.getFloatFrequencyData=function(){if(this._audioEngine.canUseWebAudio){this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING;this._webAudioAnalyser.fftSize=this.FFT_SIZE;this._webAudioAnalyser.getFloatFrequencyData(this._floatFreqs)}return this._floatFreqs};t.prototype.drawDebugCanvas=function(){var e=this;if(this._audioEngine.canUseWebAudio){if(!this._debugCanvas){this._debugCanvas=document.createElement("canvas");this._debugCanvas.width=this.DEBUGCANVASSIZE.width;this._debugCanvas.height=this.DEBUGCANVASSIZE.height;this._debugCanvas.style.position="absolute";this._debugCanvas.style.top=this.DEBUGCANVASPOS.y+"px";this._debugCanvas.style.left=this.DEBUGCANVASPOS.x+"px";this._debugCanvasContext=this._debugCanvas.getContext("2d");document.body.appendChild(this._debugCanvas);this._registerFunc=function(){e.drawDebugCanvas()};this._scene.registerBeforeRender(this._registerFunc)}if(this._registerFunc&&this._debugCanvasContext){var t=this.getByteFrequencyData();this._debugCanvasContext.fillStyle="rgb(0, 0, 0)";this._debugCanvasContext.fillRect(0,0,this.DEBUGCANVASSIZE.width,this.DEBUGCANVASSIZE.height);for(var i=0;i<this.getFrequencyBinCount();i++){var r=t[i];var n=r/this.BARGRAPHAMPLITUDE;var o=this.DEBUGCANVASSIZE.height*n;var s=this.DEBUGCANVASSIZE.height-o-1;var a=this.DEBUGCANVASSIZE.width/this.getFrequencyBinCount();var u=i/this.getFrequencyBinCount()*360;this._debugCanvasContext.fillStyle="hsl("+u+", 100%, 50%)";this._debugCanvasContext.fillRect(i*a,s,a,o)}}}};t.prototype.stopDebugCanvas=function(){if(this._debugCanvas){if(this._registerFunc){this._scene.unregisterBeforeRender(this._registerFunc);this._registerFunc=null}document.body.removeChild(this._debugCanvas);this._debugCanvas=null;this._debugCanvasContext=null}};t.prototype.connectAudioNodes=function(e,t){if(this._audioEngine.canUseWebAudio){e.connect(this._webAudioAnalyser);this._webAudioAnalyser.connect(t)}};t.prototype.dispose=function(){if(this._audioEngine.canUseWebAudio){this._webAudioAnalyser.disconnect()}};return t}();e.Analyser=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c,h){if(n===void 0){n=null}if(o===void 0){o=false}if(s===void 0){s=null}if(a===void 0){a=null}if(u===void 0){u=null}if(l===void 0){l=e.Engine.TEXTUREFORMAT_RGBA}if(c===void 0){c=false}if(h===void 0){h=null}var f=t.call(this,r)||this;f.coordinatesMode=e.Texture.CUBIC_MODE;f.boundingBoxPosition=e.Vector3.Zero();f.name=i;f.url=i;f._noMipmap=o;f.hasAlpha=false;f._format=l;f._prefiltered=c;f.isCube=true;f._textureMatrix=e.Matrix.Identity();if(c){f.gammaSpace=false}if(!i&&!s){return f}f._texture=f._getFromCache(i,o);var d=i.lastIndexOf(".");var p=h?h:d>-1?i.substring(d).toLowerCase():"";var _=p===".dds";if(!s){if(!_&&!n){n=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]}s=[];if(n){for(var m=0;m<n.length;m++){s.push(i+n[m])}}}f._files=s;if(!f._texture){if(!r.useDelayedTextureLoading){if(c){f._texture=r.getEngine().createPrefilteredCubeTexture(i,r,f.lodGenerationScale,f.lodGenerationOffset,a,u,l,h)}else{f._texture=r.getEngine().createCubeTexture(i,r,s,o,a,u,f._format,h)}}else{
f.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED}}else if(a){if(f._texture.isReady){e.Tools.SetImmediate(function(){return a()})}else{f._texture.onLoadedObservable.add(a)}}return f}Object.defineProperty(i.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t)){return}this._boundingBoxSize=t;var i=this.getScene();if(i){i.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag)}},enumerable:true,configurable:true});i.CreateFromImages=function(e,t,r){var n="";e.forEach(function(e){return n+=e});return new i(n,t,null,r,e)};i.CreateFromPrefilteredData=function(e,t,r){if(r===void 0){r=null}return new i(e,t,null,false,null,null,null,undefined,true,r)};i.prototype.delayLoad=function(){if(this.delayLoadState!==e.Engine.DELAYLOADSTATE_NOTLOADED){return}var t=this.getScene();if(!t){return}this.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED;this._texture=this._getFromCache(this.url,this._noMipmap);if(!this._texture){if(this._prefiltered){this._texture=t.getEngine().createPrefilteredCubeTexture(this.url,t,this.lodGenerationScale,this.lodGenerationOffset,undefined,undefined,this._format)}else{this._texture=t.getEngine().createCubeTexture(this.url,t,this._files,this._noMipmap,undefined,undefined,this._format)}}};i.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix};i.prototype.setReflectionTextureMatrix=function(e){this._textureMatrix=e};i.Parse=function(t,r,n){var o=e.SerializationHelper.Parse(function(){return new i(n+t.name,r,t.extensions)},t,r);if(t.boundingBoxPosition){o.boundingBoxPosition=e.Vector3.FromArray(t.boundingBoxPosition)}if(t.boundingBoxSize){o.boundingBoxSize=e.Vector3.FromArray(t.boundingBoxSize)}if(t.animations){for(var s=0;s<t.animations.length;s++){var a=t.animations[s];o.animations.push(e.Animation.Parse(a))}}return o};i.prototype.clone=function(){var t=this;return e.SerializationHelper.Clone(function(){var e=t.getScene();if(!e){return t}return new i(t.url,e,t._extensions,t._noMipmap,t._files)},this)};return i}(e.BaseTexture);e.CubeTexture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c,h,f){if(s===void 0){s=true}if(a===void 0){a=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(u===void 0){u=false}if(l===void 0){l=e.Texture.TRILINEAR_SAMPLINGMODE}if(c===void 0){c=true}if(h===void 0){h=false}if(f===void 0){f=false}var d=t.call(this,null,n,!o)||this;d.isCube=u;d.renderList=new Array;d.renderParticles=true;d.renderSprites=false;d.coordinatesMode=e.Texture.PROJECTION_MODE;d.ignoreCameraViewport=false;d.onBeforeBindObservable=new e.Observable;d.onAfterUnbindObservable=new e.Observable;d.onBeforeRenderObservable=new e.Observable;d.onAfterRenderObservable=new e.Observable;d.onClearObservable=new e.Observable;d._currentRefreshId=-1;d._refreshRate=1;d._samples=1;d.boundingBoxPosition=e.Vector3.Zero();n=d.getScene();if(!n){return d}d._engine=n.getEngine();d.name=i;d.isRenderTarget=true;d._initialSizeParameter=r;d._processSizeParameter(r);d._resizeObserver=d.getScene().getEngine().onResizeObservable.add(function(){});d._generateMipMaps=o?true:false;d._doNotChangeAspectRatio=s;d._renderingManager=new e.RenderingManager(n);if(f){return d}d._renderTargetOptions={generateMipMaps:o,type:a,samplingMode:l,generateDepthBuffer:c,generateStencilBuffer:h};if(l===e.Texture.NEAREST_SAMPLINGMODE){d.wrapU=e.Texture.CLAMP_ADDRESSMODE;d.wrapV=e.Texture.CLAMP_ADDRESSMODE}if(u){d._texture=n.getEngine().createRenderTargetCubeTexture(d.getRenderSize(),d._renderTargetOptions);d.coordinatesMode=e.Texture.INVCUBIC_MODE;d._textureMatrix=e.Matrix.Identity()}else{d._texture=n.getEngine().createRenderTargetTexture(d._size,d._renderTargetOptions)}return d}Object.defineProperty(i,"REFRESHRATE_RENDER_ONCE",{get:function(){return i._REFRESHRATE_RENDER_ONCE},enumerable:true,configurable:true});Object.defineProperty(i,"REFRESHRATE_RENDER_ONEVERYFRAME",{get:function(){return i._REFRESHRATE_RENDER_ONEVERYFRAME},enumerable:true,configurable:true});Object.defineProperty(i,"REFRESHRATE_RENDER_ONEVERYTWOFRAMES",{get:function(){return i._REFRESHRATE_RENDER_ONEVERYTWOFRAMES},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"onAfterUnbind",{set:function(e){if(this._onAfterUnbindObserver){this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver)}this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"onBeforeRender",{set:function(e){if(this._onBeforeRenderObserver){this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver)}this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"onAfterRender",{set:function(e){if(this._onAfterRenderObserver){this.onAfterRenderObservable.remove(this._onAfterRenderObserver)}this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"onClear",{set:function(e){if(this._onClearObserver){this.onClearObservable.remove(this._onClearObserver)}this._onClearObserver=this.onClearObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"renderTargetOptions",{get:function(){return this._renderTargetOptions},enumerable:true,configurable:true});i.prototype._onRatioRescale=function(){if(this._sizeRatio){this.resize(this._initialSizeParameter)}};Object.defineProperty(i.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t)){return}this._boundingBoxSize=t;var i=this.getScene();if(i){i.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag)}},enumerable:true,configurable:true});i.prototype.createDepthStencilTexture=function(e,t,i){if(e===void 0){e=0}if(t===void 0){t=true}if(i===void 0){i=false}if(!this.getScene()){return}var r=this.getScene().getEngine();this.depthStencilTexture=r.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this.isCube});r.setFrameBufferDepthStencilTexture(this)};i.prototype._processSizeParameter=function(e){if(e.ratio){this._sizeRatio=e.ratio;this._size={width:this._bestReflectionRenderTargetDimension(this._engine.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(this._engine.getRenderHeight(),this._sizeRatio)}}else{this._size=e}};Object.defineProperty(i.prototype,"samples",{get:function(){return this._samples},set:function(e){if(this._samples===e){return}var t=this.getScene();if(!t){return}this._samples=t.getEngine().updateRenderTargetTextureSampleCount(this._texture,e)},enumerable:true,configurable:true});i.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1};Object.defineProperty(i.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(e){this._refreshRate=e;this.resetRefreshCounter()},enumerable:true,configurable:true});i.prototype.addPostProcess=function(t){if(!this._postProcessManager){var i=this.getScene();if(!i){return}this._postProcessManager=new e.PostProcessManager(i);this._postProcesses=new Array}this._postProcesses.push(t);this._postProcesses[0].autoClear=false};i.prototype.clearPostProcesses=function(e){if(!this._postProcesses){return}if(e){for(var t=0,i=this._postProcesses;t<i.length;t++){var r=i[t];r.dispose()}}this._postProcesses=[]};i.prototype.removePostProcess=function(e){if(!this._postProcesses){return}var t=this._postProcesses.indexOf(e);if(t===-1){return}this._postProcesses.splice(t,1);if(this._postProcesses.length>0){this._postProcesses[0].autoClear=false}};i.prototype._shouldRender=function(){if(this._currentRefreshId===-1){this._currentRefreshId=1;return true}if(this.refreshRate===this._currentRefreshId){this._currentRefreshId=1;return true}this._currentRefreshId++;return false};i.prototype.getRenderSize=function(){if(this._size.width){return this._size.width}return this._size};i.prototype.getRenderWidth=function(){if(this._size.width){return this._size.width}return this._size};i.prototype.getRenderHeight=function(){if(this._size.width){return this._size.height}return this._size};Object.defineProperty(i.prototype,"canRescale",{get:function(){return true},enumerable:true,configurable:true});i.prototype.scale=function(e){var t=this.getRenderSize()*e;this.resize(t)};i.prototype.getReflectionTextureMatrix=function(){if(this.isCube){return this._textureMatrix}return t.prototype.getReflectionTextureMatrix.call(this)};i.prototype.resize=function(e){this.releaseInternalTexture();var t=this.getScene();if(!t){return}this._processSizeParameter(e);if(this.isCube){this._texture=t.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions)}else{this._texture=t.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions)}};i.prototype.render=function(e,t){if(e===void 0){e=false}if(t===void 0){t=false}var i=this.getScene();if(!i){return}var r=i.getEngine();if(this.useCameraPostProcesses!==undefined){e=this.useCameraPostProcesses}if(this._waitingRenderList){this.renderList=[];for(var n=0;n<this._waitingRenderList.length;n++){var o=this._waitingRenderList[n];var s=i.getMeshByID(o);if(s){this.renderList.push(s)}}delete this._waitingRenderList}if(this.renderListPredicate){if(this.renderList){this.renderList.splice(0)}else{this.renderList=[]}var i=this.getScene();if(!i){return}var a=i.meshes;for(var n=0;n<a.length;n++){var u=a[n];if(this.renderListPredicate(u)){this.renderList.push(u)}}}this.onBeforeBindObservable.notifyObservers(this);var l;if(this.activeCamera){l=this.activeCamera;r.setViewport(this.activeCamera.viewport,this.getRenderWidth(),this.getRenderHeight());if(this.activeCamera!==i.activeCamera){i.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(true))}}else{l=i.activeCamera;if(l){r.setViewport(l.viewport,this.getRenderWidth(),this.getRenderHeight())}}this._renderingManager.reset();var c=this.renderList?this.renderList:i.getActiveMeshes().data;var h=this.renderList?this.renderList.length:i.getActiveMeshes().length;var f=i.getRenderId();for(var d=0;d<h;d++){var u=c[d];if(u){if(!u.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}u._preActivateForIntermediateRendering(f);var p=void 0;if(!this.renderList&&l){p=(u.layerMask&l.layerMask)===0}else{p=false}if(u.isEnabled()&&u.isVisible&&u.subMeshes&&!p){u._activate(f);for(var _=0;_<u.subMeshes.length;_++){var m=u.subMeshes[_];i._activeIndices.addCount(m.indexCount,false);this._renderingManager.dispatch(m,u)}}}}for(var g=0;g<i.particleSystems.length;g++){var v=i.particleSystems[g];var y=v.emitter;if(!v.isStarted()||!y||!y.position||!y.isEnabled()){continue}if(c.indexOf(y)>=0){this._renderingManager.dispatchParticles(v)}}if(this.isCube){for(var b=0;b<6;b++){this.renderToTarget(b,c,h,e,t);i.incrementRenderId();i.resetCachedMaterial()}}else{this.renderToTarget(0,c,h,e,t)}this.onAfterUnbindObservable.notifyObservers(this);if(i.activeCamera){if(this.activeCamera&&this.activeCamera!==i.activeCamera){i.setTransformMatrix(i.activeCamera.getViewMatrix(),i.activeCamera.getProjectionMatrix(true))}r.setViewport(i.activeCamera.viewport)}i.resetCachedMaterial()};i.prototype._bestReflectionRenderTargetDimension=function(t,i){var r=128;var n=t*i;var o=e.Tools.NearestPOT(n+r*r/(r+n));return Math.min(e.Tools.FloorPOT(t),o)};i.prototype.unbindFrameBuffer=function(e,t){var i=this;if(!this._texture){return}e.unBindFramebuffer(this._texture,this.isCube,function(){i.onAfterRenderObservable.notifyObservers(t)})};i.prototype.renderToTarget=function(t,i,r,n,o){var s=this.getScene();if(!s){return}var a=s.getEngine();if(!this._texture){return}if(this._postProcessManager){this._postProcessManager._prepareFrame(this._texture,this._postProcesses)}else if(!n||!s.postProcessManager._prepareFrame(this._texture)){if(this._texture){a.bindFramebuffer(this._texture,this.isCube?t:undefined,undefined,undefined,this.ignoreCameraViewport,this.depthStencilTexture?this.depthStencilTexture:undefined)}}this.onBeforeRenderObservable.notifyObservers(t);if(this.onClearObservable.hasObservers()){this.onClearObservable.notifyObservers(a)}else{a.clear(this.clearColor||s.clearColor,true,true,true)}if(!this._doNotChangeAspectRatio){s.updateTransformMatrix(true)}this._renderingManager.render(this.customRenderFunction,i,this.renderParticles,this.renderSprites);if(this._postProcessManager){this._postProcessManager._finalizeFrame(false,this._texture,t,this._postProcesses,this.ignoreCameraViewport)}else if(n){s.postProcessManager._finalizeFrame(false,this._texture,t)}if(!this._doNotChangeAspectRatio){s.updateTransformMatrix(true)}if(o){e.Tools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),a)}if(!this.isCube||t===5){if(this.isCube){if(t===5){a.generateMipMapsForCubemap(this._texture)}}this.unbindFrameBuffer(a,t)}else{this.onAfterRenderObservable.notifyObservers(t)}};i.prototype.setRenderingOrder=function(e,t,i,r){if(t===void 0){t=null}if(i===void 0){i=null}if(r===void 0){r=null}this._renderingManager.setRenderingOrder(e,t,i,r)};i.prototype.setRenderingAutoClearDepthStencil=function(e,t){this._renderingManager.setRenderingAutoClearDepthStencil(e,t)};i.prototype.clone=function(){var e=this.getSize();var t=new i(this.name,e.width,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer);t.hasAlpha=this.hasAlpha;t.level=this.level;t.coordinatesMode=this.coordinatesMode;if(this.renderList){t.renderList=this.renderList.slice(0)}return t};i.prototype.serialize=function(){if(!this.name){return null}var e=t.prototype.serialize.call(this);e.renderTargetSize=this.getRenderSize();e.renderList=[];if(this.renderList){for(var i=0;i<this.renderList.length;i++){e.renderList.push(this.renderList[i].id)}}return e};i.prototype.disposeFramebufferObjects=function(){var e=this.getInternalTexture();var t=this.getScene();if(e&&t){t.getEngine()._releaseFramebufferObjects(e)}};i.prototype.dispose=function(){if(this._postProcessManager){this._postProcessManager.dispose();this._postProcessManager=null}this.clearPostProcesses(true);if(this._resizeObserver){this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver);this._resizeObserver=null}this.renderList=null;var e=this.getScene();if(!e){return}var i=e.customRenderTargets.indexOf(this);if(i>=0){e.customRenderTargets.splice(i,1)}for(var r=0,n=e.cameras;r<n.length;r++){var o=n[r];i=o.customRenderTargets.indexOf(this);if(i>=0){o.customRenderTargets.splice(i,1)}}t.prototype.dispose.call(this)};i.prototype._rebuild=function(){if(this.refreshRate===i.REFRESHRATE_RENDER_ONCE){this.refreshRate=i.REFRESHRATE_RENDER_ONCE}if(this._postProcessManager){this._postProcessManager._rebuild()}};i.prototype.freeRenderingGroups=function(){if(this._renderingManager){this._renderingManager.freeRenderingGroups()}};i._REFRESHRATE_RENDER_ONCE=0;i._REFRESHRATE_RENDER_ONEVERYFRAME=1;i._REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2;return i}(e.Texture);e.RenderTargetTexture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s){var a=this;var u=s&&s.generateMipMaps?s.generateMipMaps:false;var l=s&&s.generateDepthTexture?s.generateDepthTexture:false;var c=!s||s.doNotChangeAspectRatio===undefined?true:s.doNotChangeAspectRatio;a=t.call(this,i,r,o,u,c)||this;a._engine=o.getEngine();if(!a.isSupported){a.dispose();return}var h=[];var f=[];for(var d=0;d<n;d++){if(s&&s.types&&s.types[d]!==undefined){h.push(s.types[d])}else{h.push(s&&s.defaultType?s.defaultType:e.Engine.TEXTURETYPE_UNSIGNED_INT)}if(s&&s.samplingModes&&s.samplingModes[d]!==undefined){f.push(s.samplingModes[d])}else{f.push(e.Texture.BILINEAR_SAMPLINGMODE)}}var p=!s||s.generateDepthBuffer===undefined?true:s.generateDepthBuffer;var _=!s||s.generateStencilBuffer===undefined?false:s.generateStencilBuffer;a._size=r;a._multiRenderTargetOptions={samplingModes:f,generateMipMaps:u,generateDepthBuffer:p,generateStencilBuffer:_,generateDepthTexture:l,types:h,textureCount:n};a._createInternalTextures();a._createTextures();return a}Object.defineProperty(i.prototype,"isSupported",{get:function(){return this._engine.webGLVersion>1||this._engine.getCaps().drawBuffersExtension},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"textures",{get:function(){return this._textures},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"depthTexture",{get:function(){return this._textures[this._textures.length-1]},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"wrapU",{set:function(e){if(this._textures){for(var t=0;t<this._textures.length;t++){this._textures[t].wrapU=e}}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"wrapV",{set:function(e){if(this._textures){for(var t=0;t<this._textures.length;t++){this._textures[t].wrapV=e}}},enumerable:true,configurable:true});i.prototype._rebuild=function(){this.releaseInternalTextures();this._createInternalTextures();for(var e=0;e<this._internalTextures.length;e++){var t=this._textures[e];t._texture=this._internalTextures[e]}this._texture=this._internalTextures[0]};i.prototype._createInternalTextures=function(){this._internalTextures=this._engine.createMultipleRenderTarget(this._size,this._multiRenderTargetOptions)};i.prototype._createTextures=function(){this._textures=[];for(var t=0;t<this._internalTextures.length;t++){var i=new e.Texture(null,this.getScene());i._texture=this._internalTextures[t];this._textures.push(i)}this._texture=this._internalTextures[0]};Object.defineProperty(i.prototype,"samples",{get:function(){return this._samples},set:function(e){if(this._samples===e){return}this._samples=this._engine.updateMultipleRenderTargetTextureSampleCount(this._internalTextures,e)},enumerable:true,configurable:true});i.prototype.resize=function(e){this.releaseInternalTextures();this._internalTextures=this._engine.createMultipleRenderTarget(e,this._multiRenderTargetOptions);this._createInternalTextures()};i.prototype.unbindFrameBuffer=function(e,t){var i=this;e.unBindMultiColorAttachmentFramebuffer(this._internalTextures,this.isCube,function(){i.onAfterRenderObservable.notifyObservers(t)})};i.prototype.dispose=function(){this.releaseInternalTextures();t.prototype.dispose.call(this)};i.prototype.releaseInternalTextures=function(){if(!this._internalTextures){return}for(var e=this._internalTextures.length-1;e>=0;e--){if(this._internalTextures[e]!==undefined){this._internalTextures[e].dispose();this._internalTextures.splice(e,1)}}};return i}(e.RenderTargetTexture);e.MultiRenderTarget=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u){if(s===void 0){s=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(a===void 0){a=e.Texture.BILINEAR_SAMPLINGMODE}if(u===void 0){u=true}var l=t.call(this,i,r,n,o,true,s,false,a,u)||this;l.mirrorPlane=new e.Plane(0,1,0,1);l._transformMatrix=e.Matrix.Zero();l._mirrorMatrix=e.Matrix.Zero();l._adaptiveBlurKernel=0;l._blurKernelX=0;l._blurKernelY=0;l._blurRatio=1;l.ignoreCameraViewport=true;l.onBeforeRenderObservable.add(function(){e.Matrix.ReflectionToRef(l.mirrorPlane,l._mirrorMatrix);l._savedViewMatrix=n.getViewMatrix();l._mirrorMatrix.multiplyToRef(l._savedViewMatrix,l._transformMatrix);n.setTransformMatrix(l._transformMatrix,n.getProjectionMatrix());n.clipPlane=l.mirrorPlane;n.getEngine().cullBackFaces=false;n._mirroredCameraPosition=e.Vector3.TransformCoordinates(n.activeCamera.globalPosition,l._mirrorMatrix)});l.onAfterRenderObservable.add(function(){n.setTransformMatrix(l._savedViewMatrix,n.getProjectionMatrix());n.getEngine().cullBackFaces=true;n._mirroredCameraPosition=null;delete n.clipPlane});return l}Object.defineProperty(i.prototype,"blurRatio",{get:function(){return this._blurRatio},set:function(e){if(this._blurRatio===e){return}this._blurRatio=e;this._preparePostProcesses()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"adaptiveBlurKernel",{set:function(e){this._adaptiveBlurKernel=e;this._autoComputeBlurKernel()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"blurKernel",{set:function(e){this.blurKernelX=e;this.blurKernelY=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"blurKernelX",{get:function(){return this._blurKernelX},set:function(e){if(this._blurKernelX===e){return}this._blurKernelX=e;this._preparePostProcesses()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"blurKernelY",{get:function(){return this._blurKernelY},set:function(e){if(this._blurKernelY===e){return}this._blurKernelY=e;this._preparePostProcesses()},enumerable:true,configurable:true});i.prototype._autoComputeBlurKernel=function(){var e=this.getScene().getEngine();var t=this.getRenderWidth()/e.getRenderWidth();var i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t;this.blurKernelY=this._adaptiveBlurKernel*i};i.prototype._onRatioRescale=function(){if(this._sizeRatio){this.resize(this._initialSizeParameter);if(!this._adaptiveBlurKernel){this._preparePostProcesses()}}if(this._adaptiveBlurKernel){this._autoComputeBlurKernel()}};i.prototype._preparePostProcesses=function(){this.clearPostProcesses(true);if(this._blurKernelX&&this._blurKernelY){var t=this.getScene().getEngine();var i=t.getCaps().textureFloatRender?e.Engine.TEXTURETYPE_FLOAT:e.Engine.TEXTURETYPE_HALF_FLOAT;this._blurX=new e.BlurPostProcess("horizontal blur",new e.Vector2(1,0),this._blurKernelX,this._blurRatio,null,e.Texture.BILINEAR_SAMPLINGMODE,t,false,i);this._blurX.autoClear=false;if(this._blurRatio===1&&this.samples<2&&this._texture){this._blurX.inputTexture=this._texture}else{this._blurX.alwaysForcePOT=true}this._blurY=new e.BlurPostProcess("vertical blur",new e.Vector2(0,1),this._blurKernelY,this._blurRatio,null,e.Texture.BILINEAR_SAMPLINGMODE,t,false,i);this._blurY.autoClear=false;this._blurY.alwaysForcePOT=this._blurRatio!==1;this.addPostProcess(this._blurX);this.addPostProcess(this._blurY)}else{if(this._blurY){this.removePostProcess(this._blurY);this._blurY.dispose();this._blurY=null}if(this._blurX){this.removePostProcess(this._blurX);this._blurX.dispose();this._blurX=null}}};i.prototype.clone=function(){var e=this.getScene();if(!e){return this}var t=this.getSize();var r=new i(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);r.hasAlpha=this.hasAlpha;r.level=this.level;r.mirrorPlane=this.mirrorPlane.clone();if(this.renderList){r.renderList=this.renderList.slice(0)}return r};i.prototype.serialize=function(){if(!this.name){return null}var e=t.prototype.serialize.call(this);e.mirrorPlane=this.mirrorPlane.asArray();return e};return i}(e.RenderTargetTexture);e.MirrorTexture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o){var s=t.call(this,i,r,n,o,true)||this;s.refractionPlane=new e.Plane(0,1,0,1);s.depth=2;s.onBeforeRenderObservable.add(function(){n.clipPlane=s.refractionPlane});s.onAfterRenderObservable.add(function(){delete n.clipPlane});return s}i.prototype.clone=function(){var e=this.getScene();if(!e){return this}var t=this.getSize();var r=new i(this.name,t.width,e,this._generateMipMaps);r.hasAlpha=this.hasAlpha;r.level=this.level;r.refractionPlane=this.refractionPlane.clone();if(this.renderList){r.renderList=this.renderList.slice(0)}r.depth=this.depth;return r};i.prototype.serialize=function(){if(!this.name){return null}var e=t.prototype.serialize.call(this);e.mirrorPlane=this.refractionPlane.asArray();e.depth=this.depth;return e};return i}(e.RenderTargetTexture);e.RefractionTexture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a){if(n===void 0){n=null}if(s===void 0){s=e.Texture.TRILINEAR_SAMPLINGMODE}if(a===void 0){a=e.Engine.TEXTUREFORMAT_RGBA}var u=t.call(this,null,n,!o,undefined,s,undefined,undefined,undefined,undefined,a)||this;u.name=i;u._engine=u.getScene().getEngine();u.wrapU=e.Texture.CLAMP_ADDRESSMODE;u.wrapV=e.Texture.CLAMP_ADDRESSMODE;u._generateMipMaps=o;if(r.getContext){u._canvas=r;u._texture=u._engine.createDynamicTexture(r.width,r.height,o,s)}else{u._canvas=document.createElement("canvas");if(r.width){u._texture=u._engine.createDynamicTexture(r.width,r.height,o,s)}else{u._texture=u._engine.createDynamicTexture(r,r,o,s)}}var l=u.getSize();u._canvas.width=l.width;u._canvas.height=l.height;u._context=u._canvas.getContext("2d");return u}Object.defineProperty(i.prototype,"canRescale",{get:function(){return true},enumerable:true,configurable:true});i.prototype._recreate=function(e){this._canvas.width=e.width;this._canvas.height=e.height;this.releaseInternalTexture();this._texture=this._engine.createDynamicTexture(e.width,e.height,this._generateMipMaps,this._samplingMode)};i.prototype.scale=function(e){var t=this.getSize();t.width*=e;t.height*=e;this._recreate(t)};i.prototype.scaleTo=function(e,t){var i=this.getSize();i.width=e;i.height=t;this._recreate(i)};i.prototype.getContext=function(){return this._context};i.prototype.clear=function(){var e=this.getSize();this._context.fillRect(0,0,e.width,e.height)};i.prototype.update=function(e){this._engine.updateDynamicTexture(this._texture,this._canvas,e===undefined?true:e,undefined,this._format||undefined)};i.prototype.drawText=function(e,t,i,r,n,o,s,a){if(a===void 0){a=true}var u=this.getSize();if(o){this._context.fillStyle=o;this._context.fillRect(0,0,u.width,u.height)}this._context.font=r;if(t===null||t===undefined){var l=this._context.measureText(e);t=(u.width-l.width)/2}if(i===null||i===undefined){var c=parseInt(r.replace(/\D/g,""));i=u.height/2+c/3.65}this._context.fillStyle=n;this._context.fillText(e,t,i);if(a){this.update(s)}};i.prototype.clone=function(){var e=this.getScene();if(!e){return this}var t=this.getSize();var r=new i(this.name,t,e,this._generateMipMaps);r.hasAlpha=this.hasAlpha;r.level=this.level;r.wrapU=this.wrapU;r.wrapV=this.wrapV;return r};i.prototype._rebuild=function(){this.update()};return i}(e.Texture);e.DynamicTexture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u){if(o===void 0){o=false}if(s===void 0){s=false}if(a===void 0){a=e.Texture.TRILINEAR_SAMPLINGMODE}if(u===void 0){u={autoPlay:true,loop:true,autoUpdateTexture:true}}var l=t.call(this,null,n,!o,s)||this;l._createInternalTexture=function(){if(l._texture!=null){return}if(!l._engine.needPOTTextures||e.Tools.IsExponentOfTwo(l.video.videoWidth)&&e.Tools.IsExponentOfTwo(l.video.videoHeight)){l.wrapU=e.Texture.WRAP_ADDRESSMODE;l.wrapV=e.Texture.WRAP_ADDRESSMODE}else{l.wrapU=e.Texture.CLAMP_ADDRESSMODE;l.wrapV=e.Texture.CLAMP_ADDRESSMODE;l._generateMipMaps=false}l._texture=l._engine.createDynamicTexture(l.video.videoWidth,l.video.videoHeight,l._generateMipMaps,l._samplingMode);l._texture.isReady=true;l._updateInternalTexture();if(l._onLoadObservable&&l._onLoadObservable.hasObservers()){l.onLoadObservable.notifyObservers(l)}};l.reset=function(){if(l._texture==null){return}l._texture.dispose();l._texture=null};l._updateInternalTexture=function(e){if(l._texture==null||!l._texture.isReady){return}if(l.video.readyState<l.video.HAVE_CURRENT_DATA){return}l._engine.updateVideoTexture(l._texture,l.video,l._invertY)};l._engine=l.getScene().getEngine();l._generateMipMaps=o;l._samplingMode=a;l.autoUpdateTexture=u.autoUpdateTexture;l.name=i||l._getName(r);l.video=l._getVideo(r);if(u.autoPlay!==undefined){l.video.autoplay=u.autoPlay}if(u.loop!==undefined){l.video.loop=u.loop}l.video.addEventListener("canplay",l._createInternalTexture);l.video.addEventListener("paused",l._updateInternalTexture);l.video.addEventListener("seeked",l._updateInternalTexture);l.video.addEventListener("emptied",l.reset);if(l.video.readyState>=l.video.HAVE_CURRENT_DATA){l._createInternalTexture()}return l}i.prototype._getName=function(e){if(e instanceof HTMLVideoElement){return e.currentSrc}if(typeof e==="object"){return e.toString()}return e};i.prototype._getVideo=function(t){if(t instanceof HTMLVideoElement){e.Tools.SetCorsBehavior(t.currentSrc,t);return t}var i=document.createElement("video");if(typeof t==="string"){e.Tools.SetCorsBehavior(t,i);i.src=t}else{e.Tools.SetCorsBehavior(t[0],i);t.forEach(function(e){var t=document.createElement("source");t.src=e;i.appendChild(t)})}return i};i.prototype._rebuild=function(){this.update()};i.prototype.update=function(){if(!this.autoUpdateTexture){return}this.updateTexture(true)};i.prototype.updateTexture=function(e){if(!e){return}if(this.video.paused){return}this._updateInternalTexture()};i.prototype.updateURL=function(e){this.video.src=e};i.prototype.dispose=function(){t.prototype.dispose.call(this);this.video.removeEventListener("canplay",this._createInternalTexture);this.video.removeEventListener("paused",this._updateInternalTexture);this.video.removeEventListener("seeked",this._updateInternalTexture);this.video.removeEventListener("emptied",this.reset);this.video.pause()};i.CreateFromWebCam=function(t,r,n){var o=document.createElement("video");var s;if(n&&n.deviceId){s={exact:n.deviceId}}window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL;if(navigator.mediaDevices){navigator.mediaDevices.getUserMedia({video:n}).then(function(e){if(o.mozSrcObject!==undefined){o.mozSrcObject=e}else{o.srcObject=e}var n=function(){if(r){r(new i("video",o,t,true,true))}o.removeEventListener("playing",n)};o.addEventListener("playing",n);o.play()}).catch(function(t){e.Tools.Error(t.name)})}else{navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(navigator.getUserMedia){navigator.getUserMedia({video:{deviceId:s,width:{min:n&&n.minWidth||256,max:n&&n.maxWidth||640},height:{min:n&&n.minHeight||256,max:n&&n.maxHeight||480}}},function(e){if(o.mozSrcObject!==undefined){o.mozSrcObject=e}else{o.src=window.URL&&window.URL.createObjectURL(e)||e}o.play();if(r){r(new i("video",o,t,true,true))}},function(t){e.Tools.Error(t.name)})}}};return i}(e.Texture);e.VideoTexture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c){if(a===void 0){a=true}if(u===void 0){u=false}if(l===void 0){l=e.Texture.TRILINEAR_SAMPLINGMODE}if(c===void 0){c=e.Engine.TEXTURETYPE_UNSIGNED_INT}var h=t.call(this,null,s,!a,u)||this;h.format=o;h._engine=s.getEngine();h._texture=s.getEngine().createRawTexture(i,r,n,o,a,u,l,null,c);h.wrapU=e.Texture.CLAMP_ADDRESSMODE;h.wrapV=e.Texture.CLAMP_ADDRESSMODE;return h}i.prototype.update=function(e){this._engine.updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,undefined,this._texture.type)};i.CreateLuminanceTexture=function(t,r,n,o,s,a,u){if(s===void 0){s=true}if(a===void 0){a=false}if(u===void 0){u=e.Texture.TRILINEAR_SAMPLINGMODE}return new i(t,r,n,e.Engine.TEXTUREFORMAT_LUMINANCE,o,s,a,u)};i.CreateLuminanceAlphaTexture=function(t,r,n,o,s,a,u){if(s===void 0){s=true}if(a===void 0){a=false}if(u===void 0){u=e.Texture.TRILINEAR_SAMPLINGMODE}return new i(t,r,n,e.Engine.TEXTUREFORMAT_LUMINANCE_ALPHA,o,s,a,u)};i.CreateAlphaTexture=function(t,r,n,o,s,a,u){if(s===void 0){s=true}if(a===void 0){a=false}if(u===void 0){u=e.Texture.TRILINEAR_SAMPLINGMODE}return new i(t,r,n,e.Engine.TEXTUREFORMAT_ALPHA,o,s,a,u)};i.CreateRGBTexture=function(t,r,n,o,s,a,u,l){if(s===void 0){s=true}if(a===void 0){a=false}if(u===void 0){u=e.Texture.TRILINEAR_SAMPLINGMODE}if(l===void 0){l=e.Engine.TEXTURETYPE_UNSIGNED_INT}return new i(t,r,n,e.Engine.TEXTUREFORMAT_RGB,o,s,a,u,l)};i.CreateRGBATexture=function(t,r,n,o,s,a,u,l){if(s===void 0){s=true}if(a===void 0){a=false}if(u===void 0){
u=e.Texture.TRILINEAR_SAMPLINGMODE}if(l===void 0){l=e.Engine.TEXTURETYPE_UNSIGNED_INT}return new i(t,r,n,e.Engine.TEXTUREFORMAT_RGBA,o,s,a,u,l)};return i}(e.Texture);e.RawTexture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r,n,o,s,a,u,l,c,h,f,d,p){if(a===void 0){a=e.Texture.NEAREST_SAMPLINGMODE}if(c===void 0){c=null}if(h===void 0){h=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(f===void 0){f="postprocess"}if(p===void 0){p=false}this.name=t;this.width=-1;this.height=-1;this._outputTexture=null;this.autoClear=true;this.alphaMode=e.Engine.ALPHA_DISABLE;this.animations=new Array;this.enablePixelPerfectMode=false;this.scaleMode=e.Engine.SCALEMODE_FLOOR;this.alwaysForcePOT=false;this.samples=1;this.adaptScaleToCurrentViewport=false;this._reusable=false;this._textures=new e.SmartArray(2);this._currentRenderTextureInd=0;this._scaleRatio=new e.Vector2(1,1);this._texelSize=e.Vector2.Zero();this.onActivateObservable=new e.Observable;this.onSizeChangedObservable=new e.Observable;this.onApplyObservable=new e.Observable;this.onBeforeRenderObservable=new e.Observable;this.onAfterRenderObservable=new e.Observable;if(s!=null){this._camera=s;this._scene=s.getScene();s.attachPostProcess(this);this._engine=this._scene.getEngine();this._scene.postProcesses.push(this)}else if(u){this._engine=u;this._engine.postProcesses.push(this)}this._options=o;this.renderTargetSamplingMode=a?a:e.Texture.NEAREST_SAMPLINGMODE;this._reusable=l||false;this._textureType=h;this._samplers=n||[];this._samplers.push("textureSampler");this._fragmentUrl=i;this._vertexUrl=f;this._parameters=r||[];this._parameters.push("scale");this._indexParameters=d;if(!p){this.updateEffect(c)}}Object.defineProperty(t.prototype,"onActivate",{set:function(e){if(this._onActivateObserver){this.onActivateObservable.remove(this._onActivateObserver)}if(e){this._onActivateObserver=this.onActivateObservable.add(e)}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"onSizeChanged",{set:function(e){if(this._onSizeChangedObserver){this.onSizeChangedObservable.remove(this._onSizeChangedObserver)}this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"onApply",{set:function(e){if(this._onApplyObserver){this.onApplyObservable.remove(this._onApplyObserver)}this._onApplyObserver=this.onApplyObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"onBeforeRender",{set:function(e){if(this._onBeforeRenderObserver){this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver)}this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"onAfterRender",{set:function(e){if(this._onAfterRenderObserver){this.onAfterRenderObservable.remove(this._onAfterRenderObserver)}this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"inputTexture",{get:function(){return this._textures.data[this._currentRenderTextureInd]},set:function(e){this._forcedOutputTexture=e},enumerable:true,configurable:true});t.prototype.getCamera=function(){return this._camera};Object.defineProperty(t.prototype,"texelSize",{get:function(){if(this._shareOutputWithPostProcess){return this._shareOutputWithPostProcess.texelSize}if(this._forcedOutputTexture){this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height)}return this._texelSize},enumerable:true,configurable:true});t.prototype.getEngine=function(){return this._engine};t.prototype.getEffect=function(){return this._effect};t.prototype.shareOutputWith=function(e){this._disposeTextures();this._shareOutputWithPostProcess=e;return this};t.prototype.useOwnOutput=function(){if(this._textures.length==0){this._textures=new e.SmartArray(2)}this._shareOutputWithPostProcess=null};t.prototype.updateEffect=function(e,t,i,r,n,o){if(e===void 0){e=null}if(t===void 0){t=null}if(i===void 0){i=null}this._effect=this._engine.createEffect({vertex:this._vertexUrl,fragment:this._fragmentUrl},["position"],t||this._parameters,i||this._samplers,e!==null?e:"",undefined,n,o,r||this._indexParameters)};t.prototype.isReusable=function(){return this._reusable};t.prototype.markTextureDirty=function(){this.width=-1};t.prototype.activate=function(t,i,r){var n=this;if(i===void 0){i=null}t=t||this._camera;var o=t.getScene();var s=o.getEngine();var a=s.getCaps().maxTextureSize;var u=(i?i.width:this._engine.getRenderWidth(true))*this._options|0;var l=(i?i.height:this._engine.getRenderHeight(true))*this._options|0;var c=t.parent;if(c&&(c.leftCamera==t||c.rightCamera==t)){u/=2}var h=this._options.width||u;var f=this._options.height||l;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){var d=s.currentViewport;if(d){h*=d.width;f*=d.height}}if(this.renderTargetSamplingMode===e.Texture.TRILINEAR_SAMPLINGMODE||this.alwaysForcePOT){if(!this._options.width){h=s.needPOTTextures?e.Tools.GetExponentOfTwo(h,a,this.scaleMode):h}if(!this._options.height){f=s.needPOTTextures?e.Tools.GetExponentOfTwo(f,a,this.scaleMode):f}}if(this.width!==h||this.height!==f){if(this._textures.length>0){for(var p=0;p<this._textures.length;p++){this._engine._releaseTexture(this._textures.data[p])}this._textures.reset()}this.width=h;this.height=f;var _={width:this.width,height:this.height};var m={generateMipMaps:false,generateDepthBuffer:r||t._postProcesses.indexOf(this)===0,generateStencilBuffer:(r||t._postProcesses.indexOf(this)===0)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType};this._textures.push(this._engine.createRenderTargetTexture(_,m));if(this._reusable){this._textures.push(this._engine.createRenderTargetTexture(_,m))}this._texelSize.copyFromFloats(1/this.width,1/this.height);this.onSizeChangedObservable.notifyObservers(this)}this._textures.forEach(function(e){if(e.samples!==n.samples){n._engine.updateRenderTargetTextureSampleCount(e,n.samples)}})}var g;if(this._shareOutputWithPostProcess){g=this._shareOutputWithPostProcess.inputTexture}else if(this._forcedOutputTexture){g=this._forcedOutputTexture;this.width=this._forcedOutputTexture.width;this.height=this._forcedOutputTexture.height}else{g=this.inputTexture}if(this.enablePixelPerfectMode){this._scaleRatio.copyFromFloats(u/h,l/f);this._engine.bindFramebuffer(g,0,u,l,true)}else{this._scaleRatio.copyFromFloats(1,1);this._engine.bindFramebuffer(g,0,undefined,undefined,true)}this.onActivateObservable.notifyObservers(t);if(this.autoClear&&this.alphaMode===e.Engine.ALPHA_DISABLE){this._engine.clear(this.clearColor?this.clearColor:o.clearColor,true,true,true)}if(this._reusable){this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2}return g};Object.defineProperty(t.prototype,"isSupported",{get:function(){return this._effect.isSupported},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"aspectRatio",{get:function(){if(this._shareOutputWithPostProcess){return this._shareOutputWithPostProcess.aspectRatio}if(this._forcedOutputTexture){return this._forcedOutputTexture.width/this._forcedOutputTexture.height}return this.width/this.height},enumerable:true,configurable:true});t.prototype.isReady=function(){return this._effect&&this._effect.isReady()};t.prototype.apply=function(){if(!this._effect||!this._effect.isReady())return null;this._engine.enableEffect(this._effect);this._engine.setState(false);this._engine.setDepthBuffer(false);this._engine.setDepthWrite(false);this._engine.setAlphaMode(this.alphaMode);if(this.alphaConstants){this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a)}var e;if(this._shareOutputWithPostProcess){e=this._shareOutputWithPostProcess.inputTexture}else if(this._forcedOutputTexture){e=this._forcedOutputTexture}else{e=this.inputTexture}this._effect._bindTexture("textureSampler",e);this._effect.setVector2("scale",this._scaleRatio);this.onApplyObservable.notifyObservers(this._effect);return this._effect};t.prototype._disposeTextures=function(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){return}if(this._textures.length>0){for(var e=0;e<this._textures.length;e++){this._engine._releaseTexture(this._textures.data[e])}}this._textures.dispose()};t.prototype.dispose=function(e){e=e||this._camera;this._disposeTextures();if(this._scene){var t=this._scene.postProcesses.indexOf(this);if(t!==-1){this._scene.postProcesses.splice(t,1)}}else{var i=this._engine.postProcesses.indexOf(this);if(i!==-1){this._engine.postProcesses.splice(i,1)}}if(!e){return}e.detachPostProcess(this);var r=e._postProcesses.indexOf(this);if(r===0&&e._postProcesses.length>0){var n=this._camera._getFirstPostProcess();if(n){n.markTextureDirty()}}this.onActivateObservable.clear();this.onAfterRenderObservable.clear();this.onApplyObservable.clear();this.onBeforeRenderObservable.clear();this.onSizeChangedObservable.clear()};return t}();e.PostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l){if(n===void 0){n=null}if(u===void 0){u=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(l===void 0){l=false}return t.call(this,i,"pass",null,null,r,n,o,s,a,undefined,u,undefined,null,l)||this}return i}(e.PostProcess);e.PassPostProcess=t})(r||(r={}));"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++){t=arguments[i];for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n))e[n]=t[n]}return e};var r;(function(e){var t=function(){function t(i,r,n){this._bias=5e-5;this._normalBias=0;this._blurBoxOffset=1;this._blurScale=2;this._blurKernel=1;this._useKernelBlur=false;this._filter=t.FILTER_NONE;this._filteringQuality=t.QUALITY_HIGH;this._contactHardeningLightSizeUVRatio=.1;this._darkness=0;this._transparencyShadow=false;this.frustumEdgeFalloff=0;this.forceBackFacesOnly=false;this._lightDirection=e.Vector3.Zero();this._viewMatrix=e.Matrix.Zero();this._projectionMatrix=e.Matrix.Zero();this._transformMatrix=e.Matrix.Zero();this._cachedPosition=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cachedDirection=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._currentFaceIndex=0;this._currentFaceIndexCache=0;this._defaultTextureMatrix=e.Matrix.Identity();this._mapSize=i;this._light=r;this._scene=r.getScene();r._shadowGenerator=this;var o=this._scene.getEngine().getCaps();if(!n){if(o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering){this._textureType=e.Engine.TEXTURETYPE_HALF_FLOAT}else if(o.textureFloatRender&&o.textureFloatLinearFiltering){this._textureType=e.Engine.TEXTURETYPE_FLOAT}else{this._textureType=e.Engine.TEXTURETYPE_UNSIGNED_INT}}else{if(o.textureFloatRender&&o.textureFloatLinearFiltering){this._textureType=e.Engine.TEXTURETYPE_FLOAT}else if(o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering){this._textureType=e.Engine.TEXTURETYPE_HALF_FLOAT}else{this._textureType=e.Engine.TEXTURETYPE_UNSIGNED_INT}}this._initializeGenerator();this._applyFilterValues()}Object.defineProperty(t.prototype,"bias",{get:function(){return this._bias},set:function(e){this._bias=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"normalBias",{get:function(){return this._normalBias},set:function(e){this._normalBias=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"blurBoxOffset",{get:function(){return this._blurBoxOffset},set:function(e){if(this._blurBoxOffset===e){return}this._blurBoxOffset=e;this._disposeBlurPostProcesses()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"blurScale",{get:function(){return this._blurScale},set:function(e){if(this._blurScale===e){return}this._blurScale=e;this._disposeBlurPostProcesses()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"blurKernel",{get:function(){return this._blurKernel},set:function(e){if(this._blurKernel===e){return}this._blurKernel=e;this._disposeBlurPostProcesses()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"useKernelBlur",{get:function(){return this._useKernelBlur},set:function(e){if(this._useKernelBlur===e){return}this._useKernelBlur=e;this._disposeBlurPostProcesses()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"depthScale",{get:function(){return this._depthScale!==undefined?this._depthScale:this._light.getDepthScale()},set:function(e){this._depthScale=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"filter",{get:function(){return this._filter},set:function(e){if(this._light.needCube()){if(e===t.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=true;return}else if(e===t.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=true;return}else if(e===t.FILTER_PCF||e===t.FILTER_PCSS){this.usePoissonSampling=true;return}}if(e===t.FILTER_PCF||e===t.FILTER_PCSS){if(this._scene.getEngine().webGLVersion===1){this.usePoissonSampling=true;return}}if(this._filter===e){return}this._filter=e;this._disposeBlurPostProcesses();this._applyFilterValues();this._light._markMeshesAsLightDirty()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"usePoissonSampling",{get:function(){return this.filter===t.FILTER_POISSONSAMPLING},set:function(e){if(!e&&this.filter!==t.FILTER_POISSONSAMPLING){return}this.filter=e?t.FILTER_POISSONSAMPLING:t.FILTER_NONE},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"useVarianceShadowMap",{get:function(){e.Tools.Warn("VSM are now replaced by ESM. Please use useExponentialShadowMap instead.");return this.useExponentialShadowMap},set:function(t){e.Tools.Warn("VSM are now replaced by ESM. Please use useExponentialShadowMap instead.");this.useExponentialShadowMap=t},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"useBlurVarianceShadowMap",{get:function(){e.Tools.Warn("VSM are now replaced by ESM. Please use useBlurExponentialShadowMap instead.");return this.useBlurExponentialShadowMap},set:function(t){e.Tools.Warn("VSM are now replaced by ESM. Please use useBlurExponentialShadowMap instead.");this.useBlurExponentialShadowMap=t},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"useExponentialShadowMap",{get:function(){return this.filter===t.FILTER_EXPONENTIALSHADOWMAP},set:function(e){if(!e&&this.filter!==t.FILTER_EXPONENTIALSHADOWMAP){return}this.filter=e?t.FILTER_EXPONENTIALSHADOWMAP:t.FILTER_NONE},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"useBlurExponentialShadowMap",{get:function(){return this.filter===t.FILTER_BLUREXPONENTIALSHADOWMAP},set:function(e){if(!e&&this.filter!==t.FILTER_BLUREXPONENTIALSHADOWMAP){return}this.filter=e?t.FILTER_BLUREXPONENTIALSHADOWMAP:t.FILTER_NONE},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"useCloseExponentialShadowMap",{get:function(){return this.filter===t.FILTER_CLOSEEXPONENTIALSHADOWMAP},set:function(e){if(!e&&this.filter!==t.FILTER_CLOSEEXPONENTIALSHADOWMAP){return}this.filter=e?t.FILTER_CLOSEEXPONENTIALSHADOWMAP:t.FILTER_NONE},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"useBlurCloseExponentialShadowMap",{get:function(){return this.filter===t.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},set:function(e){if(!e&&this.filter!==t.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){return}this.filter=e?t.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP:t.FILTER_NONE},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"usePercentageCloserFiltering",{get:function(){return this.filter===t.FILTER_PCF},set:function(e){if(!e&&this.filter!==t.FILTER_PCF){return}this.filter=e?t.FILTER_PCF:t.FILTER_NONE},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"filteringQuality",{get:function(){return this._filteringQuality},set:function(e){this._filteringQuality=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"useContactHardeningShadow",{get:function(){return this.filter===t.FILTER_PCSS},set:function(e){if(!e&&this.filter!==t.FILTER_PCSS){return}this.filter=e?t.FILTER_PCSS:t.FILTER_NONE},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"contactHardeningLightSizeUVRatio",{get:function(){return this._contactHardeningLightSizeUVRatio},set:function(e){this._contactHardeningLightSizeUVRatio=e},enumerable:true,configurable:true});t.prototype.getDarkness=function(){return this._darkness};t.prototype.setDarkness=function(e){if(e>=1)this._darkness=1;else if(e<=0)this._darkness=0;else this._darkness=e;return this};t.prototype.setTransparencyShadow=function(e){this._transparencyShadow=e;return this};t.prototype.getShadowMap=function(){return this._shadowMap};t.prototype.getShadowMapForRendering=function(){if(this._shadowMap2){return this._shadowMap2}return this._shadowMap};t.prototype.addShadowCaster=function(e,t){if(t===void 0){t=true}if(!this._shadowMap){return this}if(!this._shadowMap.renderList){this._shadowMap.renderList=[]}this._shadowMap.renderList.push(e);if(t){(i=this._shadowMap.renderList).push.apply(i,e.getChildMeshes())}return this;var i};t.prototype.removeShadowCaster=function(e,t){if(t===void 0){t=true}if(!this._shadowMap||!this._shadowMap.renderList){return this}var i=this._shadowMap.renderList.indexOf(e);if(i!==-1){this._shadowMap.renderList.splice(i,1)}if(t){for(var r=0,n=e.getChildren();r<n.length;r++){var o=n[r];this.removeShadowCaster(o)}}return this};t.prototype.getLight=function(){return this._light};t.prototype._initializeGenerator=function(){this._light._markMeshesAsLightDirty();this._initializeShadowMap()};t.prototype._initializeShadowMap=function(){var i=this;var r=this._scene.getEngine();if(r.webGLVersion>1){this._shadowMap=new e.RenderTargetTexture(this._light.name+"_shadowMap",this._mapSize,this._scene,false,true,this._textureType,this._light.needCube(),undefined,false,false);this._shadowMap.createDepthStencilTexture(e.Engine.LESS,true)}else{this._shadowMap=new e.RenderTargetTexture(this._light.name+"_shadowMap",this._mapSize,this._scene,false,true,this._textureType,this._light.needCube())}this._shadowMap.wrapU=e.Texture.CLAMP_ADDRESSMODE;this._shadowMap.wrapV=e.Texture.CLAMP_ADDRESSMODE;this._shadowMap.anisotropicFilteringLevel=1;this._shadowMap.updateSamplingMode(e.Texture.BILINEAR_SAMPLINGMODE);this._shadowMap.renderParticles=false;this._shadowMap.ignoreCameraViewport=true;this._shadowMap.onBeforeRenderObservable.add(function(e){i._currentFaceIndex=e;if(i._filter===t.FILTER_PCF){r.setColorWrite(false)}});this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this);this._shadowMap.onAfterUnbindObservable.add(function(){if(i._filter===t.FILTER_PCF){r.setColorWrite(true)}if(!i.useBlurExponentialShadowMap&&!i.useBlurCloseExponentialShadowMap){return}var e=i.getShadowMapForRendering();if(e){i._scene.postProcessManager.directRender(i._blurPostProcesses,e.getInternalTexture(),true)}});var n=new e.Color4(0,0,0,0);var o=new e.Color4(1,1,1,1);this._shadowMap.onClearObservable.add(function(e){if(i._filter===t.FILTER_PCF){e.clear(o,false,true,false)}else if(i.useExponentialShadowMap||i.useBlurExponentialShadowMap){e.clear(n,true,true,false)}else{e.clear(o,true,true,false)}})};t.prototype._initializeBlurRTTAndPostProcesses=function(){var t=this;var i=this._scene.getEngine();var r=this._mapSize/this.blurScale;if(!this.useKernelBlur||this.blurScale!==1){this._shadowMap2=new e.RenderTargetTexture(this._light.name+"_shadowMap2",r,this._scene,false,true,this._textureType);this._shadowMap2.wrapU=e.Texture.CLAMP_ADDRESSMODE;this._shadowMap2.wrapV=e.Texture.CLAMP_ADDRESSMODE;this._shadowMap2.updateSamplingMode(e.Texture.BILINEAR_SAMPLINGMODE)}if(this.useKernelBlur){this._kernelBlurXPostprocess=new e.BlurPostProcess(this._light.name+"KernelBlurX",new e.Vector2(1,0),this.blurKernel,1,null,e.Texture.BILINEAR_SAMPLINGMODE,i,false,this._textureType);this._kernelBlurXPostprocess.width=r;this._kernelBlurXPostprocess.height=r;this._kernelBlurXPostprocess.onApplyObservable.add(function(e){e.setTexture("textureSampler",t._shadowMap)});this._kernelBlurYPostprocess=new e.BlurPostProcess(this._light.name+"KernelBlurY",new e.Vector2(0,1),this.blurKernel,1,null,e.Texture.BILINEAR_SAMPLINGMODE,i,false,this._textureType);this._kernelBlurXPostprocess.autoClear=false;this._kernelBlurYPostprocess.autoClear=false;if(this._textureType===e.Engine.TEXTURETYPE_UNSIGNED_INT){this._kernelBlurXPostprocess.packedFloat=true;this._kernelBlurYPostprocess.packedFloat=true}this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]}else{this._boxBlurPostprocess=new e.PostProcess(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,e.Texture.BILINEAR_SAMPLINGMODE,i,false,"#define OFFSET "+this._blurBoxOffset,this._textureType);this._boxBlurPostprocess.onApplyObservable.add(function(e){e.setFloat2("screenSize",r,r);e.setTexture("textureSampler",t._shadowMap)});this._boxBlurPostprocess.autoClear=false;this._blurPostProcesses=[this._boxBlurPostprocess]}};t.prototype._renderForShadowMap=function(e,t,i,r){var n;var o=this._scene.getEngine();if(r.length){o.setColorWrite(false);for(n=0;n<r.length;n++){this._renderSubMeshForShadowMap(r.data[n])}o.setColorWrite(true)}for(n=0;n<e.length;n++){this._renderSubMeshForShadowMap(e.data[n])}for(n=0;n<t.length;n++){this._renderSubMeshForShadowMap(t.data[n])}if(this._transparencyShadow){for(n=0;n<i.length;n++){this._renderSubMeshForShadowMap(i.data[n])}}};t.prototype._renderSubMeshForShadowMap=function(t){var i=this;var r=t.getRenderingMesh();var n=this._scene;var o=n.getEngine();var s=t.getMaterial();if(!s){return}o.setState(s.backFaceCulling);var a=r._getInstancesRenderList(t._id);if(a.mustReturn){return}var u=o.getCaps().instancedArrays&&a.visibleInstances[t._id]!==null&&a.visibleInstances[t._id]!==undefined;if(this.isReady(t,u)){o.enableEffect(this._effect);r._bind(t,this._effect,e.Material.TriangleFillMode);this._effect.setFloat3("biasAndScale",this.bias,this.normalBias,this.depthScale);this._effect.setMatrix("viewProjection",this.getTransformMatrix());if(this.getLight().getTypeID()===e.Light.LIGHTTYPEID_DIRECTIONALLIGHT){this._effect.setVector3("lightData",this._cachedDirection)}else{this._effect.setVector3("lightData",this._cachedPosition)}if(n.activeCamera){this._effect.setFloat2("depthValues",this.getLight().getDepthMinZ(n.activeCamera),this.getLight().getDepthMinZ(n.activeCamera)+this.getLight().getDepthMaxZ(n.activeCamera))}if(s&&s.needAlphaTesting()){var l=s.getAlphaTestTexture();if(l){this._effect.setTexture("diffuseSampler",l);this._effect.setMatrix("diffuseMatrix",l.getTextureMatrix()||this._defaultTextureMatrix)}}if(r.useBones&&r.computeBonesUsingShaders){this._effect.setMatrices("mBones",r.skeleton.getTransformMatrices(r))}e.MaterialHelper.BindMorphTargetParameters(r,this._effect);if(this.forceBackFacesOnly){o.setState(true,0,false,true)}r._processRendering(t,this._effect,e.Material.TriangleFillMode,a,u,function(e,t){return i._effect.setMatrix("world",t)});if(this.forceBackFacesOnly){o.setState(true,0,false,false)}}else{if(this._shadowMap){this._shadowMap.resetRefreshCounter()}}};t.prototype._applyFilterValues=function(){if(!this._shadowMap){return}if(this.filter===t.FILTER_NONE||this.filter===t.FILTER_PCSS){this._shadowMap.updateSamplingMode(e.Texture.NEAREST_SAMPLINGMODE)}else{this._shadowMap.updateSamplingMode(e.Texture.BILINEAR_SAMPLINGMODE)}};t.prototype.forceCompilation=function(e,t){var i=this;var r=n({useInstances:false},t);var o=this.getShadowMap();if(!o){if(e){e(this)}return}var s=o.renderList;if(!s){if(e){e(this)}return}var a=new Array;for(var u=0,l=s;u<l.length;u++){var c=l[u];a.push.apply(a,c.subMeshes)}if(a.length===0){if(e){e(this)}return}var h=0;var f=function(){if(!i._scene||!i._scene.getEngine()){return}while(i.isReady(a[h],r.useInstances)){h++;if(h>=a.length){if(e){e(i)}return}}setTimeout(f,16)};f()};t.prototype.forceCompilationAsync=function(e){var t=this;return new Promise(function(i){t.forceCompilation(function(){i()},e)})};t.prototype.isReady=function(t,i){var r=[];if(this._textureType!==e.Engine.TEXTURETYPE_UNSIGNED_INT){r.push("#define FLOAT")}if(this.useExponentialShadowMap||this.useBlurExponentialShadowMap){r.push("#define ESM")}else if(this.usePercentageCloserFiltering||this.useContactHardeningShadow){r.push("#define DEPTHTEXTURE")}var n=[e.VertexBuffer.PositionKind];var o=t.getMesh();var s=t.getMaterial();if(this.normalBias&&o.isVerticesDataPresent(e.VertexBuffer.NormalKind)){n.push(e.VertexBuffer.NormalKind);r.push("#define NORMAL");if(o.nonUniformScaling){r.push("#define NONUNIFORMSCALING")}if(this.getLight().getTypeID()===e.Light.LIGHTTYPEID_DIRECTIONALLIGHT){r.push("#define DIRECTIONINLIGHTDATA")}}if(s&&s.needAlphaTesting()){var a=s.getAlphaTestTexture();if(a){r.push("#define ALPHATEST");if(o.isVerticesDataPresent(e.VertexBuffer.UVKind)){n.push(e.VertexBuffer.UVKind);r.push("#define UV1")}if(o.isVerticesDataPresent(e.VertexBuffer.UV2Kind)){if(a.coordinatesIndex===1){n.push(e.VertexBuffer.UV2Kind);r.push("#define UV2")}}}}if(o.useBones&&o.computeBonesUsingShaders){n.push(e.VertexBuffer.MatricesIndicesKind);n.push(e.VertexBuffer.MatricesWeightsKind);if(o.numBoneInfluencers>4){n.push(e.VertexBuffer.MatricesIndicesExtraKind);n.push(e.VertexBuffer.MatricesWeightsExtraKind)}r.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers);r.push("#define BonesPerMesh "+(o.skeleton.bones.length+1))}else{r.push("#define NUM_BONE_INFLUENCERS 0")}var u=o.morphTargetManager;var l=0;if(u){if(u.numInfluencers>0){r.push("#define MORPHTARGETS");l=u.numInfluencers;r.push("#define NUM_MORPH_INFLUENCERS "+l);e.MaterialHelper.PrepareAttributesForMorphTargets(n,o,{NUM_MORPH_INFLUENCERS:l})}}if(i){r.push("#define INSTANCES");n.push("world0");n.push("world1");n.push("world2");n.push("world3")}var c=r.join("\n");if(this._cachedDefines!==c){this._cachedDefines=c;this._effect=this._scene.getEngine().createEffect("shadowMap",n,["world","mBones","viewProjection","diffuseMatrix","lightData","depthValues","biasAndScale","morphTargetInfluences"],["diffuseSampler"],c,undefined,undefined,undefined,{maxSimultaneousMorphTargets:l})}if(!this._effect.isReady()){return false}if(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap){if(!this._blurPostProcesses||!this._blurPostProcesses.length){this._initializeBlurRTTAndPostProcesses()}}if(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()){return false}if(this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()){return false}if(this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady()){return false}return true};t.prototype.prepareDefines=function(e,i){var r=this._scene;var n=this._light;if(!r.shadowsEnabled||!n.shadowEnabled){return}e["SHADOW"+i]=true;if(this.useContactHardeningShadow){e["SHADOWPCSS"+i]=true;if(this._filteringQuality===t.QUALITY_LOW){e["SHADOWLOWQUALITY"+i]=true}else if(this._filteringQuality===t.QUALITY_MEDIUM){e["SHADOWMEDIUMQUALITY"+i]=true}}if(this.usePercentageCloserFiltering){e["SHADOWPCF"+i]=true;if(this._filteringQuality===t.QUALITY_LOW){e["SHADOWLOWQUALITY"+i]=true}else if(this._filteringQuality===t.QUALITY_MEDIUM){e["SHADOWMEDIUMQUALITY"+i]=true}}else if(this.usePoissonSampling){e["SHADOWPOISSON"+i]=true}else if(this.useExponentialShadowMap||this.useBlurExponentialShadowMap){e["SHADOWESM"+i]=true}else if(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap){e["SHADOWCLOSEESM"+i]=true}if(n.needCube()){e["SHADOWCUBE"+i]=true}};t.prototype.bindShadowLight=function(e,i){var r=this._light;var n=this._scene;if(!n.shadowsEnabled||!r.shadowEnabled){return}var o=n.activeCamera;if(!o){return}var s=this.getShadowMap();if(!s){return}if(!r.needCube()){i.setMatrix("lightMatrix"+e,this.getTransformMatrix())}if(this._filter===t.FILTER_PCF){i.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering());r._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),s.getSize().width,1/s.getSize().width,this.frustumEdgeFalloff,e)}else if(this._filter===t.FILTER_PCSS){i.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering());i.setTexture("depthSampler"+e,this.getShadowMapForRendering());r._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/s.getSize().width,this._contactHardeningLightSizeUVRatio*s.getSize().width,this.frustumEdgeFalloff,e)}else{i.setTexture("shadowSampler"+e,this.getShadowMapForRendering());r._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/s.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)}r._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(o),this.getLight().getDepthMinZ(o)+this.getLight().getDepthMaxZ(o),e)};t.prototype.getTransformMatrix=function(){var t=this._scene;if(this._currentRenderID===t.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex){return this._transformMatrix}this._currentRenderID=t.getRenderId();this._currentFaceIndexCache=this._currentFaceIndex;var i=this._light.position;if(this._light.computeTransformedInformation()){i=this._light.transformedPosition}e.Vector3.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection);if(Math.abs(e.Vector3.Dot(this._lightDirection,e.Vector3.Up()))===1){this._lightDirection.z=1e-13}if(this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!i.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(i);this._cachedDirection.copyFrom(this._lightDirection);e.Matrix.LookAtLHToRef(i,i.add(this._lightDirection),e.Vector3.Up(),this._viewMatrix);var r=this.getShadowMap();if(r){var n=r.renderList;if(n){this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,n)}}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix};t.prototype.recreateShadowMap=function(){var e=this._shadowMap;if(!e){return}var t=e.renderList;this._disposeRTTandPostProcesses();this._initializeGenerator();this.filter=this.filter;this._applyFilterValues();this._shadowMap.renderList=t};t.prototype._disposeBlurPostProcesses=function(){if(this._shadowMap2){this._shadowMap2.dispose();this._shadowMap2=null}if(this._boxBlurPostprocess){this._boxBlurPostprocess.dispose();this._boxBlurPostprocess=null}if(this._kernelBlurXPostprocess){this._kernelBlurXPostprocess.dispose();this._kernelBlurXPostprocess=null}if(this._kernelBlurYPostprocess){this._kernelBlurYPostprocess.dispose();this._kernelBlurYPostprocess=null}this._blurPostProcesses=[]};t.prototype._disposeRTTandPostProcesses=function(){if(this._shadowMap){this._shadowMap.dispose();this._shadowMap=null}this._disposeBlurPostProcesses()};t.prototype.dispose=function(){this._disposeRTTandPostProcesses();if(this._light){this._light._shadowGenerator=null;this._light._markMeshesAsLightDirty()}};t.prototype.serialize=function(){var e={};var t=this.getShadowMap();if(!t){return e}e.lightId=this._light.id;e.mapSize=t.getRenderSize();e.useExponentialShadowMap=this.useExponentialShadowMap;e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap;e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap;e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap;e.usePoissonSampling=this.usePoissonSampling;e.forceBackFacesOnly=this.forceBackFacesOnly;e.depthScale=this.depthScale;e.darkness=this.getDarkness();e.blurBoxOffset=this.blurBoxOffset;e.blurKernel=this.blurKernel;e.blurScale=this.blurScale;e.useKernelBlur=this.useKernelBlur;e.transparencyShadow=this._transparencyShadow;e.bias=this.bias;e.normalBias=this.normalBias;e.usePercentageCloserFiltering=this.usePercentageCloserFiltering;e.useContactHardeningShadow=this.useContactHardeningShadow;e.filteringQuality=this.filteringQuality
;e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio;e.renderList=[];if(t.renderList){for(var i=0;i<t.renderList.length;i++){var r=t.renderList[i];e.renderList.push(r.id)}}return e};t.Parse=function(e,i){var r=i.getLightByID(e.lightId);var n=new t(e.mapSize,r);var o=n.getShadowMap();for(var s=0;s<e.renderList.length;s++){var a=i.getMeshesByID(e.renderList[s]);a.forEach(function(e){if(!o){return}if(!o.renderList){o.renderList=[]}o.renderList.push(e)})}if(e.usePoissonSampling){n.usePoissonSampling=true}else if(e.useExponentialShadowMap){n.useExponentialShadowMap=true}else if(e.useBlurExponentialShadowMap){n.useBlurExponentialShadowMap=true}else if(e.useCloseExponentialShadowMap){n.useCloseExponentialShadowMap=true}else if(e.useBlurCloseExponentialShadowMap){n.useBlurCloseExponentialShadowMap=true}else if(e.usePercentageCloserFiltering){n.usePercentageCloserFiltering=true}else if(e.useContactHardeningShadow){n.useContactHardeningShadow=true}if(e.filteringQuality){n.filteringQuality=e.filteringQuality}if(e.contactHardeningLightSizeUVRatio){n.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio}else if(e.useVarianceShadowMap){n.useExponentialShadowMap=true}else if(e.useBlurVarianceShadowMap){n.useBlurExponentialShadowMap=true}if(e.depthScale){n.depthScale=e.depthScale}if(e.blurScale){n.blurScale=e.blurScale}if(e.blurBoxOffset){n.blurBoxOffset=e.blurBoxOffset}if(e.useKernelBlur){n.useKernelBlur=e.useKernelBlur}if(e.blurKernel){n.blurKernel=e.blurKernel}if(e.bias!==undefined){n.bias=e.bias}if(e.normalBias!==undefined){n.normalBias=e.normalBias}if(e.darkness){n.setDarkness(e.darkness)}if(e.transparencyShadow){n.setTransparencyShadow(true)}n.forceBackFacesOnly=e.forceBackFacesOnly;return n};t.FILTER_NONE=0;t.FILTER_EXPONENTIALSHADOWMAP=1;t.FILTER_POISSONSAMPLING=2;t.FILTER_BLUREXPONENTIALSHADOWMAP=3;t.FILTER_CLOSEEXPONENTIALSHADOWMAP=4;t.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5;t.FILTER_PCF=6;t.FILTER_PCSS=7;t.QUALITY_HIGH=0;t.QUALITY_MEDIUM=1;t.QUALITY_LOW=2;return t}();e.ShadowGenerator=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e,t,i){if(t===void 0){t=""}if(i===void 0){i="black"}var r=this;this._renderingCanvas=e;this._loadingText=t;this._loadingDivBackgroundColor=i;this._resizeLoadingUI=function(){var e=r._renderingCanvas.getBoundingClientRect();var t=window.getComputedStyle(r._renderingCanvas).position;if(!r._loadingDiv){return}r._loadingDiv.style.position=t==="fixed"?"fixed":"absolute";r._loadingDiv.style.left=e.left+"px";r._loadingDiv.style.top=e.top+"px";r._loadingDiv.style.width=e.width+"px";r._loadingDiv.style.height=e.height+"px"}}e.prototype.displayLoadingUI=function(){if(this._loadingDiv){return}this._loadingDiv=document.createElement("div");this._loadingDiv.id="babylonjsLoadingDiv";this._loadingDiv.style.opacity="0";this._loadingDiv.style.transition="opacity 1.5s ease";this._loadingDiv.style.pointerEvents="none";this._loadingTextDiv=document.createElement("div");this._loadingTextDiv.style.position="absolute";this._loadingTextDiv.style.left="0";this._loadingTextDiv.style.top="50%";this._loadingTextDiv.style.marginTop="80px";this._loadingTextDiv.style.width="100%";this._loadingTextDiv.style.height="20px";this._loadingTextDiv.style.fontFamily="Arial";this._loadingTextDiv.style.fontSize="14px";this._loadingTextDiv.style.color="white";this._loadingTextDiv.style.textAlign="center";this._loadingTextDiv.innerHTML="Loading";this._loadingDiv.appendChild(this._loadingTextDiv);this._loadingTextDiv.innerHTML=this._loadingText;var e=document.createElement("style");e.type="text/css";var t="@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}\n                    100% { -webkit-transform: rotate(360deg);}\n                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}\n                    100% { transform: rotate(360deg);}\n                }";e.innerHTML=t;document.getElementsByTagName("head")[0].appendChild(e);var i=new Image;i.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAYAAAA5ZDbSAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTZEaa/1AAAYq0lEQVR4Xu2dCZRcVZnHScAJUZSwjSOIbAJmEAZwQCCMoAInYRGIg8AwegQx7AFzUBBmzAFlE4EAwxz2GRk2w7AnAURZBiEOZgyEQDAQAjmEJqTpNd3V1V3Vmd+/6utKV7/1vnpVXd2p/zn3vOV+27vfu/fd/W3QQAPrBZqbm7fJZrN79vf3T+/r67uf4wO9vb37WXQDIwWtra0Tenp6voQTv5XP56/BkfcR3iLk1g6B7hEeI+zP5V+ZiAbqBZ2dnZ8lV+6Gg87CobfhpOc4byf0FjwYE9DneBkWcXrM2tmzNzTxDdQKJPyETCazI46YgiMuI9zJuXJltuChFIHsP/PSfIfTjU19A2mira1tcxy3ey6XO5vEnkV4kes11XBmENDVj97XOT2O03FmWgMuoNLzGRJva8IUnPkzjjcT/kLoKCZzfQB7XiX8M2G8md7AUJgzJ+Z6e88gZ1xGuj3HsY17PcVkrG9gp7CUF/F8PUvxqdZDrFq1ahNVfKjwTCYxZuDE2wjKlc2WViMePM+HPNsFPOdf22OPblD5OZQHvphnV65cjTMzxaQY3eA5V9OO/hmnm1lSjE7woFsQbiXki4++foHnXkW4mLC1JUl947333tsMY3emqfB9jtPJlXN5U0+bOXPmWCPxgOccSy4+AfqPio+9/oFnbyatbqVE28GSZfjQ1NT0KQzaHMcdyPfyaNoE12HcvdxT29K3Fkv8A2vWrPmcifAFZNtD91yRY+SBZ+9UsMtEgD+jTpeenp6JXI6xpKkuUDqRcA6Kr0Wpens+InQTnIpV6Fdi+BQT64ulS5eOIzefD62na7CeoGcnLCM8ykt5OWlzcPv772/BS/w3nP+K+xU11+DvQe5dcrQlTfWAwbNMb8XA8AyGX80xtLlA6TAJuteMbVhhia1v5VMcr+LWMeoZ4xiYw7q6urbhHbgG+paCkIRQehHu4pO3O5fVydEomF5Ulx548JfVD2wqfKE2I3R3ob/f2GoC1DWhdz7HG3i5j2pvb9+Z24m6HvVZQtYsZFWcowlzePEP4jJdR/OQhxTVpAs9NMXxmZxuZKo8IG4s+v8R2tUFphSBTBWzH+OAFwn/gS3TuN55xYoVqfc6dXd3fwHZ1xFaTX0iyGbwjJqXXAammxP00EXx6UMGEx7ram7+vKnzBZ/87Xiwp40tEdDTgYwlHG/CmadSjO7L+XiialOZAej7POFG2VK0Khngl6Pn8/LL0YEtlFh4n8oDAqvaAYH8tzH2iNDm1IIFn8Ax50G7xtgCAU07CfAG4RHOz+vLZL7e0dGxlYlKHaj8BHo25xgrsfV5wrYH4KmouxV+ZZDnCUdwmXxMGgFvFUVWD+jQuOot6rI0tb4gcfaG9v+MrcAn+wj38gL8C7cObmlp2ZRjOkWYD6ypuAf6zjFHLSJ0c/6YQ813DM/yZXgehreiVgP8cvSfsOeExYsXuzs6n8v9j8mqBRZQmdjXVPuira1NHSpn8UDf4Xu0vd2uCtDzacJOlDDf5ng94X8JTWarB8R1EK7ju7udiYgEz/v3pLFKm4oHUHhh3iZdfshpaEYpA4pvKLLXBujLYKRq71XLhUHg27z12rW9B6L/QhLrWWxRH7nzeDK8awi/5HRTEx0K6MZQ694LHk0DqrgfADkreIYz1q5c+UlTEQzesIuMryrggYQWjNL3RGO7p2tuFMeqjaOidgzyCz1yJMTJ6L6d66WEVCcHIO/dQkI75Chs2g97Hoc3jRz9Lge1ED5l4r0gckqRPB0gTw34t1B+h3IqxZkmrn2SULUa7ezZszdE5xfR9130Xsm5ilrnHrmkQOcKvrkncxqrIiY6wlewbw7BOUfDo/b84zzvj9C7J7eCS0NrUiRKCPjUE7ScMBdlF/B2HqBi0ERXBcuXL99YnQz9fX2ah3Up4UnsWGEmDRuUhoTn+Z5PfvbZZ2N/fuCZRJgnfhNVBu73EZoIKt7l0L2UBsYeDZg016nb5EUCWuXQewinUtTuyq2aTStF14a8SD+VDQVj6hDYxjuXf4Hjl83sSMCmTp8j4FtoMuRQ5dAZcii3kk/0s2bBhxIcBxjxUlib1hWInEDO/6qKV+y4geO5HAMntEE/pq+nZyo0ywsG1SmwL4Orf+0yqGCfmvR73LAn9lAeBjQTEhkA+1h49a08iRflcq4H5iuXFU9cz4lqihC/LXS/NZa6Bc+pz5gql5ub6VXD2tZWTSPeyS7XgeLhXrMnEhj6MSHSwaIhFGZH8oA/JzzFeexvJbRN2HW03moT6cEChx6w4QY2rurn85JWrxsiCy0FwjcIqos8w7GZNPulkawDEbFHlaBtjzODEDrVztuKXMmADPWA3RaljyJeNdKq98ilAez8iJdyGqfO31V4NoV/EvyaCqR54V2EshE5Lqcb+TrkstkTLD4WKB4PNNZQ8P05HAelMXNSPWChC8JsYvwthJo0jSoF6fIqjjqe08Aat+LIkd+AVjn09zxbZFqK3tjXAUbXUaWDjTUSyN4J45YZX2Igo4cEOVfFson2ALIxSjR0jog5YNgpfNHM90BxIjDyWIB8Z2NfB01HISJ20wPaw4w1FlavXq1v8aPGXhFw9JNRFTDItifU/RwwpfmKxYsDK180kU4x0lhAXvOSJUs+bezlIDL2N4xi4GpjK4MGCuzUA+SPxzn3m4iKgKyV2DCV08DeMWg0B+zHHOt2DpjS3Mz1BfFOM25C5ZH4LxldJBB0g7GVARkaXgv8VsKqZtIMPpN9RUnJgRzU5Wfp22vifcG3+2vQvmdsdQXsX2pm+oKX+GYjjQXkPWqsXshpRhcJ0RpbGShSHiSuheP37ZYHsGusVHOrU1lMxkO9od4eE+8LlSzQqfetpnPAooBN/2Um+gISp89MkF8K4G3RrMJYoOhbYGxlQEGhSOGogfoLwipExGtUZVVBYIVAluaAaUpuWA+YujlPF22Ra/iBLYEOsV6tV4w0FiitfmLsXiBMU0NiAVrfsp77Zd8MHPgbDoHtva6uLs1jiv1piAKy5tCG+4KJ9wVO/p6RDzvy+b5rzSwP9Okh/WKPERiCWzfk4K8bUSTiOljAyCdx5DZG4gE8W5Dov+NYUfsV/j50fUC4dmXIQDh0qQ6PVgJsOcLM8oA410Ggvo6Ojr81di+g2TKuQOiyJOKWxlpCJpM5zUjKAL3awTsamQfEbYhjtDGKa5tPsyn/wAuiURftlBO56h6aunEwCMxxvV1d+2Fr7Jce2vAu5LUtLeoGi/19gtbToCaR97BoD6BvUs+WkXqgbw6OuhC6wH5l4rRGaCFOvYnjYbyxnpcsCvDVhYOxo6+zszNwSNHVTtJEmSiwzlMAQmNPwIPW42Dds2hfEK/5WJo0Fth+5VNxFHSlkoTzFRh/N3wnq0OGWxXtdoO8enFwaI4jsyidYgNZTxhrMEjEJ4w+En65ESWRXZ7Q4K/COqDAPlhka87WedB8KawmngTIHREOJs5pMiRp+p/GGgxL1FiA9hxjK6G1tVVdhJGAV15+cPXq1f7dahVC20Wg4miCp0uTe3Xh4Hwu93rY1B7SR/t7xQbP5R1FGgpy8IlKe+MJhZ9Aa7u5jPm+pGLX2BMDOZ+hDXgQiXIJ5xoXHZg96anEEFcvOTi0SMUXS4w0FijSTzTWYEA3hkTSEtDI2qw6RoytDLA6jctCvzKqJ8oPFOO7kAhnYe9cZGiWiZ/N9ezguWaSL4h3TUfvKJIfoN0I4sjigYSdZyxlcDVMgEczEY41ER6oZFBOh2Yqegf2zYoziFC3DuZZrjSTPLDtMlxaNPmPP/54W2OPxksrVozP5fLPGr8vEOpbxJCr3jQSJyDvGRNRhv7iHh8vE5LMpKznHBz4zSTOaXwe+mXGGh9tbWvVQf+iyfCAON/ZlTj4v43ECfB94Le4CuMrWVpTtw7O9fZOM5M8oD7xVSOLBdLuNWN1g7bgJUF8+4qpBjf7Te9M6hD4tBDc0289Wh2MHbuaSR7gsHOMLBaQ9W/G6o5MJrNDPu9dcYdQ33Yc95I6OFV5hnp2cGCliDingX5KU+9MShd0dmqta/k8J4zwnV2JsuuNxAnI83VwNpO52kiSoC4djA255cuXBzYPycGzjTQWkPdNY00OfRcQVLafRnd39ySLLsG1i20AyPZ3cDb7AyNJgnp1cOhUHUhcFiL045v9jTUa8Gjlm29fsQQhb3DzJLUEhC+oiK7EISPOwapoEh+7JQJti5YfGXs0YNC62ouC1h9lsrlToClsjc/RM7uSe0kd3EmlzTO/Kqk8Q106mM/Yw2aOB9jnOg6sWTHxJ9FraSJMy6nGz7RbZUDYmN7e3BnQ5Gisez7u3J9c0JwA6Pb0aCFvNObgwKk6NoU59uJwaJ8y1viAT4vCtEFXYO8SFQGtCZpllyXQtNqL+4lmZ/BN/5qJKQFZozEHe9JtAGSaw4wsFnie4JmUQcjleh8yZq0Fnmq3y0D02IzPMgnonYqYIfA4pC+TcXrgIahLB+PEb5s5HrjaR0b7kbHGB0pK7TDO1/T39x1lUZGAPlUH0xTbz+KSoC4dDDx2DQCHzTCaWOB5zjbW+KCSpW0IS0BIJmy6zWCk7WDuxZ4r5oO6dHB7e/sBZo4H2OfUsYOv9jHW+ECJdkAtA/c6MpmMd+XaEKj7km9M4F5TEfBzSKovDLKG1cHobw+b6EDa3WOksYBPAhevBUJMxl8GJTRhFyMLBKSJFn5ls9nvmogS0DfaHOzb3h8AcUuNNBLQNiWa0gRv4MwMMyBwCqxAfCIH82JdYSJKQN+ocjA5NHD2I/e1aj/23iPyhbG6A+bAgXsZoUEII/UAkkQORu71JqIE7o22HBw4VaelpWU74mPPDc/39d1trO5Qb4vJ8QXxbwat06WofcTInMCzeToAtN4VXUn/l1AXDkan9tDSfmL6C81BZooHxDkN9CMveLFZFFAWWZtDwVta3G0sJcAbe3bmYEiniShBXabcL+wflQDD5mD0yKlvk0b/Tk33AG5F7idG+/ibRe54oEl1nLG6A+ZYe1jyAIuG/u2LB3MazxwAfL5vJFGJinxQUwcju6c/n3+FNPm5JhJyy2k/sQTp5nm+2HBJCGi1X1WpwzuBoQXAN+IcjDz8mdePKi/WhH1uxd7GcCjIVBcWpUYDfZ0VbclEJSr2akMBhVrdX6j+Jx3DpSh7vKB8CIiqKwcrcXGqdr05k3RKbU9ryTQVkUB3aHMrEshw7kGCXiv8xxG0h6Uzent6Fpn6MhA17A6GT/3yTxNO1coJbgWur3JFf1fXNuTes5AZe18xXobFHJKv04JZc3O7CtIcgGL9KW03u3QCfL4D4b292dhrpoYgsYOhEz4kaOuHqXKqiagYiN9QnUlyKgX84JUYsQFP9GKzMFRSe8XJb9upE9Dn62CK/KQT75wdTLz+NXgPNdrDuYzeUd0ByN4Wp07n+EdCRZuTY1/ymZQDwIjQye9pA32xdw6IiUgHc639mN8kzCLRjkxzQRzitUpkZ8LZBP1CILUd55EVvdgsCrzJl5i8mgCja+Zgjst4Pq3DUnMmtSWqyNIuQruRU3+CbO08n+pvBAZAjf1IU5kcGJc0YRMBfVV3MPd2RN4+YbvYukI/3sSpe+LUmbw0ryG/6ts1oSLeYrMw6C0xeaFAGc+Wq3hbfeRk582b55lrzf3UHJwWkD0Wp+6BQ3+BfXEXw6UCdHX4TVB0BoJi9Y1Cp59XbUWN8HW7lRjLli3zbINE+1hNiCRI1cGakIhT99ani/A6z1z1nDoUqNQfbO40kyqDfrCBwMg3E5rsCy+8sFlHR8dEnFzRTq/I8hQ9NFFOtGhXVOxgFeUqfknUK7Ctpjl1ANKJ/vmUkvrdwRZmWjpA4J9MTyja2toKY8TQa/ufxP/Whdd5c5cQJHIwfBsTvkKiaqd6/fRyOHKqavdL0H+V2sxmWvrQCAeKItfmQlNyDG/8SVwnetMHyxmA7lm0K2I7GFrlVBW/V6FPP9GqeU4V0Kt2+O2yhctUN6AJBEWD9ngMnessJxh5AfCoQe+8q+xQOYLuWbQrQh2MXP1XYh8S9DKC2sI1z6kCatW3/RCZ6Vj9fNPMqx2wQVNJQlcNEl/mGG5pv48bi7HxMVSOoHsW7QqPg5GlvnJtk6/B9+HMqYUfaXE6rampqWy4dVhgi8FfLprnBXEex+i/wCSkNiSNDSpUxxt7Ccj2nQQYAwUHc9yE3HEotuifDklnfFYMdGNC/lWCxotDf4PvB/jHZTs71c+f2n+ryqCPPcb5/pKdGrTvbH2MUjH4ByOLBDpON9YSFi5cuI1FOwFbbyTox5T6y+iwFL8CqvWvwVtolWgSv/N4sXbl5ZP3r8hRLT50d56KgYJDCYXVhYOhtqqReKDdZuGJtSQSOk8f67x581SspvH3lpoBe9Vefbg/lzveaXmnAf6tEDMNGRp3LnV3ch29o10lQIf+bOKZc+XnmMGARF2EK4vUwQiSw33n7ZlqDWwcaK9Ob29vd26vwj+OT8m3kKFxdd9tlILSJ1Wo8Y8RZT/YiKOY4le5P3SGZJAc7telg7FroL16Jc/n/a1cBBCxsSblwT8LOfofcCh4AQ4x1uoCXZtgVKnYDXLMUECnPSQD29VBcrhfVw7GHrVXb6WylGg0SvUZcrr+YPYuwWVfaE9ltmpA2Q6EQq2UY+yigzf2oqCH4v4MIysD94fdwdig9uqDnB4T5/d+gwHPGNVFcOopyJiPLOfmGTwa0Ek8qS8RKDKORLFWH95utwbDd94SRqqN/Cv4PDXbTFfXfUZWBvRUPJCRBJiIqfnnccy0Dz74wHkWoypY2D4ZGU8gK+kKjQKQ8RcTW1uQI2fmc7nH7LIMFEW+sw6xdyN4CgvNByNIDjp+ZyRVhzlV7dVLaZc7t1cRoW0w9of/No6ptbuRdZupqC3QPZY33HchMkbJiRPssgyaHkN82XaJXPtOJuN+JRuixQI6Cu1VXiZtJehcFGpeNPyXI6cqPWTIvsxU1R7o912akevre4OHfTHot3fEfRbD3y8+Qu0djO5Ce5UXNGl7dTt4z0RGqnOuhgLZgmcPk2FHrrd3jgwkAVQ58e1ioxjcHeMLPWQcq+5gZKm9+hJHjXo5z4xQBQsxxyDjEfir+nNq5GfQo/nYh6f9e4NUgGEFx3DEzvw1nPrOhSJ+kh6GUBUHw6//Kmls96dJ2qv6FxNF9z8g405kVLVXDfkaiFAd4JIkttYUGFpyDOf91Ch/YVEe8DA/gORpuywDfLNMjBOQt4qEupbTPTX4YeJig+/qrnoxkfMeIdH2UHGBfP0H6kFepElc1rY5lBQYXZbzuO7BWYH7b3V3d/+TX1FEG/JSExEJdOi7qsnrx3DuNM8Zdg2NqnN/BjK0EXlVhxORr56wP6Lv/DT+X1FzYLynaOWe2s1TjCQW4An9t6Jk4hBVdH6YpB9YNXoS+SRk/JaQZHd5J2CnesLuyGaze3KZ2hTemoNcpO+uB3pAQuzvC7SeJSfc0258Wo97aX9PT+TmMEMB73jsO0wJzXnVx4llL7pe5kWaFtSqGHHgu6rpPr5jsdx+hyI59G+hA4C25GDO1V69mbf/77h0+lZpzZX44B+Ye1X1cWKz92pKrYlcjtzc6gfN+ufhApd/ErcwTvuTRNI0m4c4Tg77u6gfbCHdTuQcrRFaRKiFU7Xl1O/RqX9RObevRxR43gmEBYUn9wEJIMeF/jk0yVKTta2tE0jg43kx1OatWifEYKDrHYKGDnfkMrU1xHUPaoh7k8i+030EvoV3c6i4aTCoc/9+9NVkFgh6BmZFaig08he3oxYkwBEkQGCzg7gfG6kzaDvuSyLfgIyqt1cF6SAspoS4iJf3c9xaf3JrGEgUzZcOGgvO4agzjTQUkI9V5z4851MuLhBvUUp1gR7tjXEHL+shXFZnduNIBomi6T73FVLLByQePu4N3CxMbVxyzfeQUTYZrdpA3yvoPVf/1jdTGggC6aXx0ieLSecFcWoj72vkhU4IcswU7gVORksb6FHnufbouJ4Xbv+gf1g0EADav9uSeO9YenpA3IfURFVZ0gqEms1rRg0qCzM4TuYy1T061jt0dXXpX0xJ96FMDXIqQXtJ3tSfze6OaY0KU1ogfTUgUJMK0lBIL06dS/F/LJeRe0k2kAAk7BgSWN2GVW/aCOjRuPCbBHVGBG6J3ECKIN3VlfjroguqA+RrMsFvCNqisf5mRox2qPlB4s8vuiMdIE/fVjVvLlRnhKlqYLig7QIpOiva40PAqR2E22neJFrN10AVgWMOIDgPuMOjmRFa+HVaR0fHliaugXoEOe80nBWrZg2dZkZoYffuaW5u1kCVkadmbT70AGdqJodWOhxHqP2eFg1UDvsLatnSFq41M+KKnp6eXbhsdB2OdGiCeX8+/2ecqgnmk/VXNYtqYLSAnNposzpjgw3+H/belpVa8J7TAAAAAElFTkSuQmCC";i.style.position="absolute";i.style.left="50%";i.style.top="50%";i.style.marginLeft="-60px";i.style.marginTop="-60px";i.style.animation="spin1 2s infinite ease-in-out";i.style.webkitAnimation="spin1 2s infinite ease-in-out";i.style.transformOrigin="50% 50%";i.style.webkitTransformOrigin="50% 50%";this._loadingDiv.appendChild(i);this._resizeLoadingUI();window.addEventListener("resize",this._resizeLoadingUI);this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor;document.body.appendChild(this._loadingDiv);this._loadingDiv.style.opacity="1"};e.prototype.hideLoadingUI=function(){var e=this;if(!this._loadingDiv){return}var t=function(){if(!e._loadingDiv){return}document.body.removeChild(e._loadingDiv);window.removeEventListener("resize",e._resizeLoadingUI);e._loadingDiv=null};this._loadingDiv.style.opacity="0";this._loadingDiv.addEventListener("transitionend",t)};Object.defineProperty(e.prototype,"loadingUIText",{set:function(e){this._loadingText=e;if(this._loadingTextDiv){this._loadingTextDiv.innerHTML=this._loadingText}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"loadingUIBackgroundColor",{get:function(){return this._loadingDivBackgroundColor},set:function(e){this._loadingDivBackgroundColor=e;if(!this._loadingDiv){return}this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor},enumerable:true,configurable:true});return e}();e.DefaultLoadingScreen=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e,t,i){this.lengthComputable=e;this.loaded=t;this.total=i}e.FromProgressEvent=function(t){return new e(t.lengthComputable,t.loaded,t.total)};return e}();e.SceneLoaderProgressEvent=t;var i=function(){function i(){}Object.defineProperty(i,"NO_LOGGING",{get:function(){return 0},enumerable:true,configurable:true});Object.defineProperty(i,"MINIMAL_LOGGING",{get:function(){return 1},enumerable:true,configurable:true});Object.defineProperty(i,"SUMMARY_LOGGING",{get:function(){return 2},enumerable:true,configurable:true});Object.defineProperty(i,"DETAILED_LOGGING",{get:function(){return 3},enumerable:true,configurable:true});Object.defineProperty(i,"ForceFullSceneLoadingForIncremental",{get:function(){return i._ForceFullSceneLoadingForIncremental},set:function(e){i._ForceFullSceneLoadingForIncremental=e},enumerable:true,configurable:true});Object.defineProperty(i,"ShowLoadingScreen",{get:function(){return i._ShowLoadingScreen},set:function(e){i._ShowLoadingScreen=e},enumerable:true,configurable:true});Object.defineProperty(i,"loggingLevel",{get:function(){return i._loggingLevel},set:function(e){i._loggingLevel=e},enumerable:true,configurable:true});Object.defineProperty(i,"CleanBoneMatrixWeights",{get:function(){return i._CleanBoneMatrixWeights},set:function(e){i._CleanBoneMatrixWeights=e},enumerable:true,configurable:true});i._getDefaultPlugin=function(){return i._registeredPlugins[".babylon"]};i._getPluginForExtension=function(t){var r=i._registeredPlugins[t];if(r){return r}e.Tools.Warn("Unable to find a plugin to load "+t+" files. Trying to use .babylon default plugin.");return i._getDefaultPlugin()};i._getPluginForDirectLoad=function(e){for(var t in i._registeredPlugins){var r=i._registeredPlugins[t].plugin;if(r.canDirectLoad&&r.canDirectLoad(e)){return i._registeredPlugins[t]}}return i._getDefaultPlugin()};i._getPluginForFilename=function(e){if(e.name){e=e.name}var t=e.indexOf("?");if(t!==-1){e=e.substring(0,t)}var r=e.lastIndexOf(".");var n=e.substring(r,e.length).toLowerCase();return i._getPluginForExtension(n)};i._getDirectLoad=function(e){if(e.substr&&e.substr(0,5)==="data:"){return e.substr(5)}return null};i._loadData=function(r,n,o,s,a,u,l,c){var h=i._getDirectLoad(n);var f=c?i._getPluginForExtension(c):h?i._getPluginForDirectLoad(n):i._getPluginForFilename(n);var d;if(f.plugin.createPlugin){d=f.plugin.createPlugin()}else{d=f.plugin}var p=f.isBinary;var _;i.OnPluginActivatedObservable.notifyObservers(d);var m=function(e,t){if(o.isDisposed){u("Scene has been disposed");return}o.database=_;s(d,e,t)};var g=null;var v=false;var y=d.onDisposeObservable;if(y){y.add(function(){v=true;if(g){g.abort();g=null}l()})}var b=function(){if(v){return}var i=r+n;g=e.Tools.LoadFile(i,m,a?function(e){a(t.FromProgressEvent(e))}:undefined,_,p,function(e,t){u("Failed to load scene."+(t?"":" "+t.message),t)})};if(h){m(h);return d}if(r.indexOf("file:")===-1){var x=o.getEngine().enableOfflineSupport;if(x){var T=false;for(var E=0,P=o.disableOfflineSupportExceptionRules;E<P.length;E++){var A=P[E];if(A.test(r+n)){T=true;break}}x=!T}if(x){_=new e.Database(r+n,b)}else{b()}}else{var M=n;if(M.name){g=e.Tools.ReadFile(M,m,a,p)}else if(e.FilesInput.FilesToLoad[n]){g=e.Tools.ReadFile(e.FilesInput.FilesToLoad[n],m,a,p)}else{u("Unable to find file named "+n)}}return d};i.GetPluginForExtension=function(e){return i._getPluginForExtension(e).plugin};i.IsPluginForExtensionAvailable=function(e){return!!i._registeredPlugins[e]};i.RegisterPlugin=function(e){if(typeof e.extensions==="string"){var t=e.extensions;i._registeredPlugins[t.toLowerCase()]={plugin:e,isBinary:false}}else{var r=e.extensions;Object.keys(r).forEach(function(t){i._registeredPlugins[t.toLowerCase()]={plugin:e,isBinary:r[t].isBinary}})}};i.ImportMesh=function(t,r,n,o,s,a,u,l){if(s===void 0){s=null}if(a===void 0){a=null}if(u===void 0){u=null}if(l===void 0){l=null}if(n.substr&&n.substr(0,1)==="/"){e.Tools.Error("Wrong sceneFilename parameter");return null}var c={};o._addPendingData(c);var h=function(){o._removePendingData(c)};var f=function(t,i){var s="Unable to import meshes from "+r+n+": "+t;if(u){u(o,s,i)}else{e.Tools.Error(s)}h()};var d=a?function(e){try{a(e)}catch(e){f("Error in onProgress callback",e)}}:undefined;var p=function(e,t,i,a){o.importedMeshesFiles.push(r+n);if(s){try{s(e,t,i,a)}catch(e){f("Error in onSuccess callback",e)}}o._removePendingData(c)};return i._loadData(r,n,o,function(i,s,a){if(i.rewriteRootURL){r=i.rewriteRootURL(r,a)}if(n===""){if(n===""){r=e.Tools.GetFolderPath(r,true)}}if(i.importMesh){var u=i;var l=new Array;var c=new Array;var h=new Array;if(!u.importMesh(t,o,s,r,l,c,h,f)){return}o.loadingPluginName=i.name;p(l,c,h,[])}else{var _=i;_.importMeshAsync(t,o,s,r,d).then(function(e){o.loadingPluginName=i.name;p(e.meshes,e.particleSystems,e.skeletons,e.animationGroups)}).catch(function(e){f(e.message,e)})}},d,f,h,l)};i.ImportMeshAsync=function(e,t,r,n,o,s){if(o===void 0){o=null}if(s===void 0){s=null}return new Promise(function(s,a){i.ImportMesh(e,t,r,n,function(e,t,i,r){s({meshes:e,particleSystems:t,skeletons:i,animationGroups:r})},o,function(e,t,i){a(i||new Error(t))})})};i.Load=function(t,r,n,o,s,a,u){if(o===void 0){o=null}if(s===void 0){s=null}if(a===void 0){a=null}if(u===void 0){u=null}return i.Append(t,r,new e.Scene(n),o,s,a,u)};i.LoadAsync=function(e,t,r,n,o){if(n===void 0){n=null}if(o===void 0){o=null}return new Promise(function(s,a){i.Load(e,t,r,function(e){s(e)},n,function(e,t,i){a(i||new Error(t))},o)})};i.Append=function(t,r,n,o,s,a,u){if(o===void 0){o=null}if(s===void 0){s=null}if(a===void 0){a=null}if(u===void 0){u=null}if(r.substr&&r.substr(0,1)==="/"){e.Tools.Error("Wrong sceneFilename parameter");return null}if(i.ShowLoadingScreen){n.getEngine().displayLoadingUI()}var l={};n._addPendingData(l);var c=function(){n._removePendingData(l);n.getEngine().hideLoadingUI()};var h=function(i,o){var s="Unable to load from "+t+r+(i?": "+i:"");if(a){a(n,s,o)}else{e.Tools.Error(s)}c()};var f=s?function(e){try{s(e)}catch(e){h("Error in onProgress callback",e)}}:undefined;var d=function(){if(o){try{o(n)}catch(e){h("Error in onSuccess callback",e)}}n._removePendingData(l)};return i._loadData(t,r,n,function(o,s,a){if(r===""){t=e.Tools.GetFolderPath(t,true)}if(o.load){var u=o;if(!u.load(n,s,t,h)){return}n.loadingPluginName=o.name;d()}else{var l=o;l.loadAsync(n,s,t,f).then(function(){n.loadingPluginName=o.name;d()}).catch(function(e){h(e.message,e)})}if(i.ShowLoadingScreen){n.executeWhenReady(function(){n.getEngine().hideLoadingUI()})}},f,h,c,u)};i.AppendAsync=function(e,t,r,n,o){if(n===void 0){n=null}if(o===void 0){o=null}return new Promise(function(s,a){i.Append(e,t,r,function(e){s(e)},n,function(e,t,i){a(i||new Error(t))},o)})};i.LoadAssetContainer=function(t,r,n,o,s,a,u){if(o===void 0){o=null}if(s===void 0){s=null}if(a===void 0){a=null}if(u===void 0){u=null}if(r.substr&&r.substr(0,1)==="/"){e.Tools.Error("Wrong sceneFilename parameter");return null}var l={};n._addPendingData(l);var c=function(){n._removePendingData(l)};var h=function(i,o){var s="Unable to load assets from "+t+r+(i?": "+i:"");if(a){a(n,s,o)}else{e.Tools.Error(s)}c()};var f=s?function(e){try{s(e)}catch(e){h("Error in onProgress callback",e)}}:undefined;var d=function(e){if(o){try{o(e)}catch(e){h("Error in onSuccess callback",e)}}n._removePendingData(l)};return i._loadData(t,r,n,function(e,r,o){if(e.loadAssetContainer){var s=e;var a=s.loadAssetContainer(n,r,t,h);if(!a){return}n.loadingPluginName=e.name;d(a)}else if(e.loadAssetContainerAsync){var u=e;u.loadAssetContainerAsync(n,r,t,f).then(function(t){n.loadingPluginName=e.name;d(t)}).catch(function(e){h(e.message,e)})}else{h("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")}if(i.ShowLoadingScreen){n.executeWhenReady(function(){n.getEngine().hideLoadingUI()})}},f,h,c,u)};i.LoadAssetContainerAsync=function(e,t,r,n,o){if(n===void 0){n=null}if(o===void 0){o=null}return new Promise(function(s,a){i.LoadAssetContainer(e,t,r,function(e){s(e)},n,function(e,t,i){a(i||new Error(t))},o)})};i._ForceFullSceneLoadingForIncremental=false;i._ShowLoadingScreen=true;i._CleanBoneMatrixWeights=false;i._loggingLevel=i.NO_LOGGING;i.OnPluginActivatedObservable=new e.Observable;i._registeredPlugins={};return i}();e.SceneLoader=i})(r||(r={}));"use strict";var r;(function(e){var t=function(t,i,r,n){for(var o=0,s=i.materials.length;o<s;o++){var a=i.materials[o];if(a.id===t){return e.Material.Parse(a,r,n)}}return null};var i=function(e,t,i){for(var r in t){if(e.name===t[r]){i.push(e.id);return true}}if(e.parentId&&i.indexOf(e.parentId)!==-1){i.push(e.id);return true}return false};var r=function(e,t){return e+" of "+(t?t.file+" from "+t.name+" version: "+t.version+", exporter version: "+t.exporter_version:"unknown")};var n=function(t,i,n,o,s){if(s===void 0){s=false}var a=new e.AssetContainer(t);var u="importScene has failed JSON parse";try{var l=JSON.parse(i);u="";var c=e.SceneLoader.loggingLevel===e.SceneLoader.DETAILED_LOGGING;var h;var f;if(l.lights!==undefined&&l.lights!==null){for(h=0,f=l.lights.length;h<f;h++){var d=l.lights[h];var p=e.Light.Parse(d,t);if(p){a.lights.push(p);u+=h===0?"\n\tLights:":"";u+="\n\t\t"+p.toString(c)}}}if(l.animations!==undefined&&l.animations!==null){for(h=0,f=l.animations.length;h<f;h++){var _=l.animations[h];var m=e.Animation.Parse(_);t.animations.push(m);a.animations.push(m);u+=h===0?"\n\tAnimations:":"";u+="\n\t\t"+m.toString(c)}}if(l.materials!==undefined&&l.materials!==null){for(h=0,f=l.materials.length;h<f;h++){var g=l.materials[h];var v=e.Material.Parse(g,t,n);a.materials.push(v);u+=h===0?"\n\tMaterials:":"";u+="\n\t\t"+v.toString(c)}}if(l.multiMaterials!==undefined&&l.multiMaterials!==null){for(h=0,f=l.multiMaterials.length;h<f;h++){var y=l.multiMaterials[h];var b=e.Material.ParseMultiMaterial(y,t);a.multiMaterials.push(b);u+=h===0?"\n\tMultiMaterials:":"";u+="\n\t\t"+b.toString(c)}}if(l.morphTargetManagers!==undefined&&l.morphTargetManagers!==null){for(var x=0,T=l.morphTargetManagers;x<T.length;x++){var E=T[x];a.morphTargetManagers.push(e.MorphTargetManager.Parse(E,t))}}if(l.skeletons!==undefined&&l.skeletons!==null){for(h=0,f=l.skeletons.length;h<f;h++){var P=l.skeletons[h];var A=e.Skeleton.Parse(P,t);a.skeletons.push(A);u+=h===0?"\n\tSkeletons:":"";u+="\n\t\t"+A.toString(c)}}var M=l.geometries;if(M!==undefined&&M!==null){var S=new Array;var C=M.boxes;if(C!==undefined&&C!==null){for(h=0,f=C.length;h<f;h++){var R=C[h];S.push(e.BoxGeometry.Parse(R,t))}}var O=M.spheres;if(O!==undefined&&O!==null){for(h=0,f=O.length;h<f;h++){var I=O[h];S.push(e.SphereGeometry.Parse(I,t))}}var D=M.cylinders;if(D!==undefined&&D!==null){for(h=0,f=D.length;h<f;h++){var w=D[h];S.push(e.CylinderGeometry.Parse(w,t))}}var L=M.toruses;if(L!==undefined&&L!==null){for(h=0,f=L.length;h<f;h++){var F=L[h];S.push(e.TorusGeometry.Parse(F,t))}}var B=M.grounds;if(B!==undefined&&B!==null){for(h=0,f=B.length;h<f;h++){var V=B[h];S.push(e.GroundGeometry.Parse(V,t))}}var N=M.planes;if(N!==undefined&&N!==null){for(h=0,f=N.length;h<f;h++){var U=N[h];S.push(e.PlaneGeometry.Parse(U,t))}}var k=M.torusKnots;if(k!==undefined&&k!==null){for(h=0,f=k.length;h<f;h++){var z=k[h];S.push(e.TorusKnotGeometry.Parse(z,t))}}var G=M.vertexData;if(G!==undefined&&G!==null){for(h=0,f=G.length;h<f;h++){var W=G[h];S.push(e.Geometry.Parse(W,t,n))}}S.forEach(function(e){if(e){a.geometries.push(e)}})}if(l.transformNodes!==undefined&&l.transformNodes!==null){for(h=0,f=l.transformNodes.length;h<f;h++){var H=l.transformNodes[h];var j=e.TransformNode.Parse(H,t,n);a.transformNodes.push(j)}}if(l.meshes!==undefined&&l.meshes!==null){for(h=0,f=l.meshes.length;h<f;h++){var X=l.meshes[h];var Y=e.Mesh.Parse(X,t,n);a.meshes.push(Y);u+=h===0?"\n\tMeshes:":"";u+="\n\t\t"+Y.toString(c)}}if(l.cameras!==undefined&&l.cameras!==null){for(h=0,f=l.cameras.length;h<f;h++){var K=l.cameras[h];var Q=e.Camera.Parse(K,t);a.cameras.push(Q);u+=h===0?"\n\tCameras:":"";u+="\n\t\t"+Q.toString(c)}}for(h=0,f=t.cameras.length;h<f;h++){var Q=t.cameras[h];if(Q._waitingParentId){Q.parent=t.getLastEntryByID(Q._waitingParentId);Q._waitingParentId=null}}for(h=0,f=t.lights.length;h<f;h++){var Z=t.lights[h];if(Z&&Z._waitingParentId){Z.parent=t.getLastEntryByID(Z._waitingParentId);Z._waitingParentId=null}}var q=[];var J;if(e.AudioEngine&&l.sounds!==undefined&&l.sounds!==null){for(h=0,f=l.sounds.length;h<f;h++){var $=l.sounds[h];if(e.Engine.audioEngine.canUseWebAudio){if(!$.url)$.url=$.name;if(!q[$.url]){J=e.Sound.Parse($,t,n);q[$.url]=J;a.sounds.push(J)}else{a.sounds.push(e.Sound.Parse($,t,n,q[$.url]))}}else{a.sounds.push(new e.Sound($.name,null,t))}}}q=[];for(h=0,f=t.transformNodes.length;h<f;h++){var ee=t.transformNodes[h];if(ee._waitingParentId){ee.parent=t.getLastEntryByID(ee._waitingParentId);ee._waitingParentId=null}}for(h=0,f=t.meshes.length;h<f;h++){var Y=t.meshes[h];if(Y._waitingParentId){Y.parent=t.getLastEntryByID(Y._waitingParentId);Y._waitingParentId=null}if(Y._waitingActions){e.ActionManager.Parse(Y._waitingActions,Y,t);Y._waitingActions=null}}for(h=0,f=t.meshes.length;h<f;h++){var te=t.meshes[h];if(te._waitingFreezeWorldMatrix){te.freezeWorldMatrix();te._waitingFreezeWorldMatrix=null}else{te.computeWorldMatrix(true)}}if(l.particleSystems!==undefined&&l.particleSystems!==null){for(h=0,f=l.particleSystems.length;h<f;h++){var ie=l.particleSystems[h];if(ie.activeParticleCount){var re=e.GPUParticleSystem.Parse(ie,t,n);a.particleSystems.push(re)}else{var re=e.ParticleSystem.Parse(ie,t,n);a.particleSystems.push(re)}}}if(l.lensFlareSystems!==undefined&&l.lensFlareSystems!==null){for(h=0,f=l.lensFlareSystems.length;h<f;h++){var ne=l.lensFlareSystems[h];var oe=e.LensFlareSystem.Parse(ne,t,n);a.lensFlareSystems.push(oe)}}if(l.shadowGenerators!==undefined&&l.shadowGenerators!==null){for(h=0,f=l.shadowGenerators.length;h<f;h++){var se=l.shadowGenerators[h];var ae=e.ShadowGenerator.Parse(se,t);a.shadowGenerators.push(ae)}}for(h=0,f=t.lights.length;h<f;h++){var ue=t.lights[h];if(ue._excludedMeshesIds.length>0){for(var le=0;le<ue._excludedMeshesIds.length;le++){var ce=t.getMeshByID(ue._excludedMeshesIds[le]);if(ce){ue.excludedMeshes.push(ce)}}ue._excludedMeshesIds=[]}if(ue._includedOnlyMeshesIds.length>0){for(var he=0;he<ue._includedOnlyMeshesIds.length;he++){var fe=t.getMeshByID(ue._includedOnlyMeshesIds[he]);if(fe){ue.includedOnlyMeshes.push(fe)}}ue._includedOnlyMeshesIds=[]}}if(l.actions!==undefined&&l.actions!==null){e.ActionManager.Parse(l.actions,null,t)}if(!s){a.removeAllFromScene()}}catch(t){var de=r("loadAssts",l?l.producer:"Unknown")+u;if(o){o(de,t)}else{e.Tools.Log(de);throw t}}finally{if(u!==null&&e.SceneLoader.loggingLevel!==e.SceneLoader.NO_LOGGING){e.Tools.Log(r("loadAssts",l?l.producer:"Unknown")+(e.SceneLoader.loggingLevel!==e.SceneLoader.MINIMAL_LOGGING?u:""))}}return a};e.SceneLoader.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:function(e){if(e.indexOf("babylon")!==-1){return true}return false},importMesh:function(n,o,s,a,u,l,c,h){var f="importMesh has failed JSON parse";try{var d=JSON.parse(s);f="";var p=e.SceneLoader.loggingLevel===e.SceneLoader.DETAILED_LOGGING;if(!n){n=null}else if(!Array.isArray(n)){n=[n]}var _=new Array;if(d.meshes!==undefined&&d.meshes!==null){var m=[];var g=[];var v;var y;for(v=0,y=d.meshes.length;v<y;v++){var b=d.meshes[v];if(n===null||i(b,n,_)){if(n!==null){delete n[n.indexOf(b.name)]}if(b.geometryId!==undefined&&b.geometryId!==null){if(d.geometries!==undefined&&d.geometries!==null){var x=false;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(function(t){if(x===true||!d.geometries[t]||!Array.isArray(d.geometries[t])){return}else{d.geometries[t].forEach(function(i){if(i.id===b.geometryId){switch(t){case"boxes":e.BoxGeometry.Parse(i,o);break;case"spheres":e.SphereGeometry.Parse(i,o);break;case"cylinders":e.CylinderGeometry.Parse(i,o);break;case"toruses":e.TorusGeometry.Parse(i,o);break;case"grounds":e.GroundGeometry.Parse(i,o);break;case"planes":e.PlaneGeometry.Parse(i,o);break;case"torusKnots":e.TorusKnotGeometry.Parse(i,o);break;case"vertexData":e.Geometry.Parse(i,o,a);break}x=true}})}});if(x===false){e.Tools.Warn("Geometry not found for mesh "+b.id)}}}if(b.materialId){var T=g.indexOf(b.materialId)!==-1;if(T===false&&d.multiMaterials!==undefined&&d.multiMaterials!==null){for(var E=0,P=d.multiMaterials.length;E<P;E++){var A=d.multiMaterials[E];if(A.id===b.materialId){for(var M=0,S=A.materials.length;M<S;M++){var C=A.materials[M];g.push(C);var R=t(C,d,o,a);if(R){f+="\n\tMaterial "+R.toString(p)}}g.push(A.id);var O=e.Material.ParseMultiMaterial(A,o);if(O){T=true;f+="\n\tMulti-Material "+O.toString(p)}break}}}if(T===false){g.push(b.materialId);var R=t(b.materialId,d,o,a);if(!R){e.Tools.Warn("Material not found for mesh "+b.id)}else{f+="\n\tMaterial "+R.toString(p)}}}if(b.skeletonId>-1&&d.skeletons!==undefined&&d.skeletons!==null){var I=m.indexOf(b.skeletonId)>-1;if(I===false){for(var D=0,w=d.skeletons.length;D<w;D++){var L=d.skeletons[D];if(L.id===b.skeletonId){var F=e.Skeleton.Parse(L,o);c.push(F);m.push(L.id);f+="\n\tSkeleton "+F.toString(p)}}}}var B=e.Mesh.Parse(b,o,a);u.push(B);f+="\n\tMesh "+B.toString(p)}}var V;for(v=0,y=o.meshes.length;v<y;v++){V=o.meshes[v];if(V._waitingParentId){V.parent=o.getLastEntryByID(V._waitingParentId);V._waitingParentId=null}}for(v=0,y=o.meshes.length;v<y;v++){V=o.meshes[v];if(V._waitingFreezeWorldMatrix){V.freezeWorldMatrix();V._waitingFreezeWorldMatrix=null}else{V.computeWorldMatrix(true)}}}if(d.particleSystems!==undefined&&d.particleSystems!==null){for(v=0,y=d.particleSystems.length;v<y;v++){var N=d.particleSystems[v];if(_.indexOf(N.emitterId)!==-1){l.push(e.ParticleSystem.Parse(N,o,a))}}}return true}catch(t){var U=r("importMesh",d?d.producer:"Unknown")+f;if(h){h(U,t)}else{e.Tools.Log(U)
;throw t}}finally{if(f!==null&&e.SceneLoader.loggingLevel!==e.SceneLoader.NO_LOGGING){e.Tools.Log(r("importMesh",d?d.producer:"Unknown")+(e.SceneLoader.loggingLevel!==e.SceneLoader.MINIMAL_LOGGING?f:""))}}return false},load:function(t,i,o,s){var a="importScene has failed JSON parse";try{var u=JSON.parse(i);a="";if(u.useDelayedTextureLoading!==undefined&&u.useDelayedTextureLoading!==null){t.useDelayedTextureLoading=u.useDelayedTextureLoading&&!e.SceneLoader.ForceFullSceneLoadingForIncremental}if(u.autoClear!==undefined&&u.autoClear!==null){t.autoClear=u.autoClear}if(u.clearColor!==undefined&&u.clearColor!==null){t.clearColor=e.Color4.FromArray(u.clearColor)}if(u.ambientColor!==undefined&&u.ambientColor!==null){t.ambientColor=e.Color3.FromArray(u.ambientColor)}if(u.gravity!==undefined&&u.gravity!==null){t.gravity=e.Vector3.FromArray(u.gravity)}if(u.fogMode&&u.fogMode!==0){t.fogMode=u.fogMode;t.fogColor=e.Color3.FromArray(u.fogColor);t.fogStart=u.fogStart;t.fogEnd=u.fogEnd;t.fogDensity=u.fogDensity;a+="\tFog mode for scene:  ";switch(t.fogMode){case 1:a+="exp\n";break;case 2:a+="exp2\n";break;case 3:a+="linear\n";break}}if(u.physicsEnabled){var l;if(u.physicsEngine==="cannon"){l=new e.CannonJSPlugin}else if(u.physicsEngine==="oimo"){l=new e.OimoJSPlugin}a="\tPhysics engine "+(u.physicsEngine?u.physicsEngine:"oimo")+" enabled\n";var c=u.physicsGravity?e.Vector3.FromArray(u.physicsGravity):null;t.enablePhysics(c,l)}if(u.metadata!==undefined&&u.metadata!==null){t.metadata=u.metadata}if(u.collisionsEnabled!==undefined&&u.collisionsEnabled!==null){t.collisionsEnabled=u.collisionsEnabled}t.workerCollisions=!!u.workerCollisions;var h=n(t,i,o,s,true);if(!h){return false}if(u.autoAnimate){t.beginAnimation(t,u.autoAnimateFrom,u.autoAnimateTo,u.autoAnimateLoop,u.autoAnimateSpeed||1)}if(u.activeCameraID!==undefined&&u.activeCameraID!==null){t.setActiveCameraByID(u.activeCameraID)}if(u.environmentTexture!==undefined&&u.environmentTexture!==null){t.environmentTexture=e.CubeTexture.CreateFromPrefilteredData(o+u.environmentTexture,t);if(u.createDefaultSkybox===true){var f=t.activeCamera!==undefined&&t.activeCamera!==null?(t.activeCamera.maxZ-t.activeCamera.minZ)/2:1e3;var d=u.skyboxBlurLevel||0;t.createDefaultSkybox(undefined,true,f,d)}}return true}catch(t){var p=r("importScene",u?u.producer:"Unknown")+a;if(s){s(p,t)}else{e.Tools.Log(p);throw t}}finally{if(a!==null&&e.SceneLoader.loggingLevel!==e.SceneLoader.NO_LOGGING){e.Tools.Log(r("importScene",u?u.producer:"Unknown")+(e.SceneLoader.loggingLevel!==e.SceneLoader.MINIMAL_LOGGING?a:""))}}return false},loadAssetContainer:function(e,t,i,r){var o=n(e,t,i,r);return o}})})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,t,i,r,n,o,s,a,u){this.onProcessFileCallback=function(){return true};this._engine=e;this._currentScene=t;this._sceneLoadedCallback=i;this._progressCallback=r;this._additionalRenderLoopLogicCallback=n;this._textureLoadingCallback=o;this._startingProcessingFilesCallback=s;this._onReloadCallback=a;this._errorCallback=u}t.prototype.monitorElementForDragNDrop=function(e){var t=this;if(e){this._elementToMonitor=e;this._dragEnterHandler=function(e){t.drag(e)};this._dragOverHandler=function(e){t.drag(e)};this._dropHandler=function(e){t.drop(e)};this._elementToMonitor.addEventListener("dragenter",this._dragEnterHandler,false);this._elementToMonitor.addEventListener("dragover",this._dragOverHandler,false);this._elementToMonitor.addEventListener("drop",this._dropHandler,false)}};t.prototype.dispose=function(){if(!this._elementToMonitor){return}this._elementToMonitor.removeEventListener("dragenter",this._dragEnterHandler);this._elementToMonitor.removeEventListener("dragover",this._dragOverHandler);this._elementToMonitor.removeEventListener("drop",this._dropHandler)};t.prototype.renderFunction=function(){if(this._additionalRenderLoopLogicCallback){this._additionalRenderLoopLogicCallback()}if(this._currentScene){if(this._textureLoadingCallback){var e=this._currentScene.getWaitingItemsCount();if(e>0){this._textureLoadingCallback(e)}}this._currentScene.render()}};t.prototype.drag=function(e){e.stopPropagation();e.preventDefault()};t.prototype.drop=function(e){e.stopPropagation();e.preventDefault();this.loadFiles(e)};t.prototype._traverseFolder=function(e,t,i,r){var n=this;var o=e.createReader();var s=e.fullPath.replace(/^\//,"").replace(/(.+?)\/?$/,"$1/");o.readEntries(function(e){i.count+=e.length;for(var o=0,a=e;o<a.length;o++){var u=a[o];if(u.isFile){u.file(function(e){e.correctName=s+e.name;t.push(e);if(--i.count===0){r()}})}else if(u.isDirectory){n._traverseFolder(u,t,i,r)}}if(--i.count){r()}})};t.prototype._processFiles=function(e){for(var i=0;i<e.length;i++){var r=e[i].correctName.toLowerCase();var n=r.split(".").pop();if(!this.onProcessFileCallback(e[i],r,n)){continue}if((n==="babylon"||n==="stl"||n==="obj"||n==="gltf"||n==="glb")&&r.indexOf(".binary.babylon")===-1&&r.indexOf(".incremental.babylon")===-1){this._sceneFileToLoad=e[i]}else{t.FilesToLoad[r]=e[i]}}};t.prototype.loadFiles=function(e){var t=this;if(this._startingProcessingFilesCallback)this._startingProcessingFilesCallback();if(e&&e.dataTransfer&&e.dataTransfer.files){this._filesToLoad=e.dataTransfer.files}if(e&&e.target&&e.target.files){this._filesToLoad=e.target.files}if(this._filesToLoad&&this._filesToLoad.length>0){var i=new Array;var r=[];var n=e.dataTransfer?e.dataTransfer.items:null;for(var o=0;o<this._filesToLoad.length;o++){var s=this._filesToLoad[o];var a=s.name.toLowerCase();var u=void 0;s.correctName=a;if(n){var l=n[o];if(l.getAsEntry){u=l.getAsEntry()}else if(l.webkitGetAsEntry){u=l.webkitGetAsEntry()}}if(!u){i.push(s)}else{if(u.isDirectory){r.push(u)}else{i.push(s)}}}if(r.length===0){this._processFiles(i);this._processReload()}else{var c={count:r.length};for(var h=0,f=r;h<f.length;h++){var d=f[h];this._traverseFolder(d,i,c,function(){t._processFiles(i);if(c.count===0){t._processReload()}})}}}};t.prototype._processReload=function(){if(this._onReloadCallback){this._onReloadCallback(this._sceneFileToLoad)}else{this.reload()}};t.prototype.reload=function(){var t=this;if(this._sceneFileToLoad){if(this._currentScene){if(e.Tools.errorsCount>0){e.Tools.ClearLogCache()}this._engine.stopRenderLoop();this._currentScene.dispose()}e.SceneLoader.LoadAsync("file:",this._sceneFileToLoad,this._engine,function(e){if(t._progressCallback){t._progressCallback(e)}}).then(function(e){t._currentScene=e;if(t._sceneLoadedCallback){t._sceneLoadedCallback(t._sceneFileToLoad,t._currentScene)}t._currentScene.executeWhenReady(function(){t._engine.runRenderLoop(function(){t.renderFunction()})})}).catch(function(e){if(t._errorCallback){t._errorCallback(t._sceneFileToLoad,t._currentScene,e.message)}})}else{e.Tools.Error("Please provide a valid .babylon file.")}};t.FilesToLoad={};return t}();e.FilesInput=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this._count=0;this._data={}}e.prototype.copyFrom=function(e){var t=this;this.clear();e.forEach(function(e,i){return t.add(e,i)})};e.prototype.get=function(e){var t=this._data[e];if(t!==undefined){return t}return undefined};e.prototype.getOrAddWithFactory=function(e,t){var i=this.get(e);if(i!==undefined){return i}i=t(e);if(i){this.add(e,i)}return i};e.prototype.getOrAdd=function(e,t){var i=this.get(e);if(i!==undefined){return i}this.add(e,t);return t};e.prototype.contains=function(e){return this._data[e]!==undefined};e.prototype.add=function(e,t){if(this._data[e]!==undefined){return false}this._data[e]=t;++this._count;return true};e.prototype.set=function(e,t){if(this._data[e]===undefined){return false}this._data[e]=t;return true};e.prototype.getAndRemove=function(e){var t=this.get(e);if(t!==undefined){delete this._data[e];--this._count;return t}return null};e.prototype.remove=function(e){if(this.contains(e)){delete this._data[e];--this._count;return true}return false};e.prototype.clear=function(){this._data={};this._count=0};Object.defineProperty(e.prototype,"count",{get:function(){return this._count},enumerable:true,configurable:true});e.prototype.forEach=function(e){for(var t in this._data){var i=this._data[t];e(t,i)}};e.prototype.first=function(e){for(var t in this._data){var i=this._data[t];var r=e(t,i);if(r){return r}}return null};return e}();e.StringDictionary=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){}t.EnableFor=function(e){e._tags=e._tags||{};e.hasTags=function(){return t.HasTags(e)};e.addTags=function(i){return t.AddTagsTo(e,i)};e.removeTags=function(i){return t.RemoveTagsFrom(e,i)};e.matchesTagsQuery=function(i){return t.MatchesQuery(e,i)}};t.DisableFor=function(e){delete e._tags;delete e.hasTags;delete e.addTags;delete e.removeTags;delete e.matchesTagsQuery};t.HasTags=function(t){if(!t._tags){return false}return!e.Tools.IsEmpty(t._tags)};t.GetTags=function(e,t){if(t===void 0){t=true}if(!e._tags){return null}if(t){var i=[];for(var r in e._tags){if(e._tags.hasOwnProperty(r)&&e._tags[r]===true){i.push(r)}}return i.join(" ")}else{return e._tags}};t.AddTagsTo=function(e,i){if(!i){return}if(typeof i!=="string"){return}var r=i.split(" ");r.forEach(function(i,r,n){t._AddTagTo(e,i)})};t._AddTagTo=function(e,i){i=i.trim();if(i===""||i==="true"||i==="false"){return}if(i.match(/[\s]/)||i.match(/^([!]|([|]|[&]){2})/)){return}t.EnableFor(e);e._tags[i]=true};t.RemoveTagsFrom=function(e,i){if(!t.HasTags(e)){return}var r=i.split(" ");for(var n in r){t._RemoveTagFrom(e,r[n])}};t._RemoveTagFrom=function(e,t){delete e._tags[t]};t.MatchesQuery=function(i,r){if(r===undefined){return true}if(r===""){return t.HasTags(i)}return e.AndOrNotEvaluator.Eval(r,function(e){return t.HasTags(i)&&i._tags[e]})};return t}();e.Tags=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){}e.Eval=function(t,i){if(!t.match(/\([^\(\)]*\)/g)){t=e._HandleParenthesisContent(t,i)}else{t=t.replace(/\([^\(\)]*\)/g,function(t){t=t.slice(1,t.length-1);return e._HandleParenthesisContent(t,i)})}if(t==="true"){return true}if(t==="false"){return false}return e.Eval(t,i)};e._HandleParenthesisContent=function(t,i){i=i||function(e){return e==="true"?true:false};var r;var n=t.split("||");for(var o in n){if(n.hasOwnProperty(o)){var s=e._SimplifyNegation(n[o].trim());var a=s.split("&&");if(a.length>1){for(var u=0;u<a.length;++u){var l=e._SimplifyNegation(a[u].trim());if(l!=="true"&&l!=="false"){if(l[0]==="!"){r=!i(l.substring(1))}else{r=i(l)}}else{r=l==="true"?true:false}if(!r){s="false";break}}}if(r||s==="true"){r=true;break}if(s!=="true"&&s!=="false"){if(s[0]==="!"){r=!i(s.substring(1))}else{r=i(s)}}else{r=s==="true"?true:false}}}return r?"true":"false"};e._SimplifyNegation=function(e){e=e.replace(/^[\s!]+/,function(e){e=e.replace(/[\s]/g,function(){return""});return e.length%2?"!":""});e=e.trim();if(e==="!true"){e="false"}else if(e==="!false"){e="true"}return e};return e}();e.AndOrNotEvaluator=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,i){this.idbFactory=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;this.callbackManifestChecked=i;this.currentSceneUrl=t.ReturnFullUrlLocation(e);this.db=null;this._enableSceneOffline=false;this._enableTexturesOffline=false;this.manifestVersionFound=0;this.mustUpdateRessources=false;this.hasReachedQuota=false;if(!t.IDBStorageEnabled){this.callbackManifestChecked(true)}else{this.checkManifestFile()}}Object.defineProperty(t.prototype,"enableSceneOffline",{get:function(){return this._enableSceneOffline},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"enableTexturesOffline",{get:function(){return this._enableTexturesOffline},enumerable:true,configurable:true});t.prototype.checkManifestFile=function(){var t=this;var i=function(){t._enableSceneOffline=false;t._enableTexturesOffline=false;t.callbackManifestChecked(false)};var r=false;var n=this.currentSceneUrl+".manifest";var o=new XMLHttpRequest;if(navigator.onLine){r=true;n=n+(n.match(/\?/)==null?"?":"&")+(new Date).getTime()}o.open("GET",n,true);o.addEventListener("load",function(){if(o.status===200||e.Tools.ValidateXHRData(o,1)){try{var r=JSON.parse(o.response);t._enableSceneOffline=r.enableSceneOffline;t._enableTexturesOffline=r.enableTexturesOffline;if(r.version&&!isNaN(parseInt(r.version))){t.manifestVersionFound=r.version}if(t.callbackManifestChecked){t.callbackManifestChecked(true)}}catch(e){i()}}else{i()}},false);o.addEventListener("error",function(e){if(r){r=false;var n=t.currentSceneUrl+".manifest";o.open("GET",n,true);o.send()}else{i()}},false);try{o.send()}catch(t){e.Tools.Error("Error on XHR send request.");this.callbackManifestChecked(false)}};t.prototype.openAsync=function(t,i){var r=this;var n=function(){r.isSupported=false;if(i)i()};if(!this.idbFactory||!(this._enableSceneOffline||this._enableTexturesOffline)){this.isSupported=false;if(i)i()}else{if(!this.db){this.hasReachedQuota=false;this.isSupported=true;var o=this.idbFactory.open("babylonjs",1);o.onerror=function(e){n()};o.onblocked=function(t){e.Tools.Error("IDB request blocked. Please reload the page.");n()};o.onsuccess=function(e){r.db=o.result;t()};o.onupgradeneeded=function(t){r.db=t.target.result;if(r.db){try{r.db.createObjectStore("scenes",{keyPath:"sceneUrl"});r.db.createObjectStore("versions",{keyPath:"sceneUrl"});r.db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(t){e.Tools.Error("Error while creating object stores. Exception: "+t.message);n()}}}}else{if(t)t()}}};t.prototype.loadImageFromDB=function(e,i){var r=this;var n=t.ReturnFullUrlLocation(e);var o=function(){if(!r.hasReachedQuota&&r.db!==null){r._saveImageIntoDBAsync(n,i)}else{i.src=e}};if(!this.mustUpdateRessources){this._loadImageFromDBAsync(n,i,o)}else{o()}};t.prototype._loadImageFromDBAsync=function(t,i,r){if(this.isSupported&&this.db!==null){var n;var o=this.db.transaction(["textures"]);o.onabort=function(e){i.src=t};o.oncomplete=function(o){var s;if(n){var a=window.URL||window.webkitURL;s=a.createObjectURL(n.data,{oneTimeOnly:true});i.onerror=function(){e.Tools.Error("Error loading image from blob URL: "+s+" switching back to web url: "+t);i.src=t};i.src=s}else{r()}};var s=o.objectStore("textures").get(t);s.onsuccess=function(e){n=e.target.result};s.onerror=function(r){e.Tools.Error("Error loading texture "+t+" from DB.");i.src=t}}else{e.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open.");i.src=t}};t.prototype._saveImageIntoDBAsync=function(i,r){var n=this;if(this.isSupported){var o=function(){var e;if(a){var t=window.URL||window.webkitURL;try{e=t.createObjectURL(a,{oneTimeOnly:true})}catch(i){e=t.createObjectURL(a)}}if(e){r.src=e}};if(t.IsUASupportingBlobStorage){var s=new XMLHttpRequest,a;s.open("GET",i,true);s.responseType="blob";s.addEventListener("load",function(){if(s.status===200&&n.db){a=s.response;var e=n.db.transaction(["textures"],"readwrite");e.onabort=function(e){try{var t=e.srcElement||e.target;var i=t.error;if(i&&i.name==="QuotaExceededError"){n.hasReachedQuota=true}}catch(e){}o()};e.oncomplete=function(e){o()};var u={textureUrl:i,data:a};try{var l=e.objectStore("textures").put(u);l.onsuccess=function(e){};l.onerror=function(e){o()}}catch(e){if(e.code===25){t.IsUASupportingBlobStorage=false}r.src=i}}else{r.src=i}},false);s.addEventListener("error",function(t){e.Tools.Error("Error in XHR request in BABYLON.Database.");r.src=i},false);s.send()}else{r.src=i}}else{e.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open.");r.src=i}};t.prototype._checkVersionFromDB=function(e,t){var i=this;var r=function(){i._saveVersionIntoDBAsync(e,t)};this._loadVersionFromDBAsync(e,t,r)};t.prototype._loadVersionFromDBAsync=function(t,i,r){var n=this;if(this.isSupported&&this.db){var o;try{var s=this.db.transaction(["versions"]);s.oncomplete=function(e){if(o){if(n.manifestVersionFound>o.data){n.mustUpdateRessources=true;r()}else{i(o.data)}}else{n.mustUpdateRessources=true;r()}};s.onabort=function(e){i(-1)};var a=s.objectStore("versions").get(t);a.onsuccess=function(e){o=e.target.result};a.onerror=function(r){e.Tools.Error("Error loading version for scene "+t+" from DB.");i(-1)}}catch(t){e.Tools.Error("Error while accessing 'versions' object store (READ OP). Exception: "+t.message);i(-1)}}else{e.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open.");i(-1)}};t.prototype._saveVersionIntoDBAsync=function(t,i){var r=this;if(this.isSupported&&!this.hasReachedQuota&&this.db){try{var n=this.db.transaction(["versions"],"readwrite");n.onabort=function(e){try{var t=e.srcElement["error"];if(t&&t.name==="QuotaExceededError"){r.hasReachedQuota=true}}catch(e){}i(-1)};n.oncomplete=function(e){i(r.manifestVersionFound)};var o={sceneUrl:t,data:this.manifestVersionFound};var s=n.objectStore("versions").put(o);s.onsuccess=function(e){};s.onerror=function(t){e.Tools.Error("Error in DB add version request in BABYLON.Database.")}}catch(t){e.Tools.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+t.message);i(-1)}}else{i(-1)}};t.prototype.loadFileFromDB=function(e,i,r,n,o){var s=this;var a=t.ReturnFullUrlLocation(e);var u=function(){s._saveFileIntoDBAsync(a,i,r)};this._checkVersionFromDB(a,function(e){if(e!==-1){if(!s.mustUpdateRessources){s._loadFileFromDBAsync(a,i,u,o)}else{s._saveFileIntoDBAsync(a,i,r,o)}}else{if(n){n()}}})};t.prototype._loadFileFromDBAsync=function(t,i,r,n){if(this.isSupported&&this.db){var o;if(t.indexOf(".babylon")!==-1){o="scenes"}else{o="textures"}var s;var a=this.db.transaction([o]);a.oncomplete=function(e){if(s){i(s.data)}else{r()}};a.onabort=function(e){r()};var u=a.objectStore(o).get(t);u.onsuccess=function(e){s=e.target.result};u.onerror=function(i){e.Tools.Error("Error loading file "+t+" from DB.");r()}}else{e.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open.");i()}};t.prototype._saveFileIntoDBAsync=function(t,i,r,n){var o=this;if(this.isSupported){var s;if(t.indexOf(".babylon")!==-1){s="scenes"}else{s="textures"}var a=new XMLHttpRequest;var u;a.open("GET",t,true);if(n){a.responseType="arraybuffer"}if(r){a.onprogress=r}a.addEventListener("load",function(){if(a.status===200||e.Tools.ValidateXHRData(a,!n?1:6)){u=!n?a.responseText:a.response;if(!o.hasReachedQuota&&o.db){var r=o.db.transaction([s],"readwrite");r.onabort=function(e){try{var t=e.srcElement["error"];if(t&&t.name==="QuotaExceededError"){o.hasReachedQuota=true}}catch(e){}i(u)};r.oncomplete=function(e){i(u)};var l;if(s==="scenes"){l={sceneUrl:t,data:u,version:o.manifestVersionFound}}else{l={textureUrl:t,data:u}}try{var c=r.objectStore(s).put(l);c.onsuccess=function(e){};c.onerror=function(t){e.Tools.Error("Error in DB add file request in BABYLON.Database.")}}catch(e){i(u)}}else{i(u)}}else{i()}},false);a.addEventListener("error",function(t){e.Tools.Error("error on XHR request.");i()},false);a.send()}else{e.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open.");i()}};t.IsUASupportingBlobStorage=true;t.IDBStorageEnabled=true;t.parseURL=function(e){var t=document.createElement("a");t.href=e;var i=e.substring(0,e.lastIndexOf("#"));var r=e.substring(i.lastIndexOf("/")+1,e.length);var n=e.substring(0,e.indexOf(r,0));return n};t.ReturnFullUrlLocation=function(e){if(e.indexOf("http:/")===-1&&e.indexOf("https:/")===-1){return t.parseURL(window.location.href)+e}else{return e}};return t}();e.Database=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this._isEnabled=true;this.leftColor=e.Color3.White();this.rightColor=e.Color3.Black();this.bias=0;this.power=1}Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(t){if(this._isEnabled===t){return}this._isEnabled=t;e.Engine.MarkAllMaterialsAsDirty(e.Material.FresnelDirtyFlag|e.Material.MiscDirtyFlag)},enumerable:true,configurable:true});t.prototype.clone=function(){var i=new t;e.Tools.DeepCopy(this,i);return i};t.prototype.serialize=function(){var e={};e.isEnabled=this.isEnabled;e.leftColor=this.leftColor.asArray();e.rightColor=this.rightColor.asArray();e.bias=this.bias;e.power=this.power;return e};t.Parse=function(i){var r=new t;r.isEnabled=i.isEnabled;r.leftColor=e.Color3.FromArray(i.leftColor);r.rightColor=e.Color3.FromArray(i.rightColor);r.bias=i.bias;r.power=i.power||1;return r};return t}();e.FresnelParameters=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(e,i){var r=t.call(this,e,i,true)||this;i.multiMaterials.push(r);r.subMaterials=new Array;r.storeEffectOnSubMeshes=true;return r}Object.defineProperty(i.prototype,"subMaterials",{get:function(){return this._subMaterials},set:function(e){this._subMaterials=e;this._hookArray(e)},enumerable:true,configurable:true});i.prototype._hookArray=function(e){var t=this;var i=e.push;e.push=function(){var r=[];for(var n=0;n<arguments.length;n++){r[n]=arguments[n]}var o=i.apply(e,r);t._markAllSubMeshesAsTexturesDirty();return o};var r=e.splice;e.splice=function(i,n){var o=r.apply(e,[i,n]);t._markAllSubMeshesAsTexturesDirty();return o}};i.prototype.getSubMaterial=function(e){if(e<0||e>=this.subMaterials.length){return this.getScene().defaultMaterial}return this.subMaterials[e]};i.prototype.getActiveTextures=function(){return(e=t.prototype.getActiveTextures.call(this)).concat.apply(e,this.subMaterials.map(function(e){if(e){return e.getActiveTextures()}else{return[]}}));var e};i.prototype.getClassName=function(){return"MultiMaterial"};i.prototype.isReadyForSubMesh=function(e,t,i){for(var r=0;r<this.subMaterials.length;r++){var n=this.subMaterials[r];if(n){if(n.storeEffectOnSubMeshes){if(!n.isReadyForSubMesh(e,t,i)){return false}continue}if(!n.isReady(e)){return false}}}return true};i.prototype.clone=function(e,t){var r=new i(e,this.getScene());for(var n=0;n<this.subMaterials.length;n++){var o=null;var s=this.subMaterials[n];if(t&&s){o=s.clone(e+"-"+s.name)}else{o=this.subMaterials[n]}r.subMaterials.push(o)}return r};i.prototype.serialize=function(){var t={};t.name=this.name;t.id=this.id;if(e.Tags){t.tags=e.Tags.GetTags(this)}t.materials=[];for(var i=0;i<this.subMaterials.length;i++){var r=this.subMaterials[i];if(r){t.materials.push(r.id)}else{t.materials.push(null)}}return t};i.prototype.dispose=function(e,i){var r=this.getScene();if(!r){return}var n=r.multiMaterials.indexOf(this);if(n>=0){r.multiMaterials.splice(n,1)}t.prototype.dispose.call(this,e,i)};return i}(e.Material);e.MultiMaterial=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this._offsetX=null;this._offsetY=null;this._pointerPressed=new Array;this.touchAngularSensibility=2e5;this.touchMoveSensibility=250}t.prototype.attachControl=function(t,i){var r=this;var n=null;if(this._pointerInput===undefined){this._onLostFocus=function(e){r._offsetX=null;r._offsetY=null};this._pointerInput=function(t,o){var s=t.event;if(s.pointerType==="mouse"){return}if(t.type===e.PointerEventTypes.POINTERDOWN){if(!i){s.preventDefault()}r._pointerPressed.push(s.pointerId);if(r._pointerPressed.length!==1){return}n={x:s.clientX,y:s.clientY}}else if(t.type===e.PointerEventTypes.POINTERUP){if(!i){s.preventDefault()}var a=r._pointerPressed.indexOf(s.pointerId);if(a===-1){return}r._pointerPressed.splice(a,1);if(a!=0){return}n=null;r._offsetX=null;r._offsetY=null}else if(t.type===e.PointerEventTypes.POINTERMOVE){if(!i){s.preventDefault()}if(!n){return}var a=r._pointerPressed.indexOf(s.pointerId);if(a!=0){return}r._offsetX=s.clientX-n.x;r._offsetY=-(s.clientY-n.y)}}}this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,e.PointerEventTypes.POINTERDOWN|e.PointerEventTypes.POINTERUP|e.PointerEventTypes.POINTERMOVE);if(this._onLostFocus){t.addEventListener("blur",this._onLostFocus)}};t.prototype.detachControl=function(e){if(this._pointerInput&&e){if(this._observer){this.camera.getScene().onPointerObservable.remove(this._observer);this._observer=null}if(this._onLostFocus){e.removeEventListener("blur",this._onLostFocus);this._onLostFocus=null}this._pointerPressed=[];this._offsetX=null;this._offsetY=null}};t.prototype.checkInputs=function(){if(this._offsetX&&this._offsetY){var t=this.camera;t.cameraRotation.y+=this._offsetX/this.touchAngularSensibility;if(this._pointerPressed.length>1){t.cameraRotation.x+=-this._offsetY/this.touchAngularSensibility}else{var i=t._computeLocalCameraSpeed();var r=new e.Vector3(0,0,i*this._offsetY/this.touchMoveSensibility);e.Matrix.RotationYawPitchRollToRef(t.rotation.y,t.rotation.x,0,t._cameraRotationMatrix);t.cameraDirection.addInPlace(e.Vector3.TransformCoordinates(r,t._cameraRotationMatrix))}}};t.prototype.getClassName=function(){return"FreeCameraTouchInput"};t.prototype.getSimpleName=function(){return"touch"};__decorate([e.serialize()],t.prototype,"touchAngularSensibility",void 0);__decorate([e.serialize()],t.prototype,"touchMoveSensibility",void 0);return t}();e.FreeCameraTouchInput=t;e.CameraInputTypes["FreeCameraTouchInput"]=t})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(t,i,r){var n=e.call(this,t,i,r)||this;n.inputs.addTouch();n._setupInputs();return n}Object.defineProperty(t.prototype,"touchAngularSensibility",{get:function(){var e=this.inputs.attached["touch"];if(e)return e.touchAngularSensibility;return 0},set:function(e){var t=this.inputs.attached["touch"];if(t)t.touchAngularSensibility=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"touchMoveSensibility",{get:function(){var e=this.inputs.attached["touch"];if(e)return e.touchMoveSensibility;return 0},set:function(e){var t=this.inputs.attached["touch"];if(t)t.touchMoveSensibility=e},enumerable:true,configurable:true});t.prototype.getClassName=function(){return"TouchCamera"};t.prototype._setupInputs=function(){var e=this.inputs.attached["mouse"];if(e){e.touchEnabled=false}};return t}(e.FreeCamera);e.TouchCamera=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u){if(s===void 0){s=null}if(a===void 0){a=true}if(u===void 0){u=false}var l=t.call(this,null,o,!a)||this;l.isCube=u;l.isEnabled=true;l._currentRefreshId=-1;l._refreshRate=1;l._vertexBuffers={};l._uniforms=new Array;l._samplers=new Array;l._textures={};l._floats={};l._floatsArrays={};l._colors3={};l._colors4={};l._vectors2={};l._vectors3={};l._matrices={};l._fallbackTextureUsed=false;o.proceduralTextures.push(l);l._engine=o.getEngine();l.name=i;l.isRenderTarget=true;l._size=r;l._generateMipMaps=a;l.setFragment(n);l._fallbackTexture=s;if(u){l._texture=l._engine.createRenderTargetCubeTexture(r,{generateMipMaps:a});l.setFloat("face",0)}else{l._texture=l._engine.createRenderTargetTexture(r,a)}var c=[];c.push(1,1);c.push(-1,1);c.push(-1,-1);c.push(1,-1);l._vertexBuffers[e.VertexBuffer.PositionKind]=new e.VertexBuffer(l._engine,c,e.VertexBuffer.PositionKind,false,false,2);l._createIndexBuffer();return l}i.prototype._createIndexBuffer=function(){var e=this._engine;var t=[];t.push(0);t.push(1);t.push(2);t.push(0);t.push(2);t.push(3);this._indexBuffer=e.createIndexBuffer(t)};i.prototype._rebuild=function(){var t=this._vertexBuffers[e.VertexBuffer.PositionKind];if(t){t._rebuild()}this._createIndexBuffer();if(this.refreshRate===e.RenderTargetTexture.REFRESHRATE_RENDER_ONCE){this.refreshRate=e.RenderTargetTexture.REFRESHRATE_RENDER_ONCE}};i.prototype.reset=function(){if(this._effect===undefined){return}var e=this._engine;e._releaseEffect(this._effect)};i.prototype.isReady=function(){var t=this;var i=this._engine;var r;if(!this._fragment){return false}if(this._fallbackTextureUsed){return true}if(this._fragment.fragmentElement!==undefined){r={vertex:"procedural",fragmentElement:this._fragment.fragmentElement}}else{r={vertex:"procedural",fragment:this._fragment}}this._effect=i.createEffect(r,[e.VertexBuffer.PositionKind],this._uniforms,this._samplers,"",undefined,undefined,function(){t.releaseInternalTexture();if(t._fallbackTexture){t._texture=t._fallbackTexture._texture;if(t._texture){t._texture.incrementReferences()}}t._fallbackTextureUsed=true});return this._effect.isReady()};i.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1};i.prototype.setFragment=function(e){this._fragment=e};Object.defineProperty(i.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(e){this._refreshRate=e;this.resetRefreshCounter()},enumerable:true,configurable:true});i.prototype._shouldRender=function(){if(!this.isEnabled||!this.isReady()||!this._texture){return false}if(this._fallbackTextureUsed){return false}if(this._currentRefreshId===-1){this._currentRefreshId=1;return true}if(this.refreshRate===this._currentRefreshId){this._currentRefreshId=1;return true}this._currentRefreshId++;return false};i.prototype.getRenderSize=function(){return this._size};i.prototype.resize=function(e,t){if(this._fallbackTextureUsed){return}this.releaseInternalTexture();this._texture=this._engine.createRenderTargetTexture(e,t)};i.prototype._checkUniform=function(e){if(this._uniforms.indexOf(e)===-1){this._uniforms.push(e)}};i.prototype.setTexture=function(e,t){if(this._samplers.indexOf(e)===-1){this._samplers.push(e)}this._textures[e]=t;return this};i.prototype.setFloat=function(e,t){this._checkUniform(e);this._floats[e]=t;return this};i.prototype.setFloats=function(e,t){this._checkUniform(e);this._floatsArrays[e]=t;return this};i.prototype.setColor3=function(e,t){this._checkUniform(e);this._colors3[e]=t;return this};i.prototype.setColor4=function(e,t){this._checkUniform(e);this._colors4[e]=t;return this};i.prototype.setVector2=function(e,t){this._checkUniform(e);this._vectors2[e]=t;return this};i.prototype.setVector3=function(e,t){this._checkUniform(e);this._vectors3[e]=t;return this};i.prototype.setMatrix=function(e,t){this._checkUniform(e);this._matrices[e]=t;return this};i.prototype.render=function(t){var i=this.getScene();if(!i){return}var r=this._engine;r.enableEffect(this._effect);r.setState(false);for(var n in this._textures){this._effect.setTexture(n,this._textures[n])}for(n in this._floats){this._effect.setFloat(n,this._floats[n])}for(n in this._floatsArrays){this._effect.setArray(n,this._floatsArrays[n])}for(n in this._colors3){this._effect.setColor3(n,this._colors3[n])}for(n in this._colors4){var o=this._colors4[n];this._effect.setFloat4(n,o.r,o.g,o.b,o.a)}for(n in this._vectors2){this._effect.setVector2(n,this._vectors2[n])}for(n in this._vectors3){this._effect.setVector3(n,this._vectors3[n])}for(n in this._matrices){this._effect.setMatrix(n,this._matrices[n])}if(!this._texture){return}if(this.isCube){for(var s=0;s<6;s++){r.bindFramebuffer(this._texture,s,undefined,undefined,true);r.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect);this._effect.setFloat("face",s);r.clear(i.clearColor,true,true,true);r.drawElementsType(e.Material.TriangleFillMode,0,6);if(s===5){r.generateMipMapsForCubemap(this._texture)}}}else{r.bindFramebuffer(this._texture,0,undefined,undefined,true);r.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect);r.clear(i.clearColor,true,true,true);r.drawElementsType(e.Material.TriangleFillMode,0,6)}r.unBindFramebuffer(this._texture,this.isCube);if(this.onGenerated){this.onGenerated()}};i.prototype.clone=function(){var e=this.getSize();var t=new i(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);t.hasAlpha=this.hasAlpha;t.level=this.level;t.coordinatesMode=this.coordinatesMode;return t};i.prototype.dispose=function(){var i=this.getScene();if(!i){return}var r=i.proceduralTextures.indexOf(this);if(r>=0){i.proceduralTextures.splice(r,1)}var n=this._vertexBuffers[e.VertexBuffer.PositionKind];if(n){n.dispose();this._vertexBuffers[e.VertexBuffer.PositionKind]=null}if(this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer)){this._indexBuffer=null}t.prototype.dispose.call(this)};return i}(e.Texture);e.ProceduralTexture=t})(r||(r={}));"use strict";var r;(function(e){
var t=function(t){__extends(i,t);function i(e,i,r,n,o,s){var a=t.call(this,e,r,null,n,o,s)||this;a._animate=true;a._time=0;a._texturePath=i;a.loadJson(i);a.refreshRate=1;return a}i.prototype.loadJson=function(t){var i=this;var r=function(){e.Tools.Log("No config file found in "+t+" trying to use ShadersStore or DOM element");try{i.setFragment(i._texturePath)}catch(t){e.Tools.Error("No json or ShaderStore or DOM element found for CustomProceduralTexture")}};var n=t+"/config.json";var o=new XMLHttpRequest;o.open("GET",n,true);o.addEventListener("load",function(){if(o.status===200||e.Tools.ValidateXHRData(o,1)){try{i._config=JSON.parse(o.response);i.updateShaderUniforms();i.updateTextures();i.setFragment(i._texturePath+"/custom");i._animate=i._config.animate;i.refreshRate=i._config.refreshrate}catch(e){r()}}else{r()}},false);o.addEventListener("error",function(){r()},false);try{o.send()}catch(t){e.Tools.Error("CustomProceduralTexture: Error on XHR send request.")}};i.prototype.isReady=function(){if(!t.prototype.isReady.call(this)){return false}for(var e in this._textures){var i=this._textures[e];if(!i.isReady()){return false}}return true};i.prototype.render=function(e){var i=this.getScene();if(this._animate&&i){this._time+=i.getAnimationRatio()*.03;this.updateShaderUniforms()}t.prototype.render.call(this,e)};i.prototype.updateTextures=function(){for(var t=0;t<this._config.sampler2Ds.length;t++){this.setTexture(this._config.sampler2Ds[t].sample2Dname,new e.Texture(this._texturePath+"/"+this._config.sampler2Ds[t].textureRelativeUrl,this.getScene()))}};i.prototype.updateShaderUniforms=function(){if(this._config){for(var t=0;t<this._config.uniforms.length;t++){var i=this._config.uniforms[t];switch(i.type){case"float":this.setFloat(i.name,i.value);break;case"color3":this.setColor3(i.name,new e.Color3(i.r,i.g,i.b));break;case"color4":this.setColor4(i.name,new e.Color4(i.r,i.g,i.b,i.a));break;case"vector2":this.setVector2(i.name,new e.Vector2(i.x,i.y));break;case"vector3":this.setVector3(i.name,new e.Vector3(i.x,i.y,i.z));break}}}this.setFloat("time",this._time)};Object.defineProperty(i.prototype,"animate",{get:function(){return this._animate},set:function(e){this._animate=e},enumerable:true,configurable:true});return i}(e.ProceduralTexture);e.CustomProceduralTexture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this.gamepadAngularSensibility=200;this.gamepadMoveSensibility=40;this._cameraTransform=e.Matrix.Identity();this._deltaTransform=e.Vector3.Zero();this._vector3=e.Vector3.Zero();this._vector2=e.Vector2.Zero()}t.prototype.attachControl=function(t,i){var r=this;var n=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=n.onGamepadConnectedObservable.add(function(t){if(t.type!==e.Gamepad.POSE_ENABLED){if(!r.gamepad||t.type===e.Gamepad.XBOX){r.gamepad=t}}});this._onGamepadDisconnectedObserver=n.onGamepadDisconnectedObservable.add(function(e){if(r.gamepad===e){r.gamepad=null}});this.gamepad=n.getGamepadByType(e.Gamepad.XBOX)};t.prototype.detachControl=function(e){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver);this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver);this.gamepad=null};t.prototype.checkInputs=function(){if(this.gamepad&&this.gamepad.leftStick){var t=this.camera;var i=this.gamepad.leftStick;var r=i.x/this.gamepadMoveSensibility;var n=i.y/this.gamepadMoveSensibility;i.x=Math.abs(r)>.005?0+r:0;i.y=Math.abs(n)>.005?0+n:0;var o=this.gamepad.rightStick;if(o){var s=o.x/this.gamepadAngularSensibility;var a=o.y/this.gamepadAngularSensibility;o.x=Math.abs(s)>.001?0+s:0;o.y=Math.abs(a)>.001?0+a:0}else{o={x:0,y:0}}if(!t.rotationQuaternion){e.Matrix.RotationYawPitchRollToRef(t.rotation.y,t.rotation.x,0,this._cameraTransform)}else{t.rotationQuaternion.toRotationMatrix(this._cameraTransform)}var u=t._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(i.x*u,0,-i.y*u);e.Vector3.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform);t.cameraDirection.addInPlace(this._deltaTransform);this._vector2.copyFromFloats(o.y,o.x);t.cameraRotation.addInPlace(this._vector2)}};t.prototype.getClassName=function(){return"FreeCameraGamepadInput"};t.prototype.getSimpleName=function(){return"gamepad"};__decorate([e.serialize()],t.prototype,"gamepadAngularSensibility",void 0);__decorate([e.serialize()],t.prototype,"gamepadMoveSensibility",void 0);return t}();e.FreeCameraGamepadInput=t;e.CameraInputTypes["FreeCameraGamepadInput"]=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this.gamepadRotationSensibility=80;this.gamepadMoveSensibility=40}t.prototype.attachControl=function(t,i){var r=this;var n=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=n.onGamepadConnectedObservable.add(function(t){if(t.type!==e.Gamepad.POSE_ENABLED){if(!r.gamepad||t.type===e.Gamepad.XBOX){r.gamepad=t}}});this._onGamepadDisconnectedObserver=n.onGamepadDisconnectedObservable.add(function(e){if(r.gamepad===e){r.gamepad=null}});this.gamepad=n.getGamepadByType(e.Gamepad.XBOX)};t.prototype.detachControl=function(e){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver);this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver);this.gamepad=null};t.prototype.checkInputs=function(){if(this.gamepad){var e=this.camera;var t=this.gamepad.rightStick;if(t){if(t.x!=0){var i=t.x/this.gamepadRotationSensibility;if(i!=0&&Math.abs(i)>.005){e.inertialAlphaOffset+=i}}if(t.y!=0){var r=t.y/this.gamepadRotationSensibility;if(r!=0&&Math.abs(r)>.005){e.inertialBetaOffset+=r}}}var n=this.gamepad.leftStick;if(n&&n.y!=0){var o=n.y/this.gamepadMoveSensibility;if(o!=0&&Math.abs(o)>.005){this.camera.inertialRadiusOffset-=o}}}};t.prototype.getClassName=function(){return"ArcRotateCameraGamepadInput"};t.prototype.getSimpleName=function(){return"gamepad"};__decorate([e.serialize()],t.prototype,"gamepadRotationSensibility",void 0);__decorate([e.serialize()],t.prototype,"gamepadMoveSensibility",void 0);return t}();e.ArcRotateCameraGamepadInput=t;e.CameraInputTypes["ArcRotateCameraGamepadInput"]=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t){var i=this;this._scene=t;this._babylonGamepads=[];this._oneGamepadConnected=false;this._isMonitoring=false;this.onGamepadDisconnectedObservable=new e.Observable;if(!e.Tools.IsWindowObjectExist()){this._gamepadEventSupported=false}else{this._gamepadEventSupported="GamepadEvent"in window;this._gamepadSupport=navigator.getGamepads||navigator.webkitGetGamepads||navigator.msGetGamepads||navigator.webkitGamepads}this.onGamepadConnectedObservable=new e.Observable(function(e){for(var t in i._babylonGamepads){var r=i._babylonGamepads[t];if(r&&r._isConnected){i.onGamepadConnectedObservable.notifyObserver(e,r)}}});this._onGamepadConnectedEvent=function(e){var t=e.gamepad;if(t.index in i._babylonGamepads){if(i._babylonGamepads[t.index].isConnected){return}}var r;if(i._babylonGamepads[t.index]){r=i._babylonGamepads[t.index];r.browserGamepad=t;r._isConnected=true}else{r=i._addNewGamepad(t)}i.onGamepadConnectedObservable.notifyObservers(r);i._startMonitoringGamepads()};this._onGamepadDisconnectedEvent=function(e){var t=e.gamepad;for(var r in i._babylonGamepads){if(i._babylonGamepads[r].index===t.index){var n=i._babylonGamepads[r];n._isConnected=false;i.onGamepadDisconnectedObservable.notifyObservers(n);break}}};if(this._gamepadSupport){this._updateGamepadObjects();if(this._babylonGamepads.length){this._startMonitoringGamepads()}if(this._gamepadEventSupported){window.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,false);window.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,false)}else{this._startMonitoringGamepads()}}}Object.defineProperty(t.prototype,"gamepads",{get:function(){return this._babylonGamepads},enumerable:true,configurable:true});t.prototype.getGamepadByType=function(t){if(t===void 0){t=e.Gamepad.XBOX}for(var i=0,r=this._babylonGamepads;i<r.length;i++){var n=r[i];if(n&&n.type===t){return n}}return null};t.prototype.dispose=function(){if(this._gamepadEventSupported){if(this._onGamepadConnectedEvent){window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent)}if(this._onGamepadDisconnectedEvent){window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent)}this._onGamepadConnectedEvent=null;this._onGamepadDisconnectedEvent=null}this._babylonGamepads.forEach(function(e){e.dispose()});this.onGamepadConnectedObservable.clear();this.onGamepadDisconnectedObservable.clear();this._oneGamepadConnected=false;this._stopMonitoringGamepads();this._babylonGamepads=[]};t.prototype._addNewGamepad=function(t){if(!this._oneGamepadConnected){this._oneGamepadConnected=true}var i;var r=t.id.search("Xbox One")!==-1;if(r||t.id.search("Xbox 360")!==-1||t.id.search("xinput")!==-1){i=new e.Xbox360Pad(t.id,t.index,t,r)}else if(t.pose){i=e.PoseEnabledControllerHelper.InitiateController(t)}else{i=new e.GenericPad(t.id,t.index,t)}this._babylonGamepads[i.index]=i;return i};t.prototype._startMonitoringGamepads=function(){if(!this._isMonitoring){this._isMonitoring=true;if(!this._scene){this._checkGamepadsStatus()}}};t.prototype._stopMonitoringGamepads=function(){this._isMonitoring=false};t.prototype._checkGamepadsStatus=function(){var t=this;this._updateGamepadObjects();for(var i in this._babylonGamepads){var r=this._babylonGamepads[i];if(!r||!r.isConnected){continue}r.update()}if(this._isMonitoring&&!this._scene){e.Tools.QueueNewFrame(function(){t._checkGamepadsStatus()})}};t.prototype._updateGamepadObjects=function(){var e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(var t=0;t<e.length;t++){if(e[t]){if(!this._babylonGamepads[e[t].index]){var i=this._addNewGamepad(e[t]);this.onGamepadConnectedObservable.notifyObservers(i)}else{this._babylonGamepads[t].browserGamepad=e[t];if(!this._babylonGamepads[t].isConnected){this._babylonGamepads[t]._isConnected=true;this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t])}}}}};return t}();e.GamepadManager=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e,t){this.x=e;this.y=t}return e}();e.StickValues=t;var i=function(){function e(t,i,r,n,o,s,a){if(n===void 0){n=0}if(o===void 0){o=1}if(s===void 0){s=2}if(a===void 0){a=3}this.id=t;this.index=i;this.browserGamepad=r;this._isConnected=true;this._invertLeftStickY=false;this.type=e.GAMEPAD;this._leftStickAxisX=n;this._leftStickAxisY=o;this._rightStickAxisX=s;this._rightStickAxisY=a;if(this.browserGamepad.axes.length>=2){this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}}if(this.browserGamepad.axes.length>=4){this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]}}}Object.defineProperty(e.prototype,"isConnected",{get:function(){return this._isConnected},enumerable:true,configurable:true});e.prototype.onleftstickchanged=function(e){this._onleftstickchanged=e};e.prototype.onrightstickchanged=function(e){this._onrightstickchanged=e};Object.defineProperty(e.prototype,"leftStick",{get:function(){return this._leftStick},set:function(e){if(this._onleftstickchanged&&(this._leftStick.x!==e.x||this._leftStick.y!==e.y)){this._onleftstickchanged(e)}this._leftStick=e},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"rightStick",{get:function(){return this._rightStick},set:function(e){if(this._onrightstickchanged&&(this._rightStick.x!==e.x||this._rightStick.y!==e.y)){this._onrightstickchanged(e)}this._rightStick=e},enumerable:true,configurable:true});e.prototype.update=function(){if(this._leftStick){this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]};if(this._invertLeftStickY){this.leftStick.y*=-1}}if(this._rightStick){this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]}}};e.prototype.dispose=function(){};e.GAMEPAD=0;e.GENERIC=1;e.XBOX=2;e.POSE_ENABLED=3;return e}();e.Gamepad=i;var r=function(t){__extends(r,t);function r(r,n,o){var s=t.call(this,r,n,o)||this;s.onButtonDownObservable=new e.Observable;s.onButtonUpObservable=new e.Observable;s.type=i.GENERIC;s._buttons=new Array(o.buttons.length);return s}r.prototype.onbuttondown=function(e){this._onbuttondown=e};r.prototype.onbuttonup=function(e){this._onbuttonup=e};r.prototype._setButtonValue=function(e,t,i){if(e!==t){if(e===1){if(this._onbuttondown){this._onbuttondown(i)}this.onButtonDownObservable.notifyObservers(i)}if(e===0){if(this._onbuttonup){this._onbuttonup(i)}this.onButtonUpObservable.notifyObservers(i)}}return e};r.prototype.update=function(){t.prototype.update.call(this);for(var e=0;e<this._buttons.length;e++){this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}};r.prototype.dispose=function(){t.prototype.dispose.call(this);this.onButtonDownObservable.clear();this.onButtonUpObservable.clear()};return r}(i);e.GenericPad=r})(r||(r={}));"use strict";var r;(function(e){var t;(function(e){e[e["A"]=0]="A";e[e["B"]=1]="B";e[e["X"]=2]="X";e[e["Y"]=3]="Y";e[e["Start"]=4]="Start";e[e["Back"]=5]="Back";e[e["LB"]=6]="LB";e[e["RB"]=7]="RB";e[e["LeftStick"]=8]="LeftStick";e[e["RightStick"]=9]="RightStick"})(t=e.Xbox360Button||(e.Xbox360Button={}));var i;(function(e){e[e["Up"]=0]="Up";e[e["Down"]=1]="Down";e[e["Left"]=2]="Left";e[e["Right"]=3]="Right"})(i=e.Xbox360Dpad||(e.Xbox360Dpad={}));var r=function(r){__extends(n,r);function n(t,i,n,o){if(o===void 0){o=false}var s=r.call(this,t,i,n,0,1,2,3)||this;s._leftTrigger=0;s._rightTrigger=0;s.onButtonDownObservable=new e.Observable;s.onButtonUpObservable=new e.Observable;s.onPadDownObservable=new e.Observable;s.onPadUpObservable=new e.Observable;s._buttonA=0;s._buttonB=0;s._buttonX=0;s._buttonY=0;s._buttonBack=0;s._buttonStart=0;s._buttonLB=0;s._buttonRB=0;s._buttonLeftStick=0;s._buttonRightStick=0;s._dPadUp=0;s._dPadDown=0;s._dPadLeft=0;s._dPadRight=0;s._isXboxOnePad=false;s.type=e.Gamepad.XBOX;s._isXboxOnePad=o;return s}n.prototype.onlefttriggerchanged=function(e){this._onlefttriggerchanged=e};n.prototype.onrighttriggerchanged=function(e){this._onrighttriggerchanged=e};Object.defineProperty(n.prototype,"leftTrigger",{get:function(){return this._leftTrigger},set:function(e){if(this._onlefttriggerchanged&&this._leftTrigger!==e){this._onlefttriggerchanged(e)}this._leftTrigger=e},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"rightTrigger",{get:function(){return this._rightTrigger},set:function(e){if(this._onrighttriggerchanged&&this._rightTrigger!==e){this._onrighttriggerchanged(e)}this._rightTrigger=e},enumerable:true,configurable:true});n.prototype.onbuttondown=function(e){this._onbuttondown=e};n.prototype.onbuttonup=function(e){this._onbuttonup=e};n.prototype.ondpaddown=function(e){this._ondpaddown=e};n.prototype.ondpadup=function(e){this._ondpadup=e};n.prototype._setButtonValue=function(e,t,i){if(e!==t){if(e===1){if(this._onbuttondown){this._onbuttondown(i)}this.onButtonDownObservable.notifyObservers(i)}if(e===0){if(this._onbuttonup){this._onbuttonup(i)}this.onButtonUpObservable.notifyObservers(i)}}return e};n.prototype._setDPadValue=function(e,t,i){if(e!==t){if(e===1){if(this._ondpaddown){this._ondpaddown(i)}this.onPadDownObservable.notifyObservers(i)}if(e===0){if(this._ondpadup){this._ondpadup(i)}this.onPadUpObservable.notifyObservers(i)}}return e};Object.defineProperty(n.prototype,"buttonA",{get:function(){return this._buttonA},set:function(e){this._buttonA=this._setButtonValue(e,this._buttonA,t.A)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"buttonB",{get:function(){return this._buttonB},set:function(e){this._buttonB=this._setButtonValue(e,this._buttonB,t.B)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"buttonX",{get:function(){return this._buttonX},set:function(e){this._buttonX=this._setButtonValue(e,this._buttonX,t.X)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"buttonY",{get:function(){return this._buttonY},set:function(e){this._buttonY=this._setButtonValue(e,this._buttonY,t.Y)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"buttonStart",{get:function(){return this._buttonStart},set:function(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,t.Start)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"buttonBack",{get:function(){return this._buttonBack},set:function(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,t.Back)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"buttonLB",{get:function(){return this._buttonLB},set:function(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,t.LB)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"buttonRB",{get:function(){return this._buttonRB},set:function(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,t.RB)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"buttonLeftStick",{get:function(){return this._buttonLeftStick},set:function(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,t.LeftStick)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"buttonRightStick",{get:function(){return this._buttonRightStick},set:function(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,t.RightStick)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"dPadUp",{get:function(){return this._dPadUp},set:function(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,i.Up)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"dPadDown",{get:function(){return this._dPadDown},set:function(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,i.Down)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"dPadLeft",{get:function(){return this._dPadLeft},set:function(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,i.Left)},enumerable:true,configurable:true});Object.defineProperty(n.prototype,"dPadRight",{get:function(){return this._dPadRight},set:function(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,i.Right)},enumerable:true,configurable:true});n.prototype.update=function(){r.prototype.update.call(this);if(this._isXboxOnePad){this.buttonA=this.browserGamepad.buttons[0].value;this.buttonB=this.browserGamepad.buttons[1].value;this.buttonX=this.browserGamepad.buttons[2].value;this.buttonY=this.browserGamepad.buttons[3].value;this.buttonLB=this.browserGamepad.buttons[4].value;this.buttonRB=this.browserGamepad.buttons[5].value;this.leftTrigger=this.browserGamepad.axes[2];this.rightTrigger=this.browserGamepad.axes[5];this.buttonBack=this.browserGamepad.buttons[9].value;this.buttonStart=this.browserGamepad.buttons[8].value;this.buttonLeftStick=this.browserGamepad.buttons[6].value;this.buttonRightStick=this.browserGamepad.buttons[7].value;this.dPadUp=this.browserGamepad.buttons[11].value;this.dPadDown=this.browserGamepad.buttons[12].value;this.dPadLeft=this.browserGamepad.buttons[13].value;this.dPadRight=this.browserGamepad.buttons[14].value}else{this.buttonA=this.browserGamepad.buttons[0].value;this.buttonB=this.browserGamepad.buttons[1].value;this.buttonX=this.browserGamepad.buttons[2].value;this.buttonY=this.browserGamepad.buttons[3].value;this.buttonLB=this.browserGamepad.buttons[4].value;this.buttonRB=this.browserGamepad.buttons[5].value;this.leftTrigger=this.browserGamepad.buttons[6].value;this.rightTrigger=this.browserGamepad.buttons[7].value;this.buttonBack=this.browserGamepad.buttons[8].value;this.buttonStart=this.browserGamepad.buttons[9].value;this.buttonLeftStick=this.browserGamepad.buttons[10].value;this.buttonRightStick=this.browserGamepad.buttons[11].value;this.dPadUp=this.browserGamepad.buttons[12].value;this.dPadDown=this.browserGamepad.buttons[13].value;this.dPadLeft=this.browserGamepad.buttons[14].value;this.dPadRight=this.browserGamepad.buttons[15].value}};n.prototype.dispose=function(){r.prototype.dispose.call(this);this.onButtonDownObservable.clear();this.onButtonUpObservable.clear();this.onPadDownObservable.clear();this.onPadUpObservable.clear()};return n}(e.Gamepad);e.Xbox360Pad=r})(r||(r={}));"use strict";var r;(function(e){var t;(function(e){e[e["VIVE"]=0]="VIVE";e[e["OCULUS"]=1]="OCULUS";e[e["WINDOWS"]=2]="WINDOWS";e[e["GEAR_VR"]=3]="GEAR_VR";e[e["DAYDREAM"]=4]="DAYDREAM";e[e["GENERIC"]=5]="GENERIC"})(t=e.PoseEnabledControllerType||(e.PoseEnabledControllerType={}));var i=function(){function t(){}t.InitiateController=function(t){if(t.id.indexOf("Oculus Touch")!==-1){return new e.OculusTouchController(t)}else if(t.id.indexOf(e.WindowsMotionController.GAMEPAD_ID_PREFIX)===0){return new e.WindowsMotionController(t)}else if(t.id.toLowerCase().indexOf("openvr")!==-1){return new e.ViveController(t)}else if(t.id.indexOf(e.GearVRController.GAMEPAD_ID_PREFIX)===0){return new e.GearVRController(t)}else if(t.id.indexOf(e.DaydreamController.GAMEPAD_ID_PREFIX)===0){return new e.DaydreamController(t)}else{return new e.GenericController(t)}};return t}();e.PoseEnabledControllerHelper=i;var r=function(i){__extends(r,i);function r(r){var n=i.call(this,r.id,r.index,r)||this;n._deviceRoomPosition=e.Vector3.Zero();n._deviceRoomRotationQuaternion=new e.Quaternion;n.devicePosition=e.Vector3.Zero();n.deviceRotationQuaternion=new e.Quaternion;n.deviceScaleFactor=1;n._leftHandSystemQuaternion=new e.Quaternion;n._deviceToWorld=e.Matrix.Identity();n._pointingPoseNode=null;n._workingMatrix=e.Matrix.Identity();n.type=e.Gamepad.POSE_ENABLED;n.controllerType=t.GENERIC;n.position=e.Vector3.Zero();n.rotationQuaternion=new e.Quaternion;n._calculatedPosition=e.Vector3.Zero();n._calculatedRotation=new e.Quaternion;e.Quaternion.RotationYawPitchRollToRef(Math.PI,0,0,n._leftHandSystemQuaternion);return n}r.prototype.update=function(){i.prototype.update.call(this);var t=this.browserGamepad.pose;this.updateFromDevice(t);e.Vector3.TransformCoordinatesToRef(this._calculatedPosition,this._deviceToWorld,this.devicePosition);this._deviceToWorld.getRotationMatrixToRef(this._workingMatrix);e.Quaternion.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion);this.deviceRotationQuaternion.multiplyInPlace(this._calculatedRotation);if(this._mesh){this._mesh.position.copyFrom(this.devicePosition);if(this._mesh.rotationQuaternion){this._mesh.rotationQuaternion.copyFrom(this.deviceRotationQuaternion)}}};r.prototype.updateFromDevice=function(e){if(e){this.rawPose=e;if(e.position){this._deviceRoomPosition.copyFromFloats(e.position[0],e.position[1],-e.position[2]);if(this._mesh&&this._mesh.getScene().useRightHandedSystem){this._deviceRoomPosition.z*=-1}this._deviceRoomPosition.scaleToRef(this.deviceScaleFactor,this._calculatedPosition);this._calculatedPosition.addInPlace(this.position)}var t=this.rawPose;if(e.orientation&&t.orientation){this._deviceRoomRotationQuaternion.copyFromFloats(t.orientation[0],t.orientation[1],-t.orientation[2],-t.orientation[3]);if(this._mesh){if(this._mesh.getScene().useRightHandedSystem){this._deviceRoomRotationQuaternion.z*=-1;this._deviceRoomRotationQuaternion.w*=-1}else{this._deviceRoomRotationQuaternion.multiplyToRef(this._leftHandSystemQuaternion,this._deviceRoomRotationQuaternion)}}this._deviceRoomRotationQuaternion.multiplyToRef(this.rotationQuaternion,this._calculatedRotation)}}};r.prototype.attachToMesh=function(t){if(this._mesh){this._mesh.parent=null}this._mesh=t;if(this._poseControlledCamera){this._mesh.parent=this._poseControlledCamera}if(!this._mesh.rotationQuaternion){this._mesh.rotationQuaternion=new e.Quaternion}};r.prototype.attachToPoseControlledCamera=function(e){this._poseControlledCamera=e;if(this._mesh){this._mesh.parent=this._poseControlledCamera}};r.prototype.dispose=function(){if(this._mesh){this._mesh.dispose()}this._mesh=null;i.prototype.dispose.call(this)};Object.defineProperty(r.prototype,"mesh",{get:function(){return this._mesh},enumerable:true,configurable:true});r.prototype.getForwardRay=function(t){if(t===void 0){t=100}if(!this.mesh){return new e.Ray(e.Vector3.Zero(),new e.Vector3(0,0,1),t)}var i=this._pointingPoseNode?this._pointingPoseNode.getWorldMatrix():this.mesh.getWorldMatrix();var r=i.getTranslation();var n=new e.Vector3(0,0,-1);var o=e.Vector3.TransformNormal(n,i);var s=e.Vector3.Normalize(o);return new e.Ray(r,s,t)};r.POINTING_POSE="POINTING_POSE";return r}(e.Gamepad);e.PoseEnabledController=r})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i){var r=t.call(this,i)||this;r.onTriggerStateChangedObservable=new e.Observable;r.onMainButtonStateChangedObservable=new e.Observable;r.onSecondaryButtonStateChangedObservable=new e.Observable;r.onPadStateChangedObservable=new e.Observable;r.onPadValuesChangedObservable=new e.Observable;r.pad={x:0,y:0};r._changes={pressChanged:false,touchChanged:false,valueChanged:false,changed:false};r._buttons=new Array(i.buttons.length);r.hand=i.hand;return r}i.prototype.onButtonStateChange=function(e){this._onButtonStateChange=e};Object.defineProperty(i.prototype,"defaultModel",{get:function(){return this._defaultModel},enumerable:true,configurable:true});i.prototype.update=function(){t.prototype.update.call(this);for(var e=0;e<this._buttons.length;e++){this._setButtonValue(this.browserGamepad.buttons[e],this._buttons[e],e)}if(this.leftStick.x!==this.pad.x||this.leftStick.y!==this.pad.y){this.pad.x=this.leftStick.x;this.pad.y=this.leftStick.y;this.onPadValuesChangedObservable.notifyObservers(this.pad)}};i.prototype._setButtonValue=function(e,t,i){if(!e){e={pressed:false,touched:false,value:0}}if(!t){this._buttons[i]={pressed:e.pressed,touched:e.touched,value:e.value};return}this._checkChanges(e,t);if(this._changes.changed){this._onButtonStateChange&&this._onButtonStateChange(this.index,i,e);this._handleButtonChange(i,e,this._changes)}this._buttons[i].pressed=e.pressed;this._buttons[i].touched=e.touched;this._buttons[i].value=e.value<1e-8?0:e.value};i.prototype._checkChanges=function(e,t){this._changes.pressChanged=e.pressed!==t.pressed;this._changes.touchChanged=e.touched!==t.touched;this._changes.valueChanged=e.value!==t.value;this._changes.changed=this._changes.pressChanged||this._changes.touchChanged||this._changes.valueChanged;return this._changes};i.prototype.dispose=function(){t.prototype.dispose.call(this);this.onTriggerStateChangedObservable.clear();this.onMainButtonStateChangedObservable.clear();this.onSecondaryButtonStateChangedObservable.clear();this.onPadStateChangedObservable.clear();this.onPadValuesChangedObservable.clear()};return i}(e.PoseEnabledController);e.WebVRController=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i){var r=t.call(this,i)||this;r.onSecondaryTriggerStateChangedObservable=new e.Observable;r.onThumbRestChangedObservable=new e.Observable;r.controllerType=e.PoseEnabledControllerType.OCULUS;return r}i.prototype.initControllerMesh=function(t,r){var n=this;var o;if(this.hand==="left"){o=i.MODEL_LEFT_FILENAME}else{o=i.MODEL_RIGHT_FILENAME}e.SceneLoader.ImportMesh("",i.MODEL_BASE_URL,o,t,function(e){n._defaultModel=e[1];n.attachToMesh(n._defaultModel);if(r){r(n._defaultModel)}})};Object.defineProperty(i.prototype,"onAButtonStateChangedObservable",{get:function(){if(this.hand==="right"){return this.onMainButtonStateChangedObservable}else{throw new Error("No A button on left hand")}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"onBButtonStateChangedObservable",{get:function(){if(this.hand==="right"){return this.onSecondaryButtonStateChangedObservable}else{throw new Error("No B button on left hand")}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"onXButtonStateChangedObservable",{get:function(){if(this.hand==="left"){return this.onMainButtonStateChangedObservable}else{throw new Error("No X button on right hand")}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"onYButtonStateChangedObservable",{get:function(){if(this.hand==="left"){return this.onSecondaryButtonStateChangedObservable}else{throw new Error("No Y button on right hand")}},enumerable:true,configurable:true});i.prototype._handleButtonChange=function(e,t,i){var r=t;var n=this.hand==="right"?-1:1;switch(e){case 0:this.onPadStateChangedObservable.notifyObservers(r);return;case 1:if(this._defaultModel){this._defaultModel.getChildren()[3].rotation.x=-r.value*.2;this._defaultModel.getChildren()[3].position.y=-r.value*.005;this._defaultModel.getChildren()[3].position.z=-r.value*.005}this.onTriggerStateChangedObservable.notifyObservers(r);return;case 2:if(this._defaultModel){this._defaultModel.getChildren()[4].position.x=n*r.value*.0035}this.onSecondaryTriggerStateChangedObservable.notifyObservers(r);return;case 3:if(this._defaultModel){if(r.pressed){this._defaultModel.getChildren()[1].position.y=-.001}else{this._defaultModel.getChildren()[1].position.y=0}}this.onMainButtonStateChangedObservable.notifyObservers(r);return;case 4:if(this._defaultModel){if(r.pressed){this._defaultModel.getChildren()[2].position.y=-.001}else{this._defaultModel.getChildren()[2].position.y=0}}this.onSecondaryButtonStateChangedObservable.notifyObservers(r);return;case 5:this.onThumbRestChangedObservable.notifyObservers(r);return}};i.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/";i.MODEL_LEFT_FILENAME="left.babylon";i.MODEL_RIGHT_FILENAME="right.babylon";return i}(e.WebVRController);e.OculusTouchController=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i){var r=t.call(this,i)||this;r.controllerType=e.PoseEnabledControllerType.VIVE;r._invertLeftStickY=true;return r}i.prototype.initControllerMesh=function(t,r){var n=this;e.SceneLoader.ImportMesh("",i.MODEL_BASE_URL,i.MODEL_FILENAME,t,function(e){n._defaultModel=e[1];n.attachToMesh(n._defaultModel);if(r){r(n._defaultModel)}})};Object.defineProperty(i.prototype,"onLeftButtonStateChangedObservable",{get:function(){return this.onMainButtonStateChangedObservable},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"onRightButtonStateChangedObservable",{get:function(){return this.onMainButtonStateChangedObservable},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"onMenuButtonStateChangedObservable",{get:function(){return this.onSecondaryButtonStateChangedObservable},enumerable:true,configurable:true});i.prototype._handleButtonChange=function(e,t,i){var r=t;switch(e){case 0:this.onPadStateChangedObservable.notifyObservers(r);return;case 1:if(this._defaultModel){this._defaultModel.getChildren()[6].rotation.x=-r.value*.15}this.onTriggerStateChangedObservable.notifyObservers(r);return;case 2:this.onMainButtonStateChangedObservable.notifyObservers(r);return;case 3:if(this._defaultModel){if(r.pressed){this._defaultModel.getChildren()[2].position.y=-.001}else{this._defaultModel.getChildren()[2].position.y=0}}this.onSecondaryButtonStateChangedObservable.notifyObservers(r);return}};i.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/";i.MODEL_FILENAME="wand.babylon";return i}(e.WebVRController);e.ViveController=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(e){return t.call(this,e)||this}i.prototype.initControllerMesh=function(t,r){var n=this;e.SceneLoader.ImportMesh("",i.MODEL_BASE_URL,i.MODEL_FILENAME,t,function(e){n._defaultModel=e[1];n.attachToMesh(n._defaultModel);if(r){r(n._defaultModel)}})};i.prototype._handleButtonChange=function(e,t,i){console.log("Button id: "+e+"state: ");console.dir(t)};i.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/"
;i.MODEL_FILENAME="generic.babylon";return i}(e.WebVRController);e.GenericController=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this.buttonMeshes={};this.axisMeshes={}}return e}();var i=function(i){__extends(r,i);function r(t){var r=i.call(this,t)||this;r._mapping={buttons:["thumbstick","trigger","grip","menu","trackpad"],buttonMeshNames:{trigger:"SELECT",menu:"MENU",grip:"GRASP",thumbstick:"THUMBSTICK_PRESS",trackpad:"TOUCHPAD_PRESS"},buttonObservableNames:{trigger:"onTriggerStateChangedObservable",menu:"onSecondaryButtonStateChangedObservable",grip:"onMainButtonStateChangedObservable",thumbstick:"onPadStateChangedObservable",trackpad:"onTrackpadChangedObservable"},axisMeshNames:["THUMBSTICK_X","THUMBSTICK_Y","TOUCHPAD_TOUCH_X","TOUCHPAD_TOUCH_Y"],pointingPoseMeshName:e.PoseEnabledController.POINTING_POSE};r.onTrackpadChangedObservable=new e.Observable;r.onTrackpadValuesChangedObservable=new e.Observable;r.trackpad={x:0,y:0};r.controllerType=e.PoseEnabledControllerType.WINDOWS;r._loadedMeshInfo=null;return r}Object.defineProperty(r.prototype,"onTriggerButtonStateChangedObservable",{get:function(){return this.onTriggerStateChangedObservable},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"onMenuButtonStateChangedObservable",{get:function(){return this.onSecondaryButtonStateChangedObservable},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"onGripButtonStateChangedObservable",{get:function(){return this.onMainButtonStateChangedObservable},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"onThumbstickButtonStateChangedObservable",{get:function(){return this.onPadStateChangedObservable},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"onTouchpadButtonStateChangedObservable",{get:function(){return this.onTrackpadChangedObservable},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"onTouchpadValuesChangedObservable",{get:function(){return this.onTrackpadValuesChangedObservable},enumerable:true,configurable:true});r.prototype.update=function(){i.prototype.update.call(this);if(this.browserGamepad.axes){if(this.browserGamepad.axes[2]!=this.trackpad.x||this.browserGamepad.axes[3]!=this.trackpad.y){this.trackpad.x=this.browserGamepad["axes"][2];this.trackpad.y=this.browserGamepad["axes"][3];this.onTrackpadValuesChangedObservable.notifyObservers(this.trackpad)}if(this._loadedMeshInfo){for(var e=0;e<this._mapping.axisMeshNames.length;e++){this._lerpAxisTransform(e,this.browserGamepad.axes[e])}}}};r.prototype._handleButtonChange=function(e,t,i){var r=this._mapping.buttons[e];if(!r){return}var n=this[this._mapping.buttonObservableNames[r]];if(n){n.notifyObservers(t)}this._lerpButtonTransform(r,t.value)};r.prototype._lerpButtonTransform=function(t,i){if(!this._loadedMeshInfo){return}var r=this._loadedMeshInfo.buttonMeshes[t];if(!r.unpressed.rotationQuaternion||!r.pressed.rotationQuaternion||!r.value.rotationQuaternion){return}e.Quaternion.SlerpToRef(r.unpressed.rotationQuaternion,r.pressed.rotationQuaternion,i,r.value.rotationQuaternion);e.Vector3.LerpToRef(r.unpressed.position,r.pressed.position,i,r.value.position)};r.prototype._lerpAxisTransform=function(t,i){if(!this._loadedMeshInfo){return}var r=this._loadedMeshInfo.axisMeshes[t];if(!r){return}if(!r.min.rotationQuaternion||!r.max.rotationQuaternion||!r.value.rotationQuaternion){return}var n=i*.5+.5;e.Quaternion.SlerpToRef(r.min.rotationQuaternion,r.max.rotationQuaternion,n,r.value.rotationQuaternion);e.Vector3.LerpToRef(r.min.position,r.max.position,n,r.value.position)};r.prototype.initControllerMesh=function(t,i,n){var o=this;if(n===void 0){n=false}var s;var a;if(e.SceneLoader.IsPluginForExtensionAvailable(".glb")){var u="default";if(this.id&&!n){var l=this.id.match(r.GAMEPAD_ID_PATTERN);u=l&&l[0]||u}if(this.hand==="left"){a=r.MODEL_LEFT_FILENAME}else{a=r.MODEL_RIGHT_FILENAME}s=r.MODEL_BASE_URL+u+"/"}else{e.Tools.Warn("You need to reference GLTF loader to load Windows Motion Controllers model. Falling back to generic models");s=e.GenericController.MODEL_BASE_URL;a=e.GenericController.MODEL_FILENAME}e.SceneLoader.ImportMesh("",s,a,t,function(e){o._loadedMeshInfo=o.processModel(t,e);if(!o._loadedMeshInfo){return}o._defaultModel=o._loadedMeshInfo.rootNode;o.attachToMesh(o._defaultModel);if(i){i(o._defaultModel)}},null,function(t,r){e.Tools.Log(r);e.Tools.Warn("Failed to retrieve controller model from the remote server: "+s+a);if(!n){o.initControllerMesh(t,i,true)}})};r.prototype.processModel=function(t,i){var r=null;var n=new e.Mesh(this.id+" "+this.hand,t);var o=null;for(var s=0;s<i.length;s++){var a=i[s];if(!a.parent){a.isPickable=false;o=a;break}}if(o){o.setParent(n);r=this.createMeshInfo(n)}else{e.Tools.Warn("Could not find root node in model file.")}return r};r.prototype.createMeshInfo=function(i){var r=new t;var n;r.rootNode=i;r.buttonMeshes={};r.axisMeshes={};for(n=0;n<this._mapping.buttons.length;n++){var o=this._mapping.buttonMeshNames[this._mapping.buttons[n]];if(!o){e.Tools.Log("Skipping unknown button at index: "+n+" with mapped name: "+this._mapping.buttons[n]);continue}var s=h(i,o);if(!s){e.Tools.Warn("Missing button mesh with name: "+o);continue}var a={index:n,value:f(s,"VALUE"),pressed:f(s,"PRESSED"),unpressed:f(s,"UNPRESSED")};if(a.value&&a.pressed&&a.unpressed){r.buttonMeshes[this._mapping.buttons[n]]=a}else{e.Tools.Warn("Missing button submesh under mesh with name: "+o+"(VALUE: "+!!a.value+", PRESSED: "+!!a.pressed+", UNPRESSED:"+!!a.unpressed+")")}}for(n=0;n<this._mapping.axisMeshNames.length;n++){var u=this._mapping.axisMeshNames[n];if(!u){e.Tools.Log("Skipping unknown axis at index: "+n);continue}var l=h(i,u);if(!l){e.Tools.Warn("Missing axis mesh with name: "+u);continue}var c={index:n,value:f(l,"VALUE"),min:f(l,"MIN"),max:f(l,"MAX")};if(c.value&&c.min&&c.max){r.axisMeshes[n]=c}else{e.Tools.Warn("Missing axis submesh under mesh with name: "+u+"(VALUE: "+!!c.value+", MIN: "+!!c.min+", MAX:"+!!c.max+")")}}r.pointingPoseNode=h(i,this._mapping.pointingPoseMeshName);if(!r.pointingPoseNode){e.Tools.Warn("Missing pointing pose mesh with name: "+this._mapping.pointingPoseMeshName)}return r;function h(e,t){return e.getChildMeshes(false,function(e){return e.name===t})[0]}function f(e,t){return e.getChildMeshes(true,function(e){return e.name==t})[0]}};r.prototype.getForwardRay=function(t){if(t===void 0){t=100}if(!(this._loadedMeshInfo&&this._loadedMeshInfo.pointingPoseNode)){return i.prototype.getForwardRay.call(this,t)}var r=this._loadedMeshInfo.pointingPoseNode.getWorldMatrix();var n=r.getTranslation();var o=new e.Vector3(0,0,-1);var s=e.Vector3.TransformNormal(o,r);var a=e.Vector3.Normalize(s);return new e.Ray(n,a,t)};r.prototype.dispose=function(){i.prototype.dispose.call(this);this.onTrackpadChangedObservable.clear()};r.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/";r.MODEL_LEFT_FILENAME="left.glb";r.MODEL_RIGHT_FILENAME="right.glb";r.GAMEPAD_ID_PREFIX="Spatial Controller (Spatial Interaction Source) ";r.GAMEPAD_ID_PATTERN=/([0-9a-zA-Z]+-[0-9a-zA-Z]+)$/;return r}(e.WebVRController);e.WindowsMotionController=i})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i){var r=t.call(this,i)||this;r._buttonIndexToObservableNameMap=["onTrackpadChangedObservable","onTriggerStateChangedObservable"];r.controllerType=e.PoseEnabledControllerType.GEAR_VR;return r}i.prototype.initControllerMesh=function(t,r){var n=this;e.SceneLoader.ImportMesh("",i.MODEL_BASE_URL,i.MODEL_FILENAME,t,function(e){n._defaultModel=e[1];n.attachToMesh(n._defaultModel);if(r){r(n._defaultModel)}})};i.prototype._handleButtonChange=function(e,t,i){if(e<this._buttonIndexToObservableNameMap.length){var r=this._buttonIndexToObservableNameMap[e];var n=this[r];if(n){n.notifyObservers(t)}}};i.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/";i.MODEL_FILENAME="generic.babylon";i.GAMEPAD_ID_PREFIX="Gear VR";return i}(e.WebVRController);e.GearVRController=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i){var r=t.call(this,i)||this;r.controllerType=e.PoseEnabledControllerType.DAYDREAM;return r}i.prototype.initControllerMesh=function(t,r){var n=this;e.SceneLoader.ImportMesh("",i.MODEL_BASE_URL,i.MODEL_FILENAME,t,function(e){n._defaultModel=e[1];n.attachToMesh(n._defaultModel);if(r){r(n._defaultModel)}})};i.prototype._handleButtonChange=function(t,i,r){if(t===0){var n=this.onTriggerStateChangedObservable;if(n){n.notifyObservers(i)}}else{e.Tools.Warn("Unrecognized Daydream button index: "+t)}};i.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/";i.MODEL_FILENAME="generic.babylon";i.GAMEPAD_ID_PREFIX="Daydream";return i}(e.WebVRController);e.DaydreamController=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(e,i,r,n){if(n===void 0){n=null}var o=t.call(this,e,i,r)||this;o.radius=12;o.rotationOffset=0;o.heightOffset=4;o.cameraAcceleration=.05;o.maxCameraSpeed=20;o.lockedTarget=n;return o}i.prototype.getRadians=function(e){return e*Math.PI/180};i.prototype.follow=function(t){if(!t)return;var i;if(t.rotationQuaternion){var r=new e.Matrix;t.rotationQuaternion.toRotationMatrix(r);i=Math.atan2(r.m[8],r.m[10])}else{i=t.rotation.y}var n=this.getRadians(this.rotationOffset)+i;var o=t.getAbsolutePosition();var s=o.x+Math.sin(n)*this.radius;var a=o.z+Math.cos(n)*this.radius;var u=s-this.position.x;var l=o.y+this.heightOffset-this.position.y;var c=a-this.position.z;var h=u*this.cameraAcceleration*2;var f=l*this.cameraAcceleration;var d=c*this.cameraAcceleration*2;if(h>this.maxCameraSpeed||h<-this.maxCameraSpeed){h=h<1?-this.maxCameraSpeed:this.maxCameraSpeed}if(f>this.maxCameraSpeed||f<-this.maxCameraSpeed){f=f<1?-this.maxCameraSpeed:this.maxCameraSpeed}if(d>this.maxCameraSpeed||d<-this.maxCameraSpeed){d=d<1?-this.maxCameraSpeed:this.maxCameraSpeed}this.position=new e.Vector3(this.position.x+h,this.position.y+f,this.position.z+d);this.setTarget(o)};i.prototype._checkInputs=function(){t.prototype._checkInputs.call(this);if(this.lockedTarget){this.follow(this.lockedTarget)}};i.prototype.getClassName=function(){return"FollowCamera"};__decorate([e.serialize()],i.prototype,"radius",void 0);__decorate([e.serialize()],i.prototype,"rotationOffset",void 0);__decorate([e.serialize()],i.prototype,"heightOffset",void 0);__decorate([e.serialize()],i.prototype,"cameraAcceleration",void 0);__decorate([e.serialize()],i.prototype,"maxCameraSpeed",void 0);__decorate([e.serializeAsMeshReference("lockedTargetId")],i.prototype,"lockedTarget",void 0);return i}(e.TargetCamera);e.FollowCamera=t;var i=function(t){__extends(i,t);function i(i,r,n,o,s,a){var u=t.call(this,i,e.Vector3.Zero(),a)||this;u.alpha=r;u.beta=n;u.radius=o;u.target=s;u._cartesianCoordinates=e.Vector3.Zero();u.follow();return u}i.prototype.follow=function(){if(!this.target){return}this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta);this._cartesianCoordinates.y=this.radius*Math.sin(this.beta);this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);var e=this.target.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates);this.setTarget(e)};i.prototype._checkInputs=function(){t.prototype._checkInputs.call(this);this.follow()};i.prototype.getClassName=function(){return"ArcFollowCamera"};return i}(e.TargetCamera);e.ArcFollowCamera=i})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(t,i,r){var n=e.call(this,t,i,r)||this;n.inputs.addGamepad();return n}Object.defineProperty(t.prototype,"gamepadAngularSensibility",{get:function(){var e=this.inputs.attached["gamepad"];if(e)return e.gamepadAngularSensibility;return 0},set:function(e){var t=this.inputs.attached["gamepad"];if(t)t.gamepadAngularSensibility=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"gamepadMoveSensibility",{get:function(){var e=this.inputs.attached["gamepad"];if(e)return e.gamepadMoveSensibility;return 0},set:function(e){var t=this.inputs.attached["gamepad"];if(t)t.gamepadMoveSensibility=e},enumerable:true,configurable:true});t.prototype.getClassName=function(){return"UniversalCamera"};return t}(e.TouchCamera);e.UniversalCamera=t})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(t,i,r){return e.call(this,t,i,r)||this}Object.defineProperty(t.prototype,"gamepadAngularSensibility",{get:function(){var e=this.inputs.attached["gamepad"];if(e)return e.gamepadAngularSensibility;return 0},set:function(e){var t=this.inputs.attached["gamepad"];if(t)t.gamepadAngularSensibility=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"gamepadMoveSensibility",{get:function(){var e=this.inputs.attached["gamepad"];if(e)return e.gamepadMoveSensibility;return 0},set:function(e){var t=this.inputs.attached["gamepad"];if(t)t.gamepadMoveSensibility=e},enumerable:true,configurable:true});t.prototype.getClassName=function(){return"GamepadCamera"};return t}(e.UniversalCamera);e.GamepadCamera=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this._renderPipelines={}}e.prototype.addPipeline=function(e){this._renderPipelines[e._name]=e};e.prototype.attachCamerasToRenderPipeline=function(e,t,i){if(i===void 0){i=false}var r=this._renderPipelines[e];if(!r){return}r._attachCameras(t,i)};e.prototype.detachCamerasFromRenderPipeline=function(e,t){var i=this._renderPipelines[e];if(!i){return}i._detachCameras(t)};e.prototype.enableEffectInPipeline=function(e,t,i){var r=this._renderPipelines[e];if(!r){return}r._enableEffect(t,i)};e.prototype.disableEffectInPipeline=function(e,t,i){var r=this._renderPipelines[e];if(!r){return}r._disableEffect(t,i)};e.prototype.update=function(){for(var e in this._renderPipelines){if(this._renderPipelines.hasOwnProperty(e)){var t=this._renderPipelines[e];if(!t.isSupported){t.dispose();delete this._renderPipelines[e]}else{t._update()}}}};e.prototype._rebuild=function(){for(var e in this._renderPipelines){if(this._renderPipelines.hasOwnProperty(e)){var t=this._renderPipelines[e];t._rebuild()}}};e.prototype.dispose=function(){for(var e in this._renderPipelines){if(this._renderPipelines.hasOwnProperty(e)){var t=this._renderPipelines[e];t.dispose()}}};return e}();e.PostProcessRenderPipelineManager=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,t,i,r){this._name=t;this._singleInstance=r||true;this._getPostProcesses=i;this._cameras={};this._indicesForCamera={};this._postProcesses={}}Object.defineProperty(t.prototype,"isSupported",{get:function(){for(var e in this._postProcesses){for(var t in this._postProcesses[e]){if(!this._postProcesses[e][t].isSupported){return false}}}return true},enumerable:true,configurable:true});t.prototype._update=function(){};t.prototype._attachCameras=function(t){var i=this;var r;var n=e.Tools.MakeArray(t||this._cameras);if(!n){return}for(var o=0;o<n.length;o++){var s=n[o];var a=s.name;if(this._singleInstance){r=0}else{r=a}if(!this._postProcesses[r]){var u=this._getPostProcesses();if(u){this._postProcesses[r]=Array.isArray(u)?u:[u]}}if(!this._indicesForCamera[a]){this._indicesForCamera[a]=[]}this._postProcesses[r].forEach(function(e){var t=s.attachPostProcess(e);i._indicesForCamera[a].push(t)});if(!this._cameras[a]){this._cameras[a]=s}}};t.prototype._detachCameras=function(t){var i=e.Tools.MakeArray(t||this._cameras);if(!i){return}for(var r=0;r<i.length;r++){var n=i[r];var o=n.name;this._postProcesses[this._singleInstance?0:o].forEach(function(e){n.detachPostProcess(e)});if(this._cameras[o]){this._cameras[o]=null}}};t.prototype._enable=function(t){var i=this;var r=e.Tools.MakeArray(t||this._cameras);if(!r){return}for(var n=0;n<r.length;n++){var o=r[n];var s=o.name;for(var a=0;a<this._indicesForCamera[s].length;a++){if(o._postProcesses[this._indicesForCamera[s][a]]===undefined||o._postProcesses[this._indicesForCamera[s][a]]===null){this._postProcesses[this._singleInstance?0:s].forEach(function(e){r[n].attachPostProcess(e,i._indicesForCamera[s][a])})}}}};t.prototype._disable=function(t){var i=e.Tools.MakeArray(t||this._cameras);if(!i){return}for(var r=0;r<i.length;r++){var n=i[r];var o=n.name;this._postProcesses[this._singleInstance?0:o].forEach(function(e){n.detachPostProcess(e)})}};t.prototype.getPostProcesses=function(e){if(this._singleInstance){return this._postProcesses[0]}else{if(!e){return null}return this._postProcesses[e.name]}};return t}();e.PostProcessRenderEffect=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,t){this.engine=e;this._name=t;this._renderEffects={};this._renderEffectsForIsolatedPass=new Array;this._cameras=[]}t.prototype.getClassName=function(){return"PostProcessRenderPipeline"};Object.defineProperty(t.prototype,"isSupported",{get:function(){for(var e in this._renderEffects){if(this._renderEffects.hasOwnProperty(e)){if(!this._renderEffects[e].isSupported){return false}}}return true},enumerable:true,configurable:true});t.prototype.addEffect=function(e){this._renderEffects[e._name]=e};t.prototype._rebuild=function(){};t.prototype._enableEffect=function(t,i){var r=this._renderEffects[t];if(!r){return}r._enable(e.Tools.MakeArray(i||this._cameras))};t.prototype._disableEffect=function(t,i){var r=this._renderEffects[t];if(!r){return}r._disable(e.Tools.MakeArray(i||this._cameras))};t.prototype._attachCameras=function(t,i){var r=e.Tools.MakeArray(t||this._cameras);if(!r){return}var n=[];var o;for(o=0;o<r.length;o++){var s=r[o];var a=s.name;if(this._cameras.indexOf(s)===-1){this._cameras[a]=s}else if(i){n.push(o)}}for(o=0;o<n.length;o++){t.splice(n[o],1)}for(var u in this._renderEffects){if(this._renderEffects.hasOwnProperty(u)){this._renderEffects[u]._attachCameras(r)}}};t.prototype._detachCameras=function(t){var i=e.Tools.MakeArray(t||this._cameras);if(!i){return}for(var r in this._renderEffects){if(this._renderEffects.hasOwnProperty(r)){this._renderEffects[r]._detachCameras(i)}}for(var n=0;n<i.length;n++){this._cameras.splice(this._cameras.indexOf(i[n]),1)}};t.prototype._update=function(){for(var e in this._renderEffects){if(this._renderEffects.hasOwnProperty(e)){this._renderEffects[e]._update()}}for(var t=0;t<this._cameras.length;t++){var i=this._cameras[t].name;if(this._renderEffectsForIsolatedPass[i]){this._renderEffectsForIsolatedPass[i]._update()}}};t.prototype._reset=function(){this._renderEffects={};this._renderEffectsForIsolatedPass=new Array};t.prototype._enableMSAAOnFirstPostProcess=function(e){var t=Object.keys(this._renderEffects);if(this.engine.webGLVersion>=2&&t.length>0){var i=this._renderEffects[t[0]].getPostProcesses();if(i){i[0].samples=e;return true}}return false};t.prototype.dispose=function(){};__decorate([e.serialize()],t.prototype,"_name",void 0);return t}();e.PostProcessRenderPipeline=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r){if(i===void 0){i=e.Engine.TEXTURETYPE_FLOAT}if(r===void 0){r=null}var n=this;this._scene=t;this._camera=r;var o=t.getEngine();this._depthMap=new e.RenderTargetTexture("depthMap",{width:o.getRenderWidth(),height:o.getRenderHeight()},this._scene,false,true,i);this._depthMap.wrapU=e.Texture.CLAMP_ADDRESSMODE;this._depthMap.wrapV=e.Texture.CLAMP_ADDRESSMODE;this._depthMap.refreshRate=1;this._depthMap.renderParticles=false;this._depthMap.renderList=null;this._depthMap.activeCamera=this._camera;this._depthMap.ignoreCameraViewport=true;this._depthMap.useCameraPostProcesses=false;this._depthMap.onClearObservable.add(function(t){t.clear(new e.Color4(1,1,1,1),true,true,true)});var s=function(t){var i=t.getRenderingMesh();var r=n._scene;var o=r.getEngine();var s=t.getMaterial();if(!s){return}o.setState(s.backFaceCulling,0,false,r.useRightHandedSystem);var a=i._getInstancesRenderList(t._id);if(a.mustReturn){return}var u=o.getCaps().instancedArrays&&a.visibleInstances[t._id]!==null;var l=n._camera||r.activeCamera;if(n.isReady(t,u)&&l){o.enableEffect(n._effect);i._bind(t,n._effect,e.Material.TriangleFillMode);n._effect.setMatrix("viewProjection",r.getTransformMatrix());n._effect.setFloat2("depthValues",l.minZ,l.minZ+l.maxZ);if(s&&s.needAlphaTesting()){var c=s.getAlphaTestTexture();if(c){n._effect.setTexture("diffuseSampler",c);n._effect.setMatrix("diffuseMatrix",c.getTextureMatrix())}}if(i.useBones&&i.computeBonesUsingShaders&&i.skeleton){n._effect.setMatrices("mBones",i.skeleton.getTransformMatrices(i))}i._processRendering(t,n._effect,e.Material.TriangleFillMode,a,u,function(e,t){return n._effect.setMatrix("world",t)})}};this._depthMap.customRenderFunction=function(e,t,i,r){var n;if(r.length){o.setColorWrite(false);for(n=0;n<r.length;n++){s(r.data[n])}o.setColorWrite(true)}for(n=0;n<e.length;n++){s(e.data[n])}for(n=0;n<t.length;n++){s(t.data[n])}}}t.prototype.isReady=function(t,i){var r=t.getMaterial();if(r.disableDepthWrite){return false}var n=[];var o=[e.VertexBuffer.PositionKind];var s=t.getMesh();if(r&&r.needAlphaTesting()&&r.getAlphaTestTexture()){n.push("#define ALPHATEST");if(s.isVerticesDataPresent(e.VertexBuffer.UVKind)){o.push(e.VertexBuffer.UVKind);n.push("#define UV1")}if(s.isVerticesDataPresent(e.VertexBuffer.UV2Kind)){o.push(e.VertexBuffer.UV2Kind);n.push("#define UV2")}}if(s.useBones&&s.computeBonesUsingShaders){o.push(e.VertexBuffer.MatricesIndicesKind);o.push(e.VertexBuffer.MatricesWeightsKind);if(s.numBoneInfluencers>4){o.push(e.VertexBuffer.MatricesIndicesExtraKind);o.push(e.VertexBuffer.MatricesWeightsExtraKind)}n.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers);n.push("#define BonesPerMesh "+(s.skeleton?s.skeleton.bones.length+1:0))}else{n.push("#define NUM_BONE_INFLUENCERS 0")}if(i){n.push("#define INSTANCES");o.push("world0");o.push("world1");o.push("world2");o.push("world3")}var a=n.join("\n");if(this._cachedDefines!==a){this._cachedDefines=a;this._effect=this._scene.getEngine().createEffect("depth",o,["world","mBones","viewProjection","diffuseMatrix","depthValues"],["diffuseSampler"],a)}return this._effect.isReady()};t.prototype.getDepthMap=function(){return this._depthMap};t.prototype.dispose=function(){this._depthMap.dispose()};return t}();e.DepthRenderer=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o){var s=t.call(this,r.getEngine(),i)||this;s.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect";s.SSAORenderEffect="SSAORenderEffect";s.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect";s.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect";s.SSAOCombineRenderEffect="SSAOCombineRenderEffect";s.totalStrength=1;s.radius=1e-4;s.area=.0075;s.fallOff=1e-6;s.base=.5;s._firstUpdate=true;s._scene=r;s._createRandomTexture();s._depthTexture=r.enableDepthRenderer().getDepthMap();var a=n.ssaoRatio||n;var u=n.combineRatio||n;s._originalColorPostProcess=new e.PassPostProcess("SSAOOriginalSceneColor",u,null,e.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),false);s._createSSAOPostProcess(a);s._createBlurPostProcess(a);s._createSSAOCombinePostProcess(u);s.addEffect(new e.PostProcessRenderEffect(r.getEngine(),s.SSAOOriginalSceneColorEffect,function(){return s._originalColorPostProcess},true));s.addEffect(new e.PostProcessRenderEffect(r.getEngine(),s.SSAORenderEffect,function(){return s._ssaoPostProcess},true));s.addEffect(new e.PostProcessRenderEffect(r.getEngine(),s.SSAOBlurHRenderEffect,function(){return s._blurHPostProcess},true));s.addEffect(new e.PostProcessRenderEffect(r.getEngine(),s.SSAOBlurVRenderEffect,function(){return s._blurVPostProcess},true));s.addEffect(new e.PostProcessRenderEffect(r.getEngine(),s.SSAOCombineRenderEffect,function(){return s._ssaoCombinePostProcess},true));r.postProcessRenderPipelineManager.addPipeline(s);if(o)r.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(i,o);return s}i.prototype.dispose=function(e){if(e===void 0){e=false}for(var i=0;i<this._scene.cameras.length;i++){var r=this._scene.cameras[i];this._originalColorPostProcess.dispose(r);this._ssaoPostProcess.dispose(r);this._blurHPostProcess.dispose(r);this._blurVPostProcess.dispose(r);this._ssaoCombinePostProcess.dispose(r)}this._randomTexture.dispose();if(e)this._scene.disableDepthRenderer();this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras);t.prototype.dispose.call(this)};i.prototype._createBlurPostProcess=function(t){var i=this;var r=16;this._blurHPostProcess=new e.BlurPostProcess("BlurH",new e.Vector2(1,0),r,t,null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,e.Engine.TEXTURETYPE_UNSIGNED_INT);this._blurVPostProcess=new e.BlurPostProcess("BlurV",new e.Vector2(0,1),r,t,null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,e.Engine.TEXTURETYPE_UNSIGNED_INT);this._blurHPostProcess.onActivateObservable.add(function(){var e=i._blurHPostProcess.width/i._scene.getEngine().getRenderWidth();i._blurHPostProcess.kernel=r*e});this._blurVPostProcess.onActivateObservable.add(function(){var e=i._blurVPostProcess.height/i._scene.getEngine().getRenderHeight();i._blurVPostProcess.kernel=r*e})};i.prototype._rebuild=function(){this._firstUpdate=true;t.prototype._rebuild.call(this)};i.prototype._createSSAOPostProcess=function(t){var i=this;var r=16;var n=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];var o=1/r;this._ssaoPostProcess=new e.PostProcess("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],t,null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,"#define SAMPLES "+r+"\n#define SSAO");this._ssaoPostProcess.onApply=function(e){if(i._firstUpdate){e.setArray3("sampleSphere",n);e.setFloat("samplesFactor",o);e.setFloat("randTextureTiles",4)}e.setFloat("totalStrength",i.totalStrength);e.setFloat("radius",i.radius);e.setFloat("area",i.area);e.setFloat("fallOff",i.fallOff);e.setFloat("base",i.base);e.setTexture("textureSampler",i._depthTexture);e.setTexture("randomSampler",i._randomTexture)}};i.prototype._createSSAOCombinePostProcess=function(t){var i=this;this._ssaoCombinePostProcess=new e.PostProcess("ssaoCombine","ssaoCombine",[],["originalColor"],t,null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false);this._ssaoCombinePostProcess.onApply=function(e){e.setTextureFromPostProcess("originalColor",i._originalColorPostProcess)}};i.prototype._createRandomTexture=function(){var t=512;this._randomTexture=new e.DynamicTexture("SSAORandomTexture",t,this._scene,false,e.Texture.TRILINEAR_SAMPLINGMODE);this._randomTexture.wrapU=e.Texture.WRAP_ADDRESSMODE;this._randomTexture.wrapV=e.Texture.WRAP_ADDRESSMODE;var i=this._randomTexture.getContext();var r=function(e,t){return Math.random()*(t-e)+e};var n=e.Vector3.Zero();for(var o=0;o<t;o++){for(var s=0;s<t;s++){n.x=Math.floor(r(-1,1)*255);n.y=Math.floor(r(-1,1)*255);n.z=Math.floor(r(-1,1)*255);i.fillStyle="rgb("+n.x+", "+n.y+", "+n.z+")";i.fillRect(o,s,1,1)}}this._randomTexture.update(false)};__decorate([e.serialize()],i.prototype,"totalStrength",void 0);__decorate([e.serialize()],i.prototype,"radius",void 0);__decorate([e.serialize()],i.prototype,"area",void 0);__decorate([e.serialize()],i.prototype,"fallOff",void 0);__decorate([e.serialize()],i.prototype,"base",void 0);return i}(e.PostProcessRenderPipeline);e.SSAORenderingPipeline=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o){var s=t.call(this,r.getEngine(),i)||this;s.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect";s.SSAORenderEffect="SSAORenderEffect";s.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect";s.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect";s.SSAOCombineRenderEffect="SSAOCombineRenderEffect";s.totalStrength=1;s.maxZ=100;s.minZAspect=.2;s._samples=8;s._expensiveBlur=true;s.radius=2;s.base=.1;s._firstUpdate=true;s._scene=r;if(!s.isSupported){e.Tools.Error("SSAO 2 needs WebGL 2 support.");return s}var a=n.ssaoRatio||n;var u=n.blurRatio||n;var l=r.enableGeometryBufferRenderer();s._createRandomTexture();s._depthTexture=l.getGBuffer().textures[0];s._normalTexture=l.getGBuffer().textures[1];s._originalColorPostProcess=new e.PassPostProcess("SSAOOriginalSceneColor",1,null,e.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),false);s._createSSAOPostProcess(1);s._createBlurPostProcess(a,u);s._createSSAOCombinePostProcess(u);s.addEffect(new e.PostProcessRenderEffect(r.getEngine(),s.SSAOOriginalSceneColorEffect,function(){return s._originalColorPostProcess},true));s.addEffect(new e.PostProcessRenderEffect(r.getEngine(),s.SSAORenderEffect,function(){return s._ssaoPostProcess},true));s.addEffect(new e.PostProcessRenderEffect(r.getEngine(),s.SSAOBlurHRenderEffect,function(){return s._blurHPostProcess},true));s.addEffect(new e.PostProcessRenderEffect(r.getEngine(),s.SSAOBlurVRenderEffect,function(){return s._blurVPostProcess},true));s.addEffect(new e.PostProcessRenderEffect(r.getEngine(),s.SSAOCombineRenderEffect,function(){return s._ssaoCombinePostProcess},true));r.postProcessRenderPipelineManager.addPipeline(s);if(o)r.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(i,o);return s}Object.defineProperty(i.prototype,"samples",{get:function(){return this._samples},set:function(e){this._ssaoPostProcess.updateEffect("#define SAMPLES "+e+"\n#define SSAO");this._samples=e;this._sampleSphere=this._generateHemisphere();this._firstUpdate=true},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"expensiveBlur",{get:function(){return this._expensiveBlur},set:function(e){this._blurHPostProcess.updateEffect("#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16\n#define EXPENSIVE "+(e?"1":"0")+"\n",null,["textureSampler","depthSampler"]);this._blurVPostProcess.updateEffect("#define BILATERAL_BLUR\n#define SAMPLES 16\n#define EXPENSIVE "+(e?"1":"0")+"\n",null,["textureSampler","depthSampler"]);this._expensiveBlur=e;this._firstUpdate=true},enumerable:true,configurable:true});Object.defineProperty(i,"IsSupported",{get:function(){var t=e.Engine.LastCreatedEngine;if(!t){return false}return t.getCaps().drawBuffersExtension},enumerable:true,configurable:true});i.prototype.dispose=function(e){if(e===void 0){e=false}for(var i=0;i<this._scene.cameras.length;i++){var r=this._scene.cameras[i];this._originalColorPostProcess.dispose(r);this._ssaoPostProcess.dispose(r);this._blurHPostProcess.dispose(r);this._blurVPostProcess.dispose(r);this._ssaoCombinePostProcess.dispose(r)}this._randomTexture.dispose();if(e)this._scene.disableGeometryBufferRenderer();this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras);t.prototype.dispose.call(this)};i.prototype._createBlurPostProcess=function(t,i){var r=this;this._samplerOffsets=[];var n=this.expensiveBlur;for(var o=-8;o<8;o++){this._samplerOffsets.push(o*2+.5)}this._blurHPostProcess=new e.PostProcess("BlurH","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],t,null,e.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16\n#define EXPENSIVE "+(n?"1":"0")+"\n");this._blurHPostProcess.onApply=function(e){if(!r._scene.activeCamera){return}e.setFloat("outSize",r._ssaoCombinePostProcess.width>0?r._ssaoCombinePostProcess.width:r._originalColorPostProcess.width);e.setFloat("near",r._scene.activeCamera.minZ);e.setFloat("far",r._scene.activeCamera.maxZ);e.setFloat("radius",r.radius);e.setTexture("depthSampler",r._depthTexture);if(r._firstUpdate){e.setArray("samplerOffsets",r._samplerOffsets)}}
;this._blurVPostProcess=new e.PostProcess("BlurV","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],i,null,e.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_V\n#define SAMPLES 16\n#define EXPENSIVE "+(n?"1":"0")+"\n");this._blurVPostProcess.onApply=function(e){if(!r._scene.activeCamera){return}e.setFloat("outSize",r._ssaoCombinePostProcess.height>0?r._ssaoCombinePostProcess.height:r._originalColorPostProcess.height);e.setFloat("near",r._scene.activeCamera.minZ);e.setFloat("far",r._scene.activeCamera.maxZ);e.setFloat("radius",r.radius);e.setTexture("depthSampler",r._depthTexture);if(r._firstUpdate){e.setArray("samplerOffsets",r._samplerOffsets);r._firstUpdate=false}}};i.prototype._rebuild=function(){this._firstUpdate=true;t.prototype._rebuild.call(this)};i.prototype._generateHemisphere=function(){var t=this.samples;var i=[];var r,n;var o=function(e,t){return Math.random()*(t-e)+e};var s=0;while(s<t){r=new e.Vector3(o(-1,1),o(-1,1),o(.3,1));r.normalize();n=s/t;n=e.Scalar.Lerp(.1,1,n*n);r.scaleInPlace(n);i.push(r.x,r.y,r.z);s++}return i};i.prototype._createSSAOPostProcess=function(t){var i=this;var r=this.samples;this._sampleSphere=this._generateHemisphere();this._ssaoPostProcess=new e.PostProcess("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","far","texelSize","xViewport","yViewport","maxZ","minZAspect"],["randomSampler","normalSampler"],t,null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,"#define SAMPLES "+r+"\n#define SSAO");this._ssaoPostProcess.onApply=function(e){if(i._firstUpdate){e.setArray3("sampleSphere",i._sampleSphere);e.setFloat("randTextureTiles",4)}if(!i._scene.activeCamera){return}e.setFloat("samplesFactor",1/i.samples);e.setFloat("totalStrength",i.totalStrength);e.setFloat2("texelSize",1/i._ssaoPostProcess.width,1/i._ssaoPostProcess.height);e.setFloat("radius",i.radius);e.setFloat("maxZ",i.maxZ);e.setFloat("minZAspect",i.minZAspect);e.setFloat("base",i.base);e.setFloat("near",i._scene.activeCamera.minZ);e.setFloat("far",i._scene.activeCamera.maxZ);e.setFloat("xViewport",Math.tan(i._scene.activeCamera.fov/2)*i._scene.getEngine().getAspectRatio(i._scene.activeCamera,true));e.setFloat("yViewport",Math.tan(i._scene.activeCamera.fov/2));e.setMatrix("projection",i._scene.getProjectionMatrix());e.setTexture("textureSampler",i._depthTexture);e.setTexture("normalSampler",i._normalTexture);e.setTexture("randomSampler",i._randomTexture)}};i.prototype._createSSAOCombinePostProcess=function(t){var i=this;this._ssaoCombinePostProcess=new e.PostProcess("ssaoCombine","ssaoCombine",[],["originalColor"],t,null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false);this._ssaoCombinePostProcess.onApply=function(e){e.setTextureFromPostProcess("originalColor",i._originalColorPostProcess)}};i.prototype._createRandomTexture=function(){var t=512;this._randomTexture=new e.DynamicTexture("SSAORandomTexture",t,this._scene,false,e.Texture.TRILINEAR_SAMPLINGMODE);this._randomTexture.wrapU=e.Texture.WRAP_ADDRESSMODE;this._randomTexture.wrapV=e.Texture.WRAP_ADDRESSMODE;var i=this._randomTexture.getContext();var r=function(e,t){return Math.random()*(t-e)+e};var n=e.Vector3.Zero();for(var o=0;o<t;o++){for(var s=0;s<t;s++){n.x=r(0,1);n.y=r(0,1);n.z=0;n.normalize();n.scaleInPlace(255);n.x=Math.floor(n.x);n.y=Math.floor(n.y);i.fillStyle="rgb("+n.x+", "+n.y+", "+n.z+")";i.fillRect(o,s,1,1)}}this._randomTexture.update(false)};__decorate([e.serialize()],i.prototype,"totalStrength",void 0);__decorate([e.serialize()],i.prototype,"maxZ",void 0);__decorate([e.serialize()],i.prototype,"minZAspect",void 0);__decorate([e.serialize("samples")],i.prototype,"_samples",void 0);__decorate([e.serialize("expensiveBlur")],i.prototype,"_expensiveBlur",void 0);__decorate([e.serialize()],i.prototype,"radius",void 0);__decorate([e.serialize()],i.prototype,"base",void 0);return i}(e.PostProcessRenderPipeline);e.SSAO2RenderingPipeline=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s){if(o===void 0){o=1}var a=t.call(this,n.getEngine(),i)||this;a.LensChromaticAberrationEffect="LensChromaticAberrationEffect";a.HighlightsEnhancingEffect="HighlightsEnhancingEffect";a.LensDepthOfFieldEffect="LensDepthOfFieldEffect";a._scene=n;a._depthTexture=n.enableDepthRenderer().getDepthMap();if(r.grain_texture){a._grainTexture=r.grain_texture}else{a._createGrainTexture()}a._edgeBlur=r.edge_blur?r.edge_blur:0;a._grainAmount=r.grain_amount?r.grain_amount:0;a._chromaticAberration=r.chromatic_aberration?r.chromatic_aberration:0;a._distortion=r.distortion?r.distortion:0;a._highlightsGain=r.dof_gain!==undefined?r.dof_gain:-1;a._highlightsThreshold=r.dof_threshold?r.dof_threshold:1;a._dofDistance=r.dof_focus_distance!==undefined?r.dof_focus_distance:-1;a._dofAperture=r.dof_aperture?r.dof_aperture:1;a._dofDarken=r.dof_darken?r.dof_darken:0;a._dofPentagon=r.dof_pentagon!==undefined?r.dof_pentagon:true;a._blurNoise=r.blur_noise!==undefined?r.blur_noise:true;a._createChromaticAberrationPostProcess(o);a._createHighlightsPostProcess(o);a._createDepthOfFieldPostProcess(o/4);a.addEffect(new e.PostProcessRenderEffect(n.getEngine(),a.LensChromaticAberrationEffect,function(){return a._chromaticAberrationPostProcess},true));a.addEffect(new e.PostProcessRenderEffect(n.getEngine(),a.HighlightsEnhancingEffect,function(){return a._highlightsPostProcess},true));a.addEffect(new e.PostProcessRenderEffect(n.getEngine(),a.LensDepthOfFieldEffect,function(){return a._depthOfFieldPostProcess},true));if(a._highlightsGain===-1){a._disableEffect(a.HighlightsEnhancingEffect,null)}n.postProcessRenderPipelineManager.addPipeline(a);if(s){n.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(i,s)}return a}i.prototype.setEdgeBlur=function(e){this._edgeBlur=e};i.prototype.disableEdgeBlur=function(){this._edgeBlur=0};i.prototype.setGrainAmount=function(e){this._grainAmount=e};i.prototype.disableGrain=function(){this._grainAmount=0};i.prototype.setChromaticAberration=function(e){this._chromaticAberration=e};i.prototype.disableChromaticAberration=function(){this._chromaticAberration=0};i.prototype.setEdgeDistortion=function(e){this._distortion=e};i.prototype.disableEdgeDistortion=function(){this._distortion=0};i.prototype.setFocusDistance=function(e){this._dofDistance=e};i.prototype.disableDepthOfField=function(){this._dofDistance=-1};i.prototype.setAperture=function(e){this._dofAperture=e};i.prototype.setDarkenOutOfFocus=function(e){this._dofDarken=e};i.prototype.enablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect("#define PENTAGON\n")};i.prototype.disablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect()};i.prototype.enableNoiseBlur=function(){this._blurNoise=true};i.prototype.disableNoiseBlur=function(){this._blurNoise=false};i.prototype.setHighlightsGain=function(e){this._highlightsGain=e};i.prototype.setHighlightsThreshold=function(e){if(this._highlightsGain===-1){this._highlightsGain=1}this._highlightsThreshold=e};i.prototype.disableHighlights=function(){this._highlightsGain=-1};i.prototype.dispose=function(e){if(e===void 0){e=false}this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras);this._chromaticAberrationPostProcess=null;this._highlightsPostProcess=null;this._depthOfFieldPostProcess=null;this._grainTexture.dispose();if(e)this._scene.disableDepthRenderer()};i.prototype._createChromaticAberrationPostProcess=function(t){var i=this;this._chromaticAberrationPostProcess=new e.PostProcess("LensChromaticAberration","chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],t,null,e.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),false);this._chromaticAberrationPostProcess.onApply=function(e){e.setFloat("chromatic_aberration",i._chromaticAberration);e.setFloat("screen_width",i._scene.getEngine().getRenderWidth());e.setFloat("screen_height",i._scene.getEngine().getRenderHeight());e.setFloat("radialIntensity",1);e.setFloat2("direction",17,17);e.setFloat2("centerPosition",.5,.5)}};i.prototype._createHighlightsPostProcess=function(t){var i=this;this._highlightsPostProcess=new e.PostProcess("LensHighlights","lensHighlights",["gain","threshold","screen_width","screen_height"],[],t,null,e.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,this._dofPentagon?"#define PENTAGON\n":"");this._highlightsPostProcess.onApply=function(e){e.setFloat("gain",i._highlightsGain);e.setFloat("threshold",i._highlightsThreshold);e.setTextureFromPostProcess("textureSampler",i._chromaticAberrationPostProcess);e.setFloat("screen_width",i._scene.getEngine().getRenderWidth());e.setFloat("screen_height",i._scene.getEngine().getRenderHeight())}};i.prototype._createDepthOfFieldPostProcess=function(t){var i=this;this._depthOfFieldPostProcess=new e.PostProcess("LensDepthOfField","depthOfField",["grain_amount","blur_noise","screen_width","screen_height","distortion","dof_enabled","screen_distance","aperture","darken","edge_blur","highlights","near","far"],["depthSampler","grainSampler","highlightsSampler"],t,null,e.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),false);this._depthOfFieldPostProcess.onApply=function(e){e.setTexture("depthSampler",i._depthTexture);e.setTexture("grainSampler",i._grainTexture);e.setTextureFromPostProcess("textureSampler",i._highlightsPostProcess);e.setTextureFromPostProcess("highlightsSampler",i._depthOfFieldPostProcess);e.setFloat("grain_amount",i._grainAmount);e.setBool("blur_noise",i._blurNoise);e.setFloat("screen_width",i._scene.getEngine().getRenderWidth());e.setFloat("screen_height",i._scene.getEngine().getRenderHeight());e.setFloat("distortion",i._distortion);e.setBool("dof_enabled",i._dofDistance!==-1);e.setFloat("screen_distance",1/(.1-1/i._dofDistance));e.setFloat("aperture",i._dofAperture);e.setFloat("darken",i._dofDarken);e.setFloat("edge_blur",i._edgeBlur);e.setBool("highlights",i._highlightsGain!==-1);if(i._scene.activeCamera){e.setFloat("near",i._scene.activeCamera.minZ);e.setFloat("far",i._scene.activeCamera.maxZ)}}};i.prototype._createGrainTexture=function(){var t=512;this._grainTexture=new e.DynamicTexture("LensNoiseTexture",t,this._scene,false,e.Texture.BILINEAR_SAMPLINGMODE);this._grainTexture.wrapU=e.Texture.WRAP_ADDRESSMODE;this._grainTexture.wrapV=e.Texture.WRAP_ADDRESSMODE;var i=this._grainTexture.getContext();var r=function(e,t){return Math.random()*(t-e)+e};var n;for(var o=0;o<t;o++){for(var s=0;s<t;s++){n=Math.floor(r(.42,.58)*255);i.fillStyle="rgb("+n+", "+n+", "+n+")";i.fillRect(o,s,1,1)}}this._grainTexture.update(false)};return i}(e.PostProcessRenderPipeline);e.LensRenderingPipeline=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s){if(o===void 0){o=null}var a=t.call(this,r.getEngine(),i)||this;a.downSampleX4PostProcess=null;a.brightPassPostProcess=null;a.blurHPostProcesses=[];a.blurVPostProcesses=[];a.textureAdderPostProcess=null;a.volumetricLightPostProcess=null;a.volumetricLightSmoothXPostProcess=null;a.volumetricLightSmoothYPostProcess=null;a.volumetricLightMergePostProces=null;a.volumetricLightFinalPostProcess=null;a.luminancePostProcess=null;a.luminanceDownSamplePostProcesses=[];a.hdrPostProcess=null;a.textureAdderFinalPostProcess=null;a.lensFlareFinalPostProcess=null;a.hdrFinalPostProcess=null;a.lensFlarePostProcess=null;a.lensFlareComposePostProcess=null;a.motionBlurPostProcess=null;a.depthOfFieldPostProcess=null;a.brightThreshold=1;a.blurWidth=512;a.horizontalBlur=false;a.exposure=1;a.lensTexture=null;a.volumetricLightCoefficient=.2;a.volumetricLightPower=4;a.volumetricLightBlurScale=64;a.sourceLight=null;a.hdrMinimumLuminance=1;a.hdrDecreaseRate=.5;a.hdrIncreaseRate=.5;a.lensColorTexture=null;a.lensFlareStrength=20;a.lensFlareGhostDispersal=1.4;a.lensFlareHaloWidth=.7;a.lensFlareDistortionStrength=16;a.lensStarTexture=null;a.lensFlareDirtTexture=null;a.depthOfFieldDistance=10;a.depthOfFieldBlurWidth=64;a.motionStrength=1;a.animations=[];a._currentDepthOfFieldSource=null;a._hdrCurrentLuminance=1;a._bloomEnabled=true;a._depthOfFieldEnabled=false;a._vlsEnabled=false;a._lensFlareEnabled=false;a._hdrEnabled=false;a._motionBlurEnabled=false;a._motionBlurSamples=64;a._volumetricLightStepsCount=50;a._cameras=s||[];a._scene=r;a._basePostProcess=o;a._ratio=n;a._floatTextureType=r.getEngine().getCaps().textureFloatRender?e.Engine.TEXTURETYPE_FLOAT:e.Engine.TEXTURETYPE_HALF_FLOAT;r.postProcessRenderPipelineManager.addPipeline(a);a._buildPipeline();return a}Object.defineProperty(i.prototype,"BloomEnabled",{get:function(){return this._bloomEnabled},set:function(e){if(this._bloomEnabled===e){return}this._bloomEnabled=e;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"DepthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(e){if(this._depthOfFieldEnabled===e){return}this._depthOfFieldEnabled=e;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"LensFlareEnabled",{get:function(){return this._lensFlareEnabled},set:function(e){if(this._lensFlareEnabled===e){return}this._lensFlareEnabled=e;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"HDREnabled",{get:function(){return this._hdrEnabled},set:function(e){if(this._hdrEnabled===e){return}this._hdrEnabled=e;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"VLSEnabled",{get:function(){return this._vlsEnabled},set:function(t){if(this._vlsEnabled===t){return}if(t){var i=this._scene.enableGeometryBufferRenderer();if(!i){e.Tools.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");return}}this._vlsEnabled=t;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"MotionBlurEnabled",{get:function(){return this._motionBlurEnabled},set:function(e){if(this._motionBlurEnabled===e){return}this._motionBlurEnabled=e;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"volumetricLightStepsCount",{get:function(){return this._volumetricLightStepsCount},set:function(e){if(this.volumetricLightPostProcess){this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+e.toFixed(1))}this._volumetricLightStepsCount=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"motionBlurSamples",{get:function(){return this._motionBlurSamples},set:function(e){if(this.motionBlurPostProcess){this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+e.toFixed(1))}this._motionBlurSamples=e},enumerable:true,configurable:true});i.prototype._buildPipeline=function(){var t=this;var i=this._ratio;var r=this._scene;this._disposePostProcesses();this._reset();if(!this._basePostProcess){this.originalPostProcess=new e.PostProcess("HDRPass","standard",[],[],i,null,e.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),false,"#define PASS_POST_PROCESS",this._floatTextureType);this.originalPostProcess.onApply=function(e){t._currentDepthOfFieldSource=t.originalPostProcess}}else{this.originalPostProcess=this._basePostProcess}this.addEffect(new e.PostProcessRenderEffect(r.getEngine(),"HDRPassPostProcess",function(){return t.originalPostProcess},true));this._currentDepthOfFieldSource=this.originalPostProcess;if(this._vlsEnabled){this._createVolumetricLightPostProcess(r,i);this.volumetricLightFinalPostProcess=new e.PostProcess("HDRVLSFinal","standard",[],[],i,null,e.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),false,"#define PASS_POST_PROCESS",e.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new e.PostProcessRenderEffect(r.getEngine(),"HDRVLSFinal",function(){return t.volumetricLightFinalPostProcess},true))}if(this._bloomEnabled){this._createDownSampleX4PostProcess(r,i/2);this._createBrightPassPostProcess(r,i/2);this._createBlurPostProcesses(r,i/4,1);this._createTextureAdderPostProcess(r,i);this.textureAdderFinalPostProcess=new e.PostProcess("HDRDepthOfFieldSource","standard",[],[],i,null,e.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),false,"#define PASS_POST_PROCESS",e.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new e.PostProcessRenderEffect(r.getEngine(),"HDRBaseDepthOfFieldSource",function(){return t.textureAdderFinalPostProcess},true))}if(this._lensFlareEnabled){this._createLensFlarePostProcess(r,i);this.lensFlareFinalPostProcess=new e.PostProcess("HDRPostLensFlareDepthOfFieldSource","standard",[],[],i,null,e.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),false,"#define PASS_POST_PROCESS",e.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new e.PostProcessRenderEffect(r.getEngine(),"HDRPostLensFlareDepthOfFieldSource",function(){return t.lensFlareFinalPostProcess},true))}if(this._hdrEnabled){this._createLuminancePostProcesses(r,this._floatTextureType);this._createHdrPostProcess(r,i);this.hdrFinalPostProcess=new e.PostProcess("HDRPostHDReDepthOfFieldSource","standard",[],[],i,null,e.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),false,"#define PASS_POST_PROCESS",e.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new e.PostProcessRenderEffect(r.getEngine(),"HDRPostHDReDepthOfFieldSource",function(){return t.hdrFinalPostProcess},true))}if(this._depthOfFieldEnabled){this._createBlurPostProcesses(r,i/2,3,"depthOfFieldBlurWidth");this._createDepthOfFieldPostProcess(r,i)}if(this._motionBlurEnabled){this._createMotionBlurPostProcess(r,i)}if(this._cameras!==null){this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}};i.prototype._createDownSampleX4PostProcess=function(t,i){var r=this;var n=new Array(32);this.downSampleX4PostProcess=new e.PostProcess("HDRDownSampleX4","standard",["dsOffsets"],[],i,null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,"#define DOWN_SAMPLE_X4",e.Engine.TEXTURETYPE_UNSIGNED_INT);this.downSampleX4PostProcess.onApply=function(e){var t=0;var i=r.downSampleX4PostProcess.width;var o=r.downSampleX4PostProcess.height;for(var s=-2;s<2;s++){for(var a=-2;a<2;a++){n[t]=(s+.5)*(1/i);n[t+1]=(a+.5)*(1/o);t+=2}}e.setArray2("dsOffsets",n)};this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRDownSampleX4",function(){return r.downSampleX4PostProcess},true))};i.prototype._createBrightPassPostProcess=function(t,i){var r=this;var n=new Array(8);this.brightPassPostProcess=new e.PostProcess("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],i,null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,"#define BRIGHT_PASS",e.Engine.TEXTURETYPE_UNSIGNED_INT);this.brightPassPostProcess.onApply=function(e){var t=1/r.brightPassPostProcess.width;var i=1/r.brightPassPostProcess.height;n[0]=-.5*t;n[1]=.5*i;n[2]=.5*t;n[3]=.5*i;n[4]=-.5*t;n[5]=-.5*i;n[6]=.5*t;n[7]=-.5*i;e.setArray2("dsOffsets",n);e.setFloat("brightThreshold",r.brightThreshold)};this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRBrightPass",function(){return r.brightPassPostProcess},true))};i.prototype._createBlurPostProcesses=function(t,i,r,n){var o=this;if(n===void 0){n="blurWidth"}var s=t.getEngine();var a=new e.BlurPostProcess("HDRBlurH"+"_"+r,new e.Vector2(1,0),this[n],i,null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,e.Engine.TEXTURETYPE_UNSIGNED_INT);var u=new e.BlurPostProcess("HDRBlurV"+"_"+r,new e.Vector2(0,1),this[n],i,null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,e.Engine.TEXTURETYPE_UNSIGNED_INT);a.onActivateObservable.add(function(){var e=a.width/s.getRenderWidth();a.kernel=o[n]*e});u.onActivateObservable.add(function(){var e=u.height/s.getRenderHeight();u.kernel=o.horizontalBlur?64*e:o[n]*e});this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRBlurH"+r,function(){return a},true));this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRBlurV"+r,function(){return u},true));this.blurHPostProcesses.push(a);this.blurVPostProcesses.push(u)};i.prototype._createTextureAdderPostProcess=function(t,i){var r=this;this.textureAdderPostProcess=new e.PostProcess("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],i,null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,"#define TEXTURE_ADDER",e.Engine.TEXTURETYPE_UNSIGNED_INT);this.textureAdderPostProcess.onApply=function(e){e.setTextureFromPostProcess("otherSampler",r._vlsEnabled?r._currentDepthOfFieldSource:r.originalPostProcess);e.setTexture("lensSampler",r.lensTexture);e.setFloat("exposure",r.exposure);r._currentDepthOfFieldSource=r.textureAdderFinalPostProcess};this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRTextureAdder",function(){return r.textureAdderPostProcess},true))};i.prototype._createVolumetricLightPostProcess=function(t,i){var r=this;var n=t.enableGeometryBufferRenderer();n.enablePosition=true;var o=n.getGBuffer();this.volumetricLightPostProcess=new e.PostProcess("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],i/8,null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,"#define VLS\n#define NB_STEPS "+this._volumetricLightStepsCount.toFixed(1));var s=e.Vector2.Zero();this.volumetricLightPostProcess.onApply=function(e){if(r.sourceLight&&r.sourceLight.getShadowGenerator()&&r._scene.activeCamera){var t=r.sourceLight.getShadowGenerator();e.setTexture("shadowMapSampler",t.getShadowMap());e.setTexture("positionSampler",o.textures[2]);e.setColor3("sunColor",r.sourceLight.diffuse);e.setVector3("sunDirection",r.sourceLight.getShadowDirection());e.setVector3("cameraPosition",r._scene.activeCamera.globalPosition);e.setMatrix("shadowViewProjection",t.getTransformMatrix());e.setFloat("scatteringCoefficient",r.volumetricLightCoefficient);e.setFloat("scatteringPower",r.volumetricLightPower);s.x=t.getLight().getDepthMinZ(r._scene.activeCamera);s.y=t.getLight().getDepthMaxZ(r._scene.activeCamera);e.setVector2("depthValues",s)}};this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRVLS",function(){return r.volumetricLightPostProcess},true));this._createBlurPostProcesses(t,i/4,0,"volumetricLightBlurScale");this.volumetricLightMergePostProces=new e.PostProcess("HDRVLSMerge","standard",[],["originalSampler"],i,null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,"#define VLSMERGE");this.volumetricLightMergePostProces.onApply=function(e){e.setTextureFromPostProcess("originalSampler",r.originalPostProcess);r._currentDepthOfFieldSource=r.volumetricLightFinalPostProcess};this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRVLSMerge",function(){return r.volumetricLightMergePostProces},true))};i.prototype._createLuminancePostProcesses=function(t,r){var n=this;var o=Math.pow(3,i.LuminanceSteps);this.luminancePostProcess=new e.PostProcess("HDRLuminance","standard",["lumOffsets"],[],{width:o,height:o},null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,"#define LUMINANCE",r);var s=[];this.luminancePostProcess.onApply=function(e){var t=1/n.luminancePostProcess.width;var i=1/n.luminancePostProcess.height;s[0]=-.5*t;s[1]=.5*i;s[2]=.5*t;s[3]=.5*i;s[4]=-.5*t;s[5]=-.5*i;s[6]=.5*t;s[7]=-.5*i;e.setArray2("lumOffsets",s)};this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRLuminance",function(){return n.luminancePostProcess},true));for(var a=i.LuminanceSteps-1;a>=0;a--){var o=Math.pow(3,a);var u="#define LUMINANCE_DOWN_SAMPLE\n";if(a===0){u+="#define FINAL_DOWN_SAMPLER"}var l=new e.PostProcess("HDRLuminanceDownSample"+a,"standard",["dsOffsets","halfDestPixelSize"],[],{width:o,height:o},null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,u,r);this.luminanceDownSamplePostProcesses.push(l)}var c=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(function(i,r){var o=new Array(18);i.onApply=function(e){if(!c){return}var t=0;for(var s=-1;s<2;s++){for(var a=-1;a<2;a++){o[t]=s/c.width;o[t+1]=a/c.height;t+=2}}e.setArray2("dsOffsets",o);e.setFloat("halfDestPixelSize",.5/c.width);if(r===n.luminanceDownSamplePostProcesses.length-1){c=n.luminancePostProcess}else{c=i}};if(r===n.luminanceDownSamplePostProcesses.length-1){i.onAfterRender=function(i){var r=t.getEngine().readPixels(0,0,1,1);var o=new e.Vector4(1/(255*255*255),1/(255*255),1/255,1);n._hdrCurrentLuminance=(r[0]*o.x+r[1]*o.y+r[2]*o.z+r[3]*o.w)/100}}n.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRLuminanceDownSample"+r,function(){return i},true))})};i.prototype._createHdrPostProcess=function(t,i){var r=this;this.hdrPostProcess=new e.PostProcess("HDR","standard",["averageLuminance"],["textureAdderSampler"],i,null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,"#define HDR",e.Engine.TEXTURETYPE_UNSIGNED_INT);var n=1;var o=0;var s=0;this.hdrPostProcess.onApply=function(i){i.setTextureFromPostProcess("textureAdderSampler",r._currentDepthOfFieldSource);o+=t.getEngine().getDeltaTime();if(n<0){n=r._hdrCurrentLuminance}else{var a=(s-o)/1e3;if(r._hdrCurrentLuminance<n+r.hdrDecreaseRate*a){n+=r.hdrDecreaseRate*a}else if(r._hdrCurrentLuminance>n-r.hdrIncreaseRate*a){n-=r.hdrIncreaseRate*a}else{n=r._hdrCurrentLuminance}}n=e.Scalar.Clamp(n,r.hdrMinimumLuminance,1e20);i.setFloat("averageLuminance",n);s=o;r._currentDepthOfFieldSource=r.hdrFinalPostProcess};this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDR",function(){return r.hdrPostProcess},true))};i.prototype._createLensFlarePostProcess=function(t,i){var r=this;this.lensFlarePostProcess=new e.PostProcess("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],i/2,null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,"#define LENS_FLARE",e.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRLensFlare",function(){return r.lensFlarePostProcess},true));this._createBlurPostProcesses(t,i/4,2);this.lensFlareComposePostProcess=new e.PostProcess("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],i,null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,"#define LENS_FLARE_COMPOSE",e.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRLensFlareCompose",function(){return r.lensFlareComposePostProcess},true));var n=new e.Vector2(0,0);this.lensFlarePostProcess.onApply=function(e){e.setTextureFromPostProcess("textureSampler",r._bloomEnabled?r.blurHPostProcesses[0]:r.originalPostProcess);e.setTexture("lensColorSampler",r.lensColorTexture);e.setFloat("strength",r.lensFlareStrength);e.setFloat("ghostDispersal",r.lensFlareGhostDispersal);e.setFloat("haloWidth",r.lensFlareHaloWidth);n.x=r.lensFlarePostProcess.width;n.y=r.lensFlarePostProcess.height;e.setVector2("resolution",n);e.setFloat("distortionStrength",r.lensFlareDistortionStrength)};var o=e.Matrix.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1);var s=e.Matrix.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=function(t){if(!r._scene.activeCamera){return}t.setTextureFromPostProcess("otherSampler",r._currentDepthOfFieldSource);t.setTexture("lensDirtSampler",r.lensFlareDirtTexture);t.setTexture("lensStarSampler",r.lensStarTexture);var i=r._scene.activeCamera.getViewMatrix().getRow(0);var n=r._scene.activeCamera.getViewMatrix().getRow(2);var a=e.Vector3.Dot(i.toVector3(),new e.Vector3(1,0,0))+e.Vector3.Dot(n.toVector3(),new e.Vector3(0,0,1));a*=4;var u=e.Matrix.FromValues(Math.cos(a)*.5,-Math.sin(a),0,0,Math.sin(a),Math.cos(a)*.5,0,0,0,0,1,0,0,0,0,1);var l=s.multiply(u).multiply(o);t.setMatrix("lensStarMatrix",l);r._currentDepthOfFieldSource=r.lensFlareFinalPostProcess}};i.prototype._createDepthOfFieldPostProcess=function(t,i){var r=this;this.depthOfFieldPostProcess=new e.PostProcess("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],i,null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,"#define DEPTH_OF_FIELD",e.Engine.TEXTURETYPE_UNSIGNED_INT);this.depthOfFieldPostProcess.onApply=function(e){e.setTextureFromPostProcess("otherSampler",r._currentDepthOfFieldSource);e.setTexture("depthSampler",r._getDepthTexture());e.setFloat("distance",r.depthOfFieldDistance)};this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRDepthOfField",function(){return r.depthOfFieldPostProcess},true))};i.prototype._createMotionBlurPostProcess=function(t,i){var r=this;this.motionBlurPostProcess=new e.PostProcess("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],i,null,e.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),false,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),e.Engine.TEXTURETYPE_UNSIGNED_INT);var n=0;var o=e.Matrix.Identity();var s=e.Matrix.Identity();var a=e.Matrix.Identity();var u=e.Vector2.Zero();this.motionBlurPostProcess.onApply=function(e){a=t.getProjectionMatrix().multiply(t.getViewMatrix());a.invertToRef(s);e.setMatrix("inverseViewProjection",s);e.setMatrix("prevViewProjection",o);o=a;u.x=r.motionBlurPostProcess.width;u.y=r.motionBlurPostProcess.height;e.setVector2("screenSize",u);n=t.getEngine().getFps()/60;e.setFloat("motionScale",n);e.setFloat("motionStrength",r.motionStrength);e.setTexture("depthSampler",r._getDepthTexture())};this.addEffect(new e.PostProcessRenderEffect(t.getEngine(),"HDRMotionBlur",function(){return r.motionBlurPostProcess},true))};i.prototype._getDepthTexture=function(){if(this._scene.getEngine().getCaps().drawBuffersExtension){var e=this._scene.enableGeometryBufferRenderer();return e.getGBuffer().textures[0]}return this._scene.enableDepthRenderer().getDepthMap()};i.prototype._disposePostProcesses=function(){for(var e=0;e<this._cameras.length;e++){var t=this._cameras[e];if(this.originalPostProcess){this.originalPostProcess.dispose(t)}if(this.downSampleX4PostProcess){this.downSampleX4PostProcess.dispose(t)}if(this.brightPassPostProcess){this.brightPassPostProcess.dispose(t)}if(this.textureAdderPostProcess){this.textureAdderPostProcess.dispose(t)}if(this.textureAdderFinalPostProcess){this.textureAdderFinalPostProcess.dispose(t)}if(this.volumetricLightPostProcess){this.volumetricLightPostProcess.dispose(t)}if(this.volumetricLightSmoothXPostProcess){this.volumetricLightSmoothXPostProcess.dispose(t)}if(this.volumetricLightSmoothYPostProcess){this.volumetricLightSmoothYPostProcess.dispose(t)}if(this.volumetricLightMergePostProces){this.volumetricLightMergePostProces.dispose(t)}if(this.volumetricLightFinalPostProcess){this.volumetricLightFinalPostProcess.dispose(t)}if(this.lensFlarePostProcess){this.lensFlarePostProcess.dispose(t)}if(this.lensFlareComposePostProcess){this.lensFlareComposePostProcess.dispose(t)}for(var i=0;i<this.luminanceDownSamplePostProcesses.length;i++){this.luminanceDownSamplePostProcesses[i].dispose(t)}if(this.luminancePostProcess){this.luminancePostProcess.dispose(t)}if(this.hdrPostProcess){this.hdrPostProcess.dispose(t)}if(this.hdrFinalPostProcess){this.hdrFinalPostProcess.dispose(t)}if(this.depthOfFieldPostProcess){this.depthOfFieldPostProcess.dispose(t)}if(this.motionBlurPostProcess){this.motionBlurPostProcess.dispose(t)}for(var i=0;i<this.blurHPostProcesses.length;i++){this.blurHPostProcesses[i].dispose(t)}for(var i=0;i<this.blurVPostProcesses.length;i++){this.blurVPostProcesses[i].dispose(t)}}this.originalPostProcess=null;this.downSampleX4PostProcess=null;this.brightPassPostProcess=null;this.textureAdderPostProcess=null;this.textureAdderFinalPostProcess=null;this.volumetricLightPostProcess=null;this.volumetricLightSmoothXPostProcess=null;this.volumetricLightSmoothYPostProcess=null;this.volumetricLightMergePostProces=null;this.volumetricLightFinalPostProcess=null;this.lensFlarePostProcess=null;this.lensFlareComposePostProcess=null;this.luminancePostProcess=null;this.hdrPostProcess=null
;this.hdrFinalPostProcess=null;this.depthOfFieldPostProcess=null;this.motionBlurPostProcess=null;this.luminanceDownSamplePostProcesses=[];this.blurHPostProcesses=[];this.blurVPostProcesses=[]};i.prototype.dispose=function(){this._disposePostProcesses();this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras);t.prototype.dispose.call(this)};i.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);t.customType="StandardRenderingPipeline";return t};i.Parse=function(t,r,n){return e.SerializationHelper.Parse(function(){return new i(t._name,r,t._ratio)},t,r,n)};i.LuminanceSteps=6;__decorate([e.serialize()],i.prototype,"brightThreshold",void 0);__decorate([e.serialize()],i.prototype,"blurWidth",void 0);__decorate([e.serialize()],i.prototype,"horizontalBlur",void 0);__decorate([e.serialize()],i.prototype,"exposure",void 0);__decorate([e.serializeAsTexture("lensTexture")],i.prototype,"lensTexture",void 0);__decorate([e.serialize()],i.prototype,"volumetricLightCoefficient",void 0);__decorate([e.serialize()],i.prototype,"volumetricLightPower",void 0);__decorate([e.serialize()],i.prototype,"volumetricLightBlurScale",void 0);__decorate([e.serialize()],i.prototype,"hdrMinimumLuminance",void 0);__decorate([e.serialize()],i.prototype,"hdrDecreaseRate",void 0);__decorate([e.serialize()],i.prototype,"hdrIncreaseRate",void 0);__decorate([e.serializeAsTexture("lensColorTexture")],i.prototype,"lensColorTexture",void 0);__decorate([e.serialize()],i.prototype,"lensFlareStrength",void 0);__decorate([e.serialize()],i.prototype,"lensFlareGhostDispersal",void 0);__decorate([e.serialize()],i.prototype,"lensFlareHaloWidth",void 0);__decorate([e.serialize()],i.prototype,"lensFlareDistortionStrength",void 0);__decorate([e.serializeAsTexture("lensStarTexture")],i.prototype,"lensStarTexture",void 0);__decorate([e.serializeAsTexture("lensFlareDirtTexture")],i.prototype,"lensFlareDirtTexture",void 0);__decorate([e.serialize()],i.prototype,"depthOfFieldDistance",void 0);__decorate([e.serialize()],i.prototype,"depthOfFieldBlurWidth",void 0);__decorate([e.serialize()],i.prototype,"motionStrength",void 0);__decorate([e.serialize()],i.prototype,"_ratio",void 0);__decorate([e.serialize()],i.prototype,"BloomEnabled",null);__decorate([e.serialize()],i.prototype,"DepthOfFieldEnabled",null);__decorate([e.serialize()],i.prototype,"LensFlareEnabled",null);__decorate([e.serialize()],i.prototype,"HDREnabled",null);__decorate([e.serialize()],i.prototype,"VLSEnabled",null);__decorate([e.serialize()],i.prototype,"MotionBlurEnabled",null);__decorate([e.serialize()],i.prototype,"volumetricLightStepsCount",null);__decorate([e.serialize()],i.prototype,"motionBlurSamples",null);return i}(e.PostProcessRenderPipeline);e.StandardRenderingPipeline=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u){if(n===void 0){n=null}if(u===void 0){u=e.Engine.TEXTURETYPE_UNSIGNED_INT}var l=t.call(this,i,"fxaa",["texelSize"],null,r,n,o||e.Texture.BILINEAR_SAMPLINGMODE,s,a,null,u,"fxaa")||this;l.onApplyObservable.add(function(e){var t=l.texelSize;e.setFloat2("texelSize",t.x,t.y)});return l}return i}(e.PostProcess);e.FxaaPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c,h){if(c===void 0){c=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(h===void 0){h=false}var f=t.call(this,i,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],o,s,a,u,l,null,c,undefined,null,h)||this;f.aberrationAmount=30;f.radialIntensity=0;f.direction=new e.Vector2(.707,.707);f.centerPosition=new e.Vector2(.5,.5);f.onApplyObservable.add(function(e){e.setFloat("chromatic_aberration",f.aberrationAmount);e.setFloat("screen_width",r);e.setFloat("screen_height",n);e.setFloat("radialIntensity",f.radialIntensity);e.setFloat2("direction",f.direction.x,f.direction.y);e.setFloat2("centerPosition",f.centerPosition.x,f.centerPosition.y)});return f}return i}(e.PostProcess);e.ChromaticAberrationPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l){if(u===void 0){u=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(l===void 0){l=false}var c=t.call(this,i,"grain",["intensity","animatedSeed"],[],r,n,o,s,a,null,u,undefined,null,l)||this;c.intensity=30;c.animated=false;c.onApplyObservable.add(function(e){e.setFloat("intensity",c.intensity);e.setFloat("animatedSeed",c.animated?Math.random()+1:1)});return c}return i}(e.PostProcess);e.GrainPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l){if(u===void 0){u=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(l===void 0){l=false}var c=t.call(this,i,"sharpen",["sharpnessAmounts","screenSize"],null,r,n,o,s,a,null,u,undefined,null,l)||this;c.colorAmount=1;c.edgeAmount=.3;c.onApply=function(e){e.setFloat2("screenSize",c.width,c.height);e.setFloat2("sharpnessAmounts",c.edgeAmount,c.colorAmount)};return c}return i}(e.PostProcess);e.SharpenPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c,h,f){if(a===void 0){a=e.Texture.BILINEAR_SAMPLINGMODE}if(c===void 0){c=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(h===void 0){h=""}if(f===void 0){f=false}var d=t.call(this,i,"kernelBlur",["delta","direction","cameraMinMaxZ"],["circleOfConfusionSampler"],o,s,a,u,l,null,c,"kernelBlur",{varyingCount:0,depCount:0},true)||this;d.direction=r;d.blockCompilation=f;d._packedFloat=false;d._staticDefines="";d._staticDefines=h;d.onApplyObservable.add(function(e){if(d._outputTexture){e.setFloat2("delta",1/d._outputTexture.width*d.direction.x,1/d._outputTexture.height*d.direction.y)}else{e.setFloat2("delta",1/d.width*d.direction.x,1/d.height*d.direction.y)}});d.kernel=n;return d}Object.defineProperty(i.prototype,"kernel",{get:function(){return this._idealKernel},set:function(e){if(this._idealKernel===e){return}e=Math.max(e,1);this._idealKernel=e;this._kernel=this._nearestBestKernel(e);if(!this.blockCompilation){this._updateParameters()}},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"packedFloat",{get:function(){return this._packedFloat},set:function(e){if(this._packedFloat===e){return}this._packedFloat=e;if(!this.blockCompilation){this._updateParameters()}},enumerable:true,configurable:true});i.prototype.updateEffect=function(e,t,i,r,n,o){if(e===void 0){e=null}if(t===void 0){t=null}if(i===void 0){i=null}this._updateParameters(n,o)};i.prototype._updateParameters=function(e,i){var r=this._kernel;var n=(r-1)/2;var o=[];var s=[];var a=0;for(var u=0;u<r;u++){var l=u/(r-1);var c=this._gaussianWeight(l*2-1);o[u]=u-n;s[u]=c;a+=c}for(var u=0;u<s.length;u++){s[u]/=a}var h=[];var f=[];var d=[];for(var u=0;u<=n;u+=2){var p=Math.min(u+1,Math.floor(n));var _=u===p;if(_){d.push({o:o[u],w:s[u]})}else{var m=p===n;var g=s[u]+s[p]*(m?.5:1);var v=o[u]+1/(1+s[u]/s[p]);if(v===0){d.push({o:o[u],w:s[u]});d.push({o:o[u+1],w:s[u+1]})}else{d.push({o:v,w:g});d.push({o:-v,w:g})}}}for(var u=0;u<d.length;u++){f[u]=d[u].o;h[u]=d[u].w}o=f;s=h;var y=this.getEngine().getCaps().maxVaryingVectors;var b=Math.max(y,0)-1;var x=Math.min(o.length,b);var T="";T+=this._staticDefines;if(this._staticDefines.indexOf("DOF")!=-1){T+="#define CENTER_WEIGHT "+this._glslFloat(s[x-1])+"\r\n";x--}for(var u=0;u<x;u++){T+="#define KERNEL_OFFSET"+u+" "+this._glslFloat(o[u])+"\r\n";T+="#define KERNEL_WEIGHT"+u+" "+this._glslFloat(s[u])+"\r\n"}var E=0;for(var u=b;u<o.length;u++){T+="#define KERNEL_DEP_OFFSET"+E+" "+this._glslFloat(o[u])+"\r\n";T+="#define KERNEL_DEP_WEIGHT"+E+" "+this._glslFloat(s[u])+"\r\n";E++}if(this.packedFloat){T+="#define PACKEDFLOAT 1"}this.blockCompilation=false;t.prototype.updateEffect.call(this,T,null,null,{varyingCount:x,depCount:E},e,i)};i.prototype._nearestBestKernel=function(e){var t=Math.round(e);for(var i=0,r=[t,t-1,t+1,t-2,t+2];i<r.length;i++){var n=r[i];if(n%2!==0&&Math.floor(n/2)%2===0&&n>0){return Math.max(n,3)}}return Math.max(t,3)};i.prototype._gaussianWeight=function(e){var t=1/3;var i=Math.sqrt(2*Math.PI)*t;var r=-(e*e/(2*t*t));var n=1/i*Math.exp(r);return n};i.prototype._glslFloat=function(e,t){if(t===void 0){t=8}return e.toFixed(t).replace(/0+$/,"")};return i}(e.PostProcess);e.BlurPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c,h,f,d,p){if(l===void 0){l=null}if(c===void 0){c=e.Texture.BILINEAR_SAMPLINGMODE}if(d===void 0){d=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(p===void 0){p=false}var _=t.call(this,i,n,o,s,a,c=e.Texture.BILINEAR_SAMPLINGMODE,h,f,d=e.Engine.TEXTURETYPE_UNSIGNED_INT,"#define DOF 1\r\n",p)||this;_.direction=n;_.onApplyObservable.add(function(e){if(l!=null){e.setTextureFromPostProcess("textureSampler",l)}e.setTextureFromPostProcessOutput("circleOfConfusionSampler",u);if(r.activeCamera){e.setFloat2("cameraMinMaxZ",r.activeCamera.minZ,r.activeCamera.maxZ)}});return _}return i}(e.BlurPostProcess);e.DepthOfFieldBlurPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){}return e}();e.DepthOfFieldMergePostProcessOptions=t;var i=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c,h,f){if(h===void 0){h=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(f===void 0){f=false}var d=t.call(this,i,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],s,a,u,l,c,null,h,undefined,null,true)||this;d.blurSteps=o;d.onApplyObservable.add(function(e){e.setTextureFromPostProcess("textureSampler",r);e.setTextureFromPostProcessOutput("circleOfConfusionSampler",n);o.forEach(function(t,i){e.setTextureFromPostProcessOutput("blurStep"+(o.length-i-1),t)})});if(!f){d.updateEffect()}return d}i.prototype.updateEffect=function(e,i,r,n,o,s){if(e===void 0){e=null}if(i===void 0){i=null}if(r===void 0){r=null}if(!e){e="";e+="#define BLUR_LEVEL "+(this.blurSteps.length-1)+"\n"}t.prototype.updateEffect.call(this,e,i,r,n,o,s)};return i}(e.PostProcess);e.DepthOfFieldMergePostProcess=i})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c){if(l===void 0){l=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(c===void 0){c=false}var h=t.call(this,i,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],n,o,s,a,u,null,l,undefined,null,c)||this;h.lensSize=50;h.fStop=1.4;h.focusDistance=2e3;h.focalLength=50;h._depthTexture=null;h._depthTexture=r;h.onApplyObservable.add(function(t){if(!h._depthTexture){e.Tools.Warn("No depth texture set on CircleOfConfusionPostProcess");return}t.setTexture("depthSampler",h._depthTexture);var i=h.lensSize/h.fStop;var r=i*h.focalLength/(h.focusDistance-h.focalLength);t.setFloat("focusDistance",h.focusDistance);t.setFloat("cocPrecalculation",r);t.setFloat2("cameraMinMaxZ",h._depthTexture.activeCamera.minZ,h._depthTexture.activeCamera.maxZ)});return h}Object.defineProperty(i.prototype,"depthTexture",{set:function(e){this._depthTexture=e},enumerable:true,configurable:true});return i}(e.PostProcess);e.CircleOfConfusionPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t;(function(e){e[e["Low"]=0]="Low";e[e["Medium"]=1]="Medium";e[e["High"]=2]="High"})(t=e.DepthOfFieldEffectBlurLevel||(e.DepthOfFieldEffectBlurLevel={}));var i=function(i){__extends(r,i);function r(r,n,o,s,a){if(o===void 0){o=t.Low}if(s===void 0){s=0}if(a===void 0){a=false}var u=i.call(this,r.getEngine(),"depth of field",function(){return u._effects},true)||this;u._effects=[];u._circleOfConfusion=new e.CircleOfConfusionPostProcess("circleOfConfusion",n,1,null,e.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),false,s,a);u._depthOfFieldBlurY=[];u._depthOfFieldBlurX=[];var l=1;var c=15;switch(o){case t.High:{l=3;c=51;break}case t.Medium:{l=2;c=31;break}default:{c=15;l=1;break}}var h=c/Math.pow(2,l-1);var f=1;for(var d=0;d<l;d++){var p=new e.DepthOfFieldBlurPostProcess("verticle blur",r,new e.Vector2(0,1),h,f,null,u._circleOfConfusion,d==0?u._circleOfConfusion:null,e.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),false,s,a);p.autoClear=false;f=.75/Math.pow(2,d);var _=new e.DepthOfFieldBlurPostProcess("horizontal blur",r,new e.Vector2(1,0),h,f,null,u._circleOfConfusion,null,e.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),false,s,a);_.autoClear=false;u._depthOfFieldBlurY.push(p);u._depthOfFieldBlurX.push(_)}u._effects=[u._circleOfConfusion];for(var d=0;d<u._depthOfFieldBlurX.length;d++){u._effects.push(u._depthOfFieldBlurY[d]);u._effects.push(u._depthOfFieldBlurX[d])}u._dofMerge=new e.DepthOfFieldMergePostProcess("dofMerge",u._circleOfConfusion,u._circleOfConfusion,u._depthOfFieldBlurX,f,null,e.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),false,s,a);u._dofMerge.autoClear=false;u._effects.push(u._dofMerge);return u}Object.defineProperty(r.prototype,"focalLength",{get:function(){return this._circleOfConfusion.focalLength},set:function(e){this._circleOfConfusion.focalLength=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"fStop",{get:function(){return this._circleOfConfusion.fStop},set:function(e){this._circleOfConfusion.fStop=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"focusDistance",{get:function(){return this._circleOfConfusion.focusDistance},set:function(e){this._circleOfConfusion.focusDistance=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"lensSize",{get:function(){return this._circleOfConfusion.lensSize},set:function(e){this._circleOfConfusion.lensSize=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"depthTexture",{set:function(e){this._circleOfConfusion.depthTexture=e},enumerable:true,configurable:true});r.prototype.disposeEffects=function(e){for(var t in this._effects){this._effects[t].dispose(e)}};r.prototype._updateEffects=function(){for(var e in this._effects){this._effects[e].updateEffect()}};r.prototype._isReady=function(){for(var e in this._effects){if(!this._effects[e].isReady()){return false}}return true};return r}(e.PostProcessRenderEffect);e.DepthOfFieldEffect=i})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c,h,f){if(h===void 0){h=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(f===void 0){f=false}var d=t.call(this,i,"bloomMerge",["bloomWeight"],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2","bloomBlur"],s,a,u,l,c,null,h,undefined,null,true)||this;d.weight=o;d.onApplyObservable.add(function(e){e.setTextureFromPostProcess("textureSampler",r);e.setTextureFromPostProcessOutput("bloomBlur",n);e.setFloat("bloomWeight",d.weight)});if(!f){d.updateEffect()}return d}return i}(e.PostProcess);e.BloomMergePostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l){if(u===void 0){u=e.Engine.TEXTURETYPE_UNSIGNED_INT}if(l===void 0){l=false}var c=t.call(this,i,"extractHighlights",["threshold","exposure"],null,r,n,o,s,a,null,u,undefined,null,l)||this;c.threshold=.9;c._exposure=1;c._inputPostProcess=null;c.onApplyObservable.add(function(t){if(c._inputPostProcess){t.setTextureFromPostProcess("textureSampler",c._inputPostProcess)}t.setFloat("threshold",Math.pow(c.threshold,e.ToGammaSpace));t.setFloat("exposure",c._exposure)});return c}return i}(e.PostProcess);e.ExtractHighlightsPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a){if(s===void 0){s=0}if(a===void 0){a=false}var u=t.call(this,i.getEngine(),"bloom",function(){return u._effects},true)||this;u.bloomScale=r;u._effects=[];u._downscale=new e.ExtractHighlightsPostProcess("highlights",1,null,e.Texture.BILINEAR_SAMPLINGMODE,i.getEngine(),false,s,a);u._blurX=new e.BlurPostProcess("horizontal blur",new e.Vector2(1,0),10,r,null,e.Texture.BILINEAR_SAMPLINGMODE,i.getEngine(),false,s,undefined,a);u._blurX.alwaysForcePOT=true;u._blurX.autoClear=false;u._blurY=new e.BlurPostProcess("vertical blur",new e.Vector2(0,1),10,r,null,e.Texture.BILINEAR_SAMPLINGMODE,i.getEngine(),false,s,undefined,a);u._blurY.alwaysForcePOT=true;u._blurY.autoClear=false;u.kernel=o;u._effects=[u._downscale,u._blurX,u._blurY];u._merge=new e.BloomMergePostProcess("bloomMerge",u._downscale,u._blurY,n,r,null,e.Texture.BILINEAR_SAMPLINGMODE,i.getEngine(),false,s,a);u._merge.autoClear=false;u._effects.push(u._merge);return u}Object.defineProperty(i.prototype,"threshold",{get:function(){return this._downscale.threshold},set:function(e){this._downscale.threshold=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"weight",{get:function(){return this._merge.weight},set:function(e){this._merge.weight=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"kernel",{get:function(){return this._blurX.kernel/this.bloomScale},set:function(e){this._blurX.kernel=e*this.bloomScale;this._blurY.kernel=e*this.bloomScale},enumerable:true,configurable:true});i.prototype.disposeEffects=function(e){for(var t in this._effects){this._effects[t].dispose(e)}};i.prototype._updateEffects=function(){for(var e in this._effects){this._effects[e].updateEffect()}};i.prototype._isReady=function(){for(var e in this._effects){if(!this._effects[e].isReady()){return false}}return true};return i}(e.PostProcessRenderEffect);e.BloomEffect=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s){if(s===void 0){s=true}var a=t.call(this,n.getEngine(),i)||this;a._originalCameras=[];a.SharpenPostProcessId="SharpenPostProcessEffect";a.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect";a.FxaaPostProcessId="FxaaPostProcessEffect";a.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect";a.GrainPostProcessId="GrainPostProcessEffect";a.animations=[];a._imageProcessingConfigurationObserver=null;a._sharpenEnabled=false;a._bloomEnabled=false;a._depthOfFieldEnabled=false;a._depthOfFieldBlurLevel=e.DepthOfFieldEffectBlurLevel.Low;a._fxaaEnabled=false;a._imageProcessingEnabled=true;a._bloomScale=.5;a._chromaticAberrationEnabled=false;a._grainEnabled=false;a._buildAllowed=true;a._resizeObserver=null;a._hardwareScaleLevel=1;a._bloomKernel=64;a._bloomWeight=.15;a._bloomThreshold=.9;a._samples=1;a._hasCleared=false;a._prevPostProcess=null;a._prevPrevPostProcess=null;a._cameras=o||[];a._originalCameras=a._cameras.slice();a._buildAllowed=s;a._scene=n;var u=a._scene.getEngine().getCaps();a._hdr=r&&(u.textureHalfFloatRender||u.textureFloatRender);if(a._hdr){if(u.textureHalfFloatRender){a._defaultPipelineTextureType=e.Engine.TEXTURETYPE_HALF_FLOAT}else if(u.textureFloatRender){a._defaultPipelineTextureType=e.Engine.TEXTURETYPE_FLOAT}}else{a._defaultPipelineTextureType=e.Engine.TEXTURETYPE_UNSIGNED_INT}n.postProcessRenderPipelineManager.addPipeline(a);var l=a._scene.getEngine();a.sharpen=new e.SharpenPostProcess("sharpen",1,null,e.Texture.BILINEAR_SAMPLINGMODE,l,false,a._defaultPipelineTextureType,true);a._sharpenEffect=new e.PostProcessRenderEffect(l,a.SharpenPostProcessId,function(){return a.sharpen},true);a.depthOfField=new e.DepthOfFieldEffect(a._scene,null,a._depthOfFieldBlurLevel,a._defaultPipelineTextureType,true);a.bloom=new e.BloomEffect(a._scene,a._bloomScale,a._bloomWeight,a.bloomKernel,a._defaultPipelineTextureType,true);a.chromaticAberration=new e.ChromaticAberrationPostProcess("ChromaticAberration",l.getRenderWidth(),l.getRenderHeight(),1,null,e.Texture.BILINEAR_SAMPLINGMODE,l,false,a._defaultPipelineTextureType,true);a._chromaticAberrationEffect=new e.PostProcessRenderEffect(l,a.ChromaticAberrationPostProcessId,function(){return a.chromaticAberration},true);a.grain=new e.GrainPostProcess("Grain",1,null,e.Texture.BILINEAR_SAMPLINGMODE,l,false,a._defaultPipelineTextureType,true);a._grainEffect=new e.PostProcessRenderEffect(l,a.GrainPostProcessId,function(){return a.grain},true);a._resizeObserver=l.onResizeObservable.add(function(){a._hardwareScaleLevel=l.getHardwareScalingLevel();a.bloomKernel=a.bloomKernel});a._imageProcessingConfigurationObserver=a._scene.imageProcessingConfiguration.onUpdateParameters.add(function(){a.bloom._downscale._exposure=a._scene.imageProcessingConfiguration.exposure});a._buildPipeline();return a}Object.defineProperty(i.prototype,"sharpenEnabled",{get:function(){return this._sharpenEnabled},set:function(e){if(this._sharpenEnabled===e){return}this._sharpenEnabled=e;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"bloomKernel",{get:function(){return this._bloomKernel},set:function(e){this._bloomKernel=e;this.bloom.kernel=e/this._hardwareScaleLevel},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"bloomWeight",{get:function(){return this._bloomWeight},set:function(e){if(this._bloomWeight===e){return}this.bloom.weight=e;this._bloomWeight=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"bloomThreshold",{get:function(){return this._bloomThreshold},set:function(e){if(this._bloomThreshold===e){return}this.bloom.threshold=e;this._bloomThreshold=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"bloomScale",{get:function(){return this._bloomScale},set:function(e){if(this._bloomScale===e){return}this._bloomScale=e;this._rebuildBloom();this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"bloomEnabled",{get:function(){return this._bloomEnabled},set:function(e){if(this._bloomEnabled===e){return}this._bloomEnabled=e;this._buildPipeline()},enumerable:true,configurable:true});i.prototype._rebuildBloom=function(){var t=this.bloom;this.bloom=new e.BloomEffect(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel,this._defaultPipelineTextureType,false);this.bloom.threshold=t.threshold;for(var i=0;i<this._cameras.length;i++){t.disposeEffects(this._cameras[i])}};Object.defineProperty(i.prototype,"depthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(e){if(this._depthOfFieldEnabled===e){return}this._depthOfFieldEnabled=e;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"depthOfFieldBlurLevel",{get:function(){return this._depthOfFieldBlurLevel},set:function(t){if(this._depthOfFieldBlurLevel===t){return}this._depthOfFieldBlurLevel=t;var i=this.depthOfField;this.depthOfField=new e.DepthOfFieldEffect(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,false);this.depthOfField.focalLength=i.focalLength;this.depthOfField.focusDistance=i.focusDistance;this.depthOfField.fStop=i.fStop;this.depthOfField.lensSize=i.lensSize;for(var r=0;r<this._cameras.length;r++){i.disposeEffects(this._cameras[r])}this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"fxaaEnabled",{get:function(){return this._fxaaEnabled},set:function(e){if(this._fxaaEnabled===e){return}this._fxaaEnabled=e;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"samples",{get:function(){return this._samples},set:function(e){if(this._samples===e){return}this._samples=e;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"imageProcessingEnabled",{get:function(){return this._imageProcessingEnabled},set:function(e){if(this._imageProcessingEnabled===e){return}this._imageProcessingEnabled=e;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"chromaticAberrationEnabled",{get:function(){return this._chromaticAberrationEnabled},set:function(e){if(this._chromaticAberrationEnabled===e){return}this._chromaticAberrationEnabled=e;this._buildPipeline()},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"grainEnabled",{get:function(){return this._grainEnabled},set:function(e){if(this._grainEnabled===e){return}this._grainEnabled=e;this._buildPipeline()},enumerable:true,configurable:true});i.prototype.prepare=function(){var e=this._buildAllowed;this._buildAllowed=true;this._buildPipeline();this._buildAllowed=e};i.prototype._setAutoClearAndTextureSharing=function(e,t){if(t===void 0){t=false}if(this._hasCleared){e.autoClear=false}else{e.autoClear=true;this._scene.autoClear=false;this._hasCleared=true}if(!t){if(this._prevPrevPostProcess){e.shareOutputWith(this._prevPrevPostProcess)}else{e.useOwnOutput()}if(this._prevPostProcess){this._prevPrevPostProcess=this._prevPostProcess}this._prevPostProcess=e}};i.prototype._buildPipeline=function(){var t=this;if(!this._buildAllowed){return}this._scene.autoClear=true;var i=this._scene.getEngine();this._disposePostProcesses();if(this._cameras!==null){this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras);this._cameras=this._originalCameras.slice()}this._reset();this._prevPostProcess=null;this._prevPrevPostProcess=null;this._hasCleared=false;if(this.depthOfFieldEnabled){var r=this._scene.enableDepthRenderer(this._cameras[0]).getDepthMap();this.depthOfField.depthTexture=r;if(!this.depthOfField._isReady()){this.depthOfField._updateEffects()}this.addEffect(this.depthOfField);this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],true)}if(this.bloomEnabled){if(!this.bloom._isReady()){this.bloom._updateEffects()}this.addEffect(this.bloom);this._setAutoClearAndTextureSharing(this.bloom._effects[0],true)}if(this._imageProcessingEnabled){this.imageProcessing=new e.ImageProcessingPostProcess("imageProcessing",1,null,e.Texture.BILINEAR_SAMPLINGMODE,i,false,this._defaultPipelineTextureType);if(this._hdr){this.addEffect(new e.PostProcessRenderEffect(i,this.ImageProcessingPostProcessId,function(){return t.imageProcessing},true));this._setAutoClearAndTextureSharing(this.imageProcessing)}else{this._scene.imageProcessingConfiguration.applyByPostProcess=false}}if(this.sharpenEnabled){if(!this.sharpen.isReady()){this.sharpen.updateEffect()}this.addEffect(this._sharpenEffect);this._setAutoClearAndTextureSharing(this.sharpen)}if(this.grainEnabled){if(!this.grain.isReady()){this.grain.updateEffect()}this.addEffect(this._grainEffect);this._setAutoClearAndTextureSharing(this.grain)}if(this.chromaticAberrationEnabled){if(!this.chromaticAberration.isReady()){this.chromaticAberration.updateEffect()}this.addEffect(this._chromaticAberrationEffect);this._setAutoClearAndTextureSharing(this.chromaticAberration)}if(this.fxaaEnabled){this.fxaa=new e.FxaaPostProcess("fxaa",1,null,e.Texture.BILINEAR_SAMPLINGMODE,i,false,this._defaultPipelineTextureType);this.addEffect(new e.PostProcessRenderEffect(i,this.FxaaPostProcessId,function(){return t.fxaa},true));this._setAutoClearAndTextureSharing(this.fxaa,true)}if(this._cameras!==null){this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}if(!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1){e.Tools.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}};i.prototype._disposePostProcesses=function(e){if(e===void 0){e=false}for(var t=0;t<this._cameras.length;t++){var i=this._cameras[t];if(this.imageProcessing){this.imageProcessing.dispose(i)}if(this.fxaa){this.fxaa.dispose(i)}if(e){if(this.sharpen){this.sharpen.dispose(i)}if(this.depthOfField){this.depthOfField.disposeEffects(i)}if(this.bloom){this.bloom.disposeEffects(i)}if(this.chromaticAberration){this.chromaticAberration.dispose(i)}if(this.grain){this.grain.dispose(i)}}}this.imageProcessing=null;this.fxaa=null;if(e){this.sharpen=null;this._sharpenEffect=null;this.depthOfField=null;this.bloom=null;this.chromaticAberration=null;this._chromaticAberrationEffect=null;this.grain=null;this._grainEffect=null}};i.prototype.dispose=function(){this._disposePostProcesses(true);this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras);this._scene.autoClear=true;if(this._resizeObserver){this._scene.getEngine().onResizeObservable.remove(this._resizeObserver);this._resizeObserver=null}this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver);t.prototype.dispose.call(this)};i.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);t.customType="DefaultRenderingPipeline";return t};i.Parse=function(t,r,n){return e.SerializationHelper.Parse(function(){return new i(t._name,t._name._hdr,r)},t,r,n)};__decorate([e.serialize()],i.prototype,"sharpenEnabled",null);__decorate([e.serialize()],i.prototype,"bloomKernel",null);__decorate([e.serialize()],i.prototype,"_bloomWeight",void 0);__decorate([e.serialize()],i.prototype,"_bloomThreshold",void 0);__decorate([e.serialize()],i.prototype,"_hdr",void 0);__decorate([e.serialize()],i.prototype,"bloomWeight",null);__decorate([e.serialize()],i.prototype,"bloomThreshold",null);__decorate([e.serialize()],i.prototype,"bloomScale",null);__decorate([e.serialize()],i.prototype,"bloomEnabled",null);__decorate([e.serialize()],i.prototype,"depthOfFieldEnabled",null);__decorate([e.serialize()],i.prototype,"depthOfFieldBlurLevel",null);__decorate([e.serialize()],i.prototype,"fxaaEnabled",null);__decorate([e.serialize()],i.prototype,"samples",null);__decorate([e.serialize()],i.prototype,"imageProcessingEnabled",null);__decorate([e.serialize()],i.prototype,"chromaticAberrationEnabled",null);__decorate([e.serialize()],i.prototype,"grainEnabled",null);return i}(e.PostProcessRenderPipeline);e.DefaultRenderingPipeline=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,t){if(t===void 0){t=1}this._enablePosition=false;this._scene=e;this._ratio=t;this._createRenderTargets()}Object.defineProperty(t.prototype,"renderList",{set:function(e){this._multiRenderTarget.renderList=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"isSupported",{get:function(){return this._multiRenderTarget.isSupported},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"enablePosition",{get:function(){return this._enablePosition},set:function(e){this._enablePosition=e;this.dispose();this._createRenderTargets()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"ratio",{get:function(){return this._ratio},enumerable:true,configurable:true});t.prototype.isReady=function(t,i){var r=t.getMaterial();if(r&&r.disableDepthWrite){return false}var n=[];var o=[e.VertexBuffer.PositionKind,e.VertexBuffer.NormalKind];var s=t.getMesh();if(r&&r.needAlphaTesting()){n.push("#define ALPHATEST");if(s.isVerticesDataPresent(e.VertexBuffer.UVKind)){o.push(e.VertexBuffer.UVKind);n.push("#define UV1")}if(s.isVerticesDataPresent(e.VertexBuffer.UV2Kind)){o.push(e.VertexBuffer.UV2Kind);n.push("#define UV2")}}if(this._enablePosition){n.push("#define POSITION")}if(s.useBones&&s.computeBonesUsingShaders){o.push(e.VertexBuffer.MatricesIndicesKind);o.push(e.VertexBuffer.MatricesWeightsKind);if(s.numBoneInfluencers>4){o.push(e.VertexBuffer.MatricesIndicesExtraKind);o.push(e.VertexBuffer.MatricesWeightsExtraKind)}n.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers);n.push("#define BonesPerMesh "+(s.skeleton?s.skeleton.bones.length+1:0))}else{n.push("#define NUM_BONE_INFLUENCERS 0")}if(i){n.push("#define INSTANCES");o.push("world0");o.push("world1");o.push("world2");o.push("world3")}var a=n.join("\n");if(this._cachedDefines!==a){this._cachedDefines=a;this._effect=this._scene.getEngine().createEffect("geometry",o,["world","mBones","viewProjection","diffuseMatrix","view"],["diffuseSampler"],a,undefined,undefined,undefined,{buffersCount:this._enablePosition?3:2})}return this._effect.isReady()};t.prototype.getGBuffer=function(){return this._multiRenderTarget};Object.defineProperty(t.prototype,"samples",{get:function(){return this._multiRenderTarget.samples},set:function(e){this._multiRenderTarget.samples=e},enumerable:true,configurable:true});t.prototype.dispose=function(){
this.getGBuffer().dispose()};t.prototype._createRenderTargets=function(){var t=this;var i=this._scene.getEngine();var r=this._enablePosition?3:2;this._multiRenderTarget=new e.MultiRenderTarget("gBuffer",{width:i.getRenderWidth()*this._ratio,height:i.getRenderHeight()*this._ratio},r,this._scene,{generateMipMaps:false,generateDepthTexture:true,defaultType:e.Engine.TEXTURETYPE_FLOAT});if(!this.isSupported){return}this._multiRenderTarget.wrapU=e.Texture.CLAMP_ADDRESSMODE;this._multiRenderTarget.wrapV=e.Texture.CLAMP_ADDRESSMODE;this._multiRenderTarget.refreshRate=1;this._multiRenderTarget.renderParticles=false;this._multiRenderTarget.renderList=null;this._multiRenderTarget.onClearObservable.add(function(t){t.clear(new e.Color4(0,0,0,1),true,true,true)});var n=function(i){var r=i.getRenderingMesh();var n=t._scene;var o=n.getEngine();var s=i.getMaterial();if(!s){return}o.setState(s.backFaceCulling,0,false,n.useRightHandedSystem);var a=r._getInstancesRenderList(i._id);if(a.mustReturn){return}var u=o.getCaps().instancedArrays&&a.visibleInstances[i._id]!==null;if(t.isReady(i,u)){o.enableEffect(t._effect);r._bind(i,t._effect,e.Material.TriangleFillMode);t._effect.setMatrix("viewProjection",n.getTransformMatrix());t._effect.setMatrix("view",n.getViewMatrix());if(s&&s.needAlphaTesting()){var l=s.getAlphaTestTexture();if(l){t._effect.setTexture("diffuseSampler",l);t._effect.setMatrix("diffuseMatrix",l.getTextureMatrix())}}if(r.useBones&&r.computeBonesUsingShaders&&r.skeleton){t._effect.setMatrices("mBones",r.skeleton.getTransformMatrices(r))}r._processRendering(i,t._effect,e.Material.TriangleFillMode,a,u,function(e,i){return t._effect.setMatrix("world",i)})}};this._multiRenderTarget.customRenderFunction=function(e,t,r,o){var s;if(o.length){i.setColorWrite(false);for(s=0;s<o.length;s++){n(o.data[s])}i.setColorWrite(true)}for(s=0;s<e.length;s++){n(e.data[s])}for(s=0;s<t.length;s++){n(t.data[s])}}};return t}();e.GeometryBufferRenderer=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c,h){var f=t.call(this,i,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],a,u,l,c,h)||this;f.color=n;f.depth=o;f.colorLevel=s;f._ownRefractionTexture=true;f.onActivateObservable.add(function(t){f._refTexture=f._refTexture||new e.Texture(r,t.getScene())});f.onApplyObservable.add(function(e){e.setColor3("baseColor",f.color);e.setFloat("depth",f.depth);e.setFloat("colorLevel",f.colorLevel);e.setTexture("refractionSampler",f._refTexture)});return f}Object.defineProperty(i.prototype,"refractionTexture",{get:function(){return this._refTexture},set:function(e){if(this._refTexture&&this._ownRefractionTexture){this._refTexture.dispose()}this._refTexture=e;this._ownRefractionTexture=false},enumerable:true,configurable:true});i.prototype.dispose=function(e){if(this._refTexture&&this._ownRefractionTexture){this._refTexture.dispose();this._refTexture=null}t.prototype.dispose.call(this,e)};return i}(e.PostProcess);e.RefractionPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(t,i,r,n,o,s){var a=e.call(this,t,"blackAndWhite",["degree"],null,i,r,n,o,s)||this;a.degree=1;a.onApplyObservable.add(function(e){e.setFloat("degree",a.degree)});return a}return t}(e.PostProcess);e.BlackAndWhitePostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l){if(l===void 0){l=e.Engine.TEXTURETYPE_UNSIGNED_INT}var c=t.call(this,i,"convolution",["kernel","screenSize"],null,n,o,s,a,u,null,l)||this;c.kernel=r;c.onApply=function(e){e.setFloat2("screenSize",c.width,c.height);e.setArray("kernel",c.kernel)};return c}i.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1];i.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0];i.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1];i.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0];i.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2];i.GaussianKernel=[0,1,0,1,1,1,0,1,0];return i}(e.PostProcess);e.ConvolutionPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(t,i,r,n,o,s,a){var u=e.call(this,t,"filter",["kernelMatrix"],null,r,n,o,s,a)||this;u.kernelMatrix=i;u.onApply=function(e){e.setMatrix("kernelMatrix",u.kernelMatrix)};return u}return t}(e.PostProcess);e.FilterPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(r,n,o,s,a,u,l,c,h){if(a===void 0){a=100}if(u===void 0){u=e.Texture.BILINEAR_SAMPLINGMODE}var f=t.call(this,r,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],n.postProcessRatio||n,o,u,l,c,"#define NUM_SAMPLES "+a)||this;f._screenCoordinates=e.Vector2.Zero();f.customMeshPosition=e.Vector3.Zero();f.useCustomMeshPosition=false;f.invert=true;f.excludedMeshes=new Array;f.exposure=.3;f.decay=.96815;f.weight=.58767;f.density=.926;h=o===null?h:o.getScene();l=h.getEngine();f._viewPort=new e.Viewport(0,0,1,1).toGlobal(l.getRenderWidth(),l.getRenderHeight());f.mesh=s!==null?s:i.CreateDefaultMesh("VolumetricLightScatteringMesh",h);f._createPass(h,n.passRatio||n);f.onActivate=function(e){if(!f.isSupported){f.dispose(e)}f.onActivate=null};f.onApplyObservable.add(function(e){f._updateMeshScreenCoordinates(h);e.setTexture("lightScatteringSampler",f._volumetricLightScatteringRTT);e.setFloat("exposure",f.exposure);e.setFloat("decay",f.decay);e.setFloat("weight",f.weight);e.setFloat("density",f.density);e.setVector2("meshPositionOnScreen",f._screenCoordinates)});return f}Object.defineProperty(i.prototype,"useDiffuseColor",{get:function(){e.Tools.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead");return false},set:function(t){e.Tools.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")},enumerable:true,configurable:true});i.prototype.getClassName=function(){return"VolumetricLightScatteringPostProcess"};i.prototype._isReady=function(t,i){var r=t.getMesh();if(r===this.mesh&&r.material){return r.material.isReady(r)}var n=[];var o=[e.VertexBuffer.PositionKind];var s=t.getMaterial();if(s){if(s.needAlphaTesting()){n.push("#define ALPHATEST")}if(r.isVerticesDataPresent(e.VertexBuffer.UVKind)){o.push(e.VertexBuffer.UVKind);n.push("#define UV1")}if(r.isVerticesDataPresent(e.VertexBuffer.UV2Kind)){o.push(e.VertexBuffer.UV2Kind);n.push("#define UV2")}}if(r.useBones&&r.computeBonesUsingShaders){o.push(e.VertexBuffer.MatricesIndicesKind);o.push(e.VertexBuffer.MatricesWeightsKind);n.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers);n.push("#define BonesPerMesh "+(r.skeleton?r.skeleton.bones.length+1:0))}else{n.push("#define NUM_BONE_INFLUENCERS 0")}if(i){n.push("#define INSTANCES");o.push("world0");o.push("world1");o.push("world2");o.push("world3")}var a=n.join("\n");if(this._cachedDefines!==a){this._cachedDefines=a;this._volumetricLightScatteringPass=r.getScene().getEngine().createEffect({vertexElement:"depth",fragmentElement:"volumetricLightScatteringPass"},o,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],a)}return this._volumetricLightScatteringPass.isReady()};i.prototype.setCustomMeshPosition=function(e){this.customMeshPosition=e};i.prototype.getCustomMeshPosition=function(){return this.customMeshPosition};i.prototype.dispose=function(e){var i=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);if(i!==-1){e.getScene().customRenderTargets.splice(i,1)}this._volumetricLightScatteringRTT.dispose();t.prototype.dispose.call(this,e)};i.prototype.getPass=function(){return this._volumetricLightScatteringRTT};i.prototype._meshExcluded=function(e){if(this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1){return true}return false};i.prototype._createPass=function(t,i){var r=this;var n=t.getEngine();this._volumetricLightScatteringRTT=new e.RenderTargetTexture("volumetricLightScatteringMap",{width:n.getRenderWidth()*i,height:n.getRenderHeight()*i},t,false,true,e.Engine.TEXTURETYPE_UNSIGNED_INT);this._volumetricLightScatteringRTT.wrapU=e.Texture.CLAMP_ADDRESSMODE;this._volumetricLightScatteringRTT.wrapV=e.Texture.CLAMP_ADDRESSMODE;this._volumetricLightScatteringRTT.renderList=null;this._volumetricLightScatteringRTT.renderParticles=false;this._volumetricLightScatteringRTT.ignoreCameraViewport=true;var o=this.getCamera();if(o){o.customRenderTargets.push(this._volumetricLightScatteringRTT)}else{t.customRenderTargets.push(this._volumetricLightScatteringRTT)}var s=function(t){var i=t.getRenderingMesh();if(r._meshExcluded(i)){return}var n=t.getMaterial();if(!n){return}var o=i.getScene();var s=o.getEngine();s.setState(n.backFaceCulling);var a=i._getInstancesRenderList(t._id);if(a.mustReturn){return}var u=s.getCaps().instancedArrays&&a.visibleInstances[t._id]!==null;if(r._isReady(t,u)){var l=r._volumetricLightScatteringPass;if(i===r.mesh){if(t.effect){l=t.effect}else{l=n.getEffect()}}s.enableEffect(l);i._bind(t,l,e.Material.TriangleFillMode);if(i===r.mesh){n.bind(i.getWorldMatrix(),i)}else{r._volumetricLightScatteringPass.setMatrix("viewProjection",o.getTransformMatrix());if(n&&n.needAlphaTesting()){var c=n.getAlphaTestTexture();r._volumetricLightScatteringPass.setTexture("diffuseSampler",c);if(c){r._volumetricLightScatteringPass.setMatrix("diffuseMatrix",c.getTextureMatrix())}}if(i.useBones&&i.computeBonesUsingShaders&&i.skeleton){r._volumetricLightScatteringPass.setMatrices("mBones",i.skeleton.getTransformMatrices(i))}}i._processRendering(t,r._volumetricLightScatteringPass,e.Material.TriangleFillMode,a,u,function(e,t){return l.setMatrix("world",t)})}};var a;var u=new e.Color4(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(function(){a=t.clearColor;t.clearColor=u});this._volumetricLightScatteringRTT.onAfterRenderObservable.add(function(){t.clearColor=a});this._volumetricLightScatteringRTT.customRenderFunction=function(i,r,n,o){var a=t.getEngine();var u;if(o.length){a.setColorWrite(false);for(u=0;u<o.length;u++){s(o.data[u])}a.setColorWrite(true)}for(u=0;u<i.length;u++){s(i.data[u])}for(u=0;u<r.length;u++){s(r.data[u])}if(n.length){for(u=0;u<n.length;u++){var l=n.data[u];var c=l.getBoundingInfo();if(c&&t.activeCamera){l._alphaIndex=l.getMesh().alphaIndex;l._distanceToCamera=c.boundingSphere.centerWorld.subtract(t.activeCamera.position).length()}}var h=n.data.slice(0,n.length);h.sort(function(e,t){if(e._alphaIndex>t._alphaIndex){return 1}if(e._alphaIndex<t._alphaIndex){return-1}if(e._distanceToCamera<t._distanceToCamera){return 1}if(e._distanceToCamera>t._distanceToCamera){return-1}return 0});a.setAlphaMode(e.Engine.ALPHA_COMBINE);for(u=0;u<h.length;u++){s(h[u])}a.setAlphaMode(e.Engine.ALPHA_DISABLE)}}};i.prototype._updateMeshScreenCoordinates=function(t){var i=t.getTransformMatrix();var r;if(this.useCustomMeshPosition){r=this.customMeshPosition}else if(this.attachedNode){r=this.attachedNode.position}else{r=this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position}var n=e.Vector3.Project(r,e.Matrix.Identity(),i,this._viewPort);this._screenCoordinates.x=n.x/this._viewPort.width;this._screenCoordinates.y=n.y/this._viewPort.height;if(this.invert)this._screenCoordinates.y=1-this._screenCoordinates.y};i.CreateDefaultMesh=function(t,i){var r=e.Mesh.CreatePlane(t,1,i);r.billboardMode=e.AbstractMesh.BILLBOARDMODE_ALL;var n=new e.StandardMaterial(t+"Material",i);n.emissiveColor=new e.Color3(1,1,1);r.material=n;return r};__decorate([e.serializeAsVector3()],i.prototype,"customMeshPosition",void 0);__decorate([e.serialize()],i.prototype,"useCustomMeshPosition",void 0);__decorate([e.serialize()],i.prototype,"invert",void 0);__decorate([e.serializeAsMeshReference()],i.prototype,"mesh",void 0);__decorate([e.serialize()],i.prototype,"excludedMeshes",void 0);__decorate([e.serialize()],i.prototype,"exposure",void 0);__decorate([e.serialize()],i.prototype,"decay",void 0);__decorate([e.serialize()],i.prototype,"weight",void 0);__decorate([e.serialize()],i.prototype,"density",void 0);return i}(e.PostProcess);e.VolumetricLightScatteringPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u){var l=t.call(this,i,"colorCorrection",null,["colorTable"],n,o,s,a,u)||this;l._colorTableTexture=new e.Texture(r,o.getScene(),true,false,e.Texture.TRILINEAR_SAMPLINGMODE);l._colorTableTexture.anisotropicFilteringLevel=1;l._colorTableTexture.wrapU=e.Texture.CLAMP_ADDRESSMODE;l._colorTableTexture.wrapV=e.Texture.CLAMP_ADDRESSMODE;l.onApply=function(e){e.setTexture("colorTable",l._colorTableTexture)};return l}return i}(e.PostProcess);e.ColorCorrectionPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t;(function(e){e[e["Hable"]=0]="Hable";e[e["Reinhard"]=1]="Reinhard";e[e["HejiDawson"]=2]="HejiDawson";e[e["Photographic"]=3]="Photographic"})(t=e.TonemappingOperator||(e.TonemappingOperator={}));var i=function(i){__extends(r,i);function r(r,n,o,s,a,u,l){if(a===void 0){a=e.Texture.BILINEAR_SAMPLINGMODE}if(l===void 0){l=e.Engine.TEXTURETYPE_UNSIGNED_INT}var c=i.call(this,r,"tonemap",["_ExposureAdjustment"],null,1,s,a,u,true,null,l)||this;c._operator=n;c.exposureAdjustment=o;var h="#define ";if(c._operator===t.Hable)h+="HABLE_TONEMAPPING";else if(c._operator===t.Reinhard)h+="REINHARD_TONEMAPPING";else if(c._operator===t.HejiDawson)h+="OPTIMIZED_HEJIDAWSON_TONEMAPPING";else if(c._operator===t.Photographic)h+="PHOTOGRAPHIC_TONEMAPPING";c.updateEffect(h);c.onApply=function(e){e.setFloat("_ExposureAdjustment",c.exposureAdjustment)};return c}return r}(e.PostProcess);e.TonemapPostProcess=i})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(t,i,r,n,o,s){return e.call(this,t,"displayPass",["passSampler"],["passSampler"],i,r,n,o,s)||this}return t}(e.PostProcess);e.DisplayPassPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u){if(u===void 0){u=e.Engine.TEXTURETYPE_UNSIGNED_INT}return t.call(this,i,"highlights",null,null,r,n,o,s,a,null,u)||this}return i}(e.PostProcess);e.HighlightsPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l){if(n===void 0){n=null}if(u===void 0){u=e.Engine.TEXTURETYPE_UNSIGNED_INT}var c=t.call(this,i,"imageProcessing",[],[],r,n,o,s,a,null,u,"postprocess",null,true)||this;c._fromLinearSpace=true;c._defines={IMAGEPROCESSING:false,VIGNETTE:false,VIGNETTEBLENDMODEMULTIPLY:false,VIGNETTEBLENDMODEOPAQUE:false,TONEMAPPING:false,CONTRAST:false,COLORCURVES:false,COLORGRADING:false,COLORGRADING3D:false,FROMLINEARSPACE:false,SAMPLER3DGREENDEPTH:false,SAMPLER3DBGRMAP:false,IMAGEPROCESSINGPOSTPROCESS:false,EXPOSURE:false};if(l){l.applyByPostProcess=true;c._attachImageProcessingConfiguration(l,true);c.fromLinearSpace=false}else{c._attachImageProcessingConfiguration(null,true);c.imageProcessingConfiguration.applyByPostProcess=true}c.onApply=function(e){c.imageProcessingConfiguration.bind(e,c.aspectRatio)};return c}Object.defineProperty(i.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e)},enumerable:true,configurable:true});i.prototype._attachImageProcessingConfiguration=function(t,i){var r=this;if(i===void 0){i=false}if(t===this._imageProcessingConfiguration){return}if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}if(!t){var n=null;var o=this.getEngine();var s=this.getCamera();if(s){n=s.getScene()}else if(o&&o.scenes){var a=o.scenes;n=a[a.length-1]}else{n=e.Engine.LastCreatedScene}this._imageProcessingConfiguration=n.imageProcessingConfiguration}else{this._imageProcessingConfiguration=t}this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(e){r._updateParameters()});if(!i){this._updateParameters()}};Object.defineProperty(i.prototype,"colorCurves",{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(e){this.imageProcessingConfiguration.colorCurves=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"colorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"colorGradingTexture",{get:function(){return this.imageProcessingConfiguration.colorGradingTexture},set:function(e){this.imageProcessingConfiguration.colorGradingTexture=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"colorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"exposure",{get:function(){return this.imageProcessingConfiguration.exposure},set:function(e){this.imageProcessingConfiguration.exposure=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"toneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"contrast",{get:function(){return this.imageProcessingConfiguration.contrast},set:function(e){this.imageProcessingConfiguration.contrast=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"vignetteStretch",{get:function(){return this.imageProcessingConfiguration.vignetteStretch},set:function(e){this.imageProcessingConfiguration.vignetteStretch=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"vignetteCentreX",{get:function(){return this.imageProcessingConfiguration.vignetteCentreX},set:function(e){this.imageProcessingConfiguration.vignetteCentreX=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"vignetteCentreY",{get:function(){return this.imageProcessingConfiguration.vignetteCentreY},set:function(e){this.imageProcessingConfiguration.vignetteCentreY=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"vignetteWeight",{get:function(){return this.imageProcessingConfiguration.vignetteWeight},set:function(e){this.imageProcessingConfiguration.vignetteWeight=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"vignetteColor",{get:function(){return this.imageProcessingConfiguration.vignetteColor},set:function(e){this.imageProcessingConfiguration.vignetteColor=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"vignetteCameraFov",{get:function(){return this.imageProcessingConfiguration.vignetteCameraFov},set:function(e){this.imageProcessingConfiguration.vignetteCameraFov=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"vignetteBlendMode",{get:function(){return this.imageProcessingConfiguration.vignetteBlendMode},set:function(e){this.imageProcessingConfiguration.vignetteBlendMode=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"vignetteEnabled",{get:function(){return this.imageProcessingConfiguration.vignetteEnabled},set:function(e){this.imageProcessingConfiguration.vignetteEnabled=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"fromLinearSpace",{get:function(){return this._fromLinearSpace},set:function(e){if(this._fromLinearSpace===e){return}this._fromLinearSpace=e;this._updateParameters()},enumerable:true,configurable:true});i.prototype.getClassName=function(){return"ImageProcessingPostProcess"};i.prototype._updateParameters=function(){this._defines.FROMLINEARSPACE=this._fromLinearSpace;this.imageProcessingConfiguration.prepareDefines(this._defines,true);var t="";for(var i in this._defines){if(this._defines[i]){t+="#define "+i+";\r\n"}}var r=["textureSampler"];e.ImageProcessingConfiguration.PrepareSamplers(r,this._defines);var n=["scale"];e.ImageProcessingConfiguration.PrepareUniforms(n,this._defines);this.updateEffect(t,n,r)};i.prototype.dispose=function(e){t.prototype.dispose.call(this,e);if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}this.imageProcessingConfiguration.applyByPostProcess=false};__decorate([e.serialize()],i.prototype,"_fromLinearSpace",void 0);return i}(e.PostProcess);e.ImageProcessingPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u){if(n===void 0){n=null}if(o===void 0){o=null}if(s===void 0){s=null}if(a===void 0){a=null}if(u===void 0){u=null}var l=t.call(this,i,r.getScene())||this;l.name=i;l.children=new Array;l.animations=new Array;l._index=null;l._worldTransform=new e.Matrix;l._absoluteTransform=new e.Matrix;l._invertedAbsoluteTransform=new e.Matrix;l._scaleMatrix=e.Matrix.Identity();l._scaleVector=e.Vector3.One();l._negateScaleChildren=e.Vector3.One();l._scalingDeterminant=1;l._skeleton=r;l._localMatrix=o?o:e.Matrix.Identity();l._restPose=s?s:l._localMatrix.clone();l._baseMatrix=a?a:l._localMatrix.clone();l._index=u;r.bones.push(l);l.setParent(n,false);l._updateDifferenceMatrix();return l}Object.defineProperty(i.prototype,"_matrix",{get:function(){return this._localMatrix},set:function(e){if(this._localMatrix){this._localMatrix.copyFrom(e)}else{this._localMatrix=e}},enumerable:true,configurable:true});i.prototype.getSkeleton=function(){return this._skeleton};i.prototype.getParent=function(){return this._parent};i.prototype.setParent=function(e,t){if(t===void 0){t=true}if(this._parent===e){return}if(this._parent){var i=this._parent.children.indexOf(this);if(i!==-1){this._parent.children.splice(i,1)}}this._parent=e;if(this._parent){this._parent.children.push(this)}if(t){this._updateDifferenceMatrix()}};i.prototype.getLocalMatrix=function(){return this._localMatrix};i.prototype.getBaseMatrix=function(){return this._baseMatrix};i.prototype.getRestPose=function(){return this._restPose};i.prototype.returnToRest=function(){this.updateMatrix(this._restPose.clone())};i.prototype.getWorldMatrix=function(){return this._worldTransform};i.prototype.getInvertedAbsoluteTransform=function(){return this._invertedAbsoluteTransform};i.prototype.getAbsoluteTransform=function(){return this._absoluteTransform};Object.defineProperty(i.prototype,"position",{get:function(){return this.getPosition()},set:function(e){this.setPosition(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rotation",{get:function(){return this.getRotation()},set:function(e){this.setRotation(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rotationQuaternion",{get:function(){return this.getRotationQuaternion()},set:function(e){this.setRotationQuaternion(e)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"scaling",{get:function(){return this.getScale()},set:function(e){this.setScale(e.x,e.y,e.z)},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"animationPropertiesOverride",{get:function(){return this._skeleton.animationPropertiesOverride},enumerable:true,configurable:true});i.prototype.updateMatrix=function(e,t){if(t===void 0){t=true}this._baseMatrix=e.clone();this._localMatrix=e.clone();this._skeleton._markAsDirty();if(t){this._updateDifferenceMatrix()}};i.prototype._updateDifferenceMatrix=function(e){if(!e){e=this._baseMatrix}if(this._parent){e.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform)}else{this._absoluteTransform.copyFrom(e)}this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform);for(var t=0;t<this.children.length;t++){this.children[t]._updateDifferenceMatrix()}this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1};i.prototype.markAsDirty=function(){this._currentRenderId++;this._childRenderId++;this._skeleton._markAsDirty()};i.prototype.copyAnimationRange=function(t,i,r,n,o){if(n===void 0){n=false}if(o===void 0){o=null}if(this.animations.length===0){this.animations.push(new e.Animation(this.name,"_matrix",t.animations[0].framePerSecond,e.Animation.ANIMATIONTYPE_MATRIX,0));this.animations[0].setKeys([])}var s=t.animations[0].getRange(i);if(!s){return false}var a=s.from;var u=s.to;var l=t.animations[0].getKeys();var c=t.length;var h=t.getParent();var f=this.getParent();var d=n&&h&&c&&this.length&&c!==this.length;var p=d&&f&&h?f.length/h.length:1;var _=n&&!f&&o&&(o.x!==1||o.y!==1||o.z!==1);var m=this.animations[0].getKeys();var g;var v;var y;for(var b=0,x=l.length;b<x;b++){g=l[b];if(g.frame>=a&&g.frame<=u){if(n){y=g.value.clone();if(d){v=y.getTranslation();y.setTranslation(v.scaleInPlace(p))}else if(_&&o){v=y.getTranslation();y.setTranslation(v.multiplyInPlace(o))}else{y=g.value}}else{y=g.value}m.push({frame:g.frame+r,value:y})}}this.animations[0].createRange(i,a+r,u+r);return true};i.prototype.translate=function(t,r,n){if(r===void 0){r=e.Space.LOCAL}var o=this.getLocalMatrix();if(r==e.Space.LOCAL){o.m[12]+=t.x;o.m[13]+=t.y;o.m[14]+=t.z}else{var s=null;if(n){s=n.getWorldMatrix()}this._skeleton.computeAbsoluteTransforms();var a=i._tmpMats[0];var u=i._tmpVecs[0];if(this._parent){if(n&&s){a.copyFrom(this._parent.getAbsoluteTransform());a.multiplyToRef(s,a)}else{a.copyFrom(this._parent.getAbsoluteTransform())}}a.m[12]=0;a.m[13]=0;a.m[14]=0;a.invert();e.Vector3.TransformCoordinatesToRef(t,a,u);o.m[12]+=u.x;o.m[13]+=u.y;o.m[14]+=u.z}this.markAsDirty()};i.prototype.setPosition=function(t,r,n){if(r===void 0){r=e.Space.LOCAL}var o=this.getLocalMatrix();if(r==e.Space.LOCAL){o.m[12]=t.x;o.m[13]=t.y;o.m[14]=t.z}else{var s=null;if(n){s=n.getWorldMatrix()}this._skeleton.computeAbsoluteTransforms();var a=i._tmpMats[0];var u=i._tmpVecs[0];if(this._parent){if(n&&s){a.copyFrom(this._parent.getAbsoluteTransform());a.multiplyToRef(s,a)}else{a.copyFrom(this._parent.getAbsoluteTransform())}}a.invert();e.Vector3.TransformCoordinatesToRef(t,a,u);o.m[12]=u.x;o.m[13]=u.y;o.m[14]=u.z}this.markAsDirty()};i.prototype.setAbsolutePosition=function(t,i){this.setPosition(t,e.Space.WORLD,i)};i.prototype.setScale=function(e,t,i,r){if(r===void 0){r=false}if(this.animations[0]&&!this.animations[0].hasRunningRuntimeAnimations){if(!r){this._negateScaleChildren.x=1/e;this._negateScaleChildren.y=1/t;this._negateScaleChildren.z=1/i}this._syncScaleVector()}this.scale(e/this._scaleVector.x,t/this._scaleVector.y,i/this._scaleVector.z,r)};i.prototype.scale=function(t,r,n,o){if(o===void 0){o=false}var s=this.getLocalMatrix();var a=i._tmpMats[0];a.copyFrom(s);var u=i._tmpMats[1];u.copyFrom(a);u.invert();var l=i._tmpMats[2];e.Matrix.FromValuesToRef(t,0,0,0,0,r,0,0,0,0,n,0,0,0,0,1,l);this._scaleMatrix.multiplyToRef(l,this._scaleMatrix);this._scaleVector.x*=t;this._scaleVector.y*=r;this._scaleVector.z*=n;s.multiplyToRef(u,s);s.multiplyToRef(l,s);s.multiplyToRef(a,s);var c=this.getParent();if(c){s.multiplyToRef(c.getAbsoluteTransform(),this.getAbsoluteTransform())}else{this.getAbsoluteTransform().copyFrom(s)}var h=this.children.length;l.invert();for(var f=0;f<h;f++){var d=this.children[f];var p=d.getLocalMatrix();p.multiplyToRef(l,p);var _=d.getLocalMatrix();_.m[12]*=t;_.m[13]*=r;_.m[14]*=n}this.computeAbsoluteTransforms();if(o){for(var f=0;f<h;f++){this.children[f].scale(t,r,n,o)}}this.markAsDirty()};i.prototype.setYawPitchRoll=function(t,r,n,o,s){if(o===void 0){o=e.Space.LOCAL}var a=i._tmpMats[0];e.Matrix.RotationYawPitchRollToRef(t,r,n,a);var u=i._tmpMats[1];this._getNegativeRotationToRef(u,o,s);u.multiplyToRef(a,a);this._rotateWithMatrix(a,o,s)};i.prototype.rotate=function(t,r,n,o){if(n===void 0){n=e.Space.LOCAL}var s=i._tmpMats[0];s.m[12]=0;s.m[13]=0;s.m[14]=0;e.Matrix.RotationAxisToRef(t,r,s);this._rotateWithMatrix(s,n,o)};i.prototype.setAxisAngle=function(t,r,n,o){if(n===void 0){n=e.Space.LOCAL}var s=i._tmpMats[0];e.Matrix.RotationAxisToRef(t,r,s);var a=i._tmpMats[1];this._getNegativeRotationToRef(a,n,o);a.multiplyToRef(s,s);this._rotateWithMatrix(s,n,o)};i.prototype.setRotation=function(t,i,r){if(i===void 0){i=e.Space.LOCAL}this.setYawPitchRoll(t.y,t.x,t.z,i,r)};i.prototype.setRotationQuaternion=function(t,r,n){if(r===void 0){r=e.Space.LOCAL}var o=i._tmpMats[0];this._getNegativeRotationToRef(o,r,n);var s=i._tmpMats[1];e.Matrix.FromQuaternionToRef(t,s);o.multiplyToRef(s,s);this._rotateWithMatrix(s,r,n)};i.prototype.setRotationMatrix=function(t,r,n){if(r===void 0){r=e.Space.LOCAL}var o=i._tmpMats[0];this._getNegativeRotationToRef(o,r,n);var s=i._tmpMats[1];s.copyFrom(t);o.multiplyToRef(t,s);this._rotateWithMatrix(s,r,n)};i.prototype._rotateWithMatrix=function(t,r,n){if(r===void 0){r=e.Space.LOCAL}var o=this.getLocalMatrix();var s=o.m[12];var a=o.m[13];var u=o.m[14];var l=this.getParent();var c=i._tmpMats[3];var h=i._tmpMats[4];if(l){if(r==e.Space.WORLD){if(n){c.copyFrom(n.getWorldMatrix());l.getAbsoluteTransform().multiplyToRef(c,c)}else{c.copyFrom(l.getAbsoluteTransform())}}else{c=l._scaleMatrix}h.copyFrom(c);h.invert();o.multiplyToRef(c,o);o.multiplyToRef(t,o);o.multiplyToRef(h,o)}else{if(r==e.Space.WORLD&&n){c.copyFrom(n.getWorldMatrix());h.copyFrom(c);h.invert();o.multiplyToRef(c,o);o.multiplyToRef(t,o);o.multiplyToRef(h,o)}else{o.multiplyToRef(t,o)}}o.m[12]=s;o.m[13]=a;o.m[14]=u;this.computeAbsoluteTransforms();this.markAsDirty()};i.prototype._getNegativeRotationToRef=function(t,r,n){if(r===void 0){r=e.Space.LOCAL}if(r==e.Space.WORLD){var o=i._tmpMats[2];o.copyFrom(this._scaleMatrix);t.copyFrom(this.getAbsoluteTransform());if(n){t.multiplyToRef(n.getWorldMatrix(),t);var s=i._tmpMats[3];e.Matrix.ScalingToRef(n.scaling.x,n.scaling.y,n.scaling.z,s);o.multiplyToRef(s,o)}t.invert();o.m[0]*=this._scalingDeterminant;t.multiplyToRef(o,t)}else{t.copyFrom(this.getLocalMatrix());t.invert();var o=i._tmpMats[2];o.copyFrom(this._scaleMatrix);if(this._parent){var a=i._tmpMats[3];a.copyFrom(this._parent._scaleMatrix);a.invert();a.multiplyToRef(t,t)}else{o.m[0]*=this._scalingDeterminant}t.multiplyToRef(o,t)}};i.prototype.getScale=function(){return this._scaleVector.clone()};i.prototype.getScaleToRef=function(e){e.copyFrom(this._scaleVector)};i.prototype.getPosition=function(t,i){if(t===void 0){t=e.Space.LOCAL}if(i===void 0){i=null}var r=e.Vector3.Zero();this.getPositionToRef(t,i,r);return r};i.prototype.getPositionToRef=function(t,r,n){if(t===void 0){t=e.Space.LOCAL}if(t==e.Space.LOCAL){var o=this.getLocalMatrix();n.x=o.m[12];n.y=o.m[13];n.z=o.m[14]}else{var s=null;if(r){s=r.getWorldMatrix()}this._skeleton.computeAbsoluteTransforms();var a=i._tmpMats[0];if(r&&s){a.copyFrom(this.getAbsoluteTransform());a.multiplyToRef(s,a)}else{a=this.getAbsoluteTransform()}n.x=a.m[12];n.y=a.m[13];n.z=a.m[14]}};i.prototype.getAbsolutePosition=function(t){if(t===void 0){t=null}var i=e.Vector3.Zero();this.getPositionToRef(e.Space.WORLD,t,i);return i};i.prototype.getAbsolutePositionToRef=function(t,i){this.getPositionToRef(e.Space.WORLD,t,i)};i.prototype.computeAbsoluteTransforms=function(){if(this._parent){this._localMatrix.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform)}else{this._absoluteTransform.copyFrom(this._localMatrix);var e=this._skeleton.getPoseMatrix();if(e){this._absoluteTransform.multiplyToRef(e,this._absoluteTransform)}}var t=this.children;var i=t.length;for(var r=0;r<i;r++){t[r].computeAbsoluteTransforms()}};i.prototype._syncScaleVector=function(){var t=this.getLocalMatrix();var i=t.m[0]*t.m[0]+t.m[1]*t.m[1]+t.m[2]*t.m[2];var r=t.m[4]*t.m[4]+t.m[5]*t.m[5]+t.m[6]*t.m[6];var n=t.m[8]*t.m[8]+t.m[9]*t.m[9]+t.m[10]*t.m[10];var o=t.m[0]*t.m[1]*t.m[2]*t.m[3]<0?-1:1;var s=t.m[4]*t.m[5]*t.m[6]*t.m[7]<0?-1:1;var a=t.m[8]*t.m[9]*t.m[10]*t.m[11]<0?-1:1;this._scaleVector.x=o*Math.sqrt(i);this._scaleVector.y=s*Math.sqrt(r);this._scaleVector.z=a*Math.sqrt(n);if(this._parent){
this._scaleVector.x/=this._parent._negateScaleChildren.x;this._scaleVector.y/=this._parent._negateScaleChildren.y;this._scaleVector.z/=this._parent._negateScaleChildren.z}e.Matrix.FromValuesToRef(this._scaleVector.x,0,0,0,0,this._scaleVector.y,0,0,0,0,this._scaleVector.z,0,0,0,0,1,this._scaleMatrix)};i.prototype.getDirection=function(t,i){if(i===void 0){i=null}var r=e.Vector3.Zero();this.getDirectionToRef(t,i,r);return r};i.prototype.getDirectionToRef=function(t,r,n){if(r===void 0){r=null}var o=null;if(r){o=r.getWorldMatrix()}this._skeleton.computeAbsoluteTransforms();var s=i._tmpMats[0];s.copyFrom(this.getAbsoluteTransform());if(r&&o){s.multiplyToRef(o,s)}e.Vector3.TransformNormalToRef(t,s,n);n.normalize()};i.prototype.getRotation=function(t,i){if(t===void 0){t=e.Space.LOCAL}if(i===void 0){i=null}var r=e.Vector3.Zero();this.getRotationToRef(t,i,r);return r};i.prototype.getRotationToRef=function(t,r,n){if(t===void 0){t=e.Space.LOCAL}if(r===void 0){r=null}var o=i._tmpQuat;this.getRotationQuaternionToRef(t,r,o);o.toEulerAnglesToRef(n)};i.prototype.getRotationQuaternion=function(t,i){if(t===void 0){t=e.Space.LOCAL}if(i===void 0){i=null}var r=e.Quaternion.Identity();this.getRotationQuaternionToRef(t,i,r);return r};i.prototype.getRotationQuaternionToRef=function(t,r,n){if(t===void 0){t=e.Space.LOCAL}if(r===void 0){r=null}if(t==e.Space.LOCAL){this.getLocalMatrix().decompose(i._tmpVecs[0],n,i._tmpVecs[1])}else{var o=i._tmpMats[0];var s=this.getAbsoluteTransform();if(r){s.multiplyToRef(r.getWorldMatrix(),o)}else{o.copyFrom(s)}o.m[0]*=this._scalingDeterminant;o.m[1]*=this._scalingDeterminant;o.m[2]*=this._scalingDeterminant;o.decompose(i._tmpVecs[0],n,i._tmpVecs[1])}};i.prototype.getRotationMatrix=function(t,i){if(t===void 0){t=e.Space.LOCAL}var r=e.Matrix.Identity();this.getRotationMatrixToRef(t,i,r);return r};i.prototype.getRotationMatrixToRef=function(t,r,n){if(t===void 0){t=e.Space.LOCAL}if(t==e.Space.LOCAL){this.getLocalMatrix().getRotationMatrixToRef(n)}else{var o=i._tmpMats[0];var s=this.getAbsoluteTransform();if(r){s.multiplyToRef(r.getWorldMatrix(),o)}else{o.copyFrom(s)}o.m[0]*=this._scalingDeterminant;o.m[1]*=this._scalingDeterminant;o.m[2]*=this._scalingDeterminant;o.getRotationMatrixToRef(n)}};i.prototype.getAbsolutePositionFromLocal=function(t,i){if(i===void 0){i=null}var r=e.Vector3.Zero();this.getAbsolutePositionFromLocalToRef(t,i,r);return r};i.prototype.getAbsolutePositionFromLocalToRef=function(t,r,n){if(r===void 0){r=null}var o=null;if(r){o=r.getWorldMatrix()}this._skeleton.computeAbsoluteTransforms();var s=i._tmpMats[0];if(r&&o){s.copyFrom(this.getAbsoluteTransform());s.multiplyToRef(o,s)}else{s=this.getAbsoluteTransform()}e.Vector3.TransformCoordinatesToRef(t,s,n)};i.prototype.getLocalPositionFromAbsolute=function(t,i){if(i===void 0){i=null}var r=e.Vector3.Zero();this.getLocalPositionFromAbsoluteToRef(t,i,r);return r};i.prototype.getLocalPositionFromAbsoluteToRef=function(t,r,n){if(r===void 0){r=null}var o=null;if(r){o=r.getWorldMatrix()}this._skeleton.computeAbsoluteTransforms();var s=i._tmpMats[0];s.copyFrom(this.getAbsoluteTransform());if(r&&o){s.multiplyToRef(o,s)}s.invert();e.Vector3.TransformCoordinatesToRef(t,s,n)};i._tmpVecs=[e.Vector3.Zero(),e.Vector3.Zero()];i._tmpQuat=e.Quaternion.Identity();i._tmpMats=[e.Matrix.Identity(),e.Matrix.Identity(),e.Matrix.Identity(),e.Matrix.Identity(),e.Matrix.Identity()];return i}(e.Node);e.Bone=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r){this.targetPosition=e.Vector3.Zero();this.poleTargetPosition=e.Vector3.Zero();this.poleTargetLocalOffset=e.Vector3.Zero();this.poleAngle=0;this.slerpAmount=1;this._bone1Quat=e.Quaternion.Identity();this._bone1Mat=e.Matrix.Identity();this._bone2Ang=Math.PI;this._maxAngle=Math.PI;this._rightHandedSystem=false;this._bendAxis=e.Vector3.Right();this._slerping=false;this._adjustRoll=0;this._bone2=i;this._bone1=i.getParent();if(!this._bone1){return}this.mesh=t;var n=i.getPosition();if(i.getAbsoluteTransform().determinant()>0){this._rightHandedSystem=true;this._bendAxis.x=0;this._bendAxis.y=0;this._bendAxis.z=-1;if(n.x>n.y&&n.x>n.z){this._adjustRoll=Math.PI*.5;this._bendAxis.z=1}}if(this._bone1.length){var o=this._bone1.getScale();var s=this._bone2.getScale();this._bone1Length=this._bone1.length*o.y*this.mesh.scaling.y;this._bone2Length=this._bone2.length*s.y*this.mesh.scaling.y}else if(this._bone1.children[0]){t.computeWorldMatrix(true);var a=this._bone2.children[0].getAbsolutePosition(t);var u=this._bone2.getAbsolutePosition(t);var l=this._bone1.getAbsolutePosition(t);this._bone1Length=e.Vector3.Distance(a,u);this._bone2Length=e.Vector3.Distance(u,l)}this._bone1.getRotationMatrixToRef(e.Space.WORLD,t,this._bone1Mat);this.maxAngle=Math.PI;if(r){if(r.targetMesh){this.targetMesh=r.targetMesh;this.targetMesh.computeWorldMatrix(true)}if(r.poleTargetMesh){this.poleTargetMesh=r.poleTargetMesh;this.poleTargetMesh.computeWorldMatrix(true)}else if(r.poleTargetBone){this.poleTargetBone=r.poleTargetBone}else if(this._bone1.getParent()){this.poleTargetBone=this._bone1.getParent()}if(r.poleTargetLocalOffset){this.poleTargetLocalOffset.copyFrom(r.poleTargetLocalOffset)}if(r.poleAngle){this.poleAngle=r.poleAngle}if(r.bendAxis){this._bendAxis.copyFrom(r.bendAxis)}if(r.maxAngle){this.maxAngle=r.maxAngle}if(r.slerpAmount){this.slerpAmount=r.slerpAmount}}}Object.defineProperty(t.prototype,"maxAngle",{get:function(){return this._maxAngle},set:function(e){this._setMaxAngle(e)},enumerable:true,configurable:true});t.prototype._setMaxAngle=function(e){if(e<0){e=0}if(e>Math.PI||e==undefined){e=Math.PI}this._maxAngle=e;var t=this._bone1Length;var i=this._bone2Length;this._maxReach=Math.sqrt(t*t+i*i-2*t*i*Math.cos(e))};t.prototype.update=function(){var i=this._bone1;if(!i){return}var r=this.targetPosition;var n=this.poleTargetPosition;var o=t._tmpMats[0];var s=t._tmpMats[1];if(this.targetMesh){r.copyFrom(this.targetMesh.getAbsolutePosition())}if(this.poleTargetBone){this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,n)}else if(this.poleTargetMesh){e.Vector3.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),n)}var a=t._tmpVecs[0];var u=t._tmpVecs[1];var l=t._tmpVecs[2];var c=t._tmpVecs[3];var h=t._tmpVecs[4];var f=t._tmpQuat;i.getAbsolutePositionToRef(this.mesh,a);n.subtractToRef(a,h);if(h.x==0&&h.y==0&&h.z==0){h.y=1}else{h.normalize()}r.subtractToRef(a,c);c.normalize();e.Vector3.CrossToRef(c,h,u);u.normalize();e.Vector3.CrossToRef(c,u,l);l.normalize();e.Matrix.FromXYZAxesToRef(l,c,u,o);var d=this._bone1Length;var p=this._bone2Length;var _=e.Vector3.Distance(a,r);if(this._maxReach>0){_=Math.min(this._maxReach,_)}var m=(p*p+_*_-d*d)/(2*p*_);var g=(_*_+d*d-p*p)/(2*_*d);if(m>1){m=1}if(g>1){g=1}if(m<-1){m=-1}if(g<-1){g=-1}var v=Math.acos(m);var y=Math.acos(g);var b=-v-y;if(this._rightHandedSystem){e.Matrix.RotationYawPitchRollToRef(0,0,this._adjustRoll,s);s.multiplyToRef(o,o);e.Matrix.RotationAxisToRef(this._bendAxis,y,s);s.multiplyToRef(o,o)}else{var x=t._tmpVecs[5];x.copyFrom(this._bendAxis);x.x*=-1;e.Matrix.RotationAxisToRef(x,-y,s);s.multiplyToRef(o,o)}if(this.poleAngle){e.Matrix.RotationAxisToRef(c,this.poleAngle,s);o.multiplyToRef(s,o)}if(this._bone1){if(this.slerpAmount<1){if(!this._slerping){e.Quaternion.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat)}e.Quaternion.FromRotationMatrixToRef(o,f);e.Quaternion.SlerpToRef(this._bone1Quat,f,this.slerpAmount,this._bone1Quat);b=this._bone2Ang*(1-this.slerpAmount)+b*this.slerpAmount;this._bone1.setRotationQuaternion(this._bone1Quat,e.Space.WORLD,this.mesh);this._slerping=true}else{this._bone1.setRotationMatrix(o,e.Space.WORLD,this.mesh);this._bone1Mat.copyFrom(o);this._slerping=false}}this._bone2.setAxisAngle(this._bendAxis,b,e.Space.LOCAL);this._bone2Ang=b};t._tmpVecs=[e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero()];t._tmpQuat=e.Quaternion.Identity();t._tmpMats=[e.Matrix.Identity(),e.Matrix.Identity()];return t}();e.BoneIKController=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r,n){this.upAxis=e.Vector3.Up();this.upAxisSpace=e.Space.LOCAL;this.adjustYaw=0;this.adjustPitch=0;this.adjustRoll=0;this.slerpAmount=1;this._boneQuat=e.Quaternion.Identity();this._slerping=false;this._firstFrameSkipped=false;this._fowardAxis=e.Vector3.Forward();this.mesh=t;this.bone=i;this.target=r;if(n){if(n.adjustYaw){this.adjustYaw=n.adjustYaw}if(n.adjustPitch){this.adjustPitch=n.adjustPitch}if(n.adjustRoll){this.adjustRoll=n.adjustRoll}if(n.maxYaw!=null){this.maxYaw=n.maxYaw}else{this.maxYaw=Math.PI}if(n.minYaw!=null){this.minYaw=n.minYaw}else{this.minYaw=-Math.PI}if(n.maxPitch!=null){this.maxPitch=n.maxPitch}else{this.maxPitch=Math.PI}if(n.minPitch!=null){this.minPitch=n.minPitch}else{this.minPitch=-Math.PI}if(n.slerpAmount!=null){this.slerpAmount=n.slerpAmount}if(n.upAxis!=null){this.upAxis=n.upAxis}if(n.upAxisSpace!=null){this.upAxisSpace=n.upAxisSpace}if(n.yawAxis!=null||n.pitchAxis!=null){var o=e.Axis.Y;var s=e.Axis.X;if(n.yawAxis!=null){o=n.yawAxis.clone();o.normalize()}if(n.pitchAxis!=null){s=n.pitchAxis.clone();s.normalize()}var a=e.Vector3.Cross(s,o);this._transformYawPitch=e.Matrix.Identity();e.Matrix.FromXYZAxesToRef(s,o,a,this._transformYawPitch);this._transformYawPitchInv=this._transformYawPitch.clone();this._transformYawPitch.invert()}}if(!i.getParent()&&this.upAxisSpace==e.Space.BONE){this.upAxisSpace=e.Space.LOCAL}}Object.defineProperty(t.prototype,"minYaw",{get:function(){return this._minYaw},set:function(e){this._minYaw=e;this._minYawSin=Math.sin(e);this._minYawCos=Math.cos(e);if(this._maxYaw!=null){this._midYawConstraint=this._getAngleDiff(this._minYaw,this._maxYaw)*.5+this._minYaw;this._yawRange=this._maxYaw-this._minYaw}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"maxYaw",{get:function(){return this._maxYaw},set:function(e){this._maxYaw=e;this._maxYawSin=Math.sin(e);this._maxYawCos=Math.cos(e);if(this._minYaw!=null){this._midYawConstraint=this._getAngleDiff(this._minYaw,this._maxYaw)*.5+this._minYaw;this._yawRange=this._maxYaw-this._minYaw}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"minPitch",{get:function(){return this._minPitch},set:function(e){this._minPitch=e;this._minPitchTan=Math.tan(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"maxPitch",{get:function(){return this._maxPitch},set:function(e){this._maxPitch=e;this._maxPitchTan=Math.tan(e)},enumerable:true,configurable:true});t.prototype.update=function(){if(this.slerpAmount<1&&!this._firstFrameSkipped){this._firstFrameSkipped=true;return}var i=this.bone;var r=t._tmpVecs[0];i.getAbsolutePositionToRef(this.mesh,r);var n=this.target;var o=t._tmpMats[0];var s=t._tmpMats[1];var a=this.mesh;var u=i.getParent();var l=t._tmpVecs[1];l.copyFrom(this.upAxis);if(this.upAxisSpace==e.Space.BONE&&u){if(this._transformYawPitch){e.Vector3.TransformCoordinatesToRef(l,this._transformYawPitchInv,l)}u.getDirectionToRef(l,this.mesh,l)}else if(this.upAxisSpace==e.Space.LOCAL){a.getDirectionToRef(l,l);if(a.scaling.x!=1||a.scaling.y!=1||a.scaling.z!=1){l.normalize()}}var c=false;var h=false;if(this._maxYaw!=Math.PI||this._minYaw!=-Math.PI){c=true}if(this._maxPitch!=Math.PI||this._minPitch!=-Math.PI){h=true}if(c||h){var f=t._tmpMats[2];var d=t._tmpMats[3];if(this.upAxisSpace==e.Space.BONE&&l.y==1&&u){u.getRotationMatrixToRef(e.Space.WORLD,this.mesh,f)}else if(this.upAxisSpace==e.Space.LOCAL&&l.y==1&&!u){f.copyFrom(a.getWorldMatrix())}else{var p=t._tmpVecs[2];p.copyFrom(this._fowardAxis);if(this._transformYawPitch){e.Vector3.TransformCoordinatesToRef(p,this._transformYawPitchInv,p)}if(u){u.getDirectionToRef(p,this.mesh,p)}else{a.getDirectionToRef(p,p)}var _=e.Vector3.Cross(l,p);_.normalize();var p=e.Vector3.Cross(_,l);e.Matrix.FromXYZAxesToRef(_,l,p,f)}f.invertToRef(d);var m=null;if(h){var g=t._tmpVecs[3];n.subtractToRef(r,g);e.Vector3.TransformCoordinatesToRef(g,d,g);m=Math.sqrt(g.x*g.x+g.z*g.z);var v=Math.atan2(g.y,m);var y=v;if(v>this._maxPitch){g.y=this._maxPitchTan*m;y=this._maxPitch}else if(v<this._minPitch){g.y=this._minPitchTan*m;y=this._minPitch}if(v!=y){e.Vector3.TransformCoordinatesToRef(g,f,g);g.addInPlace(r);n=g}}if(c){var g=t._tmpVecs[4];n.subtractToRef(r,g);e.Vector3.TransformCoordinatesToRef(g,d,g);var b=Math.atan2(g.x,g.z);var x=b;if(b>this._maxYaw||b<this._minYaw){if(m==null){m=Math.sqrt(g.x*g.x+g.z*g.z)}if(this._yawRange>Math.PI){if(this._isAngleBetween(b,this._maxYaw,this._midYawConstraint)){g.z=this._maxYawCos*m;g.x=this._maxYawSin*m;x=this._maxYaw}else if(this._isAngleBetween(b,this._midYawConstraint,this._minYaw)){g.z=this._minYawCos*m;g.x=this._minYawSin*m;x=this._minYaw}}else{if(b>this._maxYaw){g.z=this._maxYawCos*m;g.x=this._maxYawSin*m;x=this._maxYaw}else if(b<this._minYaw){g.z=this._minYawCos*m;g.x=this._minYawSin*m;x=this._minYaw}}}if(this._slerping&&this._yawRange>Math.PI){var T=t._tmpVecs[8];T.copyFrom(e.Axis.Z);if(this._transformYawPitch){e.Vector3.TransformCoordinatesToRef(T,this._transformYawPitchInv,T)}var E=t._tmpMats[4];this._boneQuat.toRotationMatrix(E);this.mesh.getWorldMatrix().multiplyToRef(E,E);e.Vector3.TransformCoordinatesToRef(T,E,T);e.Vector3.TransformCoordinatesToRef(T,d,T);var P=Math.atan2(T.x,T.z);var A=this._getAngleBetween(P,b);var M=this._getAngleBetween(P,this._midYawConstraint);if(A>M){if(m==null){m=Math.sqrt(g.x*g.x+g.z*g.z)}var S=this._getAngleBetween(P,this._maxYaw);var C=this._getAngleBetween(P,this._minYaw);if(C<S){x=P+Math.PI*.75;g.z=Math.cos(x)*m;g.x=Math.sin(x)*m}else{x=P-Math.PI*.75;g.z=Math.cos(x)*m;g.x=Math.sin(x)*m}}}if(b!=x){e.Vector3.TransformCoordinatesToRef(g,f,g);g.addInPlace(r);n=g}}}var R=t._tmpVecs[5];var O=t._tmpVecs[6];var I=t._tmpVecs[7];var D=t._tmpQuat;n.subtractToRef(r,R);R.normalize();e.Vector3.CrossToRef(l,R,O);O.normalize();e.Vector3.CrossToRef(R,O,I);I.normalize();e.Matrix.FromXYZAxesToRef(O,I,R,o);if(O.x===0&&O.y===0&&O.z===0){return}if(I.x===0&&I.y===0&&I.z===0){return}if(R.x===0&&R.y===0&&R.z===0){return}if(this.adjustYaw||this.adjustPitch||this.adjustRoll){e.Matrix.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,s);s.multiplyToRef(o,o)}if(this.slerpAmount<1){if(!this._slerping){this.bone.getRotationQuaternionToRef(e.Space.WORLD,this.mesh,this._boneQuat)}if(this._transformYawPitch){this._transformYawPitch.multiplyToRef(o,o)}e.Quaternion.FromRotationMatrixToRef(o,D);e.Quaternion.SlerpToRef(this._boneQuat,D,this.slerpAmount,this._boneQuat);this.bone.setRotationQuaternion(this._boneQuat,e.Space.WORLD,this.mesh);this._slerping=true}else{if(this._transformYawPitch){this._transformYawPitch.multiplyToRef(o,o)}this.bone.setRotationMatrix(o,e.Space.WORLD,this.mesh);this._slerping=false}};t.prototype._getAngleDiff=function(e,t){var i=t-e;i%=Math.PI*2;if(i>Math.PI){i-=Math.PI*2}else if(i<-Math.PI){i+=Math.PI*2}return i};t.prototype._getAngleBetween=function(e,t){e%=2*Math.PI;e=e<0?e+2*Math.PI:e;t%=2*Math.PI;t=t<0?t+2*Math.PI:t;var i=0;if(e<t){i=t-e}else{i=e-t}if(i>Math.PI){i=Math.PI*2-i}return i};t.prototype._isAngleBetween=function(e,t,i){e%=2*Math.PI;e=e<0?e+2*Math.PI:e;t%=2*Math.PI;t=t<0?t+2*Math.PI:t;i%=2*Math.PI;i=i<0?i+2*Math.PI:i;if(t<i){if(e>t&&e<i){return true}}else{if(e>i&&e<t){return true}}return false};t._tmpVecs=[e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero()];t._tmpQuat=e.Quaternion.Identity();t._tmpMats=[e.Matrix.Identity(),e.Matrix.Identity(),e.Matrix.Identity(),e.Matrix.Identity(),e.Matrix.Identity()];return t}();e.BoneLookController=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r){this.name=t;this.id=i;this.bones=new Array;this.needInitialSkinMatrix=false;this._isDirty=true;this._meshesWithPoseMatrix=new Array;this._identity=e.Matrix.Identity();this._ranges={};this._lastAbsoluteTransformsUpdateId=-1;this.doNotSerialize=false;this.onBeforeComputeObservable=new e.Observable;this.bones=[];this._scene=r||e.Engine.LastCreatedScene;r.skeletons.push(this);this._isDirty=true}t.prototype.getTransformMatrices=function(e){if(this.needInitialSkinMatrix&&e._bonesTransformMatrices){return e._bonesTransformMatrices}if(!this._transformMatrices){this.prepare()}return this._transformMatrices};t.prototype.getScene=function(){return this._scene};t.prototype.toString=function(e){var t="Name: "+this.name+", nBones: "+this.bones.length;t+=", nAnimationRanges: "+(this._ranges?Object.keys(this._ranges).length:"none");if(e){t+=", Ranges: {";var i=true;for(var r in this._ranges){if(i){t+=", ";i=false}t+=r}t+="}"}return t};t.prototype.getBoneIndexByName=function(e){for(var t=0,i=this.bones.length;t<i;t++){if(this.bones[t].name===e){return t}}return-1};t.prototype.createAnimationRange=function(t,i,r){if(!this._ranges[t]){this._ranges[t]=new e.AnimationRange(t,i,r);for(var n=0,o=this.bones.length;n<o;n++){if(this.bones[n].animations[0]){this.bones[n].animations[0].createRange(t,i,r)}}}};t.prototype.deleteAnimationRange=function(e,t){if(t===void 0){t=true}for(var i=0,r=this.bones.length;i<r;i++){if(this.bones[i].animations[0]){this.bones[i].animations[0].deleteRange(e,t)}}this._ranges[e]=null};t.prototype.getAnimationRange=function(e){return this._ranges[e]};t.prototype.getAnimationRanges=function(){var e=[];var t;var i=0;for(t in this._ranges){e[i]=this._ranges[t];i++}return e};t.prototype.copyAnimationRange=function(t,i,r){if(r===void 0){r=false}if(this._ranges[i]||!t.getAnimationRange(i)){return false}var n=true;var o=this._getHighestAnimationFrame()+1;var s={};var a=t.bones;var u;var l;for(l=0,u=a.length;l<u;l++){s[a[l].name]=a[l]}if(this.bones.length!==a.length){e.Tools.Warn("copyAnimationRange: this rig has "+this.bones.length+" bones, while source as "+a.length);n=false}var c=r&&this.dimensionsAtRest&&t.dimensionsAtRest?this.dimensionsAtRest.divide(t.dimensionsAtRest):null;for(l=0,u=this.bones.length;l<u;l++){var h=this.bones[l].name;var f=s[h];if(f){n=n&&this.bones[l].copyAnimationRange(f,i,o,r,c)}else{e.Tools.Warn("copyAnimationRange: not same rig, missing source bone "+h);n=false}}var d=t.getAnimationRange(i);if(d){this._ranges[i]=new e.AnimationRange(i,d.from+o,d.to+o)}return n};t.prototype.returnToRest=function(){for(var e=0;e<this.bones.length;e++){this.bones[e].returnToRest()}};t.prototype._getHighestAnimationFrame=function(){var e=0;for(var t=0,i=this.bones.length;t<i;t++){if(this.bones[t].animations[0]){var r=this.bones[t].animations[0].getHighestFrame();if(e<r){e=r}}}return e};t.prototype.beginAnimation=function(e,t,i,r){var n=this.getAnimationRange(e);if(!n){return null}return this._scene.beginAnimation(this,n.from,n.to,t,i,r)};t.prototype._markAsDirty=function(){this._isDirty=true};t.prototype._registerMeshWithPoseMatrix=function(e){this._meshesWithPoseMatrix.push(e)};t.prototype._unregisterMeshWithPoseMatrix=function(e){var t=this._meshesWithPoseMatrix.indexOf(e);if(t>-1){this._meshesWithPoseMatrix.splice(t,1)}};t.prototype._computeTransformMatrices=function(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(var i=0;i<this.bones.length;i++){var r=this.bones[i];var n=r.getParent();if(n){r.getLocalMatrix().multiplyToRef(n.getWorldMatrix(),r.getWorldMatrix())}else{if(t){r.getLocalMatrix().multiplyToRef(t,r.getWorldMatrix())}else{r.getWorldMatrix().copyFrom(r.getLocalMatrix())}}if(r._index!==-1){var o=r._index===null?i:r._index;r.getInvertedAbsoluteTransform().multiplyToArray(r.getWorldMatrix(),e,o*16)}}this._identity.copyToArray(e,this.bones.length*16)};t.prototype.prepare=function(){if(!this._isDirty){return}if(this.needInitialSkinMatrix){for(var t=0;t<this._meshesWithPoseMatrix.length;t++){var i=this._meshesWithPoseMatrix[t];var r=i.getPoseMatrix();if(!i._bonesTransformMatrices||i._bonesTransformMatrices.length!==16*(this.bones.length+1)){i._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1))}if(this._synchronizedWithMesh!==i){this._synchronizedWithMesh=i;for(var n=0;n<this.bones.length;n++){var o=this.bones[n];if(!o.getParent()){var s=o.getBaseMatrix();s.multiplyToRef(r,e.Tmp.Matrix[1]);o._updateDifferenceMatrix(e.Tmp.Matrix[1])}}}this._computeTransformMatrices(i._bonesTransformMatrices,r)}}else{if(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1)){this._transformMatrices=new Float32Array(16*(this.bones.length+1))}this._computeTransformMatrices(this._transformMatrices,null)}this._isDirty=false;this._scene._activeBones.addCount(this.bones.length,false)};t.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(var e=0;e<this.bones.length;e++){this._animatables.push(this.bones[e])}}return this._animatables};t.prototype.clone=function(i,r){var n=new t(i,r||i,this._scene);n.needInitialSkinMatrix=this.needInitialSkinMatrix;for(var o=0;o<this.bones.length;o++){var s=this.bones[o];var a=null;var u=s.getParent();if(u){var l=this.bones.indexOf(u);a=n.bones[l]}var c=new e.Bone(s.name,n,a,s.getBaseMatrix().clone(),s.getRestPose().clone());e.Tools.DeepCopy(s.animations,c.animations)}if(this._ranges){n._ranges={};for(var h in this._ranges){var f=this._ranges[h];if(f){n._ranges[h]=f.clone()}}}this._isDirty=true;return n};t.prototype.enableBlending=function(e){if(e===void 0){e=.01}this.bones.forEach(function(t){t.animations.forEach(function(t){t.enableBlending=true;t.blendingSpeed=e})})};t.prototype.dispose=function(){this._meshesWithPoseMatrix=[];this.getScene().stopAnimation(this);this.getScene().removeSkeleton(this)};t.prototype.serialize=function(){var e={};e.name=this.name;e.id=this.id;if(this.dimensionsAtRest){e.dimensionsAtRest=this.dimensionsAtRest.asArray()}e.bones=[];e.needInitialSkinMatrix=this.needInitialSkinMatrix;for(var t=0;t<this.bones.length;t++){var i=this.bones[t];var r=i.getParent();var n={parentBoneIndex:r?this.bones.indexOf(r):-1,name:i.name,matrix:i.getBaseMatrix().toArray(),rest:i.getRestPose().toArray()};e.bones.push(n);if(i.length){n.length=i.length}if(i.animations&&i.animations.length>0){n.animation=i.animations[0].serialize()}e.ranges=[];for(var o in this._ranges){var s=this._ranges[o];if(!s){continue}var a={};a.name=o;a.from=s.from;a.to=s.to;e.ranges.push(a)}}return e};t.Parse=function(i,r){var n=new t(i.name,i.id,r);if(i.dimensionsAtRest){n.dimensionsAtRest=e.Vector3.FromArray(i.dimensionsAtRest)}n.needInitialSkinMatrix=i.needInitialSkinMatrix;var o;for(o=0;o<i.bones.length;o++){var s=i.bones[o];var a=null;if(s.parentBoneIndex>-1){a=n.bones[s.parentBoneIndex]}var u=s.rest?e.Matrix.FromArray(s.rest):null;var l=new e.Bone(s.name,n,a,e.Matrix.FromArray(s.matrix),u);if(s.length){l.length=s.length}if(s.animation){l.animations.push(e.Animation.Parse(s.animation))}}if(i.ranges){for(o=0;o<i.ranges.length;o++){var c=i.ranges[o];n.createAnimationRange(c.name,c.from,c.to)}}return n};t.prototype.computeAbsoluteTransforms=function(e){if(e===void 0){e=false}var t=this._scene.getRenderId();if(this._lastAbsoluteTransformsUpdateId!=t||e){this.bones[0].computeAbsoluteTransforms();this._lastAbsoluteTransformsUpdateId=t}};t.prototype.getPoseMatrix=function(){var e=null;if(this._meshesWithPoseMatrix.length>0){e=this._meshesWithPoseMatrix[0].getPoseMatrix()}return e};t.prototype.sortBones=function(){var e=new Array;var t=new Array(this.bones.length);for(var i=0;i<this.bones.length;i++){this._sortBones(i,e,t)}this.bones=e};t.prototype._sortBones=function(e,t,i){if(i[e]){return}i[e]=true;var r=this.bones[e];if(r._index===undefined){r._index=e}var n=r.getParent();if(n){this._sortBones(this.bones.indexOf(n),t,i)}t.push(r)};return t}();e.Skeleton=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this.x=e.Vector3.Zero();this.y=e.Vector3.Zero();this.z=e.Vector3.Zero();this.xx=e.Vector3.Zero();this.yy=e.Vector3.Zero();this.zz=e.Vector3.Zero();this.xy=e.Vector3.Zero();this.yz=e.Vector3.Zero();this.zx=e.Vector3.Zero()}t.prototype.addAmbient=function(t){var i=new e.Vector3(t.r,t.g,t.b);this.xx=this.xx.add(i);this.yy=this.yy.add(i);this.zz=this.zz.add(i)};t.getSphericalPolynomialFromHarmonics=function(e){var i=new t;i.x=e.L11.scale(1.02333);i.y=e.L1_1.scale(1.02333);i.z=e.L10.scale(1.02333);i.xx=e.L00.scale(.886277).subtract(e.L20.scale(.247708)).add(e.L22.scale(.429043));i.yy=e.L00.scale(.886277).subtract(e.L20.scale(.247708)).subtract(e.L22.scale(.429043));i.zz=e.L00.scale(.886277).add(e.L20.scale(.495417));i.yz=e.L2_1.scale(.858086);i.zx=e.L21.scale(.858086);i.xy=e.L2_2.scale(.858086);i.scale(1/Math.PI);return i};t.prototype.scale=function(e){this.x=this.x.scale(e);this.y=this.y.scale(e);this.z=this.z.scale(e);this.xx=this.xx.scale(e);this.yy=this.yy.scale(e);this.zz=this.zz.scale(e);this.yz=this.yz.scale(e);this.zx=this.zx.scale(e);this.xy=this.xy.scale(e)};return t}();e.SphericalPolynomial=t;var i=function(){function t(){this.L00=e.Vector3.Zero();this.L1_1=e.Vector3.Zero();this.L10=e.Vector3.Zero();this.L11=e.Vector3.Zero();this.L2_2=e.Vector3.Zero();this.L2_1=e.Vector3.Zero();this.L20=e.Vector3.Zero();this.L21=e.Vector3.Zero();this.L22=e.Vector3.Zero()}t.prototype.addLight=function(t,i,r){var n=new e.Vector3(i.r,i.g,i.b);var o=n.scale(r);this.L00=this.L00.add(o.scale(.282095));this.L1_1=this.L1_1.add(o.scale(.488603*t.y));this.L10=this.L10.add(o.scale(.488603*t.z));this.L11=this.L11.add(o.scale(.488603*t.x));this.L2_2=this.L2_2.add(o.scale(1.092548*t.x*t.y));this.L2_1=this.L2_1.add(o.scale(1.092548*t.y*t.z));this.L21=this.L21.add(o.scale(1.092548*t.x*t.z));this.L20=this.L20.add(o.scale(.315392*(3*t.z*t.z-1)));this.L22=this.L22.add(o.scale(.546274*(t.x*t.x-t.y*t.y)))};t.prototype.scale=function(e){this.L00=this.L00.scale(e);this.L1_1=this.L1_1.scale(e);this.L10=this.L10.scale(e);this.L11=this.L11.scale(e);this.L2_2=this.L2_2.scale(e);this.L2_1=this.L2_1.scale(e);this.L20=this.L20.scale(e);this.L21=this.L21.scale(e);this.L22=this.L22.scale(e)};t.prototype.convertIncidentRadianceToIrradiance=function(){this.L00=this.L00.scale(3.141593);this.L1_1=this.L1_1.scale(2.094395);this.L10=this.L10.scale(2.094395);this.L11=this.L11.scale(2.094395);this.L2_2=this.L2_2.scale(.785398);this.L2_1=this.L2_1.scale(.785398);this.L20=this.L20.scale(.785398);this.L21=this.L21.scale(.785398);this.L22=this.L22.scale(.785398)};t.prototype.convertIrradianceToLambertianRadiance=function(){this.scale(1/Math.PI)};t.getsphericalHarmonicsFromPolynomial=function(e){var i=new t;i.L00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126));i.L1_1=e.y.scale(.977204);i.L10=e.z.scale(.977204);i.L11=e.x.scale(.977204);i.L2_2=e.xy.scale(1.16538);i.L2_1=e.yz.scale(1.16538);i.L20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834));i.L21=e.zx.scale(1.16538);i.L22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538));i.scale(Math.PI);return i};return t}();e.SphericalHarmonics=i})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e,t,i,r){this.name=e;this.worldAxisForNormal=t;this.worldAxisForFileX=i;this.worldAxisForFileY=r}return e}();var i=function(){function i(){}i.ConvertCubeMapTextureToSphericalPolynomial=function(t){if(!t.isCube){return null}var i=t.getSize().width;var r=t.readPixels(0);var n=t.readPixels(1);var o;var s;if(t.isRenderTarget){o=t.readPixels(3);s=t.readPixels(2)}else{o=t.readPixels(2);s=t.readPixels(3)}var a=t.readPixels(4);var u=t.readPixels(5);var l=t.gammaSpace;var c=e.Engine.TEXTUREFORMAT_RGBA;var h=e.Engine.TEXTURETYPE_UNSIGNED_INT;if(t.textureType&&t.textureType!==e.Engine.TEXTURETYPE_UNSIGNED_INT){h=e.Engine.TEXTURETYPE_FLOAT}var f={size:i,right:r,left:n,up:o,down:s,front:a,back:u,format:c,type:h,gammaSpace:l};return this.ConvertCubeMapToSphericalPolynomial(f)};i.ConvertCubeMapToSphericalPolynomial=function(t){var i=new e.SphericalHarmonics;var r=0;var n=2/t.size;var o=n;var s=n*.5-1;for(var a=0;a<6;a++){var u=this.FileFaces[a];var l=t[u.name];var c=s;var h=t.format===e.Engine.TEXTUREFORMAT_RGBA?4:3;for(var f=0;f<t.size;f++){var d=s;for(var p=0;p<t.size;p++){var _=u.worldAxisForFileX.scale(d).add(u.worldAxisForFileY.scale(c)).add(u.worldAxisForNormal);_.normalize();var m=Math.pow(1+d*d+c*c,-3/2);var g=l[f*t.size*h+p*h+0];var v=l[f*t.size*h+p*h+1];var y=l[f*t.size*h+p*h+2];if(t.type===e.Engine.TEXTURETYPE_UNSIGNED_INT){g/=255;v/=255;y/=255}if(t.gammaSpace){g=Math.pow(e.Scalar.Clamp(g),e.ToLinearSpace);v=Math.pow(e.Scalar.Clamp(v),e.ToLinearSpace);y=Math.pow(e.Scalar.Clamp(y),e.ToLinearSpace)}var b=new e.Color3(g,v,y);i.addLight(_,b,m);r+=m;d+=n}c+=o}}var x=4*Math.PI;var T=6;var E=x*T/6;var P=E/r;i.scale(P);i.convertIncidentRadianceToIrradiance();i.convertIrradianceToLambertianRadiance();return e.SphericalPolynomial.getSphericalPolynomialFromHarmonics(i)};i.FileFaces=[new t("right",new e.Vector3(1,0,0),new e.Vector3(0,0,-1),new e.Vector3(0,-1,0)),new t("left",new e.Vector3(-1,0,0),new e.Vector3(0,0,1),new e.Vector3(0,-1,0)),new t("up",new e.Vector3(0,1,0),new e.Vector3(1,0,0),new e.Vector3(0,0,1)),new t("down",new e.Vector3(0,-1,0),new e.Vector3(1,0,0),new e.Vector3(0,0,-1)),new t("front",new e.Vector3(0,0,1),new e.Vector3(1,0,0),new e.Vector3(0,-1,0)),new t("back",new e.Vector3(0,0,-1),new e.Vector3(-1,0,0),new e.Vector3(0,-1,0))];return i}();e.CubeMapToSphericalPolynomialTools=i})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){}t.ConvertPanoramaToCubemap=function(t,i,r,n){if(!t){throw"ConvertPanoramaToCubemap: input cannot be null"}if(t.length!=i*r*3){throw"ConvertPanoramaToCubemap: input size is wrong"}var o=this.CreateCubemapTexture(n,this.FACE_FRONT,t,i,r);var s=this.CreateCubemapTexture(n,this.FACE_BACK,t,i,r);var a=this.CreateCubemapTexture(n,this.FACE_LEFT,t,i,r);var u=this.CreateCubemapTexture(n,this.FACE_RIGHT,t,i,r);var l=this.CreateCubemapTexture(n,this.FACE_UP,t,i,r);var c=this.CreateCubemapTexture(n,this.FACE_DOWN,t,i,r);return{front:o,back:s,left:a,right:u,up:l,down:c,size:n,type:e.Engine.TEXTURETYPE_FLOAT,format:e.Engine.TEXTUREFORMAT_RGB,gammaSpace:false}};t.CreateCubemapTexture=function(e,t,i,r,n){var o=new ArrayBuffer(e*e*4*3);var s=new Float32Array(o);var a=t[1].subtract(t[0]).scale(1/e);var u=t[3].subtract(t[2]).scale(1/e);var l=1/e;var c=0;for(var h=0;h<e;h++){var f=t[0];var d=t[2];for(var p=0;p<e;p++){var _=d.subtract(f).scale(c).add(f);_.normalize();var m=this.CalcProjectionSpherical(_,i,r,n);s[h*e*3+p*3+0]=m.r;s[h*e*3+p*3+1]=m.g;s[h*e*3+p*3+2]=m.b;f=f.add(a);d=d.add(u)}c+=l}return s};t.CalcProjectionSpherical=function(e,t,i,r){var n=Math.atan2(e.z,e.x);var o=Math.acos(e.y);while(n<-Math.PI)n+=2*Math.PI;while(n>Math.PI)n-=2*Math.PI;var s=n/Math.PI;var a=o/Math.PI;s=s*.5+.5;var u=Math.round(s*i);if(u<0)u=0;else if(u>=i)u=i-1;var l=Math.round(a*r);if(l<0)l=0;else if(l>=r)l=r-1;var c=r-l-1;var h=t[c*i*3+u*3+0];var f=t[c*i*3+u*3+1];var d=t[c*i*3+u*3+2];return{r:h,g:f,b:d}};t.FACE_FRONT=[new e.Vector3(-1,-1,-1),new e.Vector3(1,-1,-1),new e.Vector3(-1,1,-1),new e.Vector3(1,1,-1)];t.FACE_BACK=[new e.Vector3(1,-1,1),new e.Vector3(-1,-1,1),new e.Vector3(1,1,1),new e.Vector3(-1,1,1)];t.FACE_RIGHT=[new e.Vector3(1,-1,-1),new e.Vector3(1,-1,1),new e.Vector3(1,1,-1),new e.Vector3(1,1,1)];t.FACE_LEFT=[new e.Vector3(-1,-1,1),new e.Vector3(-1,-1,-1),new e.Vector3(-1,1,1),new e.Vector3(-1,1,-1)];t.FACE_DOWN=[new e.Vector3(-1,1,-1),new e.Vector3(1,1,-1),new e.Vector3(-1,1,1),new e.Vector3(1,1,1)];t.FACE_UP=[new e.Vector3(-1,-1,1),new e.Vector3(1,-1,1),new e.Vector3(-1,-1,-1),new e.Vector3(1,-1,-1)];return t}();e.PanoramaToCubeMapTools=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){}t.Ldexp=function(e,t){if(t>1023){return e*Math.pow(2,1023)*Math.pow(2,t-1023)}if(t<-1074){return e*Math.pow(2,-1074)*Math.pow(2,t+1074)}return e*Math.pow(2,t)};t.Rgbe2float=function(e,t,i,r,n,o){if(n>0){n=this.Ldexp(1,n-(128+8));e[o+0]=t*n;e[o+1]=i*n;e[o+2]=r*n}else{e[o+0]=0;e[o+1]=0;e[o+2]=0}};t.readStringLine=function(e,t){var i="";var r="";for(var n=t;n<e.length-t;n++){
r=String.fromCharCode(e[n]);if(r=="\n"){break}i+=r}return i};t.RGBE_ReadHeader=function(e){var t=0;var i=0;var r=this.readStringLine(e,0);if(r[0]!="#"||r[1]!="?"){throw"Bad HDR Format."}var n=false;var o=false;var s=0;do{s+=r.length+1;r=this.readStringLine(e,s);if(r=="FORMAT=32-bit_rle_rgbe"){o=true}else if(r.length==0){n=true}}while(!n);if(!o){throw"HDR Bad header format, unsupported FORMAT"}s+=r.length+1;r=this.readStringLine(e,s);var a=/^\-Y (.*) \+X (.*)$/g;var u=a.exec(r);if(!u||u.length<3){throw"HDR Bad header format, no size"}i=parseInt(u[2]);t=parseInt(u[1]);if(i<8||i>32767){throw"HDR Bad header format, unsupported size"}s+=r.length+1;return{height:t,width:i,dataPosition:s}};t.GetCubeMapTextureData=function(t,i){var r=new Uint8Array(t);var n=this.RGBE_ReadHeader(r);var o=this.RGBE_ReadPixels_RLE(r,n);var s=e.PanoramaToCubeMapTools.ConvertPanoramaToCubemap(o,n.width,n.height,i);return s};t.RGBE_ReadPixels=function(e,t){return this.RGBE_ReadPixels_RLE(e,t)};t.RGBE_ReadPixels_RLE=function(e,t){var i=t.height;var r=t.width;var n,o,s,a,u;var l=t.dataPosition;var c=0,h=0,f=0;var d=new ArrayBuffer(r*4);var p=new Uint8Array(d);var _=new ArrayBuffer(t.width*t.height*4*3);var m=new Float32Array(_);while(i>0){n=e[l++];o=e[l++];s=e[l++];a=e[l++];if(n!=2||o!=2||s&128){throw"HDR Bad header format, not RLE"}if((s<<8|a)!=r){throw"HDR Bad header format, wrong scan line width"}c=0;for(f=0;f<4;f++){h=(f+1)*r;while(c<h){n=e[l++];o=e[l++];if(n>128){u=n-128;if(u==0||u>h-c){throw"HDR Bad Format, bad scanline data (run)"}while(u-- >0){p[c++]=o}}else{u=n;if(u==0||u>h-c){throw"HDR Bad Format, bad scanline data (non-run)"}p[c++]=o;if(--u>0){for(var g=0;g<u;g++){p[c++]=e[l++]}}}}}for(f=0;f<r;f++){n=p[f];o=p[f+r];s=p[f+2*r];a=p[f+3*r];this.Rgbe2float(m,n,o,s,a,(t.height-i)*r*3+f*3)}i--}return m};return t}();e.HDRTools=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l,c){if(o===void 0){o=false}if(s===void 0){s=true}if(a===void 0){a=false}if(u===void 0){u=false}if(l===void 0){l=null}if(c===void 0){c=null}var h=t.call(this,r)||this;h._useInGammaSpace=false;h._generateHarmonics=true;h._isBABYLONPreprocessed=false;h._onLoad=null;h._onError=null;h.coordinatesMode=e.Texture.CUBIC_MODE;h.isPMREM=false;h._isBlocking=true;h.boundingBoxPosition=e.Vector3.Zero();if(!i){return h}h.name=i;h.url=i;h.hasAlpha=false;h.isCube=true;h._textureMatrix=e.Matrix.Identity();h._onLoad=l;h._onError=c;h.gammaSpace=false;var f=r.getEngine().getCaps();if(n){h._isBABYLONPreprocessed=false;h._noMipmap=o;h._size=n;h._useInGammaSpace=a;h._usePMREMGenerator=u&&f.textureLOD&&f.textureFloat&&!h._useInGammaSpace}else{h._isBABYLONPreprocessed=true;h._noMipmap=false;h._useInGammaSpace=false;h._usePMREMGenerator=f.textureLOD&&f.textureFloat&&!h._useInGammaSpace}h.isPMREM=h._usePMREMGenerator;h._texture=h._getFromCache(i,h._noMipmap);if(!h._texture){if(!r.useDelayedTextureLoading){h.loadTexture()}else{h.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED}}return h}Object.defineProperty(i.prototype,"isBlocking",{get:function(){return this._isBlocking},set:function(e){this._isBlocking=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t)){return}this._boundingBoxSize=t;var i=this.getScene();if(i){i.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag)}},enumerable:true,configurable:true});i.prototype.loadBabylonTexture=function(){var t=this;var i=0;var r=null;var n=this.getScene();var o=!this._useInGammaSpace&&n&&n.getEngine().getCaps().textureFloat?function(e){var n=new Array;if(!r){return n}var o=30;for(var s=0;s<i;s++){n.push([]);var a=Math.pow(t._size>>s,2)*3;for(var u=0;u<6;u++){var l=r.subarray(o,o+a);n[s].push(l);o+=a}}return n}:null;var s=function(n){var s=t.getScene();if(!s){return null}var a=new Int32Array(n);r=new Float32Array(n);var u=a[0];t._size=a[1];if(!t._texture){return null}t._texture.updateSize(t._size,t._size);var l=new e.SphericalPolynomial;l.x.copyFromFloats(r[2],r[3],r[4]);l.y.copyFromFloats(r[5],r[6],r[7]);l.z.copyFromFloats(r[8],r[9],r[10]);l.xx.copyFromFloats(r[11],r[12],r[13]);l.yy.copyFromFloats(r[14],r[15],r[16]);l.zz.copyFromFloats(r[17],r[18],r[19]);l.xy.copyFromFloats(r[20],r[21],r[22]);l.yz.copyFromFloats(r[23],r[24],r[25]);l.zx.copyFromFloats(r[26],r[27],r[28]);t.sphericalPolynomial=l;i=a[29];var c=30;var h=[];var f=Math.pow(t._size,2)*3;for(var d=0;d<6;d++){h.push(r.subarray(c,c+f));c+=f}var p=[];var _=null;for(var m=0;m<6;m++){var g=null;if(u===1){var v=[0,2,4,1,3,5][m];g=h[v]}if(!o&&g){if(!s.getEngine().getCaps().textureFloat){var y=new ArrayBuffer(f);_=new Uint8Array(y)}for(var b=0;b<t._size*t._size;b++){if(t._useInGammaSpace){g[b*3+0]=Math.pow(g[b*3+0],e.ToGammaSpace);g[b*3+1]=Math.pow(g[b*3+1],e.ToGammaSpace);g[b*3+2]=Math.pow(g[b*3+2],e.ToGammaSpace)}if(_){var x=Math.max(g[b*3+0]*255,0);var T=Math.max(g[b*3+1]*255,0);var E=Math.max(g[b*3+2]*255,0);var P=Math.max(Math.max(x,T),E);if(P>255){var A=255/P;x*=A;T*=A;E*=A}_[b*3+0]=x;_[b*3+1]=T;_[b*3+2]=E}}}if(_){p.push(_)}else{p.push(g)}}return p};if(n){this._texture=n.getEngine().createRawCubeTextureFromUrl(this.url,n,this._size,e.Engine.TEXTUREFORMAT_RGB,n.getEngine().getCaps().textureFloat?e.Engine.TEXTURETYPE_FLOAT:e.Engine.TEXTURETYPE_UNSIGNED_INT,this._noMipmap,s,o,this._onLoad,this._onError)}};i.prototype.loadHDRTexture=function(){var t=this;var r=function(r){var n=t.getScene();if(!n){return null}var o=e.HDRTools.GetCubeMapTextureData(r,t._size);if(t._generateHarmonics){var s=e.CubeMapToSphericalPolynomialTools.ConvertCubeMapToSphericalPolynomial(o);t.sphericalPolynomial=s}var a=[];var u=null;for(var l=0;l<6;l++){if(!n.getEngine().getCaps().textureFloat){var c=new ArrayBuffer(t._size*t._size*3);u=new Uint8Array(c)}var h=o[i._facesMapping[l]];if(t._useInGammaSpace||u){for(var f=0;f<t._size*t._size;f++){if(t._useInGammaSpace){h[f*3+0]=Math.pow(h[f*3+0],e.ToGammaSpace);h[f*3+1]=Math.pow(h[f*3+1],e.ToGammaSpace);h[f*3+2]=Math.pow(h[f*3+2],e.ToGammaSpace)}if(u){var d=Math.max(h[f*3+0]*255,0);var p=Math.max(h[f*3+1]*255,0);var _=Math.max(h[f*3+2]*255,0);var m=Math.max(Math.max(d,p),_);if(m>255){var g=255/m;d*=g;p*=g;_*=g}u[f*3+0]=d;u[f*3+1]=p;u[f*3+2]=_}}}if(u){a.push(u)}else{a.push(h)}}return a};var n=null;var o=this.getScene();if(o){this._texture=o.getEngine().createRawCubeTextureFromUrl(this.url,o,this._size,e.Engine.TEXTUREFORMAT_RGB,o.getEngine().getCaps().textureFloat?e.Engine.TEXTURETYPE_FLOAT:e.Engine.TEXTURETYPE_UNSIGNED_INT,this._noMipmap,r,n,this._onLoad,this._onError)}};i.prototype.loadTexture=function(){if(this._isBABYLONPreprocessed){this.loadBabylonTexture()}else{this.loadHDRTexture()}};i.prototype.clone=function(){var e=this.getScene();if(!e){return this}var t=this._isBABYLONPreprocessed?null:this._size;var r=new i(this.url,e,t,this._noMipmap,this._generateHarmonics,this._useInGammaSpace,this._usePMREMGenerator);r.level=this.level;r.wrapU=this.wrapU;r.wrapV=this.wrapV;r.coordinatesIndex=this.coordinatesIndex;r.coordinatesMode=this.coordinatesMode;return r};i.prototype.delayLoad=function(){if(this.delayLoadState!==e.Engine.DELAYLOADSTATE_NOTLOADED){return}this.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED;this._texture=this._getFromCache(this.url,this._noMipmap);if(!this._texture){this.loadTexture()}};i.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix};i.prototype.setReflectionTextureMatrix=function(e){this._textureMatrix=e};i.Parse=function(t,r,n){var o=null;if(t.name&&!t.isRenderTarget){var s=t.isBABYLONPreprocessed?null:t.size;o=new i(n+t.name,r,s,t.noMipmap,t.generateHarmonics,t.useInGammaSpace,t.usePMREMGenerator);o.name=t.name;o.hasAlpha=t.hasAlpha;o.level=t.level;o.coordinatesMode=t.coordinatesMode;o.isBlocking=t.isBlocking}if(o){if(t.boundingBoxPosition){o.boundingBoxPosition=e.Vector3.FromArray(t.boundingBoxPosition)}if(t.boundingBoxSize){o.boundingBoxSize=e.Vector3.FromArray(t.boundingBoxSize)}}return o};i.prototype.serialize=function(){if(!this.name){return null}var e={};e.name=this.name;e.hasAlpha=this.hasAlpha;e.isCube=true;e.level=this.level;e.size=this._size;e.coordinatesMode=this.coordinatesMode;e.useInGammaSpace=this._useInGammaSpace;e.generateHarmonics=this._generateHarmonics;e.usePMREMGenerator=this._usePMREMGenerator;e.isBABYLONPreprocessed=this._isBABYLONPreprocessed;e.customType="BABYLON.HDRCubeTexture";e.noMipmap=this._noMipmap;e.isBlocking=this._isBlocking;return e};i.generateBabylonHDROnDisk=function(e,t,r){if(r===void 0){r=null}var n=function(e){var t=new Blob([e],{type:"application/octet-stream"});var i=window.URL.createObjectURL(t);var r=document.createElement("a");document.body.appendChild(r);r.style.display="none";r.href=i;r.download="envmap.babylon.hdr";r.click()};i.generateBabylonHDR(e,t,n,r)};i.generateBabylonHDR=function(t,i,r,n){if(n===void 0){n=null}if(!t){return}if(!e.Tools.IsExponentOfTwo(i)){return}e.Tools.Error("Generation of Babylon HDR is coming back in 3.2.")};i._facesMapping=["right","left","up","down","front","back"];return i}(e.BaseTexture);e.HDRCubeTexture=t})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(t,i){var r=e.call(this,t.x,t.y)||this;r.index=i;return r}return t}(e.Vector2);var r=function(){function i(){this.elements=new Array}i.prototype.add=function(e){var i=this;var r=new Array;e.forEach(function(e){if(r.length===0||!e.equalsWithEpsilon(r[0])){var n=new t(e,i.elements.length);r.push(n);i.elements.push(n)}});return r};i.prototype.computeBounds=function(){var t=new e.Vector2(this.elements[0].x,this.elements[0].y);var i=new e.Vector2(this.elements[0].x,this.elements[0].y);this.elements.forEach(function(e){if(e.x<t.x){t.x=e.x}else if(e.x>i.x){i.x=e.x}if(e.y<t.y){t.y=e.y}else if(e.y>i.y){i.y=e.y}});return{min:t,max:i,width:i.x-t.x,height:i.y-t.y}};return i}();var n=function(){function t(){}t.Rectangle=function(t,i,r,n){return[new e.Vector2(t,i),new e.Vector2(r,i),new e.Vector2(r,n),new e.Vector2(t,n)]};t.Circle=function(t,i,r,n){if(i===void 0){i=0}if(r===void 0){r=0}if(n===void 0){n=32}var o=new Array;var s=0;var a=Math.PI*2/n;for(var u=0;u<n;u++){o.push(new e.Vector2(i+Math.cos(s)*t,r+Math.sin(s)*t));s-=a}return o};t.Parse=function(t){var i=t.split(/[^-+eE\.\d]+/).map(parseFloat).filter(function(e){return!isNaN(e)});var r,n=[];for(r=0;r<(i.length&2147483646);r+=2){n.push(new e.Vector2(i[r],i[r+1]))}return n};t.StartingAt=function(t,i){return e.Path2.StartingAt(t,i)};return t}();e.Polygon=n;var o=function(){function t(t,n,o){this._points=new r;this._outlinepoints=new r;this._holes=new Array;this._epoints=new Array;this._eholes=new Array;this._name=t;this._scene=o;var s;if(n instanceof e.Path2){s=n.getPoints()}else{s=n}this._addToepoint(s);this._points.add(s);this._outlinepoints.add(s);if(typeof i==="undefined"){e.Tools.Warn("Earcut was not found, the polygon will not be built.")}}t.prototype._addToepoint=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this._epoints.push(r.x,r.y)}};t.prototype.addHole=function(e){this._points.add(e);var t=new r;t.add(e);this._holes.push(t);this._eholes.push(this._epoints.length/2);this._addToepoint(e);return this};t.prototype.build=function(t,r){var n=this;if(t===void 0){t=false}if(r===void 0){r=0}var o=new e.Mesh(this._name,this._scene);var s=new Array;var a=new Array;var u=new Array;var l=this._points.computeBounds();this._points.elements.forEach(function(e){s.push(0,1,0);a.push(e.x,0,e.y);u.push((e.x-l.min.x)/l.width,(e.y-l.min.y)/l.height)});var c=new Array;var h=i(this._epoints,this._eholes,2);for(var f=0;f<h.length;f++){c.push(h[f])}if(r>0){var d=a.length/3;this._points.elements.forEach(function(e){s.push(0,-1,0);a.push(e.x,-r,e.y);u.push(1-(e.x-l.min.x)/l.width,1-(e.y-l.min.y)/l.height)});var p=c.length;for(var f=0;f<p;f+=3){var _=c[f+0];var m=c[f+1];var g=c[f+2];c.push(g+d);c.push(m+d);c.push(_+d)}this.addSide(a,s,u,c,l,this._outlinepoints,r,false);this._holes.forEach(function(e){n.addSide(a,s,u,c,l,e,r,true)})}o.setVerticesData(e.VertexBuffer.PositionKind,a,t);o.setVerticesData(e.VertexBuffer.NormalKind,s,t);o.setVerticesData(e.VertexBuffer.UVKind,u,t);o.setIndices(c);return o};t.prototype.addSide=function(t,i,r,n,o,s,a,u){var l=t.length/3;var c=0;for(var h=0;h<s.elements.length;h++){var f=s.elements[h];var d;if(h+1>s.elements.length-1){d=s.elements[0]}else{d=s.elements[h+1]}t.push(f.x,0,f.y);t.push(f.x,-a,f.y);t.push(d.x,0,d.y);t.push(d.x,-a,d.y);var p=new e.Vector3(f.x,0,f.y);var _=new e.Vector3(d.x,0,d.y);var m=_.subtract(p);var g=new e.Vector3(0,1,0);var v=e.Vector3.Cross(m,g);v=v.normalize();r.push(c/o.width,0);r.push(c/o.width,1);c+=m.length();r.push(c/o.width,0);r.push(c/o.width,1);if(!u){i.push(-v.x,-v.y,-v.z);i.push(-v.x,-v.y,-v.z);i.push(-v.x,-v.y,-v.z);i.push(-v.x,-v.y,-v.z);n.push(l);n.push(l+1);n.push(l+2);n.push(l+1);n.push(l+3);n.push(l+2)}else{i.push(v.x,v.y,v.z);i.push(v.x,v.y,v.z);i.push(v.x,v.y,v.z);i.push(v.x,v.y,v.z);n.push(l);n.push(l+2);n.push(l+1);n.push(l+1);n.push(l+2);n.push(l+3)}l+=4}};return t}();e.PolygonMeshBuilder=o})(r||(r={}));"use strict";var r;(function(e){var t=0;var i=function(){function t(e,t,i){this.pos=e;this.normal=t;this.uv=i}t.prototype.clone=function(){return new t(this.pos.clone(),this.normal.clone(),this.uv.clone())};t.prototype.flip=function(){this.normal=this.normal.scale(-1)};t.prototype.interpolate=function(i,r){return new t(e.Vector3.Lerp(this.pos,i.pos,r),e.Vector3.Lerp(this.normal,i.normal,r),e.Vector2.Lerp(this.uv,i.uv,r))};return t}();var r=function(){function t(e,t){this.normal=e;this.w=t}t.FromPoints=function(i,r,n){var o=n.subtract(i);var s=r.subtract(i);if(o.lengthSquared()===0||s.lengthSquared()===0){return null}var a=e.Vector3.Normalize(e.Vector3.Cross(o,s));return new t(a,e.Vector3.Dot(a,i))};t.prototype.clone=function(){return new t(this.normal.clone(),this.w)};t.prototype.flip=function(){this.normal.scaleInPlace(-1);this.w=-this.w};t.prototype.splitPolygon=function(i,r,o,s,a){var u=0;var l=1;var c=2;var h=3;var f=0;var d=[];var p;var _;for(p=0;p<i.vertices.length;p++){_=e.Vector3.Dot(this.normal,i.vertices[p].pos)-this.w;var m=_<-t.EPSILON?c:_>t.EPSILON?l:u;f|=m;d.push(m)}switch(f){case u:(e.Vector3.Dot(this.normal,i.plane.normal)>0?r:o).push(i);break;case l:s.push(i);break;case c:a.push(i);break;case h:var g=[],v=[];for(p=0;p<i.vertices.length;p++){var y=(p+1)%i.vertices.length;var b=d[p],x=d[y];var T=i.vertices[p],E=i.vertices[y];if(b!==c)g.push(T);if(b!==l)v.push(b!==c?T.clone():T);if((b|x)===h){_=(this.w-e.Vector3.Dot(this.normal,T.pos))/e.Vector3.Dot(this.normal,E.pos.subtract(T.pos));var P=T.interpolate(E,_);g.push(P);v.push(P.clone())}}var A;if(g.length>=3){A=new n(g,i.shared);if(A.plane)s.push(A)}if(v.length>=3){A=new n(v,i.shared);if(A.plane)a.push(A)}break}};t.EPSILON=1e-5;return t}();var n=function(){function e(e,t){this.vertices=e;this.shared=t;this.plane=r.FromPoints(e[0].pos,e[1].pos,e[2].pos)}e.prototype.clone=function(){var t=this.vertices.map(function(e){return e.clone()});return new e(t,this.shared)};e.prototype.flip=function(){this.vertices.reverse().map(function(e){e.flip()});this.plane.flip()};return e}();var o=function(){function e(e){this.plane=null;this.front=null;this.back=null;this.polygons=new Array;if(e){this.build(e)}}e.prototype.clone=function(){var t=new e;t.plane=this.plane&&this.plane.clone();t.front=this.front&&this.front.clone();t.back=this.back&&this.back.clone();t.polygons=this.polygons.map(function(e){return e.clone()});return t};e.prototype.invert=function(){for(var e=0;e<this.polygons.length;e++){this.polygons[e].flip()}if(this.plane){this.plane.flip()}if(this.front){this.front.invert()}if(this.back){this.back.invert()}var t=this.front;this.front=this.back;this.back=t};e.prototype.clipPolygons=function(e){if(!this.plane)return e.slice();var t=new Array,i=new Array;for(var r=0;r<e.length;r++){this.plane.splitPolygon(e[r],t,i,t,i)}if(this.front){t=this.front.clipPolygons(t)}if(this.back){i=this.back.clipPolygons(i)}else{i=[]}return t.concat(i)};e.prototype.clipTo=function(e){this.polygons=e.clipPolygons(this.polygons);if(this.front)this.front.clipTo(e);if(this.back)this.back.clipTo(e)};e.prototype.allPolygons=function(){var e=this.polygons.slice();if(this.front)e=e.concat(this.front.allPolygons());if(this.back)e=e.concat(this.back.allPolygons());return e};e.prototype.build=function(t){if(!t.length)return;if(!this.plane)this.plane=t[0].plane.clone();var i=new Array,r=new Array;for(var n=0;n<t.length;n++){this.plane.splitPolygon(t[n],this.polygons,this.polygons,i,r)}if(i.length){if(!this.front)this.front=new e;this.front.build(i)}if(r.length){if(!this.back)this.back=new e;this.back.build(r)}};return e}();var s=function(){function r(){this.polygons=new Array}r.FromMesh=function(o){var s,a,u,l,c,h=new Array,f;var d,p,_,m=null,g;if(o instanceof e.Mesh){o.computeWorldMatrix(true);d=o.getWorldMatrix();p=o.position.clone();_=o.rotation.clone();if(o.rotationQuaternion){m=o.rotationQuaternion.clone()}g=o.scaling.clone()}else{throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh"}var v=o.getIndices(),y=o.getVerticesData(e.VertexBuffer.PositionKind),b=o.getVerticesData(e.VertexBuffer.NormalKind),x=o.getVerticesData(e.VertexBuffer.UVKind);var T=o.subMeshes;for(var E=0,P=T.length;E<P;E++){for(var A=T[E].indexStart,M=T[E].indexCount+T[E].indexStart;A<M;A+=3){f=[];for(var S=0;S<3;S++){var C=new e.Vector3(b[v[A+S]*3],b[v[A+S]*3+1],b[v[A+S]*3+2]);u=new e.Vector2(x[v[A+S]*2],x[v[A+S]*2+1]);var R=new e.Vector3(y[v[A+S]*3],y[v[A+S]*3+1],y[v[A+S]*3+2]);l=e.Vector3.TransformCoordinates(R,d);a=e.Vector3.TransformNormal(C,d);s=new i(l,a,u);f.push(s)}c=new n(f,{subMeshId:E,meshId:t,materialIndex:T[E].materialIndex});if(c.plane)h.push(c)}}var O=r.FromPolygons(h);O.matrix=d;O.position=p;O.rotation=_;O.scaling=g;O.rotationQuaternion=m;t++;return O};r.FromPolygons=function(e){var t=new r;t.polygons=e;return t};r.prototype.clone=function(){var e=new r;e.polygons=this.polygons.map(function(e){return e.clone()});e.copyTransformAttributes(this);return e};r.prototype.union=function(e){var t=new o(this.clone().polygons);var i=new o(e.clone().polygons);t.clipTo(i);i.clipTo(t);i.invert();i.clipTo(t);i.invert();t.build(i.allPolygons());return r.FromPolygons(t.allPolygons()).copyTransformAttributes(this)};r.prototype.unionInPlace=function(e){var t=new o(this.polygons);var i=new o(e.polygons);t.clipTo(i);i.clipTo(t);i.invert();i.clipTo(t);i.invert();t.build(i.allPolygons());this.polygons=t.allPolygons()};r.prototype.subtract=function(e){var t=new o(this.clone().polygons);var i=new o(e.clone().polygons);t.invert();t.clipTo(i);i.clipTo(t);i.invert();i.clipTo(t);i.invert();t.build(i.allPolygons());t.invert();return r.FromPolygons(t.allPolygons()).copyTransformAttributes(this)};r.prototype.subtractInPlace=function(e){var t=new o(this.polygons);var i=new o(e.polygons);t.invert();t.clipTo(i);i.clipTo(t);i.invert();i.clipTo(t);i.invert();t.build(i.allPolygons());t.invert();this.polygons=t.allPolygons()};r.prototype.intersect=function(e){var t=new o(this.clone().polygons);var i=new o(e.clone().polygons);t.invert();i.clipTo(t);i.invert();t.clipTo(i);i.clipTo(t);t.build(i.allPolygons());t.invert();return r.FromPolygons(t.allPolygons()).copyTransformAttributes(this)};r.prototype.intersectInPlace=function(e){var t=new o(this.polygons);var i=new o(e.polygons);t.invert();i.clipTo(t);i.invert();t.clipTo(i);i.clipTo(t);t.build(i.allPolygons());t.invert();this.polygons=t.allPolygons()};r.prototype.inverse=function(){var e=this.clone();e.inverseInPlace();return e};r.prototype.inverseInPlace=function(){this.polygons.map(function(e){e.flip()})};r.prototype.copyTransformAttributes=function(e){this.matrix=e.matrix;this.position=e.position;this.rotation=e.rotation;this.scaling=e.scaling;this.rotationQuaternion=e.rotationQuaternion;return this};r.prototype.buildMeshGeometry=function(t,i,r){var n=this.matrix.clone();n.invert();var o=new e.Mesh(t,i),s=[],a=[],u=[],l=[],c=e.Vector3.Zero(),h=e.Vector3.Zero(),f=e.Vector2.Zero(),d=this.polygons,p=[0,0,0],_,m={},g,v=0,y={},b;if(r){d.sort(function(e,t){if(e.shared.meshId===t.shared.meshId){return e.shared.subMeshId-t.shared.subMeshId}else{return e.shared.meshId-t.shared.meshId}})}for(var x=0,T=d.length;x<T;x++){_=d[x];if(!y[_.shared.meshId]){y[_.shared.meshId]={}}if(!y[_.shared.meshId][_.shared.subMeshId]){y[_.shared.meshId][_.shared.subMeshId]={indexStart:+Infinity,indexEnd:-Infinity,materialIndex:_.shared.materialIndex}}b=y[_.shared.meshId][_.shared.subMeshId];for(var E=2,P=_.vertices.length;E<P;E++){p[0]=0;p[1]=E-1;p[2]=E;for(var A=0;A<3;A++){c.copyFrom(_.vertices[p[A]].pos);h.copyFrom(_.vertices[p[A]].normal);f.copyFrom(_.vertices[p[A]].uv);var M=e.Vector3.TransformCoordinates(c,n);var S=e.Vector3.TransformNormal(h,n);g=m[M.x+","+M.y+","+M.z];if(!(typeof g!=="undefined"&&u[g*3]===S.x&&u[g*3+1]===S.y&&u[g*3+2]===S.z&&l[g*2]===f.x&&l[g*2+1]===f.y)){s.push(M.x,M.y,M.z);l.push(f.x,f.y);u.push(h.x,h.y,h.z);g=m[M.x+","+M.y+","+M.z]=s.length/3-1}a.push(g);b.indexStart=Math.min(v,b.indexStart);b.indexEnd=Math.max(v,b.indexEnd);v++}}}o.setVerticesData(e.VertexBuffer.PositionKind,s);o.setVerticesData(e.VertexBuffer.NormalKind,u);o.setVerticesData(e.VertexBuffer.UVKind,l);o.setIndices(a,null);if(r){var C=0,R;o.subMeshes=new Array;for(var O in y){R=-1;for(var I in y[O]){b=y[O][I];e.SubMesh.CreateFromIndices(b.materialIndex+C,b.indexStart,b.indexEnd-b.indexStart+1,o);R=Math.max(b.materialIndex,R)}C+=++R}}return o};r.prototype.toMesh=function(e,t,i,r){var n=this.buildMeshGeometry(e,i,r);n.material=t;n.position.copyFrom(this.position);n.rotation.copyFrom(this.rotation);if(this.rotationQuaternion){n.rotationQuaternion=this.rotationQuaternion.clone()}n.scaling.copyFrom(this.scaling);n.computeWorldMatrix(true);return n};return r}();e.CSG=s})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r,n,o){this.size=t;this.position=i;this.alphaMode=e.Engine.ALPHA_ONEONE;this.color=r||new e.Color3(1,1,1);this.texture=n?new e.Texture(n,o.getScene(),true):null;this._system=o;o.lensFlares.push(this)}t.AddFlare=function(e,i,r,n,o){return new t(e,i,r,n,o)};t.prototype.dispose=function(){if(this.texture){this.texture.dispose()}var e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)};return t}();e.LensFlare=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r){this.name=t;this.lensFlares=new Array;this.borderLimit=300;this.viewportBorder=0;this.layerMask=268435455;this._vertexBuffers={};this._isEnabled=true;this._scene=r||e.Engine.LastCreatedScene;this._emitter=i;this.id=t;r.lensFlareSystems.push(this);this.meshesSelectionPredicate=function(e){return r.activeCamera&&e.material&&e.isVisible&&e.isEnabled()&&e.isBlocker&&(e.layerMask&r.activeCamera.layerMask)!=0};var n=r.getEngine();var o=[];o.push(1,1);o.push(-1,1);o.push(-1,-1);o.push(1,-1);this._vertexBuffers[e.VertexBuffer.PositionKind]=new e.VertexBuffer(n,o,e.VertexBuffer.PositionKind,false,false,2);var s=[];s.push(0);s.push(1);s.push(2);s.push(0);s.push(2);s.push(3);this._indexBuffer=n.createIndexBuffer(s);this._effect=n.createEffect("lensFlare",[e.VertexBuffer.PositionKind],["color","viewportMatrix"],["textureSampler"],"")}Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled=e},enumerable:true,configurable:true});t.prototype.getScene=function(){return this._scene};t.prototype.getEmitter=function(){return this._emitter};t.prototype.setEmitter=function(e){this._emitter=e};t.prototype.getEmitterPosition=function(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position};t.prototype.computeEffectivePosition=function(t){var i=this.getEmitterPosition();i=e.Vector3.Project(i,e.Matrix.Identity(),this._scene.getTransformMatrix(),t);this._positionX=i.x;this._positionY=i.y;i=e.Vector3.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix());if(this.viewportBorder>0){t.x-=this.viewportBorder;t.y-=this.viewportBorder;t.width+=this.viewportBorder*2;t.height+=this.viewportBorder*2;i.x+=this.viewportBorder;i.y+=this.viewportBorder;this._positionX+=this.viewportBorder;this._positionY+=this.viewportBorder}if(i.z>0){if(this._positionX>t.x&&this._positionX<t.x+t.width){if(this._positionY>t.y&&this._positionY<t.y+t.height)return true}return true}return false};t.prototype._isVisible=function(){if(!this._isEnabled||!this._scene.activeCamera){return false}var t=this.getEmitterPosition();var i=t.subtract(this._scene.activeCamera.globalPosition);var r=i.length();i.normalize();var n=new e.Ray(this._scene.activeCamera.globalPosition,i);var o=this._scene.pickWithRay(n,this.meshesSelectionPredicate,true);return!o||!o.hit||o.distance>r};t.prototype.render=function(){if(!this._effect.isReady()||!this._scene.activeCamera)return false;var t=this._scene.getEngine();var i=this._scene.activeCamera.viewport;var r=i.toGlobal(t.getRenderWidth(true),t.getRenderHeight(true));if(!this.computeEffectivePosition(r)){return false}if(!this._isVisible()){return false}var n;var o;if(this._positionX<this.borderLimit+r.x){n=this.borderLimit+r.x-this._positionX}else if(this._positionX>r.x+r.width-this.borderLimit){n=this._positionX-r.x-r.width+this.borderLimit}else{n=0}if(this._positionY<this.borderLimit+r.y){o=this.borderLimit+r.y-this._positionY}else if(this._positionY>r.y+r.height-this.borderLimit){o=this._positionY-r.y-r.height+this.borderLimit}else{o=0}var s=n>o?n:o;s-=this.viewportBorder;if(s>this.borderLimit){s=this.borderLimit}var a=1-s/this.borderLimit;if(a<0){return false}if(a>1){a=1}if(this.viewportBorder>0){r.x+=this.viewportBorder;r.y+=this.viewportBorder;r.width-=this.viewportBorder*2;r.height-=this.viewportBorder*2;this._positionX-=this.viewportBorder;this._positionY-=this.viewportBorder}var u=r.x+r.width/2;var l=r.y+r.height/2;var c=u-this._positionX;var h=l-this._positionY;t.enableEffect(this._effect);t.setState(false);t.setDepthBuffer(false);t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect);for(var f=0;f<this.lensFlares.length;f++){var d=this.lensFlares[f];t.setAlphaMode(d.alphaMode);var p=u-c*d.position;var _=l-h*d.position;var m=d.size;var g=d.size*t.getAspectRatio(this._scene.activeCamera,true);var v=2*(p/(r.width+r.x*2))-1;var y=1-2*(_/(r.height+r.y*2));var b=e.Matrix.FromValues(m/2,0,0,0,0,g/2,0,0,0,0,1,0,v,y,0,1);this._effect.setMatrix("viewportMatrix",b);this._effect.setTexture("textureSampler",d.texture);this._effect.setFloat4("color",d.color.r*a,d.color.g*a,d.color.b*a,1);t.drawElementsType(e.Material.TriangleFillMode,0,6)}t.setDepthBuffer(true);t.setAlphaMode(e.Engine.ALPHA_DISABLE);return true};t.prototype.dispose=function(){var t=this._vertexBuffers[e.VertexBuffer.PositionKind];if(t){t.dispose();this._vertexBuffers[e.VertexBuffer.PositionKind]=null}if(this._indexBuffer){this._scene.getEngine()._releaseBuffer(this._indexBuffer);this._indexBuffer=null}while(this.lensFlares.length){this.lensFlares[0].dispose()}var i=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(i,1)};t.Parse=function(i,r,n){var o=r.getLastEntryByID(i.emitterId);var s=i.name||"lensFlareSystem#"+i.emitterId;var a=new t(s,o,r);a.id=i.id||s;a.borderLimit=i.borderLimit;for(var u=0;u<i.flares.length;u++){var l=i.flares[u];e.LensFlare.AddFlare(l.size,l.position,e.Color3.FromArray(l.color),l.textureName?n+l.textureName:"",a)}return a};t.prototype.serialize=function(){var t={};t.id=this.id;t.name=this.name;t.emitterId=this.getEmitter().id;t.borderLimit=this.borderLimit;t.flares=[];for(var i=0;i<this.lensFlares.length;i++){var r=this.lensFlares[i];t.flares.push({size:r.size,position:r.position,color:r.color.asArray(),textureName:e.Tools.GetFilename(r.texture?r.texture.name:"")})}return t};return t}();e.LensFlareSystem=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e,t){this.type=e;this.jointData=t;t.nativeParams=t.nativeParams||{}}Object.defineProperty(e.prototype,"physicsJoint",{get:function(){return this._physicsJoint},set:function(e){if(this._physicsJoint){}this._physicsJoint=e},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"physicsPlugin",{set:function(e){this._physicsPlugin=e},enumerable:true,configurable:true});e.prototype.executeNativeFunction=function(e){e(this._physicsPlugin.world,this._physicsJoint)};e.DistanceJoint=0;e.HingeJoint=1;e.BallAndSocketJoint=2;e.WheelJoint=3;e.SliderJoint=4;e.PrismaticJoint=5;e.UniversalJoint=6;e.Hinge2Joint=e.WheelJoint;e.PointToPointJoint=8;e.SpringJoint=9;e.LockJoint=10;return e}();e.PhysicsJoint=t;var i=function(e){__extends(i,e);function i(i){return e.call(this,t.DistanceJoint,i)||this}i.prototype.updateDistance=function(e,t){this._physicsPlugin.updateDistanceJoint(this,e,t)};return i}(t);e.DistanceJoint=i;var r=function(e){__extends(t,e);function t(t,i){return e.call(this,t,i)||this}t.prototype.setMotor=function(e,t){this._physicsPlugin.setMotor(this,e||0,t)};t.prototype.setLimit=function(e,t){this._physicsPlugin.setLimit(this,e,t)};return t}(t);e.MotorEnabledJoint=r;var n=function(e){__extends(i,e);function i(i){return e.call(this,t.HingeJoint,i)||this}i.prototype.setMotor=function(e,t){this._physicsPlugin.setMotor(this,e||0,t)};i.prototype.setLimit=function(e,t){this._physicsPlugin.setLimit(this,e,t)};return i}(r);e.HingeJoint=n;var o=function(e){__extends(i,e);function i(i){return e.call(this,t.Hinge2Joint,i)||this}i.prototype.setMotor=function(e,t,i){if(i===void 0){i=0}this._physicsPlugin.setMotor(this,e||0,t,i)};i.prototype.setLimit=function(e,t,i){if(i===void 0){i=0}this._physicsPlugin.setLimit(this,e,t,i)};return i}(r);e.Hinge2Joint=o})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r,n){if(r===void 0){r={mass:0}}var o=this;this.object=t;this.type=i;this._options=r;this._scene=n;this._bodyUpdateRequired=false;this._onBeforePhysicsStepCallbacks=new Array;this._onAfterPhysicsStepCallbacks=new Array;this._onPhysicsCollideCallbacks=[];this._deltaPosition=e.Vector3.Zero();this._isDisposed=false;this._tmpQuat=new e.Quaternion;this._tmpQuat2=new e.Quaternion;this.beforeStep=function(){if(!o._physicsEngine){return}o.object.translate(o._deltaPosition,-1);o._deltaRotationConjugated&&o.object.rotationQuaternion&&o.object.rotationQuaternion.multiplyToRef(o._deltaRotationConjugated,o.object.rotationQuaternion);o.object.computeWorldMatrix(false);if(o.object.parent&&o.object.rotationQuaternion){o.getParentsRotation();o._tmpQuat.multiplyToRef(o.object.rotationQuaternion,o._tmpQuat)}else{o._tmpQuat.copyFrom(o.object.rotationQuaternion||new e.Quaternion)}if(!o._options.disableBidirectionalTransformation){o.object.rotationQuaternion&&o._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(o,o.object.getAbsolutePivotPoint(),o._tmpQuat)}o._onBeforePhysicsStepCallbacks.forEach(function(e){e(o)})};this.afterStep=function(){if(!o._physicsEngine){return}o._onAfterPhysicsStepCallbacks.forEach(function(e){e(o)});o._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(o);if(o.object.parent&&o.object.rotationQuaternion){o.getParentsRotation();o._tmpQuat.conjugateInPlace();o._tmpQuat.multiplyToRef(o.object.rotationQuaternion,o.object.rotationQuaternion)}o.object.setAbsolutePosition(o.object.position);o._deltaRotation&&o.object.rotationQuaternion&&o.object.rotationQuaternion.multiplyToRef(o._deltaRotation,o.object.rotationQuaternion);o.object.translate(o._deltaPosition,1)};this.onCollideEvent=null;this.onCollide=function(e){if(!o._onPhysicsCollideCallbacks.length&&!o.onCollideEvent){return}if(!o._physicsEngine){return}var t=o._physicsEngine.getImpostorWithPhysicsBody(e.body);if(t){if(o.onCollideEvent){o.onCollideEvent(o,t)}o._onPhysicsCollideCallbacks.filter(function(e){return e.otherImpostors.indexOf(t)!==-1}).forEach(function(e){e.callback(o,t)})}};if(!this.object){e.Tools.Error("No object was provided. A physics object is obligatory");return}
if(!this._scene&&t.getScene){this._scene=t.getScene()}if(!this._scene){return}this._physicsEngine=this._scene.getPhysicsEngine();if(!this._physicsEngine){e.Tools.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors.")}else{if(!this.object.rotationQuaternion){if(this.object.rotation){this.object.rotationQuaternion=e.Quaternion.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z)}else{this.object.rotationQuaternion=new e.Quaternion}}this._options.mass=r.mass===void 0?0:r.mass;this._options.friction=r.friction===void 0?.2:r.friction;this._options.restitution=r.restitution===void 0?.2:r.restitution;this._joints=[];if(!this.object.parent||this._options.ignoreParent){this._init()}else if(this.object.parent.physicsImpostor){e.Tools.Warn("You must affect impostors to children before affecting impostor to parent.")}}}Object.defineProperty(t.prototype,"isDisposed",{get:function(){return this._isDisposed},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"mass",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0},set:function(e){this.setMass(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"friction",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0},set:function(e){if(!this._physicsEngine){return}this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"restitution",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0},set:function(e){if(!this._physicsEngine){return}this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)},enumerable:true,configurable:true});t.prototype._init=function(){if(!this._physicsEngine){return}this._physicsEngine.removeImpostor(this);this.physicsBody=null;this._parent=this._parent||this._getPhysicsParent();if(!this._isDisposed&&(!this.parent||this._options.ignoreParent)){this._physicsEngine.addImpostor(this)}};t.prototype._getPhysicsParent=function(){if(this.object.parent instanceof e.AbstractMesh){var t=this.object.parent;return t.physicsImpostor}return null};t.prototype.isBodyInitRequired=function(){return this._bodyUpdateRequired||!this._physicsBody&&!this._parent};t.prototype.setScalingUpdated=function(e){this.forceUpdate()};t.prototype.forceUpdate=function(){this._init();if(this.parent&&!this._options.ignoreParent){this.parent.forceUpdate()}};Object.defineProperty(t.prototype,"physicsBody",{get:function(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody},set:function(e){if(this._physicsBody&&this._physicsEngine){this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this)}this._physicsBody=e;this.resetUpdateFlags()},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"parent",{get:function(){return!this._options.ignoreParent&&this._parent?this._parent:null},set:function(e){this._parent=e},enumerable:true,configurable:true});t.prototype.resetUpdateFlags=function(){this._bodyUpdateRequired=false};t.prototype.getObjectExtendSize=function(){if(this.object.getBoundingInfo){var e=this.object.rotationQuaternion;this.object.rotationQuaternion=t.IDENTITY_QUATERNION;this.object.computeWorldMatrix&&this.object.computeWorldMatrix(true);var i=this.object.getBoundingInfo();var r=i.boundingBox.extendSizeWorld.scale(2);this.object.rotationQuaternion=e;this.object.computeWorldMatrix&&this.object.computeWorldMatrix(true);return r}else{return t.DEFAULT_OBJECT_SIZE}};t.prototype.getObjectCenter=function(){if(this.object.getBoundingInfo){var e=this.object.getBoundingInfo();return e.boundingBox.centerWorld}else{return this.object.position}};t.prototype.getParam=function(e){return this._options[e]};t.prototype.setParam=function(e,t){this._options[e]=t;this._bodyUpdateRequired=true};t.prototype.setMass=function(e){if(this.getParam("mass")!==e){this.setParam("mass",e)}if(this._physicsEngine){this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}};t.prototype.getLinearVelocity=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):e.Vector3.Zero()};t.prototype.setLinearVelocity=function(e){if(this._physicsEngine){this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}};t.prototype.getAngularVelocity=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):e.Vector3.Zero()};t.prototype.setAngularVelocity=function(e){if(this._physicsEngine){this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}};t.prototype.executeNativeFunction=function(e){if(this._physicsEngine){e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}};t.prototype.registerBeforePhysicsStep=function(e){this._onBeforePhysicsStepCallbacks.push(e)};t.prototype.unregisterBeforePhysicsStep=function(t){var i=this._onBeforePhysicsStepCallbacks.indexOf(t);if(i>-1){this._onBeforePhysicsStepCallbacks.splice(i,1)}else{e.Tools.Warn("Function to remove was not found")}};t.prototype.registerAfterPhysicsStep=function(e){this._onAfterPhysicsStepCallbacks.push(e)};t.prototype.unregisterAfterPhysicsStep=function(t){var i=this._onAfterPhysicsStepCallbacks.indexOf(t);if(i>-1){this._onAfterPhysicsStepCallbacks.splice(i,1)}else{e.Tools.Warn("Function to remove was not found")}};t.prototype.registerOnPhysicsCollide=function(e,t){var i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})};t.prototype.unregisterOnPhysicsCollide=function(t,i){var r=t instanceof Array?t:[t];var n=this._onPhysicsCollideCallbacks.indexOf({callback:i,otherImpostors:r});if(n>-1){this._onPhysicsCollideCallbacks.splice(n,1)}else{e.Tools.Warn("Function to remove was not found")}};t.prototype.getParentsRotation=function(){var t=this.object.parent;this._tmpQuat.copyFromFloats(0,0,0,1);while(t){if(t.rotationQuaternion){this._tmpQuat2.copyFrom(t.rotationQuaternion)}else{e.Quaternion.RotationYawPitchRollToRef(t.rotation.y,t.rotation.x,t.rotation.z,this._tmpQuat2)}this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat);t=t.parent}return this._tmpQuat};t.prototype.applyForce=function(e,t){if(this._physicsEngine){this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t)}return this};t.prototype.applyImpulse=function(e,t){if(this._physicsEngine){this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t)}return this};t.prototype.createJoint=function(t,i,r){var n=new e.PhysicsJoint(i,r);this.addJoint(t,n);return this};t.prototype.addJoint=function(e,t){this._joints.push({otherImpostor:e,joint:t});if(this._physicsEngine){this._physicsEngine.addJoint(this,e,t)}return this};t.prototype.sleep=function(){if(this._physicsEngine){this._physicsEngine.getPhysicsPlugin().sleepBody(this)}return this};t.prototype.wakeUp=function(){if(this._physicsEngine){this._physicsEngine.getPhysicsPlugin().wakeUpBody(this)}return this};t.prototype.clone=function(e){if(!e)return null;return new t(e,this.type,this._options,this._scene)};t.prototype.dispose=function(){var e=this;if(!this._physicsEngine){return}this._joints.forEach(function(t){if(e._physicsEngine){e._physicsEngine.removeJoint(e,t.otherImpostor,t.joint)}});this._physicsEngine.removeImpostor(this);if(this.parent){this.parent.forceUpdate()}else{}this._isDisposed=true};t.prototype.setDeltaPosition=function(e){this._deltaPosition.copyFrom(e)};t.prototype.setDeltaRotation=function(t){if(!this._deltaRotation){this._deltaRotation=new e.Quaternion}this._deltaRotation.copyFrom(t);this._deltaRotationConjugated=this._deltaRotation.conjugate()};t.prototype.getBoxSizeToRef=function(e){if(this._physicsEngine){this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e)}return this};t.prototype.getRadius=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0};t.prototype.syncBoneWithImpostor=function(i,r,n,o,s){var a=t._tmpVecs[0];var u=this.object;if(u.rotationQuaternion){if(s){var l=t._tmpQuat;u.rotationQuaternion.multiplyToRef(s,l);i.setRotationQuaternion(l,e.Space.WORLD,r)}else{i.setRotationQuaternion(u.rotationQuaternion,e.Space.WORLD,r)}}a.x=0;a.y=0;a.z=0;if(n){a.x=n.x;a.y=n.y;a.z=n.z;i.getDirectionToRef(a,r,a);if(o===undefined||o===null){o=n.length()}a.x*=o;a.y*=o;a.z*=o}if(i.getParent()){a.addInPlace(u.getAbsolutePosition());i.setAbsolutePosition(a,r)}else{r.setAbsolutePosition(u.getAbsolutePosition());r.position.x-=a.x;r.position.y-=a.y;r.position.z-=a.z}};t.prototype.syncImpostorWithBone=function(i,r,n,o,s,a){var u=this.object;if(u.rotationQuaternion){if(s){var l=t._tmpQuat;i.getRotationQuaternionToRef(e.Space.WORLD,r,l);l.multiplyToRef(s,u.rotationQuaternion)}else{i.getRotationQuaternionToRef(e.Space.WORLD,r,u.rotationQuaternion)}}var c=t._tmpVecs[0];var h=t._tmpVecs[1];if(!a){a=t._tmpVecs[2];a.x=0;a.y=1;a.z=0}i.getDirectionToRef(a,r,h);i.getAbsolutePositionToRef(r,c);if((o===undefined||o===null)&&n){o=n.length()}if(o!==undefined&&o!==null){c.x+=h.x*o;c.y+=h.y*o;c.z+=h.z*o}u.setAbsolutePosition(c)};t.DEFAULT_OBJECT_SIZE=new e.Vector3(1,1,1);t.IDENTITY_QUATERNION=e.Quaternion.Identity();t._tmpVecs=[e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero()];t._tmpQuat=e.Quaternion.Identity();t.NoImpostor=0;t.SphereImpostor=1;t.BoxImpostor=2;t.PlaneImpostor=3;t.MeshImpostor=4;t.CylinderImpostor=7;t.ParticleImpostor=8;t.HeightmapImpostor=9;return t}();e.PhysicsImpostor=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i){if(i===void 0){i=new e.CannonJSPlugin}this._physicsPlugin=i;this._impostors=[];this._joints=[];if(!this._physicsPlugin.isSupported()){throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. "+"Please make sure it is included.")}t=t||new e.Vector3(0,-9.807,0);this.setGravity(t);this.setTimeStep()}t.prototype.setGravity=function(e){this.gravity=e;this._physicsPlugin.setGravity(this.gravity)};t.prototype.setTimeStep=function(e){if(e===void 0){e=1/60}this._physicsPlugin.setTimeStep(e)};t.prototype.getTimeStep=function(){return this._physicsPlugin.getTimeStep()};t.prototype.dispose=function(){this._impostors.forEach(function(e){e.dispose()});this._physicsPlugin.dispose()};t.prototype.getPhysicsPluginName=function(){return this._physicsPlugin.name};t.prototype.addImpostor=function(e){e.uniqueId=this._impostors.push(e);if(!e.parent){this._physicsPlugin.generatePhysicsBody(e)}};t.prototype.removeImpostor=function(e){var t=this._impostors.indexOf(e);if(t>-1){var i=this._impostors.splice(t,1);if(i.length){i[0].physicsBody=null}}};t.prototype.addJoint=function(e,t,i){var r={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin;this._joints.push(r);this._physicsPlugin.generateJoint(r)};t.prototype.removeJoint=function(e,t,i){var r=this._joints.filter(function(r){return r.connectedImpostor===t&&r.joint===i&&r.mainImpostor===e});if(r.length){this._physicsPlugin.removeJoint(r[0])}};t.prototype._step=function(e){var t=this;this._impostors.forEach(function(e){if(e.isBodyInitRequired()){t._physicsPlugin.generatePhysicsBody(e)}});if(e>.1){e=.1}else if(e<=0){e=1/60}this._physicsPlugin.executeStep(e,this._impostors)};t.prototype.getPhysicsPlugin=function(){return this._physicsPlugin};t.prototype.getImpostors=function(){return this._impostors};t.prototype.getImpostorForPhysicsObject=function(e){for(var t=0;t<this._impostors.length;++t){if(this._impostors[t].object===e){return this._impostors[t]}}return null};t.prototype.getImpostorWithPhysicsBody=function(e){for(var t=0;t<this._impostors.length;++t){if(this._impostors[t].physicsBody===e){return this._impostors[t]}}return null};t.Epsilon=.001;return t}();e.PhysicsEngine=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t){this._scene=t;this._physicsEngine=this._scene.getPhysicsEngine();if(!this._physicsEngine){e.Tools.Warn("Physics engine not enabled. Please enable the physics before you can use the methods.")}}t.prototype.applyRadialExplosionImpulse=function(t,r,n,o){if(o===void 0){o=s.Constant}if(!this._physicsEngine){e.Tools.Warn("Physics engine not enabled. Please enable the physics before you call this method.");return null}var a=this._physicsEngine.getImpostors();if(a.length===0){return null}var u=new i(this._scene);a.forEach(function(e){var i=u.getImpostorForceAndContactPoint(e,t,r,n,o);if(!i){return}e.applyImpulse(i.force,i.contactPoint)});u.dispose(false);return u};t.prototype.applyRadialExplosionForce=function(t,r,n,o){if(o===void 0){o=s.Constant}if(!this._physicsEngine){e.Tools.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper.");return null}var a=this._physicsEngine.getImpostors();if(a.length===0){return null}var u=new i(this._scene);a.forEach(function(e){var i=u.getImpostorForceAndContactPoint(e,t,r,n,o);if(!i){return}e.applyForce(i.force,i.contactPoint)});u.dispose(false);return u};t.prototype.gravitationalField=function(t,i,n,o){if(o===void 0){o=s.Constant}if(!this._physicsEngine){e.Tools.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper.");return null}var a=this._physicsEngine.getImpostors();if(a.length===0){return null}var u=new r(this,this._scene,t,i,n,o);u.dispose(false);return u};t.prototype.updraft=function(t,i,r,o,s){if(s===void 0){s=a.Center}if(!this._physicsEngine){e.Tools.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper.");return null}if(this._physicsEngine.getImpostors().length===0){return null}var u=new n(this._scene,t,i,r,o,s);u.dispose(false);return u};t.prototype.vortex=function(t,i,r,n){if(!this._physicsEngine){e.Tools.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper.");return null}if(this._physicsEngine.getImpostors().length===0){return null}var s=new o(this._scene,t,i,r,n);s.dispose(false);return s};return t}();e.PhysicsHelper=t;var i=function(){function t(e){this._sphereOptions={segments:32,diameter:1};this._rays=[];this._dataFetched=false;this._scene=e}t.prototype.getData=function(){this._dataFetched=true;return{sphere:this._sphere,rays:this._rays}};t.prototype.getImpostorForceAndContactPoint=function(t,i,r,n,o){if(t.mass===0){return null}if(!this._intersectsWithSphere(t,i,r)){return null}if(t.object.getClassName()!=="Mesh"&&t.object.getClassName()!=="InstancedMesh"){return null}var a=t.getObjectCenter();var u=a.subtract(i);var l=new e.Ray(i,u,r);this._rays.push(l);var c=l.intersectsMesh(t.object);var h=c.pickedPoint;if(!h){return null}var f=e.Vector3.Distance(i,h);if(f>r){return null}var d=o===s.Constant?n:n*(1-f/r);var p=u.multiplyByFloats(d,d,d);return{force:p,contactPoint:h}};t.prototype.dispose=function(e){var t=this;if(e===void 0){e=true}if(e){this._sphere.dispose()}else{setTimeout(function(){if(!t._dataFetched){t._sphere.dispose()}},0)}};t.prototype._prepareSphere=function(){if(!this._sphere){this._sphere=e.MeshBuilder.CreateSphere("radialExplosionEventSphere",this._sphereOptions,this._scene);this._sphere.isVisible=false}};t.prototype._intersectsWithSphere=function(t,i,r){var n=t.object;this._prepareSphere();this._sphere.position=i;this._sphere.scaling=new e.Vector3(r*2,r*2,r*2);this._sphere._updateBoundingInfo();this._sphere.computeWorldMatrix(true);return this._sphere.intersectsMesh(n,true)};return t}();e.PhysicsRadialExplosionEvent=i;var r=function(){function e(e,t,i,r,n,o){if(o===void 0){o=s.Constant}this._dataFetched=false;this._physicsHelper=e;this._scene=t;this._origin=i;this._radius=r;this._strength=n;this._falloff=o;this._tickCallback=this._tick.bind(this)}e.prototype.getData=function(){this._dataFetched=true;return{sphere:this._sphere}};e.prototype.enable=function(){this._tickCallback.call(this);this._scene.registerBeforeRender(this._tickCallback)};e.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)};e.prototype.dispose=function(e){var t=this;if(e===void 0){e=true}if(e){this._sphere.dispose()}else{setTimeout(function(){if(!t._dataFetched){t._sphere.dispose()}},0)}};e.prototype._tick=function(){if(this._sphere){this._physicsHelper.applyRadialExplosionForce(this._origin,this._radius,this._strength*-1,this._falloff)}else{var e=this._physicsHelper.applyRadialExplosionForce(this._origin,this._radius,this._strength*-1,this._falloff);if(e){this._sphere=e.getData().sphere.clone("radialExplosionEventSphereClone")}}};return e}();e.PhysicsGravitationalFieldEvent=r;var n=function(){function t(t,i,r,n,o,s){this._scene=t;this._origin=i;this._radius=r;this._strength=n;this._height=o;this._updraftMode=s;this._originTop=e.Vector3.Zero();this._originDirection=e.Vector3.Zero();this._cylinderPosition=e.Vector3.Zero();this._dataFetched=false;this._physicsEngine=this._scene.getPhysicsEngine();this._origin.addToRef(new e.Vector3(0,this._height/2,0),this._cylinderPosition);this._origin.addToRef(new e.Vector3(0,this._height,0),this._originTop);if(this._updraftMode===a.Perpendicular){this._originDirection=this._origin.subtract(this._originTop).normalize()}this._tickCallback=this._tick.bind(this)}t.prototype.getData=function(){this._dataFetched=true;return{cylinder:this._cylinder}};t.prototype.enable=function(){this._tickCallback.call(this);this._scene.registerBeforeRender(this._tickCallback)};t.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)};t.prototype.dispose=function(e){var t=this;if(e===void 0){e=true}if(e){this._cylinder.dispose()}else{setTimeout(function(){if(!t._dataFetched){t._cylinder.dispose()}},0)}};t.prototype.getImpostorForceAndContactPoint=function(e){if(e.mass===0){return null}if(!this._intersectsWithCylinder(e)){return null}var t=e.getObjectCenter();if(this._updraftMode===a.Perpendicular){var i=this._originDirection}else{var i=t.subtract(this._originTop)}var r=this._strength*-1;var n=i.multiplyByFloats(r,r,r);return{force:n,contactPoint:t}};t.prototype._tick=function(){var e=this;this._physicsEngine.getImpostors().forEach(function(t){var i=e.getImpostorForceAndContactPoint(t);if(!i){return}t.applyForce(i.force,i.contactPoint)})};t.prototype._prepareCylinder=function(){if(!this._cylinder){this._cylinder=e.MeshBuilder.CreateCylinder("updraftEventCylinder",{height:this._height,diameter:this._radius*2},this._scene);this._cylinder.isVisible=false}};t.prototype._intersectsWithCylinder=function(e){var t=e.object;this._prepareCylinder();this._cylinder.position=this._cylinderPosition;return this._cylinder.intersectsMesh(t,true)};return t}();e.PhysicsUpdraftEvent=n;var o=function(){function t(t,i,r,n,o){this._scene=t;this._origin=i;this._radius=r;this._strength=n;this._height=o;this._originTop=e.Vector3.Zero();this._centripetalForceThreshold=.7;this._updraftMultiplier=.02;this._cylinderPosition=e.Vector3.Zero();this._dataFetched=false;this._physicsEngine=this._scene.getPhysicsEngine();this._origin.addToRef(new e.Vector3(0,this._height/2,0),this._cylinderPosition);this._origin.addToRef(new e.Vector3(0,this._height,0),this._originTop);this._tickCallback=this._tick.bind(this)}t.prototype.getData=function(){this._dataFetched=true;return{cylinder:this._cylinder}};t.prototype.enable=function(){this._tickCallback.call(this);this._scene.registerBeforeRender(this._tickCallback)};t.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)};t.prototype.dispose=function(e){var t=this;if(e===void 0){e=true}if(e){this._cylinder.dispose()}else{setTimeout(function(){if(!t._dataFetched){t._cylinder.dispose()}},0)}};t.prototype.getImpostorForceAndContactPoint=function(t){if(t.mass===0){return null}if(!this._intersectsWithCylinder(t)){return null}if(t.object.getClassName()!=="Mesh"&&t.object.getClassName()!=="InstancedMesh"){return null}var i=t.getObjectCenter();var r=new e.Vector3(this._origin.x,i.y,this._origin.z);var n=i.subtract(r);var o=new e.Ray(r,n,this._radius);var s=o.intersectsMesh(t.object);var a=s.pickedPoint;if(!a){return null}var u=s.distance/this._radius;var l=e.Vector3.Cross(r,i).normalize();var c=a.normalize();if(u>this._centripetalForceThreshold){c=c.negate()}if(u>this._centripetalForceThreshold){var h=c.x*this._strength/8;var f=c.y*this._updraftMultiplier;var d=c.z*this._strength/8}else{var h=(l.x+c.x)/2;var f=this._originTop.y*this._updraftMultiplier;var d=(l.z+c.z)/2}var p=new e.Vector3(h,f,d);p=p.multiplyByFloats(this._strength,this._strength,this._strength);return{force:p,contactPoint:i}};t.prototype._tick=function(){var e=this;this._physicsEngine.getImpostors().forEach(function(t){var i=e.getImpostorForceAndContactPoint(t);if(!i){return}t.applyForce(i.force,i.contactPoint)})};t.prototype._prepareCylinder=function(){if(!this._cylinder){this._cylinder=e.MeshBuilder.CreateCylinder("vortexEventCylinder",{height:this._height,diameter:this._radius*2},this._scene);this._cylinder.isVisible=false}};t.prototype._intersectsWithCylinder=function(e){var t=e.object;this._prepareCylinder();this._cylinder.position=this._cylinderPosition;return this._cylinder.intersectsMesh(t,true)};return t}();e.PhysicsVortexEvent=o;var s;(function(e){e[e["Constant"]=0]="Constant";e[e["Linear"]=1]="Linear"})(s=e.PhysicsRadialImpulseFalloff||(e.PhysicsRadialImpulseFalloff={}));var a;(function(e){e[e["Center"]=0]="Center";e[e["Perpendicular"]=1]="Perpendicular"})(a=e.PhysicsUpdraftMode||(e.PhysicsUpdraftMode={}))})(r||(r={}));"use strict";var r;(function(t){var i=function(){function i(i,r){if(i===void 0){i=true}if(r===void 0){r=10}this._useDeltaForWorldStep=i;this.name="CannonJSPlugin";this._physicsMaterials=new Array;this._fixedTimeStep=1/60;this.BJSCANNON=e;this._minus90X=new t.Quaternion(-.7071067811865475,0,0,.7071067811865475);this._plus90X=new t.Quaternion(.7071067811865475,0,0,.7071067811865475);this._tmpPosition=t.Vector3.Zero();this._tmpDeltaPosition=t.Vector3.Zero();this._tmpUnityRotation=new t.Quaternion;if(!this.isSupported()){t.Tools.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace();this.world=new this.BJSCANNON.World;this.world.broadphase=new this.BJSCANNON.NaiveBroadphase;this.world.solver.iterations=r}i.prototype.setGravity=function(e){this.world.gravity.copy(e)};i.prototype.setTimeStep=function(e){this._fixedTimeStep=e};i.prototype.getTimeStep=function(){return this._fixedTimeStep};i.prototype.executeStep=function(e,t){this.world.step(this._fixedTimeStep,this._useDeltaForWorldStep?e:0,3)};i.prototype.applyImpulse=function(e,t,i){var r=new this.BJSCANNON.Vec3(i.x,i.y,i.z);var n=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(n,r)};i.prototype.applyForce=function(e,t,i){var r=new this.BJSCANNON.Vec3(i.x,i.y,i.z);var n=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(n,r)};i.prototype.generatePhysicsBody=function(e){if(e.parent){if(e.physicsBody){this.removePhysicsBody(e);e.forceUpdate()}return}if(e.isBodyInitRequired()){var t=this._createShape(e);var i=e.physicsBody;if(i){this.removePhysicsBody(e)}var r=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution"));var n={mass:e.getParam("mass"),material:r};var o=e.getParam("nativeOptions");for(var s in o){if(o.hasOwnProperty(s)){n[s]=o[s]}}e.physicsBody=new this.BJSCANNON.Body(n);e.physicsBody.addEventListener("collide",e.onCollide);this.world.addEventListener("preStep",e.beforeStep);this.world.addEventListener("postStep",e.afterStep);e.physicsBody.addShape(t);this.world.add(e.physicsBody);if(i){["force","torque","velocity","angularVelocity"].forEach(function(t){e.physicsBody[t].copy(i[t])})}this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)};i.prototype._processChildMeshes=function(e){var i=this;var r=e.object.getChildMeshes?e.object.getChildMeshes(true):[];var n=e.object.rotationQuaternion;if(r.length){var o=function(r,s){if(!n||!s.rotationQuaternion){return}var a=s.getPhysicsImpostor();if(a){var u=a.parent;if(u!==e){var l=s.getAbsolutePosition().subtract(e.object.getAbsolutePosition());var c=s.rotationQuaternion.multiply(t.Quaternion.Inverse(n));if(a.physicsBody){i.removePhysicsBody(a);a.physicsBody=null}a.parent=e;a.resetUpdateFlags();e.physicsBody.addShape(i._createShape(a),new i.BJSCANNON.Vec3(l.x,l.y,l.z),new i.BJSCANNON.Quaternion(c.x,c.y,c.z,c.w));e.physicsBody.mass+=a.getParam("mass")}}n.multiplyInPlace(s.rotationQuaternion);s.getChildMeshes(true).filter(function(e){return!!e.physicsImpostor}).forEach(o.bind(i,s.getAbsolutePosition()))};r.filter(function(e){return!!e.physicsImpostor}).forEach(o.bind(this,e.object.getAbsolutePosition()))}};i.prototype.removePhysicsBody=function(e){e.physicsBody.removeEventListener("collide",e.onCollide);this.world.removeEventListener("preStep",e.beforeStep);this.world.removeEventListener("postStep",e.afterStep);this.world.remove(e.physicsBody)};i.prototype.generateJoint=function(e){var i=e.mainImpostor.physicsBody;var r=e.connectedImpostor.physicsBody;if(!i||!r){return}var n;var o=e.joint.jointData;var s={pivotA:o.mainPivot?(new this.BJSCANNON.Vec3).copy(o.mainPivot):null,pivotB:o.connectedPivot?(new this.BJSCANNON.Vec3).copy(o.connectedPivot):null,axisA:o.mainAxis?(new this.BJSCANNON.Vec3).copy(o.mainAxis):null,axisB:o.connectedAxis?(new this.BJSCANNON.Vec3).copy(o.connectedAxis):null,maxForce:o.nativeParams.maxForce,collideConnected:!!o.collision};switch(e.joint.type){case t.PhysicsJoint.HingeJoint:case t.PhysicsJoint.Hinge2Joint:n=new this.BJSCANNON.HingeConstraint(i,r,s);break;case t.PhysicsJoint.DistanceJoint:n=new this.BJSCANNON.DistanceConstraint(i,r,o.maxDistance||2);break;case t.PhysicsJoint.SpringJoint:var a=o;n=new this.BJSCANNON.Spring(i,r,{restLength:a.length,stiffness:a.stiffness,damping:a.damping,localAnchorA:s.pivotA,localAnchorB:s.pivotB});break;case t.PhysicsJoint.LockJoint:n=new this.BJSCANNON.LockConstraint(i,r,s);break;case t.PhysicsJoint.PointToPointJoint:case t.PhysicsJoint.BallAndSocketJoint:default:n=new this.BJSCANNON.PointToPointConstraint(i,s.pivotA,r,s.pivotA,s.maxForce);break}n.collideConnected=!!o.collision;e.joint.physicsJoint=n;if(e.joint.type!==t.PhysicsJoint.SpringJoint){this.world.addConstraint(n)}else{e.mainImpostor.registerAfterPhysicsStep(function(){n.applyForce()})}};i.prototype.removeJoint=function(e){this.world.removeConstraint(e.joint.physicsJoint)};i.prototype._addMaterial=function(e,t,i){var r;var n;for(r=0;r<this._physicsMaterials.length;r++){n=this._physicsMaterials[r];if(n.friction===t&&n.restitution===i){return n}}var o=new this.BJSCANNON.Material(e);o.friction=t;o.restitution=i;this._physicsMaterials.push(o);return o};i.prototype._checkWithEpsilon=function(e){return e<t.PhysicsEngine.Epsilon?t.PhysicsEngine.Epsilon:e};i.prototype._createShape=function(e){var i=e.object;var r;var n=e.getObjectExtendSize();switch(e.type){case t.PhysicsImpostor.SphereImpostor:var o=n.x;var s=n.y;var a=n.z;r=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(o),this._checkWithEpsilon(s),this._checkWithEpsilon(a))/2);break;case t.PhysicsImpostor.CylinderImpostor:r=new this.BJSCANNON.Cylinder(this._checkWithEpsilon(n.x)/2,this._checkWithEpsilon(n.x)/2,this._checkWithEpsilon(n.y),16);break;case t.PhysicsImpostor.BoxImpostor:var u=n.scale(.5);r=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(u.x),this._checkWithEpsilon(u.y),this._checkWithEpsilon(u.z)));break;case t.PhysicsImpostor.PlaneImpostor:t.Tools.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead");r=new this.BJSCANNON.Plane;break;case t.PhysicsImpostor.MeshImpostor:var l=i.getVerticesData?i.getVerticesData(t.VertexBuffer.PositionKind):[];var c=i.getIndices?i.getIndices():[];if(!l)return;var h=i.position.clone();var f=i.rotation&&i.rotation.clone();var d=i.rotationQuaternion&&i.rotationQuaternion.clone();i.position.copyFromFloats(0,0,0);i.rotation&&i.rotation.copyFromFloats(0,0,0);i.rotationQuaternion&&i.rotationQuaternion.copyFrom(e.getParentsRotation());i.rotationQuaternion&&i.parent&&i.rotationQuaternion.conjugateInPlace();var p=i.computeWorldMatrix(true);var _=new Array;var m;for(m=0;m<l.length;m+=3){t.Vector3.TransformCoordinates(t.Vector3.FromArray(l,m),p).toArray(_,m)}t.Tools.Warn("MeshImpostor only collides against spheres.");r=new this.BJSCANNON.Trimesh(_,c);i.position.copyFrom(h);f&&i.rotation&&i.rotation.copyFrom(f);d&&i.rotationQuaternion&&i.rotationQuaternion.copyFrom(d);break;case t.PhysicsImpostor.HeightmapImpostor:var g=i.position.clone();var v=i.rotation&&i.rotation.clone();var y=i.rotationQuaternion&&i.rotationQuaternion.clone();i.position.copyFromFloats(0,0,0);i.rotation&&i.rotation.copyFromFloats(0,0,0);i.rotationQuaternion&&i.rotationQuaternion.copyFrom(e.getParentsRotation());i.rotationQuaternion&&i.parent&&i.rotationQuaternion.conjugateInPlace();i.rotationQuaternion&&i.rotationQuaternion.multiplyInPlace(this._minus90X);r=this._createHeightmap(i);i.position.copyFrom(g);v&&i.rotation&&i.rotation.copyFrom(v);y&&i.rotationQuaternion&&i.rotationQuaternion.copyFrom(y);i.computeWorldMatrix(true);break;case t.PhysicsImpostor.ParticleImpostor:r=new this.BJSCANNON.Particle;break}return r};i.prototype._createHeightmap=function(e,i){var r=e.getVerticesData(t.VertexBuffer.PositionKind);var n=e.computeWorldMatrix(true);var o=new Array;var s;for(s=0;s<r.length;s+=3){t.Vector3.TransformCoordinates(t.Vector3.FromArray(r,s),n).toArray(o,s)}r=o;var a=new Array;var u=i||~~(Math.sqrt(r.length/3)-1);var l=e.getBoundingInfo();var c=Math.min(l.boundingBox.extendSizeWorld.x,l.boundingBox.extendSizeWorld.y);var h=l.boundingBox.extendSizeWorld.z;var f=c*2/u;for(var d=0;d<r.length;d=d+3){var p=Math.round(r[d+0]/f+u/2);var _=Math.round((r[d+1]/f-u/2)*-1);var m=-r[d+2]+h;if(!a[p]){a[p]=[]}if(!a[p][_]){a[p][_]=m}a[p][_]=Math.max(m,a[p][_])}for(var p=0;p<=u;++p){if(!a[p]){var g=1;while(!a[(p+g)%u]){g++}a[p]=a[(p+g)%u].slice()}for(var _=0;_<=u;++_){if(!a[p][_]){var g=1;var v;while(v===undefined){v=a[p][(_+g++)%u]}a[p][_]=v}}}var y=new this.BJSCANNON.Heightfield(a,{elementSize:f});y.minY=h;return y};i.prototype._updatePhysicsBodyTransformation=function(e){var i=e.object;i.computeWorldMatrix&&i.computeWorldMatrix(true);var r=i.getBoundingInfo();if(!r)return;var n=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(i.getAbsolutePivotPoint().subtract(n));this._tmpDeltaPosition.divideInPlace(e.object.scaling);this._tmpPosition.copyFrom(n);var o=i.rotationQuaternion;if(!o){return}if(e.type===t.PhysicsImpostor.PlaneImpostor||e.type===t.PhysicsImpostor.HeightmapImpostor||e.type===t.PhysicsImpostor.CylinderImpostor){o=o.multiply(this._minus90X);e.setDeltaRotation(this._plus90X)}if(e.type===t.PhysicsImpostor.HeightmapImpostor){var s=i;var a=s.getBoundingInfo();var u=s.rotationQuaternion;s.rotationQuaternion=this._tmpUnityRotation;s.computeWorldMatrix(true);var l=n.clone();var c=s.getPivotMatrix()||t.Matrix.Translation(0,0,0);var h=t.Matrix.Translation(a.boundingBox.extendSizeWorld.x,0,-a.boundingBox.extendSizeWorld.z);s.setPreTransformMatrix(h);s.computeWorldMatrix(true);var f=a.boundingBox.centerWorld.subtract(n).subtract(s.position).negate();this._tmpPosition.copyFromFloats(f.x,f.y-a.boundingBox.extendSizeWorld.y,f.z);this._tmpDeltaPosition.copyFrom(a.boundingBox.centerWorld.subtract(l));this._tmpDeltaPosition.y+=a.boundingBox.extendSizeWorld.y;s.rotationQuaternion=u;s.setPreTransformMatrix(c);s.computeWorldMatrix(true)}else if(e.type===t.PhysicsImpostor.MeshImpostor){this._tmpDeltaPosition.copyFromFloats(0,0,0)}e.setDeltaPosition(this._tmpDeltaPosition);e.physicsBody.position.copy(this._tmpPosition);e.physicsBody.quaternion.copy(o)};i.prototype.setTransformationFromPhysicsBody=function(e){e.object.position.copyFrom(e.physicsBody.position);if(e.object.rotationQuaternion){e.object.rotationQuaternion.copyFrom(e.physicsBody.quaternion)}};i.prototype.setPhysicsBodyTransformation=function(e,t,i){e.physicsBody.position.copy(t);e.physicsBody.quaternion.copy(i)};i.prototype.isSupported=function(){return this.BJSCANNON!==undefined}
;i.prototype.setLinearVelocity=function(e,t){e.physicsBody.velocity.copy(t)};i.prototype.setAngularVelocity=function(e,t){e.physicsBody.angularVelocity.copy(t)};i.prototype.getLinearVelocity=function(e){var i=e.physicsBody.velocity;if(!i){return null}return new t.Vector3(i.x,i.y,i.z)};i.prototype.getAngularVelocity=function(e){var i=e.physicsBody.angularVelocity;if(!i){return null}return new t.Vector3(i.x,i.y,i.z)};i.prototype.setBodyMass=function(e,t){e.physicsBody.mass=t;e.physicsBody.updateMassProperties()};i.prototype.getBodyMass=function(e){return e.physicsBody.mass};i.prototype.getBodyFriction=function(e){return e.physicsBody.material.friction};i.prototype.setBodyFriction=function(e,t){e.physicsBody.material.friction=t};i.prototype.getBodyRestitution=function(e){return e.physicsBody.material.restitution};i.prototype.setBodyRestitution=function(e,t){e.physicsBody.material.restitution=t};i.prototype.sleepBody=function(e){e.physicsBody.sleep()};i.prototype.wakeUpBody=function(e){e.physicsBody.wakeUp()};i.prototype.updateDistanceJoint=function(e,t,i){e.physicsJoint.distance=t};i.prototype.setMotor=function(e,t,i,r){if(!r){e.physicsJoint.enableMotor();e.physicsJoint.setMotorSpeed(t);if(i){this.setLimit(e,i)}}};i.prototype.setLimit=function(e,t,i){e.physicsJoint.motorEquation.maxForce=t;e.physicsJoint.motorEquation.minForce=i===void 0?-t:i};i.prototype.syncMeshWithImpostor=function(e,t){var i=t.physicsBody;e.position.x=i.position.x;e.position.y=i.position.y;e.position.z=i.position.z;if(e.rotationQuaternion){e.rotationQuaternion.x=i.quaternion.x;e.rotationQuaternion.y=i.quaternion.y;e.rotationQuaternion.z=i.quaternion.z;e.rotationQuaternion.w=i.quaternion.w}};i.prototype.getRadius=function(e){var t=e.physicsBody.shapes[0];return t.boundingSphereRadius};i.prototype.getBoxSizeToRef=function(e,t){var i=e.physicsBody.shapes[0];t.x=i.halfExtents.x*2;t.y=i.halfExtents.y*2;t.z=i.halfExtents.z*2};i.prototype.dispose=function(){};i.prototype._extendNamespace=function(){var e=new this.BJSCANNON.Vec3;var t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,r,n){n=n||10;r=r||0;if(r===0){this.internalStep(i);this.time+=i}else{var o=Math.floor((this.time+r)/i)-Math.floor(this.time/i);o=Math.min(o,n)||1;var s=performance.now();for(var a=0;a!==o;a++){this.internalStep(i);if(performance.now()-s>i*1e3){break}}this.time+=r;var u=this.time%i;var l=u/i;var c=e;var h=this.bodies;for(var f=0;f!==h.length;f++){var d=h[f];if(d.type!==t.Body.STATIC&&d.sleepState!==t.Body.SLEEPING){d.position.vsub(d.previousPosition,c);c.scale(l,c);d.position.vadd(c,d.interpolatedPosition)}else{d.interpolatedPosition.copy(d.position);d.interpolatedQuaternion.copy(d.quaternion)}}}}};return i}();t.CannonJSPlugin=i})(r||(r={}));"use strict";var r;(function(e){var i=function(){function i(i){this.name="OimoJSPlugin";this._tmpImpostorsArray=[];this._tmpPositionVector=e.Vector3.Zero();this.BJSOIMO=t;this.world=new this.BJSOIMO.World({iterations:i});this.world.clear()}i.prototype.setGravity=function(e){this.world.gravity.copy(e)};i.prototype.setTimeStep=function(e){this.world.timeStep=e};i.prototype.getTimeStep=function(){return this.world.timeStep};i.prototype.executeStep=function(e,t){var i=this;t.forEach(function(e){e.beforeStep()});this.world.step();t.forEach(function(e){e.afterStep();i._tmpImpostorsArray[e.uniqueId]=e});var r=this.world.contacts;while(r!==null){if(r.touching&&!r.body1.sleeping&&!r.body2.sleeping){r=r.next;continue}var n=this._tmpImpostorsArray[+r.body1.name];var o=this._tmpImpostorsArray[+r.body2.name];if(!n||!o){r=r.next;continue}n.onCollide({body:o.physicsBody});o.onCollide({body:n.physicsBody});r=r.next}};i.prototype.applyImpulse=function(e,t,i){var r=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*r))};i.prototype.applyForce=function(t,i,r){e.Tools.Warn("Oimo doesn't support applying force. Using impule instead.");this.applyImpulse(t,i,r)};i.prototype.generatePhysicsBody=function(t){var i=this;if(t.parent){if(t.physicsBody){this.removePhysicsBody(t);t.forceUpdate()}return}if(t.isBodyInitRequired()){var r={name:t.uniqueId,config:[t.getParam("mass")||1,t.getParam("friction"),t.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:t.getParam("mass")!==0,density:t.getParam("mass"),friction:t.getParam("friction"),restitution:t.getParam("restitution"),world:this.world};var n=[t];var o=function(e){if(!e.getChildMeshes)return;e.getChildMeshes().forEach(function(e){if(e.physicsImpostor){n.push(e.physicsImpostor)}})};o(t.object);var s=function(t){return Math.max(t,e.PhysicsEngine.Epsilon)};n.forEach(function(n){if(!n.object.rotationQuaternion){return}var o=n.object.rotationQuaternion;var a=o.toEulerAngles();var u=n.getObjectExtendSize();var l=57.29577951308232;if(n===t){var c=t.getObjectCenter();t.object.getAbsolutePivotPoint().subtractToRef(c,i._tmpPositionVector);i._tmpPositionVector.divideInPlace(t.object.scaling);r.pos.push(c.x);r.pos.push(c.y);r.pos.push(c.z);r.posShape.push(0,0,0);r.rot.push(a.x*l);r.rot.push(a.y*l);r.rot.push(a.z*l);r.rotShape.push(0,0,0)}else{var h=n.object.getAbsolutePosition().subtract(t.object.getAbsolutePosition());r.posShape.push(h.x);r.posShape.push(h.y);r.posShape.push(h.z);r.pos.push(0,0,0);r.rot.push(0);r.rot.push(0);r.rot.push(0);r.rotShape.push(a.x*l);r.rotShape.push(a.y*l);r.rotShape.push(a.z*l)}switch(n.type){case e.PhysicsImpostor.ParticleImpostor:e.Tools.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case e.PhysicsImpostor.SphereImpostor:var f=u.x;var d=u.y;var p=u.z;var _=Math.max(s(f),s(d),s(p))/2;r.type.push("sphere");r.size.push(_);r.size.push(_);r.size.push(_);break;case e.PhysicsImpostor.CylinderImpostor:var m=s(u.x)/2;var g=s(u.y);r.type.push("cylinder");r.size.push(m);r.size.push(g);r.size.push(g);break;case e.PhysicsImpostor.PlaneImpostor:case e.PhysicsImpostor.BoxImpostor:default:var m=s(u.x);var g=s(u.y);var v=s(u.z);r.type.push("box");r.size.push(m);r.size.push(g);r.size.push(v);break}n.object.rotationQuaternion=o});t.physicsBody=this.world.add(r)}else{this._tmpPositionVector.copyFromFloats(0,0,0)}t.setDeltaPosition(this._tmpPositionVector)};i.prototype.removePhysicsBody=function(e){this.world.removeRigidBody(e.physicsBody)};i.prototype.generateJoint=function(t){var i=t.mainImpostor.physicsBody;var r=t.connectedImpostor.physicsBody;if(!i||!r){return}var n=t.joint.jointData;var o=n.nativeParams||{};var s;var a={body1:i,body2:r,axe1:o.axe1||(n.mainAxis?n.mainAxis.asArray():null),axe2:o.axe2||(n.connectedAxis?n.connectedAxis.asArray():null),pos1:o.pos1||(n.mainPivot?n.mainPivot.asArray():null),pos2:o.pos2||(n.connectedPivot?n.connectedPivot.asArray():null),min:o.min,max:o.max,collision:o.collision||n.collision,spring:o.spring,world:this.world};switch(t.joint.type){case e.PhysicsJoint.BallAndSocketJoint:s="jointBall";break;case e.PhysicsJoint.SpringJoint:e.Tools.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");var u=n;a.min=u.length||a.min;a.max=Math.max(a.min,a.max);case e.PhysicsJoint.DistanceJoint:s="jointDistance";a.max=n.maxDistance;break;case e.PhysicsJoint.PrismaticJoint:s="jointPrisme";break;case e.PhysicsJoint.SliderJoint:s="jointSlide";break;case e.PhysicsJoint.WheelJoint:s="jointWheel";break;case e.PhysicsJoint.HingeJoint:default:s="jointHinge";break}a.type=s;t.joint.physicsJoint=this.world.add(a)};i.prototype.removeJoint=function(t){try{this.world.removeJoint(t.joint.physicsJoint)}catch(t){e.Tools.Warn(t)}};i.prototype.isSupported=function(){return this.BJSOIMO!==undefined};i.prototype.setTransformationFromPhysicsBody=function(e){if(!e.physicsBody.sleeping){e.object.position.copyFrom(e.physicsBody.getPosition());if(e.object.rotationQuaternion){e.object.rotationQuaternion.copyFrom(e.physicsBody.getQuaternion())}}};i.prototype.setPhysicsBodyTransformation=function(e,t,i){var r=e.physicsBody;r.position.copy(t);r.orientation.copy(i);r.syncShapes();r.awake()};i.prototype.setLinearVelocity=function(e,t){e.physicsBody.linearVelocity.init(t.x,t.y,t.z)};i.prototype.setAngularVelocity=function(e,t){e.physicsBody.angularVelocity.init(t.x,t.y,t.z)};i.prototype.getLinearVelocity=function(t){var i=t.physicsBody.linearVelocity;if(!i){return null}return new e.Vector3(i.x,i.y,i.z)};i.prototype.getAngularVelocity=function(t){var i=t.physicsBody.angularVelocity;if(!i){return null}return new e.Vector3(i.x,i.y,i.z)};i.prototype.setBodyMass=function(e,t){var i=t===0;e.physicsBody.shapes.density=i?1:t;e.physicsBody.setupMass(i?2:1)};i.prototype.getBodyMass=function(e){return e.physicsBody.shapes.density};i.prototype.getBodyFriction=function(e){return e.physicsBody.shapes.friction};i.prototype.setBodyFriction=function(e,t){e.physicsBody.shapes.friction=t};i.prototype.getBodyRestitution=function(e){return e.physicsBody.shapes.restitution};i.prototype.setBodyRestitution=function(e,t){e.physicsBody.shapes.restitution=t};i.prototype.sleepBody=function(e){e.physicsBody.sleep()};i.prototype.wakeUpBody=function(e){e.physicsBody.awake()};i.prototype.updateDistanceJoint=function(e,t,i){e.physicsJoint.limitMotor.upperLimit=t;if(i!==void 0){e.physicsJoint.limitMotor.lowerLimit=i}};i.prototype.setMotor=function(e,t,i,r){var n=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;if(n){n.setMotor(t,i)}};i.prototype.setLimit=function(e,t,i,r){var n=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;if(n){n.setLimit(t,i===void 0?-t:i)}};i.prototype.syncMeshWithImpostor=function(e,t){var i=t.physicsBody;e.position.x=i.position.x;e.position.y=i.position.y;e.position.z=i.position.z;if(e.rotationQuaternion){e.rotationQuaternion.x=i.orientation.x;e.rotationQuaternion.y=i.orientation.y;e.rotationQuaternion.z=i.orientation.z;e.rotationQuaternion.w=i.orientation.s}};i.prototype.getRadius=function(e){return e.physicsBody.shapes.radius};i.prototype.getBoxSizeToRef=function(e,t){var i=e.physicsBody.shapes;t.x=i.halfWidth*2;t.y=i.halfHeight*2;t.z=i.halfDepth*2};i.prototype.dispose=function(){this.world.clear()};return i}();e.OimoJSPlugin=i})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){}t.GetTGAHeader=function(e){var t=0;var i={id_length:e[t++],colormap_type:e[t++],image_type:e[t++],colormap_index:e[t++]|e[t++]<<8,colormap_length:e[t++]|e[t++]<<8,colormap_size:e[t++],origin:[e[t++]|e[t++]<<8,e[t++]|e[t++]<<8],width:e[t++]|e[t++]<<8,height:e[t++]|e[t++]<<8,pixel_size:e[t++],flags:e[t++]};return i};t.UploadContent=function(i,r){if(r.length<19){e.Tools.Error("Unable to load TGA file - Not enough data to contain header");return}var n=18;var o=t.GetTGAHeader(r);if(o.id_length+n>r.length){e.Tools.Error("Unable to load TGA file - Not enough data");return}n+=o.id_length;var s=false;var a=false;var u=false;switch(o.image_type){case t._TYPE_RLE_INDEXED:s=true;case t._TYPE_INDEXED:a=true;break;case t._TYPE_RLE_RGB:s=true;case t._TYPE_RGB:break;case t._TYPE_RLE_GREY:s=true;case t._TYPE_GREY:u=true;break}var l;var c=o.pixel_size>>3;var h=o.width*o.height*c;var f;if(a){f=r.subarray(n,n+=o.colormap_length*(o.colormap_size>>3))}if(s){l=new Uint8Array(h);var d,p,_;var m=0;var g=new Uint8Array(c);while(n<h&&m<h){d=r[n++];p=(d&127)+1;if(d&128){for(_=0;_<c;++_){g[_]=r[n++]}for(_=0;_<p;++_){l.set(g,m+_*c)}m+=c*p}else{p*=c;for(_=0;_<p;++_){l[m+_]=r[n++]}m+=p}}}else{l=r.subarray(n,n+=a?o.width*o.height:h)}var v,y,b,x,T,E;switch((o.flags&t._ORIGIN_MASK)>>t._ORIGIN_SHIFT){default:case t._ORIGIN_UL:v=0;b=1;E=o.width;y=0;x=1;T=o.height;break;case t._ORIGIN_BL:v=0;b=1;E=o.width;y=o.height-1;x=-1;T=-1;break;case t._ORIGIN_UR:v=o.width-1;b=-1;E=-1;y=0;x=1;T=o.height;break;case t._ORIGIN_BR:v=o.width-1;b=-1;E=-1;y=o.height-1;x=-1;T=-1;break}var P="_getImageData"+(u?"Grey":"")+o.pixel_size+"bits";var A=t[P](o,f,l,y,x,T,v,b,E);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,o.width,o.height,0,i.RGBA,i.UNSIGNED_BYTE,A)};t._getImageData8bits=function(e,t,i,r,n,o,s,a,u){var l=i,c=t;var h=e.width,f=e.height;var d,p=0,_,m;var g=new Uint8Array(h*f*4);for(m=r;m!==o;m+=n){for(_=s;_!==u;_+=a,p++){d=l[p];g[(_+h*m)*4+3]=255;g[(_+h*m)*4+2]=c[d*3+0];g[(_+h*m)*4+1]=c[d*3+1];g[(_+h*m)*4+0]=c[d*3+2]}}return g};t._getImageData16bits=function(e,t,i,r,n,o,s,a,u){var l=i;var c=e.width,h=e.height;var f,d=0,p,_;var m=new Uint8Array(c*h*4);for(_=r;_!==o;_+=n){for(p=s;p!==u;p+=a,d+=2){f=l[d+0]+(l[d+1]<<8);var g=((f&31744)>>10)*255/31|0;var v=((f&992)>>5)*255/31|0;var y=(f&31)*255/31|0;m[(p+c*_)*4+0]=g;m[(p+c*_)*4+1]=v;m[(p+c*_)*4+2]=y;m[(p+c*_)*4+3]=f&32768?0:255}}return m};t._getImageData24bits=function(e,t,i,r,n,o,s,a,u){var l=i;var c=e.width,h=e.height;var f=0,d,p;var _=new Uint8Array(c*h*4);for(p=r;p!==o;p+=n){for(d=s;d!==u;d+=a,f+=3){_[(d+c*p)*4+3]=255;_[(d+c*p)*4+2]=l[f+0];_[(d+c*p)*4+1]=l[f+1];_[(d+c*p)*4+0]=l[f+2]}}return _};t._getImageData32bits=function(e,t,i,r,n,o,s,a,u){var l=i;var c=e.width,h=e.height;var f=0,d,p;var _=new Uint8Array(c*h*4);for(p=r;p!==o;p+=n){for(d=s;d!==u;d+=a,f+=4){_[(d+c*p)*4+2]=l[f+0];_[(d+c*p)*4+1]=l[f+1];_[(d+c*p)*4+0]=l[f+2];_[(d+c*p)*4+3]=l[f+3]}}return _};t._getImageDataGrey8bits=function(e,t,i,r,n,o,s,a,u){var l=i;var c=e.width,h=e.height;var f,d=0,p,_;var m=new Uint8Array(c*h*4);for(_=r;_!==o;_+=n){for(p=s;p!==u;p+=a,d++){f=l[d];m[(p+c*_)*4+0]=f;m[(p+c*_)*4+1]=f;m[(p+c*_)*4+2]=f;m[(p+c*_)*4+3]=255}}return m};t._getImageDataGrey16bits=function(e,t,i,r,n,o,s,a,u){var l=i;var c=e.width,h=e.height;var f=0,d,p;var _=new Uint8Array(c*h*4);for(p=r;p!==o;p+=n){for(d=s;d!==u;d+=a,f+=2){_[(d+c*p)*4+0]=l[f+0];_[(d+c*p)*4+1]=l[f+0];_[(d+c*p)*4+2]=l[f+0];_[(d+c*p)*4+3]=l[f+1]}}return _};t._TYPE_INDEXED=1;t._TYPE_RGB=2;t._TYPE_GREY=3;t._TYPE_RLE_INDEXED=9;t._TYPE_RLE_RGB=10;t._TYPE_RLE_GREY=11;t._ORIGIN_MASK=48;t._ORIGIN_SHIFT=4;t._ORIGIN_BL=0;t._ORIGIN_BR=1;t._ORIGIN_UL=2;t._ORIGIN_UR=3;return t}();e.TGATools=t})(r||(r={}));"use strict";var r;(function(e){var t=542327876;var i=131072;var r=512;var n=4,o=64,s=131072;function a(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function u(e){return String.fromCharCode(e&255,e>>8&255,e>>16&255,e>>24&255)}var l=a("DXT1");var c=a("DXT3");var h=a("DXT5");var f=a("DX10");var d=113;var p=116;var _=10;var m=88;var g=31;var v=0;var y=1;var b=2;var x=3;var T=4;var E=7;var P=20;var A=21;var M=22;var S=23;var C=24;var R=25;var O=26;var I=28;var D=32;var w=function(){function a(){}a.GetDDSInfo=function(t){var a=new Int32Array(t,0,g);var u=new Int32Array(t,0,g+4);var m=1;if(a[b]&i){m=Math.max(1,a[E])}var v=a[A];var y=v===f?u[D]:0;var M=e.Engine.TEXTURETYPE_UNSIGNED_INT;switch(v){case d:M=e.Engine.TEXTURETYPE_HALF_FLOAT;break;case p:M=e.Engine.TEXTURETYPE_FLOAT;break;case f:if(y===_){M=e.Engine.TEXTURETYPE_HALF_FLOAT;break}}return{width:a[T],height:a[x],mipmapCount:m,isFourCC:(a[P]&n)===n,isRGB:(a[P]&o)===o,isLuminance:(a[P]&s)===s,isCube:(a[I]&r)===r,isCompressed:v===l||v===c||v===h,dxgiFormat:y,textureType:M}};a._ToHalfFloat=function(e){if(!a._FloatView){a._FloatView=new Float32Array(1);a._Int32View=new Int32Array(a._FloatView.buffer)}a._FloatView[0]=e;var t=a._Int32View[0];var i=t>>16&32768;var r=t>>12&2047;var n=t>>23&255;if(n<103){return i}if(n>142){i|=31744;i|=(n==255?0:1)&&t&8388607;return i}if(n<113){r|=2048;i|=(r>>114-n)+(r>>113-n&1);return i}i|=n-112<<10|r>>1;i+=r&1;return i};a._FromHalfFloat=function(e){var t=(e&32768)>>15;var i=(e&31744)>>10;var r=e&1023;if(i===0){return(t?-1:1)*Math.pow(2,-14)*(r/Math.pow(2,10))}else if(i==31){return r?NaN:(t?-1:1)*Infinity}return(t?-1:1)*Math.pow(2,i-15)*(1+r/Math.pow(2,10))};a._GetHalfFloatAsFloatRGBAArrayBuffer=function(e,t,i,r,n,o){var s=new Float32Array(r);var u=new Uint16Array(n,i);var l=0;for(var c=0;c<t;c++){for(var h=0;h<e;h++){var f=(h+c*e)*4;s[l]=a._FromHalfFloat(u[f]);s[l+1]=a._FromHalfFloat(u[f+1]);s[l+2]=a._FromHalfFloat(u[f+2]);if(a.StoreLODInAlphaChannel){s[l+3]=o}else{s[l+3]=a._FromHalfFloat(u[f+3])}l+=4}}return s};a._GetHalfFloatRGBAArrayBuffer=function(e,t,i,r,n,o){if(a.StoreLODInAlphaChannel){var s=new Uint16Array(r);var u=new Uint16Array(n,i);var l=0;for(var c=0;c<t;c++){for(var h=0;h<e;h++){var f=(h+c*e)*4;s[l]=u[f];s[l+1]=u[f+1];s[l+2]=u[f+2];s[l+3]=a._ToHalfFloat(o);l+=4}}return s}return new Uint16Array(n,i,r)};a._GetFloatRGBAArrayBuffer=function(e,t,i,r,n,o){if(a.StoreLODInAlphaChannel){var s=new Float32Array(r);var u=new Float32Array(n,i);var l=0;for(var c=0;c<t;c++){for(var h=0;h<e;h++){var f=(h+c*e)*4;s[l]=u[f];s[l+1]=u[f+1];s[l+2]=u[f+2];s[l+3]=o;l+=4}}return s}return new Float32Array(n,i,r)};a._GetFloatAsUIntRGBAArrayBuffer=function(t,i,r,n,o,s){var u=new Uint8Array(n);var l=new Float32Array(o,r);var c=0;for(var h=0;h<i;h++){for(var f=0;f<t;f++){var d=(f+h*t)*4;u[c]=e.Scalar.Clamp(l[d])*255;u[c+1]=e.Scalar.Clamp(l[d+1])*255;u[c+2]=e.Scalar.Clamp(l[d+2])*255;if(a.StoreLODInAlphaChannel){u[c+3]=s}else{u[c+3]=e.Scalar.Clamp(l[d+3])*255}c+=4}}return u};a._GetHalfFloatAsUIntRGBAArrayBuffer=function(t,i,r,n,o,s){var u=new Uint8Array(n);var l=new Uint16Array(o,r);var c=0;for(var h=0;h<i;h++){for(var f=0;f<t;f++){var d=(f+h*t)*4;u[c]=e.Scalar.Clamp(a._FromHalfFloat(l[d]))*255;u[c+1]=e.Scalar.Clamp(a._FromHalfFloat(l[d+1]))*255;u[c+2]=e.Scalar.Clamp(a._FromHalfFloat(l[d+2]))*255;if(a.StoreLODInAlphaChannel){u[c+3]=s}else{u[c+3]=e.Scalar.Clamp(a._FromHalfFloat(l[d+3]))*255}c+=4}}return u};a._GetRGBAArrayBuffer=function(e,t,i,r,n,o,s,a,u){var l=new Uint8Array(r);var c=new Uint8Array(n,i);var h=0;for(var f=0;f<t;f++){for(var d=0;d<e;d++){var p=(d+f*e)*4;l[h]=c[p+o];l[h+1]=c[p+s];l[h+2]=c[p+a];l[h+3]=c[p+u];h+=4}}return l};a._ExtractLongWordOrder=function(e){if(e===0||e===255||e===-16777216){return 0}return 1+a._ExtractLongWordOrder(e>>8)};a._GetRGBArrayBuffer=function(e,t,i,r,n,o,s,a){var u=new Uint8Array(r);var l=new Uint8Array(n,i);var c=0;for(var h=0;h<t;h++){for(var f=0;f<e;f++){var d=(f+h*e)*3;u[c]=l[d+o];u[c+1]=l[d+s];u[c+2]=l[d+a];c+=3}}return u};a._GetLuminanceArrayBuffer=function(e,t,i,r,n){var o=new Uint8Array(r);var s=new Uint8Array(n,i);var a=0;for(var u=0;u<t;u++){for(var l=0;l<e;l++){var c=l+u*e;o[a]=s[c];a++}}return o};a.UploadDDSLevels=function(r,n,o,s,P,I,D,w){if(D===void 0){D=-1}var L=r.getCaps().s3tc;var F=new Int32Array(o,0,g);var B,V,N,U=0,k;var z,G,W;var H=0;var j=0;var X=1;if(F[v]!==t){e.Tools.Error("Invalid magic number in DDS header");return}if(!s.isFourCC&&!s.isRGB&&!s.isLuminance){e.Tools.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(s.isCompressed&&!L){e.Tools.Error("Compressed textures are not supported on this platform.");return}var Y=F[M];k=F[y]+4;var K=false;if(s.isFourCC){B=F[A];switch(B){case l:X=8;H=L.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case c:X=16;H=L.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case h:X=16;H=L.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case d:K=true;break;case p:K=true;break;case f:k+=5*4;var Q=false;switch(s.dxgiFormat){case _:K=true;Q=true;break;case m:s.isRGB=true;s.isFourCC=false;Y=32;Q=true;break}if(Q){break}default:console.error("Unsupported FourCC code:",u(B));return}}var Z=a._ExtractLongWordOrder(F[S]);var q=a._ExtractLongWordOrder(F[C]);var J=a._ExtractLongWordOrder(F[R]);var $=a._ExtractLongWordOrder(F[O]);if(K){j=r._getWebGLTextureType(s.textureType);H=r._getRGBABufferInternalSizedFormat(s.textureType)}G=1;if(F[b]&i&&P!==false){G=Math.max(1,F[E])}for(var ee=0;ee<I;ee++){var te=I===1?n.TEXTURE_2D:n.TEXTURE_CUBE_MAP_POSITIVE_X+ee+(w?w:0);V=F[T];N=F[x];for(W=0;W<G;++W){if(D===-1||D===W){var ie=D===-1?W:0;if(!s.isCompressed&&s.isFourCC){U=V*N*4;var re=null;if(r._badOS||r._badDesktopOS||!r.getCaps().textureHalfFloat&&!r.getCaps().textureFloat){if(Y===128){re=a._GetFloatAsUIntRGBAArrayBuffer(V,N,k,U,o,ie)}else if(Y===64){re=a._GetHalfFloatAsUIntRGBAArrayBuffer(V,N,k,U,o,ie)}s.textureType=e.Engine.TEXTURETYPE_UNSIGNED_INT;j=r._getWebGLTextureType(s.textureType);H=r._getRGBABufferInternalSizedFormat(s.textureType)}else{if(Y===128){re=a._GetFloatRGBAArrayBuffer(V,N,k,U,o,ie)}else if(Y===64&&!r.getCaps().textureHalfFloat){re=a._GetHalfFloatAsFloatRGBAArrayBuffer(V,N,k,U,o,ie);s.textureType=e.Engine.TEXTURETYPE_FLOAT;j=r._getWebGLTextureType(s.textureType);H=r._getRGBABufferInternalSizedFormat(s.textureType)}else{re=a._GetHalfFloatRGBAArrayBuffer(V,N,k,U,o,ie)}}if(re){r._uploadDataToTexture(te,ie,H,V,N,n.RGBA,j,re)}}else if(s.isRGB){if(Y===24){U=V*N*3;z=a._GetRGBArrayBuffer(V,N,k,U,o,Z,q,J);r._uploadDataToTexture(te,ie,n.RGB,V,N,n.RGB,n.UNSIGNED_BYTE,z)}else{U=V*N*4;z=a._GetRGBAArrayBuffer(V,N,k,U,o,Z,q,J,$);r._uploadDataToTexture(te,ie,n.RGBA,V,N,n.RGBA,n.UNSIGNED_BYTE,z)}}else if(s.isLuminance){var ne=n.getParameter(n.UNPACK_ALIGNMENT);var oe=V;var se=Math.floor((V+ne-1)/ne)*ne;U=se*(N-1)+oe;z=a._GetLuminanceArrayBuffer(V,N,k,U,o);r._uploadDataToTexture(te,ie,n.LUMINANCE,V,N,n.LUMINANCE,n.UNSIGNED_BYTE,z)}else{U=Math.max(4,V)/4*Math.max(4,N)/4*X;z=new Uint8Array(o,k,U);r._uploadCompressedDataToTexture(te,ie,H,V,N,z)}}k+=Y?V*N*(Y/8):U;V*=.5;N*=.5;V=Math.max(1,V);N=Math.max(1,N)}if(w!==undefined){break}}};a.StoreLODInAlphaChannel=false;return a}();e.DDSTools=w})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(i,r,n,o){this.arrayBuffer=i;var s=new Uint8Array(this.arrayBuffer,0,12);if(s[0]!==171||s[1]!==75||s[2]!==84||s[3]!==88||s[4]!==32||s[5]!==49||s[6]!==49||s[7]!==187||s[8]!==13||s[9]!==10||s[10]!==26||s[11]!==10){e.Tools.Error("texture missing KTX identifier");return}var a=new Int32Array(this.arrayBuffer,12,13);var u=a[0]===16909060;this.glType=u?this.switchEndainness(a[1]):a[1];this.glTypeSize=u?this.switchEndainness(a[2]):a[2];this.glFormat=u?this.switchEndainness(a[3]):a[3];this.glInternalFormat=u?this.switchEndainness(a[4]):a[4];this.glBaseInternalFormat=u?this.switchEndainness(a[5]):a[5];this.pixelWidth=u?this.switchEndainness(a[6]):a[6];this.pixelHeight=u?this.switchEndainness(a[7]):a[7];this.pixelDepth=u?this.switchEndainness(a[8]):a[8];this.numberOfArrayElements=u?this.switchEndainness(a[9]):a[9];this.numberOfFaces=u?this.switchEndainness(a[10]):a[10];this.numberOfMipmapLevels=u?this.switchEndainness(a[11]):a[11];this.bytesOfKeyValueData=u?this.switchEndainness(a[12]):a[12];if(this.glType!==0){e.Tools.Error("only compressed formats currently supported");return}else{this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels)}if(this.pixelHeight===0||this.pixelDepth!==0){e.Tools.Error("only 2D textures currently supported");return}if(this.numberOfArrayElements!==0){e.Tools.Error("texture arrays not currently supported");return}if(this.numberOfFaces!==r){e.Tools.Error("number of faces expected"+r+", but found "+this.numberOfFaces);return}this.loadType=t.COMPRESSED_2D}t.prototype.switchEndainness=function(e){return(e&255)<<24|(e&65280)<<8|e>>8&65280|e>>24&255};t.prototype.uploadLevels=function(e,i){switch(this.loadType){case t.COMPRESSED_2D:this._upload2DCompressedLevels(e,i);break;case t.TEX_2D:case t.COMPRESSED_3D:case t.TEX_3D:}};t.prototype._upload2DCompressedLevels=function(e,i){var r=t.HEADER_LEN+this.bytesOfKeyValueData;var n=this.pixelWidth;var o=this.pixelHeight;var s=i?this.numberOfMipmapLevels:1;for(var a=0;a<s;a++){var u=new Int32Array(this.arrayBuffer,r,1)[0];for(var l=0;l<this.numberOfFaces;l++){var c=this.numberOfFaces===1?e.TEXTURE_2D:e.TEXTURE_CUBE_MAP_POSITIVE_X+l;var h=new Uint8Array(this.arrayBuffer,r+4,u);e.compressedTexImage2D(c,a,this.glInternalFormat,n,o,0,h);r+=u+4;r+=3-(u+3)%4}n=Math.max(1,n*.5);o=Math.max(1,o*.5)}};t.HEADER_LEN=12+13*4;t.COMPRESSED_2D=0;t.COMPRESSED_3D=1;t.TEX_2D=2;t.TEX_3D=3;return t}();e.KhronosTextureContainer=t})(r||(r={}));"use strict";var r;(function(e){var t;(function(t){var i=function(){function t(t,i,r,n,o){if(n===void 0){n=true}if(o===void 0){o=1}this.skeleton=t;this.mesh=i;this.autoUpdateBonesMatrices=n;this.renderingGroupId=o;this.color=e.Color3.White();this._debugLines=new Array;this._isEnabled=false;this._scene=r;this.update();this._renderFunction=this.update.bind(this)}Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){if(this._isEnabled===e){return}this._isEnabled=e;if(e){this._scene.registerBeforeRender(this._renderFunction)}else{this._scene.unregisterBeforeRender(this._renderFunction)}},enumerable:true,configurable:true});t.prototype._getBonePosition=function(t,i,r,n,o,s){if(n===void 0){n=0}if(o===void 0){o=0}if(s===void 0){s=0}var a=e.Tmp.Matrix[0];var u=i.getParent();a.copyFrom(i.getLocalMatrix());if(n!==0||o!==0||s!==0){var l=e.Tmp.Matrix[1];e.Matrix.IdentityToRef(l);l.m[12]=n;l.m[13]=o;l.m[14]=s;l.multiplyToRef(a,a)}if(u){a.multiplyToRef(u.getAbsoluteTransform(),a)}a.multiplyToRef(r,a);t.x=a.m[12];t.y=a.m[13];t.z=a.m[14]};t.prototype._getLinesForBonesWithLength=function(t,i){var r=t.length;var n=this.mesh.position;for(var o=0;o<r;o++){var s=t[o];var a=this._debugLines[o];if(!a){a=[e.Vector3.Zero(),e.Vector3.Zero()];this._debugLines[o]=a}this._getBonePosition(a[0],s,i);this._getBonePosition(a[1],s,i,0,s.length,0);a[0].subtractInPlace(n);a[1].subtractInPlace(n)}};t.prototype._getLinesForBonesNoLength=function(t,i){var r=t.length;var n=0;var o=this.mesh.position;for(var s=r-1;s>=0;s--){var a=t[s];var u=a.getParent();if(!u){continue}var l=this._debugLines[n];if(!l){l=[e.Vector3.Zero(),e.Vector3.Zero()];this._debugLines[n]=l}a.getAbsolutePositionToRef(this.mesh,l[0]);u.getAbsolutePositionToRef(this.mesh,l[1]);l[0].subtractInPlace(o);l[1].subtractInPlace(o);n++}};t.prototype.update=function(){if(this.autoUpdateBonesMatrices){this.skeleton.computeAbsoluteTransforms()}if(this.skeleton.bones[0].length===undefined){this._getLinesForBonesNoLength(this.skeleton.bones,this.mesh.getWorldMatrix())}else{this._getLinesForBonesWithLength(this.skeleton.bones,this.mesh.getWorldMatrix())}if(!this._debugMesh){this._debugMesh=e.MeshBuilder.CreateLineSystem("",{lines:this._debugLines,updatable:true,instance:null},this._scene);this._debugMesh.renderingGroupId=this.renderingGroupId}else{e.MeshBuilder.CreateLineSystem("",{lines:this._debugLines,updatable:true,instance:this._debugMesh},this._scene)}this._debugMesh.position.copyFrom(this.mesh.position);this._debugMesh.color=this.color};t.prototype.dispose=function(){if(this._debugMesh){this.isEnabled=false;this._debugMesh.dispose();this._debugMesh=null}};return t}();t.SkeletonViewer=i})(t=e.Debug||(e.Debug={}))})(r||(r={}));"use strict";var r;(function(e){var t;(function(t){var i=function(){function t(t,i){if(i===void 0){i=1}this._xline=[e.Vector3.Zero(),e.Vector3.Zero()];this._yline=[e.Vector3.Zero(),e.Vector3.Zero()];this._zline=[e.Vector3.Zero(),e.Vector3.Zero()];this.scaleLines=1;this.scaleLines=i;this._xmesh=e.Mesh.CreateLines("xline",this._xline,t,true);this._ymesh=e.Mesh.CreateLines("yline",this._yline,t,true);this._zmesh=e.Mesh.CreateLines("zline",this._zline,t,true);this._xmesh.renderingGroupId=2;this._ymesh.renderingGroupId=2;this._zmesh.renderingGroupId=2;this._xmesh.material.checkReadyOnlyOnce=true;this._xmesh.color=new e.Color3(1,0,0);this._ymesh.material.checkReadyOnlyOnce=true;this._ymesh.color=new e.Color3(0,1,0);this._zmesh.material.checkReadyOnlyOnce=true;this._zmesh.color=new e.Color3(0,0,1);this.scene=t}t.prototype.update=function(t,i,r,n){var o=this.scaleLines;if(this._xmesh){this._xmesh.position.copyFrom(t)}if(this._ymesh){this._ymesh.position.copyFrom(t)}if(this._zmesh){this._zmesh.position.copyFrom(t)}var s=this._xline[1];s.x=i.x*o;s.y=i.y*o;s.z=i.z*o;e.Mesh.CreateLines("",this._xline,null,false,this._xmesh);s=this._yline[1];s.x=r.x*o;s.y=r.y*o;s.z=r.z*o;e.Mesh.CreateLines("",this._yline,null,false,this._ymesh);s=this._zline[1];s.x=n.x*o;s.y=n.y*o;s.z=n.z*o;e.Mesh.CreateLines("",this._zline,null,false,this._zmesh)};t.prototype.dispose=function(){if(this._xmesh){this._xmesh.dispose()}if(this._ymesh){this._ymesh.dispose()}if(this._zmesh){this._zmesh.dispose()}this._xmesh=null;this._ymesh=null;this._zmesh=null;this.scene=null};return t}();t.AxesViewer=i})(t=e.Debug||(e.Debug={}))})(r||(r={}));"use strict";var r;(function(e){var t;(function(t){var i=function(t){__extends(i,t);function i(i,r,n,o){if(o===void 0){o=1}var s=t.call(this,i,o)||this;s.pos=e.Vector3.Zero();s.xaxis=e.Vector3.Zero();s.yaxis=e.Vector3.Zero();s.zaxis=e.Vector3.Zero();s.mesh=n;s.bone=r;return s}i.prototype.update=function(){if(!this.mesh||!this.bone){return}var i=this.bone;i.getAbsolutePositionToRef(this.mesh,this.pos);i.getDirectionToRef(e.Axis.X,this.mesh,this.xaxis);i.getDirectionToRef(e.Axis.Y,this.mesh,this.yaxis);i.getDirectionToRef(e.Axis.Z,this.mesh,this.zaxis);t.prototype.update.call(this,this.pos,this.xaxis,this.yaxis,this.zaxis)};i.prototype.dispose=function(){if(this.mesh){this.mesh=null;this.bone=null;t.prototype.dispose.call(this)}};return i}(t.AxesViewer);t.BoneAxesViewer=i})(t=e.Debug||(e.Debug={}))})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e){this.ray=e}t.CreateAndShow=function(e,i,r){var n=new t(e);n.show(i,r);return n};t.prototype.show=function(t,i){if(!this._renderFunction&&this.ray){var r=this.ray;this._renderFunction=this._render.bind(this);this._scene=t;this._renderPoints=[r.origin,r.origin.add(r.direction.scale(r.length))];this._renderLine=e.Mesh.CreateLines("ray",this._renderPoints,t,true);if(this._renderFunction){this._scene.registerBeforeRender(this._renderFunction)}}if(i&&this._renderLine){this._renderLine.color.copyFrom(i)}};t.prototype.hide=function(){if(this._renderFunction&&this._scene){this._scene.unregisterBeforeRender(this._renderFunction);this._scene=null;this._renderFunction=null;if(this._renderLine){this._renderLine.dispose();this._renderLine=null}this._renderPoints=[]}};t.prototype._render=function(){var t=this.ray;if(!t){return}var i=this._renderPoints[1];var r=Math.min(t.length,1e6);i.copyFrom(t.direction);i.scaleInPlace(r);i.addInPlace(t.origin);e.Mesh.CreateLines("ray",this._renderPoints,this._scene,true,this._renderLine)};t.prototype.attachToMesh=function(t,i,r,n){this._attachedToMesh=t;var o=this.ray;if(!o){return}if(!o.direction){o.direction=e.Vector3.Zero()}if(!o.origin){o.origin=e.Vector3.Zero()}if(n){o.length=n}if(!r){r=e.Vector3.Zero()}if(!i){i=new e.Vector3(0,0,-1)}if(!this._meshSpaceDirection){this._meshSpaceDirection=i.clone();this._meshSpaceOrigin=r.clone()}else{this._meshSpaceDirection.copyFrom(i);this._meshSpaceOrigin.copyFrom(r)}if(!this._updateToMeshFunction){this._updateToMeshFunction=this._updateToMesh.bind(this);this._attachedToMesh.getScene().registerBeforeRender(this._updateToMeshFunction)}this._updateToMesh()};t.prototype.detachFromMesh=function(){if(this._attachedToMesh){if(this._updateToMeshFunction){this._attachedToMesh.getScene().unregisterBeforeRender(this._updateToMeshFunction)}this._attachedToMesh=null;this._updateToMeshFunction=null}};t.prototype._updateToMesh=function(){var t=this.ray;if(!this._attachedToMesh||!t){return}if(this._attachedToMesh._isDisposed){this.detachFromMesh();return}this._attachedToMesh.getDirectionToRef(this._meshSpaceDirection,t.direction);e.Vector3.TransformCoordinatesToRef(this._meshSpaceOrigin,this._attachedToMesh.getWorldMatrix(),t.origin)};t.prototype.dispose=function(){this.hide();this.detachFromMesh();this.ray=null};return t}();e.RayHelper=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e){this.BJSINSPECTOR=typeof INSPECTOR!=="undefined"?INSPECTOR:undefined;this._scene=e}t.prototype._createInspector=function(e){if(e===void 0){e={}}var t=e.popup||false;var i=e.initialTab||0;var r=e.parentElement||null;if(!this._inspector){this.BJSINSPECTOR=this.BJSINSPECTOR||typeof INSPECTOR!=="undefined"?INSPECTOR:undefined;this._inspector=new this.BJSINSPECTOR.Inspector(this._scene,t,i,r,e.newColors)}};t.prototype.isVisible=function(){if(!this._inspector){return false}return true};t.prototype.hide=function(){if(this._inspector){try{this._inspector.dispose()}catch(e){}this._inspector=null}};t.prototype.show=function(i){if(i===void 0){i={}}
if(typeof this.BJSINSPECTOR=="undefined"){e.Tools.LoadScript(t.InspectorURL,this._createInspector.bind(this,i))}else{this._createInspector(i)}};t.InspectorURL="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js";return t}();e.DebugLayer=t})(r||(r={}));"use strict";var r;(function(e){var t;(function(t){var i=function(){function t(t){this._impostors=[];this._meshes=[];this._numMeshes=0;this._scene=t||e.Engine.LastCreatedScene;var i=this._scene.getPhysicsEngine();if(i){this._physicsEnginePlugin=i.getPhysicsPlugin()}}t.prototype._updateDebugMeshes=function(){var e=this._physicsEnginePlugin;for(var t=0;t<this._numMeshes;t++){var i=this._impostors[t];if(!i){continue}if(i.isDisposed){this.hideImpostor(this._impostors[t--])}else{var r=this._meshes[t];if(r&&e){e.syncMeshWithImpostor(r,i)}}}};t.prototype.showImpostor=function(e){if(!this._scene){return}for(var t=0;t<this._numMeshes;t++){if(this._impostors[t]==e){return}}var i=this._getDebugMesh(e,this._scene);if(i){this._impostors[this._numMeshes]=e;this._meshes[this._numMeshes]=i;if(this._numMeshes===0){this._renderFunction=this._updateDebugMeshes.bind(this);this._scene.registerBeforeRender(this._renderFunction)}this._numMeshes++}};t.prototype.hideImpostor=function(e){if(!e||!this._scene){return}var t=false;for(var i=0;i<this._numMeshes;i++){if(this._impostors[i]==e){var r=this._meshes[i];if(!r){continue}this._scene.removeMesh(r);r.dispose();this._numMeshes--;if(this._numMeshes>0){this._meshes[i]=this._meshes[this._numMeshes];this._impostors[i]=this._impostors[this._numMeshes];this._meshes[this._numMeshes]=null;this._impostors[this._numMeshes]=null}else{this._meshes[0]=null;this._impostors[0]=null}t=true;break}}if(t&&this._numMeshes===0){this._scene.unregisterBeforeRender(this._renderFunction)}};t.prototype._getDebugMaterial=function(t){if(!this._debugMaterial){this._debugMaterial=new e.StandardMaterial("",t);this._debugMaterial.wireframe=true}return this._debugMaterial};t.prototype._getDebugBoxMesh=function(t){if(!this._debugBoxMesh){this._debugBoxMesh=e.MeshBuilder.CreateBox("physicsBodyBoxViewMesh",{size:1},t);this._debugBoxMesh.renderingGroupId=1;this._debugBoxMesh.rotationQuaternion=e.Quaternion.Identity();this._debugBoxMesh.material=this._getDebugMaterial(t);t.removeMesh(this._debugBoxMesh)}return this._debugBoxMesh.createInstance("physicsBodyBoxViewInstance")};t.prototype._getDebugSphereMesh=function(t){if(!this._debugSphereMesh){this._debugSphereMesh=e.MeshBuilder.CreateSphere("physicsBodySphereViewMesh",{diameter:1},t);this._debugSphereMesh.renderingGroupId=1;this._debugSphereMesh.rotationQuaternion=e.Quaternion.Identity();this._debugSphereMesh.material=this._getDebugMaterial(t);t.removeMesh(this._debugSphereMesh)}return this._debugSphereMesh.createInstance("physicsBodyBoxViewInstance")};t.prototype._getDebugMesh=function(t,i){var r=null;if(t.type==e.PhysicsImpostor.BoxImpostor){r=this._getDebugBoxMesh(i);t.getBoxSizeToRef(r.scaling)}else if(t.type==e.PhysicsImpostor.SphereImpostor){r=this._getDebugSphereMesh(i);var n=t.getRadius();r.scaling.x=n*2;r.scaling.y=n*2;r.scaling.z=n*2}return r};t.prototype.dispose=function(){for(var e=0;e<this._numMeshes;e++){this.hideImpostor(this._impostors[e])}if(this._debugBoxMesh){this._debugBoxMesh.dispose()}if(this._debugSphereMesh){this._debugSphereMesh.dispose()}if(this._debugMaterial){this._debugMaterial.dispose()}this._impostors.length=0;this._scene=null;this._physicsEnginePlugin=null};return t}();t.PhysicsViewer=i})(t=e.Debug||(e.Debug={}))})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t){this.frontColor=new e.Color3(1,1,1);this.backColor=new e.Color3(.1,.1,.1);this.showBackLines=true;this.renderList=new e.SmartArray(32);this._vertexBuffers={};this._scene=t}t.prototype._prepareRessources=function(){if(this._colorShader){return}this._colorShader=new e.ShaderMaterial("colorShader",this._scene,"color",{attributes:[e.VertexBuffer.PositionKind],uniforms:["world","viewProjection","color"]});var t=this._scene.getEngine();var i=e.VertexData.CreateBox({size:1});this._vertexBuffers[e.VertexBuffer.PositionKind]=new e.VertexBuffer(t,i.positions,e.VertexBuffer.PositionKind,false);this._createIndexBuffer()};t.prototype._createIndexBuffer=function(){var e=this._scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])};t.prototype._rebuild=function(){var t=this._vertexBuffers[e.VertexBuffer.PositionKind];if(t){t._rebuild()}this._createIndexBuffer()};t.prototype.reset=function(){this.renderList.reset()};t.prototype.render=function(){if(this.renderList.length===0){return}this._prepareRessources();if(!this._colorShader.isReady()){return}var t=this._scene.getEngine();t.setDepthWrite(false);this._colorShader._preBind();for(var i=0;i<this.renderList.length;i++){var r=this.renderList.data[i];var n=r.minimum;var o=r.maximum;var s=o.subtract(n);var a=n.add(s.scale(.5));var u=e.Matrix.Scaling(s.x,s.y,s.z).multiply(e.Matrix.Translation(a.x,a.y,a.z)).multiply(r.getWorldMatrix());t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect());if(this.showBackLines){t.setDepthFunctionToGreaterOrEqual();this._scene.resetCachedMaterial();this._colorShader.setColor4("color",this.backColor.toColor4());this._colorShader.bind(u);t.drawElementsType(e.Material.LineListDrawMode,0,24)}t.setDepthFunctionToLess();this._scene.resetCachedMaterial();this._colorShader.setColor4("color",this.frontColor.toColor4());this._colorShader.bind(u);t.drawElementsType(e.Material.LineListDrawMode,0,24)}this._colorShader.unbind();t.setDepthFunctionToLessOrEqual();t.setDepthWrite(true)};t.prototype.renderOcclusionBoundingBox=function(t){this._prepareRessources();if(!this._colorShader.isReady()||!t._boundingInfo){return}var i=this._scene.getEngine();i.setDepthWrite(false);i.setColorWrite(false);this._colorShader._preBind();var r=t._boundingInfo.boundingBox;var n=r.minimum;var o=r.maximum;var s=o.subtract(n);var a=n.add(s.scale(.5));var u=e.Matrix.Scaling(s.x,s.y,s.z).multiply(e.Matrix.Translation(a.x,a.y,a.z)).multiply(r.getWorldMatrix());i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect());i.setDepthFunctionToLess();this._scene.resetCachedMaterial();this._colorShader.bind(u);i.drawElementsType(e.Material.LineListDrawMode,0,24);this._colorShader.unbind();i.setDepthFunctionToLessOrEqual();i.setDepthWrite(true);i.setColorWrite(true)};t.prototype.dispose=function(){if(!this._colorShader){return}this.renderList.dispose();this._colorShader.dispose();var t=this._vertexBuffers[e.VertexBuffer.PositionKind];if(t){t.dispose();this._vertexBuffers[e.VertexBuffer.PositionKind]=null}this._scene.getEngine()._releaseBuffer(this._indexBuffer)};return t}();e.BoundingBoxRenderer=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i){if(i===void 0){i=0}this.name=t;this.animations=new Array;this._positions=null;this._normals=null;this._tangents=null;this.onInfluenceChanged=new e.Observable;this.influence=i}Object.defineProperty(t.prototype,"influence",{get:function(){return this._influence},set:function(e){if(this._influence===e){return}var t=this._influence;this._influence=e;if(this.onInfluenceChanged.hasObservers){this.onInfluenceChanged.notifyObservers(t===0||e===0)}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"hasPositions",{get:function(){return!!this._positions},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"hasNormals",{get:function(){return!!this._normals},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"hasTangents",{get:function(){return!!this._tangents},enumerable:true,configurable:true});t.prototype.setPositions=function(e){this._positions=e};t.prototype.getPositions=function(){return this._positions};t.prototype.setNormals=function(e){this._normals=e};t.prototype.getNormals=function(){return this._normals};t.prototype.setTangents=function(e){this._tangents=e};t.prototype.getTangents=function(){return this._tangents};t.prototype.serialize=function(){var t={};t.name=this.name;t.influence=this.influence;t.positions=Array.prototype.slice.call(this.getPositions());if(this.hasNormals){t.normals=Array.prototype.slice.call(this.getNormals())}if(this.hasTangents){t.tangents=Array.prototype.slice.call(this.getTangents())}e.Animation.AppendSerializedAnimations(this,t);return t};t.Parse=function(i){var r=new t(i.name,i.influence);r.setPositions(i.positions);if(i.normals){r.setNormals(i.normals)}if(i.tangents){r.setTangents(i.tangents)}if(i.animations){for(var n=0;n<i.animations.length;n++){var o=i.animations[n];r.animations.push(e.Animation.Parse(o))}}return r};t.FromMesh=function(i,r,n){if(!r){r=i.name}var o=new t(r,n);o.setPositions(i.getVerticesData(e.VertexBuffer.PositionKind));if(i.isVerticesDataPresent(e.VertexBuffer.NormalKind)){o.setNormals(i.getVerticesData(e.VertexBuffer.NormalKind))}if(i.isVerticesDataPresent(e.VertexBuffer.TangentKind)){o.setTangents(i.getVerticesData(e.VertexBuffer.TangentKind))}return o};return t}();e.MorphTarget=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t){if(t===void 0){t=null}this._targets=new Array;this._targetObservable=new Array;this._activeTargets=new e.SmartArray(16);this._supportsNormals=false;this._supportsTangents=false;this._vertexCount=0;this._uniqueId=0;this._tempInfluences=new Array;if(!t){t=e.Engine.LastCreatedScene}this._scene=t;if(this._scene){this._scene.morphTargetManagers.push(this);this._uniqueId=this._scene.getUniqueId()}}Object.defineProperty(t.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"vertexCount",{get:function(){return this._vertexCount},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"supportsNormals",{get:function(){return this._supportsNormals},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"supportsTangents",{get:function(){return this._supportsTangents},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"numTargets",{get:function(){return this._targets.length},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"numInfluencers",{get:function(){return this._activeTargets.length},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"influences",{get:function(){return this._influences},enumerable:true,configurable:true});t.prototype.getActiveTarget=function(e){return this._activeTargets.data[e]};t.prototype.getTarget=function(e){return this._targets[e]};t.prototype.addTarget=function(e){var t=this;this._targets.push(e);this._targetObservable.push(e.onInfluenceChanged.add(function(e){t._syncActiveTargets(e)}));this._syncActiveTargets(true)};t.prototype.removeTarget=function(e){var t=this._targets.indexOf(e);if(t>=0){this._targets.splice(t,1);e.onInfluenceChanged.remove(this._targetObservable.splice(t,1)[0]);this._syncActiveTargets(true)}};t.prototype.serialize=function(){var e={};e.id=this.uniqueId;e.targets=[];for(var t=0,i=this._targets;t<i.length;t++){var r=i[t];e.targets.push(r.serialize())}return e};t.prototype._syncActiveTargets=function(t){var i=0;this._activeTargets.reset();this._supportsNormals=true;this._supportsTangents=true;this._vertexCount=0;for(var r=0,n=this._targets;r<n.length;r++){var o=n[r];this._activeTargets.push(o);this._tempInfluences[i++]=o.influence;var s=o.getPositions();if(s){this._supportsNormals=this._supportsNormals&&o.hasNormals;this._supportsTangents=this._supportsTangents&&o.hasTangents;var a=s.length/3;if(this._vertexCount===0){this._vertexCount=a}else if(this._vertexCount!==a){e.Tools.Error("Incompatible target. Targets must all have the same vertices count.");return}}}if(!this._influences||this._influences.length!==i){this._influences=new Float32Array(i)}for(var u=0;u<i;u++){this._influences[u]=this._tempInfluences[u]}if(t&&this._scene){for(var l=0,c=this._scene.meshes;l<c.length;l++){var h=c[l];if(h.morphTargetManager===this){h._syncGeometryWithMorphTargetManager()}}}};t.Parse=function(i,r){var n=new t(r);n._uniqueId=i.id;for(var o=0,s=i.targets;o<s.length;o++){var a=s[o];n.addTarget(e.MorphTarget.Parse(a))}return n};return t}();e.MorphTargetManager=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r){if(r===void 0){r=2}this.maxDepth=r;this.dynamicContent=new Array;this._maxBlockCapacity=i||64;this._selectionContent=new e.SmartArrayNoDuplicate(1024);this._creationFunc=t}t.prototype.update=function(e,i,r){t._CreateBlocks(e,i,r,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)};t.prototype.addMesh=function(e){for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.addEntry(e)}};t.prototype.select=function(e,t){this._selectionContent.reset();for(var i=0;i<this.blocks.length;i++){var r=this.blocks[i];r.select(e,this._selectionContent,t)}if(t){this._selectionContent.concat(this.dynamicContent)}else{this._selectionContent.concatWithNoDuplicate(this.dynamicContent)}return this._selectionContent};t.prototype.intersects=function(e,t,i){this._selectionContent.reset();for(var r=0;r<this.blocks.length;r++){var n=this.blocks[r];n.intersects(e,t,this._selectionContent,i)}if(i){this._selectionContent.concat(this.dynamicContent)}else{this._selectionContent.concatWithNoDuplicate(this.dynamicContent)}return this._selectionContent};t.prototype.intersectsRay=function(e){this._selectionContent.reset();for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.intersectsRay(e,this._selectionContent)}this._selectionContent.concatWithNoDuplicate(this.dynamicContent);return this._selectionContent};t._CreateBlocks=function(t,i,r,n,o,s,a,u){a.blocks=new Array;var l=new e.Vector3((i.x-t.x)/2,(i.y-t.y)/2,(i.z-t.z)/2);for(var c=0;c<2;c++){for(var h=0;h<2;h++){for(var f=0;f<2;f++){var d=t.add(l.multiplyByFloats(c,h,f));var p=t.add(l.multiplyByFloats(c+1,h+1,f+1));var _=new e.OctreeBlock(d,p,n,o+1,s,u);_.addEntries(r);a.blocks.push(_)}}}};t.CreationFuncForMeshes=function(e,t){var i=e.getBoundingInfo();if(!e.isBlocked&&i.boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)){t.entries.push(e)}};t.CreationFuncForSubMeshes=function(e,t){var i=e.getBoundingInfo();if(i.boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)){t.entries.push(e)}};return t}();e.Octree=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e,t,i,r,n,o){this.entries=new Array;this._boundingVectors=new Array;this._capacity=i;this._depth=r;this._maxDepth=n;this._creationFunc=o;this._minPoint=e;this._maxPoint=t;this._boundingVectors.push(e.clone());this._boundingVectors.push(t.clone());this._boundingVectors.push(e.clone());this._boundingVectors[2].x=t.x;this._boundingVectors.push(e.clone());this._boundingVectors[3].y=t.y;this._boundingVectors.push(e.clone());this._boundingVectors[4].z=t.z;this._boundingVectors.push(t.clone());this._boundingVectors[5].z=e.z;this._boundingVectors.push(t.clone());this._boundingVectors[6].x=e.x;this._boundingVectors.push(t.clone());this._boundingVectors[7].y=e.y}Object.defineProperty(t.prototype,"capacity",{get:function(){return this._capacity},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"minPoint",{get:function(){return this._minPoint},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"maxPoint",{get:function(){return this._maxPoint},enumerable:true,configurable:true});t.prototype.addEntry=function(e){if(this.blocks){for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.addEntry(e)}return}this._creationFunc(e,this);if(this.entries.length>this.capacity&&this._depth<this._maxDepth){this.createInnerBlocks()}};t.prototype.addEntries=function(e){for(var t=0;t<e.length;t++){var i=e[t];this.addEntry(i)}};t.prototype.select=function(t,i,r){if(e.BoundingBox.IsInFrustum(this._boundingVectors,t)){if(this.blocks){for(var n=0;n<this.blocks.length;n++){var o=this.blocks[n];o.select(t,i,r)}return}if(r){i.concat(this.entries)}else{i.concatWithNoDuplicate(this.entries)}}};t.prototype.intersects=function(t,i,r,n){if(e.BoundingBox.IntersectsSphere(this._minPoint,this._maxPoint,t,i)){if(this.blocks){for(var o=0;o<this.blocks.length;o++){var s=this.blocks[o];s.intersects(t,i,r,n)}return}if(n){r.concat(this.entries)}else{r.concatWithNoDuplicate(this.entries)}}};t.prototype.intersectsRay=function(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(var i=0;i<this.blocks.length;i++){var r=this.blocks[i];r.intersectsRay(e,t)}return}t.concatWithNoDuplicate(this.entries)}};t.prototype.createInnerBlocks=function(){e.Octree._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc)};return t}();e.OctreeBlock=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o){var s=t.call(this,i,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,o.postProcessScaleFactor,r,e.Texture.BILINEAR_SAMPLINGMODE)||this;s._isRightEye=n;s._distortionFactors=o.distortionK;s._postProcessScaleFactor=o.postProcessScaleFactor;s._lensCenterOffset=o.lensCenterOffset;s.adaptScaleToCurrentViewport=true;s.onSizeChangedObservable.add(function(){s._scaleIn=new e.Vector2(2,2/s.aspectRatio);s._scaleFactor=new e.Vector2(.5*(1/s._postProcessScaleFactor),.5*(1/s._postProcessScaleFactor)*s.aspectRatio);s._lensCenter=new e.Vector2(s._isRightEye?.5-s._lensCenterOffset*.5:.5+s._lensCenterOffset*.5,.5)});s.onApplyObservable.add(function(e){e.setFloat2("LensCenter",s._lensCenter.x,s._lensCenter.y);e.setFloat2("Scale",s._scaleFactor.x,s._scaleFactor.y);e.setFloat2("ScaleIn",s._scaleIn.x,s._scaleIn.y);e.setFloat4("HmdWarpParam",s._distortionFactors[0],s._distortionFactors[1],s._distortionFactors[2],s._distortionFactors[3])});return s}return i}(e.PostProcess);e.VRDistortionCorrectionPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(t,i,r,n,o,s){var a=e.call(this,t,"anaglyph",null,["leftSampler"],i,r[1],n,o,s)||this;a._passedProcess=r[0]._rigPostProcess;a.onApplyObservable.add(function(e){e.setTextureFromPostProcess("leftSampler",a._passedProcess)});return a}return t}(e.PostProcess);e.AnaglyphPostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a){var u=t.call(this,i,"stereoscopicInterlace",["stepSize"],["camASampler"],1,r[1],o,s,a,n?"#define IS_STEREOSCOPIC_HORIZ 1":undefined)||this;u._passedProcess=r[0]._rigPostProcess;u._stepSize=new e.Vector2(1/u.width,1/u.height);u.onSizeChangedObservable.add(function(){u._stepSize=new e.Vector2(1/u.width,1/u.height)});u.onApplyObservable.add(function(e){e.setTextureFromPostProcess("camASampler",u._passedProcess);e.setFloat2("stepSize",u._stepSize.x,u._stepSize.y)});return u}return i}(e.PostProcess);e.StereoscopicInterlacePostProcess=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){var t=this;this._screenOrientationAngle=0;this._screenQuaternion=new e.Quaternion;this._alpha=0;this._beta=0;this._gamma=0;this._orientationChanged=function(){t._screenOrientationAngle=window.orientation!==undefined?+window.orientation:window.screen.orientation&&window.screen.orientation["angle"]?window.screen.orientation.angle:0;t._screenOrientationAngle=-e.Tools.ToRadians(t._screenOrientationAngle/2);t._screenQuaternion.copyFromFloats(0,Math.sin(t._screenOrientationAngle),0,Math.cos(t._screenOrientationAngle))};this._deviceOrientation=function(e){t._alpha=e.alpha!==null?e.alpha:0;t._beta=e.beta!==null?e.beta:0;t._gamma=e.gamma!==null?e.gamma:0};this._constantTranform=new e.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));this._orientationChanged()}Object.defineProperty(t.prototype,"camera",{get:function(){return this._camera},set:function(t){this._camera=t;if(this._camera!=null&&!this._camera.rotationQuaternion){this._camera.rotationQuaternion=new e.Quaternion}},enumerable:true,configurable:true});t.prototype.attachControl=function(e,t){window.addEventListener("orientationchange",this._orientationChanged);window.addEventListener("deviceorientation",this._deviceOrientation);this._orientationChanged()};t.prototype.detachControl=function(e){window.removeEventListener("orientationchange",this._orientationChanged);window.removeEventListener("deviceorientation",this._deviceOrientation)};t.prototype.checkInputs=function(){if(!this._alpha)return;e.Quaternion.RotationYawPitchRollToRef(e.Tools.ToRadians(this._alpha),e.Tools.ToRadians(this._beta),-e.Tools.ToRadians(this._gamma),this.camera.rotationQuaternion);this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion);this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform);this._camera.rotationQuaternion.z*=-1;this._camera.rotationQuaternion.w*=-1};t.prototype.getClassName=function(){return"FreeCameraDeviceOrientationInput"};t.prototype.getSimpleName=function(){return"deviceOrientation"};return t}();e.FreeCameraDeviceOrientationInput=t;e.CameraInputTypes["FreeCameraDeviceOrientationInput"]=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this.alphaCorrection=1;this.betaCorrection=1;this.gammaCorrection=1;this._alpha=0;this._gamma=0;this._dirty=false;this._deviceOrientationHandler=this._onOrientationEvent.bind(this)}e.prototype.attachControl=function(e,t){this.camera.attachControl(e,t);window.addEventListener("deviceorientation",this._deviceOrientationHandler)};e.prototype._onOrientationEvent=function(e){if(e.alpha!==null){this._alpha=+e.alpha|0}if(e.gamma!==null){this._gamma=+e.gamma|0}this._dirty=true};e.prototype.checkInputs=function(){if(this._dirty){this._dirty=false;if(this._gamma<0){this._gamma=180+this._gamma}this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2;this.camera.beta=this._gamma/180*Math.PI}};e.prototype.detachControl=function(e){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)};e.prototype.getClassName=function(){return"ArcRotateCameraVRDeviceOrientationInput"};e.prototype.getSimpleName=function(){return"VRDeviceOrientation"};return e}();e.ArcRotateCameraVRDeviceOrientationInput=t;e.CameraInputTypes["ArcRotateCameraVRDeviceOrientationInput"]=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this.compensateDistortion=true}Object.defineProperty(t.prototype,"aspectRatio",{get:function(){return this.hResolution/(2*this.vResolution)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"aspectRatioFov",{get:function(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"leftHMatrix",{get:function(){var t=this.hScreenSize/4-this.lensSeparationDistance/2;var i=4*t/this.hScreenSize;return e.Matrix.Translation(i,0,0)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"rightHMatrix",{get:function(){var t=this.hScreenSize/4-this.lensSeparationDistance/2;var i=4*t/this.hScreenSize;return e.Matrix.Translation(-i,0,0)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"leftPreViewMatrix",{get:function(){return e.Matrix.Translation(.5*this.interpupillaryDistance,0,0)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"rightPreViewMatrix",{get:function(){return e.Matrix.Translation(-.5*this.interpupillaryDistance,0,0)},enumerable:true,configurable:true});t.GetDefault=function(){var e=new t;e.hResolution=1280;e.vResolution=800;e.hScreenSize=.149759993;e.vScreenSize=.0935999975;e.vScreenCenter=.0467999987;e.eyeToScreenDistance=.0410000011;e.lensSeparationDistance=.063500002;e.interpupillaryDistance=.064000003;e.distortionK=[1,.219999999,.239999995,0];e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0];e.postProcessScaleFactor=1.714605507808412;e.lensCenterOffset=.151976421;return e};return t}();e.VRCameraMetrics=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o){if(o===void 0){o={}}var s=t.call(this,i,r,n)||this;s.webVROptions=o;s._vrDevice=null;s.rawPose=null;s._specsVersion="1.1";s._attached=false;s._descendants=[];s._deviceRoomPosition=e.Vector3.Zero();s._deviceRoomRotationQuaternion=e.Quaternion.Identity();s._standingMatrix=null;s.devicePosition=e.Vector3.Zero();s.deviceRotationQuaternion=e.Quaternion.Identity();s.deviceScaleFactor=1;s._deviceToWorld=e.Matrix.Identity();s._worldToDevice=e.Matrix.Identity();s.controllers=[];s.onControllersAttachedObservable=new e.Observable;s.onControllerMeshLoadedObservable=new e.Observable;s.rigParenting=true;s._defaultHeight=undefined;s._workingVector=e.Vector3.Zero();s._oneVector=e.Vector3.One();s._workingMatrix=e.Matrix.Identity();s._cache.position=e.Vector3.Zero();if(o.defaultHeight){s._defaultHeight=o.defaultHeight;s.position.y=s._defaultHeight}s.minZ=.1;if(arguments.length===5){s.webVROptions=arguments[4]}if(s.webVROptions.trackPosition==undefined){s.webVROptions.trackPosition=true}if(s.webVROptions.controllerMeshes==undefined){s.webVROptions.controllerMeshes=true}if(s.webVROptions.defaultLightingOnControllers==undefined){s.webVROptions.defaultLightingOnControllers=true}s.rotationQuaternion=new e.Quaternion;if(s.webVROptions&&s.webVROptions.positionScale){s.deviceScaleFactor=s.webVROptions.positionScale}var a=s.getEngine();s._onVREnabled=function(e){if(e){s.initControllers()}};a.onVRRequestPresentComplete.add(s._onVREnabled);a.initWebVR().add(function(t){if(!t.vrDisplay||s._vrDevice===t.vrDisplay){return}s._vrDevice=t.vrDisplay;s.setCameraRigMode(e.Camera.RIG_MODE_WEBVR,{parentCamera:s,vrDisplay:s._vrDevice,frameData:s._frameData,specs:s._specsVersion});if(s._attached){s.getEngine().enableVR()}});if(typeof VRFrameData!=="undefined")s._frameData=new VRFrameData;n.onBeforeCameraRenderObservable.add(function(e){if(e.parent===s&&s.rigParenting){s._descendants=s.getDescendants(true,function(e){var t=s.controllers.some(function(t){return t._mesh===e});var i=s._rigCameras.indexOf(e)!==-1;return!t&&!i});s._descendants.forEach(function(t){t.parent=e})}});n.onAfterCameraRenderObservable.add(function(e){if(e.parent===s&&s.rigParenting){s._descendants.forEach(function(e){e.parent=s})}});return s}i.prototype.deviceDistanceToRoomGround=function(){if(this._standingMatrix){this._standingMatrix.getTranslationToRef(this._workingVector);return this._deviceRoomPosition.y+this._workingVector.y}return this._defaultHeight||0};i.prototype.useStandingMatrix=function(t){var i=this;if(t===void 0){t=function(e){}}this.getEngine().initWebVRAsync().then(function(r){if(!r.vrDisplay||!r.vrDisplay.stageParameters||!r.vrDisplay.stageParameters.sittingToStandingTransform){t(false)}else{i._standingMatrix=new e.Matrix;e.Matrix.FromFloat32ArrayToRefScaled(r.vrDisplay.stageParameters.sittingToStandingTransform,0,1,i._standingMatrix);if(!i.getScene().useRightHandedSystem){[2,6,8,9,14].forEach(function(e){if(i._standingMatrix){i._standingMatrix.m[e]*=-1}})}t(true)}})};i.prototype.useStandingMatrixAsync=function(){var e=this;return new Promise(function(t,i){e.useStandingMatrix(function(e){t(e)})})};i.prototype.dispose=function(){this.getEngine().onVRRequestPresentComplete.removeCallback(this._onVREnabled);t.prototype.dispose.call(this)};i.prototype.getControllerByName=function(e){for(var t=0,i=this.controllers;t<i.length;t++){var r=i[t];if(r.hand===e){return r}}return null};Object.defineProperty(i.prototype,"leftController",{get:function(){if(!this._leftController){this._leftController=this.getControllerByName("left")}return this._leftController},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"rightController",{get:function(){if(!this._rightController){this._rightController=this.getControllerByName("right")}return this._rightController},enumerable:true,configurable:true});i.prototype.getForwardRay=function(e){if(e===void 0){e=100}if(this.leftCamera){return t.prototype.getForwardRay.call(this,e,this.leftCamera.getWorldMatrix(),this.leftCamera.globalPosition)}else{return t.prototype.getForwardRay.call(this,e)}};i.prototype._checkInputs=function(){if(this._vrDevice&&this._vrDevice.isPresenting){this._vrDevice.getFrameData(this._frameData);this.updateFromDevice(this._frameData.pose)}t.prototype._checkInputs.call(this)};i.prototype.updateFromDevice=function(e){if(e&&e.orientation){this.rawPose=e;this._deviceRoomRotationQuaternion.copyFromFloats(e.orientation[0],e.orientation[1],-e.orientation[2],-e.orientation[3]);if(this.getScene().useRightHandedSystem){this._deviceRoomRotationQuaternion.z*=-1;this._deviceRoomRotationQuaternion.w*=-1}if(this.webVROptions.trackPosition&&this.rawPose.position){this._deviceRoomPosition.copyFromFloats(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2]);if(this.getScene().useRightHandedSystem){this._deviceRoomPosition.z*=-1}}}};i.prototype.attachControl=function(i,r){t.prototype.attachControl.call(this,i,r);this._attached=true;r=e.Camera.ForceAttachControlToAlwaysPreventDefault?false:r;if(this._vrDevice){this.getEngine().enableVR()}};i.prototype.detachControl=function(e){this.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver);this.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver);t.prototype.detachControl.call(this,e);this._attached=false;this.getEngine().disableVR()};i.prototype.getClassName=function(){return"WebVRFreeCamera"};i.prototype.resetToCurrentRotation=function(){this._vrDevice.resetPose()};i.prototype._updateRigCameras=function(){var e=this._rigCameras[0];var t=this._rigCameras[1];e.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion);t.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion);e.position.copyFrom(this._deviceRoomPosition);t.position.copyFrom(this._deviceRoomPosition)};i.prototype._updateCache=function(i){var r=this;if(!this.rotationQuaternion.equals(this._cache.rotationQuaternion)||!this.position.equals(this._cache.position)){if(!this.updateCacheCalled){this.updateCacheCalled=true;this.update()}this.rotationQuaternion.toRotationMatrix(this._workingMatrix);e.Vector3.TransformCoordinatesToRef(this._deviceRoomPosition,this._workingMatrix,this._workingVector);this.devicePosition.subtractToRef(this._workingVector,this._workingVector);e.Matrix.ComposeToRef(this._oneVector,this.rotationQuaternion,this._workingVector,this._deviceToWorld);this._deviceToWorld.getTranslationToRef(this._workingVector);this._workingVector.addInPlace(this.position);this._workingVector.subtractInPlace(this._cache.position);this._deviceToWorld.setTranslation(this._workingVector);this._deviceToWorld.invertToRef(this._worldToDevice);this.controllers.forEach(function(e){e._deviceToWorld.copyFrom(r._deviceToWorld);e.update()})}if(!i){t.prototype._updateCache.call(this)}this.updateCacheCalled=false};i.prototype.update=function(){e.Vector3.TransformCoordinatesToRef(this._deviceRoomPosition,this._deviceToWorld,this.devicePosition);e.Matrix.FromQuaternionToRef(this._deviceRoomRotationQuaternion,this._workingMatrix);this._workingMatrix.multiplyToRef(this._deviceToWorld,this._workingMatrix);e.Quaternion.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion);t.prototype.update.call(this)};i.prototype._getViewMatrix=function(){return e.Matrix.Identity()};i.prototype._getWebVRViewMatrix=function(){var t=this;var i=this._cameraRigParams["parentCamera"];i._updateCache();var r=this._cameraRigParams["left"]?this._cameraRigParams["frameData"].leftViewMatrix:this._cameraRigParams["frameData"].rightViewMatrix;e.Matrix.FromArrayToRef(r,0,this._webvrViewMatrix);if(!this.getScene().useRightHandedSystem){[2,6,8,9,14].forEach(function(e){t._webvrViewMatrix.m[e]*=-1})}this._webvrViewMatrix.getRotationMatrixToRef(this._cameraRotationMatrix);e.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint);this.position.addToRef(this._transformedReferencePoint,this._currentTarget)
;if(i.deviceScaleFactor!==1){this._webvrViewMatrix.invert();if(i.deviceScaleFactor){this._webvrViewMatrix.m[12]*=i.deviceScaleFactor;this._webvrViewMatrix.m[13]*=i.deviceScaleFactor;this._webvrViewMatrix.m[14]*=i.deviceScaleFactor}this._webvrViewMatrix.invert()}i._worldToDevice.multiplyToRef(this._webvrViewMatrix,this._webvrViewMatrix);return this._webvrViewMatrix};i.prototype._getWebVRProjectionMatrix=function(){var t=this;var i=this.parent;i._vrDevice.depthNear=i.minZ;i._vrDevice.depthFar=i.maxZ;var r=this._cameraRigParams["left"]?this._cameraRigParams["frameData"].leftProjectionMatrix:this._cameraRigParams["frameData"].rightProjectionMatrix;e.Matrix.FromArrayToRef(r,0,this._projectionMatrix);if(!this.getScene().useRightHandedSystem){[8,9,10,11].forEach(function(e){t._projectionMatrix.m[e]*=-1})}return this._projectionMatrix};i.prototype.initControllers=function(){var t=this;this.controllers=[];var i=this.getScene().gamepadManager;this._onGamepadDisconnectedObserver=i.onGamepadDisconnectedObservable.add(function(i){if(i.type===e.Gamepad.POSE_ENABLED){var r=i;if(r.defaultModel){r.defaultModel.setEnabled(false)}if(r.hand==="right"){t._rightController=null}if(r.hand==="left"){t._leftController=null}var n=t.controllers.indexOf(r);if(n!==-1){t.controllers.splice(n,1)}}});this._onGamepadConnectedObserver=i.onGamepadConnectedObservable.add(function(i){if(i.type===e.Gamepad.POSE_ENABLED){var r=i;r.deviceScaleFactor=t.deviceScaleFactor;r._deviceToWorld.copyFrom(t._deviceToWorld);if(t.webVROptions.controllerMeshes){if(r.defaultModel){r.defaultModel.setEnabled(true)}else{r.initControllerMesh(t.getScene(),function(i){i.scaling.scaleInPlace(t.deviceScaleFactor);t.onControllerMeshLoadedObservable.notifyObservers(r);if(t.webVROptions.defaultLightingOnControllers){if(!t._lightOnControllers){t._lightOnControllers=new e.HemisphericLight("vrControllersLight",new e.Vector3(0,1,0),t.getScene())}var n=function(e,t){var i=e.getChildren();if(i.length!==0){i.forEach(function(e){t.includedOnlyMeshes.push(e);n(e,t)})}};t._lightOnControllers.includedOnlyMeshes.push(i);n(i,t._lightOnControllers)}})}}r.attachToPoseControlledCamera(t);if(t.controllers.indexOf(r)===-1){t.controllers.push(r);var n=false;for(var o=0;o<t.controllers.length;o++){if(t.controllers[o].controllerType===e.PoseEnabledControllerType.VIVE){if(!n){n=true;t.controllers[o].hand="left"}else{t.controllers[o].hand="right"}}}if(t.controllers.length>=2){t.onControllersAttachedObservable.notifyObservers(t.controllers)}}}})};return i}(e.FreeCamera);e.WebVRFreeCamera=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n){var o=t.call(this,i,r,n)||this;o._quaternionCache=new e.Quaternion;o.inputs.addDeviceOrientation();return o}i.prototype.getClassName=function(){return"DeviceOrientationCamera"};i.prototype._checkInputs=function(){t.prototype._checkInputs.call(this);this._quaternionCache.copyFrom(this.rotationQuaternion);if(this._initialQuaternion){this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}};i.prototype.resetToCurrentRotation=function(t){var i=this;if(t===void 0){t=e.Axis.Y}if(!this.rotationQuaternion)return;if(!this._initialQuaternion){this._initialQuaternion=new e.Quaternion}this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion);["x","y","z"].forEach(function(e){if(!t[e]){i._initialQuaternion[e]=0}else{i._initialQuaternion[e]*=-1}});this._initialQuaternion.normalize();this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)};return i}(e.FreeCamera);e.DeviceOrientationCamera=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s){if(o===void 0){o=true}if(s===void 0){s=e.VRCameraMetrics.GetDefault()}var a=t.call(this,i,r,n)||this;s.compensateDistortion=o;a.setCameraRigMode(e.Camera.RIG_MODE_VR,{vrCameraMetrics:s});return a}i.prototype.getClassName=function(){return"VRDeviceOrientationFreeCamera"};return i}(e.DeviceOrientationCamera);e.VRDeviceOrientationFreeCamera=t;var i=function(t){__extends(i,t);function i(i,r,n,o,s){if(o===void 0){o=true}if(s===void 0){s=e.VRCameraMetrics.GetDefault()}var a=t.call(this,i,r,n,o,s)||this;a.inputs.addGamepad();return a}i.prototype.getClassName=function(){return"VRDeviceOrientationGamepadCamera"};return i}(t);e.VRDeviceOrientationGamepadCamera=i;var r=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l){if(u===void 0){u=true}if(l===void 0){l=e.VRCameraMetrics.GetDefault()}var c=t.call(this,i,r,n,o,s,a)||this;l.compensateDistortion=u;c.setCameraRigMode(e.Camera.RIG_MODE_VR,{vrCameraMetrics:l});c.inputs.addVRDeviceOrientation();return c}i.prototype.getClassName=function(){return"VRDeviceOrientationArcRotateCamera"};return i}(e.ArcRotateCamera);e.VRDeviceOrientationArcRotateCamera=r})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o){var s=t.call(this,i,r,o)||this;s.interaxialDistance=n;s.setCameraRigMode(e.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:n});return s}i.prototype.getClassName=function(){return"AnaglyphFreeCamera"};return i}(e.FreeCamera);e.AnaglyphFreeCamera=t;var i=function(t){__extends(i,t);function i(i,r,n,o,s,a,u){var l=t.call(this,i,r,n,o,s,u)||this;l.interaxialDistance=a;l.setCameraRigMode(e.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:a});return l}i.prototype.getClassName=function(){return"AnaglyphArcRotateCamera"};return i}(e.ArcRotateCamera);e.AnaglyphArcRotateCamera=i;var r=function(t){__extends(i,t);function i(i,r,n,o){var s=t.call(this,i,r,o)||this;s.interaxialDistance=n;s.setCameraRigMode(e.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:n});return s}i.prototype.getClassName=function(){return"AnaglyphGamepadCamera"};return i}(e.GamepadCamera);e.AnaglyphGamepadCamera=r;var n=function(t){__extends(i,t);function i(i,r,n,o){var s=t.call(this,i,r,o)||this;s.interaxialDistance=n;s.setCameraRigMode(e.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:n});return s}i.prototype.getClassName=function(){return"AnaglyphUniversalCamera"};return i}(e.UniversalCamera);e.AnaglyphUniversalCamera=n;var o=function(t){__extends(i,t);function i(i,r,n,o,s){var a=t.call(this,i,r,s)||this;a.interaxialDistance=n;a.isStereoscopicSideBySide=o;a.setCameraRigMode(o?e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:e.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:n});return a}i.prototype.getClassName=function(){return"StereoscopicFreeCamera"};return i}(e.FreeCamera);e.StereoscopicFreeCamera=o;var s=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l){var c=t.call(this,i,r,n,o,s,l)||this;c.interaxialDistance=a;c.isStereoscopicSideBySide=u;c.setCameraRigMode(u?e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:e.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:a});return c}i.prototype.getClassName=function(){return"StereoscopicArcRotateCamera"};return i}(e.ArcRotateCamera);e.StereoscopicArcRotateCamera=s;var a=function(t){__extends(i,t);function i(i,r,n,o,s){var a=t.call(this,i,r,s)||this;a.interaxialDistance=n;a.isStereoscopicSideBySide=o;a.setCameraRigMode(o?e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:e.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:n});return a}i.prototype.getClassName=function(){return"StereoscopicGamepadCamera"};return i}(e.GamepadCamera);e.StereoscopicGamepadCamera=a;var u=function(t){__extends(i,t);function i(i,r,n,o,s){var a=t.call(this,i,r,s)||this;a.interaxialDistance=n;a.isStereoscopicSideBySide=o;a.setCameraRigMode(o?e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:e.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:n});return a}i.prototype.getClassName=function(){return"StereoscopicUniversalCamera"};return i}(e.UniversalCamera);e.StereoscopicUniversalCamera=u})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(i,r){if(r===void 0){r=null}this.scene=i;this._pointerDownOnMeshAsked=false;this._isActionableMesh=false;this._teleportationRequestInitiated=false;this._teleportationBackRequestInitiated=false;this._dpadPressed=true;this._activePointer=false;this._id=t._idCounter++;if(!r){this._gazeTracker=e.Mesh.CreateTorus("gazeTracker",.0035,.0025,20,i,false);this._gazeTracker.bakeCurrentTransformIntoVertices();this._gazeTracker.isPickable=false;this._gazeTracker.isVisible=false;var n=new e.StandardMaterial("targetMat",i);n.specularColor=e.Color3.Black();n.emissiveColor=new e.Color3(.7,.7,.7);n.backFaceCulling=false;this._gazeTracker.material=n}else{this._gazeTracker=r.clone("gazeTracker")}}t.prototype._getForwardRay=function(t){return new e.Ray(e.Vector3.Zero(),new e.Vector3(0,0,t))};t.prototype._selectionPointerDown=function(){this._pointerDownOnMeshAsked=true;if(this._currentMeshSelected&&this._currentHit){this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}};t.prototype._selectionPointerUp=function(){if(this._currentMeshSelected&&this._currentHit){this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id})}this._pointerDownOnMeshAsked=false};t.prototype._activatePointer=function(){this._activePointer=true};t.prototype._deactivatePointer=function(){this._activePointer=false};t.prototype._updatePointerDistance=function(e){};t.prototype.dispose=function(){this._interactionsEnabled=false;this._teleportationEnabled=false};t._idCounter=0;return t}();var i=function(t){__extends(i,t);function i(i,r,n){var o=t.call(this,r,n)||this;o.webVRController=i;o._laserPointer=e.Mesh.CreateCylinder("laserPointer",1,.004,2e-4,20,1,r,false);var s=new e.StandardMaterial("laserPointerMat",r);s.emissiveColor=new e.Color3(.7,.7,.7);s.alpha=.6;o._laserPointer.material=s;o._laserPointer.rotation.x=Math.PI/2;o._laserPointer.position.z=-.5;o._laserPointer.isVisible=false;if(!i.mesh){var a=new e.Mesh("preloadControllerMesh",r);var u=new e.Mesh(e.PoseEnabledController.POINTING_POSE,r);u.rotation.x=-.7;a.addChild(u);i.attachToMesh(a)}o._setLaserPointerParent(i.mesh);return o}i.prototype._getForwardRay=function(e){return this.webVRController.getForwardRay(e)};i.prototype._activatePointer=function(){t.prototype._activatePointer.call(this);this._laserPointer.isVisible=true};i.prototype._deactivatePointer=function(){t.prototype._deactivatePointer.call(this);this._laserPointer.isVisible=false};i.prototype._setLaserPointerColor=function(e){this._laserPointer.material.emissiveColor=e};i.prototype._setLaserPointerParent=function(t){var i=function(e){e.name+=" laserPointer";e.getChildMeshes().forEach(function(e){i(e)})};i(t);var r=t.getChildMeshes();this.webVRController._pointingPoseNode=null;for(var n=0;n<r.length;n++){if(r[n].name&&r[n].name.indexOf(e.PoseEnabledController.POINTING_POSE)>=0){t=r[n];this.webVRController._pointingPoseNode=t;break}}this._laserPointer.parent=t};i.prototype._updatePointerDistance=function(e){this._laserPointer.scaling.y=e;this._laserPointer.position.z=-e/2};i.prototype.dispose=function(){t.prototype.dispose.call(this);this._laserPointer.dispose()};return i}(t);var r=function(t){__extends(i,t);function i(e,i){var r=t.call(this,i)||this;r.getCamera=e;return r}i.prototype._getForwardRay=function(t){var i=this.getCamera();if(i){return i.getForwardRay(t)}else{return new e.Ray(e.Vector3.Zero(),e.Vector3.Forward())}};return i}(t);var n=function(){function t(t,n){if(n===void 0){n={}}var o=this;this.webVROptions=n;this._webVRsupported=false;this._webVRready=false;this._webVRrequesting=false;this._webVRpresenting=false;this._fullscreenVRpresenting=false;this.onEnteringVRObservable=new e.Observable;this.onExitingVRObservable=new e.Observable;this.onControllerMeshLoadedObservable=new e.Observable;this._useCustomVRButton=false;this._teleportationRequested=false;this._teleportActive=false;this._floorMeshesCollection=[];this._rotationAllowed=true;this._teleportBackwardsVector=new e.Vector3(0,-1,-1);this._rotationRightAsked=false;this._rotationLeftAsked=false;this._isDefaultTeleportationTarget=true;this._teleportationFillColor="#444444";this._teleportationBorderColor="#FFFFFF";this._rotationAngle=0;this._haloCenter=new e.Vector3(0,0,0);this._padSensibilityUp=.65;this._padSensibilityDown=.35;this.leftController=null;this.rightController=null;this.onNewMeshSelected=new e.Observable;this.onNewMeshPicked=new e.Observable;this.onBeforeCameraTeleport=new e.Observable;this.onAfterCameraTeleport=new e.Observable;this.onSelectedMeshUnselected=new e.Observable;this.teleportationEnabled=true;this._teleportationInitialized=false;this._interactionsEnabled=false;this._interactionsRequested=false;this._displayGaze=true;this._displayLaserPointer=true;this._onResize=function(){o.moveButtonToBottomRight();if(o._fullscreenVRpresenting&&o._webVRready){o.exitVR()}};this._onFullscreenChange=function(){if(document.fullscreen!==undefined){o._fullscreenVRpresenting=document.fullscreen}else if(document.mozFullScreen!==undefined){o._fullscreenVRpresenting=document.mozFullScreen}else if(document.webkitIsFullScreen!==undefined){o._fullscreenVRpresenting=document.webkitIsFullScreen}else if(document.msIsFullScreen!==undefined){o._fullscreenVRpresenting=document.msIsFullScreen}if(!o._fullscreenVRpresenting&&o._canvas){o.exitVR();if(!o._useCustomVRButton){o._btnVR.style.top=o._canvas.offsetTop+o._canvas.offsetHeight-70+"px";o._btnVR.style.left=o._canvas.offsetLeft+o._canvas.offsetWidth-100+"px"}}};this.beforeRender=function(){if(o.leftController&&o.leftController._activePointer){o._castRayAndSelectObject(o.leftController)}if(o.rightController&&o.rightController._activePointer){o._castRayAndSelectObject(o.rightController)}if(!(o.leftController&&o.leftController._activePointer)&&!(o.rightController&&o.rightController._activePointer)){o._castRayAndSelectObject(o._cameraGazer)}else{o._cameraGazer._gazeTracker.isVisible=false}};this._onNewGamepadConnected=function(t){if(t.type!==e.Gamepad.POSE_ENABLED){if(t.leftStick){t.onleftstickchanged(function(e){if(o._teleportationInitialized&&o.teleportationEnabled){if(!o.leftController&&!o.rightController||o.leftController&&!o.leftController._activePointer&&(o.rightController&&!o.rightController._activePointer)){o._checkTeleportWithRay(e,o._cameraGazer);o._checkTeleportBackwards(e,o._cameraGazer)}}})}if(t.rightStick){t.onrightstickchanged(function(e){if(o._teleportationInitialized){o._checkRotate(e,o._cameraGazer)}})}if(t.type===e.Gamepad.XBOX){t.onbuttondown(function(t){if(o._interactionsEnabled&&t===e.Xbox360Button.A){o._cameraGazer._selectionPointerDown()}});t.onbuttonup(function(t){if(o._interactionsEnabled&&t===e.Xbox360Button.A){o._cameraGazer._selectionPointerUp()}})}}else{var r=t;var n=new i(r,o._scene,o._cameraGazer._gazeTracker);if(r.hand==="right"||o.leftController&&o.leftController.webVRController!=r){o.rightController=n}else{o.leftController=n}o._tryEnableInteractionOnController(n)}};this._tryEnableInteractionOnController=function(e){if(o._interactionsRequested&&!e._interactionsEnabled){o._enableInteractionOnController(e)}if(o._teleportationRequested&&!e._teleportationEnabled){o._enableTeleportationOnController(e)}};this._onNewGamepadDisconnected=function(t){if(t instanceof e.WebVRController){if(t.hand==="left"&&o.leftController!=null){o.leftController.dispose();o.leftController=null}if(t.hand==="right"&&o.rightController!=null){o.rightController.dispose();o.rightController=null}}};this._workingVector=e.Vector3.Zero();this._workingQuaternion=e.Quaternion.Identity();this._workingMatrix=e.Matrix.Identity();this._scene=t;this._canvas=t.getEngine().getRenderingCanvas();if(n.createFallbackVRDeviceOrientationFreeCamera===undefined){n.createFallbackVRDeviceOrientationFreeCamera=true}if(n.createDeviceOrientationCamera===undefined){n.createDeviceOrientationCamera=true}if(n.defaultHeight===undefined){n.defaultHeight=1.7}if(n.useCustomVRButton){this._useCustomVRButton=true;if(n.customVRButton){this._btnVR=n.customVRButton}}if(n.rayLength){this._rayLength=n.rayLength}this._defaultHeight=n.defaultHeight;if(n.positionScale){this._rayLength*=n.positionScale;this._defaultHeight*=n.positionScale}if(this._scene.activeCamera){this._position=this._scene.activeCamera.position.clone()}else{this._position=new e.Vector3(0,this._defaultHeight,0)}if(n.createDeviceOrientationCamera||!this._scene.activeCamera){this._deviceOrientationCamera=new e.DeviceOrientationCamera("deviceOrientationVRHelper",this._position.clone(),t);if(this._scene.activeCamera){this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ;this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ;if(this._scene.activeCamera instanceof e.TargetCamera&&this._scene.activeCamera.rotation){var s=this._scene.activeCamera;if(s.rotationQuaternion){this._deviceOrientationCamera.rotationQuaternion.copyFrom(s.rotationQuaternion)}else{this._deviceOrientationCamera.rotationQuaternion.copyFrom(e.Quaternion.RotationYawPitchRoll(s.rotation.y,s.rotation.x,s.rotation.z))}this._deviceOrientationCamera.rotation=s.rotation.clone()}}this._scene.activeCamera=this._deviceOrientationCamera;if(this._canvas){this._scene.activeCamera.attachControl(this._canvas)}}else{this._existingCamera=this._scene.activeCamera}if(n.createFallbackVRDeviceOrientationFreeCamera){this._vrDeviceOrientationCamera=new e.VRDeviceOrientationFreeCamera("VRDeviceOrientationVRHelper",this._position,this._scene)}this._webVRCamera=new e.WebVRFreeCamera("WebVRHelper",this._position,this._scene,n);this._webVRCamera.useStandingMatrix();this._cameraGazer=new r(function(){return o.currentVRCamera},t);if(!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON");this._btnVR.className="babylonVRicon";this._btnVR.id="babylonVRiconbtn";this._btnVR.title="Click to switch to VR";var a=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url(data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";a+=".babylonVRicon.vrdisplaypresenting { display: none; }";var u=document.createElement("style");u.appendChild(document.createTextNode(a));document.getElementsByTagName("head")[0].appendChild(u);this.moveButtonToBottomRight()}if(this._btnVR){this._btnVR.addEventListener("click",function(){if(!o.isInVRMode){o.enterVR()}else{o.exitVR()}})}window.addEventListener("resize",this._onResize);document.addEventListener("fullscreenchange",this._onFullscreenChange,false);document.addEventListener("mozfullscreenchange",this._onFullscreenChange,false);document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,false);document.addEventListener("msfullscreenchange",this._onFullscreenChange,false);if(n.createFallbackVRDeviceOrientationFreeCamera){this.displayVRButton()}else{this._scene.getEngine().onVRDisplayChangedObservable.add(function(e){if(e.vrDisplay){o.displayVRButton()}})}this._onKeyDown=function(e){if(e.keyCode===27&&o.isInVRMode){o.exitVR()}};document.addEventListener("keydown",this._onKeyDown);this._scene.onPrePointerObservable.add(function(e,t){if(o.isInVRMode){o.exitVR();if(o._fullscreenVRpresenting){o._scene.getEngine().switchFullscreen(true)}}},e.PointerEventTypes.POINTERDOUBLETAP,false);this._onVRDisplayChanged=function(e){return o.onVRDisplayChanged(e)};this._onVrDisplayPresentChange=function(){return o.onVrDisplayPresentChange()};this._onVRRequestPresentStart=function(){o._webVRrequesting=true;o.updateButtonVisibility()};this._onVRRequestPresentComplete=function(e){o._webVRrequesting=false;o.updateButtonVisibility()};t.getEngine().onVRDisplayChangedObservable.add(this._onVRDisplayChanged);t.getEngine().onVRRequestPresentStart.add(this._onVRRequestPresentStart);t.getEngine().onVRRequestPresentComplete.add(this._onVRRequestPresentComplete);window.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange);t.onDisposeObservable.add(function(){o.dispose()});this._webVRCamera.onControllerMeshLoadedObservable.add(function(e){return o._onDefaultMeshLoaded(e)});this._scene.gamepadManager.onGamepadConnectedObservable.add(this._onNewGamepadConnected);this._scene.gamepadManager.onGamepadDisconnectedObservable.add(this._onNewGamepadDisconnected);this.updateButtonVisibility();this._circleEase=new e.CircleEase;this._circleEase.setEasingMode(e.EasingFunction.EASINGMODE_EASEINOUT)}Object.defineProperty(t.prototype,"onEnteringVR",{get:function(){return this.onEnteringVRObservable},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"onExitingVR",{get:function(){return this.onExitingVRObservable},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"onControllerMeshLoaded",{get:function(){return this.onControllerMeshLoadedObservable},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"teleportationTarget",{get:function(){return this._teleportationTarget},set:function(e){if(e){e.name="teleportationTarget";this._isDefaultTeleportationTarget=false;this._teleportationTarget=e}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"gazeTrackerMesh",{get:function(){return this._cameraGazer._gazeTracker},set:function(e){if(e){this._cameraGazer._gazeTracker=e;this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices();this._cameraGazer._gazeTracker.isPickable=false;this._cameraGazer._gazeTracker.isVisible=false;this._cameraGazer._gazeTracker.name="gazeTracker";if(this.leftController){this.leftController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")}if(this.rightController){this.rightController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")}}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"displayGaze",{get:function(){return this._displayGaze},set:function(e){this._displayGaze=e;if(!e){this._cameraGazer._gazeTracker.isVisible=false;if(this.leftController){this.leftController._gazeTracker.isVisible=false}if(this.rightController){this.rightController._gazeTracker.isVisible=false}}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"displayLaserPointer",{get:function(){return this._displayLaserPointer},set:function(e){this._displayLaserPointer=e;if(!e){if(this.rightController){this.rightController._deactivatePointer();this.rightController._gazeTracker.isVisible=false}if(this.leftController){this.leftController._deactivatePointer();this.leftController._gazeTracker.isVisible=false}}else{if(this.rightController){this.rightController._activatePointer()}else if(this.leftController){this.leftController._activatePointer()}}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"deviceOrientationCamera",{get:function(){return this._deviceOrientationCamera},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"currentVRCamera",{get:function(){if(this._webVRready){return this._webVRCamera}else{return this._scene.activeCamera}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"webVRCamera",{get:function(){return this._webVRCamera},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"vrDeviceOrientationCamera",{get:function(){return this._vrDeviceOrientationCamera},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"_teleportationRequestInitiated",{get:function(){var e=this._cameraGazer._teleportationRequestInitiated||this.leftController!==null&&this.leftController._teleportationRequestInitiated||this.rightController!==null&&this.rightController._teleportationRequestInitiated;return e},enumerable:true,configurable:true});t.prototype._onDefaultMeshLoaded=function(t){if(this.leftController&&this.leftController.webVRController==t){if(t.mesh){this.leftController._setLaserPointerParent(t.mesh)}}if(this.rightController&&this.rightController.webVRController==t){if(t.mesh){this.rightController._setLaserPointerParent(t.mesh)}}try{this.onControllerMeshLoadedObservable.notifyObservers(t)}catch(t){e.Tools.Warn("Error in your custom logic onControllerMeshLoaded: "+t)}};Object.defineProperty(t.prototype,"isInVRMode",{get:function(){return this._webVRpresenting||this._fullscreenVRpresenting},enumerable:true,configurable:true});t.prototype.onVrDisplayPresentChange=function(){var t=this._scene.getEngine().getVRDevice();if(t){var i=this._webVRpresenting;this._webVRpresenting=t.isPresenting;if(i&&!this._webVRpresenting)this.exitVR()}else{e.Tools.Warn("Detected VRDisplayPresentChange on an unknown VRDisplay. Did you can enterVR on the vrExperienceHelper?")}this.updateButtonVisibility()};t.prototype.onVRDisplayChanged=function(e){this._webVRsupported=e.vrSupported;this._webVRready=!!e.vrDisplay;this._webVRpresenting=e.vrDisplay&&e.vrDisplay.isPresenting;this.updateButtonVisibility()};t.prototype.moveButtonToBottomRight=function(){if(this._canvas&&!this._useCustomVRButton){this._btnVR.style.top=this._canvas.offsetTop+this._canvas.offsetHeight-70+"px";this._btnVR.style.left=this._canvas.offsetLeft+this._canvas.offsetWidth-100+"px"}};t.prototype.displayVRButton=function(){if(!this._useCustomVRButton&&!this._btnVRDisplayed){document.body.appendChild(this._btnVR);this._btnVRDisplayed=true}};t.prototype.updateButtonVisibility=function(){if(!this._btnVR||this._useCustomVRButton){return}this._btnVR.className="babylonVRicon";if(this.isInVRMode){this._btnVR.className+=" vrdisplaypresenting"}else{if(this._webVRready)this._btnVR.className+=" vrdisplayready";if(this._webVRsupported)this._btnVR.className+=" vrdisplaysupported";if(this._webVRrequesting)this._btnVR.className+=" vrdisplayrequesting"}};t.prototype.enterVR=function(){if(this.onEnteringVRObservable){try{this.onEnteringVRObservable.notifyObservers(this)}catch(t){e.Tools.Warn("Error in your custom logic onEnteringVR: "+t)}}if(this._scene.activeCamera){this._position=this._scene.activeCamera.position.clone();this._existingCamera=this._scene.activeCamera}if(this._webVRrequesting)return;if(this._webVRready){if(!this._webVRpresenting){this._webVRCamera.position=this._position;this._scene.activeCamera=this._webVRCamera}}else if(this._vrDeviceOrientationCamera){this._vrDeviceOrientationCamera.position=this._position;this._scene.activeCamera=this._vrDeviceOrientationCamera;this._scene.getEngine().switchFullscreen(true);this.updateButtonVisibility()}if(this._scene.activeCamera&&this._canvas){this._scene.activeCamera.attachControl(this._canvas)}if(this._interactionsEnabled){this._scene.registerBeforeRender(this.beforeRender)}};t.prototype.exitVR=function(){if(this.onExitingVRObservable){try{this.onExitingVRObservable.notifyObservers(this)}catch(t){e.Tools.Warn("Error in your custom logic onExitingVR: "+t)}}if(this._webVRpresenting){this._scene.getEngine().disableVR()}if(this._scene.activeCamera){this._position=this._scene.activeCamera.position.clone()}if(this._deviceOrientationCamera){this._deviceOrientationCamera.position=this._position;this._scene.activeCamera=this._deviceOrientationCamera;if(this._canvas){this._scene.activeCamera.attachControl(this._canvas)}}else if(this._existingCamera){this._existingCamera.position=this._position;this._scene.activeCamera=this._existingCamera}this.updateButtonVisibility();if(this._interactionsEnabled){this._scene.unregisterBeforeRender(this.beforeRender)}};Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(e){this._position=e;if(this._scene.activeCamera){this._scene.activeCamera.position=e}},enumerable:true,configurable:true});t.prototype.enableInteractions=function(){var e=this;if(!this._interactionsEnabled){this._interactionsRequested=true;if(this.leftController){this._enableInteractionOnController(this.leftController)}if(this.rightController){this._enableInteractionOnController(this.rightController)}this.raySelectionPredicate=function(e){return e.isVisible};this.meshSelectionPredicate=function(e){return true};this._raySelectionPredicate=function(t){if(e._isTeleportationFloor(t)||t.name.indexOf("gazeTracker")===-1&&t.name.indexOf("teleportationTarget")===-1&&t.name.indexOf("torusTeleportation")===-1&&t.name.indexOf("laserPointer")===-1){return e.raySelectionPredicate(t)}return false};this._interactionsEnabled=true}};t.prototype._isTeleportationFloor=function(e){for(var t=0;t<this._floorMeshesCollection.length;t++){if(this._floorMeshesCollection[t].id===e.id){return true}}if(this._floorMeshName&&e.name===this._floorMeshName){return true}return false};t.prototype.addFloorMesh=function(e){if(!this._floorMeshesCollection){return}if(this._floorMeshesCollection.indexOf(e)>-1){return}this._floorMeshesCollection.push(e)};t.prototype.removeFloorMesh=function(e){if(!this._floorMeshesCollection){return}var t=this._floorMeshesCollection.indexOf(e);if(t!==-1){this._floorMeshesCollection.splice(t,1)}};t.prototype.enableTeleportation=function(t){if(t===void 0){t={}}if(!this._teleportationInitialized){this._teleportationRequested=true;this.enableInteractions();if(t.floorMeshName){this._floorMeshName=t.floorMeshName}if(t.floorMeshes){this._floorMeshesCollection=t.floorMeshes}if(this.leftController!=null){this._enableTeleportationOnController(this.leftController)}if(this.rightController!=null){this._enableTeleportationOnController(this.rightController)}var i=new e.ImageProcessingConfiguration;i.vignetteColor=new e.Color4(0,0,0,0);i.vignetteEnabled=true;this._postProcessMove=new e.ImageProcessingPostProcess("postProcessMove",1,this._webVRCamera,undefined,undefined,undefined,undefined,i);this._webVRCamera.detachPostProcess(this._postProcessMove);this._teleportationInitialized=true;if(this._isDefaultTeleportationTarget){this._createTeleportationCircles();this._teleportationTarget.scaling.scaleInPlace(this._webVRCamera.deviceScaleFactor)}}};t.prototype._enableInteractionOnController=function(e){var t=this;var i=e.webVRController.mesh;if(i){e._interactionsEnabled=true;e._activatePointer();e.webVRController.onMainButtonStateChangedObservable.add(function(i){if(t._displayLaserPointer&&i.value===1){if(e._activePointer){e._deactivatePointer()}else{e._activatePointer()}if(t.displayGaze){e._gazeTracker.isVisible=e._activePointer}}});e.webVRController.onTriggerStateChangedObservable.add(function(i){if(!e._pointerDownOnMeshAsked){if(i.value>t._padSensibilityUp){e._selectionPointerDown()}}else if(i.value<t._padSensibilityDown){e._selectionPointerUp()}})}}
;t.prototype._checkTeleportWithRay=function(e,t){if(this._teleportationRequestInitiated&&!t._teleportationRequestInitiated){return}if(!t._teleportationRequestInitiated){if(e.y<-this._padSensibilityUp&&t._dpadPressed){t._activatePointer();t._teleportationRequestInitiated=true}}else{if(Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown){if(this._teleportActive){this._teleportCamera(this._haloCenter)}t._teleportationRequestInitiated=false}}};t.prototype._checkRotate=function(e,t){if(t._teleportationRequestInitiated){return}if(!this._rotationLeftAsked){if(e.x<-this._padSensibilityUp&&t._dpadPressed){this._rotationLeftAsked=true;if(this._rotationAllowed){this._rotateCamera(false)}}}else{if(e.x>-this._padSensibilityDown){this._rotationLeftAsked=false}}if(!this._rotationRightAsked){if(e.x>this._padSensibilityUp&&t._dpadPressed){this._rotationRightAsked=true;if(this._rotationAllowed){this._rotateCamera(true)}}}else{if(e.x<this._padSensibilityDown){this._rotationRightAsked=false}}};t.prototype._checkTeleportBackwards=function(t,i){if(i._teleportationRequestInitiated){return}if(t.y>this._padSensibilityUp&&i._dpadPressed){if(!i._teleportationBackRequestInitiated){if(!this.currentVRCamera){return}var r=e.Quaternion.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix());var n=this.currentVRCamera.position;if(this.currentVRCamera.devicePosition&&this.currentVRCamera.deviceRotationQuaternion){r=this.currentVRCamera.deviceRotationQuaternion;n=this.currentVRCamera.devicePosition}r.toEulerAnglesToRef(this._workingVector);this._workingVector.z=0;this._workingVector.x=0;e.Quaternion.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion);this._workingQuaternion.toRotationMatrix(this._workingMatrix);e.Vector3.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);var o=new e.Ray(n,this._workingVector);var s=this._scene.pickWithRay(o,this._raySelectionPredicate);if(s&&s.pickedPoint&&s.pickedMesh&&this._isTeleportationFloor(s.pickedMesh)&&s.distance<5){this._teleportCamera(s.pickedPoint)}i._teleportationBackRequestInitiated=true}}else{i._teleportationBackRequestInitiated=false}};t.prototype._enableTeleportationOnController=function(t){var i=this;var r=t.webVRController.mesh;if(r){if(!t._interactionsEnabled){this._enableInteractionOnController(t)}t._interactionsEnabled=true;t._teleportationEnabled=true;if(t.webVRController.controllerType===e.PoseEnabledControllerType.VIVE){t._dpadPressed=false;t.webVRController.onPadStateChangedObservable.add(function(e){t._dpadPressed=e.pressed;if(!t._dpadPressed){i._rotationLeftAsked=false;i._rotationRightAsked=false;t._teleportationBackRequestInitiated=false}})}t.webVRController.onPadValuesChangedObservable.add(function(e){if(i.teleportationEnabled){i._checkTeleportBackwards(e,t);i._checkTeleportWithRay(e,t)}i._checkRotate(e,t)})}};t.prototype._createTeleportationCircles=function(){this._teleportationTarget=e.Mesh.CreateGround("teleportationTarget",2,2,2,this._scene);this._teleportationTarget.isPickable=false;var t=512;var i=new e.DynamicTexture("DynamicTexture",t,this._scene,true);i.hasAlpha=true;var r=i.getContext();var n=t/2;var o=t/2;var s=200;r.beginPath();r.arc(n,o,s,0,2*Math.PI,false);r.fillStyle=this._teleportationFillColor;r.fill();r.lineWidth=10;r.strokeStyle=this._teleportationBorderColor;r.stroke();r.closePath();i.update();var a=new e.StandardMaterial("TextPlaneMaterial",this._scene);a.diffuseTexture=i;this._teleportationTarget.material=a;var u=e.Mesh.CreateTorus("torusTeleportation",.75,.1,25,this._scene,false);u.isPickable=false;u.parent=this._teleportationTarget;var l=new e.Animation("animationInnerCircle","position.y",30,e.Animation.ANIMATIONTYPE_FLOAT,e.Animation.ANIMATIONLOOPMODE_CYCLE);var c=[];c.push({frame:0,value:0});c.push({frame:30,value:.4});c.push({frame:60,value:0});l.setKeys(c);var h=new e.SineEase;h.setEasingMode(e.EasingFunction.EASINGMODE_EASEINOUT);l.setEasingFunction(h);u.animations=[];u.animations.push(l);this._scene.beginAnimation(u,0,60,true);this._hideTeleportationTarget()};t.prototype._displayTeleportationTarget=function(){this._teleportActive=true;if(this._teleportationInitialized){this._teleportationTarget.isVisible=true;if(this._isDefaultTeleportationTarget){this._teleportationTarget.getChildren()[0].isVisible=true}}};t.prototype._hideTeleportationTarget=function(){this._teleportActive=false;if(this._teleportationInitialized){this._teleportationTarget.isVisible=false;if(this._isDefaultTeleportationTarget){this._teleportationTarget.getChildren()[0].isVisible=false}}};t.prototype._rotateCamera=function(t){var i=this;if(!(this.currentVRCamera instanceof e.FreeCamera)){return}if(t){this._rotationAngle++}else{this._rotationAngle--}this.currentVRCamera.animations=[];var r=e.Quaternion.FromRotationMatrix(e.Matrix.RotationY(Math.PI/4*this._rotationAngle));var n=new e.Animation("animationRotation","rotationQuaternion",90,e.Animation.ANIMATIONTYPE_QUATERNION,e.Animation.ANIMATIONLOOPMODE_CONSTANT);var o=[];o.push({frame:0,value:this.currentVRCamera.rotationQuaternion});o.push({frame:6,value:r});n.setKeys(o);n.setEasingFunction(this._circleEase);this.currentVRCamera.animations.push(n);this._postProcessMove.animations=[];var s=new e.Animation("animationPP","vignetteWeight",90,e.Animation.ANIMATIONTYPE_FLOAT,e.Animation.ANIMATIONLOOPMODE_CONSTANT);var a=[];a.push({frame:0,value:0});a.push({frame:3,value:4});a.push({frame:6,value:0});s.setKeys(a);s.setEasingFunction(this._circleEase);this._postProcessMove.animations.push(s);var u=new e.Animation("animationPP2","vignetteStretch",90,e.Animation.ANIMATIONTYPE_FLOAT,e.Animation.ANIMATIONLOOPMODE_CONSTANT);var l=[];l.push({frame:0,value:0});l.push({frame:3,value:10});l.push({frame:6,value:0});u.setKeys(l);u.setEasingFunction(this._circleEase);this._postProcessMove.animations.push(u);this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0;this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0;this._postProcessMove.samples=4;this._webVRCamera.attachPostProcess(this._postProcessMove);this._scene.beginAnimation(this._postProcessMove,0,6,false,1,function(){i._webVRCamera.detachPostProcess(i._postProcessMove)});this._scene.beginAnimation(this.currentVRCamera,0,6,false,1)};t.prototype._moveTeleportationSelectorTo=function(t,i){if(t.pickedPoint){if(i._teleportationRequestInitiated){this._displayTeleportationTarget();this._haloCenter.copyFrom(t.pickedPoint);this._teleportationTarget.position.copyFrom(t.pickedPoint)}var r=t.getNormal(true,false);if(r){var n=e.Vector3.Cross(e.Axis.Y,r);var o=e.Vector3.Cross(r,n);e.Vector3.RotationFromAxisToRef(o,r,n,this._teleportationTarget.rotation)}this._teleportationTarget.position.y+=.1}};t.prototype._teleportCamera=function(t){var i=this;if(!(this.currentVRCamera instanceof e.FreeCamera)){return}if(this.webVRCamera.leftCamera){this._workingVector.copyFrom(this.webVRCamera.leftCamera.globalPosition);this._workingVector.subtractInPlace(this.webVRCamera.position);t.subtractToRef(this._workingVector,this._workingVector)}else{this._workingVector.copyFrom(t)}if(this.isInVRMode){this._workingVector.y+=this.webVRCamera.deviceDistanceToRoomGround()*this._webVRCamera.deviceScaleFactor}else{this._workingVector.y+=this._defaultHeight}this.onBeforeCameraTeleport.notifyObservers(this._workingVector);this.currentVRCamera.animations=[];var r=new e.Animation("animationCameraTeleportation","position",90,e.Animation.ANIMATIONTYPE_VECTOR3,e.Animation.ANIMATIONLOOPMODE_CONSTANT);var n=[{frame:0,value:this.currentVRCamera.position},{frame:11,value:this._workingVector}];r.setKeys(n);r.setEasingFunction(this._circleEase);this.currentVRCamera.animations.push(r);this._postProcessMove.animations=[];var o=new e.Animation("animationPP","vignetteWeight",90,e.Animation.ANIMATIONTYPE_FLOAT,e.Animation.ANIMATIONLOOPMODE_CONSTANT);var s=[];s.push({frame:0,value:0});s.push({frame:5,value:8});s.push({frame:11,value:0});o.setKeys(s);this._postProcessMove.animations.push(o);var a=new e.Animation("animationPP2","vignetteStretch",90,e.Animation.ANIMATIONTYPE_FLOAT,e.Animation.ANIMATIONLOOPMODE_CONSTANT);var u=[];u.push({frame:0,value:0});u.push({frame:5,value:10});u.push({frame:11,value:0});a.setKeys(u);this._postProcessMove.animations.push(a);this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0;this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0;this._webVRCamera.attachPostProcess(this._postProcessMove);this._scene.beginAnimation(this._postProcessMove,0,11,false,1,function(){i._webVRCamera.detachPostProcess(i._postProcessMove)});this._scene.beginAnimation(this.currentVRCamera,0,11,false,1,function(){i.onAfterCameraTeleport.notifyObservers(i._workingVector)});this._hideTeleportationTarget()};t.prototype._castRayAndSelectObject=function(t){if(!(this.currentVRCamera instanceof e.FreeCamera)){return}var i=this._scene.pickWithRay(t._getForwardRay(this._rayLength),this._raySelectionPredicate);if(i&&i.pickedPoint){if(this._displayGaze){var r=1;t._gazeTracker.isVisible=true;if(t._isActionableMesh){r=3}t._gazeTracker.scaling.x=i.distance*r;t._gazeTracker.scaling.y=i.distance*r;t._gazeTracker.scaling.z=i.distance*r;var n=i.getNormal();var o=.002;if(n){var s=e.Vector3.Cross(e.Axis.Y,n);var a=e.Vector3.Cross(n,s);e.Vector3.RotationFromAxisToRef(a,n,s,t._gazeTracker.rotation)}t._gazeTracker.position.copyFrom(i.pickedPoint);if(t._gazeTracker.position.x<0){t._gazeTracker.position.x+=o}else{t._gazeTracker.position.x-=o}if(t._gazeTracker.position.y<0){t._gazeTracker.position.y+=o}else{t._gazeTracker.position.y-=o}if(t._gazeTracker.position.z<0){t._gazeTracker.position.z+=o}else{t._gazeTracker.position.z-=o}}t._updatePointerDistance(i.distance)}else{t._gazeTracker.isVisible=false}if(i&&i.pickedMesh){t._currentHit=i;if(t._pointerDownOnMeshAsked){this._scene.simulatePointerMove(t._currentHit,{pointerId:t._id})}if(this._teleportationInitialized&&this._isTeleportationFloor(i.pickedMesh)&&i.pickedPoint){if(t._currentMeshSelected&&!this._isTeleportationFloor(t._currentMeshSelected)){this._notifySelectedMeshUnselected(t._currentMeshSelected)}t._currentMeshSelected=null;if(t._teleportationRequestInitiated){this._moveTeleportationSelectorTo(i,t)}return}if(i.pickedMesh!==t._currentMeshSelected){if(this.meshSelectionPredicate(i.pickedMesh)){this.onNewMeshPicked.notifyObservers(i);t._currentMeshSelected=i.pickedMesh;if(i.pickedMesh.isPickable&&i.pickedMesh.actionManager){this.changeGazeColor(new e.Color3(0,0,1));this.changeLaserColor(new e.Color3(.2,.2,1));t._isActionableMesh=true}else{this.changeGazeColor(new e.Color3(.7,.7,.7));this.changeLaserColor(new e.Color3(.7,.7,.7));t._isActionableMesh=false}try{this.onNewMeshSelected.notifyObservers(i.pickedMesh)}catch(t){e.Tools.Warn("Error in your custom logic onNewMeshSelected: "+t)}}else{this._notifySelectedMeshUnselected(t._currentMeshSelected);t._currentMeshSelected=null;this.changeGazeColor(new e.Color3(.7,.7,.7));this.changeLaserColor(new e.Color3(.7,.7,.7))}}}else{t._currentHit=null;this._notifySelectedMeshUnselected(t._currentMeshSelected);t._currentMeshSelected=null;this.changeGazeColor(new e.Color3(.7,.7,.7));this.changeLaserColor(new e.Color3(.7,.7,.7))}};t.prototype._notifySelectedMeshUnselected=function(e){if(e){this.onSelectedMeshUnselected.notifyObservers(e)}};t.prototype.changeLaserColor=function(e){if(this.leftController){this.leftController._setLaserPointerColor(e)}if(this.rightController){this.rightController._setLaserPointerColor(e)}};t.prototype.changeGazeColor=function(e){if(!this._cameraGazer._gazeTracker.material){return}this._cameraGazer._gazeTracker.material.emissiveColor=e;if(this.leftController){this.leftController._gazeTracker.material.emissiveColor=e}if(this.rightController){this.rightController._gazeTracker.material.emissiveColor=e}};t.prototype.dispose=function(){if(this.isInVRMode){this.exitVR()}if(this._postProcessMove){this._postProcessMove.dispose()}if(this._webVRCamera){this._webVRCamera.dispose()}if(this._vrDeviceOrientationCamera){this._vrDeviceOrientationCamera.dispose()}if(!this._useCustomVRButton&&this._btnVR.parentNode){document.body.removeChild(this._btnVR)}if(this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera){this._deviceOrientationCamera.dispose()}if(this._cameraGazer){this._cameraGazer.dispose()}if(this.leftController){this.leftController.dispose()}if(this.rightController){this.rightController.dispose()}if(this._teleportationTarget){this._teleportationTarget.dispose()}this._floorMeshesCollection=[];document.removeEventListener("keydown",this._onKeyDown);window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange);window.removeEventListener("resize",this._onResize);document.removeEventListener("fullscreenchange",this._onFullscreenChange);document.removeEventListener("mozfullscreenchange",this._onFullscreenChange);document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange);document.removeEventListener("msfullscreenchange",this._onFullscreenChange);this._scene.getEngine().onVRDisplayChangedObservable.removeCallback(this._onVRDisplayChanged);this._scene.getEngine().onVRRequestPresentStart.removeCallback(this._onVRRequestPresentStart);this._scene.getEngine().onVRRequestPresentComplete.removeCallback(this._onVRRequestPresentComplete);window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange);this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected);this._scene.gamepadManager.onGamepadDisconnectedObservable.removeCallback(this._onNewGamepadDisconnected);this._scene.unregisterBeforeRender(this.beforeRender)};t.prototype.getClassName=function(){return"VRExperienceHelper"};return t}();e.VRExperienceHelper=n})(r||(r={}));"use strict";var r;(function(e){var t;(function(e){e[e["X"]=0]="X";e[e["Y"]=1]="Y";e[e["Z"]=2]="Z"})(t=e.JoystickAxis||(e.JoystickAxis={}));var i=function(){function i(r){var n=this;if(r){this._leftJoystick=true}else{this._leftJoystick=false}i._globalJoystickIndex++;this._axisTargetedByLeftAndRight=t.X;this._axisTargetedByUpAndDown=t.Y;this.reverseLeftRight=false;this.reverseUpDown=false;this._touches=new e.StringDictionary;this.deltaPosition=e.Vector3.Zero();this._joystickSensibility=25;this._inversedSensibility=1/(this._joystickSensibility/1e3);this._onResize=function(e){i.vjCanvasWidth=window.innerWidth;i.vjCanvasHeight=window.innerHeight;if(i.vjCanvas){i.vjCanvas.width=i.vjCanvasWidth;i.vjCanvas.height=i.vjCanvasHeight}i.halfWidth=i.vjCanvasWidth/2};if(!i.vjCanvas){window.addEventListener("resize",this._onResize,false);i.vjCanvas=document.createElement("canvas");i.vjCanvasWidth=window.innerWidth;i.vjCanvasHeight=window.innerHeight;i.vjCanvas.width=window.innerWidth;i.vjCanvas.height=window.innerHeight;i.vjCanvas.style.width="100%";i.vjCanvas.style.height="100%";i.vjCanvas.style.position="absolute";i.vjCanvas.style.backgroundColor="transparent";i.vjCanvas.style.top="0px";i.vjCanvas.style.left="0px";i.vjCanvas.style.zIndex="5";i.vjCanvas.style.msTouchAction="none";i.vjCanvas.setAttribute("touch-action","none");var o=i.vjCanvas.getContext("2d");if(!o){throw new Error("Unable to create canvas for virtual joystick")}i.vjCanvasContext=o;i.vjCanvasContext.strokeStyle="#ffffff";i.vjCanvasContext.lineWidth=2;document.body.appendChild(i.vjCanvas)}i.halfWidth=i.vjCanvas.width/2;this.pressed=false;this._joystickColor="cyan";this._joystickPointerID=-1;this._joystickPointerPos=new e.Vector2(0,0);this._joystickPreviousPointerPos=new e.Vector2(0,0);this._joystickPointerStartPos=new e.Vector2(0,0);this._deltaJoystickVector=new e.Vector2(0,0);this._onPointerDownHandlerRef=function(e){n._onPointerDown(e)};this._onPointerMoveHandlerRef=function(e){n._onPointerMove(e)};this._onPointerUpHandlerRef=function(e){n._onPointerUp(e)};i.vjCanvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,false);i.vjCanvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,false);i.vjCanvas.addEventListener("pointerup",this._onPointerUpHandlerRef,false);i.vjCanvas.addEventListener("pointerout",this._onPointerUpHandlerRef,false);i.vjCanvas.addEventListener("contextmenu",function(e){e.preventDefault()},false);requestAnimationFrame(function(){n._drawVirtualJoystick()})}i.prototype.setJoystickSensibility=function(e){this._joystickSensibility=e;this._inversedSensibility=1/(this._joystickSensibility/1e3)};i.prototype._onPointerDown=function(e){var t;e.preventDefault();if(this._leftJoystick===true){t=e.clientX<i.halfWidth}else{t=e.clientX>i.halfWidth}if(t&&this._joystickPointerID<0){this._joystickPointerID=e.pointerId;this._joystickPointerStartPos.x=e.clientX;this._joystickPointerStartPos.y=e.clientY;this._joystickPointerPos=this._joystickPointerStartPos.clone();this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone();this._deltaJoystickVector.x=0;this._deltaJoystickVector.y=0;this.pressed=true;this._touches.add(e.pointerId.toString(),e)}else{if(i._globalJoystickIndex<2&&this._action){this._action();this._touches.add(e.pointerId.toString(),{x:e.clientX,y:e.clientY,prevX:e.clientX,prevY:e.clientY})}}};i.prototype._onPointerMove=function(e){if(this._joystickPointerID==e.pointerId){this._joystickPointerPos.x=e.clientX;this._joystickPointerPos.y=e.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone();this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos);var i=this.reverseLeftRight?-1:1;var r=i*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case t.X:this.deltaPosition.x=Math.min(1,Math.max(-1,r));break;case t.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,r));break;case t.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,r));break}var n=this.reverseUpDown?1:-1;var o=n*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case t.X:this.deltaPosition.x=Math.min(1,Math.max(-1,o));break;case t.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,o));break;case t.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,o));break}}else{var s=this._touches.get(e.pointerId.toString());if(s){s.x=e.clientX;s.y=e.clientY}}};i.prototype._onPointerUp=function(e){if(this._joystickPointerID==e.pointerId){i.vjCanvasContext.clearRect(this._joystickPointerStartPos.x-64,this._joystickPointerStartPos.y-64,128,128);i.vjCanvasContext.clearRect(this._joystickPreviousPointerPos.x-42,this._joystickPreviousPointerPos.y-42,84,84);this._joystickPointerID=-1;this.pressed=false}else{var t=this._touches.get(e.pointerId.toString());if(t){i.vjCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88)}}this._deltaJoystickVector.x=0;this._deltaJoystickVector.y=0;this._touches.remove(e.pointerId.toString())};i.prototype.setJoystickColor=function(e){this._joystickColor=e};i.prototype.setActionOnTouch=function(e){this._action=e};i.prototype.setAxisForLeftRight=function(e){switch(e){case t.X:case t.Y:case t.Z:this._axisTargetedByLeftAndRight=e;break;default:this._axisTargetedByLeftAndRight=t.X;break}};i.prototype.setAxisForUpDown=function(e){switch(e){case t.X:case t.Y:case t.Z:this._axisTargetedByUpAndDown=e;break;default:this._axisTargetedByUpAndDown=t.Y;break}};i.prototype._drawVirtualJoystick=function(){var e=this;if(this.pressed){this._touches.forEach(function(t,r){if(r.pointerId===e._joystickPointerID){i.vjCanvasContext.clearRect(e._joystickPointerStartPos.x-64,e._joystickPointerStartPos.y-64,128,128);i.vjCanvasContext.clearRect(e._joystickPreviousPointerPos.x-42,e._joystickPreviousPointerPos.y-42,84,84);i.vjCanvasContext.beginPath();i.vjCanvasContext.lineWidth=6;i.vjCanvasContext.strokeStyle=e._joystickColor;i.vjCanvasContext.arc(e._joystickPointerStartPos.x,e._joystickPointerStartPos.y,40,0,Math.PI*2,true);i.vjCanvasContext.stroke();i.vjCanvasContext.closePath();i.vjCanvasContext.beginPath();i.vjCanvasContext.strokeStyle=e._joystickColor;i.vjCanvasContext.lineWidth=2;i.vjCanvasContext.arc(e._joystickPointerStartPos.x,e._joystickPointerStartPos.y,60,0,Math.PI*2,true);i.vjCanvasContext.stroke();i.vjCanvasContext.closePath();i.vjCanvasContext.beginPath();i.vjCanvasContext.strokeStyle=e._joystickColor;i.vjCanvasContext.arc(e._joystickPointerPos.x,e._joystickPointerPos.y,40,0,Math.PI*2,true);i.vjCanvasContext.stroke();i.vjCanvasContext.closePath();e._joystickPreviousPointerPos=e._joystickPointerPos.clone()}else{i.vjCanvasContext.clearRect(r.prevX-44,r.prevY-44,88,88);i.vjCanvasContext.beginPath();i.vjCanvasContext.fillStyle="white";i.vjCanvasContext.beginPath();i.vjCanvasContext.strokeStyle="red";i.vjCanvasContext.lineWidth=6;i.vjCanvasContext.arc(r.x,r.y,40,0,Math.PI*2,true);i.vjCanvasContext.stroke();i.vjCanvasContext.closePath();r.prevX=r.x;r.prevY=r.y}})}requestAnimationFrame(function(){e._drawVirtualJoystick()})};i.prototype.releaseCanvas=function(){if(i.vjCanvas){i.vjCanvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef);i.vjCanvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef);i.vjCanvas.removeEventListener("pointerup",this._onPointerUpHandlerRef);i.vjCanvas.removeEventListener("pointerout",this._onPointerUpHandlerRef);window.removeEventListener("resize",this._onResize);document.body.removeChild(i.vjCanvas);i.vjCanvas=null}};i._globalJoystickIndex=0;return i}();e.VirtualJoystick=i})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(t,i,r){var n=e.call(this,t,i,r)||this;n.inputs.addVirtualJoystick();return n}t.prototype.getClassName=function(){return"VirtualJoysticksCamera"};return t}(e.FreeCamera);e.VirtualJoysticksCamera=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){}t.prototype.getLeftJoystick=function(){return this._leftjoystick};t.prototype.getRightJoystick=function(){return this._rightjoystick};t.prototype.checkInputs=function(){if(this._leftjoystick){var t=this.camera;var i=t._computeLocalCameraSpeed()*50;var r=e.Matrix.RotationYawPitchRoll(t.rotation.y,t.rotation.x,0);var n=e.Vector3.TransformCoordinates(new e.Vector3(this._leftjoystick.deltaPosition.x*i,this._leftjoystick.deltaPosition.y*i,this._leftjoystick.deltaPosition.z*i),r);t.cameraDirection=t.cameraDirection.add(n);t.cameraRotation=t.cameraRotation.addVector3(this._rightjoystick.deltaPosition);if(!this._leftjoystick.pressed){this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)}if(!this._rightjoystick.pressed){this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9)}}};t.prototype.attachControl=function(t,i){this._leftjoystick=new e.VirtualJoystick(true);this._leftjoystick.setAxisForUpDown(e.JoystickAxis.Z);this._leftjoystick.setAxisForLeftRight(e.JoystickAxis.X);this._leftjoystick.setJoystickSensibility(.15);this._rightjoystick=new e.VirtualJoystick(false);this._rightjoystick.setAxisForUpDown(e.JoystickAxis.X);this._rightjoystick.setAxisForLeftRight(e.JoystickAxis.Y);this._rightjoystick.reverseUpDown=true;this._rightjoystick.setJoystickSensibility(.05);this._rightjoystick.setJoystickColor("yellow")};t.prototype.detachControl=function(e){this._leftjoystick.releaseCanvas();this._rightjoystick.releaseCanvas()};t.prototype.getClassName=function(){return"FreeCameraVirtualJoystickInput"};t.prototype.getSimpleName=function(){return"virtualJoystick"};return t}();e.FreeCameraVirtualJoystickInput=t;e.CameraInputTypes["FreeCameraVirtualJoystickInput"]=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e,t,i){this.quality=e;this.distance=t;this.optimizeMesh=i}return e}();e.SimplificationSettings=t;var i=function(){function t(){this.running=false;this._simplificationArray=[]}t.prototype.addTask=function(e){this._simplificationArray.push(e)};t.prototype.executeNext=function(){var e=this._simplificationArray.pop();if(e){this.running=true;this.runSimplification(e)}else{this.running=false}};t.prototype.runSimplification=function(t){var i=this;if(t.parallelProcessing){t.settings.forEach(function(e){var r=i.getSimplifier(t);r.simplify(e,function(r){t.mesh.addLODLevel(e.distance,r);r.isVisible=true;if(e.quality===t.settings[t.settings.length-1].quality&&t.successCallback){t.successCallback()}i.executeNext()})})}else{var r=this.getSimplifier(t);var n=function(e,i){r.simplify(e,function(r){t.mesh.addLODLevel(e.distance,r);r.isVisible=true;i()})};e.AsyncLoop.Run(t.settings.length,function(e){n(t.settings[e.index],function(){e.executeNext()})},function(){if(t.successCallback){t.successCallback()}i.executeNext()})}};t.prototype.getSimplifier=function(e){switch(e.simplificationType){case r.QUADRATIC:default:return new u(e.mesh)}};return t}();e.SimplificationQueue=i;var r;(function(e){e[e["QUADRATIC"]=0]="QUADRATIC"})(r=e.SimplificationType||(e.SimplificationType={}));var n=function(){function e(e){this.vertices=e;this.error=new Array(4);this.deleted=false;this.isDirty=false;this.deletePending=false;this.borderFactor=0}return e}();e.DecimationTriangle=n;var o=function(){function e(e,t){this.position=e;this.id=t;this.isBorder=true;this.q=new s;this.triangleCount=0;this.triangleStart=0;this.originalOffsets=[]}e.prototype.updatePosition=function(e){this.position.copyFrom(e)};return e}();e.DecimationVertex=o;var s=function(){function e(e){this.data=new Array(10);for(var t=0;t<10;++t){if(e&&e[t]){this.data[t]=e[t]}else{this.data[t]=0}}}e.prototype.det=function(e,t,i,r,n,o,s,a,u){var l=this.data[e]*this.data[n]*this.data[u]+this.data[i]*this.data[r]*this.data[a]+this.data[t]*this.data[o]*this.data[s]-this.data[i]*this.data[n]*this.data[s]-this.data[e]*this.data[o]*this.data[a]-this.data[t]*this.data[r]*this.data[u];return l};e.prototype.addInPlace=function(e){for(var t=0;t<10;++t){this.data[t]+=e.data[t]}};e.prototype.addArrayInPlace=function(e){for(var t=0;t<10;++t){this.data[t]+=e[t]}};e.prototype.add=function(t){var i=new e;for(var r=0;r<10;++r){i.data[r]=this.data[r]+t.data[r]}return i};e.FromData=function(t,i,r,n){return new e(e.DataFromNumbers(t,i,r,n))};e.DataFromNumbers=function(e,t,i,r){return[e*e,e*t,e*i,e*r,t*t,t*i,t*r,i*i,i*r,r*r]};return e}();e.QuadraticMatrix=s;var a=function(){function e(e,t){this.vertexId=e;this.triangleId=t}return e}();e.Reference=a;var u=function(){function t(t){this._mesh=t;this.syncIterations=5e3;this.aggressiveness=7;this.decimationIterations=100;this.boundingBoxEpsilon=e.Epsilon}t.prototype.simplify=function(t,i){var r=this;this.initDecimatedMesh();e.AsyncLoop.Run(this._mesh.subMeshes.length,function(e){r.initWithMesh(e.index,function(){r.runDecimation(t,e.index,function(){e.executeNext()})},t.optimizeMesh)},function(){setTimeout(function(){i(r._reconstructedMesh)},0)})};t.prototype.runDecimation=function(t,i,r){var n=this;var o=~~(this.triangles.length*t.quality);var s=0;var a=this.triangles.length;var u=function(t,i){setTimeout(function(){if(t%5===0){n.updateMesh(t===0)}for(var r=0;r<n.triangles.length;++r){n.triangles[r].isDirty=false}var u=1e-9*Math.pow(t+3,n.aggressiveness);var l=function(t){var i=~~((n.triangles.length/2+t)%n.triangles.length);var r=n.triangles[i];if(!r)return;if(r.error[3]>u||r.deleted||r.isDirty){return}for(var o=0;o<3;++o){if(r.error[o]<u){var a=[];var l=[];var c=r.vertices[o];var h=r.vertices[(o+1)%3];if(c.isBorder||h.isBorder)continue;var f=e.Vector3.Zero();var d=e.Vector3.Zero();var p=e.Vector2.Zero();var _=new e.Color4(0,0,0,1);n.calculateError(c,h,f,d,p,_);var m=new Array;if(n.isFlipped(c,h,f,a,r.borderFactor,m))continue;if(n.isFlipped(h,c,f,l,r.borderFactor,m))continue;if(a.indexOf(true)<0||l.indexOf(true)<0)continue;var g=new Array;m.forEach(function(e){if(g.indexOf(e)===-1){e.deletePending=true;g.push(e)}});if(g.length%2!==0){continue}c.q=h.q.add(c.q);c.updatePosition(f);var v=n.references.length;s=n.updateTriangles(c,c,a,s);s=n.updateTriangles(c,h,l,s);var y=n.references.length-v;if(y<=c.triangleCount){if(y){for(var b=0;b<y;b++){n.references[c.triangleStart+b]=n.references[v+b]}}}else{c.triangleStart=v}c.triangleCount=y;break}}};e.AsyncLoop.SyncAsyncForLoop(n.triangles.length,n.syncIterations,l,i,function(){return a-s<=o})},0)};e.AsyncLoop.Run(this.decimationIterations,function(e){if(a-s<=o)e.breakLoop();else{u(e.index,function(){e.executeNext()})}},function(){setTimeout(function(){n.reconstructMesh(i);r()},0)})};t.prototype.initWithMesh=function(t,i,r){var s=this;this.vertices=[];this.triangles=[];var a=this._mesh.getVerticesData(e.VertexBuffer.PositionKind);var u=this._mesh.getIndices();var l=this._mesh.subMeshes[t];var c=function(e){if(r){for(var t=0;t<s.vertices.length;++t){if(s.vertices[t].position.equals(e)){return s.vertices[t]}}}return null};var h=[];var f=function(t){if(!a){return}var i=t+l.verticesStart;var r=e.Vector3.FromArray(a,i*3);var n=c(r)||new o(r,s.vertices.length);n.originalOffsets.push(i);if(n.id===s.vertices.length){s.vertices.push(n)}h.push(n.id)};var d=l.verticesCount;e.AsyncLoop.SyncAsyncForLoop(d,this.syncIterations/4>>0,f,function(){var t=function(e){if(!u){return}var t=l.indexStart/3+e;var i=t*3;var r=u[i+0];var o=u[i+1];var a=u[i+2];var c=s.vertices[h[r-l.verticesStart]];var f=s.vertices[h[o-l.verticesStart]];var d=s.vertices[h[a-l.verticesStart]];var p=new n([c,f,d]);p.originalOffset=i;s.triangles.push(p)};e.AsyncLoop.SyncAsyncForLoop(l.indexCount/3,s.syncIterations,t,function(){s.init(i)})})};t.prototype.init=function(t){var i=this;var r=function(t){var r=i.triangles[t];r.normal=e.Vector3.Cross(r.vertices[1].position.subtract(r.vertices[0].position),r.vertices[2].position.subtract(r.vertices[0].position)).normalize();for(var n=0;n<3;n++){r.vertices[n].q.addArrayInPlace(s.DataFromNumbers(r.normal.x,r.normal.y,r.normal.z,-e.Vector3.Dot(r.normal,r.vertices[0].position)))}};e.AsyncLoop.SyncAsyncForLoop(this.triangles.length,this.syncIterations,r,function(){var r=function(e){var t=i.triangles[e];for(var r=0;r<3;++r){t.error[r]=i.calculateError(t.vertices[r],t.vertices[(r+1)%3])}t.error[3]=Math.min(t.error[0],t.error[1],t.error[2])};e.AsyncLoop.SyncAsyncForLoop(i.triangles.length,i.syncIterations,r,function(){t()})})};t.prototype.reconstructMesh=function(t){var i=[];var r;for(r=0;r<this.vertices.length;++r){this.vertices[r].triangleCount=0}var n;var o;for(r=0;r<this.triangles.length;++r){if(!this.triangles[r].deleted){n=this.triangles[r];for(o=0;o<3;++o){n.vertices[o].triangleCount=1}i.push(n)}}var s=this._reconstructedMesh.getVerticesData(e.VertexBuffer.PositionKind)||[];var a=this._reconstructedMesh.getVerticesData(e.VertexBuffer.NormalKind)||[];var u=this._reconstructedMesh.getVerticesData(e.VertexBuffer.UVKind)||[];var l=this._reconstructedMesh.getVerticesData(e.VertexBuffer.ColorKind)||[];var c=this._mesh.getVerticesData(e.VertexBuffer.NormalKind);var h=this._mesh.getVerticesData(e.VertexBuffer.UVKind);var f=this._mesh.getVerticesData(e.VertexBuffer.ColorKind);var d=0;for(r=0;r<this.vertices.length;++r){var p=this.vertices[r];p.id=d;if(p.triangleCount){p.originalOffsets.forEach(function(e){if(!c){return}s.push(p.position.x);s.push(p.position.y);s.push(p.position.z);a.push(c[e*3]);a.push(c[e*3+1]);a.push(c[e*3+2]);if(h&&h.length){u.push(h[e*2]);u.push(h[e*2+1])}else if(f&&f.length){l.push(f[e*4]);l.push(f[e*4+1]);l.push(f[e*4+2]);l.push(f[e*4+3])}++d})}}var _=this._reconstructedMesh.getTotalIndices();var m=this._reconstructedMesh.getTotalVertices();var g=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];var v=this._reconstructedMesh.getIndices();var y=this._mesh.getIndices();for(r=0;r<i.length;++r){n=i[r];[0,1,2].forEach(function(e){var t=y[n.originalOffset+e];var i=n.vertices[e].originalOffsets.indexOf(t);if(i<0)i=0;v.push(n.vertices[e].id+i+m)})}this._reconstructedMesh.setIndices(v);this._reconstructedMesh.setVerticesData(e.VertexBuffer.PositionKind,s);this._reconstructedMesh.setVerticesData(e.VertexBuffer.NormalKind,a);if(u.length>0)this._reconstructedMesh.setVerticesData(e.VertexBuffer.UVKind,u);if(l.length>0)this._reconstructedMesh.setVerticesData(e.VertexBuffer.ColorKind,l);var b=this._mesh.subMeshes[t];if(t>0){
this._reconstructedMesh.subMeshes=[];g.forEach(function(t){e.SubMesh.AddToMesh(t.materialIndex,t.verticesStart,t.verticesCount,t.indexStart,t.indexCount,t.getMesh())});e.SubMesh.AddToMesh(b.materialIndex,m,d,_,i.length*3,this._reconstructedMesh)}};t.prototype.initDecimatedMesh=function(){this._reconstructedMesh=new e.Mesh(this._mesh.name+"Decimated",this._mesh.getScene());this._reconstructedMesh.material=this._mesh.material;this._reconstructedMesh.parent=this._mesh.parent;this._reconstructedMesh.isVisible=false;this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId};t.prototype.isFlipped=function(t,i,r,n,o,s){for(var a=0;a<t.triangleCount;++a){var u=this.triangles[this.references[t.triangleStart+a].triangleId];if(u.deleted)continue;var l=this.references[t.triangleStart+a].vertexId;var c=u.vertices[(l+1)%3];var h=u.vertices[(l+2)%3];if(c===i||h===i){n[a]=true;s.push(u);continue}var f=c.position.subtract(r);f=f.normalize();var d=h.position.subtract(r);d=d.normalize();if(Math.abs(e.Vector3.Dot(f,d))>.999)return true;var p=e.Vector3.Cross(f,d).normalize();n[a]=false;if(e.Vector3.Dot(p,u.normal)<.2)return true}return false};t.prototype.updateTriangles=function(e,t,i,r){var n=r;for(var o=0;o<t.triangleCount;++o){var s=this.references[t.triangleStart+o];var a=this.triangles[s.triangleId];if(a.deleted)continue;if(i[o]&&a.deletePending){a.deleted=true;n++;continue}a.vertices[s.vertexId]=e;a.isDirty=true;a.error[0]=this.calculateError(a.vertices[0],a.vertices[1])+a.borderFactor/2;a.error[1]=this.calculateError(a.vertices[1],a.vertices[2])+a.borderFactor/2;a.error[2]=this.calculateError(a.vertices[2],a.vertices[0])+a.borderFactor/2;a.error[3]=Math.min(a.error[0],a.error[1],a.error[2]);this.references.push(s)}return n};t.prototype.identifyBorder=function(){for(var e=0;e<this.vertices.length;++e){var t=[];var i=[];var r=this.vertices[e];var n;for(n=0;n<r.triangleCount;++n){var o=this.triangles[this.references[r.triangleStart+n].triangleId];for(var s=0;s<3;s++){var a=0;var u=o.vertices[s];while(a<t.length){if(i[a]===u.id)break;++a}if(a===t.length){t.push(1);i.push(u.id)}else{t[a]++}}}for(n=0;n<t.length;++n){if(t[n]===1){this.vertices[i[n]].isBorder=true}else{this.vertices[i[n]].isBorder=false}}}};t.prototype.updateMesh=function(e){if(e===void 0){e=false}var t;if(!e){var i=[];for(t=0;t<this.triangles.length;++t){if(!this.triangles[t].deleted){i.push(this.triangles[t])}}this.triangles=i}for(t=0;t<this.vertices.length;++t){this.vertices[t].triangleCount=0;this.vertices[t].triangleStart=0}var r;var n;var o;for(t=0;t<this.triangles.length;++t){r=this.triangles[t];for(n=0;n<3;++n){o=r.vertices[n];o.triangleCount++}}var s=0;for(t=0;t<this.vertices.length;++t){this.vertices[t].triangleStart=s;s+=this.vertices[t].triangleCount;this.vertices[t].triangleCount=0}var u=new Array(this.triangles.length*3);for(t=0;t<this.triangles.length;++t){r=this.triangles[t];for(n=0;n<3;++n){o=r.vertices[n];u[o.triangleStart+o.triangleCount]=new a(n,t);o.triangleCount++}}this.references=u;if(e){this.identifyBorder()}};t.prototype.vertexError=function(e,t){var i=t.x;var r=t.y;var n=t.z;return e.data[0]*i*i+2*e.data[1]*i*r+2*e.data[2]*i*n+2*e.data[3]*i+e.data[4]*r*r+2*e.data[5]*r*n+2*e.data[6]*r+e.data[7]*n*n+2*e.data[8]*n+e.data[9]};t.prototype.calculateError=function(t,i,r,n,o,s){var a=t.q.add(i.q);var u=t.isBorder&&i.isBorder;var l=0;var c=a.det(0,1,2,1,4,5,2,5,7);if(c!==0&&!u){if(!r){r=e.Vector3.Zero()}r.x=-1/c*a.det(1,2,3,4,5,6,5,7,8);r.y=1/c*a.det(0,2,3,1,5,6,2,7,8);r.z=-1/c*a.det(0,1,3,1,4,6,2,5,8);l=this.vertexError(a,r)}else{var h=t.position.add(i.position).divide(new e.Vector3(2,2,2));var f=this.vertexError(a,t.position);var d=this.vertexError(a,i.position);var p=this.vertexError(a,h);l=Math.min(f,d,p);if(l===f){if(r){r.copyFrom(t.position)}}else if(l===d){if(r){r.copyFrom(i.position)}}else{if(r){r.copyFrom(h)}}}return l};return t}();e.QuadraticErrorSimplification=u})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e,t){this.distance=e;this.mesh=t}return e}();e.MeshLODLevel=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(e){if(e===void 0){e=0}this.priority=e}e.prototype.getDescription=function(){return""};e.prototype.apply=function(e,t){return true};return e}();e.SceneOptimization=t;var i=function(e){__extends(t,e);function t(t,i,r){if(t===void 0){t=0}if(i===void 0){i=1024}if(r===void 0){r=.5}var n=e.call(this,t)||this;n.priority=t;n.maximumSize=i;n.step=r;return n}t.prototype.getDescription=function(){return"Reducing render target texture size to "+this.maximumSize};t.prototype.apply=function(e,t){var i=true;for(var r=0;r<e.textures.length;r++){var n=e.textures[r];if(!n.canRescale||n.getContext){continue}var o=n.getSize();var s=Math.max(o.width,o.height);if(s>this.maximumSize){n.scale(this.step);i=false}}return i};return t}(t);e.TextureOptimization=i;var r=function(e){__extends(t,e);function t(t,i,r){if(t===void 0){t=0}if(i===void 0){i=2}if(r===void 0){r=.25}var n=e.call(this,t)||this;n.priority=t;n.maximumScale=i;n.step=r;n._currentScale=-1;n._directionOffset=1;return n}t.prototype.getDescription=function(){return"Setting hardware scaling level to "+this._currentScale};t.prototype.apply=function(e,t){if(this._currentScale===-1){this._currentScale=e.getEngine().getHardwareScalingLevel();if(this._currentScale>this.maximumScale){this._directionOffset=-1}}this._currentScale+=this._directionOffset*this.step;e.getEngine().setHardwareScalingLevel(this._currentScale);return this._directionOffset===1?this._currentScale>=this.maximumScale:this._currentScale<=this.maximumScale};return t}(t);e.HardwareScalingOptimization=r;var n=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.getDescription=function(){return"Turning shadows on/off"};t.prototype.apply=function(e,t){e.shadowsEnabled=t.isInImprovementMode;return true};return t}(t);e.ShadowsOptimization=n;var o=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.getDescription=function(){return"Turning post-processes on/off"};t.prototype.apply=function(e,t){e.postProcessesEnabled=t.isInImprovementMode;return true};return t}(t);e.PostProcessesOptimization=o;var s=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.getDescription=function(){return"Turning lens flares on/off"};t.prototype.apply=function(e,t){e.lensFlaresEnabled=t.isInImprovementMode;return true};return t}(t);e.LensFlaresOptimization=s;var a=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.getDescription=function(){if(this.onGetDescription){return this.onGetDescription()}return"Running user defined callback"};t.prototype.apply=function(e,t){if(this.onApply){return this.onApply(e,t)}return true};return t}(t);e.CustomOptimization=a;var u=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.getDescription=function(){return"Turning particles on/off"};t.prototype.apply=function(e,t){e.particlesEnabled=t.isInImprovementMode;return true};return t}(t);e.ParticlesOptimization=u;var l=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.getDescription=function(){return"Turning render targets off"};t.prototype.apply=function(e,t){e.renderTargetsEnabled=t.isInImprovementMode;return true};return t}(t);e.RenderTargetsOptimization=l;var c=function(t){__extends(i,t);function i(){var i=t!==null&&t.apply(this,arguments)||this;i._canBeMerged=function(t){if(!(t instanceof e.Mesh)){return false}var i=t;if(!i.isVisible||!i.isEnabled()){return false}if(i.instances.length>0){return false}if(i.skeleton||i.hasLODLevels){return false}if(i.parent){return false}return true};return i}Object.defineProperty(i,"UpdateSelectionTree",{get:function(){return i._UpdateSelectionTree},set:function(e){i._UpdateSelectionTree=e},enumerable:true,configurable:true});i.prototype.getDescription=function(){return"Merging similar meshes together"};i.prototype.apply=function(t,r,n){var o=t.meshes.slice(0);var s=o.length;for(var a=0;a<s;a++){var u=new Array;var l=o[a];if(!this._canBeMerged(l)){continue}u.push(l);for(var c=a+1;c<s;c++){var h=o[c];if(!this._canBeMerged(h)){continue}if(h.material!==l.material){continue}if(h.checkCollisions!==l.checkCollisions){continue}u.push(h);s--;o.splice(c,1);c--}if(u.length<2){continue}e.Mesh.MergeMeshes(u)}if(n!=undefined){if(n){t.createOrUpdateSelectionOctree()}}else if(i.UpdateSelectionTree){t.createOrUpdateSelectionOctree()}return true};i._UpdateSelectionTree=false;return i}(t);e.MergeMeshesOptimization=c;var h=function(){function e(e,t){if(e===void 0){e=60}if(t===void 0){t=2e3}this.targetFrameRate=e;this.trackerDuration=t;this.optimizations=new Array}e.prototype.addOptimization=function(e){this.optimizations.push(e);return this};e.prototype.addCustomOptimization=function(e,t,i){if(i===void 0){i=0}var r=new a(i);r.onApply=e;r.onGetDescription=t;this.optimizations.push(r);return this};e.LowDegradationAllowed=function(t){var r=new e(t);var a=0;r.addOptimization(new c(a));r.addOptimization(new n(a));r.addOptimization(new s(a));a++;r.addOptimization(new o(a));r.addOptimization(new u(a));a++;r.addOptimization(new i(a,1024));return r};e.ModerateDegradationAllowed=function(t){var a=new e(t);var h=0;a.addOptimization(new c(h));a.addOptimization(new n(h));a.addOptimization(new s(h));h++;a.addOptimization(new o(h));a.addOptimization(new u(h));h++;a.addOptimization(new i(h,512));h++;a.addOptimization(new l(h));h++;a.addOptimization(new r(h,2));return a};e.HighDegradationAllowed=function(t){var a=new e(t);var h=0;a.addOptimization(new c(h));a.addOptimization(new n(h));a.addOptimization(new s(h));h++;a.addOptimization(new o(h));a.addOptimization(new u(h));h++;a.addOptimization(new i(h,256));h++;a.addOptimization(new l(h));h++;a.addOptimization(new r(h,4));return a};return e}();e.SceneOptimizerOptions=h;var f=function(){function t(t,i,r,n){if(r===void 0){r=true}if(n===void 0){n=false}var o=this;this._isRunning=false;this._currentPriorityLevel=0;this._targetFrameRate=60;this._trackerDuration=2e3;this._currentFrameRate=0;this._improvementMode=false;this.onSuccessObservable=new e.Observable;this.onNewOptimizationAppliedObservable=new e.Observable;this.onFailureObservable=new e.Observable;if(!i){this._options=new h}else{this._options=i}if(this._options.targetFrameRate){this._targetFrameRate=this._options.targetFrameRate}if(this._options.trackerDuration){this._trackerDuration=this._options.trackerDuration}if(r){var s=0;for(var a=0,u=this._options.optimizations;a<u.length;a++){var l=u[a];l.priority=s++}}this._improvementMode=n;this._scene=t||e.Engine.LastCreatedScene;this._sceneDisposeObserver=this._scene.onDisposeObservable.add(function(){o._sceneDisposeObserver=null;o.dispose()})}Object.defineProperty(t.prototype,"isInImprovementMode",{get:function(){return this._improvementMode},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"currentPriorityLevel",{get:function(){return this._currentPriorityLevel},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"currentFrameRate",{get:function(){return this._currentFrameRate},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"targetFrameRate",{get:function(){return this._targetFrameRate},set:function(e){this._targetFrameRate=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"trackerDuration",{get:function(){return this._trackerDuration},set:function(e){this._trackerDuration=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"optimizations",{get:function(){return this._options.optimizations},enumerable:true,configurable:true});t.prototype.stop=function(){this._isRunning=false};t.prototype.reset=function(){this._currentPriorityLevel=0};t.prototype.start=function(){var e=this;if(this._isRunning){return}this._isRunning=true;this._scene.executeWhenReady(function(){setTimeout(function(){e._checkCurrentState()},e._trackerDuration)})};t.prototype._checkCurrentState=function(){var e=this;if(!this._isRunning){return}var t=this._scene;var i=this._options;this._currentFrameRate=Math.round(t.getEngine().getFps());if(this._improvementMode&&this._currentFrameRate<=this._targetFrameRate||!this._improvementMode&&this._currentFrameRate>=this._targetFrameRate){this._isRunning=false;this.onSuccessObservable.notifyObservers(this);return}var r=true;var n=true;for(var o=0;o<i.optimizations.length;o++){var s=i.optimizations[o];if(s.priority===this._currentPriorityLevel){n=false;r=r&&s.apply(t,this);this.onNewOptimizationAppliedObservable.notifyObservers(s)}}if(n){this._isRunning=false;this.onFailureObservable.notifyObservers(this);return}if(r){this._currentPriorityLevel++}t.executeWhenReady(function(){setTimeout(function(){e._checkCurrentState()},e._trackerDuration)})};t.prototype.dispose=function(){this.stop();this.onSuccessObservable.clear();this.onFailureObservable.clear();this.onNewOptimizationAppliedObservable.clear();if(this._sceneDisposeObserver){this._scene.onDisposeObservable.remove(this._sceneDisposeObserver)}};t.OptimizeAsync=function(e,i,r,n){var o=new t(e,i||h.ModerateDegradationAllowed(),false);if(r){o.onSuccessObservable.add(function(){r()})}if(n){o.onFailureObservable.add(function(){n()})}o.start();return o};return t}();e.SceneOptimizer=f})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(e){this.zOffset=1;this._scene=e}t.prototype.render=function(t,i,r){var n=this;if(r===void 0){r=false}var o=this._scene;var s=this._scene.getEngine();var a=s.getCaps().instancedArrays&&i.visibleInstances[t._id]!==null&&i.visibleInstances[t._id]!==undefined;if(!this.isReady(t,a)){return}var u=t.getRenderingMesh();var l=t.getMaterial();if(!l||!o.activeCamera){return}s.enableEffect(this._effect);if(l.useLogarithmicDepth){this._effect.setFloat("logarithmicDepthConstant",2/(Math.log(o.activeCamera.maxZ+1)/Math.LN2))}this._effect.setFloat("offset",r?0:u.outlineWidth);this._effect.setColor4("color",r?u.overlayColor:u.outlineColor,r?u.overlayAlpha:l.alpha);this._effect.setMatrix("viewProjection",o.getTransformMatrix());if(u.useBones&&u.computeBonesUsingShaders&&u.skeleton){this._effect.setMatrices("mBones",u.skeleton.getTransformMatrices(u))}u._bind(t,this._effect,e.Material.TriangleFillMode);if(l&&l.needAlphaTesting()){var c=l.getAlphaTestTexture();if(c){this._effect.setTexture("diffuseSampler",c);this._effect.setMatrix("diffuseMatrix",c.getTextureMatrix())}}s.setZOffset(-this.zOffset);u._processRendering(t,this._effect,e.Material.TriangleFillMode,i,a,function(e,t){n._effect.setMatrix("world",t)});s.setZOffset(0)};t.prototype.isReady=function(t,i){var r=[];var n=[e.VertexBuffer.PositionKind,e.VertexBuffer.NormalKind];var o=t.getMesh();var s=t.getMaterial();if(s){if(s.needAlphaTesting()){r.push("#define ALPHATEST");if(o.isVerticesDataPresent(e.VertexBuffer.UVKind)){n.push(e.VertexBuffer.UVKind);r.push("#define UV1")}if(o.isVerticesDataPresent(e.VertexBuffer.UV2Kind)){n.push(e.VertexBuffer.UV2Kind);r.push("#define UV2")}}if(s.useLogarithmicDepth){r.push("#define LOGARITHMICDEPTH")}}if(o.useBones&&o.computeBonesUsingShaders){n.push(e.VertexBuffer.MatricesIndicesKind);n.push(e.VertexBuffer.MatricesWeightsKind);if(o.numBoneInfluencers>4){n.push(e.VertexBuffer.MatricesIndicesExtraKind);n.push(e.VertexBuffer.MatricesWeightsExtraKind)}r.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers);r.push("#define BonesPerMesh "+(o.skeleton?o.skeleton.bones.length+1:0))}else{r.push("#define NUM_BONE_INFLUENCERS 0")}if(i){r.push("#define INSTANCES");n.push("world0");n.push("world1");n.push("world2");n.push("world3")}var a=r.join("\n");if(this._cachedDefines!==a){this._cachedDefines=a;this._effect=this._scene.getEngine().createEffect("outline",n,["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant"],["diffuseSampler"],a)}return this._effect.isReady()};return t}();e.OutlineRenderer=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this.edges=new Array;this.edgesConnectedCount=0}return e}();var i=function(){function i(e,t,i){if(t===void 0){t=.95}if(i===void 0){i=false}this.edgesWidthScalerForOrthographic=1e3;this.edgesWidthScalerForPerspective=50;this._linesPositions=new Array;this._linesNormals=new Array;this._linesIndices=new Array;this._buffers={};this._checkVerticesInsteadOfIndices=false;this._source=e;this._checkVerticesInsteadOfIndices=i;this._epsilon=t;this._prepareRessources();this._generateEdgesLines()}i.prototype._prepareRessources=function(){if(this._lineShader){return}this._lineShader=new e.ShaderMaterial("lineShader",this._source.getScene(),"line",{attributes:["position","normal"],uniforms:["worldViewProjection","color","width","aspectRatio"]});this._lineShader.disableDepthWrite=true;this._lineShader.backFaceCulling=false};i.prototype._rebuild=function(){var t=this._buffers[e.VertexBuffer.PositionKind];if(t){t._rebuild()}t=this._buffers[e.VertexBuffer.NormalKind];if(t){t._rebuild()}var i=this._source.getScene();var r=i.getEngine();this._ib=r.createIndexBuffer(this._linesIndices)};i.prototype.dispose=function(){var t=this._buffers[e.VertexBuffer.PositionKind];if(t){t.dispose();this._buffers[e.VertexBuffer.PositionKind]=null}t=this._buffers[e.VertexBuffer.NormalKind];if(t){t.dispose();this._buffers[e.VertexBuffer.NormalKind]=null}this._source.getScene().getEngine()._releaseBuffer(this._ib);this._lineShader.dispose()};i.prototype._processEdgeForAdjacencies=function(e,t,i,r,n){if(e===i&&t===r||e===r&&t===i){return 0}if(e===r&&t===n||e===n&&t===r){return 1}if(e===n&&t===i||e===i&&t===n){return 2}return-1};i.prototype._processEdgeForAdjacenciesWithVertices=function(e,t,i,r,n){if(e.equalsWithEpsilon(i)&&t.equalsWithEpsilon(r)||e.equalsWithEpsilon(r)&&t.equalsWithEpsilon(i)){return 0}if(e.equalsWithEpsilon(r)&&t.equalsWithEpsilon(n)||e.equalsWithEpsilon(n)&&t.equalsWithEpsilon(r)){return 1}if(e.equalsWithEpsilon(n)&&t.equalsWithEpsilon(i)||e.equalsWithEpsilon(i)&&t.equalsWithEpsilon(n)){return 2}return-1};i.prototype._checkEdge=function(t,i,r,n,o){var s;if(i===undefined){s=true}else{var a=e.Vector3.Dot(r[t],r[i]);s=a<this._epsilon}if(s){var u=this._linesPositions.length/3;var l=n.subtract(o);l.normalize();this._linesPositions.push(n.x);this._linesPositions.push(n.y);this._linesPositions.push(n.z);this._linesPositions.push(n.x);this._linesPositions.push(n.y);this._linesPositions.push(n.z);this._linesPositions.push(o.x);this._linesPositions.push(o.y);this._linesPositions.push(o.z);this._linesPositions.push(o.x);this._linesPositions.push(o.y);this._linesPositions.push(o.z);this._linesNormals.push(o.x);this._linesNormals.push(o.y);this._linesNormals.push(o.z);this._linesNormals.push(-1);this._linesNormals.push(o.x);this._linesNormals.push(o.y);this._linesNormals.push(o.z);this._linesNormals.push(1);this._linesNormals.push(n.x);this._linesNormals.push(n.y);this._linesNormals.push(n.z);this._linesNormals.push(-1);this._linesNormals.push(n.x);this._linesNormals.push(n.y);this._linesNormals.push(n.z);this._linesNormals.push(1);this._linesIndices.push(u);this._linesIndices.push(u+1);this._linesIndices.push(u+2);this._linesIndices.push(u);this._linesIndices.push(u+2);this._linesIndices.push(u+3)}};i.prototype._generateEdgesLines=function(){var i=this._source.getVerticesData(e.VertexBuffer.PositionKind);var r=this._source.getIndices();if(!r||!i){return}var n=new Array;var o=new Array;var s;var a;for(s=0;s<r.length;s+=3){a=new t;var u=r[s];var l=r[s+1];var c=r[s+2];a.p0=new e.Vector3(i[u*3],i[u*3+1],i[u*3+2]);a.p1=new e.Vector3(i[l*3],i[l*3+1],i[l*3+2]);a.p2=new e.Vector3(i[c*3],i[c*3+1],i[c*3+2]);var h=e.Vector3.Cross(a.p1.subtract(a.p0),a.p2.subtract(a.p1));h.normalize();o.push(h);n.push(a)}for(s=0;s<n.length;s++){a=n[s];for(var f=s+1;f<n.length;f++){var d=n[f];if(a.edgesConnectedCount===3){break}if(d.edgesConnectedCount===3){continue}var p=r[f*3];var _=r[f*3+1];var m=r[f*3+2];for(var g=0;g<3;g++){var v=0;if(a.edges[g]!==undefined){continue}switch(g){case 0:if(this._checkVerticesInsteadOfIndices){v=this._processEdgeForAdjacenciesWithVertices(a.p0,a.p1,d.p0,d.p1,d.p2)}else{v=this._processEdgeForAdjacencies(r[s*3],r[s*3+1],p,_,m)}break;case 1:if(this._checkVerticesInsteadOfIndices){v=this._processEdgeForAdjacenciesWithVertices(a.p1,a.p2,d.p0,d.p1,d.p2)}else{v=this._processEdgeForAdjacencies(r[s*3+1],r[s*3+2],p,_,m)}break;case 2:if(this._checkVerticesInsteadOfIndices){v=this._processEdgeForAdjacenciesWithVertices(a.p2,a.p0,d.p0,d.p1,d.p2)}else{v=this._processEdgeForAdjacencies(r[s*3+2],r[s*3],p,_,m)}break}if(v===-1){continue}a.edges[g]=f;d.edges[v]=s;a.edgesConnectedCount++;d.edgesConnectedCount++;if(a.edgesConnectedCount===3){break}}}}for(s=0;s<n.length;s++){var y=n[s];this._checkEdge(s,y.edges[0],o,y.p0,y.p1);this._checkEdge(s,y.edges[1],o,y.p1,y.p2);this._checkEdge(s,y.edges[2],o,y.p2,y.p0)}var b=this._source.getScene().getEngine();this._buffers[e.VertexBuffer.PositionKind]=new e.VertexBuffer(b,this._linesPositions,e.VertexBuffer.PositionKind,false);this._buffers[e.VertexBuffer.NormalKind]=new e.VertexBuffer(b,this._linesNormals,e.VertexBuffer.NormalKind,false,false,4);this._ib=b.createIndexBuffer(this._linesIndices);this._indicesCount=this._linesIndices.length};i.prototype.render=function(){var t=this._source.getScene();if(!this._lineShader.isReady()||!t.activeCamera){return}var i=t.getEngine();this._lineShader._preBind();i.bindBuffers(this._buffers,this._ib,this._lineShader.getEffect());t.resetCachedMaterial();this._lineShader.setColor4("color",this._source.edgesColor);if(t.activeCamera.mode===e.Camera.ORTHOGRAPHIC_CAMERA){this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic)}else{this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective)}this._lineShader.setFloat("aspectRatio",i.getAspectRatio(t.activeCamera));this._lineShader.bind(this._source.getWorldMatrix());i.drawElementsType(e.Material.TriangleFillMode,0,this._indicesCount);this._lineShader.unbind();i.setDepthWrite(true)};return i}();e.EdgesRenderer=i})(r||(r={}));"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++){t=arguments[i];for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n))e[n]=t[n]}return e};var r;(function(e){var t=function(){function t(t,i){this._vertexBuffers={};this._maxSize=0;this._mainTextureDesiredSize={width:0,height:0};this._shouldRender=true;this._postProcesses=[];this._textures=[];this._emissiveTextureAndColor={texture:null,color:new e.Color4};this.neutralColor=new e.Color4;this.isEnabled=true;this.onDisposeObservable=new e.Observable;this.onBeforeRenderMainTextureObservable=new e.Observable;this.onBeforeComposeObservable=new e.Observable;this.onAfterComposeObservable=new e.Observable;this.onSizeChangedObservable=new e.Observable;this.name=t;this._scene=i||e.Engine.LastCreatedScene;this._engine=i.getEngine();this._maxSize=this._engine.getCaps().maxTextureSize;this._scene.effectLayers.push(this);this._generateIndexBuffer();this._genrateVertexBuffer()}Object.defineProperty(t.prototype,"camera",{get:function(){return this._effectLayerOptions.camera},enumerable:true,configurable:true});t.prototype._init=function(t){this._effectLayerOptions=n({mainTextureRatio:.5,alphaBlendingMode:e.Engine.ALPHA_COMBINE,camera:null},t);this._setMainTextureSize();this._createMainTexture();this._createTextureAndPostProcesses();this._mergeEffect=this._createMergeEffect()};t.prototype._generateIndexBuffer=function(){var e=[];e.push(0);e.push(1);e.push(2);e.push(0);e.push(2);e.push(3);this._indexBuffer=this._engine.createIndexBuffer(e)};t.prototype._genrateVertexBuffer=function(){var t=[];t.push(1,1);t.push(-1,1);t.push(-1,-1);t.push(1,-1);var i=new e.VertexBuffer(this._engine,t,e.VertexBuffer.PositionKind,false,false,2);this._vertexBuffers[e.VertexBuffer.PositionKind]=i};t.prototype._setMainTextureSize=function(){if(this._effectLayerOptions.mainTextureFixedSize){this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize;this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize}else{this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio;this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio;this._mainTextureDesiredSize.width=this._engine.needPOTTextures?e.Tools.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width;this._mainTextureDesiredSize.height=this._engine.needPOTTextures?e.Tools.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height}this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width);this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)};t.prototype._createMainTexture=function(){var t=this;this._mainTexture=new e.RenderTargetTexture("HighlightLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,false,true,e.Engine.TEXTURETYPE_UNSIGNED_INT);this._mainTexture.activeCamera=this._effectLayerOptions.camera;this._mainTexture.wrapU=e.Texture.CLAMP_ADDRESSMODE;this._mainTexture.wrapV=e.Texture.CLAMP_ADDRESSMODE;this._mainTexture.anisotropicFilteringLevel=1;this._mainTexture.updateSamplingMode(e.Texture.BILINEAR_SAMPLINGMODE);this._mainTexture.renderParticles=false;this._mainTexture.renderList=null;this._mainTexture.ignoreCameraViewport=true;this._mainTexture.customRenderFunction=function(e,i,r,n){t.onBeforeRenderMainTextureObservable.notifyObservers(t);var o;var s=t._scene.getEngine();if(n.length){s.setColorWrite(false);for(o=0;o<n.length;o++){t._renderSubMesh(n.data[o])}s.setColorWrite(true)}for(o=0;o<e.length;o++){t._renderSubMesh(e.data[o])}for(o=0;o<i.length;o++){t._renderSubMesh(i.data[o])}for(o=0;o<r.length;o++){t._renderSubMesh(r.data[o])}};this._mainTexture.onClearObservable.add(function(e){e.clear(t.neutralColor,true,true,true)})};t.prototype._isReady=function(t,i,r){var n=t.getMaterial();if(!n){return false}if(!n.isReady(t.getMesh(),i)){return false}var o=[];var s=[e.VertexBuffer.PositionKind];var a=t.getMesh();var u=false;var l=false;if(n&&n.needAlphaTesting()){var c=n.getAlphaTestTexture();if(c){o.push("#define ALPHATEST");if(a.isVerticesDataPresent(e.VertexBuffer.UV2Kind)&&c.coordinatesIndex===1){o.push("#define DIFFUSEUV2");l=true}else if(a.isVerticesDataPresent(e.VertexBuffer.UVKind)){o.push("#define DIFFUSEUV1");u=true}}}if(r){o.push("#define EMISSIVE");if(a.isVerticesDataPresent(e.VertexBuffer.UV2Kind)&&r.coordinatesIndex===1){o.push("#define EMISSIVEUV2");l=true}else if(a.isVerticesDataPresent(e.VertexBuffer.UVKind)){o.push("#define EMISSIVEUV1");u=true}}if(u){s.push(e.VertexBuffer.UVKind);o.push("#define UV1")}if(l){s.push(e.VertexBuffer.UV2Kind);o.push("#define UV2")}if(a.useBones&&a.computeBonesUsingShaders){s.push(e.VertexBuffer.MatricesIndicesKind);s.push(e.VertexBuffer.MatricesWeightsKind);if(a.numBoneInfluencers>4){s.push(e.VertexBuffer.MatricesIndicesExtraKind);s.push(e.VertexBuffer.MatricesWeightsExtraKind)}o.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers);o.push("#define BonesPerMesh "+(a.skeleton?a.skeleton.bones.length+1:0))}else{o.push("#define NUM_BONE_INFLUENCERS 0")}var h=a.morphTargetManager;var f=0;if(h){if(h.numInfluencers>0){o.push("#define MORPHTARGETS");f=h.numInfluencers;o.push("#define NUM_MORPH_INFLUENCERS "+f);e.MaterialHelper.PrepareAttributesForMorphTargets(s,a,{NUM_MORPH_INFLUENCERS:f})}}if(i){o.push("#define INSTANCES");s.push("world0");s.push("world1");s.push("world2");s.push("world3")}var d=o.join("\n");if(this._cachedDefines!==d){this._cachedDefines=d;this._effectLayerMapGenerationEffect=this._scene.getEngine().createEffect("glowMapGeneration",s,["world","mBones","viewProjection","diffuseMatrix","color","emissiveMatrix","morphTargetInfluences"],["diffuseSampler","emissiveSampler"],d,undefined,undefined,undefined,{maxSimultaneousMorphTargets:f})}return this._effectLayerMapGenerationEffect.isReady()};t.prototype.render=function(){var e=this._mergeEffect;if(!e.isReady())return;for(var t=0;t<this._postProcesses.length;t++){if(!this._postProcesses[t].isReady()){return}}var i=this._scene.getEngine();this.onBeforeComposeObservable.notifyObservers(this);i.enableEffect(e);i.setState(false);i.bindBuffers(this._vertexBuffers,this._indexBuffer,e);var r=i.getAlphaMode();i.setAlphaMode(this._effectLayerOptions.alphaBlendingMode);this._internalRender(e);i.setAlphaMode(r);this.onAfterComposeObservable.notifyObservers(this);var n=this._mainTexture.getSize();this._setMainTextureSize();if(n.width!==this._mainTextureDesiredSize.width||n.height!==this._mainTextureDesiredSize.height){this.onSizeChangedObservable.notifyObservers(this);this._disposeTextureAndPostProcesses();this._createMainTexture();this._createTextureAndPostProcesses()}};t.prototype.hasMesh=function(e){return true};t.prototype.shouldRender=function(){return this.isEnabled&&this._shouldRender};t.prototype._shouldRenderMesh=function(e){return true};t.prototype._shouldRenderEmissiveTextureForMesh=function(e){return true};t.prototype._renderSubMesh=function(t){var i=this;if(!this.shouldRender()){return}var r=t.getMaterial();var n=t.getRenderingMesh();var o=this._scene;var s=o.getEngine();if(!r){return}if(r.needAlphaBlendingForMesh(n)){return}s.setState(r.backFaceCulling);var a=n._getInstancesRenderList(t._id);if(a.mustReturn){return}if(!this._shouldRenderMesh(n)){return}var u=s.getCaps().instancedArrays&&a.visibleInstances[t._id]!==null&&a.visibleInstances[t._id]!==undefined;this._setEmissiveTextureAndColor(n,t,r);if(this._isReady(t,u,this._emissiveTextureAndColor.texture)){s.enableEffect(this._effectLayerMapGenerationEffect);n._bind(t,this._effectLayerMapGenerationEffect,e.Material.TriangleFillMode);this._effectLayerMapGenerationEffect.setMatrix("viewProjection",o.getTransformMatrix());this._effectLayerMapGenerationEffect.setFloat4("color",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a);if(r&&r.needAlphaTesting()){var l=r.getAlphaTestTexture();if(l){this._effectLayerMapGenerationEffect.setTexture("diffuseSampler",l);var c=l.getTextureMatrix();if(c){this._effectLayerMapGenerationEffect.setMatrix("diffuseMatrix",c)}}}if(this._emissiveTextureAndColor.texture){this._effectLayerMapGenerationEffect.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture);this._effectLayerMapGenerationEffect.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())}if(n.useBones&&n.computeBonesUsingShaders&&n.skeleton){this._effectLayerMapGenerationEffect.setMatrices("mBones",n.skeleton.getTransformMatrices(n))}e.MaterialHelper.BindMorphTargetParameters(n,this._effectLayerMapGenerationEffect);n._processRendering(t,this._effectLayerMapGenerationEffect,e.Material.TriangleFillMode,a,u,function(e,t){return i._effectLayerMapGenerationEffect.setMatrix("world",t)})}else{this._mainTexture.resetRefreshCounter()}};t.prototype._rebuild=function(){var t=this._vertexBuffers[e.VertexBuffer.PositionKind];if(t){t._rebuild()}this._generateIndexBuffer()};t.prototype._disposeTextureAndPostProcesses=function(){this._mainTexture.dispose();for(var e=0;e<this._postProcesses.length;e++){if(this._postProcesses[e]){this._postProcesses[e].dispose()}}this._postProcesses=[];for(var e=0;e<this._textures.length;e++){if(this._textures[e]){this._textures[e].dispose()}}this._textures=[]};t.prototype.dispose=function(){var t=this._vertexBuffers[e.VertexBuffer.PositionKind];if(t){t.dispose();this._vertexBuffers[e.VertexBuffer.PositionKind]=null}if(this._indexBuffer){this._scene.getEngine()._releaseBuffer(this._indexBuffer);this._indexBuffer=null}this._disposeTextureAndPostProcesses()
;var i=this._scene.effectLayers.indexOf(this,0);if(i>-1){this._scene.effectLayers.splice(i,1)}this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onBeforeRenderMainTextureObservable.clear();this.onBeforeComposeObservable.clear();this.onAfterComposeObservable.clear();this.onSizeChangedObservable.clear()};t.prototype.getClassName=function(){return"EffectLayer"};__decorate([e.serialize()],t.prototype,"name",void 0);__decorate([e.serializeAsColor4()],t.prototype,"neutralColor",void 0);__decorate([e.serialize()],t.prototype,"isEnabled",void 0);__decorate([e.serializeAsCameraReference()],t.prototype,"camera",null);return t}();e.EffectLayer=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o,s,a,u,l){if(a===void 0){a=e.Texture.BILINEAR_SAMPLINGMODE}var c=t.call(this,i,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,o,s,a,u,l)||this;c.direction=r;c.kernel=n;c.onApplyObservable.add(function(e){e.setFloat2("screenSize",c.width,c.height);e.setVector2("direction",c.direction);e.setFloat("blurWidth",c.kernel)});return c}return i}(e.PostProcess);var i=function(i){__extends(r,i);function r(t,o,s){var a=i.call(this,t,o)||this;a.name=t;a.innerGlow=true;a.outerGlow=true;a.onBeforeBlurObservable=new e.Observable;a.onAfterBlurObservable=new e.Observable;a._instanceGlowingMeshStencilReference=r.GlowingMeshStencilReference++;a._meshes={};a._excludedMeshes={};a.neutralColor=r.NeutralColor;if(!a._engine.isStencilEnable){e.Tools.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new BABYLON.Engine(canvas, antialias, { stencil: true }")}a._options=n({mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:e.Engine.ALPHA_COMBINE,camera:null},s);a._init({alphaBlendingMode:a._options.alphaBlendingMode,camera:a._options.camera,mainTextureFixedSize:a._options.mainTextureFixedSize,mainTextureRatio:a._options.mainTextureRatio});a._shouldRender=false;return a}Object.defineProperty(r.prototype,"blurHorizontalSize",{get:function(){return this._horizontalBlurPostprocess.kernel},set:function(e){this._horizontalBlurPostprocess.kernel=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"blurVerticalSize",{get:function(){return this._verticalBlurPostprocess.kernel},set:function(e){this._verticalBlurPostprocess.kernel=e},enumerable:true,configurable:true});r.prototype.getEffectName=function(){return r.EffectName};r.prototype._createMergeEffect=function(){return this._engine.createEffect("glowMapMerge",[e.VertexBuffer.PositionKind],["offset"],["textureSampler"],this._options.isStroke?"#define STROKE \n":undefined)};r.prototype._createTextureAndPostProcesses=function(){var i=this;var r=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio;var n=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;r=this._engine.needPOTTextures?e.Tools.GetExponentOfTwo(r,this._maxSize):r;n=this._engine.needPOTTextures?e.Tools.GetExponentOfTwo(n,this._maxSize):n;this._blurTexture=new e.RenderTargetTexture("HighlightLayerBlurRTT",{width:r,height:n},this._scene,false,true,e.Engine.TEXTURETYPE_HALF_FLOAT);this._blurTexture.wrapU=e.Texture.CLAMP_ADDRESSMODE;this._blurTexture.wrapV=e.Texture.CLAMP_ADDRESSMODE;this._blurTexture.anisotropicFilteringLevel=16;this._blurTexture.updateSamplingMode(e.Texture.TRILINEAR_SAMPLINGMODE);this._blurTexture.renderParticles=false;this._blurTexture.ignoreCameraViewport=true;this._textures=[this._blurTexture];if(this._options.alphaBlendingMode===e.Engine.ALPHA_COMBINE){this._downSamplePostprocess=new e.PassPostProcess("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine());this._downSamplePostprocess.onApplyObservable.add(function(e){e.setTexture("textureSampler",i._mainTexture)});this._horizontalBlurPostprocess=new t("HighlightLayerHBP",new e.Vector2(1,0),this._options.blurHorizontalSize,1,null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine());this._horizontalBlurPostprocess.onApplyObservable.add(function(e){e.setFloat2("screenSize",r,n)});this._verticalBlurPostprocess=new t("HighlightLayerVBP",new e.Vector2(0,1),this._options.blurVerticalSize,1,null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine());this._verticalBlurPostprocess.onApplyObservable.add(function(e){e.setFloat2("screenSize",r,n)});this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]}else{this._horizontalBlurPostprocess=new e.BlurPostProcess("HighlightLayerHBP",new e.Vector2(1,0),this._options.blurHorizontalSize/2,{width:r,height:n},null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,e.Engine.TEXTURETYPE_HALF_FLOAT);this._horizontalBlurPostprocess.width=r;this._horizontalBlurPostprocess.height=n;this._horizontalBlurPostprocess.onApplyObservable.add(function(e){e.setTexture("textureSampler",i._mainTexture)});this._verticalBlurPostprocess=new e.BlurPostProcess("HighlightLayerVBP",new e.Vector2(0,1),this._options.blurVerticalSize/2,{width:r,height:n},null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,e.Engine.TEXTURETYPE_HALF_FLOAT);this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]}this._mainTexture.onAfterUnbindObservable.add(function(){i.onBeforeBlurObservable.notifyObservers(i);var e=i._blurTexture.getInternalTexture();if(e){i._scene.postProcessManager.directRender(i._postProcesses,e,true)}i.onAfterBlurObservable.notifyObservers(i)});this._postProcesses.map(function(e){e.autoClear=false})};r.prototype.needStencil=function(){return true};r.prototype.isReady=function(e,t){var r=e.getMaterial();var n=e.getRenderingMesh();if(!r||!n||!this._meshes){return false}var o=null;var s=this._meshes[n.uniqueId];if(s&&s.glowEmissiveOnly&&r){o=r.emissiveTexture}return i.prototype._isReady.call(this,e,t,o)};r.prototype._internalRender=function(t){t.setTexture("textureSampler",this._blurTexture);var i=this._engine;var r=i.getStencilBuffer();var n=i.getStencilFunction();var o=i.getStencilMask();var s=i.getStencilOperationPass();var a=i.getStencilOperationFail();var u=i.getStencilOperationDepthFail();var l=i.getStencilFunctionReference();i.setStencilOperationPass(e.Engine.REPLACE);i.setStencilOperationFail(e.Engine.KEEP);i.setStencilOperationDepthFail(e.Engine.KEEP);i.setStencilMask(0);i.setStencilBuffer(true);i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference);if(this.outerGlow){t.setFloat("offset",0);i.setStencilFunction(e.Engine.NOTEQUAL);i.drawElementsType(e.Material.TriangleFillMode,0,6)}if(this.innerGlow){t.setFloat("offset",1);i.setStencilFunction(e.Engine.EQUAL);i.drawElementsType(e.Material.TriangleFillMode,0,6)}i.setStencilFunction(n);i.setStencilMask(o);i.setStencilBuffer(r);i.setStencilOperationPass(s);i.setStencilOperationFail(a);i.setStencilOperationDepthFail(u);i.setStencilFunctionReference(l)};r.prototype.shouldRender=function(){if(i.prototype.shouldRender.call(this)){return this._meshes?true:false}return false};r.prototype._shouldRenderMesh=function(e){if(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]){return false}return true};r.prototype._setEmissiveTextureAndColor=function(e,t,i){var r=this._meshes[e.uniqueId];if(r){this._emissiveTextureAndColor.color.set(r.color.r,r.color.g,r.color.b,1)}else{this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}if(r&&r.glowEmissiveOnly&&i){this._emissiveTextureAndColor.texture=i.emissiveTexture;this._emissiveTextureAndColor.color.set(1,1,1,1)}else{this._emissiveTextureAndColor.texture=null}};r.prototype.addExcludedMesh=function(e){if(!this._excludedMeshes){return}var t=this._excludedMeshes[e.uniqueId];if(!t){this._excludedMeshes[e.uniqueId]={mesh:e,beforeRender:e.onBeforeRenderObservable.add(function(e){e.getEngine().setStencilBuffer(false)}),afterRender:e.onAfterRenderObservable.add(function(e){e.getEngine().setStencilBuffer(true)})}}};r.prototype.removeExcludedMesh=function(e){if(!this._excludedMeshes){return}var t=this._excludedMeshes[e.uniqueId];if(t){if(t.beforeRender){e.onBeforeRenderObservable.remove(t.beforeRender)}if(t.afterRender){e.onAfterRenderObservable.remove(t.afterRender)}}this._excludedMeshes[e.uniqueId]=null};r.prototype.hasMesh=function(e){if(!this._meshes){return false}return this._meshes[e.uniqueId]!==undefined&&this._meshes[e.uniqueId]!==null};r.prototype.addMesh=function(e,t,i){var r=this;if(i===void 0){i=false}if(!this._meshes){return}var n=this._meshes[e.uniqueId];if(n){n.color=t}else{this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeRenderObservable.add(function(e){if(r._excludedMeshes&&r._excludedMeshes[e.uniqueId]){r._defaultStencilReference(e)}else{e.getScene().getEngine().setStencilFunctionReference(r._instanceGlowingMeshStencilReference)}}),observerDefault:e.onAfterRenderObservable.add(this._defaultStencilReference),glowEmissiveOnly:i}}this._shouldRender=true};r.prototype.removeMesh=function(e){if(!this._meshes){return}var t=this._meshes[e.uniqueId];if(t){if(t.observerHighlight){e.onBeforeRenderObservable.remove(t.observerHighlight)}if(t.observerDefault){e.onAfterRenderObservable.remove(t.observerDefault)}delete this._meshes[e.uniqueId]}this._shouldRender=false;for(var i in this._meshes){if(this._meshes[i]){this._shouldRender=true;break}}};r.prototype._defaultStencilReference=function(e){e.getScene().getEngine().setStencilFunctionReference(r.NormalMeshStencilReference)};r.prototype._disposeMesh=function(e){this.removeMesh(e);this.removeExcludedMesh(e)};r.prototype.dispose=function(){if(this._meshes){for(var e in this._meshes){var t=this._meshes[e];if(t&&t.mesh){if(t.observerHighlight){t.mesh.onBeforeRenderObservable.remove(t.observerHighlight)}if(t.observerDefault){t.mesh.onAfterRenderObservable.remove(t.observerDefault)}}}this._meshes=null}if(this._excludedMeshes){for(var e in this._excludedMeshes){var t=this._excludedMeshes[e];if(t){if(t.beforeRender){t.mesh.onBeforeRenderObservable.remove(t.beforeRender)}if(t.afterRender){t.mesh.onAfterRenderObservable.remove(t.afterRender)}}}this._excludedMeshes=null}i.prototype.dispose.call(this)};r.EffectName="HighlightLayer";r.NeutralColor=new e.Color4(0,0,0,0);r.GlowingMeshStencilReference=2;r.NormalMeshStencilReference=1;return r}(e.EffectLayer);e.HighlightLayer=i})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(r,o,s){var a=t.call(this,r,o)||this;a._intensity=1;a._includedOnlyMeshes=[];a._excludedMeshes=[];a.neutralColor=new e.Color4(0,0,0,1);a._options=n({mainTextureRatio:i.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:undefined,camera:null,mainTextureSamples:1},s);a._init({alphaBlendingMode:e.Engine.ALPHA_ADD,camera:a._options.camera,mainTextureFixedSize:a._options.mainTextureFixedSize,mainTextureRatio:a._options.mainTextureRatio});return a}Object.defineProperty(i.prototype,"blurKernelSize",{get:function(){return this._horizontalBlurPostprocess1.kernel},set:function(e){this._horizontalBlurPostprocess1.kernel=e;this._verticalBlurPostprocess1.kernel=e;this._horizontalBlurPostprocess2.kernel=e;this._verticalBlurPostprocess2.kernel=e},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"intensity",{get:function(){return this._intensity},set:function(e){this._intensity=e},enumerable:true,configurable:true});i.prototype.getEffectName=function(){return i.EffectName};i.prototype._createMergeEffect=function(){return this._engine.createEffect("glowMapMerge",[e.VertexBuffer.PositionKind],["offset"],["textureSampler","textureSampler2"],"#define EMISSIVE \n")};i.prototype._createTextureAndPostProcesses=function(){var t=this;var i=this._mainTextureDesiredSize.width;var r=this._mainTextureDesiredSize.height;i=this._engine.needPOTTextures?e.Tools.GetExponentOfTwo(i,this._maxSize):i;r=this._engine.needPOTTextures?e.Tools.GetExponentOfTwo(r,this._maxSize):r;var n=0;if(this._engine.getCaps().textureHalfFloatRender){n=e.Engine.TEXTURETYPE_HALF_FLOAT}else{n=e.Engine.TEXTURETYPE_UNSIGNED_INT}this._blurTexture1=new e.RenderTargetTexture("GlowLayerBlurRTT",{width:i,height:r},this._scene,false,true,n);this._blurTexture1.wrapU=e.Texture.CLAMP_ADDRESSMODE;this._blurTexture1.wrapV=e.Texture.CLAMP_ADDRESSMODE;this._blurTexture1.updateSamplingMode(e.Texture.BILINEAR_SAMPLINGMODE);this._blurTexture1.renderParticles=false;this._blurTexture1.ignoreCameraViewport=true;var o=Math.floor(i/2);var s=Math.floor(r/2);this._blurTexture2=new e.RenderTargetTexture("GlowLayerBlurRTT2",{width:o,height:s},this._scene,false,true,n);this._blurTexture2.wrapU=e.Texture.CLAMP_ADDRESSMODE;this._blurTexture2.wrapV=e.Texture.CLAMP_ADDRESSMODE;this._blurTexture2.updateSamplingMode(e.Texture.BILINEAR_SAMPLINGMODE);this._blurTexture2.renderParticles=false;this._blurTexture2.ignoreCameraViewport=true;this._textures=[this._blurTexture1,this._blurTexture2];this._horizontalBlurPostprocess1=new e.BlurPostProcess("GlowLayerHBP1",new e.Vector2(1,0),this._options.blurKernelSize/2,{width:i,height:r},null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,n);this._horizontalBlurPostprocess1.width=i;this._horizontalBlurPostprocess1.height=r;this._horizontalBlurPostprocess1.onApplyObservable.add(function(e){e.setTexture("textureSampler",t._mainTexture)});this._verticalBlurPostprocess1=new e.BlurPostProcess("GlowLayerVBP1",new e.Vector2(0,1),this._options.blurKernelSize/2,{width:i,height:r},null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,n);this._horizontalBlurPostprocess2=new e.BlurPostProcess("GlowLayerHBP2",new e.Vector2(1,0),this._options.blurKernelSize/2,{width:o,height:s},null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,n);this._horizontalBlurPostprocess2.width=o;this._horizontalBlurPostprocess2.height=s;this._horizontalBlurPostprocess2.onApplyObservable.add(function(e){e.setTexture("textureSampler",t._blurTexture1)});this._verticalBlurPostprocess2=new e.BlurPostProcess("GlowLayerVBP2",new e.Vector2(0,1),this._options.blurKernelSize/2,{width:o,height:s},null,e.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),false,n);this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2];this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1];this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2];this._mainTexture.samples=this._options.mainTextureSamples;this._mainTexture.onAfterUnbindObservable.add(function(){var e=t._blurTexture1.getInternalTexture();if(e){t._scene.postProcessManager.directRender(t._postProcesses1,e,true);e=t._blurTexture2.getInternalTexture();if(e){t._scene.postProcessManager.directRender(t._postProcesses2,e,true)}}});this._postProcesses.map(function(e){e.autoClear=false})};i.prototype.isReady=function(e,i){var r=e.getMaterial();var n=e.getRenderingMesh();if(!r||!n){return false}var o=r.emissiveTexture;return t.prototype._isReady.call(this,e,i,o)};i.prototype.needStencil=function(){return false};i.prototype._internalRender=function(t){t.setTexture("textureSampler",this._blurTexture1);t.setTexture("textureSampler2",this._blurTexture2);t.setFloat("offset",this._intensity);var i=this._engine;var r=i.getStencilBuffer();i.setStencilBuffer(false);i.drawElementsType(e.Material.TriangleFillMode,0,6);i.setStencilBuffer(r)};i.prototype._setEmissiveTextureAndColor=function(e,t,i){var r=1;if(this.customEmissiveTextureSelector){this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(e,t,i)}else{if(i){this._emissiveTextureAndColor.texture=i.emissiveTexture;if(this._emissiveTextureAndColor.texture){r=this._emissiveTextureAndColor.texture.level}}else{this._emissiveTextureAndColor.texture=null}}if(this.customEmissiveColorSelector){this.customEmissiveColorSelector(e,t,i,this._emissiveTextureAndColor.color)}else{if(i.emissiveColor){this._emissiveTextureAndColor.color.set(i.emissiveColor.r*r,i.emissiveColor.g*r,i.emissiveColor.b*r,1)}else{this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}}};i.prototype._shouldRenderMesh=function(e){return this.hasMesh(e)};i.prototype.addExcludedMesh=function(e){if(this._excludedMeshes.indexOf(e.uniqueId)===-1){this._excludedMeshes.push(e.uniqueId)}};i.prototype.removeExcludedMesh=function(e){var t=this._excludedMeshes.indexOf(e.uniqueId);if(t!==-1){this._excludedMeshes.splice(t,1)}};i.prototype.addIncludedOnlyMesh=function(e){if(this._includedOnlyMeshes.indexOf(e.uniqueId)===-1){this._includedOnlyMeshes.push(e.uniqueId)}};i.prototype.removeIncludedOnlyMesh=function(e){var t=this._includedOnlyMeshes.indexOf(e.uniqueId);if(t!==-1){this._includedOnlyMeshes.splice(t,1)}};i.prototype.hasMesh=function(e){if(this._includedOnlyMeshes.length){return this._includedOnlyMeshes.indexOf(e.uniqueId)!==-1}if(this._excludedMeshes.length){return this._excludedMeshes.indexOf(e.uniqueId)===-1}return true};i.prototype._disposeMesh=function(e){this.removeIncludedOnlyMesh(e);this.removeExcludedMesh(e)};i.prototype.getClassName=function(){return"GlowLayer"};i.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);var i;t.includedMeshes=[];if(this._includedOnlyMeshes.length){for(i=0;i<this._includedOnlyMeshes.length;i++){var r=this._scene.getMeshByUniqueID(this._includedOnlyMeshes[i]);if(r){t.includedMeshes.push(r.id)}}}t.excludedMeshes=[];if(this._excludedMeshes.length){for(i=0;i<this._excludedMeshes.length;i++){var r=this._scene.getMeshByUniqueID(this._excludedMeshes[i]);if(r){t.excludedMeshes.push(r.id)}}}return t};i.Parse=function(t,r,n){var o=e.SerializationHelper.Parse(function(){return new i(t.name,r,t.options)},t,r,n);var s;for(s=0;s<t.excludedMeshes.length;s++){var a=r.getMeshByID(t.excludedMeshes[s]);if(a){o.addExcludedMesh(a)}}for(s=0;s<t.includedMeshes.length;s++){var a=r.getMeshByID(t.includedMeshes[s]);if(a){o.addIncludedOnlyMesh(a)}}return o};i.EffectName="GlowLayer";i.DefaultBlurKernelSize=32;i.DefaultTextureRatio=.5;__decorate([e.serialize()],i.prototype,"blurKernelSize",null);__decorate([e.serialize()],i.prototype,"intensity",null);__decorate([e.serialize("options")],i.prototype,"_options",void 0);return i}(e.EffectLayer);e.GlowLayer=t})(r||(r={}));"use strict";var r;(function(e){var t;(function(e){e[e["INIT"]=0]="INIT";e[e["RUNNING"]=1]="RUNNING";e[e["DONE"]=2]="DONE";e[e["ERROR"]=3]="ERROR"})(t=e.AssetTaskState||(e.AssetTaskState={}));var i=function(){function e(e){this.name=e;this._isCompleted=false;this._taskState=t.INIT}Object.defineProperty(e.prototype,"isCompleted",{get:function(){return this._isCompleted},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"taskState",{get:function(){return this._taskState},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"errorObject",{get:function(){return this._errorObject},enumerable:true,configurable:true});e.prototype._setErrorObject=function(e,t){if(this._errorObject){return}this._errorObject={message:e,exception:t}};e.prototype.run=function(e,i,r){var n=this;this._taskState=t.RUNNING;this.runTask(e,function(){n.onDoneCallback(i,r)},function(e,t){n.onErrorCallback(r,e,t)})};e.prototype.runTask=function(e,t,i){throw new Error("runTask is not implemented")};e.prototype.onErrorCallback=function(e,i,r){this._taskState=t.ERROR;this._errorObject={message:i,exception:r};if(this.onError){this.onError(this,i,r)}e()};e.prototype.onDoneCallback=function(e,i){try{this._taskState=t.DONE;this._isCompleted=true;if(this.onSuccess){this.onSuccess(this)}e()}catch(e){this.onErrorCallback(i,"Task is done, error executing success callback(s)",e)}};return e}();e.AbstractAssetTask=i;var r=function(){function e(e,t,i){this.remainingCount=e;this.totalCount=t;this.task=i}return e}();e.AssetsProgressEvent=r;var n=function(t){__extends(i,t);function i(e,i,r,n){var o=t.call(this,e)||this;o.name=e;o.meshesNames=i;o.rootUrl=r;o.sceneFilename=n;return o}i.prototype.runTask=function(t,i,r){var n=this;e.SceneLoader.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,t,function(e,t,r){n.loadedMeshes=e;n.loadedParticleSystems=t;n.loadedSkeletons=r;i()},null,function(e,t,i){r(t,i)})};return i}(i);e.MeshAssetTask=n;var o=function(e){__extends(t,e);function t(t,i){var r=e.call(this,t)||this;r.name=t;r.url=i;return r}t.prototype.runTask=function(e,t,i){var r=this;e._loadFile(this.url,function(e){r.text=e;t()},undefined,false,false,function(e,t){if(e){i(e.status+" "+e.statusText,t)}})};return t}(i);e.TextFileAssetTask=o;var s=function(e){__extends(t,e);function t(t,i){var r=e.call(this,t)||this;r.name=t;r.url=i;return r}t.prototype.runTask=function(e,t,i){var r=this;e._loadFile(this.url,function(e){r.data=e;t()},undefined,true,true,function(e,t){if(e){i(e.status+" "+e.statusText,t)}})};return t}(i);e.BinaryFileAssetTask=s;var a=function(t){__extends(i,t);function i(e,i){var r=t.call(this,e)||this;r.name=e;r.url=i;return r}i.prototype.runTask=function(t,i,r){var n=this;var o=new Image;e.Tools.SetCorsBehavior(this.url,o);o.onload=function(){n.image=o;i()};o.onerror=function(e){r("Error loading image",e)};o.src=this.url};return i}(i);e.ImageAssetTask=a;var u=function(t){__extends(i,t);function i(i,r,n,o,s){if(s===void 0){s=e.Texture.TRILINEAR_SAMPLINGMODE}var a=t.call(this,i)||this;a.name=i;a.url=r;a.noMipmap=n;a.invertY=o;a.samplingMode=s;return a}i.prototype.runTask=function(t,i,r){var n=function(){i()};var o=function(e,t){r(e,t)};this.texture=new e.Texture(this.url,t,this.noMipmap,this.invertY,this.samplingMode,n,o)};return i}(i);e.TextureAssetTask=u;var l=function(t){__extends(i,t);function i(e,i,r,n,o){var s=t.call(this,e)||this;s.name=e;s.url=i;s.extensions=r;s.noMipmap=n;s.files=o;return s}i.prototype.runTask=function(t,i,r){var n=function(){i()};var o=function(e,t){r(e,t)};this.texture=new e.CubeTexture(this.url,t,this.extensions,this.noMipmap,this.files,n,o)};return i}(i);e.CubeTextureAssetTask=l;var c=function(t){__extends(i,t);function i(e,i,r,n,o,s,a){if(n===void 0){n=false}if(o===void 0){o=true}if(s===void 0){s=false}if(a===void 0){a=false}var u=t.call(this,e)||this;u.name=e;u.url=i;u.size=r;u.noMipmap=n;u.generateHarmonics=o;u.useInGammaSpace=s;u.usePMREMGenerator=a;return u}i.prototype.run=function(t,i,r){var n=function(){i()};var o=function(e,t){r(e,t)};this.texture=new e.HDRCubeTexture(this.url,t,this.size,this.noMipmap,this.generateHarmonics,this.useInGammaSpace,this.usePMREMGenerator,n,o)};return i}(i);e.HDRCubeTextureAssetTask=c;var h=function(){function i(t){this._isLoading=false;this._tasks=new Array;this._waitingTasksCount=0;this._totalTasksCount=0;this.onTaskSuccessObservable=new e.Observable;this.onTaskErrorObservable=new e.Observable;this.onTasksDoneObservable=new e.Observable;this.onProgressObservable=new e.Observable;this.useDefaultLoadingScreen=true;this._scene=t}i.prototype.addMeshTask=function(e,t,i,r){var o=new n(e,t,i,r);this._tasks.push(o);return o};i.prototype.addTextFileTask=function(e,t){var i=new o(e,t);this._tasks.push(i);return i};i.prototype.addBinaryFileTask=function(e,t){var i=new s(e,t);this._tasks.push(i);return i};i.prototype.addImageTask=function(e,t){var i=new a(e,t);this._tasks.push(i);return i};i.prototype.addTextureTask=function(t,i,r,n,o){if(o===void 0){o=e.Texture.TRILINEAR_SAMPLINGMODE}var s=new u(t,i,r,n,o);this._tasks.push(s);return s};i.prototype.addCubeTextureTask=function(e,t,i,r,n){var o=new l(e,t,i,r,n);this._tasks.push(o);return o};i.prototype.addHDRCubeTextureTask=function(e,t,i,r,n,o,s){if(r===void 0){r=false}if(n===void 0){n=true}if(o===void 0){o=false}if(s===void 0){s=false}var a=new c(e,t,i,r,n,o,s);this._tasks.push(a);return a};i.prototype._decreaseWaitingTasksCount=function(i){var n=this;this._waitingTasksCount--;try{if(i.taskState===t.DONE){e.Tools.SetImmediate(function(){var e=n._tasks.indexOf(i);if(e>-1){n._tasks.splice(e,1)}})}if(this.onProgress){this.onProgress(this._waitingTasksCount,this._totalTasksCount,i)}this.onProgressObservable.notifyObservers(new r(this._waitingTasksCount,this._totalTasksCount,i))}catch(t){e.Tools.Error("Error running progress callbacks.");console.log(t)}if(this._waitingTasksCount===0){try{if(this.onFinish){this.onFinish(this._tasks)}this.onTasksDoneObservable.notifyObservers(this._tasks)}catch(t){e.Tools.Error("Error running tasks-done callbacks.");console.log(t)}this._isLoading=false;this._scene.getEngine().hideLoadingUI()}};i.prototype._runTask=function(e){var t=this;var i=function(){try{if(t.onTaskSuccess){t.onTaskSuccess(e)}t.onTaskSuccessObservable.notifyObservers(e);t._decreaseWaitingTasksCount(e)}catch(e){r("Error executing task success callbacks",e)}};var r=function(i,r){e._setErrorObject(i,r);if(t.onTaskError){t.onTaskError(e)}t.onTaskErrorObservable.notifyObservers(e);t._decreaseWaitingTasksCount(e)};e.run(this._scene,i,r)};i.prototype.reset=function(){this._isLoading=false;this._tasks=new Array;return this};i.prototype.load=function(){if(this._isLoading){return this}this._isLoading=true;this._waitingTasksCount=this._tasks.length;this._totalTasksCount=this._tasks.length;if(this._waitingTasksCount===0){this._isLoading=false;if(this.onFinish){this.onFinish(this._tasks)}this.onTasksDoneObservable.notifyObservers(this._tasks);return this}if(this.useDefaultLoadingScreen){this._scene.getEngine().displayLoadingUI()}for(var e=0;e<this._tasks.length;e++){var t=this._tasks[e];this._runTask(t)}return this};return i}();e.AssetsManager=h})(r||(r={}));"use strict";var r;(function(e){var t=[];var i=function(i,r){if(t[i.id]){return}if(i.doNotSerialize){return}if(i instanceof e.BoxGeometry){r.boxes.push(i.serialize())}else if(i instanceof e.SphereGeometry){r.spheres.push(i.serialize())}else if(i instanceof e.CylinderGeometry){r.cylinders.push(i.serialize())}else if(i instanceof e.TorusGeometry){r.toruses.push(i.serialize())}else if(i instanceof e.GroundGeometry){r.grounds.push(i.serialize())}else if(i instanceof e.Plane){r.planes.push(i.serialize())}else if(i instanceof e.TorusKnotGeometry){r.torusKnots.push(i.serialize())}else if(i instanceof e._PrimitiveGeometry){throw new Error("Unknown primitive type")}else{r.vertexData.push(i.serializeVerticeData())}t[i.id]=true};var r=function(e,t){var r={};var n=e._geometry;if(n){if(!e.getScene().getGeometryByID(n.id)){i(n,t.geometries)}}if(e.serialize){e.serialize(r)}return r};var n=function(t,n){if(t.delayLoadState===e.Engine.DELAYLOADSTATE_LOADED||t.delayLoadState===e.Engine.DELAYLOADSTATE_NONE){if(t.material){if(t.material instanceof e.StandardMaterial){n.materials=n.materials||[];if(!n.materials.some(function(e){return e.id===t.material.id})){n.materials.push(t.material.serialize())}}else if(t.material instanceof e.MultiMaterial){n.multiMaterials=n.multiMaterials||[];if(!n.multiMaterials.some(function(e){return e.id===t.material.id})){n.multiMaterials.push(t.material.serialize())}}}var o=t._geometry;if(o){if(!n.geometries){n.geometries={};n.geometries.boxes=[];n.geometries.spheres=[];n.geometries.cylinders=[];n.geometries.toruses=[];n.geometries.grounds=[];n.geometries.planes=[];n.geometries.torusKnots=[];n.geometries.vertexData=[]}i(o,n.geometries)}if(t.skeleton){n.skeletons=n.skeletons||[];n.skeletons.push(t.skeleton.serialize())}n.meshes=n.meshes||[];n.meshes.push(r(t,n))}};var o=function(){function o(){}o.ClearCache=function(){t=[]};o.Serialize=function(n){var s={};o.ClearCache();s.useDelayedTextureLoading=n.useDelayedTextureLoading;s.autoClear=n.autoClear;s.clearColor=n.clearColor.asArray();s.ambientColor=n.ambientColor.asArray();s.gravity=n.gravity.asArray();s.collisionsEnabled=n.collisionsEnabled;s.workerCollisions=n.workerCollisions;if(n.fogMode&&n.fogMode!==0){s.fogMode=n.fogMode;s.fogColor=n.fogColor.asArray();s.fogStart=n.fogStart;s.fogEnd=n.fogEnd;s.fogDensity=n.fogDensity}if(n.isPhysicsEnabled()){var a=n.getPhysicsEngine();if(a){s.physicsEnabled=true;s.physicsGravity=a.gravity.asArray();s.physicsEngine=a.getPhysicsPluginName()}}if(n.metadata){s.metadata=n.metadata}s.morphTargetManagers=[];for(var u=0,l=n.meshes;u<l.length;u++){var c=l[u];var h=c.morphTargetManager;if(h){s.morphTargetManagers.push(h.serialize())}}s.lights=[];var f;var d;for(f=0;f<n.lights.length;f++){d=n.lights[f];if(!d.doNotSerialize){s.lights.push(d.serialize())}}s.cameras=[];for(f=0;f<n.cameras.length;f++){var p=n.cameras[f];if(!p.doNotSerialize){s.cameras.push(p.serialize())}}if(n.activeCamera){s.activeCameraID=n.activeCamera.id}e.Animation.AppendSerializedAnimations(n,s);s.materials=[];s.multiMaterials=[];var _;for(f=0;f<n.materials.length;f++){_=n.materials[f];if(!_.doNotSerialize){s.materials.push(_.serialize())}}s.multiMaterials=[];for(f=0;f<n.multiMaterials.length;f++){var m=n.multiMaterials[f];s.multiMaterials.push(m.serialize())}if(n.environmentTexture){s.environmentTexture=n.environmentTexture.name}s.skeletons=[];for(f=0;f<n.skeletons.length;f++){var g=n.skeletons[f];if(!g.doNotSerialize){s.skeletons.push(g.serialize())}}s.transformNodes=[];for(f=0;f<n.transformNodes.length;f++){s.transformNodes.push(n.transformNodes[f].serialize())}s.geometries={};s.geometries.boxes=[];s.geometries.spheres=[];s.geometries.cylinders=[];s.geometries.toruses=[];s.geometries.grounds=[];s.geometries.planes=[];s.geometries.torusKnots=[];s.geometries.vertexData=[];t=[];var v=n.getGeometries();for(f=0;f<v.length;f++){var y=v[f];if(y.isReady()){i(y,s.geometries)}}s.meshes=[];for(f=0;f<n.meshes.length;f++){var c=n.meshes[f];if(c instanceof e.Mesh){var b=c;if(!b.doNotSerialize){if(b.delayLoadState===e.Engine.DELAYLOADSTATE_LOADED||b.delayLoadState===e.Engine.DELAYLOADSTATE_NONE){s.meshes.push(r(b,s))}}}}s.particleSystems=[];for(f=0;f<n.particleSystems.length;f++){s.particleSystems.push(n.particleSystems[f].serialize())}s.lensFlareSystems=[];for(f=0;f<n.lensFlareSystems.length;f++){s.lensFlareSystems.push(n.lensFlareSystems[f].serialize())}s.shadowGenerators=[];for(f=0;f<n.lights.length;f++){d=n.lights[f];var x=d.getShadowGenerator();if(x){s.shadowGenerators.push(x.serialize())}}if(n.actionManager){s.actions=n.actionManager.serialize("scene")}s.sounds=[];for(f=0;f<n.soundTracks.length;f++){var T=n.soundTracks[f];for(var E=0;E<T.soundCollection.length;E++){s.sounds.push(T.soundCollection[E].serialize())}}return s};o.SerializeMesh=function(t,i,r){if(i===void 0){i=false}if(r===void 0){r=false}var s={};o.ClearCache();t=t instanceof Array?t:[t];if(i||r){for(var a=0;a<t.length;++a){if(r){t[a].getDescendants().forEach(function(i){if(i instanceof e.Mesh&&t.indexOf(i)<0){t.push(i)}})}if(i&&t[a].parent&&t.indexOf(t[a].parent)<0){t.push(t[a].parent)}}}t.forEach(function(e){n(e,s)});return s};return o}();e.SceneSerializer=o})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r,n){if(n===void 0){n=true}var o=this;this.name=t;this._viewMatrix=e.Matrix.Identity();this._target=e.Vector3.Zero();this._add=e.Vector3.Zero();this._invertYAxis=false;this.position=e.Vector3.Zero();this._scene=r;this._scene.reflectionProbes.push(this);this._renderTargetTexture=new e.RenderTargetTexture(t,i,r,n,true,e.Engine.TEXTURETYPE_UNSIGNED_INT,true);this._renderTargetTexture.onBeforeRenderObservable.add(function(t){switch(t){case 0:o._add.copyFromFloats(1,0,0);break;case 1:o._add.copyFromFloats(-1,0,0);break;case 2:o._add.copyFromFloats(0,o._invertYAxis?1:-1,0);break;case 3:o._add.copyFromFloats(0,o._invertYAxis?-1:1,0);break;case 4:o._add.copyFromFloats(0,0,1);break;case 5:o._add.copyFromFloats(0,0,-1);break}if(o._attachedMesh){o.position.copyFrom(o._attachedMesh.getAbsolutePosition())}o.position.addToRef(o._add,o._target);e.Matrix.LookAtLHToRef(o.position,o._target,e.Vector3.Up(),o._viewMatrix);r.setTransformMatrix(o._viewMatrix,o._projectionMatrix);r._forcedViewPosition=o.position});this._renderTargetTexture.onAfterUnbindObservable.add(function(){r._forcedViewPosition=null;r.updateTransformMatrix(true)})
;if(r.activeCamera){this._projectionMatrix=e.Matrix.PerspectiveFovLH(Math.PI/2,1,r.activeCamera.minZ,r.activeCamera.maxZ)}}Object.defineProperty(t.prototype,"samples",{get:function(){return this._renderTargetTexture.samples},set:function(e){this._renderTargetTexture.samples=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"refreshRate",{get:function(){return this._renderTargetTexture.refreshRate},set:function(e){this._renderTargetTexture.refreshRate=e},enumerable:true,configurable:true});t.prototype.getScene=function(){return this._scene};Object.defineProperty(t.prototype,"cubeTexture",{get:function(){return this._renderTargetTexture},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"renderList",{get:function(){return this._renderTargetTexture.renderList},enumerable:true,configurable:true});t.prototype.attachToMesh=function(e){this._attachedMesh=e};t.prototype.setRenderingAutoClearDepthStencil=function(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)};t.prototype.dispose=function(){var e=this._scene.reflectionProbes.indexOf(this);if(e!==-1){this._scene.reflectionProbes.splice(e,1)}if(this._renderTargetTexture){this._renderTargetTexture.dispose();this._renderTargetTexture=null}};return t}();e.ReflectionProbe=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t,i,r,n,o){this.name=t;this.scale=new e.Vector2(1,1);this.offset=new e.Vector2(0,0);this.alphaBlendingMode=e.Engine.ALPHA_COMBINE;this.layerMask=268435455;this._vertexBuffers={};this.onDisposeObservable=new e.Observable;this.onBeforeRenderObservable=new e.Observable;this.onAfterRenderObservable=new e.Observable;this.texture=i?new e.Texture(i,r,true):null;this.isBackground=n===undefined?true:n;this.color=o===undefined?new e.Color4(1,1,1,1):o;this._scene=r||e.Engine.LastCreatedScene;this._scene.layers.push(this);var s=this._scene.getEngine();var a=[];a.push(1,1);a.push(-1,1);a.push(-1,-1);a.push(1,-1);var u=new e.VertexBuffer(s,a,e.VertexBuffer.PositionKind,false,false,2);this._vertexBuffers[e.VertexBuffer.PositionKind]=u;this._createIndexBuffer();this._effect=s.createEffect("layer",[e.VertexBuffer.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],"");this._alphaTestEffect=s.createEffect("layer",[e.VertexBuffer.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],"#define ALPHATEST")}Object.defineProperty(t.prototype,"onDispose",{set:function(e){if(this._onDisposeObserver){this.onDisposeObservable.remove(this._onDisposeObserver)}this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"onBeforeRender",{set:function(e){if(this._onBeforeRenderObserver){this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver)}this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"onAfterRender",{set:function(e){if(this._onAfterRenderObserver){this.onAfterRenderObservable.remove(this._onAfterRenderObserver)}this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)},enumerable:true,configurable:true});t.prototype._createIndexBuffer=function(){var e=this._scene.getEngine();var t=[];t.push(0);t.push(1);t.push(2);t.push(0);t.push(2);t.push(3);this._indexBuffer=e.createIndexBuffer(t)};t.prototype._rebuild=function(){var t=this._vertexBuffers[e.VertexBuffer.PositionKind];if(t){t._rebuild()}this._createIndexBuffer()};t.prototype.render=function(){var t=this.alphaTest?this._alphaTestEffect:this._effect;if(!t.isReady()||!this.texture||!this.texture.isReady())return;var i=this._scene.getEngine();this.onBeforeRenderObservable.notifyObservers(this);i.enableEffect(t);i.setState(false);t.setTexture("textureSampler",this.texture);t.setMatrix("textureMatrix",this.texture.getTextureMatrix());t.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a);t.setVector2("offset",this.offset);t.setVector2("scale",this.scale);i.bindBuffers(this._vertexBuffers,this._indexBuffer,t);if(!this.alphaTest){i.setAlphaMode(this.alphaBlendingMode);i.drawElementsType(e.Material.TriangleFillMode,0,6);i.setAlphaMode(e.Engine.ALPHA_DISABLE)}else{i.drawElementsType(e.Material.TriangleFillMode,0,6)}this.onAfterRenderObservable.notifyObservers(this)};t.prototype.dispose=function(){var t=this._vertexBuffers[e.VertexBuffer.PositionKind];if(t){t.dispose();this._vertexBuffers[e.VertexBuffer.PositionKind]=null}if(this._indexBuffer){this._scene.getEngine()._releaseBuffer(this._indexBuffer);this._indexBuffer=null}if(this.texture){this.texture.dispose();this.texture=null}var i=this._scene.layers.indexOf(this);this._scene.layers.splice(i,1);this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onAfterRenderObservable.clear();this.onBeforeRenderObservable.clear()};return t}();e.Layer=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){}t.CreateResizedCopy=function(t,i,r,n){if(n===void 0){n=true}var o=t.getScene();var s=o.getEngine();var a=new e.RenderTargetTexture("resized"+t.name,{width:i,height:r},o,!t.noMipmap,true,t._texture.type,false,t._samplingMode,false);a.wrapU=t.wrapU;a.wrapV=t.wrapV;a.uOffset=t.uOffset;a.vOffset=t.vOffset;a.uScale=t.uScale;a.vScale=t.vScale;a.uAng=t.uAng;a.vAng=t.vAng;a.wAng=t.wAng;a.coordinatesIndex=t.coordinatesIndex;a.level=t.level;a.anisotropicFilteringLevel=t.anisotropicFilteringLevel;a._texture.isReady=false;t.wrapU=e.Texture.CLAMP_ADDRESSMODE;t.wrapV=e.Texture.CLAMP_ADDRESSMODE;var u=new e.PassPostProcess("pass",1,null,n?e.Texture.BILINEAR_SAMPLINGMODE:e.Texture.NEAREST_SAMPLINGMODE,s,false,e.Engine.TEXTURETYPE_UNSIGNED_INT);u.getEffect().executeWhenCompiled(function(){u.onApply=function(e){e.setTexture("textureSampler",t)};var e=a.getInternalTexture();if(e){o.postProcessManager.directRender([u],e);s.unBindFramebuffer(e);a.disposeFramebufferObjects();u.dispose();e.isReady=true}});return a};t.GetEnvironmentBRDFTexture=function(t){if(!t._environmentBRDFTexture){var i=e.Texture.CreateFromBase64String(this._environmentBRDFBase64Texture,"EnvironmentBRDFTexture",t,true,false,e.Texture.BILINEAR_SAMPLINGMODE);i.wrapU=e.Texture.CLAMP_ADDRESSMODE;i.wrapV=e.Texture.CLAMP_ADDRESSMODE;t._environmentBRDFTexture=i}return t._environmentBRDFTexture}
;t._environmentBRDFBase64Texture="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR4Xu19Z7PtTHbW1g3jMMbGmGDAZAMm5xxMLDAU0WSKWOQcCoqccw6eGdtgk4yNbZxnvvAL+Af8Af6AsQl+06ako9X36dXPSi3pnPu+cz/cOntL3S1pq5+w1mrpLs/eud9fvn27rf9evPPwFz+v22S7fGZ/n7/70G79J5/Xv/qzbLP+Pnvvoc/6Tz7jX/15/c62LfeH7fofbpfP3l/ct36Wf+u4+D37+XYb++G26LPsr/zFttnPuh37bm1bt0f7MvtlnOx4uv0H4fty8UUsz77rfn/57u32cgXvDv72eQf0tl0+G38b0Nf9K4Dl704MEfA16KsE8Gw9JgD+DQE8EA0DT2b7GwK4GHnF4a8iguXZt9/vL5/dbisJbEq/uwD5vIK/fbbAv4N9U/8nJIDNCazKvBLBGwdwu62OhajxmQSAx6gqNp5HCg9wPan2nwSNjhLD8ux/3u8vP3y7vbwDAYjtR8AzFyDqLu1Q+YEINnew23rPCYiKb+q/K7o4AVT4tg0t/h4ydJZfkQASQ/d5b9fZ/Z1ENmuPn/cwYCYEELBguKC3nRkCnE0AFOwOKCOAR/sH/L4hgFMpbSWP5dn/uN9ffs7t9mJ5cAHoBLTyszBAFJ/F/xIKdASw5wgaEWDMLySxAk4svf6L+4QAGPiJCziNAPb4f3UZ2dh/m+z7BK4SAPYrxf5FB6ABPgCUAfANAZwKyscc7IEA/vv9/uLzbreXzx9cQCMACAl00m8jAlF7ov6SCMQ8gJsMFFBnCECSg5H6TxJAU3vPAbwhgFfz9AABeOEDBcIbB3AqPzwQwH+731/8sNvt5Ydut5e3B2C/fG9P+jESgGz/RgxG9r9VAwTUUh0goQDafUz+DYnAnSha5l99Z1l/yQVswAZSGIAugNd/9xBgCw9E8aECkHUB22QPHIAVDlQdQAMWAibhBgZAasAVHUAI8Cqg96Tm0bj3VBS9jwd7IIBvuN9ffMHt9vLTbreXy+32QlwAhgMIeuNzKwOqCoB2Aa00KHE+EsIeDuj4H2N+Hf/TfAC6A4nhgQCQDDwiaKDXiq9KgBEJNPArAtCk0AEd2mpAizW3/lYIoANpBPg3BPA+hjs/9eXZV+0E8Bm32wsJA9aEoBCAuAABPiEAC/yDC4gSgRgKRHkAlgsI6v7iEFqJEMgBwb4BGkEfEEDnDlReoAP/SQRgOYIB+IYDMEE/SQBbXoLNr0jhq4qOZc0PHBSf5oKW519xvz//kbfby8+83V68ABfwniIBgwgQ/HoRUMv8w5qAoQqgk4DWQiCw+63eD8k/XAPQgK5s/5a5xzAAqgR6wY9k+ZEMtCOoJABb230hEHMFWQdgAl0Ap/+uc6tKBrrP/n0AuwfiNwTwNKguHHV5/qX3+/M1B/Ddb7cXax7g2e324vaQB3hhkMAW92tHoFb96cVAbimwkgQ0Vv7R+D8iACfuxzKfLvnNlAAjAsBwwP2MwLQAD9sbYJME0AFcg5uBPSAA0x0AobhtcDKDA0j3KYDhk7Hp8uKj9/vzH3C7vfget9uLT9nDgDUZuOYCLBJA8MNKPyGGIftPrL+4gy3eh5p/lwRUYYAs9Fn7tM/E9lvJwCH2DxJ/mPTr4nyyLiDtBgTAGCrgNuPzNuETgN+suEEAFhng9lkCoICMLH7V0isCeEMCxylrefkl9/uzz90J4NNUGLDmAnYXINUBrf5dCCAuQCcCvYVAYPk3G++VAveVfkIAFRLolgbr2F9ifP33pAqAV/fHRF4HcAS7AKlAAEIYFNwITOszs/wMsB6II4BXFZ0QwBsSOEYCDwTw2TsBfPrt9uLlqzCgcwFABI0EVCiANl8Uvq0JWNsi2JPZ/0YKsOiHxftsW4v51ZqAaBWgZf91PsBL/jFHwEqBR1cCiuJ3gAfCmCEA3cf8rmz8AMZHIoA3JDBPAsuHVgL4jNvt+UoCH34ggK0asIYBGArsAB7AD+reQgCl+GwZ8LaNlP3MEEDaSg4ACMGr/+ulwV4JsAEfLH42/vdKgWElAJ4QpBl+LAlKErHwt+oGMgTA2ngE4IUIOH3dGr/hAKT/m/UBdSJYPuVL7vflU26352sScCWAD+0EsCcDVxewKjfmAzAsENVn4EfgdySgnYB81yEAgL4RA8T8mTUASAAYBgylQAkL8K/+zL6rsl8qF6ArAeS7WRGoAB8Sf7isN/VZqTs6jQ5wXlweWfyqpQ8I4I0TmCCAT/3I/b48u92ef9bt9nwNAdZE4FoOFALYXcAGegkDMByAzzQEgJh+cAIs/legH0IA5QTCPADE+7ISkD0TgA/8sBIgLQfOgF/F9kPcr+J8fIYguyCILQRKgV4DNviOzoKqeJS0u4AA3pBAjQSWT//I/b5OmC0MWB3ASgBrGLA+IryvDNxCgRXo+wKhjgwk8bcTwUACsJ09ANRVAALwCxmEoFcrAUsuAJ4M1E8BDuHABAHomJ8RgACrZfQLyT9dBWi2OOEG9NJd/TDQ8HAQuBE97ZhjGKy6o+imnU+4gDckkCeB5cMfud/v6zr9Dz84gOdCAM/3JwQhF9CAD25gBWWz/8wNgMpj3K9Lfy0foMMBVffXyT4r+cceC9bvCcDFP0311QrATPkvWgosYQFLAuoqQEcQuw3v2si25F+M1RkZXLUU+CgBmCBOEsCbvECOBJbP+Oj9fv+u2+3Zp91uz9cy4Kfebs/3ROD6iPD2b10YJCXB+0PyrgsHdtBuRACfBeTN+uM+suJPSEDbfh3/oxPoHgwiC3/06j8Eutj69sAQqj++I0CUfvIpwCEvYCT90O4Pn1XsT5Ve1/+dcp9FBh3woqXBSEJkvjHHEOUPqJPAjUUCeOMGfCJYPvOj9/t7//d2e7YmAlcS2B3A8xcPYcBm/7ULEDIQew+5gS0EIEA31R8Uf6gAoBsgKwBd9ddvBBJAs6XARgLQXQ2o7T8+IETe+9eRACg7rhCMVgCiE8D4O9wOCb2ubOht1/vYd2ubzLlgKbBHEDSnAMfL6durVm8qBPwXWz7rY/f7/X/fbsvL2+3Zqv4QAjzfw4COAMAJbEC3wC8koBJ9lAhgxZ+4hi3Oh/f8dU8EqtV/JhHgWn9cC4CJQZXZp6GAk/1nawMkrrcqAiwPIIA2FwOB2oaAF5UkcX+GADBs0I5gsNbBQqCorJcFJjqWKvhNMjky0Aek7/LZH7vf3/vO2215vruAD91uz/dSYCOAPQzYkoD7vw34sFIQw4LNymNSUKk8Wv0hCYhkoJ74Q6BboO9eDKoWAHXvBiCvAdPZf4nt3QqA924AbfXV8t8uN4Bt2We029WkoErWpSoCSm11TM8AOYA5uRS4RAITIQDDavaYHxCcm5exfM7H7vd3v2N9McDt9uxDD//WKsAG/ue32/M1DEACuO3g1jkBsf57fqCL/7UbIISAio85AAG0VQEYiIC9DJTYfy/+Dx8HlpeDRK8G90IBHQbgWgD2WT8LoOJ7NyeA5JEkAwwxmuqzur5X6y+sBEwDMggrqoBNH7c68Puk/fI9Vwfwvx4e6H724oEA1iSg5AAaAewlweeyLmAnAHQCTfU1CTAH4GyTMt+QDMRFQFEYQB71lXUAOjHYlvTqh4N2xe5yASoh2PpaJUGDBDrLr9cGIDlY1l+vDlQOAQHckYMiA68KMFsGtOy65RCGsMIDT+QqJoD3yUwCy/f+6P3+7koAt50AXrwigM0FrIuEoBrwHMMAUhmQUKAlAwHo7VmAPURo9h/r//ozLv1V7/5v6wGMV4B3rwYPXEBqIZAQwp4TYDE+LQlqtQfw6my/LgsyZaeLg7wVgmDnWQ5AA5ZWCDRx7ECzyn3udgFptFCIgTlyFRMEUCKgA+O/jl2Xz/3o/f7Otz88QvpszQOsLmAPARoBSDVgud02AthdwPZ5BSxUBVr8L3kAVHrvs076KSLQi3/M9QCJ7H/G/rf4n8X41XIgcwHecuBMDgAe+BHA6uQgqnvbF5DB5hwUQM3vQgIWkKOVftH+gAC6cz0RXZ9MjmD5fh/ZCWCd1CsB7CSwhgArAUgIIC5AQoDOCewJwab+CH79WR4C0mQAZT4hEQS9DgfEztNkoEECDfi6FAhZflb6Q1XXqwHDEECpvZX4a0qP1l7bfAS98cQfzQUo9a4mASMC0CsIm6JGK/2i/QkCuFK9PxmIYPm8nQDu795uy3K7LTvwVyJAB7ARwJoAVLkA7QIkJ9A5AQS95Ad2YmgvAJWwQFcBpB38pUuB9wVKbAWgCXwV86Mz2ICKTwUWFgOxMEBicr0eoBwCGBUADfxsDsAiA+zflNay31ZcfnAdAAXgDGkcdAcfZCJYfuCX3O9vf/vtthHAmgcQF7ATwOoAtn9IACsRSDkQ/wqIIUGoXYEQQ/sL5IDJP539776DwodVAGlr5QBgP8sDdApP3gSUXQa8/rZsRaBeHmy+HwDyCI1MUNlZzX9iJSBO9igJGJYCo4RdIqMfJQ4Ztq8C7FXjHuSnQ92XH/yvdwJ4Z68ErOXAlQRW0O9/JRG42v9GBHsuAImAqv+uzDo30C3yAfVHoHeg9xyAp/7wlp+WFCSWv1sOTBb+0EoAZP5DImBrApAUMFHolQG19c+EAkbpjyUEdQ6gm/QEsCzZFxKDlWNwprJVWfBm/1WAvWrcQ0ie7Lz80H91v7/9v263+9sPI2zrAZAEdvXvXMBKBJIIFDcgyUAEvHICg/o7wA/Bvyt35wCc2F9Cg03RvRyAA34N8hD0xsIfXP7bQgDMFSgyYO8GsF4N/hQ5ALak1yUGRQDZZJ5VWXgKEsie8yQuH63b8vn/8oEA3lsJYJ2EQgD73xX4z9bs/74gaHMBQgA7+DsXAJWBBniHCLTtNx2AUnkG/LYNiUCpvX7wp6sIOHF/lwgkNf8UGagwYMgLMBdgLQCyVgOyciCGCs5nz/Jr8EXOQOcQZEbrfjjTU8qaCBseMyx4vxPB8iP+RU8A24Kg9R8Qgaj/av8lDBgcwApQ+QdVgW0bKr3+jsk//AztzBKgtv4K+Kj08rl7JFgt9BnCAIsQcD2AsQAolQj0CAGAqhOFCK5u3cA+84dyIJLCPm6buAgoBa5qDoDF6wzUkZ13iSDKKwTamSKZSf29cuzJUwq7LV/wz18RwH2Nl9dKABLArv6bC5B/+9OBGxmsIIR1AQ3w2gk4RECTfwBulgC0rP96/FYJUOv9SzkAB/xuKTBY/qsTgZ0LILF/s/RW9v81ywEwhbeAwUIH6hRwGp+wEOhqoF49fojqQoPlR/+z+/3t77jd3n3rdru999CzEYAQAYJfXACEAqL8W5lQgA5uoJUK9zxBB3ii9ALiYT2AjvuN72wFILP+XdlP8gLKFeg6f5QM3AC+VlMMZ9ABGuN+VePHWL6tHVD23or3tQPo2iWfBRgShDp0ELcBjmIAbwTWqEzIJvLM6kEDEFcD9erxCzg3my4/9p/e7299x+323lu32+oAtjwAhgE7Cazqv7mAvRLQcgG7A9B5AAwHus87CWBYsIKFfe+eCSBgt2J+7QBQ+VsogOU/9fIPBvLhASEF8AHwlhPQ2wVYFhmo/Wby74QyYLcmQAEbbbue2FcnAb28QTmHQKBwNVCvHv8IESw//h/f7299pyIA7QIE/LsTeIbqL59hPUADvHIBG8jBIWgn0L4rsKMj2Noomz8QgZELsCoAAnh0Caj8lup7ib9tX+ZBoKgUmFkWTGJ8S/UHZa/kAHT+QGaeoeQmMUC/CoAzVYAjYDvSNwPCq8fPnINus/zEfwQE8O7tdt8dwGZjIQQQ9Y9cwAB+RQIC4I4MdvvdLL+O//E7LgLykn6q3Efjf6X8bOUfkoNYcQZ8z/KzBUBYCqT/YQgjBuOBHxPs7JHh7JoAy/IzWz+xEtBKBEYg8fIGw+SeQQQ+CzHZP+oWXWPU/8z9y0/+h/f729/5kAN4791X/6/cpl4SCsDfLRQwHEBLCmJFYH92vssNgBPo7D8qv4CekIHpAjKgx1iffGbKb5UAQwdguIAtz2KsEWj7vIQggNON91lYoIFN2mznYKj9UBmwQgXLLcDstRTdBchEFWAWcLP9MgC9cuzM8aXN8lP//v3+9v/uCUDyAM0FIBFADqAjAsgFiAvYwK3/MfAL8InSd/Yfy37Qpyv3OSTgxf8C5vZXPfF3aB2AA3hJGg5LghMOgCUBo8SgEAyC3Irvh5xAwhW0cT1iQBKYWds/QQLdeVUQcrEjeGoiWH7633sggHfWJOAaAkglYL/wLQyQf3tYsCp9CwmgFIgOgIJ/JwMdBuB3cQTDX4z9wR2whN+WE9idh67761p/F/8bpb8O/OotQCsJDhZfji0qT9p0LsCI83X9H8E9KH8iCSiTrQO29bwAAbvlCipPAw4T/oRKQAVElbaMJ472t7jnqnEjrlt+1t+539/6P4oAxLquawIkF7Bb/40M9hAAHcD2GVzABmBYKSgxfyMGAbROCipl1w6gs/8ZF0Cy/UIOOr7vHAIu9iHP/2v77yX9ROUt29+AHVUCnDJgtvSn8wXsnQGzIUAW3F27qFS4z2CrD07wCogqbR8LtGecUwR4vX/5OX/7FQFsOYC9FCiToBGAEAH83ZwA5AM06BspiPKrNQIt/kcg69iffBegNqVXb/wdQgIMC0DltUuQ+L+Bmz0OrNTdK/91+4JVf15SEPMCYRkwEfc3stBxurMS0AoTMKRocaV8cKw6jpcFsdUn2/8qRT8buGeP55HC8vP+5v3+1v99cADvvfNQBZB4dO24Kv5GAntSUOz/+n1wAis4wAnoMAC/N9svSUKsBABgmwPAbQTwWzsW/2vAI6j14h+1CEjnBYZFQWSxj+sEVFyPjgBBrhf+aOtPY39vRaBVJlQ2vyOGIATQsb6etBguDMSQyAF4IMhUAmZANNNnUNSqBDvtzzif6HSWL/wbuwN4eycA4gDEBQgRYPzfSGC3/BYBdOCHxKBHBAJoAbdWfIz1I9XXsf5g9y0yAJB7iUDPCaC6e2EA2ngMGyIHwAgBldncf4ID0EDXVp1NYmbnrclOtyfDhiPOoCO4CEXB/rOBfOZ4yy/8a7sDAALY1gKAfWMEgOovoNdk0IArKr+7gwH02gWQ2L4t/sEEoLL2IQnoFX96HYC4CIz/jcSgAJSVAtu2RPZ/SPRBHkC7AkYEqceC2fqBfdKaCcHAAeAkpKVBCANcElBVgBQRTC4HngHOTJ+rQo2jhEbP6xf/VU4AmBza7L+EAZgLgGSgxP8dGQDwmQOQbS2xp6oEWAnQn1seIEMCJO4fsv8Q2w/JQU0IJMvPiCCT/NPuQP/noJ0rAFBa23VSr1N/vQhIgxzzB9odMMIAkGvFZPF6JkyIlJeFFl6IcRYYX0ciOOOcll/6l+/3t/7fngPYy4BSCmyT0SGAlgvY4/+BAET10fZjUhAWCg2AV8nBEPQ6D6DJgSUAoQ/G+Dr+T9l/pfg0HxAs/e3WBUhbsihIgHKkHGiGCQHYO/UHomDgdd0BcRkZlYtyAFlgZNtlzqkSJcwc1xr/6FjLL/tLPQG8t+YA3tuXBKPiqISgAB//bjZdkoNE/Rs5EAIYXIAKCwYHYJADlvhalp8RgS4PogNwFN8jgo1A2LoALxRw1gA09TbCAjckQHBZlQEFwEoS0Iv1S3mAYFGPlwOIJn+0v+ocPohEsHzRX9gJYM0BvPvwTyoB2gGsP6iEAowANsBJWAAVgRYeAPCb/WdkAKEAttNJwRbzM+UPQI8K36k9Kf3RagBTe2vhj3o8uAFXLxUGxTdXBrK1AIltTZ2JzUe7Lp/Ralvxvrb5kcWP9nv2fwBzIRF4FRFkx/XcwRljHCGm5Vf++fv9re+63d4xCABVRhOAJoOtRCguQKoCmghwv7L/mBPQwB/KfMQhCEF0ym8RAUkIToUAxrP/gxOwSoDGmn9WCjTzASw3kHQA5poA7Q4g3n+MEMAChiadiopXwHZV26usvB43e/7Lr/pznADakmBdDcB8AFj+5ggcF4AhgAlwwyUM6m+pPgF8U3BS6jOdAAkJ3HUAO5C7ZKBT99/IVDsGhwyY3e8qNfhCERXDa5BrlW/ftaoqe265Ar0U+PIQQCUzqwqYBYfnSK4AcuW8sjmHaMzl1/zZnQDeud3eXRcCrfH/ngNYbyxzAKL8nQNAMiC5gI0gBNz42XIBAnAkBACwqDyWByPlp2BPWP7WD0Crs/5ewq+1JaBnWX8rEajbDiVAlbNpwHRyAJ4D6EqECQcQWfxo/0wI4E3wcPJnUbSLXqH5A26qHaD9kb7ssKaj+nV/ZiSALRG4rwhsJLBfUKt/k3yAJMGwEtCFBGD/PTIY4n6d8ANyaEk/Q/nPUv8h+WeRgXYCVgIwSwbK3osKi4PonEGUC2C2Pngc2LL73Xanlj9bBTg7BIgAFe2vuoxZS14B7wy/DCT8xX/qfn/rrYccwLtrElA7AJkgkrDSJUHJfO/Z/wZ4Kx8g4IXyYKfm0i9QfkoSJK5HghALr51Ce2Jwv0ad9BvAj1WCidKfZf1x3UDnvPQ90HYf7o1WfSQMGbOpU1D3H6oCynpjPE7VfSccpoalMEHNdAxFKkDLgDzTRo5ZaXukz1E34f1Gy2/8kzEB6MUlsjCoCwWMEAAdgOcGTECrnECn+JYTgPyABn0U82vwt7hfJft0rK9DAlHooTSolH94GxBUAnTSL/reAbz6UBADt344SDkIJBIT5E62HgnEAwgFmjq3ChFkAJUFd7Zd9fwsdZ89nnX85Tf/8Z0A1hwAOgDJAxBbuU1usboYCoiCKvWX+L/lAUDlNUG0bD8Bt7dviP9Vf0v9LbV3XQCz/3qbZf2d0h8D+JAPYDb/RAfArL1l92W7Z/OjEICpOZvkw7bES0EisET7M0RxRNkzx78qJGj37rf+MUUA+zoAnQjs1gTAhJNyFy4X7kBtkYHKB0ifDMgrLiADfJMESGa/Cwe0/a+CHsmA5QQ8N6ByAzJZh1IhEobOAegsvwaVDhEKDkCre0cielYbau4SQfIZggyIM0DMtMkc6ywnMHMsduzlt/+R+/2tt2+3d8QBiAtQSUBaEVDxPyYB22cEuiYDQgJtLUFk7539ke1vgAeAR05gC3ekbAclwuaEjEVA3XoAAnLpT6sBCuStrUrIpqsBHhkwcBOVTecFJAteCAFSyk/GzapwBOJofwV0mbEQkNX2p/X9HX9IEcB7eyLw3q8IlPgSbV/LBThEIMreQJkhAeYOIsDrsELV8VmIgHX9ITGo1L+BnxGB5wQY6IvKLzZZCKD7nsj8m+sADjoAVHk9ga19tF1CzSk5GO8T9MCUAdpZbSqEUW17lpNYfucfvN/fBgfwLlQBcEnwdkA9cdGiCjCgGrCpZhACDMSA6wL28dewgKl6GzuI963EXwtf1Nr/wQ0YMb+bCJwAPgKc5gPIPeiImeUC4B5J2zbZnGXBQjI4Mdk2HFNPYqv9MNlJCJByAzPPEezIiUAe7a8ANjPWGYpePc52Db/799/vb7/zKgQQAnhvDwH0cwFWLqBluwkRYJ7AqgoMTiHjApTqR9ZfbLxbCbCUX1wOKQGiO8ASn7XdKgMimL2SoG4nkxGVnqk+OoeBDHR4AN87EmCWnlULBGiBuiNJMFC5RJB8HsACRgYwZ7WpEEY2pNEuYOoYv/f37Q7g3dvtnT3+39YC6BBAv3IK1wVA9p8SAYC5gRDBqz53QDasvag/dQboGMCy0zBA7e/CgoTyszX/VeA35QeH1YGc2Hwr2YchGn5mJNGVd8FdoEOIHEBo9VkeQc3cqFJgEkPhxSBHwoIMCVTAlx1vlggq4y+/7/fe72+tDuDdV2XARgD7isDtd95BpZWjKRUov4Acwa6BT5OEsEjICg1aBUAl8DpwA2kgQeCYbHsjL0zygfKbll9XC5xk3zYGgM1yA0IKERGgI2PJQJ20M13CAQfgWv1kEjBj+Yc2zlqAGdWPgBPtrwI2O16FXMrn8Ad+z04AaxVgTwDiasAtBNgnrK4E6HBgSApichCBBHkBCnQNbmb1iTPoSEXlDXCfTv6x0EAA2OUDtCPA70bMT6sAXjVAlf4sIhieC8BYXy0CYk5gIPKCA8CJGzoAI5QYJqoRzx8NAZ6KCLLgzra7igSWP/i79hzA6gCAAMQFrBMNSUCrFypUm+x78k/cQRffY45AqatOGDJy0CDHkh5dDERielFhWvrTIYHO+icy/jK+qe6sCkCAH70erLsXylXMWv5GFowQrLyACISU6HZ0W+RALX0Qz2ug4NgYUWScRNQ+q6IZ8GbaVMCdHS99jX/4dwIBCAmsoNd5AHAB1sRDArByAV1YgLkBnfRDF6AtPbP4LNY32lkOgMX/tPynSKFzC466Y2JP+mT+mk8BOiVAVP2MA9COgH4nQGcgHxyCAe5uMicqARTcJ+QBIlB5+6O+V4E7c9wMCSx/9HfkCEDyAMPDJiQZ2AABqtZUVwG7s+ZWMlCDO/F9iPFZso9l/IkDaMRgxPqe4g8JQa30yg14pdaM7TddgWHxXcUPVgLqvnqyWw6AqrlT0jPV33AekYJb4IlAdfX+6LwR0BVi8Yhg+WO//X5/e68AyLMAawlwCAEwF2BkpTfgqwlu5QU6G45KrdYNsNi9qwAQMgjBnyEDI77XYGcxfjXut1wAhlfSptsGoNHJPab6XkLwTAeAk1MIidp+mJlRJYCqPxCABwizr0aUDl3I/ogEMsDMjJEZp0oYjECWP/HbSA4ACEDWAbA8gJ6MjADWbYP6i5LqvyRROBBABHgjXEAV14k963s7d0koOkm/s+J+FiaERADqbjkAHKNNrsRCoE7lmYsQ0HjlPm+dgMzKRLmQkkgyBJhR/SPWPwPyTJuriWD5U78FHMB7eyJQ5QDaYiBhXL0mgGWumRNQAO/KbieTASMOL8bvVgUSq2/lAvAaOvDiwiEjs6/BThdZ6bUBJNvfuQN0Z+pzVzI09nXqrT3UMRMAACAASURBVJcKg+J6xKAnLao7Tvruc6ZcyBS6EDpUXUIEvgyAz2oTnQuqe+aYzT386d98v69rALZ1AEIAazVgz/4zBzC8aorlAdS2rkIgC4e8v2TxkOsGMLeA45I6vgZ7ygFg4g8JQhOdl+FPZv+ZnRey0CQhE4PtH1TfCBmkXQd+S+1ZXkCTiQZq0gG4sb6qMHSAKFYQHpsIMoDMtKla/syYy5/9Tb0DWGP/7R8QgOUA2NtnzEw3LhRS6hjlA9CK6/gfS4XU5rOk427p9bg02cfATtS9CwGcSsB6/taTf9Zvx0ItvQ2JgH7WgEYyMMA+5AwmHMBMDsAjAhrPTz5M9H4mggy4M65g+XO/YSeAXf1lLYAsBca/24D7MwKdakBIYOUBxKYyJ0BDAeIOTOW2QI75AgVkXNVH7b+VBFTgDisAQda/gd5LrCrlZpa/WXJrEVBk+cGxNWAkqwDMQWiFNq2/zNKgDOi6A2NFICULRAV8rrSN7HgEzmh/NH4G2MZlDi8qXf78Fz8QgNj/thjIcADtvw9HNcgQwGxIwPIGLHTQVj8BfszWmzkAlZsQwFrlPbcCYOUCjBwKKwl6pUBRWyFhukxY7LmO7414X8f61BVY4YLY9iDBhy6BTX6LPJCoPHtcAXelbQRUD+gZEojGZyCvjrv8hV/fOwArBGBLgnFpcGdJYUJ0gNknxLDNCwm8xKEV6xtqPwt4DWpm92kIQICN7bSNF2Xv/pLfUgNd5wxoCEAA34GbqL0VAmhSuMIBuIqv8wGJRUQWmCzAfNIQwV/8tff7O+9BEhBKgEMiUIUAXjLQinMbAAAcCIruFWMVgBPFX28iLhW2Yvzu+JCo06A21wAQm69XRVJwk+RpaiEQCxeQKEDlaWhgtEWQWEqvt7vhwoQDKAFfjR+5hytdgjf20X1HLH/kIpa//GtUCLATgE4CogOQz628IwzslKx0gosuG1bWnuUGotJhyzUYYUIjBSsnoJKVXZnPCAeYo3EBH1UDDIA38CniiBR/CA1I1r5VEQBUg/1XVt8jjG7iWZUD5WEz5UIK8sRagIhYquQQgfqI/a/aeBYKZMOD5a/86r0MCGsApAqQcQDbgTQBMNuqJ70GE/nuOgMSGjDFj7ZZhNABnxBTIxon459Vfa9yYpUEEfRU5RXounEUkJEgGJlEYNb9O2IQ16hsO07y9nk2ETjzJKG4JIKUSlgQKqyDzgzQM22ic/AcxPLXflXSAew30no8eDsJvBGWyhmJsKojQOAOi3R0yRFtPcvuqxo/tf7qeryYv2T/mZqT0IARgfzmG9Eg6erP8Jvr+4Tk4Sk6IwnWfgA/IxsCPhmfKWuk3ugcqENIgLwC+hl1j4Ac7c+CPDNOd4/++q/ccwCRA1iFHkqAtBrA3ICh/J46Yp7AjM+DHIK27t1aA0YIbKGPIisrw59NAOqSH/0NEKyMCBS4qwnAtNpnk4JGnN8pfKYKoIgiA2R2DEYglW1XE8FZQI6AHu1vv8nf+BUPBNDKgFYOgDkAsHdmQhAnkhP74kNDg72OwgMP0CRuN90GW+CTdCwWoVluQKv3EAYQ1cZjuOpv9JXJNyT49KIgliMwlByVu7kJUFwvPBjcQuaxYSuUOBAGZMjGIxEP1BEQn3z/3/oi4gA0CQD4uxAACMBLCKLNjFSPJd3Q7rtJOWu1oZNcHMgmE+8H5T3P3Xj7OlCzCgEeN+sEVDs8Rpu4Ol9ggd1ScuYWkAQIsDv1lrYqB+BZ/2FfsBqQAe3sbZG6Xwn2aGzr3Ja//cuJA8CnAXfr314SajgBkwBwAs6EAwmwWWFChThY0s8iI297B3DDPYRtCLi3Psb2AdRAHrKvqb9BCEyNtaKXS4OkoqAnomXjKUEo9e/GSjqAs0HvAS8C5WzfaNwKES1/95cZDmAlAbIacPudIRcgi4H0oqBuUirgU6WDSVtJsHnJw8gtZNyGWeJLEJNn61vZzYjzo/3dQ0Ea1DgmUXMWAqTAbil9UOaLynttQj+iAzibCCLQRfstUM+ShJiqqP/y937p7gDuex5gBz5bByD23woDMA9ACeCAG8jkCLTis+8ZUhjCAisZOKvwySw/OoWONFWMrmv4ZsWAqX+wrXMGbLkwnMvgIowEIWuHTsV1CTKz978WeViA88IKDzRnA/Ts8TyCcUng7/+SngC2twFZJLBPljIB4IQ1wgA9waPM+rCfJApN9Tae1beOGZ1LO06CEKj7UbF9A7CVB7AShIa9R3Uf1gOwhF9V6S1iEEQFDqFN3my14IJEYNYRTANNERd+PZMMIsXXp7H8g198v68VgHf2uP9dBX5xAtvbgaUUqEqCg/1HKweAlx9vsLeGIlqxchWojCyqY1RCgXK5jxGHofIsD9B+V92nSAgIxCEkgLEGBU8mAaO4PgoVmEJbOQQG1CzIs+08Msg6kAwRzJBOlgiWf/SLRgewksCq8l0YAKBveQAgBGb/t4vDhJQmAwf4a9dQeZPWnJbiHMfgOYeNlAKlx3BFOxs3L6B+LySS8EUg6rzwuEgQ3luBGugDqx/lCzyCGPbtCBBi05M9Io2OFB4hEXgmGLMgzZDEjIvYruUf/0I7BGgkAJWAbY46SUArGThMyAIZVADH2ppEkiCBir2n5xmpu5ME1I5pUH+LYEnFICKEDpiFEADPSSu0JhQX/MphTBFBIYnI3MRjgLviLs48H9OR/JNf4IcAK9bxPwoV9TerAXgj4T0BOJk9MhAQDZOfACUCNgIy0zbTJpPZpyGAQwTiKug7AYkr0L+N991Vf00gpGyHINbK3yZVMQQwVT2xEMh1BEZ/Nvk1EKsKmgXyGeOeTQQdEf/TL3wggNX2b/H//jqwLRGo1gC0HMCeD9AlQPw+WDqZJEZIoCdaNY6OgOmFAVq5u7ae3Y9AHam7sd8kApUsZHaekclAvrv86eoBcwkZkFvrA1hf1wU4Cu4Btu1T/c8G/hWgrxDEmSFDc0D//OdDCEAqADoPIMnA7a8wrv6LpSEFfJlkoQtAdfKShEmAWlUDN7xgOYYE6DPuBY+Lv0W0HRXdK/cN2X6l0jqcsICubbx2AVeFAK7Sy+zV1YDiasAjgH6MvqZth+vXH6sksfyLn/eKAFaw6yoA5gEE9FYScDsZZfsR8CwhSJNb2Tq5UVLsQO0lE5Pk4bqRiBDU/oEcHFVn9X1T4dFZ6TKhYfWZcltqbm6HsZm6D07QKuGRcqQGgEUKSF5N2QySYPutbZkw4SmJwCIIJIXIYSz/8uf2BEDXAWAosN/w7gUhAHwhge7GY2wGBKFtf5oMGKgcl1Cx/wKwKKQY2hWB3oHbqver7ab6J8t/2L9VbaR6sM8auk4gArlRNbBchQnSaBw5RyV7lRCAgSYCerS/otRZwqiMmSECc7x/9XNUDkCvAyB5AAwDtrlBQgG8KegCOsvolQgrgPKcQKTQSReBhOCquBP3a8LTToXF/vpY8ls2J6AdBFH/rNJfov4YDoL6UzVP5gDc8MBJBFbBnwHrWW08EEcqrvhw+5oNBZZ//bMLBCDqb7kAcAJtUQeyOuQDcGIPnzFeJQClSbJqngBULW3xIzKpkBYe3wGxkISn/u5zASwccLbh5NHhht43ELsFcGeFXwfmA1UAdBsZ9YxU/ej+zDkwJ+RtO5Mkmhh9yc+637cKwJ79lxyAlP/kKcC1IqBzAJgL0K4AQwC0m7hgyAsBrAVEaL0HJU6SQKeiyT6dWictOwsTsqW+9ttosAax/pA3AKJBEqEhQLX+T+J2PG9GEIxEPPC6ag/SNzhOtm/fZo3JABYpfLT/KBFU+leUvxHNR37mSAAC/lYBUDkA76EgIYWOAHASKnXHm4/hwaB8pIxIV8oFFpxlziNws/0diSgF91bwuQQmE7QQ+2fUvwO+pf7KkXRA9db6W6QB1+KCHu1qMgTQE70DoTOG24/Y5qMuIEMOFYBXQ4FM++WjP2MnAFUClGTg5gCEAMhy4M4F7JNou/eZ0qBWELD7qO6D0uNkZXmEwKqb4HXI4wzAa8ejLTYSjb5mfXz8jgCvlP86YrhC/ZH4lfpSFU4SgAfMo88TZFxAlRgyY1aI4Iy2zQF87KfbBLCVAAP199YCaBJAV9AlnAxX0NqwnIBSrHSSziAPa/VeJt/ACMp0AY6l1+CNvofqb6h6NikoJMMUHN2apayZNt3YxRwAPa6Tb2iTXj4cVP2MwkdkUQFz5njsGt1tX/rTHghArwHY7P++DBhdwDanYCWgzgPIfh2TtfUB+6QcJhcBedfGUXoGwAaOyXhdKy4rC1rxPAtlymqfjP0x5h6ArVSdARJdiQa6BWC8t3h8RhQ616AnY+cEigRQdREWUZ1NDBnFz4I5Y+OroMf2y5f9VE4ACH50AS4B7OD28gDtxyEVgW6yOIQwWGlg/Uz8bQLXcBoa/AM56Dq8FcMbCTyx/o3ISF3fsvaMWPRv7JLEPht08nC4TyTDb5UNI1VnwO3coaHQFPBKxa0QwAO/G1LAucwA+2oHkDkny2Vs27/8pygCANUXF9D+h2CdC1CA334rcQf7Z7yxsp8qiFpBOKhPQAiW6jIlN9UdzllAKQBjdtxT9eF8HJLQ5xNae6Lska1nSu+pfyMjb3GOlxwEYrHANwA6sO/abdBxyRiPAf4ZoGf6WOA9y0Es/+YnAwHs4JfsP4v/JSEoTgD/is1veYFZEsB+xAp7gDEX0yRU2asQaHX2wD8QjEEsCDKt0pZqM2LpSqaiiNpteCW7mQSgukc4UTWxsH0Z8EaKT/erRGIW/E/pAo6AOdt35+Pxvwf/t0gA8BKQFfzZMiDmAYakoJ4oUB2gE4UtHDLiYQSa9bnsDEhJj4HfdBYHF/V4Vn8gvh3sh9Rfk60ot7c9Uf+Xc80AkDnCNGng+RrnzCa/RS6Z8zXBJDv0ORnf9bHY96Pbov7LV/ykMQfQrQMgVQABvP67//60BKgXA7UTU9Z/mDgk+TeAndjrBtpCBcEF9Wz23on7j1p9TW74mzaH4jgC/Vtri20uDdakzvIDbTL0y1I9Gx+V8CJHgNeTBfIMEXhjz5LDU5HB8pU/ccwByBOAXQ6AxP9sQVBL5EJGF8uByPYDCehJE1UGAuB7JKD3MadA22iFx9DCiPPpeZAFOZWyH46Jk2cDPiZFRX1IvI7XrMdg2fsOvCRsYGMM25QadgC8KAeQIg5BblAajOL26v5Z4DPrb6m95wKWf/cTxhwAPgJskQAu/aUhAIB5+22J9aelQa0uOuFFQoRBCY2Soc4PNBDBMQVAGJ50amqVI8kYOH4F3FTZsyU9EvuLMs4q/NBP3SNT1Y2FPQyQcs0RYYT7JxYTZQgiAmoE/Ki/8E80DgO+RQYe8Nvx/v2P3wng9updALgAyEoEYrY/ejS4katyBegG2OfOEqpSX7s4K0QohgVUpSft+5VgR7BFsb/nEkxScByD/s31pB2IIOMSIETRE9YLF0wiOGMtwcUu4EoyyIAe79uyEsDwIhAsBSrrT6sAuyJ0i4KU6p9CAkpl9boBNuHT7iCw9vThJBJfe8erKrt2IZZjoWSIcTkLCTwVt6oC6nojwLKYvuoWIsUf1DsZRljn7m3PAPcMBY/GqIK8YU/IHTYs/+HHKQLYAd+tBCQkMIQA7L0AQAxo8bbjI1MXPiOIqMJNOgIEly4HmvsUIaUA7oQ0tD/LuBsAzTqC7XosUnAy/MwBZADtKTl1fjhB2aT19j9RCHAGOWTGyII/Gyos//HHAgEo5c8kAbv4X6m+lRDEmy73EtViSEA5pcFOIVTSMHIEAgTLVuvVceXVeFWwO3F+ByIW5zuxv1ZRRqL6d2TK64E1Y/9dIiDWfVB3veqPEcEThAARcDNgPKtNdC6Dw/lPP+Z+fxcWAOHbgM2FQKDsQ/wP+7TSo+qzsiAqk1apLmGoVUor4kTpcCCDALzZen1EQpbNp+QEjgNdiZWxN8t4pCKQUXeLOChZOFacEoFxTmzsYRIjEZwQAnjjRwCL7Hu0PxofLnVc1IM7gzxGE96vWgkAHwUWF8AWAuGDQOyhIAQ/KwPu+9t5KmVvJwXtMHSgE9BQfU0g7oMy2g4byb9ZMFtkwUCMhNDtJ2VDDVoNLBoSEBLpQBYB18kPpElkv9HM1XRzwFB85gzw2BaArX4uoRRAFYG7up+RQYYgKm5i+aof/RACiPK39wAAEbB3ArSq3v4Bl//qpcAa8Nt3QhAM7N0FE7DTSWc4goEUAAwm8Ky1CNYCG69syWr/BJBWLkArvWflL1H/iDwE2I6dH0hKJkeyYtCRFYCThSdZYLuEwo6hCGwGlE9FBsNx//OP2gkAwwBJBBoVgK4SsE8KyQWwuJ8RAoIdCQJvpMXqVnlQA3z4TpRdjsHA1IEo6hss7JFzQQDQYwaE0AHAUmMrSWgAmJKomuRH7D8DmOVWGMAjgHb7T8oBeORR2XcFOcyMyfps2776C/ocwPr7df8rkEMC23xS/0uQLgVm3IBOAHYni1ldneHVcSMJKdbJEYYOQU7BDR+M8VMZeQZUY1tHVNYxlQJnQgJNKNbk9tzGAFovx0CWDXurDkPF1+MVcgBZhzDbbgaoVWdQsftNaIHcNwLQIYCQgCh9SwaC2jfgQ/lPg92qAnQnokIB6gCUcrlVAqNsZqqco+xMtTM2/FTwVxyBofAsvGGgNe25UxqskgxV+ETIkCaCAgFEzkLmqdXuqZ1ARBam6gMAl6/5kSoEUPYfwa/fBNSeBQBi2MZW7wRox8skBgnYTUfgKLeA11O4KDk3gJ0pWzI00BOYxuhOeU9fhwXWqdg/Io7MfuJKKNhBfRrAJisAFJgH1wF4oPYAF4HxyP6oLwN6xhls/f7Lj7jf5dHf9hdeBNoRgJH5L4UB+2TSpBDmBADsCG5U9izYq+Sg25uKqqsJhnJ64JdrcC13Mfan14tAdDL76MhM0qmOFdh2fRxGJBZQoycKI7BkQZ5tFx0v2h+BPw30BrhXH7bweCOA/eWf+kUgFvjxKcChGqAAbuYADCLQ4N5O14j9I/DjftcGe1UDpn7Ogh2LhCrHfyzw098Hwews/aVkkMzkD8qd7JciggNJQItUjoC0CuAjxMLOMzz3r/3h4ADgLcDM+ktOwKwC4HJg9ZmV/RoXWaGBUv1TiYABO8ofWLHwRDLPBd8JCn8quLMWPeMkiPozK5/dNpBCkAPIgnwWiLP9QqAqBc8of6rN1/3wh4VA8gRg9AxARwI7iFgJUCcAKwlBFg50lQIdDoCbMC1rpYKQrBygW+kUMcjkR+CsxvHus/sReCPQRvsR0A74rPCBnXtK6ZVTsdzgYwK+ovaVthE5zCi/8MnydZ+vQgC1AIiFARveINHnJQMbNlHlAbDbiTj7NBmUiYCoNqsiDBNUT+YjoHaSh3Lz3BDBcivedkaSjvqa8X2ypBe+QEQBVl9vBHrmCCi4H7EKcJban00GFcJYvv6H9UlA+i4AXAuAZT/1WWf/LdXv8G6VAQkxlMHPMsJFJ3CJylugstTaU2FPdT3wZpQ9UZ4LiYvU/TswJ1xDRsWZ88v0a0oIFjtDNt7YEQCPEEc0dnX/AwGQ2P9oDkDCAvld9XdP9dEV4I3tbpaenMZ3V2lIn0yCSlv0wyTh1Nkz9p6ppxVGoFU2VV/UOqn+6NKiMbtzdQgmcgRv1P/hJlXdw/C7/dcfajsAifeFDESU27MB+wa5jzoUaOB3LD4SA4v9NVF4LgAnd3ehgeozAHugHianEx6wCR+FG2YeA294whVQYtjvWQRUMw9BlDIkG7b6j4VmVrusOp9s/y0ncJX6R+POAD4kiI0A4L8BQ+Uf3gfg2H/2MBBTfdP+C7vAzdaPAFfIwLSERHVoIoqUBjNKm3EDGVIwx8kAOFLuaL86hkkkxcU/jDgrSh8CUhG9B6iMzc+0iUB7xO6H4EWszLqBb/ghJARgTwKytwI7OYAhBHBcQDYckOtlTmFYABIA3XILbCEJ3QaE1ampsRItHTbsF+mqqpUryCzZzYA/QzJJN+ICPLFqLwPCI/F/aXy5N4YjiRT6akB7BGmd2/INP/ghBGjJPwL+1QnIfGf2X8CuQ4GGEZXoO9UFEOdwhAxYDiCtXE79ngKh2t7LFWTAHwAbSTEKEby2kaqznEHUJ6XmCUJJjaPUdFbFK4CvtI2IprJ/+caVAHQSkD0ObL0MxCgJbnNNqb7+XlX+KATYLlwdky4NZVaRxY/ZcMGLZwNHkCaXCPwZ1bbOBZXNyS0wkJruSKmll1w9CsrHdACzZOBdYwWwYj7CcAhcijf+8o0/KHYAkgzs/u4Trqm+/g7gKYUDRNG7F4jKhTlAbz+SbgNjdz+g0S5yA0wFO5AQAnHVzwOoZ/vPAn8yMeclKSMlPwOspm1nhO2oeRZEM+0qgH8q9d/O8ZtWAig4AMGQuRDIWQ48JAUBkO3eRcDWuQSi+pETQOBSdpxQ/kjJI7IYljkrVXaBlajpZxbqeGrOQEDzGqA8OoywfvdqHP5+IICznEKFSDJOYhjvm35g0QEkFwIh2Bm4w3AgcAJ6MrV5R+y9BpcmCFQl+oOz8MByE0qNu/EK4UDkJBihWHF7Bvz4m5jAJct+I8Wn+6+I1a8YE0k4+OwBtaLwlbYZwIfjrQQwrP4jK/82+6+2y8q/IQmolR2SiNvvqFUc3x/A9jOwESfAgB6BnxGJFR6E9tWbhJ499ey9FUbIhDT6ejadAjwKMbSVtkgxY7kvAOuZjwFn1fvq0CACeAhucGPycejzzT9gdABYERheCLqDUQhh+0qeC2iYNcBvWf4wMWgQhE7+CdHoC04TAlFy0zkY6+41udAJkyANar8JKVIHEBFEspYfOZLIxofkmSEOr82B+H9WvWcIoALaStuILNj+bdtKAF4JUKu+uQpQx/5AFKj6NBwQeiLOYCCxKEegCELb++GHcCoCA2taYHXU0IrtXTJhjsd5kKcDpziDBEEgQZkkg+MBWVigiYjA/T3gZofjGI4kC+azwTszXgTaqwlgHX/5ls97tRRYVL2tADRCgUH1yYKgDofE4nc4VqDG/EGbE0ZiziMIF/yGYlCHYJEKKzviJLaOEWTbQ5CQpN9AAhcoP5JWGaBA8lmyKYHZI+FgldwMeLNhgncNlX0RWczufyAAWQqcjP2tCgACV+Z+t0RYAUmIpAOxEdtHTmDbTybBsHaAnIMmiuHmatcBk9m8iexcEgrqVgP2c6cxvFL+LMii2HkYJ5Er8H6TaeL4ANj/CKSPofiIowcH8P23COBGnwHQhOBVALxHg1l4kCED0mbIEVjqTIhk+4GT26dJIXAF0yGBQR4U6MR5ZNsNTkIRS0mVsa8ir+o4LnF4ZKvPYXKV3xWK/1o4gG/9/ioJKC8E9dyAAXaM75sDANDp+N8LA7p3CyjF1Y5B3xxKEsZ6AVo5SIDYZHMvGRUlqqLseLCSbzunpBVGMsy6hTA0icAWXf9sIjC45irZyPzKuJUjIH4KxR8cwLd+v50A1PMAmOzTnwXTYvkld7Bth5uM+9uBo3yAodKR8uP4HUEQ5dFtGYEM25QCDwQQqVAEzAgcQdx/JvipC4jICX50Cpxk/wzoorCkAsrM8WbHM0WCEGXU9qr9y0oAWwiglH8LCYz1/w3wqvznqr5BDhqsUwuEqg5BkUwHdgOI2yGsx02tHIHcaGd/pMQIbArMRF7hCGAwFMqAxWwTEdys+sO9zJzfjBuoKPVVba8lgGISsFsApElivyE45wdXADdNhwUdlkm8nnYCCeWXY+l439tecgvG5OxuZqSMjnPoJnwWYJETYUoenWOkaBP9M2C2yDML8my72fg/Am2FLKKxZvZvfb7t+77KAWxOwEj8NXUHp7DNb3QBCvwSAnSCq0MAQhiitugOcCzcbsX71qrAri9OXEY21nMGHUu9GnG4oQVncMg2Z8FPSDEFNMcVHemf6ssIidw3a6wsyM9oVwXhUQLwznkQMVIKbQRAV/45RKDJoAHcIQMhiwjUQwjQscer3hYh0BWBxhhCNCzej/ZZx9FuIsolHLbMFUWfAXIUviAY2ecKOUVjMTIoXH8EmAwhRSA/Cuoj/c255pHot33uQw6A5QFku5cLQGAjMSDmLCcw4BImixUaCDCZkntuwGtPCcABCx6nHBJkVDg7qSuvwEoAcQDIBPi9MTIAKyt59rcKyGWWHCr9IvJ4kv2NAII8gIC1Wwqs1wUAoi0yEABrx82UP+sGziCFDsgkHLDyBN1N80gjqCLg+CkQJOPqdn4BUOhEniENVJtE/2x8TduRa/IAmT1WBMSzxomO8yj7P/65r1YCotIPn0m8j28BFpVvwGdkoCRf2/gOd1k3MNgImIEEyBZZYEKJugVrHYEoi3EsTSzu5HEIZCCFyuQPnMIl4If7kgVMtt0hUkOCMj5XgVex7VM2XU3IlEAQxyPDdP0//n3GlYAh+FWs370OXBbbqWSfblNxAlbbsuUPyMLLBeA9YLafTZruB8+AO2vps+32650Flqem4b4T1d881oyreWICqJLL1e2XjQDkjUDkmX+d5WffEVeWE0CBNJU/qfq6f0eQBdVv/Qw1tdyCBWzGsDJGqBIZgiCAzjqK0kQ6A1hnjOGBNUEwIUmd5AAqxyndB0PFw7nkOAY9R5ePf+9XSUBGBAJudAVt234Ttn37xi4ESGyTE0rnAIBtBqwfAD/+Zl68r8nGdA3RykEsy2TtfJYkKsfWk+wM4GavJwnA2fj/CDCPgqzSPwoLov1HSOUVAeBKwGgtgJH80+AfbL8OC9A66Od0gFy0UiuCa+Sjt0cKboYQRGmHsR0w4vmGE0GRltk+AapuIlTbG9dcDh8mxpkCauL6wt/eUcojfY8AUiv0Wd+tc3ogAA/8xsKfDuykTVP2/YO1GlCLNnUCiii0Cpu7LUfgjUf2WTG/JgXLORwFtbkE2VLQRNKPTgiHjNKASBw7PZZ2J0Vnc+Q4ugsk6gAAG0BJREFUVVKKQH/muZxKCp/4Xv3DQGLn0fI3sEerAPVTghAaaFyllgcDi1Asq43t6yzwI2IIKgHiOFKWjZyjZ3XZBMuAOJqYbTJVwwuDfIb/l8FR2cy5VX6Ts0HmZdunz90i7eClJZnjZdoMv1EjAMcFbLiYAT+x8TpX0DCeAHPXxAA5XTug7YiW7on9NPYPwgLtEEKiSNjcTg2y4YSehCeBv+xUZid98ne5khCmwHaQDGeOGfVZVgKwqgAiiBH4U2XAfTCco1qxNcAZxiOAm+J/kSvwEoYU4Anl325ath0hr5BYNPDYq9Sr4LzY+reJfBZZVa/vhPYRGGf2Z/p4bZZPfM++CmCFAF4YIETR/upnApw3AqUJAQ4ShQPD/ovA3wjdANDwwxvKZbVjN45uSwI427eqnIywpsbIKOT7iAAy4Ix+p5kxMn2kzSsCCKoA+AiwJoOOAJTtF8vPSAK3NSFLhAJdPwLuTKiwHc8jhsx+1YaGBSRxJdeadQgWETBVTJNG0mVEE3TbXww9yg6lmPzL/gapawNSitpXgIdcF40783tlzmUd94EAEiVAuc8m+HWOoCH61fxAy19R/mplAElHicqrryeD3wM1fVkpm1gBkOgxHEV0gZA4VnpiFlQ5MzHNNoXjpM+9APBozKuI59BvpgAwJgE/B0KA6CWgrP7vZP4bWcBJZJYEI1FYQuzlAtw8gTFg2jXs12I+diz7gQA9tu/2GaRkOQvrfYapiZgNR6znyMn1zQCkpG7GOZfG0PenQAAZIM6cS2bcq9osnxAC0C6AgH14+Ie9EIQQwoY5FRo0HAbbKY5In3Yf2QtHEGVWiGEAVhHow1cHPHgeJnAZqAIll3GrSUdKBkdyBmQF41WTsxv3LMK6mAAe5bdwSKt6/AcCMEIAmevrbz88A7Dv1CofVQQ66w9ftAJrMdSuAHD46ucIiEGDeRDcKCwgB43KgZYa47l4biIav0QyybjfOufhWGcRiQHK7nivKQFUATcQ+Ylgnhl7+cT3sEOARgDO038dATjZ/w74AKTM9q05AScjBY8YEHRVy4/Kr4mEKZXbRnaSa/IAvR3HISk3CZkkr3AMOPeM3c2SiTtWAfyzgDyz3+xYZ/6e6XPoCMBZ9tuAboB8cALKIbT5x54H2CeVBrkGOHUFHjFQNlBJ6wnVZ+AWgogA3Fg6cVymuJ1zME/kYQdT0CwgXTUpEFdmUodtCgQQjrVf2NXtMuNn2lTu18x4rxyACgO8sp+n+ts+A+Rs+a+0Z1jFfXS/ASLLGQxjJEAYlgpn1FwdN0UazloDD6wR4aQVH4GTPP+ZCUkn/MmhxtWgsu7H7O9x5fkun/hsFQKw5B+AGsGfjfc9UrDIYjukmmjatlv4taoAFduvyccFWYJIvOSdFvIo7s8Avps0ScBaE606VoVUdFvL9byO4Inc2PvhnEcC2CfL+mf7p+P//ar1dgTsEA7AmJ1gFrZ36k36tXEjV8CshFwT3tEsqBPt2rDQNqX68GNl2kfEUQGmpcQR+VSOkQJIQf2vUMorxkxdd1R+hbl6aLzmAMhCnuEZAKPmrxW+EYAFcGtpsLM9dATgUrSiMvLQbSruYArQCaKIAJxyCjgxnGN6hGLuyy55npicFuEcJZSjAD7aPwvOK46TGfPBAej4nz3959T8B8VXYMR5aK4HIACOLD8DLZvzlp2nZiAB1G1+J9pVbD8jrdR6Awts5PymQL+Pf6j6EBCCNVHN/7iV/lgq6XkWCcn1k2NmwX2UxLLHyQBeLkPGXD7x3cccQGbdP1P9UPmt5CAAqiMLOVvD8re2XkjggHXASALUWfAzl4BzKLT0wblk+kdt0vuNc6lMbBPkhtU9tMpRgfUogGaApfmi8lsdPd9S/44ASLyPQEelZwlATQqIPU/56ctB1MtEGI61slP1NybvU4LfELBXmxMZfzZGxnGkQY8HgB9rxkVM9XkK0imqfYUYqgRYAnHBEelxXzkAJwcg4EOFz9p+5hSasBPlZuGCMgIPIkwmiN50RjWg+22zDsFxHRnwR21cEKtzjADvTUx0OzMgjsY2VbEI/iq4ps+L3JiKslfPszJ2pS2exwMBZHMA+8Re709HAGxxELTtnACgWZNIa5ew/APY9c0xngno+qlBXHxfDP7tBlaOwSZjsn+GFLZJciAMOUQYRQI4dKxHBvWVJDAz9vKJz4rXAYjidiHA/sPRtQDWE4LGOwIt1e+2KxvgEsD7DPyotNPqXwQNO84ApIkxI3IJwXryMcPjnUAAVeCd1f6MaxsJgNX9WXjgKbzlCIwyX7vn3jJhpZCUAGBjRBCKTzjukoraOlfbp04iooTk04mFic4I6QiwvQkvp+XlL44cewYkZwF0uDZ1D2Ztu76VR8ZZPv5ZDxpOwwDr+X9P4ZV9b66B2HodRmgXnHEGrc8Tgz98B4GF4wJp0Bud7B+BqDu9fcxMn6hNaT+5llL/IsnNkMNMn9eZUDYC0M/5I2jXzxqowzaw9l1bZzsCl1p9I1zQJCHkhffeVH+HJBgA9HwysZYE4TA/Z/sZziECi+clPAXOKg62y5xLFHJMjZFU2ciVnA30GRJ4jD7Lxz/zVQ5AwFVa/rt3osAv5gIQ3A+25OFuenbefV6AlBLZeBb4U/hMNSLQC8gonPyzx7Xq7gapyObwfKJx4SfIOJmzjveYQM78VlW7PktU2eseCSCI9wegW5Y/SQwakDpksPYLM1juofVTQHFxE71NKGkJQmyGDTyt9qsFGeCYo8N5ZcfJtnMnsvo9smNm2mWBUHU50bFnjvvYY67H6wiAvvLLyQPgk3xWqKCFRZSdAbdti5KBilws8YrcAd70cgxfJYtAYQPI97uPEog62DbxCmNGE7UKJjx2duwz2kVjXLl/hiAihzEz5isCCFYByhzRCj0A37H92xjE1neuwtmP/V1nQBYKWfMbQ40MCKvtD5EMO6ErgBqMGQGBnWa6z37sdPujoUYUipy4f9a+R0A/c9zl277bXgXYRQABjsDUIK0Anym7DiW0m2CCaS0ZHsggafuzYO6GSwCQNkn0CwnojDESYUwFjDjcTL9osVHZTTwigCMgvu77txCAEkCy7s9IAcHI3IIGNoJwIAV0ppmwYD+4xgn9HoCpAuIQl0aDsF9nH0J6KDWo2v5DKk86zxy/QjCZtq9Tm+hcrtq/EUCn9M4LQIYwYL+x5mpABUgK8H0jgmH47IC/U38Sl1fBnwV+GryzuYILwd+GTl5ENPmyzNONkzx2xg7PklP2ujLtHqtNdJxov3YljQBEibW1t7Y34CVW/Wngt3vv9MXxB4sPd5w5CBY+6PESTvihCUzU7JzF68uCwzrnSnKudCx1MZmJUxo/itWTP+bMeWX7PEW7s46ZGSdq00IA+uYfou4DkEG9vX2W7Weqz8gBccjcAQNPRfnNuUjcCQPB6a7BZIMqBI32SfBVjhZNtm6sxPFL48HglX5XtM2OeWa7zFhWm+VbP6NPAgrYXOX3VH8fwFT9qEqg+rvq76izRxQZfEVlQXcOJ4nDBdgZY6TZKoZ6ZpLFo4iq8JZHj1Htf1X7K8bNjDnTZiCAyPLPxvs4LnUEiaW/HaifCPyReEXEkSGfM22/nO82OaKTTyP4QMOLQo/M5NdnfXWf6viZ9pk263Vm2m0hwOoAUK3NxUCBsrvEkFH9YI1AN3+zFYHki0M6UBog8bCDYcth0SUHOgW3pwxyAPiJ9wvMjp6Z7Gzsx+pXPU62/RntGgFYyt/IQVnS9au3DwHL6vc6RIjWASDIBntvOMvsSkAPwBZuuu0HQBuNUwUFPd+LwZ+diFc4kPSxyQ/52H2rx6u0z7bV7ZZvkRyAEddr694BP3IFmXyAE/NHlt8iAv2fjXju1wJ/Cvhq4AzOzDZO58y4mXxClUxObX/4IvqzyU547xqOjnGkf7VvpX2p7bd8eCIJKIpLXAFTfq322jl0feCOee00qC2HYIHfUt408GFgb26n5v0JawVmiOVUgHuDpX6E+GwqEzseLRcnXz3OzDVV+3jtl5UAEKAIOhO40WO+mZifOA5KBEG7DuCJhUADIcDkZPPUJIQDil21/dP4KXYsNs9g46HNgYGrkz1/UucRwHrMo+c527/abwwBdgLoSIAou1bjSNU98jD/81Ct/t7/IyAuRPocAH9F9be2pEM0x+l+tTEag03u11H55Zy2yTZzURUUH2xbBVDmcEfGfOy+yzfrEMBaCrzfTAbsiBwyYcGg/oSEAOu9sKi2oe2fUP3WJQnacN4XbH84lp6VB9xJZoKn25RPPD3yaQ2PAC5zEkfHP9I/03cjAAbgAegHFv9YBMEsPyqsPgcNbNaWgb+bh4QsNLHgjWV9Q4IxZoZFIubxghmWcRWZSVrgj/xwb8Df/VYZMEY/7hVjPBAAgIIqvKHGkfJ3Y0UEsl99+L4AaQcoxLmm593Z4Gfz2pvrw76kg5giBXIiV+EwHDdsEE336/efAaiZszzzuEfHWr7508k7ARXIEMjMGZhKnnkpKGnDxhu2ESWfAX8K0Jn/ZwBmgjn3E7Y/i5uIWDITM3uszFgdYV01cPVEgvZHwXP0dK46fmXc5Zs+nZcBN8BFqn10v7H8V5NMZ7kTVYHBoicBTMkgqaqhC3AaRHiJ9m8TccJZeBM4dUw2wIHrjABVmdjkJ2nDV8eJzuus/VeelzX2RgCDwnuLghxV74CbedQ3Uy5MvBQkUn53P7odreIJUFnzvdueGKdq+b3xLwF2NqE/zRxnweiDNc6VpLD+Uo0AGnjBWg92f6dVur2yNFhA59h4nEfb5+T6fw2MCPxU9ZV8mG3UXKNzn1yjnqIRZtz9RXIpinaIplkiCgd+08D9Bc4ihuUbMQRQkzXrDBAv4UNBcllR+IDK/Ejgb5MZZnVEIJ7V9J4M9EAdEUI7ZqZhVrkzZJawFslTegPvR/gFMiSxEYBW2PX7oPIROWTe+JsIHzoygS/6fDTwjiq/Bv8s8BmJAOfR2x6BxnMW1dDBIyxrTkbnt/VzGqX6PwIgjhxCX0MGXEeO9xh912t4IIAo5nfAj2o0kAaqeDLb341hHNcDf/QEoAvsI8lCA4nW5D/iAE5558ABxR/O/SDCD3a/DCuZ83q/E8HyDZ/mVAF2pCEoKcizdj5DJEIaVfAnlgJXwT/lApxS3wzoM2DLTNSK8mfHE+UvtS/A9apxM6fwlMeW81vJ5WrnsREAA/W2LQHsVMyfGKez/gr8Q1ignEXm8V8PzFXXYIHJUmY2mWbIwPq/EvWEzkzeTJuQNMgg2XEzIJwJb6rjHgp7zjrYI43D3MryX8EBWHZ+VvUtEmGAbseAGUSPWwT/2apvglntOAv0bRwDWRnAXdYmM/BkEvKpgZm8tEeC7nWH6QhgRvVdkColt9rKcT1ioC4gsP0V8LttjUnMwFkBvjXJhu2EFGcBEk3saL8cN5uHmD3PaMpnzzMax9v/GMc4cn5n9N0IANXXBWnmPQCi0Enwb8AO2mbAXwFw1fJXiKQBxLg7FYJAR8aGiyboZfvVwNFxMhN1ZoyZPplzie5hZYzXve3y9RICEBAOZJAEdQnQxpiuG3DWBWA//RnJhu5TdyskFTIDKwBPtU2qfwQGb3/Ut/utEo0TTUxczPSd6ZMF5pVjZ88hanfkHDcCiAC7HSAqFQJthi4icAlU8YMyImPtAcAOmLBtCHzCHikwR6GEvtMnVxQY6ZFD2vMt8TDTjFN5yj5Xgisa29t/BNSV4y5f/6nj04ADABNZfI8kqJor5XcVPwF+D7RybimSgF/PHDNQ5YhAPCC2vkl3EYF6VvlpP7VxZpJW+lTasntbAYLVduYcKse9evzoXJav+9RX6wBkMnUKfgH4U+VFDcTkcmANCAR/SBIF8M+CPOUUCDnijZwB9UyfDlSJmZpo0s3HTPtMm7McRMkNRcgK9s9e18HDDt03AugArx7qMfftQ0XKP+MmvD4U4HguhDi8PpV9mfUGTJFToJdrMGaGNWHO2u46iYCQjgAwC4RsuyxRZoA0c8xo3CvGjI7p3dvla4kD2Dqom06JIOsOEs8A4A9jOZCzwV9yBKpxBtSZNt01JY5h3cwzicA7p84VZGZech1AFhjZdjPneYTIop+iet7ReGed60YAFuBc9T8R/IPiF2N+Rh6RWtM+xEmIw/EmlEckacA6KnsGuL0JaO5LJv2ykztqF+2fBXV23LNApcc5cnyPCM4Yd/kv6ACyoM62q7wSTD+BaDiQlAuYLBNSIBeAGRGBSQbkTlZAf0bb4dySbqQ62TOTNtPGDVkIarJjnkkCR45Z/V1nHMPa5xUBwEQ/TfnhF3DHJC8TYa7gKPhLqg8Hi4Bd3W9ZbDZhzgB3ZYx2bs7szUzsqM3R/Y/pBqJzPZM0HgP4eD0bAaTi/WxeoBDvD6SQIAzG/K1bslJgEUF3o48+XUhi32EiFev8WYKYAjzOPBCDSFkicHj7o75Zlc+MQy4vurS2vzp+9ryvtveZ81i+5lPGMiBT3zRJ7J3Tig9UHvVxHYC6SxmQm22csVwC2q8lcgTbGGRWHQF4tq83KbYxjNkegWAW6NG4mUk84wYyx50Zt3K+FgFUzu2o+9gIIALeVeBHuxmdQxb8VeAP48IAEZCn9zvHsCZQFuDZdvQ4CeWPJudTE0F0fjNOoDLmEQKoHmfmWjRhLF8dOQA1KVygFpKDrwP4B7IwgDkNdOYIDJBlgXt2O7wPenJEE3IG7DN9qhM9Ou8rx5slgMo5zzoT5hY2AjBBfTL48cfZhs6+OhzOvANtArBpR5AA5mEiIHc5GjPrCLLEcIXyW5O3uj07sTNgybTJgjU7Vna8KtEebe/1X/6z5QAmwT+AnL1g9CD4hTzcsMAiDba9mPCLQEv3G2RlTfoMoDNtvEnZ+quBZlR6Buwzx7lCvTMAz7SZIYDsuFlyZCrvnddGAIMDCMDfgbxCFIkKgUcg2q6m1X3/VWj7yTUD7Ec1iSHhLrJEcAT0dLIVKxHRRKwSQQSAq/dH15PdX2030z76LRj4oz7LV2kHQJRqIAgB1GOD31DRChF0bR3lM8GcKO91fYvuwmJr73y8yeQSRlL5zwL1rOJHk/jo/oxyR8e4GtDZ41fPoyeAQhKvVBk4Q/kD8FdIYLvhCTLxQozIAWzDBwCLQB3tj87BnQwTyl8hgkrbzKSNAHD1/gxJZNtkrhfVPLo2rfyV9hsBlMH8RMpfBjn8MpbyZ8asEEEbT/1GFZWOgB/tD13EBcpfBfwVbiCa+FfvrwA7OpfKWLNksZ7D8p8+lFwI9AS2H1U0A1Rp47YlwLTaTwF/7xSB9Oj+I+pfeX15SCYGyWYm5etGAhlQPmabqxwFjrsRgAaO+f0k5ccTcI+dBGuaHJLjReByCSNQ16PAj/qHgIUBKqrN2h7tH6ncFQQRgSoCeLQ/Gj+65gxxasufPSZrt/zHrAN4jcCfBjyG4RPPCZQdgAOuCLgeqUSEFIIeZt0VQD46pjeBryCBCMRX788CNjqPCplYx9wIIHQAB8GfVvwT3gNAgTQBflflme0l7qJCIDMgzwCvtQmcSZpECi82rTiECBTVsWbHi/pl9kdtzgT20bGW/xA5gNcc/K4bOAh8D8DdD3/kPygplhVLoL9Q+TPnESlUFdTV9rPOIgLw0f1HQRv9rjpE8I63EYDpAF5D8LuAP2j5o7GpSkMn/UNXvlfaZtxCa3Oh8lcAWWk7C9yzjpEFmAes2X3ZY2dIKNNm+feWA3hC8FeASNuS9QxZNbeOTfur38i6edkxI2BnVFc7kyPWPnO8yvhntI0m9WOSwBGQRy7g6P4skWwEMDiASfDjzTFdxX5m3f4CYCNyyCzwicZIkQUBv6fiFYWvtDVB9cjKnyWLqrqfBehZsM4CcbZfFrjR+BFRynGWf6cdwCT4GahSJBCAPwJrtx++6GOnQK3icVO5T3p+oAL0qG13fYScvImVAW/p+CoIzYxfPb8qkUSAuIIgZseMzjWzP9NmPb+NABpYXgPwlwAPE02vZjwT8BHJsMn7ZG6AzLoMAM9qU7H5Z6j7GWNkVLd6nCwAFVe2r5HCn7V/+crVAVSeAUALbyjhrPJ7LsIC9NaHKN4lDsBQVtMpOI7CIyg2ebxjzKr/DOgzfSok8NhtI2CeCfQjID3SN7pG3L985cvEOgAE/ZFXfSceCio7AMO1uIShriflFhySqQL2DMKgx0yofwbAnnupALYCpsx5PUaY8H4ILSoAjxzG8hUvi88C7Ee3VB5PjrZJuA02BgVp4EBSwM7E/cn1BBVV90A2tQ86RQCOCCuz/ygRZAF/lETOBLSnypXz9Igssy8igIp7WP7tTgAhcCfVuyOBE8DfLq4A/shVuERhAGsKpBeFBNH/gmRNqogoov2PRQJHj/MYJDBDDkeAPHs8fcxGAJaiVwHMwLZtS4Df7Kst+8HKgQX44fj7hizYz24XKbH8rmjzItAe3R+dU9WmZ53AB5UEZoE8228ggH+TdQAFADMgpQhGAZ0SAlHkSOGj/VZ4MRNCZPvMtuv6JQgqA9gqKWTBmAV3tl32uGcpvgWy6vZZpT8L5CgQlAA85a2qtwZ6RflDB5AEfwT4aL+21Fb7LIhn+kfAzfzHIhVgR22j8zmq/BVQZc61SgKV41fH9n6bWXI4q9/y5SoJiAMfBb9Xm7ccwXB8cQVE7QayIW8groI0s5KwOmYEHm9Cm/suUP+MEp/V5oiaV8B6VdsZEphR9Jk+FXLYCMAE0oTtb2OpCZoBq+kAjLFMsgDP4x33TOsfugohMnJuEUEM56lmRaSIV+/PnP8RwGfHrxzjyrZnksPlBPBlRhlwxrpnwW8CnWXJC0RymBCS5b4zwV5Wf+hwBNhH+lqW9rHdwVF1P9r/dQZ6ljiWlQC0SjIbPLRRilYFv0cC7Yc9WOrLAFWf94y9n+ljnZurdie8YnzquMS9PAUJHAVshqCs63oMsFeuzzvPaB8eZ/lS7QCU4jJVNckgUGurH1XuiVJfilSYFTdUtUIgR0nA67/tU7OjouBll2GEKVnQZ4EWXUPFps8es3KM15EEskoPt3T7KP02AojUO0UCk+CnoCWAzII7Au2w3yG8o6COzoUBioKCnKPrFBjJqRlQcQLVY2WJIjNuBaCvIwlUVX0G0NVjdATwMXEAAYBdEnhC8Ecgc/efGPNH5xFNdhOQRdt/ptpHCh3tj675CFE8JTFUjv2UriFz7GUlgOp/DNKRwUHwdxPfUeMjDoCCq5BfOOoEZvpr2x+BLavolXEyAM6obnTMzHEqoMuc09HxKv2rbTPAVYZO/ydUbXfkKP4/BnecprBuissAAAAASUVORK5CYII=";return t}();e.TextureTools=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this._mode=t.FitFrustumSidesMode;this._radiusScale=1;this._positionScale=.5;this._defaultElevation=.3;this._elevationReturnTime=1500;this._elevationReturnWaitTime=1e3;this._zoomStopsAnimation=false;this._framingTime=1500;this._isPointerDown=false;this._lastInteractionTime=-Infinity;this._animatables=new Array;this._betaIsAnimating=false}Object.defineProperty(t.prototype,"name",{get:function(){return"Framing"},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"mode",{get:function(){return this._mode},set:function(e){this._mode=e},enumerable:true,
configurable:true});Object.defineProperty(t.prototype,"radiusScale",{get:function(){return this._radiusScale},set:function(e){this._radiusScale=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"positionScale",{get:function(){return this._positionScale},set:function(e){this._positionScale=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"defaultElevation",{get:function(){return this._defaultElevation},set:function(e){this._defaultElevation=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"elevationReturnTime",{get:function(){return this._elevationReturnTime},set:function(e){this._elevationReturnTime=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"elevationReturnWaitTime",{get:function(){return this._elevationReturnWaitTime},set:function(e){this._elevationReturnWaitTime=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"zoomStopsAnimation",{get:function(){return this._zoomStopsAnimation},set:function(e){this._zoomStopsAnimation=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"framingTime",{get:function(){return this._framingTime},set:function(e){this._framingTime=e},enumerable:true,configurable:true});t.prototype.init=function(){};t.prototype.attach=function(i){var r=this;this._attachedCamera=i;var n=this._attachedCamera.getScene();t.EasingFunction.setEasingMode(t.EasingMode);this._onPrePointerObservableObserver=n.onPrePointerObservable.add(function(t){if(t.type===e.PointerEventTypes.POINTERDOWN){r._isPointerDown=true;return}if(t.type===e.PointerEventTypes.POINTERUP){r._isPointerDown=false}});this._onMeshTargetChangedObserver=i.onMeshTargetChangedObservable.add(function(e){if(e){r.zoomOnMesh(e)}});this._onAfterCheckInputsObserver=i.onAfterCheckInputsObservable.add(function(){r._applyUserInteraction();r._maintainCameraAboveGround()})};t.prototype.detach=function(){if(!this._attachedCamera){return}var e=this._attachedCamera.getScene();if(this._onPrePointerObservableObserver){e.onPrePointerObservable.remove(this._onPrePointerObservableObserver)}if(this._onAfterCheckInputsObserver){this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver)}if(this._onMeshTargetChangedObserver){this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver)}this._attachedCamera=null};t.prototype.zoomOnMesh=function(e,t,i){if(t===void 0){t=false}if(i===void 0){i=null}e.computeWorldMatrix(true);var r=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(r.minimumWorld,r.maximumWorld,t,i)};t.prototype.zoomOnMeshHierarchy=function(e,t,i){if(t===void 0){t=false}if(i===void 0){i=null}e.computeWorldMatrix(true);var r=e.getHierarchyBoundingVectors(true);this.zoomOnBoundingInfo(r.min,r.max,t,i)};t.prototype.zoomOnMeshesHierarchy=function(t,i,r){if(i===void 0){i=false}if(r===void 0){r=null}var n=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);var o=new e.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var s=0;s<t.length;s++){var a=t[s].getHierarchyBoundingVectors(true);e.Tools.CheckExtends(a.min,n,o);e.Tools.CheckExtends(a.max,n,o)}this.zoomOnBoundingInfo(n,o,i,r)};t.prototype.zoomOnBoundingInfo=function(i,r,n,o){var s=this;if(n===void 0){n=false}if(o===void 0){o=null}var a;if(!this._attachedCamera){return}var u=i.y;var l=r.y;var c=u+(l-u)*this._positionScale;var h=r.subtract(i).scale(.5);if(n){a=new e.Vector3(0,c,0)}else{var f=i.add(h);a=new e.Vector3(f.x,c,f.z)}if(!this._vectorTransition){this._vectorTransition=e.Animation.CreateAnimation("target",e.Animation.ANIMATIONTYPE_VECTOR3,60,t.EasingFunction)}this._betaIsAnimating=true;var d=e.Animation.TransitionTo("target",a,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);if(d){this._animatables.push(d)}var p=0;if(this._mode===t.FitFrustumSidesMode){var _=this._calculateLowerRadiusFromModelBoundingSphere(i,r);this._attachedCamera.lowerRadiusLimit=h.length()+this._attachedCamera.minZ;p=_}else if(this._mode===t.IgnoreBoundsSizeMode){p=this._calculateLowerRadiusFromModelBoundingSphere(i,r);if(this._attachedCamera.lowerRadiusLimit===null){this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ}}var m=r.subtract(i).length();this._attachedCamera.panningSensibility=5e3/m;this._attachedCamera.wheelPrecision=100/p;if(!this._radiusTransition){this._radiusTransition=e.Animation.CreateAnimation("radius",e.Animation.ANIMATIONTYPE_FLOAT,60,t.EasingFunction)}d=e.Animation.TransitionTo("radius",p,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,function(){s.stopAllAnimations();if(o){o()}if(s._attachedCamera){s._attachedCamera.storeState()}});if(d){this._animatables.push(d)}};t.prototype._calculateLowerRadiusFromModelBoundingSphere=function(e,i){var r=i.subtract(e);var n=r.length();var o=this._getFrustumSlope();var s=n*.5;var a=s*this._radiusScale;var u=a*Math.sqrt(1+1/(o.x*o.x));var l=a*Math.sqrt(1+1/(o.y*o.y));var c=Math.max(u,l);var h=this._attachedCamera;if(!h){return 0}if(h.lowerRadiusLimit&&this._mode===t.IgnoreBoundsSizeMode){c=c<h.lowerRadiusLimit?h.lowerRadiusLimit:c}if(h.upperRadiusLimit){c=c>h.upperRadiusLimit?h.upperRadiusLimit:c}return c};t.prototype._maintainCameraAboveGround=function(){var i=this;if(this._elevationReturnTime<0){return}var r=e.Tools.Now-this._lastInteractionTime;var n=Math.PI*.5-this._defaultElevation;var o=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>o&&r>=this._elevationReturnWaitTime){this._betaIsAnimating=true;this.stopAllAnimations();if(!this._betaTransition){this._betaTransition=e.Animation.CreateAnimation("beta",e.Animation.ANIMATIONTYPE_FLOAT,60,t.EasingFunction)}var s=e.Animation.TransitionTo("beta",n,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,function(){i._clearAnimationLocks();i.stopAllAnimations()});if(s){this._animatables.push(s)}}};t.prototype._getFrustumSlope=function(){var t=this._attachedCamera;if(!t){return e.Vector2.Zero()}var i=t.getScene().getEngine();var r=i.getAspectRatio(t);var n=Math.tan(t.fov/2);var o=n*r;return new e.Vector2(o,n)};t.prototype._clearAnimationLocks=function(){this._betaIsAnimating=false};t.prototype._applyUserInteraction=function(){if(this.isUserIsMoving){this._lastInteractionTime=e.Tools.Now;this.stopAllAnimations();this._clearAnimationLocks()}};t.prototype.stopAllAnimations=function(){if(this._attachedCamera){this._attachedCamera.animations=[]}while(this._animatables.length){if(this._animatables[0]){this._animatables[0].onAnimationEnd=null;this._animatables[0].stop()}this._animatables.shift()}};Object.defineProperty(t.prototype,"isUserIsMoving",{get:function(){if(!this._attachedCamera){return false}return this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown},enumerable:true,configurable:true});t.EasingFunction=new e.ExponentialEase;t.EasingMode=e.EasingFunction.EASINGMODE_EASEINOUT;t.IgnoreBoundsSizeMode=0;t.FitFrustumSidesMode=1;return t}();e.FramingBehavior=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this.transitionDuration=450;this.lowerRadiusTransitionRange=2;this.upperRadiusTransitionRange=-2;this._autoTransitionRange=false;this._radiusIsAnimating=false;this._radiusBounceTransition=null;this._animatables=new Array}Object.defineProperty(t.prototype,"name",{get:function(){return"Bouncing"},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"autoTransitionRange",{get:function(){return this._autoTransitionRange},set:function(e){var t=this;if(this._autoTransitionRange===e){return}this._autoTransitionRange=e;var i=this._attachedCamera;if(!i){return}if(e){this._onMeshTargetChangedObserver=i.onMeshTargetChangedObservable.add(function(e){if(!e){return}e.computeWorldMatrix(true);var i=e.getBoundingInfo().diagonalLength;t.lowerRadiusTransitionRange=i*.05;t.upperRadiusTransitionRange=i*.05})}else if(this._onMeshTargetChangedObserver){i.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver)}},enumerable:true,configurable:true});t.prototype.init=function(){};t.prototype.attach=function(e){var t=this;this._attachedCamera=e;this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(function(){if(!t._attachedCamera){return}if(t._isRadiusAtLimit(t._attachedCamera.lowerRadiusLimit)){t._applyBoundRadiusAnimation(t.lowerRadiusTransitionRange)}if(t._isRadiusAtLimit(t._attachedCamera.upperRadiusLimit)){t._applyBoundRadiusAnimation(t.upperRadiusTransitionRange)}})};t.prototype.detach=function(){if(!this._attachedCamera){return}if(this._onAfterCheckInputsObserver){this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver)}if(this._onMeshTargetChangedObserver){this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver)}this._attachedCamera=null};t.prototype._isRadiusAtLimit=function(e){if(!this._attachedCamera){return false}if(this._attachedCamera.radius===e&&!this._radiusIsAnimating){return true}return false};t.prototype._applyBoundRadiusAnimation=function(i){var r=this;if(!this._attachedCamera){return}if(!this._radiusBounceTransition){t.EasingFunction.setEasingMode(t.EasingMode);this._radiusBounceTransition=e.Animation.CreateAnimation("radius",e.Animation.ANIMATIONTYPE_FLOAT,60,t.EasingFunction)}this._cachedWheelPrecision=this._attachedCamera.wheelPrecision;this._attachedCamera.wheelPrecision=Infinity;this._attachedCamera.inertialRadiusOffset=0;this.stopAllAnimations();this._radiusIsAnimating=true;var n=e.Animation.TransitionTo("radius",this._attachedCamera.radius+i,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,function(){return r._clearAnimationLocks()});if(n){this._animatables.push(n)}};t.prototype._clearAnimationLocks=function(){this._radiusIsAnimating=false;if(this._attachedCamera){this._attachedCamera.wheelPrecision=this._cachedWheelPrecision}};t.prototype.stopAllAnimations=function(){if(this._attachedCamera){this._attachedCamera.animations=[]}while(this._animatables.length){this._animatables[0].onAnimationEnd=null;this._animatables[0].stop();this._animatables.shift()}};t.EasingFunction=new e.BackEase(.3);t.EasingMode=e.EasingFunction.EASINGMODE_EASEOUT;return t}();e.BouncingBehavior=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(){this._zoomStopsAnimation=false;this._idleRotationSpeed=.05;this._idleRotationWaitTime=2e3;this._idleRotationSpinupTime=2e3;this._isPointerDown=false;this._lastFrameTime=null;this._lastInteractionTime=-Infinity;this._cameraRotationSpeed=0;this._lastFrameRadius=0}Object.defineProperty(t.prototype,"name",{get:function(){return"AutoRotation"},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"zoomStopsAnimation",{get:function(){return this._zoomStopsAnimation},set:function(e){this._zoomStopsAnimation=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"idleRotationSpeed",{get:function(){return this._idleRotationSpeed},set:function(e){this._idleRotationSpeed=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"idleRotationWaitTime",{get:function(){return this._idleRotationWaitTime},set:function(e){this._idleRotationWaitTime=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"idleRotationSpinupTime",{get:function(){return this._idleRotationSpinupTime},set:function(e){this._idleRotationSpinupTime=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"rotationInProgress",{get:function(){return Math.abs(this._cameraRotationSpeed)>0},enumerable:true,configurable:true});t.prototype.init=function(){};t.prototype.attach=function(t){var i=this;this._attachedCamera=t;var r=this._attachedCamera.getScene();this._onPrePointerObservableObserver=r.onPrePointerObservable.add(function(t){if(t.type===e.PointerEventTypes.POINTERDOWN){i._isPointerDown=true;return}if(t.type===e.PointerEventTypes.POINTERUP){i._isPointerDown=false}});this._onAfterCheckInputsObserver=t.onAfterCheckInputsObservable.add(function(){var t=e.Tools.Now;var r=0;if(i._lastFrameTime!=null){r=t-i._lastFrameTime}i._lastFrameTime=t;i._applyUserInteraction();var n=t-i._lastInteractionTime-i._idleRotationWaitTime;var o=Math.max(Math.min(n/i._idleRotationSpinupTime,1),0);i._cameraRotationSpeed=i._idleRotationSpeed*o;if(i._attachedCamera){i._attachedCamera.alpha-=i._cameraRotationSpeed*(r/1e3)}})};t.prototype.detach=function(){if(!this._attachedCamera){return}var e=this._attachedCamera.getScene();if(this._onPrePointerObservableObserver){e.onPrePointerObservable.remove(this._onPrePointerObservableObserver)}this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver);this._attachedCamera=null};t.prototype._userIsZooming=function(){if(!this._attachedCamera){return false}return this._attachedCamera.inertialRadiusOffset!==0};t.prototype._shouldAnimationStopForInteraction=function(){if(!this._attachedCamera){return false}var e=false;if(this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0){e=true}this._lastFrameRadius=this._attachedCamera.radius;return this._zoomStopsAnimation?e:this._userIsZooming()};t.prototype._applyUserInteraction=function(){if(this._userIsMoving()&&!this._shouldAnimationStopForInteraction()){this._lastInteractionTime=e.Tools.Now}};t.prototype._userIsMoving=function(){if(!this._attachedCamera){return false}return this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown};return t}();e.AutoRotationBehavior=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this.renderWidth=512;this.renderHeight=256;this.textureSize=512;this.deterministicLockstep=false;this.lockstepMaxSteps=4}return e}();e.NullEngineOptions=t;var i=function(i){__extends(r,i);function r(r){if(r===void 0){r=new t}var n=i.call(this,null)||this;if(r.deterministicLockstep===undefined){r.deterministicLockstep=false}if(r.lockstepMaxSteps===undefined){r.lockstepMaxSteps=4}n._options=r;n._caps=new e.EngineCapabilities;n._caps.maxTexturesImageUnits=16;n._caps.maxVertexTextureImageUnits=16;n._caps.maxTextureSize=512;n._caps.maxCubemapTextureSize=512;n._caps.maxRenderTextureSize=512;n._caps.maxVertexAttribs=16;n._caps.maxVaryingVectors=16;n._caps.maxFragmentUniformVectors=16;n._caps.maxVertexUniformVectors=16;n._caps.standardDerivatives=false;n._caps.astc=null;n._caps.s3tc=null;n._caps.pvrtc=null;n._caps.etc1=null;n._caps.etc2=null;n._caps.textureAnisotropicFilterExtension=null;n._caps.maxAnisotropy=0;n._caps.uintIndices=false;n._caps.fragmentDepthSupported=false;n._caps.highPrecisionShaderSupported=true;n._caps.colorBufferFloat=false;n._caps.textureFloat=false;n._caps.textureFloatLinearFiltering=false;n._caps.textureFloatRender=false;n._caps.textureHalfFloat=false;n._caps.textureHalfFloatLinearFiltering=false;n._caps.textureHalfFloatRender=false;n._caps.textureLOD=false;n._caps.drawBuffersExtension=false;n._caps.depthTextureExtension=false;n._caps.vertexArrayObject=false;n._caps.instancedArrays=false;e.Tools.Log("Babylon.js null engine (v"+e.Engine.Version+") launched");if(typeof URL==="undefined"){URL={createObjectURL:function(){},revokeObjectURL:function(){}}}if(typeof Blob==="undefined"){Blob=function(){}}return n}r.prototype.isDeterministicLockStep=function(){return this._options.deterministicLockstep};r.prototype.getLockstepMaxSteps=function(){return this._options.lockstepMaxSteps};r.prototype.getHardwareScalingLevel=function(){return 1};r.prototype.createVertexBuffer=function(e){return{capacity:0,references:1,is32Bits:false}};r.prototype.createIndexBuffer=function(e){return{capacity:0,references:1,is32Bits:false}};r.prototype.clear=function(e,t,i,r){if(r===void 0){r=false}};r.prototype.getRenderWidth=function(e){if(e===void 0){e=false}if(!e&&this._currentRenderTarget){return this._currentRenderTarget.width}return this._options.renderWidth};r.prototype.getRenderHeight=function(e){if(e===void 0){e=false}if(!e&&this._currentRenderTarget){return this._currentRenderTarget.height}return this._options.renderHeight};r.prototype.setViewport=function(e,t,i){this._cachedViewport=e};r.prototype.createShaderProgram=function(e,t,i,r){return{transformFeedback:null,__SPECTOR_rebuildProgram:null}};r.prototype.getUniforms=function(e,t){return[]};r.prototype.getAttributes=function(e,t){return[]};r.prototype.bindSamplers=function(e){this._currentEffect=null};r.prototype.enableEffect=function(e){this._currentEffect=e;if(e.onBind){e.onBind(e)}e.onBindObservable.notifyObservers(e)};r.prototype.setState=function(e,t,i,r){if(t===void 0){t=0}if(r===void 0){r=false}};r.prototype.setIntArray=function(e,t){};r.prototype.setIntArray2=function(e,t){};r.prototype.setIntArray3=function(e,t){};r.prototype.setIntArray4=function(e,t){};r.prototype.setFloatArray=function(e,t){};r.prototype.setFloatArray2=function(e,t){};r.prototype.setFloatArray3=function(e,t){};r.prototype.setFloatArray4=function(e,t){};r.prototype.setArray=function(e,t){};r.prototype.setArray2=function(e,t){};r.prototype.setArray3=function(e,t){};r.prototype.setArray4=function(e,t){};r.prototype.setMatrices=function(e,t){};r.prototype.setMatrix=function(e,t){};r.prototype.setMatrix3x3=function(e,t){};r.prototype.setMatrix2x2=function(e,t){};r.prototype.setFloat=function(e,t){};r.prototype.setFloat2=function(e,t,i){};r.prototype.setFloat3=function(e,t,i,r){};r.prototype.setBool=function(e,t){};r.prototype.setFloat4=function(e,t,i,r,n){};r.prototype.setColor3=function(e,t){};r.prototype.setColor4=function(e,t,i){};r.prototype.setAlphaMode=function(t,i){if(i===void 0){i=false}if(this._alphaMode===t){return}this._alphaState.alphaBlend=t!==e.Engine.ALPHA_DISABLE;if(!i){this.setDepthWrite(t===e.Engine.ALPHA_DISABLE)}this._alphaMode=t};r.prototype.bindBuffers=function(e,t,i){};r.prototype.wipeCaches=function(e){if(this.preventCacheWipeBetweenFrames){return}this.resetTextureCache();this._currentEffect=null;if(e){this._currentProgram=null;this._stencilState.reset();this._depthCullingState.reset();this._alphaState.reset()}this._cachedVertexBuffers=null;this._cachedIndexBuffer=null;this._cachedEffectForVertexBuffers=null};r.prototype.draw=function(e,t,i,r){};r.prototype.drawElementsType=function(e,t,i,r){};r.prototype.drawArraysType=function(e,t,i,r){};r.prototype._createTexture=function(){return{}};r.prototype._releaseTexture=function(e){};r.prototype.createTexture=function(t,i,r,n,o,s,a,u,l,c){if(o===void 0){o=e.Texture.TRILINEAR_SAMPLINGMODE}if(s===void 0){s=null}if(a===void 0){a=null}if(u===void 0){u=null}var h=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_URL);var f=String(t);h.url=f;h.generateMipMaps=!i;h.samplingMode=o;h.invertY=r;h.baseWidth=this._options.textureSize;h.baseHeight=this._options.textureSize;h.width=this._options.textureSize;h.height=this._options.textureSize;if(c){h.format=c}h.isReady=true;if(s){s()}return h};r.prototype.createRenderTargetTexture=function(t,i){var r=new e.RenderTargetCreationOptions;if(i!==undefined&&typeof i==="object"){r.generateMipMaps=i.generateMipMaps;r.generateDepthBuffer=i.generateDepthBuffer===undefined?true:i.generateDepthBuffer;r.generateStencilBuffer=r.generateDepthBuffer&&i.generateStencilBuffer;r.type=i.type===undefined?e.Engine.TEXTURETYPE_UNSIGNED_INT:i.type;r.samplingMode=i.samplingMode===undefined?e.Texture.TRILINEAR_SAMPLINGMODE:i.samplingMode}else{r.generateMipMaps=i;r.generateDepthBuffer=true;r.generateStencilBuffer=false;r.type=e.Engine.TEXTURETYPE_UNSIGNED_INT;r.samplingMode=e.Texture.TRILINEAR_SAMPLINGMODE}var n=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_RENDERTARGET);var o=t.width||t;var s=t.height||t;n._depthStencilBuffer={};n._framebuffer={};n.baseWidth=o;n.baseHeight=s;n.width=o;n.height=s;n.isReady=true;n.samples=1;n.generateMipMaps=r.generateMipMaps?true:false;n.samplingMode=r.samplingMode;n.type=r.type;n._generateDepthBuffer=r.generateDepthBuffer;n._generateStencilBuffer=r.generateStencilBuffer?true:false;return n};r.prototype.updateTextureSamplingMode=function(e,t){t.samplingMode=e};r.prototype.bindFramebuffer=function(e,t,i,r,n){if(this._currentRenderTarget){this.unBindFramebuffer(this._currentRenderTarget)}this._currentRenderTarget=e;this._currentFramebuffer=e._MSAAFramebuffer?e._MSAAFramebuffer:e._framebuffer;if(this._cachedViewport&&!n){this.setViewport(this._cachedViewport,i,r)}};r.prototype.unBindFramebuffer=function(e,t,i){if(t===void 0){t=false}this._currentRenderTarget=null;if(i){if(e._MSAAFramebuffer){this._currentFramebuffer=e._framebuffer}i()}this._currentFramebuffer=null};r.prototype.createDynamicVertexBuffer=function(e){var t={capacity:1,references:1,is32Bits:false};return t};r.prototype.updateDynamicIndexBuffer=function(e,t,i){if(i===void 0){i=0}};r.prototype.updateDynamicVertexBuffer=function(e,t,i,r){};r.prototype._bindTextureDirectly=function(e,t){if(this._boundTexturesCache[this._activeChannel]!==t){this._boundTexturesCache[this._activeChannel]=t}};r.prototype._bindTexture=function(e,t){if(e<0){return}this._bindTextureDirectly(0,t)};r.prototype._releaseBuffer=function(e){e.references--;if(e.references===0){return true}return false};return r}(e.Engine);e.NullEngine=i})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t){this.engine=t;this._captureGPUFrameTime=false;this._gpuFrameTime=new e.PerfCounter;this._captureShaderCompilationTime=false;this._shaderCompilationTime=new e.PerfCounter;this._onBeginFrameObserver=null;this._onEndFrameObserver=null;this._onBeforeShaderCompilationObserver=null;this._onAfterShaderCompilationObserver=null}Object.defineProperty(t.prototype,"gpuFrameTimeCounter",{get:function(){return this._gpuFrameTime},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"captureGPUFrameTime",{get:function(){return this._captureGPUFrameTime},set:function(e){var t=this;if(e===this._captureGPUFrameTime){return}this._captureGPUFrameTime=e;if(e){this._onBeginFrameObserver=this.engine.onBeginFrameObservable.add(function(){if(!t._gpuFrameTimeToken){t._gpuFrameTimeToken=t.engine.startTimeQuery()}});this._onEndFrameObserver=this.engine.onEndFrameObservable.add(function(){if(!t._gpuFrameTimeToken){return}var e=t.engine.endTimeQuery(t._gpuFrameTimeToken);if(e>-1){t._gpuFrameTimeToken=null;t._gpuFrameTime.fetchNewFrame();t._gpuFrameTime.addCount(e,true)}})}else{this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver);this._onBeginFrameObserver=null;this.engine.onEndFrameObservable.remove(this._onEndFrameObserver);this._onEndFrameObserver=null}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"shaderCompilationTimeCounter",{get:function(){return this._shaderCompilationTime},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"captureShaderCompilationTime",{get:function(){return this._captureShaderCompilationTime},set:function(e){var t=this;if(e===this._captureShaderCompilationTime){return}this._captureShaderCompilationTime=e;if(e){this._onBeforeShaderCompilationObserver=this.engine.onBeforeShaderCompilationObservable.add(function(){t._shaderCompilationTime.fetchNewFrame();t._shaderCompilationTime.beginMonitoring()});this._onAfterShaderCompilationObserver=this.engine.onAfterShaderCompilationObservable.add(function(){t._shaderCompilationTime.endMonitoring()})}else{this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver);this._onBeforeShaderCompilationObserver=null;this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver);this._onAfterShaderCompilationObserver=null}},enumerable:true,configurable:true});t.prototype.dispose=function(){this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver);this._onBeginFrameObserver=null;this.engine.onEndFrameObservable.remove(this._onEndFrameObserver);this._onEndFrameObserver=null;this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver);this._onBeforeShaderCompilationObserver=null;this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver);this._onAfterShaderCompilationObserver=null;this.engine=null};return t}();e.EngineInstrumentation=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function t(t){var i=this;this.scene=t;this._captureActiveMeshesEvaluationTime=false;this._activeMeshesEvaluationTime=new e.PerfCounter;this._captureRenderTargetsRenderTime=false;this._renderTargetsRenderTime=new e.PerfCounter;this._captureFrameTime=false;this._frameTime=new e.PerfCounter;this._captureRenderTime=false;this._renderTime=new e.PerfCounter;this._captureInterFrameTime=false;this._interFrameTime=new e.PerfCounter;this._captureParticlesRenderTime=false;this._particlesRenderTime=new e.PerfCounter;this._captureSpritesRenderTime=false;this._spritesRenderTime=new e.PerfCounter;this._capturePhysicsTime=false;this._physicsTime=new e.PerfCounter;this._captureAnimationsTime=false;this._animationsTime=new e.PerfCounter;this._onBeforeActiveMeshesEvaluationObserver=null;this._onAfterActiveMeshesEvaluationObserver=null;this._onBeforeRenderTargetsRenderObserver=null;this._onAfterRenderTargetsRenderObserver=null;this._onAfterRenderObserver=null;this._onBeforeDrawPhaseObserver=null;this._onAfterDrawPhaseObserver=null;this._onBeforeAnimationsObserver=null;this._onBeforeParticlesRenderingObserver=null;this._onAfterParticlesRenderingObserver=null;this._onBeforeSpritesRenderingObserver=null;this._onAfterSpritesRenderingObserver=null;this._onBeforePhysicsObserver=null;this._onAfterPhysicsObserver=null;this._onAfterAnimationsObserver=null;this._onBeforeAnimationsObserver=t.onBeforeAnimationsObservable.add(function(){if(i._captureActiveMeshesEvaluationTime){i._activeMeshesEvaluationTime.fetchNewFrame()}if(i._captureRenderTargetsRenderTime){i._renderTargetsRenderTime.fetchNewFrame()}if(i._captureFrameTime){e.Tools.StartPerformanceCounter("Scene rendering");i._frameTime.beginMonitoring()}if(i._captureInterFrameTime){i._interFrameTime.endMonitoring()}if(i._captureParticlesRenderTime){i._particlesRenderTime.fetchNewFrame()}if(i._captureSpritesRenderTime){i._spritesRenderTime.fetchNewFrame()}if(i._captureAnimationsTime){i._animationsTime.beginMonitoring()}i.scene.getEngine()._drawCalls.fetchNewFrame();i.scene.getEngine()._textureCollisions.fetchNewFrame()});this._onAfterRenderObserver=t.onAfterRenderObservable.add(function(){if(i._captureFrameTime){e.Tools.EndPerformanceCounter("Scene rendering");i._frameTime.endMonitoring()}if(i._captureRenderTime){i._renderTime.endMonitoring(false)}if(i._captureInterFrameTime){i._interFrameTime.beginMonitoring()}})}Object.defineProperty(t.prototype,"activeMeshesEvaluationTimeCounter",{get:function(){return this._activeMeshesEvaluationTime},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"captureActiveMeshesEvaluationTime",{get:function(){return this._captureActiveMeshesEvaluationTime},set:function(t){var i=this;if(t===this._captureActiveMeshesEvaluationTime){return}this._captureActiveMeshesEvaluationTime=t;if(t){this._onBeforeActiveMeshesEvaluationObserver=this.scene.onBeforeActiveMeshesEvaluationObservable.add(function(){e.Tools.StartPerformanceCounter("Active meshes evaluation");i._activeMeshesEvaluationTime.beginMonitoring()});this._onAfterActiveMeshesEvaluationObserver=this.scene.onAfterActiveMeshesEvaluationObservable.add(function(){e.Tools.EndPerformanceCounter("Active meshes evaluation");i._activeMeshesEvaluationTime.endMonitoring()})}else{this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver);this._onBeforeActiveMeshesEvaluationObserver=null;this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver);this._onAfterActiveMeshesEvaluationObserver=null}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"renderTargetsRenderTimeCounter",{get:function(){return this._renderTargetsRenderTime},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"captureRenderTargetsRenderTime",{get:function(){return this._captureRenderTargetsRenderTime},set:function(t){var i=this;if(t===this._captureRenderTargetsRenderTime){return}this._captureRenderTargetsRenderTime=t;if(t){this._onBeforeRenderTargetsRenderObserver=this.scene.onBeforeRenderTargetsRenderObservable.add(function(){e.Tools.StartPerformanceCounter("Render targets rendering");i._renderTargetsRenderTime.beginMonitoring()});this._onAfterRenderTargetsRenderObserver=this.scene.onAfterRenderTargetsRenderObservable.add(function(){e.Tools.EndPerformanceCounter("Render targets rendering");i._renderTargetsRenderTime.endMonitoring(false)})}else{this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver);this._onBeforeRenderTargetsRenderObserver=null;this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver);this._onAfterRenderTargetsRenderObserver=null}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"particlesRenderTimeCounter",{get:function(){return this._particlesRenderTime},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"captureParticlesRenderTime",{get:function(){return this._captureParticlesRenderTime},set:function(t){var i=this;if(t===this._captureParticlesRenderTime){return}this._captureParticlesRenderTime=t;if(t){this._onBeforeParticlesRenderingObserver=this.scene.onBeforeParticlesRenderingObservable.add(function(){e.Tools.StartPerformanceCounter("Particles");i._particlesRenderTime.beginMonitoring()});this._onAfterParticlesRenderingObserver=this.scene.onAfterParticlesRenderingObservable.add(function(){e.Tools.EndPerformanceCounter("Particles");i._particlesRenderTime.endMonitoring(false)})}else{this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver);this._onBeforeParticlesRenderingObserver=null;this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver);this._onAfterParticlesRenderingObserver=null}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"spritesRenderTimeCounter",{get:function(){return this._spritesRenderTime},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"captureSpritesRenderTime",{get:function(){return this._captureSpritesRenderTime},set:function(t){var i=this;if(t===this._captureSpritesRenderTime){return}this._captureSpritesRenderTime=t;if(t){this._onBeforeSpritesRenderingObserver=this.scene.onBeforeSpritesRenderingObservable.add(function(){e.Tools.StartPerformanceCounter("Sprites");i._spritesRenderTime.beginMonitoring()});this._onAfterSpritesRenderingObserver=this.scene.onAfterSpritesRenderingObservable.add(function(){e.Tools.EndPerformanceCounter("Sprites");i._spritesRenderTime.endMonitoring(false)})}else{this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver);this._onBeforeSpritesRenderingObserver=null;this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver);this._onAfterSpritesRenderingObserver=null}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"physicsTimeCounter",{get:function(){return this._physicsTime},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"capturePhysicsTime",{get:function(){return this._capturePhysicsTime},set:function(t){var i=this;if(t===this._capturePhysicsTime){return}this._capturePhysicsTime=t;if(t){
this._onBeforePhysicsObserver=this.scene.onBeforePhysicsObservable.add(function(){e.Tools.StartPerformanceCounter("Physics");i._physicsTime.beginMonitoring()});this._onAfterPhysicsObserver=this.scene.onAfterPhysicsObservable.add(function(){e.Tools.EndPerformanceCounter("Physics");i._physicsTime.endMonitoring()})}else{this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver);this._onBeforePhysicsObserver=null;this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver);this._onAfterPhysicsObserver=null}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"animationsTimeCounter",{get:function(){return this._animationsTime},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"captureAnimationsTime",{get:function(){return this._captureAnimationsTime},set:function(e){var t=this;if(e===this._captureAnimationsTime){return}this._captureAnimationsTime=e;if(e){this._onAfterAnimationsObserver=this.scene.onAfterAnimationsObservable.add(function(){t._animationsTime.endMonitoring()})}else{this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver);this._onAfterAnimationsObserver=null}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"frameTimeCounter",{get:function(){return this._frameTime},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"captureFrameTime",{get:function(){return this._captureFrameTime},set:function(e){this._captureFrameTime=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"interFrameTimeCounter",{get:function(){return this._interFrameTime},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"captureInterFrameTime",{get:function(){return this._captureInterFrameTime},set:function(e){this._captureInterFrameTime=e},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"renderTimeCounter",{get:function(){return this._renderTime},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"captureRenderTime",{get:function(){return this._captureRenderTime},set:function(t){var i=this;if(t===this._captureRenderTime){return}this._captureRenderTime=t;if(t){this._onBeforeDrawPhaseObserver=this.scene.onBeforeDrawPhaseObservable.add(function(){i._renderTime.beginMonitoring();e.Tools.StartPerformanceCounter("Main render")});this._onAfterDrawPhaseObserver=this.scene.onAfterDrawPhaseObservable.add(function(){i._renderTime.endMonitoring(false);e.Tools.EndPerformanceCounter("Main render")})}else{this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver);this._onBeforeDrawPhaseObserver=null;this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver);this._onAfterDrawPhaseObserver=null}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"drawCallsCounter",{get:function(){return this.scene.getEngine()._drawCalls},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"textureCollisionsCounter",{get:function(){return this.scene.getEngine()._textureCollisions},enumerable:true,configurable:true});t.prototype.dispose=function(){this.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver);this._onAfterRenderObserver=null;this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver);this._onBeforeActiveMeshesEvaluationObserver=null;this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver);this._onAfterActiveMeshesEvaluationObserver=null;this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver);this._onBeforeRenderTargetsRenderObserver=null;this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver);this._onAfterRenderTargetsRenderObserver=null;this.scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver);this._onBeforeAnimationsObserver=null;this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver);this._onBeforeParticlesRenderingObserver=null;this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver);this._onAfterParticlesRenderingObserver=null;this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver);this._onBeforeSpritesRenderingObserver=null;this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver);this._onAfterSpritesRenderingObserver=null;this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver);this._onBeforeDrawPhaseObserver=null;this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver);this._onAfterDrawPhaseObserver=null;this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver);this._onBeforePhysicsObserver=null;this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver);this._onAfterPhysicsObserver=null;this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver);this._onAfterAnimationsObserver=null;this.scene=null};return t}();e.SceneInstrumentation=t})(r||(r={}));"use strict";var r;(function(e){var t=function(){function e(){this._timeElapsedQueryEnded=false}return e}();e._TimeToken=t})(r||(r={}));"use strict";var r;(function(e){var t=function(e){__extends(t,e);function t(){var t=e.call(this)||this;t.DIFFUSE=false;t.DIFFUSEDIRECTUV=0;t.GAMMADIFFUSE=false;t.DIFFUSEHASALPHA=false;t.OPACITYFRESNEL=false;t.REFLECTIONBLUR=false;t.REFLECTIONFRESNEL=false;t.REFLECTIONFALLOFF=false;t.TEXTURELODSUPPORT=false;t.PREMULTIPLYALPHA=false;t.USERGBCOLOR=false;t.NOISE=false;t.REFLECTIONBGR=false;t.IMAGEPROCESSING=false;t.VIGNETTE=false;t.VIGNETTEBLENDMODEMULTIPLY=false;t.VIGNETTEBLENDMODEOPAQUE=false;t.TONEMAPPING=false;t.CONTRAST=false;t.COLORCURVES=false;t.COLORGRADING=false;t.COLORGRADING3D=false;t.SAMPLER3DGREENDEPTH=false;t.SAMPLER3DBGRMAP=false;t.IMAGEPROCESSINGPOSTPROCESS=false;t.EXPOSURE=false;t.REFLECTION=false;t.REFLECTIONMAP_3D=false;t.REFLECTIONMAP_SPHERICAL=false;t.REFLECTIONMAP_PLANAR=false;t.REFLECTIONMAP_CUBIC=false;t.REFLECTIONMAP_PROJECTION=false;t.REFLECTIONMAP_SKYBOX=false;t.REFLECTIONMAP_EXPLICIT=false;t.REFLECTIONMAP_EQUIRECTANGULAR=false;t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false;t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false;t.INVERTCUBICMAP=false;t.REFLECTIONMAP_OPPOSITEZ=false;t.LODINREFLECTIONALPHA=false;t.GAMMAREFLECTION=false;t.EQUIRECTANGULAR_RELFECTION_FOV=false;t.MAINUV1=false;t.MAINUV2=false;t.UV1=false;t.UV2=false;t.CLIPPLANE=false;t.POINTSIZE=false;t.FOG=false;t.NORMAL=false;t.NUM_BONE_INFLUENCERS=0;t.BonesPerMesh=0;t.INSTANCES=false;t.SHADOWFLOAT=false;t.rebuild();return t}return t}(e.MaterialDefines);var i=function(i){__extends(r,i);function r(t,r){var n=i.call(this,t,r)||this;n.primaryColor=e.Color3.White();n.primaryLevel=1;n.secondaryColor=e.Color3.Gray();n.secondaryLevel=1;n.tertiaryColor=e.Color3.Black();n.tertiaryLevel=1;n.reflectionTexture=null;n.reflectionBlur=0;n.diffuseTexture=null;n._shadowLights=null;n.shadowLights=null;n.shadowBlurScale=1;n.shadowLevel=0;n.sceneCenter=e.Vector3.Zero();n.opacityFresnel=true;n.reflectionFresnel=false;n.reflectionFalloffDistance=0;n.reflectionAmount=1;n.reflectionReflectance0=.05;n.reflectionReflectance90=.5;n.useRGBColor=true;n.enableNoise=false;n._fovMultiplier=1;n.useEquirectangularFOV=false;n._maxSimultaneousLights=4;n.maxSimultaneousLights=4;n._imageProcessingObserver=null;n.switchToBGR=false;n._renderTargets=new e.SmartArray(16);n._reflectionControls=e.Vector4.Zero();n._attachImageProcessingConfiguration(null);n.getRenderTargetTextures=function(){n._renderTargets.reset();if(n._diffuseTexture&&n._diffuseTexture.isRenderTarget){n._renderTargets.push(n._diffuseTexture)}if(n._reflectionTexture&&n._reflectionTexture.isRenderTarget){n._renderTargets.push(n._reflectionTexture)}return n._renderTargets};return n}Object.defineProperty(r.prototype,"reflectionStandardFresnelWeight",{set:function(e){var t=e;if(t<.5){t=t*2;this.reflectionReflectance0=r.StandardReflectance0*t;this.reflectionReflectance90=r.StandardReflectance90*t}else{t=t*2-1;this.reflectionReflectance0=r.StandardReflectance0+(1-r.StandardReflectance0)*t;this.reflectionReflectance90=r.StandardReflectance90+(1-r.StandardReflectance90)*t}},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"fovMultiplier",{get:function(){return this._fovMultiplier},set:function(e){if(isNaN(e)){e=1}this._fovMultiplier=Math.max(0,Math.min(2,e))},enumerable:true,configurable:true});r.prototype._attachImageProcessingConfiguration=function(e){var t=this;if(e===this._imageProcessingConfiguration){return}if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}if(!e){this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration}else{this._imageProcessingConfiguration=e}this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(e){t._markAllSubMeshesAsImageProcessingDirty()})};Object.defineProperty(r.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e);this._markAllSubMeshesAsTexturesDirty()},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(e){this._imageProcessingConfiguration.exposure=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(e){this._imageProcessingConfiguration.contrast=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(e){this.imageProcessingConfiguration.colorGradingTexture=e},enumerable:true,configurable:true});Object.defineProperty(r.prototype,"cameraColorCurves",{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(e){this.imageProcessingConfiguration.colorCurves=e},enumerable:true,configurable:true});r.prototype.needAlphaTesting=function(){return true};r.prototype.needAlphaBlending=function(){return this.alpha<0||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha};r.prototype.isReadyForSubMesh=function(i,r,n){var o=this;if(n===void 0){n=false}if(r.effect&&this.isFrozen){if(this._wasPreviouslyReady){return true}}if(!r._materialDefines){r._materialDefines=new t}var s=this.getScene();var a=r._materialDefines;if(!this.checkReadyOnEveryCall&&r.effect){if(a._renderId===s.getRenderId()){return true}}var u=s.getEngine();e.MaterialHelper.PrepareDefinesForLights(s,i,a,false,this._maxSimultaneousLights);a._needNormals=true;if(a._areTexturesDirty){a._needUVs=false;if(s.texturesEnabled){if(s.getEngine().getCaps().textureLOD){a.TEXTURELODSUPPORT=true}if(this._diffuseTexture&&e.StandardMaterial.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking()){return false}e.MaterialHelper.PrepareDefinesForMergedUV(this._diffuseTexture,a,"DIFFUSE");a.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha;a.GAMMADIFFUSE=this._diffuseTexture.gammaSpace;a.OPACITYFRESNEL=this._opacityFresnel}else{a.DIFFUSE=false;a.DIFFUSEHASALPHA=false;a.GAMMADIFFUSE=false;a.OPACITYFRESNEL=false}var l=this._reflectionTexture;if(l&&e.StandardMaterial.ReflectionTextureEnabled){if(!l.isReadyOrNotBlocking()){return false}a.REFLECTION=true;a.GAMMAREFLECTION=l.gammaSpace;a.REFLECTIONBLUR=this._reflectionBlur>0;a.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!l.invertZ:l.invertZ;a.LODINREFLECTIONALPHA=l.lodLevelInAlpha;a.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV;a.REFLECTIONBGR=this.switchToBGR;if(l.coordinatesMode===e.Texture.INVCUBIC_MODE){a.INVERTCUBICMAP=true}a.REFLECTIONMAP_3D=l.isCube;switch(l.coordinatesMode){case e.Texture.CUBIC_MODE:case e.Texture.INVCUBIC_MODE:a.REFLECTIONMAP_CUBIC=true;break;case e.Texture.EXPLICIT_MODE:a.REFLECTIONMAP_EXPLICIT=true;break;case e.Texture.PLANAR_MODE:a.REFLECTIONMAP_PLANAR=true;break;case e.Texture.PROJECTION_MODE:a.REFLECTIONMAP_PROJECTION=true;break;case e.Texture.SKYBOX_MODE:a.REFLECTIONMAP_SKYBOX=true;break;case e.Texture.SPHERICAL_MODE:a.REFLECTIONMAP_SPHERICAL=true;break;case e.Texture.EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR=true;break;case e.Texture.FIXED_EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=true;break;case e.Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=true;break}if(this.reflectionFresnel){a.REFLECTIONFRESNEL=true;a.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0;this._reflectionControls.x=this.reflectionAmount;this._reflectionControls.y=this.reflectionReflectance0;this._reflectionControls.z=this.reflectionReflectance90;this._reflectionControls.w=1/this.reflectionFalloffDistance}else{a.REFLECTIONFRESNEL=false;a.REFLECTIONFALLOFF=false}}else{a.REFLECTION=false;a.REFLECTIONFALLOFF=false;a.REFLECTIONBLUR=false;a.REFLECTIONMAP_3D=false;a.REFLECTIONMAP_SPHERICAL=false;a.REFLECTIONMAP_PLANAR=false;a.REFLECTIONMAP_CUBIC=false;a.REFLECTIONMAP_PROJECTION=false;a.REFLECTIONMAP_SKYBOX=false;a.REFLECTIONMAP_EXPLICIT=false;a.REFLECTIONMAP_EQUIRECTANGULAR=false;a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=false;a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=false;a.INVERTCUBICMAP=false;a.REFLECTIONMAP_OPPOSITEZ=false;a.LODINREFLECTIONALPHA=false;a.GAMMAREFLECTION=false}}a.PREMULTIPLYALPHA=this.alphaMode===e.Engine.ALPHA_PREMULTIPLIED||this.alphaMode===e.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;a.USERGBCOLOR=this._useRGBColor;a.NOISE=this._enableNoise}if(a._areImageProcessingDirty){if(!this._imageProcessingConfiguration.isReady()){return false}this._imageProcessingConfiguration.prepareDefines(a)}e.MaterialHelper.PrepareDefinesForMisc(i,s,false,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(i),a);e.MaterialHelper.PrepareDefinesForFrameBoundValues(s,u,a,n);if(e.MaterialHelper.PrepareDefinesForAttributes(i,a,false,true,false)){if(i){if(!s.getEngine().getCaps().standardDerivatives&&!i.isVerticesDataPresent(e.VertexBuffer.NormalKind)){i.createNormals(true);e.Tools.Warn("BackgroundMaterial: Normals have been created for the mesh: "+i.name)}}}if(a.isDirty){a.markAsProcessed();s.resetCachedMaterial();var c=new e.EffectFallbacks;if(a.FOG){c.addFallback(0,"FOG")}if(a.POINTSIZE){c.addFallback(1,"POINTSIZE")}e.MaterialHelper.HandleFallbacksForShadows(a,c,this._maxSimultaneousLights);if(a.NUM_BONE_INFLUENCERS>0){c.addCPUSkinningFallback(0,i)}var h=[e.VertexBuffer.PositionKind];if(a.NORMAL){h.push(e.VertexBuffer.NormalKind)}if(a.UV1){h.push(e.VertexBuffer.UVKind)}if(a.UV2){h.push(e.VertexBuffer.UV2Kind)}e.MaterialHelper.PrepareAttributesForBones(h,i,a,c);e.MaterialHelper.PrepareAttributesForInstances(h,a);var f=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","vClipPlane","mBones","vPrimaryColor","vSecondaryColor","vTertiaryColor","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix"];var d=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"];var p=["Material","Scene"];e.ImageProcessingConfiguration.PrepareUniforms(f,a);e.ImageProcessingConfiguration.PrepareSamplers(d,a);e.MaterialHelper.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:p,samplers:d,defines:a,maxSimultaneousLights:this._maxSimultaneousLights});var _=function(e){if(o.onCompiled){o.onCompiled(e)}o.bindSceneUniformBuffer(e,s.getSceneUniformBuffer())};var m=a.toString();r.setEffect(s.getEngine().createEffect("background",{attributes:h,uniformsNames:f,uniformBuffersNames:p,samplers:d,defines:m,fallbacks:c,onCompiled:_,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},u),a);this.buildUniformLayout()}if(!r.effect||!r.effect.isReady()){return false}a._renderId=s.getRenderId();this._wasPreviouslyReady=true;return true};r.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform("vPrimaryColor",4);this._uniformBuffer.addUniform("vSecondaryColor",4);this._uniformBuffer.addUniform("vTertiaryColor",4);this._uniformBuffer.addUniform("vDiffuseInfos",2);this._uniformBuffer.addUniform("vReflectionInfos",2);this._uniformBuffer.addUniform("diffuseMatrix",16);this._uniformBuffer.addUniform("reflectionMatrix",16);this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3);this._uniformBuffer.addUniform("fFovMultiplier",1);this._uniformBuffer.addUniform("pointSize",1);this._uniformBuffer.addUniform("shadowLevel",1);this._uniformBuffer.addUniform("alpha",1);this._uniformBuffer.addUniform("vBackgroundCenter",3);this._uniformBuffer.addUniform("vReflectionControl",4);this._uniformBuffer.create()};r.prototype.unbind=function(){if(this._diffuseTexture&&this._diffuseTexture.isRenderTarget){this._uniformBuffer.setTexture("diffuseSampler",null)}if(this._reflectionTexture&&this._reflectionTexture.isRenderTarget){this._uniformBuffer.setTexture("reflectionSampler",null)}i.prototype.unbind.call(this)};r.prototype.bindOnlyWorldMatrix=function(e){this._activeEffect.setMatrix("world",e)};r.prototype.bindForSubMesh=function(t,i,r){var n=this.getScene();var o=r._materialDefines;if(!o){return}var s=r.effect;if(!s){return}this._activeEffect=s;this.bindOnlyWorldMatrix(t);e.MaterialHelper.BindBonesParameters(i,this._activeEffect);var a=this._mustRebind(n,s,i.visibility);if(a){this._uniformBuffer.bindToEffect(s,"Material");this.bindViewProjection(s);var u=this._reflectionTexture;if(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync){if(n.texturesEnabled){if(this._diffuseTexture&&e.StandardMaterial.DiffuseTextureEnabled){this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level);e.MaterialHelper.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")}if(u&&e.StandardMaterial.ReflectionTextureEnabled){this._uniformBuffer.updateMatrix("reflectionMatrix",u.getReflectionTextureMatrix());this._uniformBuffer.updateFloat2("vReflectionInfos",u.level,this._reflectionBlur);this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",u.getSize().width,u.lodGenerationScale,u.lodGenerationOffset)}}if(this.shadowLevel>0){this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel)}this._uniformBuffer.updateFloat("alpha",this.alpha);if(this.pointsCloud){this._uniformBuffer.updateFloat("pointSize",this.pointSize)}this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,this._primaryLevel);this._uniformBuffer.updateColor4("vSecondaryColor",this._secondaryColor,this._secondaryLevel);this._uniformBuffer.updateColor4("vTertiaryColor",this._tertiaryColor,this._tertiaryLevel)}this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier);if(n.texturesEnabled){if(this._diffuseTexture&&e.StandardMaterial.DiffuseTextureEnabled){this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture)}if(u&&e.StandardMaterial.ReflectionTextureEnabled){if(o.REFLECTIONBLUR&&o.TEXTURELODSUPPORT){this._uniformBuffer.setTexture("reflectionSampler",u)}else if(!o.REFLECTIONBLUR){this._uniformBuffer.setTexture("reflectionSampler",u)}else{this._uniformBuffer.setTexture("reflectionSampler",u._lodTextureMid||u);this._uniformBuffer.setTexture("reflectionSamplerLow",u._lodTextureLow||u);this._uniformBuffer.setTexture("reflectionSamplerHigh",u._lodTextureHigh||u)}if(o.REFLECTIONFRESNEL){this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z);this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w)}}}e.MaterialHelper.BindClipPlane(this._activeEffect,n);e.MaterialHelper.BindEyePosition(s,n)}if(a||!this.isFrozen){if(n.lightsEnabled){e.MaterialHelper.BindLights(n,i,this._activeEffect,o,this._maxSimultaneousLights,false)}this.bindView(s);e.MaterialHelper.BindFogParameters(n,i,this._activeEffect);this._imageProcessingConfiguration.bind(this._activeEffect)}this._uniformBuffer.update();this._afterBind(i)};r.prototype.dispose=function(e,t){if(e===void 0){e=false}if(t===void 0){t=false}if(t){if(this.diffuseTexture){this.diffuseTexture.dispose()}if(this.reflectionTexture){this.reflectionTexture.dispose()}}this._renderTargets.dispose();if(this._imageProcessingConfiguration&&this._imageProcessingObserver){this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver)}i.prototype.dispose.call(this,e)};r.prototype.clone=function(t){var i=this;return e.SerializationHelper.Clone(function(){return new r(t,i.getScene())},this)};r.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);t.customType="BABYLON.BackgroundMaterial";return t};r.prototype.getClassName=function(){return"BackgroundMaterial"};r.Parse=function(t,i,n){return e.SerializationHelper.Parse(function(){return new r(t.name,i)},t,i,n)};r.StandardReflectance0=.05;r.StandardReflectance90=.5;__decorate([e.serializeAsColor3()],r.prototype,"_primaryColor",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsLightsDirty")],r.prototype,"primaryColor",void 0);__decorate([e.serialize()],r.prototype,"_primaryLevel",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsLightsDirty")],r.prototype,"primaryLevel",void 0);__decorate([e.serializeAsColor3()],r.prototype,"_secondaryColor",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsLightsDirty")],r.prototype,"secondaryColor",void 0);__decorate([e.serialize()],r.prototype,"_secondaryLevel",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsLightsDirty")],r.prototype,"secondaryLevel",void 0);__decorate([e.serializeAsColor3()],r.prototype,"_tertiaryColor",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsLightsDirty")],r.prototype,"tertiaryColor",void 0);__decorate([e.serialize()],r.prototype,"_tertiaryLevel",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsLightsDirty")],r.prototype,"tertiaryLevel",void 0);__decorate([e.serializeAsTexture()],r.prototype,"_reflectionTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionTexture",void 0);__decorate([e.serialize()],r.prototype,"_reflectionBlur",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionBlur",void 0);__decorate([e.serializeAsTexture()],r.prototype,"_diffuseTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"diffuseTexture",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"shadowLights",void 0);__decorate([e.serialize()],r.prototype,"_shadowBlurScale",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"shadowBlurScale",void 0);__decorate([e.serialize()],r.prototype,"_shadowLevel",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"shadowLevel",void 0);__decorate([e.serializeAsVector3()],r.prototype,"_sceneCenter",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"sceneCenter",void 0);__decorate([e.serialize()],r.prototype,"_opacityFresnel",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"opacityFresnel",void 0);__decorate([e.serialize()],r.prototype,"_reflectionFresnel",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionFresnel",void 0);__decorate([e.serialize()],r.prototype,"_reflectionFalloffDistance",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionFalloffDistance",void 0);__decorate([e.serialize()],r.prototype,"_reflectionAmount",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionAmount",void 0);__decorate([e.serialize()],r.prototype,"_reflectionReflectance0",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionReflectance0",void 0);__decorate([e.serialize()],r.prototype,"_reflectionReflectance90",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"reflectionReflectance90",void 0);__decorate([e.serialize()],r.prototype,"_useRGBColor",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"useRGBColor",void 0);__decorate([e.serialize()],r.prototype,"_enableNoise",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"enableNoise",void 0);__decorate([e.serialize()],r.prototype,"_maxSimultaneousLights",void 0);__decorate([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],r.prototype,"maxSimultaneousLights",void 0);__decorate([e.serializeAsImageProcessingConfiguration()],r.prototype,"_imageProcessingConfiguration",void 0);return r}(e.PushMaterial);e.BackgroundMaterial=i})(r||(r={}));"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++){t=arguments[i];for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n))e[n]=t[n]}return e};var r;(function(e){var t=function(){function t(i,r){var o=this;this._errorHandler=function(e,t){o.onErrorObservable.notifyObservers({message:e,exception:t})};this._options=n({},t._getDefaultOptions(),i);this._scene=r;this.onErrorObservable=new e.Observable;this._setupBackground();this._setupImageProcessing()}t._getDefaultOptions=function(){return{createGround:true,groundSize:15,groundTexture:this._groundTextureCDNUrl,groundColor:new e.Color3(.2,.2,.3).toLinearSpace().scale(3),groundOpacity:.9,enableGroundShadow:true,groundShadowLevel:.5,enableGroundMirror:false,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:e.Engine.TEXTURETYPE_UNSIGNED_INT,groundYBias:1e-5,createSkybox:true,skyboxSize:20,skyboxTexture:this._skyboxTextureCDNUrl,skyboxColor:new e.Color3(.2,.2,.3).toLinearSpace().scale(3),backgroundYRotation:0,sizeAuto:true,rootPosition:e.Vector3.Zero(),setupImageProcessing:true,environmentTexture:this._environmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:true}};Object.defineProperty(t.prototype,"rootMesh",{get:function(){return this._rootMesh},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"skybox",{get:function(){return this._skybox},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"skyboxTexture",{get:function(){return this._skyboxTexture},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"skyboxMaterial",{get:function(){return this._skyboxMaterial},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"ground",{get:function(){return this._ground},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"groundTexture",{get:function(){return this._groundTexture},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"groundMirror",{get:function(){return this._groundMirror},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"groundMirrorRenderList",{get:function(){if(this._groundMirror){return this._groundMirror.renderList}return null},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"groundMaterial",{get:function(){return this._groundMaterial},enumerable:true,configurable:true});t.prototype.updateOptions=function(e){var t=n({},this._options,e);if(this._ground&&!t.createGround){this._ground.dispose();this._ground=null}if(this._groundMaterial&&!t.createGround){this._groundMaterial.dispose();this._groundMaterial=null}if(this._groundTexture){if(this._options.groundTexture!=t.groundTexture){this._groundTexture.dispose();this._groundTexture=null}}if(this._skybox&&!t.createSkybox){this._skybox.dispose();this._skybox=null}if(this._skyboxMaterial&&!t.createSkybox){this._skyboxMaterial.dispose();this._skyboxMaterial=null}if(this._skyboxTexture){if(this._options.skyboxTexture!=t.skyboxTexture){this._skyboxTexture.dispose();this._skyboxTexture=null}}if(this._groundMirror&&!t.enableGroundMirror){this._groundMirror.dispose();this._groundMirror=null}if(this._scene.environmentTexture){if(this._options.environmentTexture!=t.environmentTexture){this._scene.environmentTexture.dispose()}}this._options=t;this._setupBackground();this._setupImageProcessing()};t.prototype.setMainColor=function(t){if(this.groundMaterial){this.groundMaterial.primaryColor=t}if(this.skyboxMaterial){this.skyboxMaterial.primaryColor=t}if(this.groundMirror){this.groundMirror.clearColor=new e.Color4(t.r,t.g,t.b,1)}};t.prototype._setupImageProcessing=function(){if(this._options.setupImageProcessing){this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast;this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure;this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled;this._setupEnvironmentTexture()}};t.prototype._setupEnvironmentTexture=function(){if(this._scene.environmentTexture){return}if(this._options.environmentTexture instanceof e.BaseTexture){this._scene.environmentTexture=this._options.environmentTexture;return}var t=e.CubeTexture.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=t};t.prototype._setupBackground=function(){if(!this._rootMesh){this._rootMesh=new e.Mesh("BackgroundHelper",this._scene)}this._rootMesh.rotation.y=this._options.backgroundYRotation;var t=this._getSceneSize();if(this._options.createGround){this._setupGround(t);this._setupGroundMaterial();this._setupGroundDiffuseTexture();if(this._options.enableGroundMirror){this._setupGroundMirrorTexture(t)}this._setupMirrorInGroundMaterial()}if(this._options.createSkybox){this._setupSkybox(t);this._setupSkyboxMaterial();this._setupSkyboxReflectionTexture()}this._rootMesh.position.x=t.rootPosition.x;this._rootMesh.position.z=t.rootPosition.z;this._rootMesh.position.y=t.rootPosition.y};t.prototype._getSceneSize=function(){var t=this;var i=this._options.groundSize;var r=this._options.skyboxSize;var n=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1){return{groundSize:i,skyboxSize:r,rootPosition:n}}var o=this._scene.getWorldExtends(function(e){return e!==t._ground&&e!==t._rootMesh&&e!==t._skybox});var s=o.max.subtract(o.min);if(this._options.sizeAuto){if(this._scene.activeCamera instanceof e.ArcRotateCamera&&this._scene.activeCamera.upperRadiusLimit){i=this._scene.activeCamera.upperRadiusLimit*2;r=i}var a=s.length();if(a>i){i=a*2;r=i}i*=1.1;r*=1.5;n=o.min.add(s.scale(.5));n.y=o.min.y-this._options.groundYBias}return{groundSize:i,skyboxSize:r,rootPosition:n}};t.prototype._setupGround=function(t){var i=this;if(!this._ground){this._ground=e.Mesh.CreatePlane("BackgroundPlane",t.groundSize,this._scene);this._ground.rotation.x=Math.PI/2;this._ground.parent=this._rootMesh
;this._ground.onDisposeObservable.add(function(){i._ground=null})}this._ground.receiveShadows=this._options.enableGroundShadow};t.prototype._setupGroundMaterial=function(){if(!this._groundMaterial){this._groundMaterial=new e.BackgroundMaterial("BackgroundPlaneMaterial",this._scene)}this._groundMaterial.alpha=this._options.groundOpacity;this._groundMaterial.alphaMode=e.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;this._groundMaterial.shadowLevel=this._options.groundShadowLevel;this._groundMaterial.primaryLevel=1;this._groundMaterial.primaryColor=this._options.groundColor;this._groundMaterial.secondaryLevel=0;this._groundMaterial.tertiaryLevel=0;this._groundMaterial.useRGBColor=false;this._groundMaterial.enableNoise=true;if(this._ground){this._ground.material=this._groundMaterial}};t.prototype._setupGroundDiffuseTexture=function(){if(!this._groundMaterial){return}if(this._groundTexture){return}if(this._options.groundTexture instanceof e.BaseTexture){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}var t=new e.Texture(this._options.groundTexture,this._scene,undefined,undefined,undefined,undefined,this._errorHandler);t.gammaSpace=false;t.hasAlpha=true;this._groundMaterial.diffuseTexture=t};t.prototype._setupGroundMirrorTexture=function(t){var i=e.Texture.CLAMP_ADDRESSMODE;if(!this._groundMirror){this._groundMirror=new e.MirrorTexture("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,false,this._options.groundMirrorTextureType,e.Texture.BILINEAR_SAMPLINGMODE,true);this._groundMirror.mirrorPlane=new e.Plane(0,-1,0,t.rootPosition.y);this._groundMirror.anisotropicFilteringLevel=1;this._groundMirror.wrapU=i;this._groundMirror.wrapV=i;this._groundMirror.gammaSpace=false;if(this._groundMirror.renderList){for(var r=0;r<this._scene.meshes.length;r++){var n=this._scene.meshes[r];if(n!==this._ground&&n!==this._skybox&&n!==this._rootMesh){this._groundMirror.renderList.push(n)}}}}this._groundMirror.clearColor=new e.Color4(this._options.groundColor.r,this._options.groundColor.g,this._options.groundColor.b,1);this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel};t.prototype._setupMirrorInGroundMaterial=function(){if(this._groundMaterial){this._groundMaterial.reflectionTexture=this._groundMirror;this._groundMaterial.reflectionFresnel=true;this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount;this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight;this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance}};t.prototype._setupSkybox=function(t){var i=this;if(!this._skybox){this._skybox=e.Mesh.CreateBox("BackgroundSkybox",t.skyboxSize,this._scene,undefined,e.Mesh.BACKSIDE);this._skybox.onDisposeObservable.add(function(){i._skybox=null})}this._skybox.parent=this._rootMesh};t.prototype._setupSkyboxMaterial=function(){if(!this._skybox){return}if(!this._skyboxMaterial){this._skyboxMaterial=new e.BackgroundMaterial("BackgroundSkyboxMaterial",this._scene)}this._skyboxMaterial.useRGBColor=false;this._skyboxMaterial.primaryLevel=1;this._skyboxMaterial.primaryColor=this._options.skyboxColor;this._skyboxMaterial.secondaryLevel=0;this._skyboxMaterial.tertiaryLevel=0;this._skyboxMaterial.enableNoise=true;this._skybox.material=this._skyboxMaterial};t.prototype._setupSkyboxReflectionTexture=function(){if(!this._skyboxMaterial){return}if(this._skyboxTexture){return}if(this._options.skyboxTexture instanceof e.BaseTexture){this._skyboxMaterial.reflectionTexture=this._skyboxTexture;return}this._skyboxTexture=new e.CubeTexture(this._options.skyboxTexture,this._scene,undefined,undefined,undefined,undefined,this._errorHandler);this._skyboxTexture.coordinatesMode=e.Texture.SKYBOX_MODE;this._skyboxTexture.gammaSpace=false;this._skyboxMaterial.reflectionTexture=this._skyboxTexture};t.prototype.dispose=function(){if(this._groundMaterial){this._groundMaterial.dispose(true,true)}if(this._skyboxMaterial){this._skyboxMaterial.dispose(true,true)}this._rootMesh.dispose(false)};t._groundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png";t._skyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds";t._environmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.dds";return t}();e.EnvironmentHelper=t})(r||(r={}));"use strict";var r;(function(e){var t=function(t){__extends(i,t);function i(i,r,n,o){var s=t.call(this,i,o)||this;i=i||"videoDome";n.resolution=Math.abs(n.resolution)|0||12;n.clickToPlay=Boolean(n.clickToPlay);n.autoPlay=n.autoPlay===undefined?true:Boolean(n.autoPlay);n.loop=n.loop===undefined?true:Boolean(n.loop);n.size=Math.abs(n.size)||(o.activeCamera?o.activeCamera.maxZ*.48:1e3);var a={loop:n.loop,autoPlay:n.autoPlay,autoUpdateTexture:true};var u=s._material=new e.BackgroundMaterial(i+"_material",o);var l=s._videoTexture=new e.VideoTexture(i+"_texture",r,o,false,false,e.Texture.TRILINEAR_SAMPLINGMODE,a);s._mesh=e.MeshBuilder.CreateIcoSphere(i+"_mesh",{flat:false,radius:n.size,subdivisions:n.resolution,sideOrientation:e.Mesh.BACKSIDE},o);l.coordinatesMode=e.Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE;l.wrapV=e.Texture.CLAMP_ADDRESSMODE;u.reflectionTexture=s._videoTexture;u.useEquirectangularFOV=true;u.fovMultiplier=1;s._mesh.material=u;s._mesh.parent=s;if(n.clickToPlay){o.onPointerUp=function(){s._videoTexture.video.play()}}return s}Object.defineProperty(i.prototype,"fovMultiplier",{get:function(){return this._material.fovMultiplier},set:function(e){this._material.fovMultiplier=e},enumerable:true,configurable:true});i.prototype.dispose=function(e,i){if(i===void 0){i=false}this._videoTexture.dispose();this._mesh.dispose();this._material.dispose();t.prototype.dispose.call(this,e,i)};return i}(e.Node);e.VideoDome=t})(r||(r={}));r.Effect.ShadersStore={defaultVertexShader:"#include<__decl__defaultVertex>\n\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0\nvarying vec2 vDiffuseUV;\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nvarying vec2 vAmbientUV;\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nvarying vec2 vOpacityUV;\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nvarying vec2 vEmissiveUV;\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nvarying vec2 vLightmapUV;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM) && SPECULARDIRECTUV == 0\nvarying vec2 vSpecularUV;\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nvarying vec2 vBumpUV;\n#endif\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL \nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif \n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0\nif (vDiffuseInfos.x == 0.)\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nif (vAmbientInfos.x == 0.)\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nif (vOpacityInfos.x == 0.)\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nif (vEmissiveInfos.x == 0.)\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nif (vLightmapInfos.x == 0.)\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM) && SPECULARDIRECTUV == 0\nif (vSpecularInfos.x == 0.)\n{\nvSpecularUV=vec2(specularMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvSpecularUV=vec2(specularMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nif (vBumpInfos.x == 0.)\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\n\nvColor=color;\n#endif\n#include<pointCloudVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n",defaultPixelShader:"#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define RECIPROCAL_PI2 0.15915494\nuniform vec3 vEyePosition;\nuniform vec3 vAmbientColor;\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n\n#include<helperFunctions>\n\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV == 1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV == 2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef AMBIENT\n#if AMBIENTDIRECTUV == 1\n#define vAmbientUV vMainUV1\n#elif AMBIENTDIRECTUV == 2\n#define vAmbientUV vMainUV2\n#else\nvarying vec2 vAmbientUV;\n#endif\nuniform sampler2D ambientSampler;\n#endif\n#ifdef OPACITY \n#if OPACITYDIRECTUV == 1\n#define vOpacityUV vMainUV1\n#elif OPACITYDIRECTUV == 2\n#define vOpacityUV vMainUV2\n#else\nvarying vec2 vOpacityUV;\n#endif\nuniform sampler2D opacitySampler;\n#endif\n#ifdef EMISSIVE\n#if EMISSIVEDIRECTUV == 1\n#define vEmissiveUV vMainUV1\n#elif EMISSIVEDIRECTUV == 2\n#define vEmissiveUV vMainUV2\n#else\nvarying vec2 vEmissiveUV;\n#endif\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef LIGHTMAP\n#if LIGHTMAPDIRECTUV == 1\n#define vLightmapUV vMainUV1\n#elif LIGHTMAPDIRECTUV == 2\n#define vLightmapUV vMainUV2\n#else\nvarying vec2 vLightmapUV;\n#endif\nuniform sampler2D lightmapSampler;\n#endif\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\n#if SPECULARDIRECTUV == 1\n#define vSpecularUV vMainUV1\n#elif SPECULARDIRECTUV == 2\n#define vSpecularUV vMainUV2\n#else\nvarying vec2 vSpecularUV;\n#endif\nuniform sampler2D specularSampler;\n#endif\n\n#include<fresnelFunction>\n\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition-vPositionW);\n\nvec4 baseColor=vec4(1.,1.,1.,1.);\nvec3 diffuseColor=vDiffuseColor.rgb;\n\nfloat alpha=vDiffuseColor.a;\n\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#include<depthPrePass>\n#ifdef VERTEXCOLOR\nbaseColor.rgb*=vColor.rgb;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\n\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\n\n#ifdef SPECULARTERM\nfloat glossiness=vSpecularColor.a;\nvec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);\nspecularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#else\nfloat glossiness=0.;\n#endif\n\nvec3 diffuseBase=vec3(0.,0.,0.);\nlightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;\n#ifdef LIGHTMAP\nvec3 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset).rgb*vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\n\nvec3 refractionColor=vec3(0.,0.,0.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nif (dot(refractionVector,viewDirectionW)<1.0)\n{\nrefractionColor=textureCube(refractionCubeSampler,refractionVector).rgb*vRefractionInfos.x;\n}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\nrefractionColor=texture2D(refraction2DSampler,refractionCoords).rgb*vRefractionInfos.x;\n#endif\n#endif\n\nvec3 reflectionColor=vec3(0.,0.,0.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias).rgb*vReflectionInfos.x;\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW).rgb*vReflectionInfos.x;\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;\nreflectionColor=texture2D(reflection2DSampler,coords).rgb*vReflectionInfos.x;\n#endif\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);\nrefractionColor*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);\nalpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#ifdef VERTEXALPHA\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);\nalpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);\nemissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);\ndiffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor+emissiveColor+refractionColor,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor+refractionColor,alpha);\n#endif\n\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor;\n#else\ncolor.rgb+=lightmapColor;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor.rgb=max(color.rgb,0.);\n#include<logDepthFragment>\n#include<fogFragment>\n\n\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);\ncolor=applyImageProcessing(color);\n#endif\n#endif\n#ifdef PREMULTIPLYALPHA\n\ncolor.rgb*=color.a;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\ngl_FragColor=color;\n}\n",pbrVertexShader:"precision highp float;\n#include<__decl__pbrVertex>\n\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2; \n#endif \n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\n#if defined(ALBEDO) && ALBEDODIRECTUV == 0\nvarying vec2 vAlbedoUV;\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nvarying vec2 vAmbientUV;\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nvarying vec2 vOpacityUV;\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nvarying vec2 vEmissiveUV;\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nvarying vec2 vLightmapUV;\n#endif\n#if defined(REFLECTIVITY) && REFLECTIVITYDIRECTUV == 0\nvarying vec2 vReflectivityUV;\n#endif\n#if defined(MICROSURFACEMAP) && MICROSURFACEMAPDIRECTUV == 0\nvarying vec2 vMicroSurfaceSamplerUV;\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nvarying vec2 vBumpUV;\n#endif\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\nvoid main(void) {\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif \n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=environmentIrradianceJones(reflectionVector);\n#endif\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif \n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif \n#if defined(ALBEDO) && ALBEDODIRECTUV == 0 \nif (vAlbedoInfos.x == 0.)\n{\nvAlbedoUV=vec2(albedoMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0 \nif (vAmbientInfos.x == 0.)\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0 \nif (vOpacityInfos.x == 0.)\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0 \nif (vEmissiveInfos.x == 0.)\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0 \nif (vLightmapInfos.x == 0.)\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(REFLECTIVITY) && REFLECTIVITYDIRECTUV == 0 \nif (vReflectivityInfos.x == 0.)\n{\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(MICROSURFACEMAP) && MICROSURFACEMAPDIRECTUV == 0 \nif (vMicroSurfaceSamplerInfos.x == 0.)\n{\nvMicroSurfaceSamplerUV=vec2(microSurfaceSamplerMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvMicroSurfaceSamplerUV=vec2(microSurfaceSamplerMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0 \nif (vBumpInfos.x == 0.)\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n\n#include<bumpVertex>\n\n#include<clipPlaneVertex>\n\n#include<fogVertex>\n\n#include<shadowsVertex>[0..maxSimultaneousLights]\n\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n\n#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif\n\n#include<logDepthVertex>\n}",
pbrPixelShader:"#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(GEOMETRYAA)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nprecision highp float;\n#include<__decl__pbrFragment>\nuniform vec4 vEyePosition;\nuniform vec3 vAmbientColor;\nuniform vec4 vCameraInfos;\n\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2;\n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#endif\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n\n#ifdef ALBEDO\n#if ALBEDODIRECTUV == 1\n#define vAlbedoUV vMainUV1\n#elif ALBEDODIRECTUV == 2\n#define vAlbedoUV vMainUV2\n#else\nvarying vec2 vAlbedoUV;\n#endif\nuniform sampler2D albedoSampler;\n#endif\n#ifdef AMBIENT\n#if AMBIENTDIRECTUV == 1\n#define vAmbientUV vMainUV1\n#elif AMBIENTDIRECTUV == 2\n#define vAmbientUV vMainUV2\n#else\nvarying vec2 vAmbientUV;\n#endif\nuniform sampler2D ambientSampler;\n#endif\n#ifdef OPACITY\n#if OPACITYDIRECTUV == 1\n#define vOpacityUV vMainUV1\n#elif OPACITYDIRECTUV == 2\n#define vOpacityUV vMainUV2\n#else\nvarying vec2 vOpacityUV;\n#endif\nuniform sampler2D opacitySampler;\n#endif\n#ifdef EMISSIVE\n#if EMISSIVEDIRECTUV == 1\n#define vEmissiveUV vMainUV1\n#elif EMISSIVEDIRECTUV == 2\n#define vEmissiveUV vMainUV2\n#else\nvarying vec2 vEmissiveUV;\n#endif\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef LIGHTMAP\n#if LIGHTMAPDIRECTUV == 1\n#define vLightmapUV vMainUV1\n#elif LIGHTMAPDIRECTUV == 2\n#define vLightmapUV vMainUV2\n#else\nvarying vec2 vLightmapUV;\n#endif\nuniform sampler2D lightmapSampler;\n#endif\n#ifdef REFLECTIVITY\n#if REFLECTIVITYDIRECTUV == 1\n#define vReflectivityUV vMainUV1\n#elif REFLECTIVITYDIRECTUV == 2\n#define vReflectivityUV vMainUV2\n#else\nvarying vec2 vReflectivityUV;\n#endif\nuniform sampler2D reflectivitySampler;\n#endif\n#ifdef MICROSURFACEMAP\n#if MICROSURFACEMAPDIRECTUV == 1\n#define vMicroSurfaceSamplerUV vMainUV1\n#elif MICROSURFACEMAPDIRECTUV == 2\n#define vMicroSurfaceSamplerUV vMainUV2\n#else\nvarying vec2 vMicroSurfaceSamplerUV;\n#endif\nuniform sampler2D microSurfaceSampler;\n#endif\n\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\n#define sampleRefraction(s,c) textureCube(s,c)\nuniform samplerCube refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;\nuniform samplerCube refractionSamplerHigh;\n#endif\n#else\n#define sampleRefraction(s,c) texture2D(s,c)\nuniform sampler2D refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;\nuniform samplerCube refractionSamplerHigh;\n#endif\n#endif\n#endif\n\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n\n#include<shadowsFragmentFunctions>\n#include<pbrFunctions>\n#include<harmonicsFunctions>\n#include<pbrLightFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n\n#include<fogFragmentDeclaration>\nvoid main(void) {\n#include<clipPlaneFragment>\n\n\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#endif\n#ifdef GEOMETRYAA\nvec3 nDfdx=dFdx(normalW.xyz);\nvec3 nDfdy=dFdy(normalW.xyz);\nfloat slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));\n\nfloat geometricRoughnessFactor=pow(clamp(slopeSquare ,0.,1.),0.333);\n\nfloat geometricAlphaGFactor=sqrt(slopeSquare);\n#else\nfloat geometricRoughnessFactor=0.;\n#endif\n#include<bumpFragment>\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n\n\nvec3 surfaceAlbedo=vAlbedoColor.rgb;\n\nfloat alpha=vAlbedoColor.a;\n#ifdef ALBEDO\nvec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\nsurfaceAlbedo*=toLinearSpace(albedoTexture.rgb);\nsurfaceAlbedo*=vAlbedoInfos.y;\n#endif\n\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#ifdef VERTEXALPHA\nalpha*=vColor.a;\n#endif\n#if !defined(LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\n\nalpha=1.0;\n#endif\n#endif\n#endif\n#include<depthPrePass>\n#ifdef VERTEXCOLOR\nsurfaceAlbedo*=vColor.rgb;\n#endif\n\nvec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#endif\n#ifdef UNLIT\nvec3 diffuseBase=vec3(1.,1.,1.);\n#else\n\nfloat microSurface=vReflectivityColor.a;\nvec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\nvec4 surfaceMetallicColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\n#ifdef AOSTOREINMETALMAPRED\nvec3 aoStoreInMetalMap=vec3(surfaceMetallicColorMap.r,surfaceMetallicColorMap.r,surfaceMetallicColorMap.r);\nambientOcclusionColor=mix(ambientOcclusionColor,aoStoreInMetalMap,vReflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicColorMap.g;\n#endif\n#endif\n#endif\n#ifdef MICROSURFACEMAP\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n\nmicroSurface=1.0-metallicRoughness.g;\n\nvec3 baseColor=surfaceAlbedo;\n\n\nconst vec3 DefaultSpecularReflectanceDielectric=vec3(0.04,0.04,0.04);\n\nsurfaceAlbedo=mix(baseColor.rgb*(1.0-DefaultSpecularReflectanceDielectric.r),vec3(0.,0.,0.),metallicRoughness.r);\n\nsurfaceReflectivityColor=mix(DefaultSpecularReflectanceDielectric,baseColor,metallicRoughness.r);\n#else\n#ifdef REFLECTIVITY\nvec4 surfaceReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\nsurfaceReflectivityColor*=toLinearSpace(surfaceReflectivityColorMap.rgb);\nsurfaceReflectivityColor*=vReflectivityInfos.y;\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceReflectivityColorMap.a;\nmicroSurface*=vReflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#endif\n#endif\n#endif\n\nmicroSurface=clamp(microSurface,0.,1.);\n\nfloat roughness=1.-microSurface;\n\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\n\n\n\nfloat opacityPerceptual=alpha;\n#ifdef LINEARALPHAFRESNEL\nfloat opacity0=opacityPerceptual;\n#else\nfloat opacity0=opacityPerceptual*opacityPerceptual;\n#endif\nfloat opacity90=fresnelGrazingReflectance(opacity0);\nvec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);\n\nalpha=fresnelSchlickEnvironmentGGX(clamp(dot(viewDirectionW,normalForward),0.0,1.0),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\n\nalpha=1.0;\n#endif\n#endif\n#endif\n#endif\n\n\nfloat NdotVUnclamped=dot(normalW,viewDirectionW);\nfloat NdotV=clamp(NdotVUnclamped,0.,1.)+0.00001;\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\n#ifdef GEOMETRYAA\n\n\nalphaG+=(0.75*geometricAlphaGFactor);\n#endif\n\n#ifdef REFRACTION\nvec3 environmentRefraction=vec3(0.,0.,0.);\nvec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);\n#ifdef REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n\n#ifdef REFRACTIONMAP_3D\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nvec3 refractionCoords=refractionVector;\nrefractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef LODINREFRACTIONALPHA\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#else\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,alphaG,1.0);\n#endif\n#ifdef LODBASEDMICROSFURACE\n\nrefractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef LODINREFRACTIONALPHA\n\n\n\n\n\n\n\n\n\nfloat automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);\nfloat requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);\n#else\nfloat requestedRefractionLOD=refractionLOD;\n#endif\nenvironmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD).rgb;\n#else\nfloat lodRefractionNormalized=clamp(refractionLOD/log2(vRefractionMicrosurfaceInfos.x),0.,1.);\nfloat lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;\nvec3 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords).rgb;\nif(lodRefractionNormalizedDoubled<1.0){\nenvironmentRefraction=mix(\nsampleRefraction(refractionSamplerHigh,refractionCoords).rgb,\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);\n}else{\nenvironmentRefraction=mix(\nenvironmentRefractionMid,\nsampleRefraction(refractionSamplerLow,refractionCoords).rgb,\nlodRefractionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef GAMMAREFRACTION\nenvironmentRefraction=toLinearSpace(environmentRefraction.rgb);\n#endif\n\nenvironmentRefraction*=vRefractionInfos.x;\n#endif\n\n#ifdef REFLECTION\nvec3 environmentRadiance=vec3(0.,0.,0.);\nvec3 environmentIrradiance=vec3(0.,0.,0.);\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,1.);\n#endif\n#ifdef LODBASEDMICROSFURACE\n\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\n\n\n\n\n\n\n\n\n\nfloat automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);\nfloat requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);\n#else\nfloat requestedReflectionLOD=reflectionLOD;\n#endif\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,requestedReflectionLOD).rgb;\n#else\nfloat lodReflectionNormalized=clamp(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x),0.,1.);\nfloat lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;\nvec3 environmentSpecularMid=sampleReflection(reflectionSampler,reflectionCoords).rgb;\nif(lodReflectionNormalizedDoubled<1.0){\nenvironmentRadiance=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords).rgb,\nenvironmentSpecularMid,\nlodReflectionNormalizedDoubled\n);\n}else{\nenvironmentRadiance=mix(\nenvironmentSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords).rgb,\nlodReflectionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance=toLinearSpace(environmentRadiance.rgb);\n#endif\n\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\nenvironmentIrradiance=environmentIrradianceJones(irradianceVector);\n#endif\n#endif\n\nenvironmentRadiance*=vReflectionInfos.x;\nenvironmentRadiance*=vReflectionColor.rgb;\nenvironmentIrradiance*=vReflectionColor.rgb;\n#endif\n\n\n\nfloat reflectance=max(max(surfaceReflectivityColor.r,surfaceReflectivityColor.g),surfaceReflectivityColor.b);\nfloat reflectance90=fresnelGrazingReflectance(reflectance);\nvec3 specularEnvironmentR0=surfaceReflectivityColor.rgb;\nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0)*reflectance90;\n\nvec3 diffuseBase=vec3(0.,0.,0.);\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\n#ifdef LIGHTMAP\nvec3 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset).rgb;\n#ifdef GAMMALIGHTMAP\nlightmapColor=toLinearSpace(lightmapColor);\n#endif\nlightmapColor*=vLightmapInfos.y;\n#endif\nlightingInfo info;\nfloat shadow=1.; \nfloat NdotL=-1.;\n#include<lightFragment>[0..maxSimultaneousLights]\n\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n\nvec2 brdfSamplerUV=vec2(NdotV,roughness);\n\nvec4 environmentBrdf=texture2D(environmentBrdfSampler,brdfSamplerUV);\nvec3 specularEnvironmentReflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nfloat ambientMonochrome=ambientOcclusionColor.r;\n#else\nfloat ambientMonochrome=getLuminance(ambientOcclusionColor);\n#endif\nfloat seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\nspecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat eho=environmentHorizonOcclusion(reflectionCoords,normalW);\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\n\nvec3 specularEnvironmentReflectance=fresnelSchlickEnvironmentGGX(NdotV,specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n\n#ifdef REFRACTION\nvec3 refractance=vec3(0.0,0.0,0.0);\nvec3 transmission=vec3(1.0,1.0,1.0);\n#ifdef LINKREFRACTIONTOTRANSPARENCY\n\ntransmission*=(1.0-alpha);\n\n\nvec3 mixedAlbedo=surfaceAlbedo;\nfloat maxChannel=max(max(mixedAlbedo.r,mixedAlbedo.g),mixedAlbedo.b);\nvec3 tint=clamp(maxChannel*mixedAlbedo,0.0,1.0);\n\nsurfaceAlbedo*=alpha;\n\nenvironmentIrradiance*=alpha;\n\nenvironmentRefraction*=tint;\n\nalpha=1.0;\n#endif\n\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);\nspecularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,alpha);\n\ntransmission*=1.0-specularEnvironmentReflectance;\n\nrefractance=transmission;\n#endif\n\n\n\n\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\n\n#ifdef REFLECTION\nvec3 finalIrradiance=environmentIrradiance;\nfinalIrradiance*=surfaceAlbedo.rgb;\n#endif\n\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase;\nfinalSpecular=max(finalSpecular,0.0);\n\nvec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;\n#endif\n\n#ifdef REFLECTION\nvec3 finalRadiance=environmentRadiance;\nfinalRadiance*=specularEnvironmentReflectance;\n\nvec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;\n#endif\n\n#ifdef REFRACTION\nvec3 finalRefraction=environmentRefraction;\nfinalRefraction*=refractance;\n#endif\n\n#ifdef ALPHABLEND\nfloat luminanceOverAlpha=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA)\nalpha=clamp(alpha+luminanceOverAlpha*luminanceOverAlpha,0.,1.);\n#endif\n#endif\n#endif\n\nvec3 finalDiffuse=diffuseBase;\nfinalDiffuse.rgb+=vAmbientColor;\nfinalDiffuse*=surfaceAlbedo.rgb;\nfinalDiffuse=max(finalDiffuse,0.0);\n\nvec3 finalEmissive=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\nfinalEmissive*=toLinearSpace(emissiveColorTex.rgb);\nfinalEmissive*=vEmissiveInfos.y;\n#endif\n\n\n\nvec4 finalColor=vec4(\nfinalDiffuse*ambientOcclusionColor*vLightingIntensity.x +\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance*ambientOcclusionColor*vLightingIntensity.z +\n#endif\n#ifdef SPECULARTERM\n\n\nfinalSpecularScaled +\n#endif\n#ifdef REFLECTION\n\n\nfinalRadianceScaled +\n#endif\n#ifdef REFRACTION\nfinalRefraction*vLightingIntensity.z +\n#endif\n#endif\nfinalEmissive*vLightingIntensity.y,\nalpha);\n\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor;\n#else\nfinalColor.rgb+=lightmapColor;\n#endif\n#endif\n#endif\n\nfinalColor=max(finalColor,0.0);\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n\n\nfinalColor.rgb=clamp(finalColor.rgb,0.,30.0);\n#else\n\nfinalColor=applyImageProcessing(finalColor);\n#endif\n#ifdef PREMULTIPLYALPHA\n\nfinalColor.rgb*=finalColor.a;\n#endif\ngl_FragColor=finalColor;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n}",spritesVertexShader:"\nattribute vec4 position;\nattribute vec4 options;\nattribute vec4 cellInfo;\nattribute vec4 color;\n\nuniform vec2 textureInfos;\nuniform mat4 view;\nuniform mat4 projection;\n\nvarying vec2 vUV;\nvarying vec4 vColor;\n#include<fogVertexDeclaration>\nvoid main(void) { \nvec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; \nvec2 cornerPos;\nfloat angle=position.w;\nvec2 size=vec2(options.x,options.y);\nvec2 offset=options.zw;\nvec2 uvScale=textureInfos.xy;\ncornerPos=vec2(offset.x-0.5,offset.y-0.5)*size;\n\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\n\nviewPos+=rotatedCorner;\ngl_Position=projection*vec4(viewPos,1.0); \n\nvColor=color;\n\nvec2 uvOffset=vec2(abs(offset.x-cellInfo.x),1.0-abs(offset.y-cellInfo.y));\nvUV=(uvOffset+cellInfo.zw)*uvScale;\n\n#ifdef FOG\nvFogDistance=viewPos;\n#endif\n}",spritesPixelShader:"uniform bool alphaTest;\nvarying vec4 vColor;\n\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n\n#include<fogFragmentDeclaration>\nvoid main(void) {\nvec4 color=texture2D(diffuseSampler,vUV);\nif (alphaTest) \n{\nif (color.a<0.95)\ndiscard;\n}\ncolor*=vColor;\n#include<fogFragment>\ngl_FragColor=color;\n}",particlesVertexShader:"\nattribute vec3 position;\nattribute vec4 color;\nattribute vec4 options;\nattribute float cellIndex;\n\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec3 particlesInfos; \n\nvarying vec2 vUV;\nvarying vec4 vColor;\n#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nuniform mat4 invView;\nvarying float fClipDistance;\n#endif\nvoid main(void) { \nvec3 viewPos=(view*vec4(position,1.0)).xyz; \nvec3 cornerPos;\nfloat size=options.y;\nfloat angle=options.x;\nvec2 offset=options.zw;\ncornerPos=vec3(offset.x-0.5,offset.y-0.5,0.)*size;\n\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\n\nviewPos+=rotatedCorner;\ngl_Position=projection*vec4(viewPos,1.0); \nvColor=color;\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex/particlesInfos.z);\nfloat columnOffset=cellIndex-rowOffset*particlesInfos.z;\nvec2 uvScale=particlesInfos.xy;\nvec2 uvOffset=vec2(offset.x ,1.0-offset.y);\nvUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=offset;\n#endif\n\n#ifdef CLIPPLANE\nvec4 worldPos=invView*vec4(viewPos,1.0);\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n}",particlesPixelShader:"\nvarying vec2 vUV;\nvarying vec4 vColor;\nuniform vec4 textureMask;\nuniform sampler2D diffuseSampler;\n#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\nvoid main(void) {\n#ifdef CLIPPLANE\nif (fClipDistance>0.0)\ndiscard;\n#endif\nvec4 baseColor=texture2D(diffuseSampler,vUV);\ngl_FragColor=(baseColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;\n}",gpuRenderParticlesVertexShader:"#version 300 es\nuniform vec4 colorDead;\nuniform mat4 view;\nuniform mat4 projection;\n\nin vec3 position;\nin float age;\nin float life;\nin float size;\nin vec4 color;\nin vec2 offset;\nin vec2 uv;\nout vec2 vUV;\nout vec4 vColor;\n#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nuniform mat4 invView;\nout float fClipDistance;\n#endif\nvoid main() {\nvUV=uv;\nfloat ratio=age/life;\nvColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);\n\nvec4 viewPosition=view*vec4(position,1.0);\ngl_Position=projection*(viewPosition+vec4(offset*size,0.,0.));\n\n#ifdef CLIPPLANE\nvec4 worldPos=invView*viewPosition;\nfClipDistance=dot(worldPos,vClipPlane);\n#endif \n}",gpuRenderParticlesPixelShader:"#version 300 es\nuniform sampler2D textureSampler;\nin vec2 vUV;\nin vec4 vColor;\nout vec4 outFragColor;\n#ifdef CLIPPLANE\nin float fClipDistance;\n#endif\nvoid main() {\n#ifdef CLIPPLANE\nif (fClipDistance>0.0)\ndiscard;\n#endif \noutFragColor=texture(textureSampler,vUV)*vColor;\n}\n",gpuUpdateParticlesVertexShader:"#version 300 es\n#define PI 3.14159\nuniform float currentCount;\nuniform float timeDelta;\nuniform float stopFactor;\nuniform vec3 generalRandoms;\nuniform mat4 emitterWM;\nuniform vec2 lifeTime;\nuniform vec2 emitPower;\nuniform vec2 sizeRange;\nuniform vec4 color1;\nuniform vec4 color2;\nuniform vec3 gravity;\nuniform sampler2D randomSampler;\n#ifdef BOXEMITTER\nuniform vec3 direction1;\nuniform vec3 direction2;\nuniform vec3 minEmitBox;\nuniform vec3 maxEmitBox;\n#endif\n#ifdef SPHEREEMITTER\nuniform float radius;\n#ifdef DIRECTEDSPHEREEMITTER\nuniform vec3 direction1;\nuniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\n#ifdef CONEEMITTER\nuniform float radius;\nuniform float angle;\nuniform float height;\nuniform float directionRandomizer;\n#endif\n\nin vec3 position;\nin float age;\nin float life;\nin float seed;\nin float size;\nin vec4 color;\nin vec3 direction;\n\nout vec3 outPosition;\nout float outAge;\nout float outLife;\nout float outSeed;\nout float outSize;\nout vec4 outColor;\nout vec3 outDirection;\nvec3 getRandomVec3(float offset) {\nreturn texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;\n}\nvec4 getRandomVec4(float offset) {\nreturn texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));\n}\nvoid main() {\nif (age>=life) {\nif (stopFactor == 0.) {\noutPosition=position;\noutAge=life;\noutLife=life;\noutSeed=seed;\noutColor=vec4(0.,0.,0.,0.);\noutSize=0.;\noutDirection=direction;\nreturn;\n}\nvec3 position;\nvec3 direction;\n\nvec4 randoms=getRandomVec4(generalRandoms.x);\n\noutAge=0.0;\noutLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;\n\noutSeed=seed;\n\noutSize=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;\n\noutColor=color1+(color2-color1)*randoms.b;\n\n#ifdef BOXEMITTER\nvec3 randoms2=getRandomVec3(generalRandoms.y);\nvec3 randoms3=getRandomVec3(generalRandoms.z);\nposition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;\ndirection=direction1+(direction2-direction1)*randoms3;\n#elif defined(SPHEREEMITTER)\nvec3 randoms2=getRandomVec3(generalRandoms.y);\nvec3 randoms3=getRandomVec3(generalRandoms.z);\n\nfloat phi=2.0*PI*randoms2.x;\nfloat theta=PI*randoms2.y;\nfloat randX=cos(phi)*sin(theta);\nfloat randY=cos(theta);\nfloat randZ=sin(phi)*sin(theta);\nposition=(radius*randoms2.z)*vec3(randX,randY,randZ);\n#ifdef DIRECTEDSPHEREEMITTER\ndirection=direction1+(direction2-direction1)*randoms3;\n#else\n\ndirection=position+directionRandomizer*randoms3;\n#endif\n#elif defined(CONEEMITTER)\nvec3 randoms2=getRandomVec3(generalRandoms.y);\nfloat s=2.0*PI*randoms2.x;\nfloat h=randoms2.y;\n\nh=1.-h*h;\nfloat lRadius=radius*randoms2.z;\nlRadius=lRadius*h;\nfloat randX=lRadius*sin(s);\nfloat randZ=lRadius*cos(s);\nfloat randY=h*height;\nposition=vec3(randX,randY,randZ); \n\nif (angle == 0.) {\ndirection=vec3(0.,1.0,0.);\n} else {\nvec3 randoms3=getRandomVec3(generalRandoms.z);\ndirection=position+directionRandomizer*randoms3;\n}\n#else \n\nposition=vec3(0.,0.,0.);\n\ndirection=2.0*(getRandomVec3(seed)-vec3(0.5,0.5,0.5));\n#endif\nfloat power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;\noutPosition=(emitterWM*vec4(position,1.)).xyz;\noutDirection=(emitterWM*vec4(direction*power,0.)).xyz;\n} else { \noutPosition=position+direction*timeDelta;\noutAge=age+timeDelta;\noutLife=life;\noutSeed=seed;\noutColor=color;\noutSize=size;\noutDirection=direction+gravity*timeDelta;\n}\n}",gpuUpdateParticlesPixelShader:"#version 300 es\nvoid main() {\ndiscard;\n}\n",colorVertexShader:"\nattribute vec3 position;\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n\nuniform mat4 viewProjection;\nuniform mat4 world;\n\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\nvoid main(void) {\nmat4 finalWorld=world;\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#ifdef VERTEXCOLOR\n\nvColor=color;\n#endif\n}",colorPixelShader:"#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#else\nuniform vec4 color;\n#endif\nvoid main(void) {\n#ifdef VERTEXCOLOR\ngl_FragColor=vColor;\n#else\ngl_FragColor=color;\n#endif\n}",postprocessVertexShader:"\nattribute vec2 position;\nuniform vec2 scale;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=(position*madd+madd)*scale;\ngl_Position=vec4(position,0.0,1.0);\n}",passPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\n}",shadowMapVertexShader:"\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\nuniform vec3 lightData;\n#endif\n#include<bonesDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n\n#include<instancesDeclaration>\n#include<helperFunctions>\nuniform mat4 viewProjection;\nuniform vec3 biasAndScale;\nuniform vec2 depthValues;\nvarying float vDepthMetric;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvec3 worldNor=normalize(normalWorld*normal);\n#ifdef DIRECTIONINLIGHTDATA\nvec3 worldLightDir=normalize(-lightData.xyz);\n#else\nvec3 directionToLight=lightData.xyz-worldPos.xyz;\nvec3 worldLightDir=normalize(directionToLight);\n#endif\nfloat ndl=dot(worldNor,worldLightDir);\nfloat sinNL=sqrt(1.0-ndl*ndl);\nfloat normalBias=biasAndScale.y*sinNL;\nworldPos.xyz-=worldNor*normalBias;\n#endif\n\ngl_Position=viewProjection*worldPos;\n#ifdef DEPTHTEXTURE\n\ngl_Position.z+=biasAndScale.x*gl_Position.w;\n#endif\n\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y))+biasAndScale.x;\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",shadowMapPixelShader:"#ifndef FLOAT\nvec4 pack(float depth)\n{\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(depth*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\n#endif\nvarying float vDepthMetric;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\nuniform vec3 biasAndScale;\nuniform vec2 depthValues;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nfloat depth=vDepthMetric;\n#ifdef ESM\ndepth=clamp(exp(-min(87.,biasAndScale.z*depth)),0.,1.);\n#endif\n#ifdef FLOAT\ngl_FragColor=vec4(depth,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depth);\n#endif\n}",depthBoxBlurPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nvoid main(void)\n{\nvec4 colorDepth=vec4(0.0);\nfor (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);\ngl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));\n}",proceduralVertexShader:"\nattribute vec2 position;\n\nvarying vec2 vPosition;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvPosition=position;\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n}",depthVertexShader:"\nattribute vec3 position;\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nuniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvarying float vDepthMetric;\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",depthPixelShader:"#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\nvarying float vDepthMetric;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(vDepthMetric,vDepthMetric*vDepthMetric,0.0,1.0);\n}",
ssaoPixelShader:"\nuniform sampler2D textureSampler;\nvarying vec2 vUV;\n#ifdef SSAO\nuniform sampler2D randomSampler;\nuniform float randTextureTiles;\nuniform float samplesFactor;\nuniform vec3 sampleSphere[SAMPLES];\nuniform float totalStrength;\nuniform float radius;\nuniform float area;\nuniform float fallOff;\nuniform float base;\nvec3 normalFromDepth(float depth,vec2 coords)\n{\nvec2 offset1=vec2(0.0,radius);\nvec2 offset2=vec2(radius,0.0);\nfloat depth1=texture2D(textureSampler,coords+offset1).r;\nfloat depth2=texture2D(textureSampler,coords+offset2).r;\nvec3 p1=vec3(offset1,depth1-depth);\nvec3 p2=vec3(offset2,depth2-depth);\nvec3 normal=cross(p1,p2);\nnormal.z=-normal.z;\nreturn normalize(normal);\n}\nvoid main()\n{\nvec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);\nfloat depth=texture2D(textureSampler,vUV).r;\nvec3 position=vec3(vUV,depth);\nvec3 normal=normalFromDepth(depth,vUV);\nfloat radiusDepth=radius/depth;\nfloat occlusion=0.0;\nvec3 ray;\nvec3 hemiRay;\nfloat occlusionDepth;\nfloat difference;\nfor (int i=0; i<SAMPLES; i++)\n{\nray=radiusDepth*reflect(sampleSphere[i],random);\nhemiRay=position+sign(dot(ray,normal))*ray;\nocclusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;\ndifference=depth-occlusionDepth;\nocclusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));\n}\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;\nfloat result=clamp(ao+base,0.0,1.0);\ngl_FragColor.r=result;\ngl_FragColor.g=result;\ngl_FragColor.b=result;\ngl_FragColor.a=1.0;\n}\n#endif\n",ssao2PixelShader:"\nprecision highp float;\nuniform sampler2D textureSampler;\nuniform float near;\nuniform float far;\nuniform float radius;\nvarying vec2 vUV;\nfloat perspectiveDepthToViewZ( const in float invClipZ,const in float near,const in float far ) {\nreturn ( near*far )/( ( far-near )*invClipZ-far );\n}\nfloat viewZToPerspectiveDepth( const in float viewZ,const in float near,const in float far ) {\nreturn ( near*far/viewZ+far)/( far-near );\n}\nfloat viewZToOrthographicDepth( const in float viewZ,const in float near,const in float far ) {\nreturn ( viewZ+near )/( near-far );\n}\n#ifdef SSAO\nuniform sampler2D randomSampler;\nuniform sampler2D normalSampler;\nuniform float randTextureTiles;\nuniform float samplesFactor;\nuniform vec3 sampleSphere[SAMPLES];\nuniform float totalStrength;\nuniform float base;\nuniform float xViewport;\nuniform float yViewport;\nuniform float maxZ;\nuniform float minZAspect;\nuniform vec2 texelSize;\nuniform mat4 projection;\nvoid main()\n{\nvec3 random=texture2D(randomSampler,vUV*randTextureTiles).rgb;\nfloat depth=texture2D(textureSampler,vUV).r;\nfloat depthSign=depth/abs(depth);\ndepth=depth*depthSign;\nvec3 normal=texture2D(normalSampler,vUV).rgb; \nfloat occlusion=0.0;\nfloat correctedRadius=min(radius,minZAspect*depth/near);\nvec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);\nvec3 origin=vViewRay*depth;\nvec3 rvec=random*2.0-1.0;\nrvec.z=0.0;\nvec3 tangent=normalize(rvec-normal*dot(rvec,normal));\nvec3 bitangent=cross(normal,tangent);\nmat3 tbn=mat3(tangent,bitangent,normal);\nfloat difference;\nif (depth>maxZ) {\ngl_FragColor=vec4(1.0,1.0,1.0,1.0);\nreturn;\n}\nfor (int i=0; i<SAMPLES; ++i) {\n\nvec3 samplePosition=tbn*sampleSphere[i];\nsamplePosition=samplePosition*correctedRadius+origin;\n\nvec4 offset=vec4(samplePosition,1.0);\noffset=projection*offset;\noffset.xyz/=offset.w;\noffset.xy=offset.xy*0.5+0.5;\nif (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {\ncontinue;\n}\n\nfloat sampleDepth=abs(texture2D(textureSampler,offset.xy).r);\n\nfloat rangeCheck=abs(depth-sampleDepth)<correctedRadius ? 1.0 : 0.0;\ndifference=depthSign*samplePosition.z-sampleDepth;\n\nocclusion+=(difference>=1e-5 ? 1.0 : 0.0)*rangeCheck;\n}\n\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;\nfloat result=clamp(ao+base,0.0,1.0);\ngl_FragColor=vec4(vec3(result),1.0);\n}\n#endif\n#ifdef BILATERAL_BLUR\nuniform sampler2D depthSampler;\nuniform float outSize;\nuniform float samplerOffsets[SAMPLES];\nvec4 blur9(sampler2D image,vec2 uv,float resolution,vec2 direction) {\nvec4 color=vec4(0.0);\nvec2 off1=vec2(1.3846153846)*direction;\nvec2 off2=vec2(3.2307692308)*direction;\ncolor+=texture2D(image,uv)*0.2270270270;\ncolor+=texture2D(image,uv+(off1/resolution))*0.3162162162;\ncolor+=texture2D(image,uv-(off1/resolution))*0.3162162162;\ncolor+=texture2D(image,uv+(off2/resolution))*0.0702702703;\ncolor+=texture2D(image,uv-(off2/resolution))*0.0702702703;\nreturn color;\n}\nvec4 blur13(sampler2D image,vec2 uv,float resolution,vec2 direction) {\nvec4 color=vec4(0.0);\nvec2 off1=vec2(1.411764705882353)*direction;\nvec2 off2=vec2(3.2941176470588234)*direction;\nvec2 off3=vec2(5.176470588235294)*direction;\ncolor+=texture2D(image,uv)*0.1964825501511404;\ncolor+=texture2D(image,uv+(off1/resolution))*0.2969069646728344;\ncolor+=texture2D(image,uv-(off1/resolution))*0.2969069646728344;\ncolor+=texture2D(image,uv+(off2/resolution))*0.09447039785044732;\ncolor+=texture2D(image,uv-(off2/resolution))*0.09447039785044732;\ncolor+=texture2D(image,uv+(off3/resolution))*0.010381362401148057;\ncolor+=texture2D(image,uv-(off3/resolution))*0.010381362401148057;\nreturn color;\n}\nvec4 blur13Bilateral(sampler2D image,vec2 uv,float resolution,vec2 direction) {\nvec4 color=vec4(0.0);\nvec2 off1=vec2(1.411764705882353)*direction;\nvec2 off2=vec2(3.2941176470588234)*direction;\nvec2 off3=vec2(5.176470588235294)*direction;\nfloat compareDepth=abs(texture2D(depthSampler,uv).r);\nfloat sampleDepth;\nfloat weight;\nfloat weightSum=30.0;\ncolor+=texture2D(image,uv)*30.0;\nsampleDepth=abs(texture2D(depthSampler,uv+(off1/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv+(off1/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv-(off1/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv-(off1/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv+(off2/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv+(off2/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv-(off2/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv-(off2/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv+(off3/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv+(off3/resolution))*weight;\nsampleDepth=abs(texture2D(depthSampler,uv-(off3/resolution)).r);\nweight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);\nweightSum+=weight;\ncolor+=texture2D(image,uv-(off3/resolution))*weight;\nreturn color/weightSum;\n}\nvoid main()\n{\n#if EXPENSIVE\nfloat compareDepth=abs(texture2D(depthSampler,vUV).r);\nfloat texelsize=1.0/outSize;\nfloat result=0.0;\nfloat weightSum=0.0;\nfor (int i=0; i<SAMPLES; ++i)\n{\n#ifdef BILATERAL_BLUR_H\nvec2 direction=vec2(1.0,0.0);\nvec2 sampleOffset=vec2(texelsize*samplerOffsets[i],0.0);\n#else\nvec2 direction=vec2(0.0,1.0);\nvec2 sampleOffset=vec2(0.0,texelsize*samplerOffsets[i]);\n#endif\nvec2 samplePos=vUV+sampleOffset;\nfloat sampleDepth=abs(texture2D(depthSampler,samplePos).r);\nfloat weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30000.0);\nresult+=texture2D(textureSampler,samplePos).r*weight;\nweightSum+=weight;\n}\nresult/=weightSum;\ngl_FragColor.rgb=vec3(result);\ngl_FragColor.a=1.0;\n#else\nvec4 color;\n#ifdef BILATERAL_BLUR_H\nvec2 direction=vec2(1.0,0.0);\ncolor=blur13Bilateral(textureSampler,vUV,outSize,direction);\n#else\nvec2 direction=vec2(0.0,1.0);\ncolor=blur13Bilateral(textureSampler,vUV,outSize,direction);\n#endif\ngl_FragColor.rgb=vec3(color.r);\ngl_FragColor.a=1.0;\n#endif\n}\n#endif\n",ssaoCombinePixelShader:"uniform sampler2D textureSampler;\nuniform sampler2D originalColor;\nvarying vec2 vUV;\nvoid main(void) {\nvec4 ssaoColor=texture2D(textureSampler,vUV);\nvec4 sceneColor=texture2D(originalColor,vUV);\ngl_FragColor=sceneColor*ssaoColor;\n}\n",lensHighlightsPixelShader:"\nuniform sampler2D textureSampler; \n\nuniform float gain;\nuniform float threshold;\nuniform float screen_width;\nuniform float screen_height;\n\nvarying vec2 vUV;\n\nvec4 highlightColor(vec4 color) {\nvec4 highlight=color;\nfloat luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));\nfloat lum_threshold;\nif (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }\nelse { lum_threshold=0.5+0.44*threshold; }\nluminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);\nhighlight*=luminance*gain;\nhighlight.a=1.0;\nreturn highlight;\n}\nvoid main(void)\n{\nvec4 original=texture2D(textureSampler,vUV);\n\nif (gain == -1.0) {\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\nreturn;\n}\nfloat w=2.0/screen_width;\nfloat h=2.0/screen_height;\nfloat weight=1.0;\n\nvec4 blurred=vec4(0.0,0.0,0.0,0.0);\n#ifdef PENTAGON\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));\n#else\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));\n#endif\nblurred/=39.0;\ngl_FragColor=blurred;\n\n}",depthOfFieldPixelShader:"\n\n\n\n\nuniform sampler2D textureSampler;\nuniform sampler2D highlightsSampler;\nuniform sampler2D depthSampler;\nuniform sampler2D grainSampler;\n\nuniform float grain_amount;\nuniform bool blur_noise;\nuniform float screen_width;\nuniform float screen_height;\nuniform float distortion;\nuniform bool dof_enabled;\n\nuniform float screen_distance; \nuniform float aperture;\nuniform float darken;\nuniform float edge_blur;\nuniform bool highlights;\n\nuniform float near;\nuniform float far;\n\nvarying vec2 vUV;\n\n#define PI 3.14159265\n#define TWOPI 6.28318530\n#define inverse_focal_length 0.1 \n\nvec2 centered_screen_pos;\nvec2 distorted_coords;\nfloat radius2;\nfloat radius;\n\nvec2 rand(vec2 co)\n{\nfloat noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));\nfloat noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));\nreturn clamp(vec2(noise1,noise2),0.0,1.0);\n}\n\nvec2 getDistortedCoords(vec2 coords) {\nif (distortion == 0.0) { return coords; }\nvec2 direction=1.0*normalize(centered_screen_pos);\nvec2 dist_coords=vec2(0.5,0.5);\ndist_coords.x=0.5+direction.x*radius2*1.0;\ndist_coords.y=0.5+direction.y*radius2*1.0;\nfloat dist_amount=clamp(distortion*0.23,0.0,1.0);\ndist_coords=mix(coords,dist_coords,dist_amount);\nreturn dist_coords;\n}\n\nfloat sampleScreen(inout vec4 color,const in vec2 offset,const in float weight) {\n\nvec2 coords=distorted_coords;\nfloat angle=rand(coords*100.0).x*TWOPI;\ncoords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));\ncolor+=texture2D(textureSampler,coords)*weight;\nreturn weight;\n}\n\nfloat getBlurLevel(float size) {\nreturn min(3.0,ceil(size/1.0));\n}\n\nvec4 getBlurColor(float size) {\nvec4 col=texture2D(textureSampler,distorted_coords);\nif (size == 0.0) { return col; }\n\n\nfloat blur_level=getBlurLevel(size);\nfloat w=(size/screen_width);\nfloat h=(size/screen_height);\nfloat total_weight=1.0;\nvec2 sample_coords;\ntotal_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);\ntotal_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);\ntotal_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);\ntotal_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);\ntotal_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);\ntotal_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);\ntotal_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);\ntotal_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);\ntotal_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);\nif (blur_level>1.0) {\ntotal_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);\ntotal_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);\ntotal_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);\ntotal_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);\ntotal_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);\ntotal_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);\ntotal_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);\ntotal_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);\ntotal_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);\n}\nif (blur_level>2.0) {\ntotal_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);\ntotal_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);\ntotal_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);\ntotal_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);\ntotal_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);\ntotal_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);\ntotal_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);\ntotal_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);\ntotal_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);\n}\ncol/=total_weight; \n\nif (darken>0.0) {\ncol.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);\n}\n\n\n\n\nreturn col;\n}\nvoid main(void)\n{\n\ncentered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);\nradius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;\nradius=sqrt(radius2);\ndistorted_coords=getDistortedCoords(vUV); \nvec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); \nfloat depth=texture2D(depthSampler,distorted_coords).r; \nfloat distance=near+(far-near)*depth; \nvec4 color=texture2D(textureSampler,vUV); \n\n\nfloat coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));\n\nif (dof_enabled == false || coc<0.07) { coc=0.0; }\n\nfloat edge_blur_amount=0.0;\nif (edge_blur>0.0) {\nedge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;\n}\n\nfloat blur_amount=max(edge_blur_amount,coc);\n\nif (blur_amount == 0.0) {\ngl_FragColor=texture2D(textureSampler,distorted_coords);\n}\nelse {\n\ngl_FragColor=getBlurColor(blur_amount*1.7);\n\nif (highlights) {\ngl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;\n}\nif (blur_noise) {\n\nvec2 noise=rand(distorted_coords)*0.01*blur_amount;\nvec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);\ngl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;\n}\n}\n\nif (grain_amount>0.0) {\nvec4 grain_color=texture2D(grainSampler,texels_coords*0.003);\ngl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;\n}\n}\n",standardPixelShader:"uniform sampler2D textureSampler;\nvarying vec2 vUV;\n#if defined(PASS_POST_PROCESS)\nvoid main(void)\n{\nvec4 color=texture2D(textureSampler,vUV);\ngl_FragColor=color;\n}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+dsOffsets[0]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[1]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[2]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[3]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[4]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[5]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[6]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[7]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[8]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[9]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[10]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[11]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[12]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[13]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[14]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[15]);\naverage/=16.0;\ngl_FragColor=average;\n}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];\nuniform float brightThreshold;\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));\naverage*=0.25;\nfloat luminance=length(average.rgb);\nif (luminance<brightThreshold) {\naverage=vec4(0.0,0.0,0.0,1.0);\n}\ngl_FragColor=average;\n}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;\nuniform sampler2D lensSampler;\nuniform float exposure;\nvoid main(void)\n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\ncolour*=exposure;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\ncolour+=colour*texture2D(lensSampler,vUV).rgb;\nvec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);\ngl_FragColor=finalColor;\n}\n#endif\n#if defined(VLS)\n#define PI 3.1415926535897932384626433832795\nuniform mat4 shadowViewProjection;\nuniform mat4 lightWorld;\nuniform vec3 cameraPosition;\nuniform vec3 sunDirection;\nuniform vec3 sunColor;\nuniform vec2 depthValues;\nuniform float scatteringCoefficient;\nuniform float scatteringPower;\nuniform sampler2D shadowMapSampler;\nuniform sampler2D positionSampler;\nfloat computeScattering(float lightDotView)\n{\nfloat result=1.0-scatteringCoefficient*scatteringCoefficient;\nresult/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));\nreturn result;\n}\nvoid main(void)\n{\n\nvec3 worldPos=texture2D(positionSampler,vUV).rgb;\nvec3 startPosition=cameraPosition;\nvec3 rayVector=worldPos-startPosition;\nfloat rayLength=length(rayVector);\nvec3 rayDirection=rayVector/rayLength;\nfloat stepLength=rayLength/NB_STEPS;\nvec3 stepL=rayDirection*stepLength;\nvec3 currentPosition=startPosition;\nvec3 accumFog=vec3(0.0);\nfor (int i=0; i<int(NB_STEPS); i++)\n{\nvec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);\nfloat depthMetric=(worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depthMetric,0.0,1.0);\nworldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;\nworldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);\nfloat shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;\nif (shadowMapValue>shadowPixelDepth)\naccumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));\ncurrentPosition+=stepL;\n}\naccumFog/=NB_STEPS;\nvec3 color=accumFog*scatteringPower;\ngl_FragColor=vec4(color*exp(color) ,1.0);\n}\n#endif\n#if defined(VLSMERGE)\nuniform sampler2D originalSampler;\nvoid main(void)\n{\ngl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);\n}\n#endif\n#if defined(LUMINANCE)\nuniform vec2 lumOffsets[4];\nvoid main()\n{\nfloat average=0.0;\nvec4 color=vec4(0.0);\nfloat maximum=-1e20;\nvec3 weight=vec3(0.299,0.587,0.114);\nfor (int i=0; i<4; i++)\n{\ncolor=texture2D(textureSampler,vUV+ lumOffsets[i]);\n\nfloat GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));\n\n#ifdef WEIGHTED_AVERAGE\nfloat GreyValue=dot(color.rgb,weight);\n#endif\n#ifdef BRIGHTNESS\nfloat GreyValue=max(color.r,max(color.g,color.b));\n#endif\n#ifdef HSL_COMPONENT\nfloat GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));\n#endif\n#ifdef MAGNITUDE\nfloat GreyValue=length(color.rgb);\n#endif\nmaximum=max(maximum,GreyValue);\naverage+=(0.25*log(1e-5+GreyValue));\n}\naverage=exp(average);\ngl_FragColor=vec4(average,maximum,0.0,1.0);\n}\n#endif\n#if defined(LUMINANCE_DOWN_SAMPLE)\nuniform vec2 dsOffsets[9];\nuniform float halfDestPixelSize;\n#ifdef FINAL_DOWN_SAMPLER\nvec4 pack(float value) {\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(value*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\n#endif\nvoid main()\n{\nvec4 color=vec4(0.0);\nfloat average=0.0;\nfor (int i=0; i<9; i++)\n{\ncolor=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);\naverage+=color.r;\n}\naverage/=9.0;\n#ifdef FINAL_DOWN_SAMPLER\ngl_FragColor=pack(average);\n#else\ngl_FragColor=vec4(average,average,0.0,1.0);\n#endif\n}\n#endif\n#if defined(HDR)\nuniform sampler2D textureAdderSampler;\nuniform float averageLuminance;\nvoid main()\n{\nvec4 color=texture2D(textureAdderSampler,vUV);\nvec4 adjustedColor=color/averageLuminance;\ncolor=adjustedColor;\ncolor.a=1.0;\ngl_FragColor=color;\n}\n#endif\n#if defined(LENS_FLARE)\n#define GHOSTS 3\nuniform sampler2D lensColorSampler;\nuniform float strength;\nuniform float ghostDispersal;\nuniform float haloWidth;\nuniform vec2 resolution;\nuniform float distortionStrength;\nfloat hash(vec2 p)\n{\nfloat h=dot(p,vec2(127.1,311.7));\nreturn -1.0+2.0*fract(sin(h)*43758.5453123);\n}\nfloat noise(in vec2 p)\n{\nvec2 i=floor(p);\nvec2 f=fract(p);\nvec2 u=f*f*(3.0-2.0*f);\nreturn mix(mix(hash(i+vec2(0.0,0.0)),\nhash(i+vec2(1.0,0.0)),u.x),\nmix(hash(i+vec2(0.0,1.0)),\nhash(i+vec2(1.0,1.0)),u.x),u.y);\n}\nfloat fbm(vec2 p)\n{\nfloat f=0.0;\nf+=0.5000*noise(p); p*=2.02;\nf+=0.2500*noise(p); p*=2.03;\nf+=0.1250*noise(p); p*=2.01;\nf+=0.0625*noise(p); p*=2.04;\nf/=0.9375;\nreturn f;\n}\nvec3 pattern(vec2 uv)\n{\nvec2 p=-1.0+2.0*uv;\nfloat p2=dot(p,p);\nfloat f=fbm(vec2(15.0*p2))/2.0;\nfloat r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));\nfloat g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));\nfloat b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));\nreturn (1.0-f)*vec3(r,g,b);\n}\nfloat luminance(vec3 color)\n{\nreturn dot(color.rgb,vec3(0.2126,0.7152,0.0722));\n}\nvec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)\n{\nreturn vec4(\ntexture2D(tex,texcoord+direction*distortion.r).r,\ntexture2D(tex,texcoord+direction*distortion.g).g,\ntexture2D(tex,texcoord+direction*distortion.b).b,\n1.0\n);\n}\nvoid main(void)\n{\nvec2 uv=-vUV+vec2(1.0);\nvec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;\nvec2 texelSize=1.0/resolution;\nvec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);\nvec4 result=vec4(0.0);\nfloat ghostIndice=1.0;\nfor (int i=0; i<GHOSTS; ++i)\n{\nvec2 offset=fract(uv+ghostDir*ghostIndice);\nfloat weight=length(vec2(0.5)-offset)/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;\nghostIndice+=1.0;\n}\nvec2 haloVec=normalize(ghostDir)*haloWidth;\nfloat weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;\nresult*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));\ngl_FragColor=result;\n}\n#endif\n#if defined(LENS_FLARE_COMPOSE)\nuniform sampler2D otherSampler;\nuniform sampler2D lensDirtSampler;\nuniform sampler2D lensStarSampler;\nuniform mat4 lensStarMatrix;\nvoid main(void)\n{\nvec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;\nvec4 lensMod=texture2D(lensDirtSampler,vUV);\nlensMod+=texture2D(lensStarSampler,vUV);\nvec4 result=texture2D(textureSampler,vUV)*lensMod;\ngl_FragColor=texture2D(otherSampler,vUV)+result;\n}\n#endif\n#if defined(DEPTH_OF_FIELD)\nuniform sampler2D otherSampler;\nuniform sampler2D depthSampler;\nuniform float distance;\nvoid main(void)\n{\nvec4 sharp=texture2D(otherSampler,vUV);\nvec4 blur=texture2D(textureSampler,vUV);\nfloat dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);\nfloat factor=0.0;\nif (dist<0.05)\nfactor=1.0;\nelse if (dist<0.1)\nfactor=20.0*(0.1-dist);\nelse if (dist<0.5)\nfactor=0.0;\nelse\nfactor=2.0*(dist-0.5);\nfactor=clamp(factor,0.0,0.90);\ngl_FragColor=mix(sharp,blur,factor);\n}\n#endif\n#if defined(MOTION_BLUR)\nuniform mat4 inverseViewProjection;\nuniform mat4 prevViewProjection;\nuniform vec2 screenSize;\nuniform float motionScale;\nuniform float motionStrength;\nuniform sampler2D depthSampler;\nvoid main(void)\n{\nvec2 texelSize=1.0/screenSize;\nfloat depth=texture2D(depthSampler,vUV).r;\nvec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);\ncpos=cpos*inverseViewProjection;\nvec4 ppos=cpos*prevViewProjection;\nppos.xyz/=ppos.w;\nppos.xy=ppos.xy*0.5+0.5;\nvec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;\nfloat speed=length(velocity/texelSize);\nint nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));\nvec4 result=texture2D(textureSampler,vUV);\nfor (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {\nif (i>=nSamples)\nbreak;\nvec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);\nresult+=texture2D(textureSampler,offset1);\n}\ngl_FragColor=result/float(nSamples);\n}\n#endif\n",fxaaVertexShader:"\nattribute vec2 position;\nuniform vec2 texelSize;\n\nvarying vec2 vUV;\nvarying vec2 sampleCoordS;\nvarying vec2 sampleCoordE;\nvarying vec2 sampleCoordN;\nvarying vec2 sampleCoordW;\nvarying vec2 sampleCoordNW;\nvarying vec2 sampleCoordSE;\nvarying vec2 sampleCoordNE;\nvarying vec2 sampleCoordSW;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=(position*madd+madd);\nsampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;\nsampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;\nsampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;\nsampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;\nsampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;\nsampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;\nsampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;\nsampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;\ngl_Position=vec4(position,0.0,1.0);\n}",
fxaaPixelShader:"uniform sampler2D textureSampler;\nuniform vec2 texelSize;\nvarying vec2 vUV;\nvarying vec2 sampleCoordS;\nvarying vec2 sampleCoordE;\nvarying vec2 sampleCoordN;\nvarying vec2 sampleCoordW;\nvarying vec2 sampleCoordNW;\nvarying vec2 sampleCoordSE;\nvarying vec2 sampleCoordNE;\nvarying vec2 sampleCoordSW;\nconst float fxaaQualitySubpix=1.0;\nconst float fxaaQualityEdgeThreshold=0.166;\nconst float fxaaQualityEdgeThresholdMin=0.0833;\nconst vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);\n#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)\nvoid main(){\nvec2 posM;\nposM.x=vUV.x;\nposM.y=vUV.y;\nvec4 rgbyM=texture2D(textureSampler,vUV,0.0);\nfloat lumaM=FxaaLuma(rgbyM);\nfloat lumaS=FxaaLuma(texture2D(textureSampler,sampleCoordS,0.0));\nfloat lumaE=FxaaLuma(texture2D(textureSampler,sampleCoordE,0.0));\nfloat lumaN=FxaaLuma(texture2D(textureSampler,sampleCoordN,0.0));\nfloat lumaW=FxaaLuma(texture2D(textureSampler,sampleCoordW,0.0));\nfloat maxSM=max(lumaS,lumaM);\nfloat minSM=min(lumaS,lumaM);\nfloat maxESM=max(lumaE,maxSM);\nfloat minESM=min(lumaE,minSM);\nfloat maxWN=max(lumaN,lumaW);\nfloat minWN=min(lumaN,lumaW);\nfloat rangeMax=max(maxWN,maxESM);\nfloat rangeMin=min(minWN,minESM);\nfloat rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;\nfloat range=rangeMax-rangeMin;\nfloat rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\nif(range<rangeMaxClamped) \n{\ngl_FragColor=rgbyM;\nreturn;\n}\nfloat lumaNW=FxaaLuma(texture2D(textureSampler,sampleCoordNW,0.0));\nfloat lumaSE=FxaaLuma(texture2D(textureSampler,sampleCoordSE,0.0));\nfloat lumaNE=FxaaLuma(texture2D(textureSampler,sampleCoordNE,0.0));\nfloat lumaSW=FxaaLuma(texture2D(textureSampler,sampleCoordSW,0.0));\nfloat lumaNS=lumaN+lumaS;\nfloat lumaWE=lumaW+lumaE;\nfloat subpixRcpRange=1.0/range;\nfloat subpixNSWE=lumaNS+lumaWE;\nfloat edgeHorz1=(-2.0*lumaM)+lumaNS;\nfloat edgeVert1=(-2.0*lumaM)+lumaWE;\nfloat lumaNESE=lumaNE+lumaSE;\nfloat lumaNWNE=lumaNW+lumaNE;\nfloat edgeHorz2=(-2.0*lumaE)+lumaNESE;\nfloat edgeVert2=(-2.0*lumaN)+lumaNWNE;\nfloat lumaNWSW=lumaNW+lumaSW;\nfloat lumaSWSE=lumaSW+lumaSE;\nfloat edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);\nfloat edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);\nfloat edgeHorz3=(-2.0*lumaW)+lumaNWSW;\nfloat edgeVert3=(-2.0*lumaS)+lumaSWSE;\nfloat edgeHorz=abs(edgeHorz3)+edgeHorz4;\nfloat edgeVert=abs(edgeVert3)+edgeVert4;\nfloat subpixNWSWNESE=lumaNWSW+lumaNESE;\nfloat lengthSign=texelSize.x;\nbool horzSpan=edgeHorz>=edgeVert;\nfloat subpixA=subpixNSWE*2.0+subpixNWSWNESE;\nif (!horzSpan)\n{\nlumaN=lumaW;\n}\nif (!horzSpan) \n{\nlumaS=lumaE;\n}\nif (horzSpan) \n{\nlengthSign=texelSize.y;\n}\nfloat subpixB=(subpixA*(1.0/12.0))-lumaM;\nfloat gradientN=lumaN-lumaM;\nfloat gradientS=lumaS-lumaM;\nfloat lumaNN=lumaN+lumaM;\nfloat lumaSS=lumaS+lumaM;\nbool pairN=abs(gradientN)>=abs(gradientS);\nfloat gradient=max(abs(gradientN),abs(gradientS));\nif (pairN)\n{\nlengthSign=-lengthSign;\n}\nfloat subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);\nvec2 posB;\nposB.x=posM.x;\nposB.y=posM.y;\nvec2 offNP;\noffNP.x=(!horzSpan) ? 0.0 : texelSize.x;\noffNP.y=(horzSpan) ? 0.0 : texelSize.y;\nif (!horzSpan) \n{\nposB.x+=lengthSign*0.5;\n}\nif (horzSpan)\n{\nposB.y+=lengthSign*0.5;\n}\nvec2 posN;\nposN.x=posB.x-offNP.x*1.5;\nposN.y=posB.y-offNP.y*1.5;\nvec2 posP;\nposP.x=posB.x+offNP.x*1.5;\nposP.y=posB.y+offNP.y*1.5;\nfloat subpixD=((-2.0)*subpixC)+3.0;\nfloat lumaEndN=FxaaLuma(texture2D(textureSampler,posN,0.0));\nfloat subpixE=subpixC*subpixC;\nfloat lumaEndP=FxaaLuma(texture2D(textureSampler,posP,0.0));\nif (!pairN) \n{\nlumaNN=lumaSS;\n}\nfloat gradientScaled=gradient*1.0/4.0;\nfloat lumaMM=lumaM-lumaNN*0.5;\nfloat subpixF=subpixD*subpixE;\nbool lumaMLTZero=lumaMM<0.0;\nlumaEndN-=lumaNN*0.5;\nlumaEndP-=lumaNN*0.5;\nbool doneN=abs(lumaEndN)>=gradientScaled;\nbool doneP=abs(lumaEndP)>=gradientScaled;\nif (!doneN) \n{\nposN.x-=offNP.x*3.0;\n}\nif (!doneN) \n{\nposN.y-=offNP.y*3.0;\n}\nbool doneNP=(!doneN) || (!doneP);\nif (!doneP) \n{\nposP.x+=offNP.x*3.0;\n}\nif (!doneP)\n{\nposP.y+=offNP.y*3.0;\n}\nif (doneNP)\n{\nif (!doneN) lumaEndN=FxaaLuma(texture2D(textureSampler,posN.xy,0.0));\nif (!doneP) lumaEndP=FxaaLuma(texture2D(textureSampler,posP.xy,0.0));\nif (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;\nif (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;\ndoneN=abs(lumaEndN)>=gradientScaled;\ndoneP=abs(lumaEndP)>=gradientScaled;\nif (!doneN) posN.x-=offNP.x*12.0;\nif (!doneN) posN.y-=offNP.y*12.0;\ndoneNP=(!doneN) || (!doneP);\nif (!doneP) posP.x+=offNP.x*12.0;\nif (!doneP) posP.y+=offNP.y*12.0;\n}\nfloat dstN=posM.x-posN.x;\nfloat dstP=posP.x-posM.x;\nif (!horzSpan)\n{\ndstN=posM.y-posN.y;\n}\nif (!horzSpan) \n{\ndstP=posP.y-posM.y;\n}\nbool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;\nfloat spanLength=(dstP+dstN);\nbool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;\nfloat spanLengthRcp=1.0/spanLength;\nbool directionN=dstN<dstP;\nfloat dst=min(dstN,dstP);\nbool goodSpan=directionN ? goodSpanN : goodSpanP;\nfloat subpixG=subpixF*subpixF;\nfloat pixelOffset=(dst*(-spanLengthRcp))+0.5;\nfloat subpixH=subpixG*fxaaQualitySubpix;\nfloat pixelOffsetGood=goodSpan ? pixelOffset : 0.0;\nfloat pixelOffsetSubpix=max(pixelOffsetGood,subpixH);\nif (!horzSpan)\n{\nposM.x+=pixelOffsetSubpix*lengthSign;\n}\nif (horzSpan)\n{\nposM.y+=pixelOffsetSubpix*lengthSign;\n}\ngl_FragColor=texture2D(textureSampler,posM,0.0);\n}",chromaticAberrationPixelShader:"\nuniform sampler2D textureSampler; \n\nuniform float chromatic_aberration;\nuniform float radialIntensity;\nuniform vec2 direction;\nuniform vec2 centerPosition;\nuniform float screen_width;\nuniform float screen_height;\n\nvarying vec2 vUV;\nvoid main(void)\n{\nvec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);\nvec2 directionOfEffect=direction;\nif(directionOfEffect.x == 0. && directionOfEffect.y == 0.){\ndirectionOfEffect=normalize(centered_screen_pos);\n}\nfloat radius2=centered_screen_pos.x*centered_screen_pos.x\n+centered_screen_pos.y*centered_screen_pos.y;\nfloat radius=sqrt(radius2);\nvec4 original=texture2D(textureSampler,vUV);\n\nvec3 ref_indices=vec3(-0.3,0.0,0.3);\nfloat ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;\nfloat ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;\n\nvec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);\nvec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);\nvec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);\noriginal.r=texture2D(textureSampler,ref_coords_r).r;\noriginal.g=texture2D(textureSampler,ref_coords_g).g;\noriginal.b=texture2D(textureSampler,ref_coords_b).b;\noriginal.a=clamp(texture2D(textureSampler,ref_coords_r).a+texture2D(textureSampler,ref_coords_g).a+texture2D(textureSampler,ref_coords_b).a,0.,1.);\ngl_FragColor=original;\n}",grainPixelShader:"#include<helperFunctions>\n\nuniform sampler2D textureSampler; \n\nuniform float intensity;\nuniform float animatedSeed;\n\nvarying vec2 vUV;\nvoid main(void)\n{\ngl_FragColor=texture2D(textureSampler,vUV);\nvec2 seed=vUV*(animatedSeed);\nfloat grain=dither(seed,intensity);\n\nfloat lum=getLuminance(gl_FragColor.rgb);\nfloat grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;\ngl_FragColor.rgb+=grain*grainAmount;\ngl_FragColor.rgb=max(gl_FragColor.rgb,0.0);\n}",sharpenPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform vec2 sharpnessAmounts;\nvoid main(void)\n{\nvec2 onePixel=vec2(1.0,1.0)/screenSize;\nvec4 color=texture2D(textureSampler,vUV);\nvec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1)) -\ncolor*4.0;\ngl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);\n}",kernelBlurVertexShader:"\nattribute vec2 position;\n\nuniform vec2 delta;\n\nvarying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n}",kernelBlurPixelShader:"\nuniform sampler2D textureSampler;\nuniform vec2 delta;\n\nvarying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;\nuniform vec2 cameraMinMaxZ;\nfloat sampleDistance(const in vec2 offset) {\nfloat depth=texture2D(circleOfConfusionSampler,offset).g; \nreturn cameraMinMaxZ.x+(cameraMinMaxZ.y-cameraMinMaxZ.x)*depth; \n}\nfloat sampleCoC(const in vec2 offset) {\nfloat coc=texture2D(circleOfConfusionSampler,offset).r; \nreturn coc; \n}\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\nvec4 pack(float depth)\n{\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(depth*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nvoid main(void)\n{\nfloat computedWeight=0.0;\n#ifdef PACKEDFLOAT \nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}",depthOfFieldMergePixelShader:"uniform sampler2D textureSampler;\nvarying vec2 vUV;\nuniform sampler2D circleOfConfusionSampler;\nuniform sampler2D blurStep0;\n#if BLUR_LEVEL>0\nuniform sampler2D blurStep1;\n#endif\n#if BLUR_LEVEL>1\nuniform sampler2D blurStep2;\n#endif\nvoid main(void)\n{\nfloat coc=texture2D(circleOfConfusionSampler,vUV).r;\n#if BLUR_LEVEL == 0\nvec4 original=texture2D(textureSampler,vUV);\nvec4 blurred0=texture2D(blurStep0,vUV);\ngl_FragColor=mix(original,blurred0,coc);\n#endif\n#if BLUR_LEVEL == 1\nif(coc<0.5){\nvec4 original=texture2D(textureSampler,vUV);\nvec4 blurred1=texture2D(blurStep1,vUV);\ngl_FragColor=mix(original,blurred1,coc/0.5);\n}else{\nvec4 blurred0=texture2D(blurStep0,vUV); \nvec4 blurred1=texture2D(blurStep1,vUV);\ngl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);\n}\n#endif\n#if BLUR_LEVEL == 2\nif(coc<0.33){\nvec4 original=texture2D(textureSampler,vUV);\nvec4 blurred2=texture2D(blurStep2,vUV);\ngl_FragColor=mix(original,blurred2,coc/0.33);\n}else if(coc<0.66){\nvec4 blurred1=texture2D(blurStep1,vUV);\nvec4 blurred2=texture2D(blurStep2,vUV);\ngl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);\n}else{\nvec4 blurred0=texture2D(blurStep0,vUV);\nvec4 blurred1=texture2D(blurStep1,vUV);\ngl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);\n}\n#endif\n}\n",circleOfConfusionPixelShader:"\nuniform sampler2D depthSampler;\n\nvarying vec2 vUV;\n\nuniform vec2 cameraMinMaxZ;\n\nuniform float focusDistance;\nuniform float cocPrecalculation;\nvoid main(void)\n{\nfloat depth=texture2D(depthSampler,vUV).r;\nfloat pixelDistance=(cameraMinMaxZ.x+(cameraMinMaxZ.y-cameraMinMaxZ.x)*depth)*1000.0; \nfloat coc=abs(cocPrecalculation* ((focusDistance-pixelDistance)/pixelDistance));\ncoc=clamp(coc,0.0,1.0);\ngl_FragColor=vec4(coc,depth,coc,1.0);\n}\n",bloomMergePixelShader:"uniform sampler2D textureSampler;\nuniform sampler2D bloomBlur;\nvarying vec2 vUV;\nuniform float bloomWeight;\nvoid main(void)\n{\ngl_FragColor=texture2D(textureSampler,vUV);\nvec3 blurred=texture2D(bloomBlur,vUV).rgb;\ngl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); \n}\n",extractHighlightsPixelShader:"#include<helperFunctions>\n\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float threshold;\nuniform float exposure;\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\nfloat luma=getLuminance(gl_FragColor.rgb*exposure);\ngl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;\n}",geometryVertexShader:"precision highp float;\nprecision highp int;\n#include<bonesDeclaration>\n#include<instancesDeclaration>\nattribute vec3 position;\nattribute vec3 normal;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nvarying vec2 uv;\n#endif\n#ifdef UV2\nvarying vec2 uv2;\n#endif\n#endif\n\nuniform mat4 viewProjection;\nuniform mat4 view;\nvarying vec3 vNormalV;\nvarying vec4 vViewPos;\n#ifdef POSITION\nvarying vec3 vPosition;\n#endif\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\nvec4 pos=vec4(finalWorld*vec4(position,1.0));\nvNormalV=normalize(vec3((view*finalWorld)*vec4(normal,0.0)));\nvViewPos=view*pos;\n#ifdef POSITION\nvPosition=pos.xyz/pos.w;\n#endif\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",geometryPixelShader:"#extension GL_EXT_draw_buffers : require\nprecision highp float;\nprecision highp int;\nvarying vec3 vNormalV;\nvarying vec4 vViewPos;\n#ifdef POSITION\nvarying vec3 vPosition;\n#endif\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef POSITION\n#include<mrtFragmentDeclaration>[3]\n#else\n#include<mrtFragmentDeclaration>[2]\n#endif\nvoid main() {\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\ngl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\n\ngl_FragData[1]=vec4(normalize(vNormalV),1.0);\n\n#ifdef POSITION\ngl_FragData[2]=vec4(vPosition,1.0);\n#endif\n}",refractionPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D refractionSampler;\n\nuniform vec3 baseColor;\nuniform float depth;\nuniform float colorLevel;\nvoid main() {\nfloat ref=1.0-texture2D(refractionSampler,vUV).r;\nvec2 uv=vUV-vec2(0.5);\nvec2 offset=uv*depth*ref;\nvec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;\ngl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);\n}",blackAndWhitePixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform float degree;\nvoid main(void) \n{\nvec3 color=texture2D(textureSampler,vUV).rgb;\nfloat luminance=dot(color,vec3(0.3,0.59,0.11)); \nvec3 blackAndWhite=vec3(luminance,luminance,luminance);\ngl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);\n}",convolutionPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform float kernel[9];\nvoid main(void)\n{\nvec2 onePixel=vec2(1.0,1.0)/screenSize;\nvec4 colorSum =\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];\nfloat kernelWeight =\nkernel[0] +\nkernel[1] +\nkernel[2] +\nkernel[3] +\nkernel[4] +\nkernel[5] +\nkernel[6] +\nkernel[7] +\nkernel[8];\nif (kernelWeight<=0.0) {\nkernelWeight=1.0;\n}\ngl_FragColor=vec4((colorSum/kernelWeight).rgb,1);\n}",filterPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform mat4 kernelMatrix;\nvoid main(void)\n{\nvec3 baseColor=texture2D(textureSampler,vUV).rgb;\nvec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;\ngl_FragColor=vec4(updatedColor,1.0);\n}",volumetricLightScatteringPixelShader:"uniform sampler2D textureSampler;\nuniform sampler2D lightScatteringSampler;\nuniform float decay;\nuniform float exposure;\nuniform float weight;\nuniform float density;\nuniform vec2 meshPositionOnScreen;\nvarying vec2 vUV;\nvoid main(void) {\nvec2 tc=vUV;\nvec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);\ndeltaTexCoord*=1.0/float(NUM_SAMPLES)*density;\nfloat illuminationDecay=1.0;\nvec4 color=texture2D(lightScatteringSampler,tc)*0.4;\nfor(int i=0; i<NUM_SAMPLES; i++) {\ntc-=deltaTexCoord;\nvec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;\ndataSample*=illuminationDecay*weight;\ncolor+=dataSample;\nilluminationDecay*=decay;\n}\nvec4 realColor=texture2D(textureSampler,vUV);\ngl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));\n}\n",volumetricLightScatteringPassPixelShader:"#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\n#endif\n#if defined(ALPHATEST)\nuniform sampler2D diffuseSampler;\n#endif\nvoid main(void)\n{\n#if defined(ALPHATEST)\nvec4 diffuseColor=texture2D(diffuseSampler,vUV);\nif (diffuseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\n}\n",colorCorrectionPixelShader:"\nuniform sampler2D textureSampler; \nuniform sampler2D colorTable; \n\nvarying vec2 vUV;\n\nconst float SLICE_COUNT=16.0; \n\nvec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {\nfloat sliceSize=1.0/width; \nfloat slicePixelSize=sliceSize/width; \nfloat sliceInnerSize=slicePixelSize*(width-1.0); \nfloat zSlice0=min(floor(uv.z*width),width-1.0);\nfloat zSlice1=min(zSlice0+1.0,width-1.0);\nfloat xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;\nfloat s0=xOffset+(zSlice0*sliceSize);\nfloat s1=xOffset+(zSlice1*sliceSize);\nvec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));\nvec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));\nfloat zOffset=mod(uv.z*width,1.0);\nvec4 result=mix(slice0Color,slice1Color,zOffset);\nreturn result;\n}\nvoid main(void)\n{\nvec4 screen_color=texture2D(textureSampler,vUV);\ngl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);\n}",tonemapPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform float _ExposureAdjustment;\n#if defined(HABLE_TONEMAPPING)\nconst float A=0.15;\nconst float B=0.50;\nconst float C=0.10;\nconst float D=0.20;\nconst float E=0.02;\nconst float F=0.30;\nconst float W=11.2;\n#endif\nfloat Luminance(vec3 c)\n{\nreturn dot(c,vec3(0.22,0.707,0.071));\n}\nvoid main(void) \n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nfloat lum=Luminance(colour.rgb); \nfloat lumTm=lum*_ExposureAdjustment;\nfloat scale=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nconst float ExposureBias=2.0;\nvec3 x=ExposureBias*colour;\nvec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\nx=vec3(W,W,W);\nvec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);\ncolour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour=vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);\n#endif\ngl_FragColor=vec4(colour.rgb,1.0);\n}",displayPassPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D passSampler;\nvoid main(void)\n{\ngl_FragColor=texture2D(passSampler,vUV);\n}",highlightsPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nconst vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);\nvoid main(void) \n{\nvec4 tex=texture2D(textureSampler,vUV);\nvec3 c=tex.rgb;\nfloat luma=dot(c.rgb,RGBLuminanceCoefficients);\n\n\ngl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); \n}",imageProcessingPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\nvoid main(void)\n{\nvec4 result=texture2D(textureSampler,vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\n\nresult.rgb=toLinearSpace(result.rgb);\n#endif\nresult=applyImageProcessing(result);\n#else\n\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\ngl_FragColor=result;\n}",lensFlareVertexShader:"\nattribute vec2 position;\n\nuniform mat4 viewportMatrix;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=position*madd+madd;\ngl_Position=viewportMatrix*vec4(position,0.0,1.0);\n}",lensFlarePixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec4 color;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\ngl_FragColor=baseColor*color;\n}",anaglyphPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D leftSampler;\nvoid main(void)\n{\nvec4 leftFrag=texture2D(leftSampler,vUV);\nleftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);\nvec4 rightFrag=texture2D(textureSampler,vUV);\nrightFrag=vec4(rightFrag.r,1.0,1.0,1.0);\ngl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);\n}",stereoscopicInterlacePixelShader:"const vec3 TWO=vec3(2.0,2.0,2.0);\nvarying vec2 vUV;\nuniform sampler2D camASampler;\nuniform sampler2D textureSampler;\nuniform vec2 stepSize;\nvoid main(void)\n{\nbool useCamB;\nvec2 texCoord1;\nvec2 texCoord2;\nvec3 frag1;\nvec3 frag2;\n#ifdef IS_STEREOSCOPIC_HORIZ\nuseCamB=vUV.x>0.5;\ntexCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);\ntexCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);\n#else\nuseCamB=vUV.y>0.5;\ntexCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);\ntexCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);\n#endif\n\nif (useCamB){\nfrag1=texture2D(textureSampler,texCoord1).rgb;\nfrag2=texture2D(textureSampler,texCoord2).rgb;\n}else{\nfrag1=texture2D(camASampler ,texCoord1).rgb;\nfrag2=texture2D(camASampler ,texCoord2).rgb;\n}\ngl_FragColor=vec4((frag1+frag2)/TWO,1.0);\n}",vrDistortionCorrectionPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 LensCenter;\nuniform vec2 Scale;\nuniform vec2 ScaleIn;\nuniform vec4 HmdWarpParam;\nvec2 HmdWarp(vec2 in01) {\nvec2 theta=(in01-LensCenter)*ScaleIn; \nfloat rSq=theta.x*theta.x+theta.y*theta.y;\nvec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);\nreturn LensCenter+Scale*rvector;\n}\nvoid main(void)\n{\nvec2 tc=HmdWarp(vUV);\nif (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\ngl_FragColor=vec4(0.0,0.0,0.0,0.0);\nelse{\ngl_FragColor=texture2D(textureSampler,tc);\n}\n}",glowBlurPostProcessPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nuniform vec2 direction;\nuniform float blurWidth;\n\nfloat getLuminance(vec3 color)\n{\nreturn dot(color,vec3(0.2126,0.7152,0.0722));\n}\nvoid main(void)\n{\nfloat weights[7];\nweights[0]=0.05;\nweights[1]=0.1;\nweights[2]=0.2;\nweights[3]=0.3;\nweights[4]=0.2;\nweights[5]=0.1;\nweights[6]=0.05;\nvec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);\nvec2 texelStep=texelSize*direction*blurWidth;\nvec2 start=vUV-3.0*texelStep;\nvec4 baseColor=vec4(0.,0.,0.,0.);\nvec2 texelOffset=vec2(0.,0.);\nfor (int i=0; i<7; i++)\n{\n\nvec4 texel=texture2D(textureSampler,start+texelOffset);\nbaseColor.a+=texel.a*weights[i];\n\nfloat luminance=getLuminance(baseColor.rgb);\nfloat luminanceTexel=getLuminance(texel.rgb);\nfloat choice=step(luminanceTexel,luminance);\nbaseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;\ntexelOffset+=texelStep;\n}\ngl_FragColor=baseColor;\n}",glowMapGenerationPixelShader:"#ifdef ALPHATEST\nvarying vec2 vUVDiffuse;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform sampler2D emissiveSampler;\n#endif\nuniform vec4 color;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUVDiffuse).a<0.4)\ndiscard;\n#endif\n#ifdef EMISSIVE\ngl_FragColor=texture2D(emissiveSampler,vUVEmissive)*color;\n#else\ngl_FragColor=color;\n#endif\n}",glowMapGenerationVertexShader:"\nattribute vec3 position;\n#include<bonesDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nvarying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef ALPHATEST\nvarying vec2 vUVDiffuse;\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform mat4 emissiveMatrix;\n#endif\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#ifdef CUBEMAP\nvPosition=finalWorld*vec4(positionUpdated,1.0);\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\ngl_Position=vPosition;\n#endif\n#ifdef ALPHATEST\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",glowMapMergePixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n#ifdef EMISSIVE\nuniform sampler2D textureSampler2;\n#endif\n\nuniform float offset;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef EMISSIVE\nbaseColor+=texture2D(textureSampler2,vUV);\nbaseColor*=offset;\n#else\nbaseColor.a=abs(offset-baseColor.a);\n#ifdef STROKE\nfloat alpha=smoothstep(.0,.1,baseColor.a);\nbaseColor.a=alpha;\nbaseColor.rgb=baseColor.rgb*alpha;\n#endif\n#endif\ngl_FragColor=baseColor;\n}",glowMapMergeVertexShader:"\nattribute vec2 position;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) {\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n}",lineVertexShader:"\nattribute vec3 position;\nattribute vec4 normal;\n\nuniform mat4 worldViewProjection;\nuniform float width;\nuniform float aspectRatio;\nvoid main(void) {\nvec4 viewPosition=worldViewProjection*vec4(position,1.0);\nvec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);\nvec2 currentScreen=viewPosition.xy/viewPosition.w;\nvec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;\ncurrentScreen.x*=aspectRatio;\nnextScreen.x*=aspectRatio;\nvec2 dir=normalize(nextScreen-currentScreen);\nvec2 normalDir=vec2(-dir.y,dir.x);\nnormalDir*=width/2.0;\nnormalDir.x/=aspectRatio;\nvec4 offset=vec4(normalDir*normal.w,0.0,0.0);\ngl_Position=viewPosition+offset;\n}",linePixelShader:"uniform vec4 color;\nvoid main(void) {\ngl_FragColor=color;\n}",outlineVertexShader:"\nattribute vec3 position;\nattribute vec3 normal;\n#include<bonesDeclaration>\n\nuniform float offset;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<logDepthDeclaration>\nvoid main(void)\n{\nvec3 offsetPosition=position+normal*offset;\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(offsetPosition,1.0);\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<logDepthVertex>\n}\n",outlinePixelShader:"#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform vec4 color;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<logDepthDeclaration>\nvoid main(void) {\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#include<logDepthFragment>\ngl_FragColor=color;\n}",layerVertexShader:"\nattribute vec2 position;\n\nuniform vec2 scale;\nuniform vec2 offset;\nuniform mat4 textureMatrix;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvec2 shiftedPosition=position*scale+offset;\nvUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));\ngl_Position=vec4(shiftedPosition,0.0,1.0);\n}",layerPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec4 color;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n}",backgroundVertexShader:"precision highp float;\n#include<__decl__backgroundVertex>\n#include<helperFunctions>\n\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2; \n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0\nvarying vec2 vDiffuseUV;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\nvoid main(void) {\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif \n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\nvec4 worldPos=finalWorld*vec4(position,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nmat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));\nvec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));\nif (fFovMultiplier<=1.0) {\nvDirectionW=normalize(segment);\n} else {\nvDirectionW=normalize(vDirectionW+(vDirectionW-segment));\n}\n#endif\n#endif\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif \n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0 \nif (vDiffuseInfos.x == 0.)\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n\n#include<clipPlaneVertex>\n\n#include<fogVertex>\n\n#include<shadowsVertex>[0..maxSimultaneousLights]\n\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n\n#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif\n}\n",
backgroundPixelShader:"#ifdef TEXTURELODSUPPORT\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nprecision highp float;\n#include<__decl__backgroundFragment>\n#define RECIPROCAL_PI2 0.15915494\n\nuniform vec3 vEyePosition;\n\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2; \n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV == 1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV == 2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<helperFunctions>\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#include<clipPlaneFragmentDeclaration>\n\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\n\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow(clamp(1.0-VdotN,0.,1.),5.0);\n}\n#endif\nvoid main(void) {\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition-vPositionW);\n\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(0.0,1.0,0.0);\n#endif\n\nfloat shadow=1.;\nfloat globalShadow=0.;\nfloat shadowLightCount=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n\nvec3 reflectionColor=vec3(1.,1.,1.);\n#ifdef REFLECTION\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nfloat reflectionLOD=vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\n\nreflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\nreflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD).rgb;\n#else\nfloat lodReflectionNormalized=clamp(reflectionLOD,0.,1.);\nfloat lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;\nvec3 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords).rgb;\nif(lodReflectionNormalizedDoubled<1.0){\nreflectionColor=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords).rgb,\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);\n} else {\nreflectionColor=mix(\nreflectionSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords).rgb,\nlodReflectionNormalizedDoubled-1.0\n);\n}\n#endif\n#else\nvec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);\nreflectionColor=reflectionSample.rgb;\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor=toLinearSpace(reflectionColor.rgb);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor=reflectionColor.bgr;\n#endif\n\nreflectionColor*=vReflectionInfos.x;\n#endif\n\nvec3 diffuseColor=vec3(1.,1.,1.);\nfloat finalAlpha=alpha;\n#ifdef DIFFUSE\nvec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap.rgb=toLinearSpace(diffuseMap.rgb);\n#endif\n\ndiffuseMap.rgb*=vDiffuseInfos.y;\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n\n#ifdef REFLECTIONFRESNEL\nvec3 colorBase=diffuseColor;\n#else\nvec3 colorBase=reflectionColor*diffuseColor;\n#endif\ncolorBase=max(colorBase,0.0);\n\n#ifdef USERGBCOLOR\nvec3 finalColor=colorBase;\n#else\nvec3 finalColor=colorBase.r*vPrimaryColor.rgb*vPrimaryColor.a;\nfinalColor+=colorBase.g*vSecondaryColor.rgb*vSecondaryColor.a;\nfinalColor+=colorBase.b*vTertiaryColor.rgb*vTertiaryColor.a;\n#endif\n\n#ifdef REFLECTIONFRESNEL\nvec3 reflectionAmount=vReflectionControl.xxx;\nvec3 reflectionReflectance0=vReflectionControl.yyy;\nvec3 reflectionReflectance90=vReflectionControl.zzz;\nfloat VdotN=dot(normalize(vEyePosition),normalW);\nvec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(clamp(VdotN,0.0,1.0),reflectionReflectance0,reflectionReflectance90,1.0);\nreflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nfloat reflectionDistanceFalloff=1.0-clamp(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w,0.0,1.0);\nreflectionDistanceFalloff*=reflectionDistanceFalloff;\nreflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor,clamp(reflectionAmount,0.,1.));\n#endif\n#ifdef OPACITYFRESNEL\nfloat viewAngleToFloor=dot(normalW,normalize(vEyePosition-vBackgroundCenter));\n\nconst float startAngle=0.1;\nfloat fadeFactor=clamp(viewAngleToFloor/startAngle,0.0,1.0);\nfinalAlpha*=fadeFactor*fadeFactor;\n#endif\n\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);\n#endif\n\nvec4 color=vec4(finalColor,finalAlpha);\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n\n\ncolor.rgb=clamp(color.rgb,0.,30.0);\n#else\n\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\n\ncolor.rgb*=color.a;\n#endif\n#ifdef NOISE\ncolor.rgb+=dither(vPositionW.xy,0.5);\ncolor=max(color,0.0);\n#endif\ngl_FragColor=color;\n}\n"};r.Effect.IncludesShadersStore={depthPrePass:"#ifdef DEPTHPREPASS\ngl_FragColor=vec4(0.,0.,0.,1.0);\nreturn;\n#endif",bonesDeclaration:"#if NUM_BONE_INFLUENCERS>0\nuniform mat4 mBones[BonesPerMesh];\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;\nattribute vec4 matricesWeightsExtra;\n#endif\n#endif",instancesDeclaration:"#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#else\nuniform mat4 world;\n#endif",pointCloudVertexDeclaration:"#ifdef POINTSIZE\nuniform float pointSize;\n#endif",bumpVertexDeclaration:"#if defined(BUMP) || defined(PARALLAX)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n",clipPlaneVertexDeclaration:"#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nvarying float fClipDistance;\n#endif",fogVertexDeclaration:"#ifdef FOG\nvarying vec3 vFogDistance;\n#endif",morphTargetsVertexGlobalDeclaration:"#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#endif",morphTargetsVertexDeclaration:"#ifdef MORPHTARGETS\nattribute vec3 position{X};\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#endif",logDepthDeclaration:"#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;\nvarying float vFragmentDepth;\n#endif",morphTargetsVertex:"#ifdef MORPHTARGETS\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#endif",instancesVertex:"#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#else\nmat4 finalWorld=world;\n#endif",bonesVertex:"#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif \nfinalWorld=finalWorld*influence;\n#endif",bumpVertex:"#if defined(BUMP) || defined(PARALLAX)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);\nvec3 tbnTangent=normalize(tangentUpdated.xyz);\nvec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;\nvTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif",clipPlaneVertex:"#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif",fogVertex:"#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif",shadowsVertex:"#ifdef SHADOWS\n#if defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\nvDepthMetric{X}=((vPositionFromLight{X}.z+light{X}.depthValues.x)/(light{X}.depthValues.y));\n#endif\n#endif",pointCloudVertex:"#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif",logDepthVertex:"#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;\ngl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif",helperFunctions:"const float PI=3.1415926535897932384626433832795;\nconst float LinearEncodePowerApprox=2.2;\nconst float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;\nconst vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);\nmat3 transposeMat3(mat3 inMatrix) {\nvec3 i0=inMatrix[0];\nvec3 i1=inMatrix[1];\nvec3 i2=inMatrix[2];\nmat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);\nreturn outMatrix;\n}\n\nmat3 inverseMat3(mat3 inMatrix) {\nfloat a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];\nfloat a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];\nfloat a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];\nfloat b01=a22*a11-a12*a21;\nfloat b11=-a22*a10+a12*a20;\nfloat b21=a21*a10-a11*a20;\nfloat det=a00*b01+a01*b11+a02*b21;\nreturn mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),\nb11,(a22*a00-a02*a20),(-a12*a00+a02*a10),\nb21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;\n}\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{\nfloat mask=smoothstep(1.0-frustumEdgeFalloff,1.0,clamp(dot(clipSpace,clipSpace),0.,1.));\nreturn mix(value,1.0,mask);\n}\nvec3 applyEaseInOut(vec3 x){\nreturn x*x*(3.0-2.0*x);\n}\nvec3 toLinearSpace(vec3 color)\n{\nreturn pow(color,vec3(LinearEncodePowerApprox));\n}\nvec3 toGammaSpace(vec3 color)\n{\nreturn pow(color,vec3(GammaEncodePowerApprox));\n}\nfloat square(float value)\n{\nreturn value*value;\n}\nfloat getLuminance(vec3 color)\n{\nreturn clamp(dot(color,LuminanceEncodeApprox),0.,1.);\n}\n\nfloat getRand(vec2 seed) {\nreturn fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);\n}\nfloat dither(vec2 seed,float varianceAmount) {\nfloat rand=getRand(seed);\nfloat dither=mix(-varianceAmount/255.0,varianceAmount/255.0,rand);\nreturn dither;\n}",lightFragmentDeclaration:"#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec3 vLightSpecular{X};\n#else\nvec3 vLightSpecular{X}=vec3(0.);\n#endif\n#ifdef SHADOW{X}\n#if defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X};\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};\nuniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\n#endif\n#ifdef HEMILIGHT{X}\nuniform vec3 vLightGround{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#endif",lightsFragmentFunctions:"\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 lightVectorW;\nfloat attenuation=1.0;\nif (lightData.w == 0.)\n{\nvec3 direction=lightData.xyz-vPositionW;\nattenuation=max(0.,1.0-length(direction)/range);\nlightVectorW=normalize(direction);\n}\nelse\n{\nlightVectorW=normalize(-lightData.xyz);\n}\n\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 direction=lightData.xyz-vPositionW;\nvec3 lightVectorW=normalize(direction);\nfloat attenuation=max(0.,1.0-length(direction)/range);\n\nfloat cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));\nif (cosAngle>=lightDirection.w)\n{\ncosAngle=max(0.,pow(cosAngle,lightData.w));\nattenuation*=cosAngle;\n\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {\nlightingInfo result;\n\nfloat ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor;\n#endif\nreturn result;\n}\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){\nvec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);\nstrq/=strq.w;\nvec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;\n#ifdef PBR\ntextureColor=toLinearSpace(textureColor);\n#endif\nreturn textureColor;\n}",lightUboDeclaration:"#ifdef LIGHT{X}\nuniform Light{X}\n{\nvec4 vLightData;\nvec4 vLightDiffuse;\nvec3 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;\n#endif\n#ifdef HEMILIGHT{X}\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;\nvec2 depthValues;\n} light{X};\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#ifdef SHADOW{X}\n#if defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X}; \n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif",defaultVertexDeclaration:"\nuniform mat4 viewProjection;\nuniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\nuniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n",defaultFragmentDeclaration:"uniform vec4 vDiffuseColor;\n#ifdef SPECULARTERM\nuniform vec4 vSpecularColor;\n#endif\nuniform vec3 vEmissiveColor;\n\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;\nuniform vec4 refractionRightColor;\n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;\nuniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;\nuniform vec4 emissiveRightColor;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REFLECTIONMAP_SKYBOX\n#else\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION)\nuniform mat4 reflectionMatrix;\n#endif\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;\nuniform vec4 reflectionRightColor;\n#endif\n#endif",defaultUboDeclaration:"layout(std140,column_major) uniform;\nuniform Material\n{\nvec4 diffuseLeftColor;\nvec4 diffuseRightColor;\nvec4 opacityParts;\nvec4 reflectionLeftColor;\nvec4 reflectionRightColor;\nvec4 refractionLeftColor;\nvec4 refractionRightColor;\nvec4 emissiveLeftColor; \nvec4 emissiveRightColor;\nvec2 vDiffuseInfos;\nvec2 vAmbientInfos;\nvec2 vOpacityInfos;\nvec2 vReflectionInfos;\nvec3 vReflectionPosition;\nvec3 vReflectionSize;\nvec2 vEmissiveInfos;\nvec2 vLightmapInfos;\nvec2 vSpecularInfos;\nvec3 vBumpInfos;\nmat4 diffuseMatrix;\nmat4 ambientMatrix;\nmat4 opacityMatrix;\nmat4 reflectionMatrix;\nmat4 emissiveMatrix;\nmat4 lightmapMatrix;\nmat4 specularMatrix;\nmat4 bumpMatrix; \nvec4 vTangentSpaceParams;\nmat4 refractionMatrix;\nvec4 vRefractionInfos;\nvec4 vSpecularColor;\nvec3 vEmissiveColor;\nvec4 vDiffuseColor;\nfloat pointSize; \n};\nuniform Scene {\nmat4 viewProjection;\nmat4 view;\n};",
shadowsFragmentFunctions:"#ifdef SHADOWS\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nfloat computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nif (depth>shadow)\n{\nreturn darkness;\n}\nreturn 1.0;\n}\nfloat computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\nfloat visibility=1.;\nvec3 poissonDisk[4];\npoissonDisk[0]=vec3(-1.0,1.0,-1.0);\npoissonDisk[1]=vec3(1.0,-1.0,-1.0);\npoissonDisk[2]=vec3(-1.0,-1.0,-1.0);\npoissonDisk[3]=vec3(1.0,-1.0,1.0);\n\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);\n}\nfloat computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); \nreturn esm;\n}\nfloat computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn esm;\n}\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uv));\n#else\nfloat shadow=texture2D(shadowSampler,uv).x;\n#endif\nif (shadowPixelDepth>shadow)\n{\nreturn computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff);\n}\nreturn 1.;\n}\nfloat computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\nfloat visibility=1.;\nvec2 poissonDisk[4];\npoissonDisk[0]=vec2(-0.94201624,-0.39906216);\npoissonDisk[1]=vec2(0.94558609,-0.76890725);\npoissonDisk[2]=vec2(-0.094184101,-0.92938870);\npoissonDisk[3]=vec2(0.34495938,0.29387760);\n\n#ifndef SHADOWFLOAT\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[0]*mapSize))<shadowPixelDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[1]*mapSize))<shadowPixelDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[2]*mapSize))<shadowPixelDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[3]*mapSize))<shadowPixelDepth) visibility-=0.25;\n#else\nif (texture2D(shadowSampler,uv+poissonDisk[0]*mapSize).x<shadowPixelDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[1]*mapSize).x<shadowPixelDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[2]*mapSize).x<shadowPixelDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[3]*mapSize).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);\n}\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(texture2D(shadowSampler,uv));\n#else\nfloat shadowMapSample=texture2D(shadowSampler,uv).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(texture2D(shadowSampler,uv));\n#else\nfloat shadowMapSample=texture2D(shadowSampler,uv).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\n#ifdef WEBGL2\n\nfloat computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nfloat shadow=texture2D(shadowSampler,uvDepth);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n\n\n\nfloat computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \n\n\n\n\nvec2 uvw0=3.-2.*st;\nvec2 uvw1=1.+2.*st;\nvec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;\nvec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z));\nshadow=shadow/16.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n\n\n\nfloat computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \n\n\nvec2 uvw0=4.-3.*st;\nvec2 uvw1=vec2(7.);\nvec2 uvw2=1.+3.*st;\nvec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;\nvec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z));\nshadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z));\nshadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z));\nshadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z));\nshadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z));\nshadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z));\nshadow=shadow/144.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\nconst vec3 PoissonSamplers32[64]=vec3[64](\nvec3(0.06407013,0.05409927,0.),\nvec3(0.7366577,0.5789394,0.),\nvec3(-0.6270542,-0.5320278,0.),\nvec3(-0.4096107,0.8411095,0.),\nvec3(0.6849564,-0.4990818,0.),\nvec3(-0.874181,-0.04579735,0.),\nvec3(0.9989998,0.0009880066,0.),\nvec3(-0.004920578,-0.9151649,0.),\nvec3(0.1805763,0.9747483,0.),\nvec3(-0.2138451,0.2635818,0.),\nvec3(0.109845,0.3884785,0.),\nvec3(0.06876755,-0.3581074,0.),\nvec3(0.374073,-0.7661266,0.),\nvec3(0.3079132,-0.1216763,0.),\nvec3(-0.3794335,-0.8271583,0.),\nvec3(-0.203878,-0.07715034,0.),\nvec3(0.5912697,0.1469799,0.),\nvec3(-0.88069,0.3031784,0.),\nvec3(0.5040108,0.8283722,0.),\nvec3(-0.5844124,0.5494877,0.),\nvec3(0.6017799,-0.1726654,0.),\nvec3(-0.5554981,0.1559997,0.),\nvec3(-0.3016369,-0.3900928,0.),\nvec3(-0.5550632,-0.1723762,0.),\nvec3(0.925029,0.2995041,0.),\nvec3(-0.2473137,0.5538505,0.),\nvec3(0.9183037,-0.2862392,0.),\nvec3(0.2469421,0.6718712,0.),\nvec3(0.3916397,-0.4328209,0.),\nvec3(-0.03576927,-0.6220032,0.),\nvec3(-0.04661255,0.7995201,0.),\nvec3(0.4402924,0.3640312,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.)\n);\nconst vec3 PoissonSamplers64[64]=vec3[64](\nvec3(-0.613392,0.617481,0.),\nvec3(0.170019,-0.040254,0.),\nvec3(-0.299417,0.791925,0.),\nvec3(0.645680,0.493210,0.),\nvec3(-0.651784,0.717887,0.),\nvec3(0.421003,0.027070,0.),\nvec3(-0.817194,-0.271096,0.),\nvec3(-0.705374,-0.668203,0.),\nvec3(0.977050,-0.108615,0.),\nvec3(0.063326,0.142369,0.),\nvec3(0.203528,0.214331,0.),\nvec3(-0.667531,0.326090,0.),\nvec3(-0.098422,-0.295755,0.),\nvec3(-0.885922,0.215369,0.),\nvec3(0.566637,0.605213,0.),\nvec3(0.039766,-0.396100,0.),\nvec3(0.751946,0.453352,0.),\nvec3(0.078707,-0.715323,0.),\nvec3(-0.075838,-0.529344,0.),\nvec3(0.724479,-0.580798,0.),\nvec3(0.222999,-0.215125,0.),\nvec3(-0.467574,-0.405438,0.),\nvec3(-0.248268,-0.814753,0.),\nvec3(0.354411,-0.887570,0.),\nvec3(0.175817,0.382366,0.),\nvec3(0.487472,-0.063082,0.),\nvec3(-0.084078,0.898312,0.),\nvec3(0.488876,-0.783441,0.),\nvec3(0.470016,0.217933,0.),\nvec3(-0.696890,-0.549791,0.),\nvec3(-0.149693,0.605762,0.),\nvec3(0.034211,0.979980,0.),\nvec3(0.503098,-0.308878,0.),\nvec3(-0.016205,-0.872921,0.),\nvec3(0.385784,-0.393902,0.),\nvec3(-0.146886,-0.859249,0.),\nvec3(0.643361,0.164098,0.),\nvec3(0.634388,-0.049471,0.),\nvec3(-0.688894,0.007843,0.),\nvec3(0.464034,-0.188818,0.),\nvec3(-0.440840,0.137486,0.),\nvec3(0.364483,0.511704,0.),\nvec3(0.034028,0.325968,0.),\nvec3(0.099094,-0.308023,0.),\nvec3(0.693960,-0.366253,0.),\nvec3(0.678884,-0.204688,0.),\nvec3(0.001801,0.780328,0.),\nvec3(0.145177,-0.898984,0.),\nvec3(0.062655,-0.611866,0.),\nvec3(0.315226,-0.604297,0.),\nvec3(-0.780145,0.486251,0.),\nvec3(-0.371868,0.882138,0.),\nvec3(0.200476,0.494430,0.),\nvec3(-0.494552,-0.711051,0.),\nvec3(0.612476,0.705252,0.),\nvec3(-0.578845,-0.768792,0.),\nvec3(-0.772454,-0.090976,0.),\nvec3(0.504440,0.372295,0.),\nvec3(0.155736,0.065157,0.),\nvec3(0.391522,0.849605,0.),\nvec3(-0.620106,-0.328104,0.),\nvec3(0.789239,-0.419965,0.),\nvec3(-0.545396,0.538133,0.),\nvec3(-0.178564,-0.596057,0.)\n);\n\n\n\n\n\nfloat computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nfloat blockerDepth=0.0;\nfloat sumBlockerDepth=0.0;\nfloat numBlocker=0.0;\nfor (int i=0; i<searchTapCount; i ++) {\nblockerDepth=texture(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy)).r;\nif (blockerDepth<depthMetric) {\nsumBlockerDepth+=blockerDepth;\nnumBlocker++;\n}\n}\nif (numBlocker<1.0) {\nreturn 1.0;\n}\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;\n\nfloat AAOffset=shadowMapSizeInverse*10.;\n\n\nfloat penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);\nfloat filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;\nfloat random=getRand(vPositionFromLight.xy);\nfloat rotationAngle=random*3.1415926;\nvec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));\nfloat shadow=0.;\nfor (int i=0; i<pcfTapCount; i++) {\nvec3 offset=poissonSamplers[i];\n\noffset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);\nshadow+=texture2D(shadowSampler,uvDepth+offset*filterRadius);\n}\nshadow/=float(pcfTapCount);\n\nshadow=mix(shadow,1.,depthMetric-avgBlockerDepth);\n\nshadow=mix(darkness,1.,shadow);\n\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\nfloat computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);\n}\nfloat computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);\n}\nfloat computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);\n}\n#endif\n#endif\n",fresnelFunction:"#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{\nfloat fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);\nreturn clamp(fresnelTerm,0.,1.);\n}\n#endif",reflectionFunction:"#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nvec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {\n\nvec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;\nvec3 halfSize=cubeSize*0.5;\nvec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;\nvec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;\n\nvec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);\n\nfloat distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);\n\nvec3 intersectPositionWS=vertexPos+origVec*distance;\n\nreturn intersectPositionWS-cubePos;\n}\n#endif\nvec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvec3 direction=vDirectionW;\nfloat t=clamp(direction.y*-0.5+0.5,0.,1.0);\nfloat s=atan(direction.z,direction.x)*RECIPROCAL_PI2+0.5;\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nreturn vec3(1.0-s,t,0);\n#else\nreturn vec3(s,t,0);\n#endif\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nvec3 cameraToVertex=normalize(worldPos.xyz-vEyePosition.xyz);\nvec3 r=reflect(cameraToVertex,worldNormal);\nfloat t=clamp(r.y*-0.5+0.5,0.,1.0);\nfloat s=atan(r.z,r.x)*RECIPROCAL_PI2+0.5;\nreturn vec3(s,t,0);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nvec3 viewDir=normalize(vec3(view*worldPos));\nvec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));\nvec3 r=reflect(viewDir,viewNormal);\nr.z=r.z-1.0;\nfloat m=2.0*length(r);\nreturn vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nvec3 viewDir=worldPos.xyz-vEyePosition.xyz;\nvec3 coords=normalize(reflect(viewDir,worldNormal));\nreturn vec3(reflectionMatrix*vec4(coords,1));\n#endif\n#ifdef REFLECTIONMAP_CUBIC\nvec3 viewDir=normalize(worldPos.xyz-vEyePosition.xyz);\n\nvec3 coords=reflect(viewDir,worldNormal);\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\ncoords=parallaxCorrectNormal(worldPos.xyz,coords,vReflectionSize,vReflectionPosition);\n#endif\ncoords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn vec3(reflectionMatrix*(view*worldPos));\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn vPositionUVW;\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}",imageProcessingDeclaration:"#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#ifdef VIGNETTE\nuniform vec2 vInverseScreenSize;\nuniform vec4 vignetteSettings1;\nuniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;\nuniform vec4 vCameraColorCurveNeutral;\nuniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nuniform highp sampler3D txColorTransform;\n#else\nuniform sampler2D txColorTransform;\n#endif\nuniform vec4 colorTransformSettings;\n#endif",imageProcessingFunctions:"#if defined(COLORGRADING) && !defined(COLORGRADING3D)\n\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{\nfloat sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);\n\n\nfloat sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;\nsliceUV.x+=sliceInteger*sliceSize;\nsliceUV=clamp(sliceUV,0.,1.);\nvec4 slice0Color=texture2D(colorTransform,sliceUV);\nsliceUV.x+=sliceSize;\nsliceUV=clamp(sliceUV,0.,1.);\nvec4 slice1Color=texture2D(colorTransform,sliceUV);\nvec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;\n}\n#endif\nvec4 applyImageProcessing(vec4 result) {\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\n\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;\nviewportXY=viewportXY*2.0-1.0;\nvec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);\nfloat vignetteTerm=dot(vignetteXY1,vignetteXY1);\nfloat vignette=pow(vignetteTerm,vignetteSettings2.w);\n\nvec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);\nresult.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#ifdef TONEMAPPING\nconst float tonemappingCalibration=1.590579;\nresult.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\n\nresult.rgb=toGammaSpace(result.rgb);\nresult.rgb=clamp(result.rgb,0.0,1.0);\n#ifdef CONTRAST\n\nvec3 resultHighContrast=applyEaseInOut(result.rgb);\nif (contrast<1.0) {\n\nresult.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);\n} else {\n\nresult.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);\n}\n#endif\n\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;\n#else\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\n#endif\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\n\nfloat luma=getLuminance(result.rgb);\nvec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));\nvec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;\nresult.rgb*=colorCurve.rgb;\nresult.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\nreturn result;\n}",bumpFragmentFunctions:"#ifdef BUMP\n#if BUMPDIRECTUV == 1\n#define vBumpUV vMainUV1\n#elif BUMPDIRECTUV == 2\n#define vBumpUV vMainUV2\n#else\nvarying vec2 vBumpUV;\n#endif\nuniform sampler2D bumpSampler;\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#endif\n\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv)\n{\n\nuv=gl_FrontFacing ? uv : -uv;\n\nvec3 dp1=dFdx(p);\nvec3 dp2=dFdy(p);\nvec2 duv1=dFdx(uv);\nvec2 duv2=dFdy(uv);\n\nvec3 dp2perp=cross(dp2,normal);\nvec3 dp1perp=cross(normal,dp1);\nvec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;\nvec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;\n\ntangent*=vTangentSpaceParams.x;\nbitangent*=vTangentSpaceParams.y;\n\nfloat invmax=inversesqrt(max(dot(tangent,tangent),dot(bitangent,bitangent)));\nreturn mat3(tangent*invmax,bitangent*invmax,normal);\n}\nvec3 perturbNormal(mat3 cotangentFrame,vec2 uv)\n{\nvec3 map=texture2D(bumpSampler,uv).xyz;\nmap=map*2.0-1.0;\n#ifdef NORMALXYSCALE\nmap=normalize(map*vec3(vBumpInfos.y,vBumpInfos.y,1.0));\n#endif\nreturn normalize(cotangentFrame*map);\n}\n#ifdef PARALLAX\nconst float minSamples=4.;\nconst float maxSamples=15.;\nconst int iMaxSamples=15;\n\nvec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {\nfloat parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;\nparallaxLimit*=parallaxScale;\nvec2 vOffsetDir=normalize(vViewDirCoT.xy);\nvec2 vMaxOffset=vOffsetDir*parallaxLimit;\nfloat numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));\nfloat stepSize=1.0/numSamples;\n\nfloat currRayHeight=1.0;\nvec2 vCurrOffset=vec2(0,0);\nvec2 vLastOffset=vec2(0,0);\nfloat lastSampledHeight=1.0;\nfloat currSampledHeight=1.0;\nfor (int i=0; i<iMaxSamples; i++)\n{\ncurrSampledHeight=texture2D(bumpSampler,vBumpUV+vCurrOffset).w;\n\nif (currSampledHeight>currRayHeight)\n{\nfloat delta1=currSampledHeight-currRayHeight;\nfloat delta2=(currRayHeight+stepSize)-lastSampledHeight;\nfloat ratio=delta1/(delta1+delta2);\nvCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;\n\nbreak;\n}\nelse\n{\ncurrRayHeight-=stepSize;\nvLastOffset=vCurrOffset;\nvCurrOffset+=stepSize*vMaxOffset;\nlastSampledHeight=currSampledHeight;\n}\n}\nreturn vCurrOffset;\n}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{\n\nfloat height=texture2D(bumpSampler,vBumpUV).w;\nvec2 texCoordOffset=heightScale*viewDir.xy*height;\nreturn -texCoordOffset;\n}\n#endif\n#endif",clipPlaneFragmentDeclaration:"#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif",fogFragmentDeclaration:"#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;\nuniform vec3 vFogColor;\nvarying vec3 vFogDistance;\nfloat CalcFogFactor()\n{\nfloat fogCoeff=1.0;\nfloat fogStart=vFogInfos.y;\nfloat fogEnd=vFogInfos.z;\nfloat fogDensity=vFogInfos.w;\nfloat fogDistance=length(vFogDistance);\nif (FOGMODE_LINEAR == vFogInfos.x)\n{\nfogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);\n}\nelse if (FOGMODE_EXP == vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDensity);\n}\nelse if (FOGMODE_EXP2 == vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);\n}\nreturn clamp(fogCoeff,0.0,1.0);\n}\n#endif",clipPlaneFragment:"#ifdef CLIPPLANE\nif (fClipDistance>0.0)\n{\ndiscard;\n}\n#endif",bumpFragment:"vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#else \nfloat normalScale=vBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nmat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,vBumpUV);\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\nnormalW=normalize(texture2D(bumpSampler,vBumpUV).xyz*2.0-1.0);\nnormalW=normalize(mat3(normalMatrix)*normalW); \n#else\nnormalW=perturbNormal(TBN,vBumpUV+uvOffset);\n#endif\n#endif",
lightFragment:"#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || (defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X}))\n\n#else\n#ifdef PBR\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,roughness,NdotV,specularEnvironmentR0,specularEnvironmentR90,geometricRoughnessFactor,NdotL);\n#endif\n#ifdef HEMILIGHT{X}\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightGround,roughness,NdotV,specularEnvironmentR0,specularEnvironmentR90,geometricRoughnessFactor,NdotL);\n#endif\n#if defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,roughness,NdotV,specularEnvironmentR0,specularEnvironmentR90,geometricRoughnessFactor,NdotL);\n#endif\n#else\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#ifdef HEMILIGHT{X}\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightGround,glossiness);\n#endif\n#if defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCLOSEESM{X}\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;\nshadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor;\n#endif\n#endif\n#else\ndiffuseBase+=info.diffuse*shadow;\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#endif\n#endif\n#endif",logDepthFragment:"#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif",fogFragment:"#ifdef FOG\nfloat fog=CalcFogFactor();\ncolor.rgb=fog*color.rgb+(1.0-fog)*vFogColor;\n#endif",pbrVertexDeclaration:"uniform mat4 view;\nuniform mat4 viewProjection;\n#ifdef ALBEDO\nuniform mat4 albedoMatrix;\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec3 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY \nuniform vec3 vReflectivityInfos;\nuniform mat4 reflectivityMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\nuniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\nuniform vec3 vRefractionMicrosurfaceInfos;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n",pbrFragmentDeclaration:"uniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\n\nuniform vec4 vLightingIntensity;\nuniform vec4 vReflectivityColor;\nuniform vec3 vEmissiveColor;\n\n#ifdef ALBEDO\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform vec3 vAmbientInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\n#endif\n\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\nuniform vec3 vRefractionMicrosurfaceInfos;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \n#endif\n#endif",pbrUboDeclaration:"layout(std140,column_major) uniform;\nuniform Material\n{\nuniform vec2 vAlbedoInfos;\nuniform vec3 vAmbientInfos;\nuniform vec2 vOpacityInfos;\nuniform vec2 vEmissiveInfos;\nuniform vec2 vLightmapInfos;\nuniform vec3 vReflectivityInfos;\nuniform vec2 vMicroSurfaceSamplerInfos;\nuniform vec4 vRefractionInfos;\nuniform vec2 vReflectionInfos;\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \nuniform vec3 vBumpInfos;\nuniform mat4 albedoMatrix;\nuniform mat4 ambientMatrix;\nuniform mat4 opacityMatrix;\nuniform mat4 emissiveMatrix;\nuniform mat4 lightmapMatrix;\nuniform mat4 reflectivityMatrix;\nuniform mat4 microSurfaceSamplerMatrix;\nuniform mat4 bumpMatrix;\nuniform vec2 vTangentSpaceParams;\nuniform mat4 refractionMatrix;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\nuniform vec4 vLightingIntensity;\nuniform vec3 vRefractionMicrosurfaceInfos;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform vec4 vReflectivityColor;\nuniform vec3 vEmissiveColor;\nuniform float pointSize;\n};\nuniform Scene {\nmat4 viewProjection;\nmat4 view;\n};",pbrFunctions:"\n#define RECIPROCAL_PI2 0.15915494\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n\nconst float kRougnhessToAlphaScale=0.1;\nconst float kRougnhessToAlphaOffset=0.29248125;\nfloat convertRoughnessToAverageSlope(float roughness)\n{\n\nconst float kMinimumVariance=0.0005;\nfloat alphaG=square(roughness)+kMinimumVariance;\nreturn alphaG;\n}\n\nfloat smithVisibilityG1_TrowbridgeReitzGGX(float dot,float alphaG)\n{\nfloat tanSquared=(1.0-dot*dot)/(dot*dot);\nreturn 2.0/(1.0+sqrt(1.0+alphaG*alphaG*tanSquared));\n}\nfloat smithVisibilityG_TrowbridgeReitzGGX_Walter(float NdotL,float NdotV,float alphaG)\n{\nreturn smithVisibilityG1_TrowbridgeReitzGGX(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGX(NdotV,alphaG);\n}\n\n\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{\n\n\n\nfloat a2=square(alphaG);\nfloat d=NdotH*NdotH*(a2-1.0)+1.0;\nreturn a2/(PI*d*d);\n}\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow(clamp(1.0-VdotH,0.,1.),5.0);\n}\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\n\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow(clamp(1.0-VdotN,0.,1.),5.0);\n}\n\nvec3 computeSpecularTerm(float NdotH,float NdotL,float NdotV,float VdotH,float roughness,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor)\n{\nroughness=max(roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\nfloat visibility=smithVisibilityG_TrowbridgeReitzGGX_Walter(NdotL,NdotV,alphaG);\nvisibility/=(4.0*NdotL*NdotV); \nfloat specTerm=max(0.,visibility*distribution)*NdotL;\nvec3 fresnel=fresnelSchlickGGX(VdotH,reflectance0,reflectance90);\nreturn fresnel*specTerm;\n}\nfloat computeDiffuseTerm(float NdotL,float NdotV,float VdotH,float roughness)\n{\n\n\nfloat diffuseFresnelNV=pow(clamp(1.0-NdotL,0.000001,1.),5.0);\nfloat diffuseFresnelNL=pow(clamp(1.0-NdotV,0.000001,1.),5.0);\nfloat diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;\nfloat fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);\nreturn fresnel*NdotL/PI;\n}\nfloat adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\n\nfloat lightRoughness=lightRadius/lightDistance;\n\nfloat totalRoughness=clamp(lightRoughness+roughness,0.,1.);\nreturn totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{\nconst float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;\nfloat reflectivityLuminance=getLuminance(reflectivityColor);\nfloat reflectivityLuma=sqrt(reflectivityLuminance);\nmicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;\nreturn microSurface;\n}\n\n\nfloat fresnelGrazingReflectance(float reflectance0) {\nfloat reflectance90=clamp(reflectance0*25.0,0.0,1.0);\nreturn reflectance90;\n}\n\n\n#define UNPACK_LOD(x) (1.0-x)*255.0\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {\nfloat microsurfaceAverageSlope=alphaG;\n\n\n\n\n\n\nmicrosurfaceAverageSlope*=sqrt(abs(NdotV));\nfloat microsurfaceAverageSlopeTexels=microsurfaceAverageSlope*cubeMapDimensionPixels;\nfloat lod=log2(microsurfaceAverageSlopeTexels);\nreturn lod;\n}\nfloat environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {\n\n\nfloat temp=NdotVUnclamped+ambientOcclusion;\nreturn clamp(square(temp)-1.0+ambientOcclusion,0.0,1.0);\n}\nfloat environmentHorizonOcclusion(vec3 reflection,vec3 normal) {\n\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflection.z*=-1.0;\n#endif\nfloat temp=clamp( 1.0+1.1*dot(reflection,normal),0.0,1.0);\nreturn square(temp);\n}",harmonicsFunctions:"#ifdef USESPHERICALFROMREFLECTIONMAP\nuniform vec3 vSphericalX;\nuniform vec3 vSphericalY;\nuniform vec3 vSphericalZ;\nuniform vec3 vSphericalXX_ZZ;\nuniform vec3 vSphericalYY_ZZ;\nuniform vec3 vSphericalZZ;\nuniform vec3 vSphericalXY;\nuniform vec3 vSphericalYZ;\nuniform vec3 vSphericalZX;\nvec3 quaternionVectorRotation_ScaledSqrtTwo(vec4 Q,vec3 V){\nvec3 T=cross(Q.xyz,V);\nT+=Q.www*V;\nreturn cross(Q.xyz,T)+V;\n}\nvec3 environmentIrradianceJones(vec3 normal)\n{\n\n\n\n\n\n\n\n\n\nfloat Nx=normal.x;\nfloat Ny=normal.y;\nfloat Nz=normal.z;\nvec3 C1=vSphericalZZ.rgb;\nvec3 Cx=vSphericalX.rgb;\nvec3 Cy=vSphericalY.rgb;\nvec3 Cz=vSphericalZ.rgb;\nvec3 Cxx_zz=vSphericalXX_ZZ.rgb;\nvec3 Cyy_zz=vSphericalYY_ZZ.rgb;\nvec3 Cxy=vSphericalXY.rgb;\nvec3 Cyz=vSphericalYZ.rgb;\nvec3 Czx=vSphericalZX.rgb;\nvec3 a1=Cyy_zz*Ny+Cy;\nvec3 a2=Cyz*Nz+a1;\nvec3 b1=Czx*Nz+Cx;\nvec3 b2=Cxy*Ny+b1;\nvec3 b3=Cxx_zz*Nx+b2;\nvec3 t1=Cz*Nz+C1;\nvec3 t2=a2*Ny+t1;\nvec3 t3=b3*Nx+t2;\nreturn t3;\n}\n#endif",pbrLightFunctions:"\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n};\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range)\n{ \n#ifdef USEPHYSICALLIGHTFALLOFF\nfloat lightDistanceFalloff=1.0/((lightDistanceSquared+0.001));\n#else\nfloat lightDistanceFalloff=max(0.,1.0-length(lightOffset)/range);\n#endif\nreturn lightDistanceFalloff;\n}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)\n{\nfloat falloff=0.0;\n#ifdef USEPHYSICALLIGHTFALLOFF\nconst float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \n\n\n\n\n\nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);\n\n\nvec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);\nfalloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));\n#else\nfloat cosAngle=max(0.000000000000001,dot(-lightDirection,directionToLightCenterW));\nif (cosAngle>=cosHalfAngle)\n{\nfalloff=max(0.,pow(cosAngle,exponent));\n}\n#endif\nreturn falloff;\n}\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float rangeRadius,float roughness,float NdotV,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,out float NdotL) {\nlightingInfo result;\nvec3 lightDirection;\nfloat attenuation=1.0;\nfloat lightDistance;\n\nif (lightData.w == 0.)\n{\nvec3 lightOffset=lightData.xyz-vPositionW;\nfloat lightDistanceSquared=dot(lightOffset,lightOffset);\nattenuation=computeDistanceLightFalloff(lightOffset,lightDistanceSquared,rangeRadius);\nlightDistance=sqrt(lightDistanceSquared);\nlightDirection=normalize(lightOffset);\n}\n\nelse\n{\nlightDistance=length(-lightData.xyz);\nlightDirection=normalize(-lightData.xyz);\n}\n\nroughness=adjustRoughnessFromLightProperties(roughness,rangeRadius,lightDistance);\n\nvec3 H=normalize(viewDirectionW+lightDirection);\nNdotL=clamp(dot(vNormal,lightDirection),0.00000000001,1.0);\nfloat VdotH=clamp(dot(viewDirectionW,H),0.0,1.0);\nfloat diffuseTerm=computeDiffuseTerm(NdotL,NdotV,VdotH,roughness);\nresult.diffuse=diffuseTerm*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nfloat NdotH=clamp(dot(vNormal,H),0.000000000001,1.0);\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,reflectance0,reflectance90,geometricRoughnessFactor);\nresult.specular=specTerm*diffuseColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float rangeRadius,float roughness,float NdotV,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,out float NdotL) {\nlightingInfo result;\nvec3 lightOffset=lightData.xyz-vPositionW;\nvec3 directionToLightCenterW=normalize(lightOffset);\n\nfloat lightDistanceSquared=dot(lightOffset,lightOffset);\nfloat attenuation=computeDistanceLightFalloff(lightOffset,lightDistanceSquared,rangeRadius);\n\nfloat directionalAttenuation=computeDirectionalLightFalloff(lightDirection.xyz,directionToLightCenterW,lightDirection.w,lightData.w);\nattenuation*=directionalAttenuation;\n\nfloat lightDistance=sqrt(lightDistanceSquared);\nroughness=adjustRoughnessFromLightProperties(roughness,rangeRadius,lightDistance);\n\nvec3 H=normalize(viewDirectionW+directionToLightCenterW);\nNdotL=clamp(dot(vNormal,directionToLightCenterW),0.000000000001,1.0);\nfloat VdotH=clamp(dot(viewDirectionW,H),0.0,1.0);\nfloat diffuseTerm=computeDiffuseTerm(NdotL,NdotV,VdotH,roughness);\nresult.diffuse=diffuseTerm*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nfloat NdotH=clamp(dot(vNormal,H),0.000000000001,1.0);\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,reflectance0,reflectance90,geometricRoughnessFactor);\nresult.specular=specTerm*diffuseColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float roughness,float NdotV,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,out float NdotL) {\nlightingInfo result;\n\n\n\nNdotL=dot(vNormal,lightData.xyz)*0.5+0.5;\nresult.diffuse=mix(groundColor,diffuseColor,NdotL);\n#ifdef SPECULARTERM\n\nvec3 lightVectorW=normalize(lightData.xyz);\nvec3 H=normalize(viewDirectionW+lightVectorW);\nfloat NdotH=clamp(dot(vNormal,H),0.000000000001,1.0);\nNdotL=clamp(NdotL,0.000000000001,1.0);\nfloat VdotH=clamp(dot(viewDirectionW,H),0.0,1.0);\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,reflectance0,reflectance90,geometricRoughnessFactor);\nresult.specular=specTerm*diffuseColor;\n#endif\nreturn result;\n}",kernelBlurFragment:"#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;\nsumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif",kernelBlurFragment2:"#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});\ncomputedWeight=KERNEL_DEP_WEIGHT{X}*factor;\nsumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif",kernelBlurVaryingDeclaration:"varying vec2 sampleCoord{X};",kernelBlurVertex:"sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};",mrtFragmentDeclaration:"#if __VERSION__>=200\nlayout(location=0) out vec4 glFragData[{X}];\n#endif\n",bones300Declaration:"#if NUM_BONE_INFLUENCERS>0\nuniform mat4 mBones[BonesPerMesh];\nin vec4 matricesIndices;\nin vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nin vec4 matricesIndicesExtra;\nin vec4 matricesWeightsExtra;\n#endif\n#endif",instances300Declaration:"#ifdef INSTANCES\nin vec4 world0;\nin vec4 world1;\nin vec4 world2;\nin vec4 world3;\n#else\nuniform mat4 world;\n#endif",backgroundVertexDeclaration:"uniform mat4 view;\nuniform mat4 viewProjection;\nuniform float shadowLevel;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform float fFovMultiplier;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif",backgroundFragmentDeclaration:" uniform vec4 vPrimaryColor;\nuniform vec4 vSecondaryColor;\nuniform vec4 vTertiaryColor;\nuniform float shadowLevel;\nuniform float alpha;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif",backgroundUboDeclaration:"layout(std140,column_major) uniform;\nuniform Material\n{\nuniform vec4 vPrimaryColor;\nuniform vec4 vSecondaryColor;\nuniform vec4 vTertiaryColor;\nuniform vec2 vDiffuseInfos;\nuniform vec2 vReflectionInfos;\nuniform mat4 diffuseMatrix;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform float fFovMultiplier;\nuniform float pointSize;\nuniform float shadowLevel;\nuniform float alpha;\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n};\nuniform Scene {\nmat4 viewProjection;\nmat4 view;\n};"};var o=typeof global!=="undefined"?global:typeof window!=="undefined"?window:this;o["BABYLON"]=r;if(typeof i!=="undefined"){o["Earcut"]={earcut:i}}return r});